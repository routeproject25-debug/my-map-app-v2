// Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===== Helpers ===== */
    function authed() { return request.auth != null; }

    // ÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ (Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ ÑÐ²Ð¾Ð³Ð¾ users/{uid})
    function me() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Ð Ð¾Ð»ÑŒ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°: users/{uid} -> roles/{uid} -> 'pending'
    function role() {
      return authed()
        ? (
            exists(/databases/$(database)/documents/users/$(request.auth.uid))
              ? me().data.role
              : (
                  exists(/databases/$(database)/documents/roles/$(request.auth.uid))
                    ? get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role
                    : 'pending'
                )
          )
        : null;
    }

    // ðŸ”‘ Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñ– Ñ€Ð¾Ð»Ñ–: Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‡Ð¸ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¼Ð°Ñ” Ñ€Ð¾Ð»ÑŒ (Ð¾ÑÐ½Ð¾Ð²Ð½Ñƒ Ð°Ð±Ð¾ Ð´Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñƒ)
    function additionalRoles() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? (me().data.additionalRoles is list ? me().data.additionalRoles : [])
        : [];
    }
    
    function hasRole(checkRole) {
      return role() == checkRole || (checkRole in additionalRoles());
    }

    function isAdmin()    { return hasRole('admin'); }
    function isLogist()   { return hasRole('logist'); }
    function isUser()     { return hasRole('user'); }
    function isSecurity() { return hasRole('security'); }
    function isWriter()   { return isAdmin() || isLogist(); } // ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ/Ñ€ÐµÐ´Ð°Ð³ÑƒÐ²Ð°Ð½Ð½Ñ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ–Ð²

    // ===== Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð° Ñ…Ð°Ð±Ð°Ð¼Ð¸ =====
    function _userAllowedHubs() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? (
            (me().data.allowedHubs is list) ? me().data.allowedHubs
          : (me().data.hubs        is list) ? me().data.hubs
          : (me().data.hub         is string) ? [me().data.hub]
          : (me().data.hubAccess   is string) ? [me().data.hubAccess]
          : []
          )
        : [];
    }

    // ÐŸÐ¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº = "ÑƒÑÑ– Ñ…Ð°Ð±Ð¸"
    function hasAllHubs() {
      return _userAllowedHubs().size() == 0;
    }

    // Ð§Ð¸Ñ‚Ð°Ð½Ð½Ñ/Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð´Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñƒ Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ñ…Ð°Ð±Ñ–Ð²
    function canReadRoute(d) {
      return (isAdmin() || isSecurity())
          || hasAllHubs()
          || (d.hub is string && d.hub in _userAllowedHubs());
    }

    // Ð§Ð¸Ñ‚Ð°Ð½Ð½Ñ/Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð´Ð¾ Ñ€Ð¾Ð·Ñ†Ñ–Ð½Ð¾Ðº Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ñ…Ð°Ð±Ñ–Ð²
    function canReadPricing(d) {
      return isAdmin()
          || hasAllHubs()
          || (d.hub is string && d.hub in _userAllowedHubs());
    }

    // Ð£Ñ‚Ð¸Ð»Ñ–Ñ‚Ð¸
    function nonEmptyString(s) { return s is string && s.matches('^\\S.*$'); }
    function validYear(y)      { return y.matches('^\\d{4}$'); }
    function isNum(x)          { return x is int || x is float; }

    // Ð’Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸ Ñ€Ð¾Ð·Ñ†Ñ–Ð½ÐºÐ¸
    function validPricing(d) {
      return d.hub is string
          && nonEmptyString(d.hub)
          && d.year is int
          && d.year >= 2020
          && d.year <= 2030
          && d.crop is string
          && nonEmptyString(d.crop)
          && isNum(d.distFrom)
          && isNum(d.distTo)
          && d.distFrom >= 0
          && d.distTo > d.distFrom
          && d.priceType is string
          && (d.priceType == 'Ñ‚/ÐºÐ¼' || d.priceType == 'Ð·Ð° Ñ‚Ð¾Ð½Ñƒ')
          && (!('priceNoVAT' in d) || d.priceNoVAT == null || isNum(d.priceNoVAT))
          && (!('priceWithVAT' in d) || d.priceWithVAT == null || isNum(d.priceWithVAT));
    }

    // Ð§Ð¸ Ð·Ð¼Ñ–Ð½Ð¸Ð»Ð°ÑÑŒ Ð²Ñ–Ð´ÑÑ‚Ð°Ð½ÑŒ ÑÑƒÑ‚Ñ‚Ñ”Ð²Ð¾ (>0.01 ÐºÐ¼)
    function distanceChanged() {
      return isNum(resource.data.distance_km)
          && isNum(request.resource.data.distance_km)
          && (
               request.resource.data.distance_km > resource.data.distance_km + 0.01
            || request.resource.data.distance_km < resource.data.distance_km - 0.01
          );
    }

    // Ð‘Ð°Ð·Ð¾Ð²Ð° Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñƒ (Ð±ÐµÐ· Ð¾Ð±Ð¾Ð²'ÑÐ·ÐºÐ¾Ð²Ð¾Ð³Ð¾ hub)
    function validRouteBase(d) {
      return d.fromCode  is string
          && d.toCode    is string
          && d.routeType is string
          && (!('routeKey' in d) || d.routeKey.matches('^[A-Za-zÐ-Ð¯Ð†Ð‡Ð„Ò]{2}-\\d{10}$'));
    }

    // Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ð° ÑƒÐ¼Ð¾Ð²Ð° Ð¿Ð¾ hub: ÑÐºÑ‰Ð¾ "Ð²ÑÑ– Ñ…Ð°Ð±Ð¸" â€” hub Ð¼Ð¾Ð¶Ðµ Ð±ÑƒÑ‚Ð¸ Ð²Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–Ð¼/Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¼; Ñ–Ð½Ð°ÐºÑˆÐµ â€” Ð¾Ð±Ð¾Ð²'ÑÐ·ÐºÐ¾Ð²Ð¾ Ð½ÐµÐ¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹
    function hubWriteOk(d) {
      return hasAllHubs()
        ? ( !('hub' in d) || d.hub == null || nonEmptyString(d.hub) )
        : ( ('hub' in d) && nonEmptyString(d.hub) );
    }

    // ---- approval: Ð»Ð¾Ð³Ñ–ÑÑ‚ â†’ pending
    function canSetPending(oldApp, newApp) {
      return newApp is map
             && ('status' in newApp) && newApp.status == 'pending'
             && (!('comment' in newApp) || (newApp.comment == null || (newApp.comment is string && newApp.comment.size() == 0)))
             && (!('decidedByUid'   in newApp) || newApp.decidedByUid   == null)
             && (!('decidedByEmail' in newApp) || newApp.decidedByEmail == null)
             && (!('decisionAt'     in newApp) || newApp.decisionAt     == null);
    }

    // ---- approval: Ñ–Ð½Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ Ñƒ draft Ð¿Ñ€Ð¸ Ð·Ð¼Ñ–Ð½Ñ– Ð²Ñ–Ð´ÑÑ‚Ð°Ð½Ñ– (Ð»Ð¾Ð³Ñ–ÑÑ‚)
    function canInvalidateToDraft(oldApp, newApp) {
      return newApp is map
             && ('status' in newApp) && newApp.status == 'draft'
             && distanceChanged()
             && (!('submittedAt'     in newApp) || newApp.submittedAt     == null)
             && (!('submittedByUid'  in newApp) || newApp.submittedByUid  == null)
             && (!('submittedByEmail'in newApp) || newApp.submittedByEmail== null)
             && (!('decidedByUid'    in newApp) || newApp.decidedByUid    == null)
             && (!('decidedByEmail'  in newApp) || newApp.decidedByEmail  == null)
             && (!('decisionAt'      in newApp) || newApp.decisionAt      == null)
             && (!('revision' in newApp) || (newApp.revision is int));
    }

    // ---- approval: Ð¡Ð‘/ÐÐ´Ð¼Ñ–Ð½ â†’ approved/rejected
    function canSecurityDecide(oldApp, newApp) {
      return newApp is map
             && ('status' in newApp)
             && (newApp.status == 'approved' || newApp.status == 'rejected')
             && (newApp.status != 'rejected' || (('comment' in newApp) && nonEmptyString(newApp.comment)));
    }

    /* ===== NEW: helpers Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ð¹ ===== */
    function changedOnly(keys) {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(keys);
    }
    function proposalRemoved() {
      return ('proposal' in resource.data) && !('proposal' in request.resource.data);
    }
    function proposalPresent() {
      return ('proposal' in request.resource.data);
    }
    // ÐŸÑ€Ð¾ÑÑ‚Ðµ Ð¾Ð±Ð¼ÐµÐ¶ÐµÐ½Ð½Ñ Ð½Ð° Ñ‚Ð¸Ð¿ Ð¿Ð¾Ð»Ñ proposal (Ð´Ð¾Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ map Ð°Ð±Ð¾ Ð²Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–ÑÑ‚ÑŒ)
    function proposalWriteOk() {
      return !proposalPresent() || (request.resource.data.proposal is map);
    }
    // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð¸ Ð¿Ñ€Ð¸ "Ð¿Ñ€Ð¸Ð¹Ð½ÑÑ‚Ñ‚Ñ–" (Ð»Ð¸ÑˆÐµ Ñ‚Ð¸Ð¿Ð¸ Ð¿Ð¾Ð»Ñ–Ð²; Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð° Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° â€” Ð½Ð° Ð±ÐµÐºÐµÐ½Ð´Ñ–/ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ñ–)
    function acceptProposalShapeOk() {
      return (!('points' in request.resource.data)      || (request.resource.data.points      is list))
          && (!('startRuler' in request.resource.data)  || (request.resource.data.startRuler  is list))
          && (!('endRuler' in request.resource.data)    || (request.resource.data.endRuler    is list))
          && (!('distance_km' in request.resource.data) || isNum(request.resource.data.distance_km));
    }

    /* ===== Collections ===== */

    // Ð›Ð¾Ð³Ñ–ÑÑ‚Ð¸
    match /logists/{id} {
      allow read: if authed();
      allow create, update, delete: if isAdmin(); // Ð°Ð±Ð¾ Ð´Ð¾Ð´Ð°Ñ‚Ð¸ || isLogist()
    }

    // ===== Ð Ð¾Ð·Ñ†Ñ–Ð½ÐºÐ¸ (pricing) =====
    match /pricing/{id} {
      // Ð§Ð¸Ñ‚Ð°Ð½Ð½Ñ â€” Ð²ÑÑ– Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ– ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ– Ð· Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ð´Ð¾ Ñ…Ð°Ð±Ñƒ
      allow read: if authed() && canReadPricing(resource.data);
      
      // Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ/Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ â€” Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð· Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ”ÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸
      allow create, update: if isAdmin() && validPricing(request.resource.data);
      
      // Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ â€” Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€
      allow delete: if isAdmin();
    }

    // ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ð¸
    match /routes/{id} {
      // Ð§Ð¸Ñ‚Ð°Ð½Ð½Ñ â€” Ð·Ð° Ñ€Ð¾Ð»Ð»ÑŽ/Ñ…Ð°Ð±Ð°Ð¼Ð¸
      allow read: if authed() && canReadRoute(resource.data);

      // Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ â€” Ð°Ð²Ñ‚Ð¾Ñ€ (Ð°Ð´Ð¼Ñ–Ð½/Ð»Ð¾Ð³Ñ–ÑÑ‚), Ð²Ð°Ð»Ñ–Ð´Ð½Ð¸Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚, hubâ€‘Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾, Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð¿Ð¾ Ñ…Ð°Ð±Ñƒ
      allow create: if isWriter()
                    && validRouteBase(request.resource.data)
                    && hubWriteOk(request.resource.data)
                    && canReadRoute(request.resource.data);

      // ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ:
      //  A) Ð‘Ð°Ð·Ð¾Ð²Ð¸Ð¹ Ð°Ð¿Ð´ÐµÐ¹Ñ‚ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð¼ (Ð°Ð´Ð¼Ñ–Ð½/Ð»Ð¾Ð³Ñ–ÑÑ‚) + Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð´Ð»Ñ approval (ÑÐº Ð±ÑƒÐ»Ð¾)
      //  B) Ð Ñ–ÑˆÐµÐ½Ð½Ñ Ð¡Ð‘/ÐÐ´Ð¼Ñ–Ð½Ð° Ð¿Ð¾ approval (approved/rejected) â€” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ approval/updatedAt
      //  C) Ð¡Ð‘/ÐÐ´Ð¼Ñ–Ð½: Ñ€Ð¾Ð±Ð¾Ñ‚Ð° Ð· Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ”ÑŽ â€” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ proposal/updatedAt (ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸/Ð¾Ð½Ð¾Ð²Ð¸Ñ‚Ð¸/Ð²Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸)
      //  D) Ð›Ð¾Ð³Ñ–ÑÑ‚/ÐÐ´Ð¼Ñ–Ð½: ÐŸÐ Ð˜Ð™ÐÐ¯Ð¢Ð˜ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–ÑŽ â€” Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ points/startRuler/endRuler/distance_km Ñ‚Ð° Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ proposal (+ updatedAt)
      //  E) Ð›Ð¾Ð³Ñ–ÑÑ‚/ÐÐ´Ð¼Ñ–Ð½: Ð’Ð†Ð”Ð¥Ð˜Ð›Ð˜Ð¢Ð˜ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–ÑŽ â€” Ð»Ð¸ÑˆÐµ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ proposal (+ updatedAt)
      allow update: if (
        // A) Ð±Ð°Ð·Ð¾Ð²Ð¸Ð¹ Ð°Ð¿Ð´ÐµÐ¹Ñ‚ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð¼
        isWriter()
        && validRouteBase(request.resource.data)
        && hubWriteOk(request.resource.data)
        && canReadRoute(request.resource.data)
        && (!('routeKey' in resource.data) || resource.data.routeKey == request.resource.data.routeKey)
        && !(('approval' in resource.data) && !('approval' in request.resource.data))
        && (
             (!('approval' in request.resource.data) && !('approval' in resource.data))
             || (('approval' in request.resource.data) && ('approval' in resource.data) && request.resource.data.approval == resource.data.approval)
             || (('approval' in request.resource.data) && canSetPending(resource.data.approval, request.resource.data.approval))
             || (('approval' in request.resource.data) && canInvalidateToDraft(resource.data.approval, request.resource.data.approval))
           )
      ) || (
        // B) Ñ€Ñ–ÑˆÐµÐ½Ð½Ñ Ð¡Ð‘/ÐÐ´Ð¼Ñ–Ð½Ð° Ð¿Ð¾ approval
        (isSecurity() || isAdmin())
        && changedOnly(['approval', 'updatedAt'])
        && ('approval' in request.resource.data)
        && canSecurityDecide(resource.data.approval, request.resource.data.approval)
        && (!('routeKey' in resource.data) || resource.data.routeKey == request.resource.data.routeKey)
        && canReadRoute(request.resource.data)
      ) || (
        // C) Ð¡Ð‘/ÐÐ´Ð¼Ñ–Ð½ Ð¼Ð¾Ð¶Ðµ ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸/Ð¾Ð½Ð¾Ð²Ð¸Ñ‚Ð¸/Ð²Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸ Ð¢Ð†Ð›Ð¬ÐšÐ˜ proposal (+ updatedAt)
        (isSecurity() || isAdmin())
        && changedOnly(['proposal', 'updatedAt'])
        && proposalWriteOk()
        && (!('routeKey' in resource.data) || resource.data.routeKey == request.resource.data.routeKey)
        && canReadRoute(request.resource.data)
      ) || (
        // D) Ð›Ð¾Ð³Ñ–ÑÑ‚/ÐÐ´Ð¼Ñ–Ð½ ÐŸÐ Ð˜Ð™ÐœÐÐ„ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–ÑŽ:
        //    â€” Ð·Ð¼Ñ–Ð½ÑŽÑ” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ points/startRuler/endRuler/distance_km/proposal/updatedAt
        //    â€” Ñ– Ð¾Ð±Ð¾Ð²'ÑÐ·ÐºÐ¾Ð²Ð¾ Ð²Ð¸Ð´Ð°Ð»ÑÑ” proposal
        isWriter()
        && changedOnly(['points','startRuler','endRuler','distance_km','proposal','updatedAt'])
        && proposalRemoved()
        && acceptProposalShapeOk()
        && (!('routeKey' in resource.data) || resource.data.routeKey == request.resource.data.routeKey)
        && hubWriteOk(request.resource.data)
        && canReadRoute(request.resource.data)
      ) || (
        // E) Ð›Ð¾Ð³Ñ–ÑÑ‚/ÐÐ´Ð¼Ñ–Ð½ Ð’Ð†Ð”Ð¥Ð˜Ð›Ð¯Ð„ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–ÑŽ:
        //    â€” Ð·Ð¼Ñ–Ð½ÑŽÑ” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ proposal/updatedAt
        //    â€” Ñ– Ð¾Ð±Ð¾Ð²'ÑÐ·ÐºÐ¾Ð²Ð¾ Ð²Ð¸Ð´Ð°Ð»ÑÑ” proposal
        isWriter()
        && changedOnly(['proposal','updatedAt'])
        && proposalRemoved()
        && (!('routeKey' in resource.data) || resource.data.routeKey == request.resource.data.routeKey)
        && canReadRoute(request.resource.data)
      );

      // Ð’Ð¸Ð´Ð°Ð»ÑÑ‚Ð¸ Ð¼Ð¾Ð¶Ðµ Ð»Ð¸ÑˆÐµ Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€
      allow delete: if isAdmin();
    }

    // Ð ÐµÐ·ÐµÑ€Ð² ÑƒÐ½Ñ–ÐºÐ°Ð»ÑŒÐ½Ð¸Ñ… ÐºÐ¾Ð´Ñ–Ð² Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ–Ð² â€” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð´Ð»Ñ Ð°Ð´Ð¼Ñ–Ð½Ñ–Ð²/Ð¡Ð‘
    match /routeKeys/{key} {
      allow read: if isWriter();
      allow create, update: if isAdmin() || isSecurity();
      allow delete: if isAdmin();
    }

    // Ð”Ð¾Ð²Ñ–Ð´Ð½Ð¸ÐºÐ¸
    match /directory/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isLogist();
    }

    // ===== Users =====
    match /users/{uid} {
      allow create: if authed()
                    && request.auth.uid == uid
                    && !exists(/databases/$(database)/documents/users/$(uid));
      allow read: if authed() && (request.auth.uid == uid || isAdmin());
      allow update, delete: if isAdmin();
    }

    // ===== Audit =====
    match /audit/{docId} {
      allow create: if isAdmin();
      allow read:   if isAdmin();
      allow update, delete: if isAdmin();
    }

    // ===== Route Audit Logs (client-side on Spark) =====
    match /route_logs/{id} {
      // Ð”Ð¾Ð·Ð²Ð¾Ð»ÑÑ”Ð¼Ð¾ ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸ Ð¶ÑƒÑ€Ð½Ð°Ð»Ð¸ admin/security/logist
      allow create: if authed() && (isAdmin() || isSecurity() || isLogist());
      // Ð”Ð¾Ð·Ð²Ð¾Ð»ÑÑ”Ð¼Ð¾ Ñ‡Ð¸Ñ‚Ð°Ñ‚Ð¸ Ð¶ÑƒÑ€Ð½Ð°Ð»Ð¸ Ñ‚Ð¸Ð¼ Ð¶Ðµ Ñ€Ð¾Ð»ÑÐ¼ (Ñ‰Ð¾Ð± Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ Ñ—Ñ… Ñƒ Ð²Ê¼ÑŽÐ²ÐµÑ€Ñ–)
      allow read:   if authed() && (isAdmin() || isSecurity() || isLogist());
      // Ð—Ð°Ð±Ð¾Ñ€Ð¾Ð½ÑÑ”Ð¼Ð¾ Ñ€ÐµÐ´Ð°Ð³ÑƒÐ²Ð°Ð½Ð½Ñ/Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ â€” Ð¶ÑƒÑ€Ð½Ð°Ð»Ð¸ append-only
      allow update, delete: if false;
    }

    // ===== Legacy roles (read-only) =====
    match /roles/{uid} {
      allow read: if authed() && (request.auth.uid == uid || isAdmin());
      allow write: if false;
    }

    // ===== Codes =====
    match /codes/{year}/sowings/{sowing_key} {
      allow read: if authed();
      allow create, update: if isAdmin()
                            && validYear(year)
                            && (request.resource.data.code is string)
                            && validSowingCodeData(request.resource.data);
      allow delete: if isAdmin();
    }

    match /codes_by_code/{year}/codes/{code} {
      allow read: if authed();
      allow create, update: if isAdmin()
                            && validYear(year)
                            && request.resource.data.sowing_key is string
                            && request.resource.data.sowing_key.matches('^\\S.*$');
      allow delete: if isAdmin();
    }

    // ===== ÐžÐ½Ð»Ð°Ð¹Ð½-ÐºÐ¾Ð½Ñ„Ñ–Ð³ tilesets =====
    match /config/tilesets {
      allow read: if authed();
      allow write: if isAdmin();
    }

    // ===== Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð²Ñ–Ð´Ð²Ñ–Ð´ÑƒÐ²Ð°Ð½Ð½Ñ =====
    // Ð¡ÐµÑÑ–Ñ— Ð²Ñ–Ð´Ð²Ñ–Ð´ÑƒÐ²Ð°Ñ‡Ñ–Ð² - Ð²ÑÑ– Ð¼Ð¾Ð¶ÑƒÑ‚ÑŒ ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸ Ñ‚Ð° Ð¾Ð½Ð¾Ð²Ð»ÑŽÐ²Ð°Ñ‚Ð¸ ÑÐ²Ð¾Ñ— ÑÐµÑÑ–Ñ—
    match /visitor_sessions/{sessionId} {
      allow create: if authed();
      allow update: if authed() && resource.data.userId == request.resource.data.userId;
      allow read: if authed() && isAdmin();
      allow delete: if false;
    }
    
    // Ð”ÐµÐ½Ð½Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ñ–Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚ÑƒÐ²Ð°Ð½Ð½Ñ
    match /visitor_stats/{date} {
      allow read: if authed() && isAdmin();
      allow create, update: if authed();
      allow delete: if false;
    }

    // Fallback
    match /{document=**} {
      allow read, write: if false;
    }
  }

  // Helper Ð´Ð»Ñ codes (ÑÐºÑ‰Ð¾ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ)
  function validSowingCodeData(d) {
    return d.code is string && d.code.matches('^\\S.*$');
  }
}
