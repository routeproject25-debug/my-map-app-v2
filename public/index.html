<!-- Telegram notification is handled server-side to avoid exposing tokens -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üöö–ú–∞—Ä—à—Ä—É—Ç–∏ Mapbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="preconnect" href="https://api.mapbox.com" crossorigin>
<link rel="preconnect" href="https://events.mapbox.com" crossorigin>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="https://firestore.googleapis.com">
<link rel="dns-prefetch" href="https://firebasestorage.googleapis.com">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <!-- ‚¨áÔ∏è Firebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <!-- App config -->
<script src="/config/config.js"></script>

  <style>
  :root { --nav-h:56px; --nav-real:56px; --card:#fff; --line:#e5e7eb; --muted:#6b7280; }

  *{box-sizing:border-box}
  body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  header.topbar{
    position:sticky; top:0; z-index:5000; min-height:var(--nav-h);
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px;
    background:#2563eb; color:#fff;
  }
  header.topbar a{ color:#fff; text-decoration:none; margin-right:12px; white-space:nowrap; }
  header .left, header .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  header .spacer{ flex:1 1 auto; }
  /* –ü–µ—Ä–µ–º–∏–∫–∞—á –º—ñ–∂ –¥–µ—Å–∫—Ç–æ–ø–Ω–∏–º–∏ –ª—ñ–Ω–∫–∞–º–∏ —Ç–∞ –º–æ–±—ñ–ª—å–Ω–∏–º –º–µ–Ω—é */
  .nav-link{ display:inline-block; }
  #mainMenuWrap{ display:none; }
  /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∫–ª—é—á–∏–∫ –¥–ª—è –∞–¥–º—ñ–Ω-–∫–Ω–æ–ø–∫–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –ª–∏—à–µ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö) */
  #adminKeyIcon{ display:none; }

  /* ===== Notifications ===== */
  #notifArea{ position:relative; display:flex; align-items:center; gap:6px; }
  #notifBell{ position:relative; height:34px; padding:0 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35); background:#fff; color:#111; cursor:pointer; }
  #notifCount{ position:absolute; top:-6px; right:-6px; background:#ef4444; color:#fff; border-radius:999px; padding:2px 6px; font-size:12px; line-height:1; display:none; }
  /* Dropdown –∞–≤—Ç–æ-–ø—ñ–¥ —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–Ω—Ç—É (–∞–ª–µ –Ω–µ —à–∏—Ä—à–µ –≤—ñ–∫–Ω–∞) */
  #notifDropdown{ position:absolute; right:0; top:40px; width:max-content; min-width:320px; max-width:calc(100vw - 16px); background:#fff; color:#111; border:1px solid var(--line); border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.18); display:none; z-index:6000; }
  #notifDropdown header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line); font-weight:600; }
  #notifList{ list-style:none; margin:0; padding:0; max-height:50vh; overflow-y:auto; overflow-x:hidden; }
  #notifList li{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #f1f5f9; }
  #notifList li:last-child{ border-bottom:none; }
  .notif-msg{ font-size:14px; white-space:nowrap; }
  .notif-msg a{ color:inherit; text-decoration:none; white-space:nowrap; }
  .notif-time{ font-size:12px; color:#6b7280; }
  .notif-dismiss{ background:transparent; border:none; color:#6b7280; cursor:pointer; font-size:16px; line-height:1; padding:0 4px; }

  #authBar{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  #authBar input{
    height:34px; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.15); color:#fff; outline:none; width:180px;
  }
  #authBar input::placeholder{ color:rgba(255,255,255,.85) }
  #authBar input[type="password"]{ width:120px }
  #authBar .chip{
    font-size:12px; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3);
    border-radius:999px; padding:4px 10px; white-space:nowrap;
  }
  #authBar .btn{
    height:34px; padding:0 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
    background:#fff; color:#111; cursor:pointer; touch-action:manipulation;
  }

  #mobileAuthToggle{ display:none; }
  @media (max-width: 1024px){
    header .left{ flex-wrap:nowrap; }
    .btn.xs{ padding:6px 8px; }
    :root{ --nav-h:48px; --nav-real:48px; }
    #mobileAuthToggle{
      display:inline-flex; align-items:center; justify-content:center;
      height:34px; padding:0 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
      background:#fff; color:#111; cursor:pointer;
    }
    #authBar.collapsed input,
    #authBar.collapsed #authLogin,
    #authBar.collapsed #authLogout{ display:none !important; }
    /* –°—Ö–æ–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤—ñ —á—ñ–ø–∏ ¬´–£–≤—ñ–π—à–ª–∏ —è–∫‚Ä¶¬ª —Ç–∞ ¬´–†–æ–ª—å: ‚Ä¶¬ª –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    #authHello, #roleChip{ display:none !important; }
  }

  #map{position:absolute; top:var(--nav-real); bottom:0; width:100%}

  #controls{
    position:absolute; z-index:3000; top:calc(var(--nav-real) + 8px); left:8px;
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 1px 8px rgba(0,0,0,.12); padding:12px;
    width:280px; max-width:280px; max-height:90vh; overflow-y:auto; overflow-x:hidden;
  }
  .controls-hidden #controls{ display:none }

  #controls .row>*{min-width:0}
  #controls input[type=text], #controls select, #controls textarea{
    width:100%; max-width:100%; padding:9px 11px; font-size:14px;
    border:1px solid var(--line); border-radius:10px; outline:none;
  }
  /* –§—ñ–∫—Å—É—î–º–æ –ø–æ–≤–µ–¥—ñ–Ω–∫—É –≤–∏–ø–∞–¥–∞—é—á–æ–≥–æ —Å–ø–∏—Å–∫—É: —Ä–æ–±–∏–º–æ —Ç–µ–∫—Å—Ç –æ–ø—Ü—ñ–π –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–∏–º */
  #remoteRoutes{ width:100%; }
  #remoteRoutes option{ white-space:nowrap; }
  #controls textarea{min-height:48px; resize:vertical}
  label{display:block;font-size:13px;color:#444;margin:2px 0 6px}
  small.muted{color:#6b7280}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:420px){ .row{grid-template-columns:1fr} }

  .btn{
    cursor:pointer;border:1px solid var(--line);background:#fff;border-radius:10px;
    padding:8px 12px;font-size:14px; line-height:1.2; touch-action:manipulation;
  }
  .btn.xs{ padding:8px 12px; font-size:14px }
  .btn.active{background:#e6f4ea;border-color:#22c55e}

  /* –õ—ñ–≤–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç‚Äë—Å—Ç–æ–≤–ø—á–∏–∫: –≤–∏—Ä—ñ–≤–Ω—é—î–º–æ —Ç–µ–∫—Å—Ç–∏ –≤–ª—ñ–≤–æ —ñ –¥–æ–¥–∞—î–º–æ –ø—ñ–¥–ø–∏—Å —à–æ—Ä—Ç–∫–∞—Ç—ñ–≤ –ø—Ä–∞–≤–æ—Ä—É—á */
  #panel-create .tools-left .btn{ display:flex; align-items:center; gap:8px; justify-content:flex-start; text-align:left }
  #panel-create .tools-left .btn .lbl{ flex:1 1 auto; text-align:left }
  #panel-create .tools-left .btn .kbd{
    margin-left:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px; color:#374151; background:#f3f4f6; border:1px solid var(--line);
    border-radius:6px; padding:1px 6px; line-height:1.2;
  }

  .panel-head{display:grid;gap:10px;margin-bottom:8px}
  .segment{display:flex;gap:6px;flex-wrap:wrap}
  .btn-row{display:flex;gap:6px;flex-wrap:wrap}

  @media (max-width: 1024px){
    #controls{ left:8px; right:8px; max-width:unset; width:auto; }
    .segment, .btn-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .btn, .btn.xs{ min-height:44px; font-size:15px; padding:10px 12px; }
    .km-chip{ font-size:13px; padding:6px 10px; }
  }

  .km-chip{margin-top:2px;font-size:12.5px;color:#111;background:#f3f4f6;
           border:1px solid var(--line);border-radius:999px;display:inline-block;
           padding:4px 10px;width:max-content}

  .section{border-top:1px dashed var(--line);padding-top:8px;margin-top:8px}
  details>summary{cursor:pointer;font-weight:700;margin:4px 0}
  #dbControls{margin-top:10px;padding-top:10px;border-top:1px dashed var(--line)}
  #dbControls input,#dbControls select{margin:5px 0}

  #contextMenu{position:absolute;background:#fff;border:1px solid #ccc;display:none;z-index:3500;
               box-shadow:0 2px 6px rgba(0,0,0,.15)}
  #contextMenu div{padding:6px 10px;cursor:pointer}
  #contextMenu div:hover{background:#f3f4f6}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000}
  .modal.show{display:flex}
  .modal-box{background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; width:min(440px,92vw); box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-weight:700; margin-bottom:6px}
  .modal-body{color:#374151; font-size:14px; margin-bottom:10px; white-space:pre-line}
  .modal-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .modal-actions .btn{min-width:140px}

  .mapboxgl-canvas{z-index:0!important}
  .mapboxgl-control-container{z-index:1!important}
  .mapboxgl-marker{z-index:2!important}
  /* –°—Ç–∏–ª—ñ –¥–ª—è –¥–æ–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∏–ª—é –∫–∞—Ä—Ç–∏ (–Ω–∏–∂–Ω—ñ–π –ª—ñ–≤–∏–π –∫—É—Ç) */
  .style-dock{
    position:fixed;
    left:8px; bottom:8px; z-index:3500;
    display:flex; align-items:center; gap:6px;
    background:var(--card); border:1px solid var(--line);
    border-radius:12px; padding:6px 8px;
    box-shadow:0 2px 12px rgba(0,0,0,.12);
  }
  .style-dock select{
    border:1px solid var(--line); border-radius:10px;
    padding:6px 8px; font-size:13px; background:#fff; color:#111;
  }
  .style-dock input[type="text"]{
    border:1px solid var(--line); border-radius:10px;
    padding:6px 8px; font-size:13px; background:#fff; color:#111;
    width:180px;
  }
  .style-dock .mapbox-brand{
    font-size:11px; color:#6b7280; border-left:1px dashed var(--line);
    padding-left:8px;
  }
  /* –ú–æ–±—ñ–ª—å–Ω–∞ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—Å—Ç—å –Ω–∏–∂–Ω—å–æ–≥–æ –ª—ñ–≤–æ–≥–æ –¥–æ–∫—É (—Å—Ç–∏–ª—å/–ø–æ—à—É–∫) —ñ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
  @media(max-width:1024px){
    /* –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é —ñ —Å—Ö–æ–≤–∞—Ç–∏ –æ–∫—Ä–µ–º—ñ –ª—ñ–Ω–∫–∏ */
    .nav-link{ display:none; }
    #mainMenuWrap{ display:inline-block; }
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ—à–∏–π —Ö–µ–¥–µ—Ä */
    header.topbar{ padding:6px; gap:6px; }
    /* –õ–∏—à–µ —ñ–∫–æ–Ω–∫–∞ –¥–∑–≤—ñ–Ω–æ—á–∫–∞ */
    #notifBell .label{ display:none; }
    /* –ê–¥–º—ñ–Ω-–∫–Ω–æ–ø–∫–∞ —è–∫ –∫–ª—é—á–∏–∫ (–±–µ–∑ –ø—ñ–¥–ø–∏—Å—É —Ç–∞ —Ä–æ–ª—ñ) */
    #roleEmoji{ display:none !important; }
    #adminMenuBtn .label{ display:none !important; }
    #adminKeyIcon{ display:inline !important; }
    /* –ö–Ω–æ–ø–∫–∞ ¬´–ú–µ–Ω—é¬ª: –ª–∏—à–µ —ñ–∫–æ–Ω–∫–∞ */
    #mainMenuBtn .label{ display:none !important; }
    #mainMenuBtn .icon{ display:inline !important; }
    .style-dock{ padding:4px 6px; gap:4px; }
    .style-dock select{ padding:4px 6px; font-size:12px; }
    .style-dock input[type="text"]{ padding:4px 6px; font-size:12px; width:130px; }
    .style-dock .mapbox-brand{ display:none; }
  }

  #logistsMsg{display:none;font-size:12px;color:#b91c1c;margin-top:4px}
  /* ===== –ü—Ä–∏–º—É—Å–æ–≤–∏–π –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ body.force-compact ===== */
  body.force-compact .nav-link{ display:none; }
  body.force-compact #mainMenuWrap{ display:inline-block; }
  body.force-compact header.topbar{ padding:6px; gap:6px; }
  body.force-compact #notifBell .label{ display:none; }
  body.force-compact #roleEmoji{ display:none !important; }
  body.force-compact #adminMenuBtn .label{ display:none !important; }
  body.force-compact #adminKeyIcon{ display:inline !important; }
  body.force-compact #mainMenuBtn .label{ display:none !important; }
  body.force-compact #mainMenuBtn .icon{ display:inline !important; }
  body.force-compact .style-dock{ padding:4px 6px; gap:4px; }
  body.force-compact .style-dock select{ padding:4px 6px; font-size:12px; }
  body.force-compact .style-dock input[type="text"]{ padding:4px 6px; font-size:12px; width:130px; }
  body.force-compact .style-dock .mapbox-brand{ display:none; }
  body.force-compact #panelDock .dock-btn{ padding:6px 8px; font-size:16px; }
  body.force-compact #panelDock .dock-btn .label{ display:none; }
  body.force-compact #authHello, body.force-compact #roleChip{ display:none !important; }
  
  #splash{
  position:fixed; inset:0; display:grid; place-items:center;
  background:#fff; z-index:9999; transition:opacity .25s ease;
  font-size:14px; color:#111; gap:12px;
}
#splash.hide{ opacity:0; pointer-events:none }
.spinner{
  width:40px; height:40px; border:3px solid #e5e7eb;
  border-top-color:#2563eb; border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg) } }
/* ==== –ü–∞–Ω–µ–ª—ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è ==== */
#controls .panel{ display:none; }
#controls .panel.active{ display:block; }

/* ==== –î–æ–∫ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º —ñ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—î—é (–≤–Ω–∏–∑—É –ø—Ä–∞–≤–æ—Ä—É—á, –Ω–∞–¥ –∫–Ω–æ–ø–∫–∞–º–∏ dock) ==== */
#statusDock{
  position:fixed;
  right:8px;
  /* —Ä–æ–∑—Ç–∞—à–æ–≤—É—î–º–æ –ù–ê–î –Ω–∏–∂–Ω—ñ–º dock —ñ–∑ –∫–Ω–æ–ø–∫–∞–º–∏; –≤–∏—Å–æ—Ç—É dock –≤—ñ–¥–¥–∞—î CSS-–∑–º—ñ–Ω–Ω–∞ */
  bottom: calc(8px + var(--panel-dock-h, 0px) + 8px);
  z-index:3500;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.status-chip{
  background:#f3f4f6;
  color:#111;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 12px;
  font-size:12.5px;
  box-shadow:0 1px 8px rgba(0,0,0,.08);
  width:max-content;
  max-width:46vw;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* –∫–æ–ª—å–æ—Ä–∏ —Å—Ç–∞—Ç—É—Å—ñ–≤ */
#statusChip.status-chip[data-status="pending"]{ background:#fff7ed; border-color:#f59e0b; }
#statusChip.status-chip[data-status="approved"]{ background:#e6f4ea; border-color:#22c55e; }
#statusChip.status-chip[data-status="rejected"]{ background:#fee2e2; border-color:#ef4444; }
#statusChip.status-chip[data-status="draft"]{ background:#eef2ff; border-color:#c7d2fe; }
#statusChip.status-chip[data-active="true"]::after{ content:" üü©"; }
#statusChip.status-chip[data-active="false"]::after{ content:" üü•"; }
/* –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç ‚Äî —Ç—å–º—è–Ω—ñ—à–∏–π —Ñ–æ–Ω —Ç–∞ —Å—ñ—Ä–∞ —Ä–∞–º–∫–∞ */
#statusChip.status-chip[data-active="false"]{ opacity:.85; background:#f8fafc; border-color:#e2e8f0; }
/* proposal (yellow) */
#statusChip.status-chip[data-status="proposal"]{ background:#fef9c3; border-color:#f59e0b; }

@media (max-width:640px){
  #statusDock{ right:8px; bottom: calc(8px + var(--panel-dock-h, 0px) + 8px); }
}
/* –ñ–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–Ω–∞—á–µ–Ω–Ω—è –∫–º —É –≤–µ—Ä—Ö–Ω—å–æ–º—É —á—ñ–ø—ñ */
#distanceChip #distanceTop{
  font-weight: 700;
  font-variant-numeric: tabular-nums; /* –æ–ø—Ü—ñ–π–Ω–æ: —Ä—ñ–≤–Ω—ñ —à–∏—Ä–∏–Ω–∏ —Ü–∏—Ñ—Ä */
}

/* –î–æ–∫-–ø–µ—Ä–µ–º–∏–∫–∞—á –ø–∞–Ω–µ–ª–µ–π (–ø—Ä–∞–≤–æ—Ä—É—á –≤–Ω–∏–∑—É) */
#panelDock{
  position:fixed;
  right:8px; bottom:8px;
  z-index:3500;
  display:flex; gap:6px; flex-wrap:wrap;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 12px rgba(0,0,0,.12);
}
#panelDock .dock-btn{
  cursor:pointer; border:1px solid var(--line); background:#fff;
  border-radius:10px; padding:8px 10px; font-size:13px; display:inline-flex; align-items:center; gap:4px;
}
#panelDock .dock-btn.active{
  background:#e6f4ea; border-color:#22c55e;
}

/* –¥—Ä—ñ–±–Ω—ñ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ –ø—Ä–∞–≤–∫–∏ */
@media (max-width:640px){
  #statusChip{ right:8px; top:calc(var(--nav-real) + 8px); }
  #panelDock{ right:8px; bottom:8px; }
  /* –Ü–∫–æ–Ω–∫–∏ –∑–∞–º—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—ñ–≤ –¥–ª—è dock-buttons */
  #panelDock .dock-btn{ padding:6px 8px; font-size:16px; }
  #panelDock .dock-btn .label{ display:none; }
  /* –©–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–∏–π —Å—Ç–∏–ª—å-–¥–æ–∫ */
  .style-dock{ padding:3px 4px; }
  .style-dock select{ padding:3px 4px; font-size:11px; }
  .style-dock input[type="text"]{ padding:3px 4px; font-size:11px; width:110px; }
}
/* –≤–µ—Ä—Ö–Ω—ñ–π —Å–µ–≥–º–µ–Ω—Ç –∑ —Ç—Ä—å–æ–º–∞ –∫–Ω–æ–ø–∫–∞–º–∏ */
#panel-create .segment{
  display:flex;
  gap:6px;
  flex-wrap:nowrap;        /* –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–∏ */
}
#panel-create .segment .btn{
  white-space:nowrap;      /* –Ω–µ –ª–∞–º–∞—Ç–∏ —Ç–µ–∫—Å—Ç –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ */
  flex: 1 1 auto;          /* —Ä—ñ–≤–Ω—ñ —à–∏—Ä–∏–Ω–∏, —è–∫—â–æ —Ö–æ—á–µ—à */
}
#panel-create .segment .btn.active::after{
  content: "";                 /* –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—É –∫—Ä–∞–ø–∫—É */
  display: inline-block;       /* –∑—Ä–æ–±–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–æ–º, —â–æ–± –∑–∞–¥–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä–∏ */
  width: 8px;                  /* –º–∞–ª–µ–Ω—å–∫–∏–π –∫—Ä—É–∂–µ—á–æ–∫ */
  height: 8px;
  margin-left: .35rem;         /* –≤—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ —Ç–µ–∫—Å—Ç—É –∫–Ω–æ–ø–∫–∏ */
  border-radius: 50%;          /* –∫–æ–ª–æ */
  background: #22c55e;         /* –∑–µ–ª–µ–Ω–∏–π */
  border: 1px solid rgba(0,0,0,.25); /* —Ç–æ–Ω–∫–∞ –æ–±–≤–æ–¥–∫–∞, —â–æ–± –±—É–ª–æ —á—ñ—Ç–∫–æ –≤–∏–¥–Ω–æ */
  vertical-align: middle;
}
/* —Ä—ñ–∑–Ω—ñ –∫–æ–ª—å–æ—Ä–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–Ω–æ–ø–∫–∏ ‚Äî –¶–ï–ô –í–ê–†–Ü–ê–ù–¢ –ó –ü–†–ê–í–ò–õ–¨–ù–û–Æ –°–ü–ï–¶–ò–§–Ü–ß–ù–Ü–°–¢–Æ */
#panel-create #toggleAdd.active::after     { background:#22c55e; } /* –ú–∞—Ä—à—Ä—É—Ç ‚Äì –∑–µ–ª–µ–Ω–∏–π */
#panel-create #startLineMode.active::after { background:#2563eb; } /* –õ—ñ–Ω—ñ–π–∫–∞(–ø–æ—á.) ‚Äì —Å–∏–Ω—ñ–π */
#panel-create #endLineMode.active::after   { background:#f59e0b; } /* –õ—ñ–Ω—ñ–π–∫–∞(–∫—ñ–Ω.) ‚Äì –ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π */

  /* –ú–∞—Ä–∫–µ—Ä–∏ –ª—ñ–Ω—ñ–π–æ–∫ (–ø–æ—á./–∫—ñ–Ω.) */
  .ruler-marker{ width:20px; height:20px; border-radius:50%; border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:12px; line-height:1; }
  .ruler-marker.start{ background:#2563eb; }
  /* –ö—ñ–Ω—Ü–µ–≤–∞ –ª—ñ–Ω—ñ–π–∫–∞: –º–∞—Ä–∫–µ—Ä –ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π */
  .ruler-marker.end{   background:#f59e0b; }

  /* –ú–∞—Ä–∫–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç—É –∑ —Ü–∏—Ñ—Ä–æ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ */
  .route-marker{ width:22px; height:22px; border-radius:50%; border:2px solid #2563eb; background:#fef08a; box-shadow:0 1px 4px rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; color:#111; font-weight:700; font-size:12px; line-height:1; }

  /* –ù–æ–º–µ—Ä–∫–∏ –¥–ª—è —Ç–æ—á–æ–∫ (HTML‚Äë–±–µ–π–¥–∂—ñ) */
  .pt-label { position:relative; z-index:3; font-size:12px; line-height:1; color:#111; background:#fff; border:1px solid #cbd5e1; border-radius:999px; padding:2px 5px; box-shadow:0 1px 3px rgba(0,0,0,.15); user-select:none; }
  .pt-label.s { background:#eff6ff; border-color:#93c5fd; }
  .pt-label.e { background:#fffbeb; border-color:#fcd34d; }

  /* ==== –ù–û–í–ï –ö–û–ú–ü–û–ù–£–í–ê–ù–ù–Ø –ì–û–õ–û–í–ò –ü–ê–ù–ï–õ–Ü –°–¢–í–û–†–ï–ù–ù–Ø ==== */
  #panel-create .panel-head .layout{
    display:grid;
    grid-template-columns:150px 1fr;
    gap:10px;
    align-items:start;
  }
  #panel-create .tools-left{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  #panel-create .head-right{ min-width:0; }
  #panel-create .route-toolbar{
    display:flex; gap:8px; align-items:flex-end;
    flex-wrap:nowrap; overflow:auto; padding-bottom:4px;
  }
  #panel-create .route-toolbar .field{ min-width:160px; }
  #panel-create .route-toolbar .field.w220{ min-width:220px; }
  #panel-create .route-toolbar .field.w240{ min-width:240px; }
  #panel-create .route-toolbar .field.w260{ min-width:260px; }
  #panel-create .route-toolbar .field.w160{ min-width:160px; }
  #panel-create .route-toolbar label{ font-size:12px; margin-bottom:4px; color:#374151; }
  #panel-create .route-toolbar input[type=text],
  #panel-create .route-toolbar select{ height:36px; }

  @media (max-width: 1024px){
    #panel-create .panel-head .layout{ grid-template-columns:1fr; }
    /* –ù–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –∑–∞–ª–∏—à–∞—î–º–æ —Å—Ç–æ–≤–ø—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –∑–ª—ñ–≤–∞ –∑–≤–µ—Ä—Ö—É */
    #panel-create .tools-left{ flex-direction:column; flex-wrap:nowrap; }
    #panel-create .route-toolbar{ flex-wrap:wrap; overflow:visible; }
  }

  /* ===== –í–µ—Ä—Ö–Ω—ñ–π –¥–æ–∫ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö (–≤–∏–¥—ñ–ª–µ–Ω–æ –æ–∫—Ä–µ–º–æ) ===== */
  .entry-dock{
    position:fixed; left:8px; right:8px; top:calc(var(--nav-real) + 8px);
    z-index:3400;
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 2px 12px rgba(0,0,0,.12);
    padding:6px;
  }
  .entry-dock .entry-toggle{
    cursor:pointer; border:1px solid var(--line); background:#fff; color:#111;
    border-radius:8px; padding:4px 8px; font-size:12px; line-height:1.2;
  }
  /* –†—ñ–≤–Ω–æ–º—ñ—Ä–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ —É –≤–µ—Ä—Ö–Ω—å–æ–º—É –¥–æ–∫—É */
  .entry-dock .route-toolbar{
    display:grid;
    grid-template-columns:
      220px  /* –í—ñ–¥ */
      220px  /* –î–æ */
      160px  /* –¢–∏–ø */
      160px  /* –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è */
      160px  /* –•–∞–± */
      minmax(420px, 1fr)   /* –ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏ ‚Äî –¥–æ–≤—à–µ, —Ç—è–≥–Ω–µ—Ç—å—Å—è */
      240px;               /* –õ–æ–≥—ñ—Å—Ç */
    gap:8px 10px; align-items:center; /* –≤–∏—Ä—ñ–≤–Ω—é—î–º–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ –¥–ª—è —Ä—ñ–≤–Ω—ñ—à–æ–≥–æ –≤–∏–≥–ª—è–¥—É */
    padding-left:34px; /* –º—ñ—Å—Ü–µ –ø—ñ–¥ –ø–ª–∞–≤–∞—é—á—É –∫–Ω–æ–ø–∫—É –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è */
  }
  .entry-dock .route-toolbar .field{ min-width:160px; /* –¥–æ–∑–≤–æ–ª—è—î–º–æ –µ–ª–µ–º–µ–Ω—Ç—É —Ä–æ–∑—Ç—è–≥—É–≤–∞—Ç–∏—Å—å —É—Å–µ—Ä–µ–¥–∏–Ω—ñ –≥—Ä—ñ–¥—É */ min-width:0; }
  .entry-dock .route-toolbar .field.w220{ min-width:220px; }
  .entry-dock .route-toolbar .field.w240{ min-width:240px; }
  .entry-dock .route-toolbar .field.w260{ min-width:260px; }
  .entry-dock .route-toolbar .field.w420{ min-width:420px; flex:1 1 420px; }
  .entry-dock .route-toolbar .field.w160{ min-width:160px; }
  /* –∫–Ω–æ–ø–∫–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–∞ –ø–æ –≤–∏—Å–æ—Ç—ñ, —â–æ–± —Ä—è–¥ –±—É–≤ –Ω–∏–∂—á–µ */
  .entry-dock .entry-toggle{
    position:absolute; left:6px; top:10px; z-index:2;
    height:28px; display:inline-flex; align-items:center; justify-content:center;
    padding:2px 6px; font-size:14px; line-height:1; width:24px;
  }
  .entry-dock .route-toolbar label{ font-size:11px; margin-bottom:2px; color:#374151; }
  .entry-dock .route-toolbar input[type=text],
  .entry-dock .route-toolbar select{
    height:32px;
    padding:6px 10px;
    width:100%;              /* ‚Üê —Ä–æ–∑—Ç—è–≥—É—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–≤–æ—î—ó –≥—Ä—ñ–¥-–∫–æ–ª–æ–Ω–∫–∏ */
  }
  .entry-dock small.muted{ display:none; }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —Ä–æ–∑–∫–ª–∞–¥–∫–∞ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –¥–æ–∫—É –∑–∞ —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ—é —à–∏—Ä–∏–Ω–æ—é (–∫–ª–∞—Å–∏ –≤–∏—Å—Ç–∞–≤–ª—è—î JS) */
  .entry-dock.is-md .route-toolbar{
    grid-template-columns: 1fr 1fr 1fr; /* 3 –≥–Ω—É—á–∫—ñ –∫–æ–ª–æ–Ω–∫–∏; –ø—Ä–æ–º—ñ–∂–Ω—ñ –∑–∞–π–º—É—Ç—å 2 */
  }
  .entry-dock.is-md #intermediateField{ grid-column: span 2; } /* –∑—Ä–æ–±–∏—Ç–∏ "–ü—Ä–æ–º—ñ–∂–Ω—ñ" —à–∏—Ä—à–∏–º–∏ —É 2 –∫–æ–ª–æ–Ω–∫–∏ */

  .entry-dock.is-sm .route-toolbar{
    grid-template-columns: 1fr 1fr; /* –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–µ ‚Äî 2 –≥–Ω—É—á–∫—ñ –∫–æ–ª–æ–Ω–∫–∏ */
  }
  .entry-dock.is-sm #intermediateField{ grid-column: span 2; }

  /* –£ –≤—É–∑—å–∫–∏—Ö —Ä–µ–∂–∏–º–∞—Ö –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ —à–∏—Ä–∏–Ω–∏, —â–æ–± –Ω–µ –±—É–ª–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è */
  .entry-dock.is-md .route-toolbar .field,
  .entry-dock.is-md .route-toolbar .field.w220,
  .entry-dock.is-md .route-toolbar .field.w240,
  .entry-dock.is-md .route-toolbar .field.w260,
  .entry-dock.is-md .route-toolbar .field.w420,
  .entry-dock.is-md .route-toolbar .field.w160,
  .entry-dock.is-sm .route-toolbar .field,
  .entry-dock.is-sm .route-toolbar .field.w220,
  .entry-dock.is-sm .route-toolbar .field.w240,
  .entry-dock.is-sm .route-toolbar .field.w260,
  .entry-dock.is-sm .route-toolbar .field.w420,
  .entry-dock.is-sm .route-toolbar .field.w160{ min-width:0 !important; }
  .entry-dock .route-toolbar{ overflow-x:hidden; }

  /* Collapsed state */
  .entry-dock.collapsed{ padding:4px 6px; }
  .entry-dock.collapsed .route-toolbar .field,
  .entry-dock.collapsed datalist,
  .entry-dock.collapsed #logistsMsg,
  .entry-dock.collapsed small.muted{ display:none !important; }

  /* ===== –ê–¥–º—ñ–Ω-–º–µ–Ω—é (–≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫) ===== */
  .admin-menu .admin-item{ display:block; padding:8px 12px; color:#111; text-decoration:none; font-size:13px; }
  .admin-menu .admin-item:hover{ background:#f3f4f6; }
  /* –ì–æ–ª–æ–≤–Ω–µ (–º–æ–±—ñ–ª—å–Ω–µ) –º–µ–Ω—é */
  #mainMenu a{ display:block; padding:8px 12px; color:#111; text-decoration:none; font-size:13px; }
  #mainMenu a:hover{ background:#f3f4f6; }

  @media (max-width:640px){
    .entry-dock{ left:8px; right:8px; top:calc(var(--nav-real) + 8px); }
    /* –Ω–∞ –≤—É–∑—å–∫–∏—Ö ‚Äî –¥–æ–∑–≤–æ–ª–∏–º–æ –≥—Ä—ñ–¥—É –ø–µ—Ä–µ–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏—Å—å —É 2-3 —Ä—è–¥–∫–∏ */
    .entry-dock .route-toolbar{ grid-template-columns: 1fr 1fr; }
    .entry-dock .route-toolbar .field.w420{ min-width:240px; }
  }

  </style>
</head>
<body>

<header class="topbar">
  <div class="left">
    <button id="panelToggle" class="btn xs" title="–°—Ö–æ–≤–∞—Ç–∏/–ø–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å" data-label-full="‚óÄ –°—Ö–æ–≤–∞—Ç–∏" data-label-mini="‚óÄ" aria-label="–ü–µ—Ä–µ–º–∏–∫–∞—á –ø–∞–Ω–µ–ª—ñ">‚óÄ –°—Ö–æ–≤–∞—Ç–∏</button>
    <button id="compactToggle" class="btn xs" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º" aria-pressed="false">‚áÜ</button>
    <!-- –î–µ—Å–∫—Ç–æ–ø–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è -->
    <a class="nav-link" href="/">üè† –ö–∞—Ä—Ç–∞</a>
    <a class="nav-link" href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <!-- –ú–æ–±—ñ–ª—å–Ω–∏–π –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –º–µ–π–Ω-–º–µ–Ω—é -->
  <div id="mainMenuWrap" style="position:relative;">
      <button id="mainMenuBtn" class="btn xs" type="button" aria-haspopup="true" aria-expanded="false" title="–ú–µ–Ω—é"><span class="icon">‚ò∞</span> <span class="label">–ú–µ–Ω—é ‚ñæ</span></button>
      <div id="mainMenu" role="menu" aria-label="–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é" style="display:none; position:absolute; top:100%; left:0; min-width:180px; background:#fff; border:1px solid #d5d9e0; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.15); padding:6px 0; z-index:5000;">
        <a href="/" class="admin-item" role="menuitem">üè† –ö–∞—Ä—Ç–∞</a>
        <a href="/export/" class="admin-item" role="menuitem">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
      </div>
    </div>
    <!-- –ì—Ä—É–ø–æ–≤–∞–Ω–∏–π –≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ –∞–¥–º—ñ–Ω-—Å—Ç–æ—Ä—ñ–Ω–æ–∫ -->
    <div id="adminMenuWrap" class="admin-menu" style="display:none; position:relative;">
  <button id="adminMenuBtn" class="btn xs" type="button" aria-haspopup="true" aria-expanded="false" title="–ê–¥–º—ñ–Ω—Å—å–∫—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏" data-label-full="üîß –ê–¥–º—ñ–Ω —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ‚ñæ" data-label-mini="üîë" aria-label="–ê–¥–º—ñ–Ω—Å—å–∫—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏"><span id="adminKeyIcon" aria-hidden="true">üîë</span><span id="roleEmoji" aria-hidden="true" style="display:none; margin-left:4px;">üë§</span> <span class="label" style="margin-left:4px;">üîß –ê–¥–º—ñ–Ω —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ‚ñæ</span></button>
      <div id="adminMenu" class="admin-menu-dropdown" role="menu" aria-label="–ê–¥–º—ñ–Ω—Å—å–∫—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏" style="display:none; position:absolute; top:100%; left:0; min-width:220px; background:#fff; border:1px solid #d5d9e0; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.15); padding:6px 0; z-index:5000;">
        <a href="/admin.html" class="admin-item" role="menuitem">üë®‚Äçüíª –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</a>
        <a href="/Firestore_Viewe.html" target="_blank" class="admin-item" role="menuitem">üìÇ Firestore Viewer</a>
        <a href="/admin/geojson-builder.html" class="admin-item" role="menuitem">üß≠ GeoJSON Builder</a>
        <a href="/import/" class="admin-item" role="menuitem">üì• –Ü–º–ø–æ—Ä—Ç (–¥–æ–≤—ñ–¥–Ω–∏–∫)</a>
        <a href="/import/upload-routes.html" class="admin-item" role="menuitem">‚¨Ü –Ü–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (—Ñ–∞–π–ª)</a>
      </div>
    </div>
  </div>

  <div class="spacer"></div>

  <div id="notifArea" class="right">
    <button id="notifBell" class="btn">üîî <span class="label">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span><span id="notifCount"></span></button>
    <div id="notifDropdown" role="region" aria-label="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
      <header>
        <span>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span>
        <div>
          <button id="notifClear" class="btn xs">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
      </header>
      <ul id="notifList"></ul>
    </div>
  </div>

  <div id="authBar" class="right collapsed">
    <span id="authHello" class="chip">–ì—ñ—Å—Ç—å</span>
    <span id="roleChip" class="chip">–†–æ–ª—å: ‚Äì</span>

    <input id="authEmail" type="text" placeholder="email (–Ω–∞–ø—Ä–∏–∫–ª. user@demo.fake)" autocomplete="username">
    <input id="authPass"  type="password" placeholder="–ø–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button id="authLogin"  class="btn">–£–≤—ñ–π—Ç–∏</button>
    <button id="authLogout" class="btn" style="display:none">–í–∏–π—Ç–∏</button>
  </div>

  <button id="mobileAuthToggle" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –≤—Ö—ñ–¥">üîê –í—Ö—ñ–¥</button>
</header>
<div id="splash">
  <div class="spinner"></div>
  <div>–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—ÉüîÑ‚Ä¶</div>
</div>

<!-- –í–µ—Ä—Ö–Ω—ñ–π –±–ª–æ–∫ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—É -->
<div id="topEntryDock" class="entry-dock" role="region" aria-label="–í–≤–µ–¥–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É">
  <button id="entryDockCollapse" class="entry-toggle" title="–ó–≥–æ—Ä–Ω—É—Ç–∏/—Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –ø–∞–Ω–µ–ª—å" aria-label="–ó–≥–æ—Ä–Ω—É—Ç–∏">‚ñ¥</button>
  <div class="route-toolbar" id="routeToolbar">
    <div class="field w220">
      <label for="fromName">–í—ñ–¥</label>
      <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
    </div>
    <div class="field w220">
      <label for="toName">–î–æ</label>
      <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
    </div>
    <div class="field w160">
      <label for="routeType">–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç—É</label>
      <select id="routeType">
        <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
      </select>
    </div>
    <div class="field w160">
      <label for="routePurpose">–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</label>
      <select id="routePurpose">
        <option value="–ó–µ—Ä–Ω–æ" selected>–ó–µ—Ä–Ω–æ</option>
        <option value="–û–î">–û–î</option>
        <option value="–¢–ú–¶">–¢–ú–¶</option>
      </select>
    </div>
    <div class="field w160">
      <label for="hubSelect">–•–∞–±</label>
      <select id="hubSelect">
        <option value="">‚Äî –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî</option>
        <option value="–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π">–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π</option>
        <option value="–ó–∞—Ö—ñ–¥–Ω–∏–π">–ó–∞—Ö—ñ–¥–Ω–∏–π</option>
        <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π</option>
        <option value="–£—Ä–æ–∂–∞–π–Ω–∞ –∫—Ä–∞—ó–Ω–∞">–£—Ä–æ–∂–∞–π–Ω–∞ –∫—Ä–∞—ó–Ω–∞</option>
      </select>
    </div>
    <div id="intermediateField" class="field w420">
      <label for="intermediateText">–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏</label>
      <input id="intermediateText" type="text" placeholder="–ù–∞–ø—Ä.: –ù–µ–º–∏—Ä—ñ–≤; –ì–∞–π—Å–∏–Ω; –¢—É–ª—å—á–∏–Ω">
    </div>
    <div class="field w240">
      <label for="logistInput">–õ–æ–≥—ñ—Å—Ç (—Ö—Ç–æ —Å—Ç–≤–æ—Ä—é—î)</label>
      <input id="logistInput" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –ø—Ä—ñ–∑–≤–∏—â–µ..." list="logistsList" autocomplete="off">
    </div>
  </div>
  <datalist id="directoryList"></datalist>
  <datalist id="logistsList"></datalist>
  <div id="logistsMsg"></div>
  <small class="muted">–°–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤ –±–µ—Ä–µ—Ç—å—Å—è –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó <b>logists</b> (–∞–∫—Ç–∏–≤–Ω—ñ).</small>
</div>

<div id="controls">
  <!-- === –ü–ê–ù–ï–õ–¨ 1: –°–¢–í–û–†–ï–ù–ù–Ø –ú–ê–†–®–†–£–¢–£ (–æ—Å–Ω–æ–≤–Ω–∞) === -->
  <div id="panel-create" class="panel active">
    <div class="panel-head">
      <!-- –Ω–æ–≤–µ –∫–æ–º–ø–æ–Ω—É–≤–∞–Ω–Ω—è: –∑–ª—ñ–≤–∞ —Å—Ç–æ–≤–ø—á–∏–∫ –∫–Ω–æ–ø–æ–∫, —Å–ø—Ä–∞–≤–∞ –≤–µ—Ä—Ö–Ω—ñ–π —ñ–Ω–ª–∞–π–Ω-—Ä—è–¥–æ–∫ –ø–æ–ª—ñ–≤ -->
      <div class="layout">
        <div class="tools-left">
          <button id="toggleAdd" class="btn xs"><span class="lbl">–ú–∞—Ä—à—Ä—É—Ç</span><span class="kbd">Ctrl+1</span></button>
          <button id="startLineMode" class="btn xs" title="–î–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –ª—ñ–Ω—ñ–π–∫–∏"><span class="lbl">–õ—ñ–Ω—ñ–π–∫–∞(–ø–æ—á.)</span><span class="kbd">Ctrl+S</span></button>
          <button id="endLineMode" class="btn xs" title="–î–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –∫—ñ–Ω—Ü–µ–≤–æ—ó –ª—ñ–Ω—ñ–π–∫–∏"><span class="lbl">–õ—ñ–Ω—ñ–π–∫–∞(–∫—ñ–Ω.)</span><span class="kbd">Ctrl+E</span></button>
          <button id="clearRoute" class="btn xs">–û—á–∏—Å—Ç. –º–∞—Ä—à.</button>
          <button id="clearRulers" class="btn xs" title="–û—á–∏—Å—Ç–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É –ª—ñ–Ω—ñ–π–∫—É, –∞–±–æ –æ–±–∏–¥–≤—ñ —è–∫—â–æ —Ä–µ–∂–∏–º –ª—ñ–Ω—ñ–π–∫–∏ –≤–∏–º–∫–Ω–µ–Ω–æ">–û—á–∏—Å—Ç. –ª—ñ–Ω.</button>
          <button id="popRulerPoint" class="btn xs" title="–í–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é —Ç–æ—á–∫—É –∞–∫—Ç–∏–≤–Ω–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">‚Üê –û—Å—Ç–∞–Ω–Ω—è —Ç–æ—á–∫–∞ (–ª—ñ–Ω.)</button>
          <button id="findSimilarBtn" class="btn xs" title="–ó–Ω–∞–π—Ç–∏ —Å—Ö–æ–∂—ñ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ –ë–î –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–º–∏ –í—ñ–¥/–î–æ">üîé –°—Ö–æ–∂—ñ (–í—ñ–¥/–î–æ)</button>
          <button id="toggleMarkers" class="btn xs">üìç –¢–æ—á–∫–∏</button>
          <button id="toggleGeozones" class="btn xs">üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏</button>
          <button id="toggleRoadGrid" class="btn xs" title="–ü–æ–∫–∞–∑–∞—Ç–∏/–ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Å—ñ—Ç–∫—É –¥–æ—Ä—ñ–≥">üõ£ –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—ñ—Ç–∫—É –¥–æ—Ä—ñ–≥</button>
          <button id="exportPng" class="btn xs" title="–ï–∫—Å–ø–æ—Ä—Ç PNG —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞ –∫–∞—Ä—Ç–∏">üñºÔ∏è –ï–∫—Å–ø–æ—Ä—Ç PNG</button>
        </div>
        <div class="head-right"></div>
      </div>

      <details id="fileIoSection" style="margin-top:4px;">
        <summary><b>üìÅ –§–∞–π–ª–∏ (JSON/KML)</b></summary>
        <div class="btn-row" style="margin-top:6px;">
          <button id="saveRoute" class="btn xs">üíæ Route JSON</button>
          <button id="loadRoute" class="btn xs">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ JSON</button>
          <button id="saveRouteKml" class="btn xs">üíæ Route KML</button>
          <button id="loadRouteKml" class="btn xs">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ KML</button>
          <input type="file" id="fileInput" accept=".json" style="display:none;">
          <input type="file" id="fileInputKml" accept=".kml,.xml" style="display:none;">
        </div>
      </details>

      <div class="km-chip">
        —Ç–æ—á–∫–∏: <span id="countRoute">0</span> ‚Ä¢
        –ª—ñ–Ω(–ø–æ—á): <span id="countStart">0</span> ‚Ä¢
        –ª—ñ–Ω(–∫—ñ–Ω): <span id="countEnd">0</span> ‚Ä¢
        –≤—Å—å–æ–≥–æ: <span id="countTotal">0</span>
      </div>
    </div>

    <hr/>

  

    <!-- –°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ —É –Ω–∏–∂–Ω—ñ–π –ª—ñ–≤–∏–π –∫—É—Ç; —Ü–µ–π –±–ª–æ–∫ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ) -->
    <details style="display:none">
      <summary><b>–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏</b></summary>
      <div id="styleSelector" style="margin-top:10px;">
        <label for="mapStyle">–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏:</label>
        <select id="mapStyle">
          <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
          <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
          <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
          <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
        </select>
      </div>
    </details>

    <!-- –ë–∞–∑–∞ (–ª–∏—à–µ –Ω–∞–∑–≤–∞ + –∑–±–µ—Ä–µ–≥—Ç–∏ + –æ—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É) -->
    <div id="dbCreate" class="section">
      <div><strong>–ë–∞–∑–∞ (Firestore)</strong></div>
      <input id="routeName" type="text" placeholder="–ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É (–∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏)" />
      <div class="btn-row" style="margin-top:6px;">
        <button id="saveToDB" class="btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î</button>
        <button id="clearForm" class="btn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
      </div>
    </div>
  </div>

  <!-- === –ü–ê–ù–ï–õ–¨ 2: –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –Ü–ó –ë–ê–ó–ò / –°–ï–†–í–Ü–°–ù–Ü –ö–ù–ü–ö–ò === -->
  <div id="panel-load" class="panel">
    <!-- –î–æ–≤—ñ–¥–Ω–∏–∫–∏/–∫–µ—à—ñ -->
    <div id="dirControls">
      <div><strong>–î–æ–≤—ñ–¥–Ω–∏–∫–∏</strong></div>
      <div class="btn-row" style="margin-top:4px;">
        <button id="refreshDirectory" class="btn xs">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫</button>
        <button id="clearDirCache" class="btn xs">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à</button>
      </div>
      <div class="btn-row" style="margin-top:6px;">
        <button id="refreshLogists" class="btn xs">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤</button>
        <button id="clearLogistsCache" class="btn xs">üßπ –ö–µ—à –ª–æ–≥—ñ—Å—Ç—ñ–≤</button>
      </div>
      <small class="muted">–î–∞–Ω—ñ –ª–æ–≥—ñ—Å—Ç—ñ–≤ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∑ Firestore. –ê–¥–º—ñ–Ω –∑–º—ñ–Ω—é—î —ó—Ö —É –∫–æ–ª–µ–∫—Ü—ñ—ó <b>logists</b>.</small>
    </div>

    <!-- –†–æ–±–æ—Ç–∞ –∑ –ø–µ—Ä–µ–ª—ñ–∫–æ–º –º–∞—Ä—à—Ä—É—Ç—ñ–≤ -->
    <div id="dbLoad" class="section">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <strong>–ú–∞—Ä—à—Ä—É—Ç–∏ (–ë–î)</strong>
        <small id="routesFound" class="muted"></small>
      </div>

      <div class="routes-search-wrap" style="position:relative;">
  <!-- –ü—Ä–∏–±—Ä–∞–Ω–æ list="routesList", —â–æ–± –Ω–µ –≤—ñ–¥–∫—Ä–∏–≤–∞–≤—Å—è –Ω–∞—Ç–∏–≤–Ω–∏–π datalist –ø–æ–≤–µ—Ä—Ö –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ø–∞–ø—É -->
  <input id="routeSearch" type="text" placeholder="üîé –ü–æ—à—É–∫ –º–∞—Ä—à—Ä—É—Ç—É..." autocomplete="off" />
        <datalist id="routesList"></datalist>
        <!-- –ö–∞—Å—Ç–æ–º–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø—ñ–¥–∫–∞–∑–æ–∫ —ñ–∑ —Ç—É–ª—Ç—ñ–ø–∞–º–∏ -->
        <div id="routesPopup" style="display:none; position:absolute; z-index: 20; left:0; top:100%; width:100%; max-height: 260px; overflow:auto; box-shadow:0 6px 16px rgba(0,0,0,.2); border:1px solid #d0d0d0; background:#fff; border-radius:6px; margin-top:4px;"></div>
      </div>

      <!-- select –∑–∞–ª–∏—à–µ–Ω–æ –≤ DOM –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∞–ª–µ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ: –ª–æ–≥—ñ–∫–∞ –≤–∏–±–æ—Ä—É –ø–µ—Ä–µ—ó—Ö–∞–ª–∞ —É –ø–æ—à—É–∫ + datalist -->
      <select id="remoteRoutes" style="display:none; min-width:260px; margin-top:6px;">
        <option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>
      </select>

      <div class="btn-row" style="margin-top:6px;">
        <button id="refreshList" class="btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
        <button id="loadMoreRoutes" class="btn">‚¨áÔ∏è –©–µ</button>
        <button id="loadAllRoutes" class="btn">üì• –í—Å—ñ</button>
        <button id="loadFromDB" class="btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ –ë–î</button>
        <button id="deleteFromDB" class="btn">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –ë–î</button>
      </div>
    </div>
  </div>

  <!-- === –ü–ê–ù–ï–õ–¨ 3: –ü–û–ì–û–î–ñ–ï–ù–ù–Ø === -->
  <div id="panel-approve" class="panel">
    <div id="approvalPanel">
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <span class="km-chip">–°—Ç–∞—Ç—É—Å: <b id="approvalStatus">‚Äî</b></span>
        <button id="sendForApproval" class="btn xs" title="–ü–æ–¥–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è –°–ë">üì® –ù–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è</button>
        <button id="copyReviewLink" class="btn xs" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –°–ë">üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <a id="openReviewLink" class="btn xs" target="_blank" style="display:none">üëÅ‚Äçüó® –ü–µ—Ä–µ–≥–ª—è–¥</a>
      </div>

      <div id="approvalCommentWrap" style="margin-top:6px; display:none;">
        <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –°–ë (—è–∫—â–æ –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ)</label>
        <textarea id="approvalComment" readonly></textarea>
      </div>

      <!-- –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –°–ë: –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ –¥—ñ—ó –¥–ª—è –ª–æ–≥—ñ—Å—Ç–∞ -->
      <div id="proposalWrapMain" style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed var(--line);">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:6px;">
          <span class="km-chip" id="proposalKmChip">–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –°–ë: ‚Äî</span>
          <button id="btnShowProposal" class="btn xs">üëÅ –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</button>
          <button id="btnAcceptProposal" class="btn xs">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</button>
          <button id="btnRejectProposal" class="btn xs">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</button>
        </div>
        <small class="muted">–ñ–æ–≤—Ç–∏–º –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –º–∞—Ä—à—Ä—É—Ç, –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π –°–ë. –ü—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–º—ñ–Ω–∏—Ç—å –ø–æ—Ç–æ—á–Ω—ñ —Ç–æ—á–∫–∏ —Ç–∞ –ª—ñ–Ω—ñ–π–∫–∏ –º–∞—Ä—à—Ä—É—Ç—É.</small>
      </div>
    </div>
  </div>
</div>

<div id="map"></div>
<!-- –ó–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∏–π —Å—Ç–∞—Ç—É—Å –º–∞—Ä—à—Ä—É—Ç—É -->
<!-- –î–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó (–ø—Ä–∞–≤–æ—Ä—É—á —É–≥–æ—Ä—ñ) -->
<div id="statusDock">
  <div id="statusChip" class="status-chip" data-status="draft">üìù –°—Ç–∞—Ç—É—Å: –ß–µ—Ä–Ω–µ—Ç–∫–∞</div>
  <div id="distanceChip" class="status-chip">üìè –í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º: <span id="distanceTop">0</span></div>
</div>

<!-- –ü–µ—Ä–µ–º–∏–∫–∞—á –ø–∞–Ω–µ–ª–µ–π (–ø—Ä–∞–≤–æ—Ä—É—á –≤–Ω–∏–∑—É) -->
<div id="panelDock">
  <button class="dock-btn active" data-panel="panel-create"><span class="icon">‚úèÔ∏è</span><span class="label">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è</span></button>
  <button class="dock-btn" data-panel="panel-load"><span class="icon">üìö</span><span class="label">–ë–∞–∑–∞</span></button>
  <button class="dock-btn" data-panel="panel-approve"><span class="icon">‚úÖ</span><span class="label">–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è</span></button>
</div>

<!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç–∏–ª—é –∫–∞—Ä—Ç–∏ (–Ω–∏–∂–Ω—ñ–π –ª—ñ–≤–∏–π –∫—É—Ç) -->
<div id="styleDock" class="style-dock" title="–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏">
  <select id="mapStyleDock">
    <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
    <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
    <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
    <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
  </select>
  <input id="placeSearch" type="text" list="placeList" placeholder="–ü–æ—à—É–∫‚Ä¶" autocomplete="off" />
  <datalist id="placeList"></datalist>
  <div class="mapbox-brand">mapbox</div>
  
</div>

<div id="contextMenu">
  <div id="insertBefore">‚ûï–í—Å—Ç–∞–≤–∏—Ç–∏ –ø–µ—Ä–µ–¥</div>
  <div id="insertAfter">‚ûï–í—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ—Å–ª—è</div>
  <div id="deletePoint">‚ùå–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É</div>
</div>

<div id="dupModal" class="modal" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="dupTitle">
    <div id="dupTitle" class="modal-title">–ú–∞—Ä—à—Ä—É—Ç –≤–∂–µ —ñ—Å–Ω—É—î</div>
    <div class="modal-body">
      <div id="dupText"></div>
    </div>
    <div class="modal-actions">
      <button id="dupOverwrite" class="btn">–û–∫ ‚Äî –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏</button>
      <button id="dupCopy" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–ø—ñ—é</button>
      <button id="dupCancel" class="btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<!-- Modal: –°—Ö–æ–∂—ñ –º–∞—Ä—à—Ä—É—Ç–∏ -->
<div id="similarModal" class="modal" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="similarTitle">
    <div id="similarTitle" class="modal-title">–°—Ö–æ–∂—ñ –º–∞—Ä—à—Ä—É—Ç–∏</div>
    <div class="modal-body">
      <div id="similarList" style="display:flex;flex-direction:column;gap:6px;max-height:50vh;overflow:auto"></div>
      <div id="similarEmpty" style="display:none;color:#6b7280">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –í—ñ–¥/–î–æ.</div>
    </div>
    <div class="modal-actions">
      <button id="similarClose" class="btn">–ó–∞–∫—Ä–∏—Ç–∏</button>
      <button id="similarClearPreview" class="btn" style="display:none">–ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π</button>
    </div>
  </div>
  </div>

<!-- AUTH GUARD (cache-first, –±–µ–∑ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏) -->
<script>
/* ====== –ê–¥–º—ñ–Ω—Å—å–∫–µ –≤–∏–ø–∞–¥–∞—é—á–µ –º–µ–Ω—é ====== */
function setupAdminMenu(isAdmin){
  const wrap = document.getElementById('adminMenuWrap');
  if (!wrap) return;
  wrap.style.display = isAdmin ? 'inline-block' : 'none';
  if (!isAdmin) return;
  const btn = document.getElementById('adminMenuBtn');
  const menu = document.getElementById('adminMenu');
  if (!btn || !menu) return;
  function close(){ menu.style.display='none'; btn.setAttribute('aria-expanded','false'); }
  function open(){ menu.style.display='block'; btn.setAttribute('aria-expanded','true'); }
  btn.onclick = (e)=>{ e.preventDefault(); (menu.style.display==='block') ? close() : open(); };
  document.addEventListener('click', (ev)=>{ if (!wrap.contains(ev.target)) close(); });
  document.addEventListener('keydown', (ev)=>{ if (ev.key==='Escape') close(); });
}

/* ====== –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é (–º–æ–±—ñ–ª—å–Ω–µ) ====== */
function setupMainMenu(){
  const wrap = document.getElementById('mainMenuWrap');
  if (!wrap) return;
  const btn = document.getElementById('mainMenuBtn');
  const menu = document.getElementById('mainMenu');
  if (!btn || !menu) return;
  function close(){ menu.style.display='none'; btn.setAttribute('aria-expanded','false'); }
  function open(){ menu.style.display='block'; btn.setAttribute('aria-expanded','true'); }
  btn.onclick = (e)=>{ e.preventDefault(); (menu.style.display==='block') ? close() : open(); };
  document.addEventListener('click', (ev)=>{ if (!wrap.contains(ev.target)) close(); });
  document.addEventListener('keydown', (ev)=>{ if (ev.key==='Escape') close(); });
}

/* ====== –†–æ–ª—å-–µ–º–æ–¥–∑—ñ –Ω–∞ –∫–Ω–æ–ø—Ü—ñ –∞–¥–º—ñ–Ω-–º–µ–Ω—é (–º–æ–±—ñ–ª—å–Ω–æ) ====== */
function setRoleVisual(role){
  try{
    const map = {
      admin: 'üë®‚Äçüíª',
      logist: 'üöõ',
      reviewer: 'üëÆüèª‚Äç‚ôÇÔ∏è',
      pending: 'üöß',
      user: 'üë§',
      guest: 'üë§'
    };
    const emoji = map[String(role||'guest').toLowerCase()] || 'üë§';
    const el = document.getElementById('roleEmoji');
    if (el){ el.textContent = emoji; }
  }catch(_){ }
}
(function(){
  const CFG = window.APP_CONFIG?.firebase;
  if (!CFG) {
    console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js');
    return;
  }
    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) {}

  // (–†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û) —Ñ–æ—Ä—Å—É–≤–∞—Ç–∏ long-polling —É ¬´–≤—É–∑—å–∫–∏—Ö¬ª –º–µ—Ä–µ–∂–∞—Ö
  try {
    firebase.firestore().settings({
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });
  } catch(_) {}

  // –£–≤—ñ–º–∫–Ω—É—Ç–∏ persistence –î–û –ø–µ—Ä—à–∏—Ö —á–∏—Ç–∞–Ω—å —ñ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ–º—ñ—Å –≥–ª–æ–±–∞–ª—å–Ω–æ
  window.__PERSISTENCE_PROMISE = (async () => {
    try { await firebase.firestore().enablePersistence({ synchronizeTabs: true }); }
    catch(_) {} // –æ–∫, —è–∫—â–æ –≤–∂–µ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –∞–±–æ —ñ–Ω—à–∞ –≤–∫–ª–∞–¥–∫–∞
  })();

  const auth = firebase.auth();
  const db   = firebase.firestore();

  const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
  const ALLOWED  = new Set(['admin','logist','user']);

  // –ù–ï —Ö–æ–≤–∞—î–º–æ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äì –ø–æ–∫–∞–∑—É—î–º–æ –æ–¥—Ä–∞–∑—É.
  auth.onAuthStateChanged(async (u) => {
    if (!u) { location.replace(loginURL); return; }
        // –¥–æ—á–µ–∫–∞—Ç–∏—Å—è, —â–æ–± –∫–µ—à —Ä–µ–∞–ª—å–Ω–æ –ø—ñ–¥–≥–æ—Ç—É–≤–∞–≤—Å—è
    if (window.__PERSISTENCE_PROMISE) {
      try { await window.__PERSISTENCE_PROMISE; } catch(_) {}
    }

    // 1) —à–≤–∏–¥–∫–æ –±–µ—Ä–µ–º–æ —Ä–æ–ª—å —ñ–∑ –∫–µ—à—É (—è–∫—â–æ —î) ‚Äî –ª–∏—à–µ users/{uid}
    let role = null;
    try {
      const snap = await db.collection('users').doc(u.uid).get({ source: 'cache' });
      role = snap.exists ? String(snap.data().role ?? 'pending').trim().toLowerCase() : null;
      console.log('[role][cache] uid:', u.uid, 'role:', role, 'data:', snap.data());
    } catch (e) { console.warn('[role][cache] error:', e?.message||e); }

  window.__userRole = role || 'guest';

  // –ü–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è –∞–¥–º—ñ–Ω-–ª—ñ–Ω–∫—ñ–≤ ¬´–Ω–∞ –∑–∞—Ä–∞–∑¬ª + —Ä–æ–ª—å-–µ–º–æ–¥–∑—ñ
  setupAdminMenu(window.__userRole === 'admin');
  setRoleVisual(window.__userRole);
  setupMainMenu();

    // 2) —Ç–∏—Ö–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–ª—å –∑ —Å–µ—Ä–≤–µ—Ä–∞ —ñ, —è–∫—â–æ –Ω–µ –æ–∫ ‚Äî —Ä–µ–¥—ñ—Ä–µ–∫—Ç–∏–º–æ
    (async () => {
      try {
        const s = await db.collection('users').doc(u.uid).get({ source: 'server' });
        const r = s.exists ? String(s.data().role ?? 'pending').trim().toLowerCase() : 'pending';
        window.__userRole = r;
        console.log('[role][server] uid:', u.uid, 'role:', r, 'data:', s.data());

  setupAdminMenu(r === 'admin');
  setRoleVisual(r);

        if (!ALLOWED.has(r)) {
          alert(r === 'pending'
            ? '–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
            : '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏.');
          location.replace(loginURL);
        }
      } catch (e) {
        console.error('Role check (server) failed:', e);
        if (e && (e.code === 'permission-denied' || /permission/i.test(String(e.message||'')))){
          alert('–ù–µ–º–∞—î –¥–æ–∑–≤–æ–ª—É —á–∏—Ç–∞—Ç–∏ users/' + u.uid + '. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore (allow read –¥–ª—è —Å–≤–æ–≥–æ uid).');
        }
      }
    })();
  });
})();
</script>

<script>
/* ===================== Mapbox init ===================== */
mapboxgl.accessToken = window.APP_CONFIG?.mapboxToken || '';
if (!mapboxgl.accessToken) console.error('APP_CONFIG.mapboxToken –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.');
let currentStyle = 'mapbox://styles/mapbox/streets-v12';
const map = new mapboxgl.Map({
  container: 'map',
  style: currentStyle,
  center: [28.468, 49.234],
  zoom: 12,
  preserveDrawingBuffer: true
});

/* ‚¨áÔ∏è –¥–æ–¥–∞–π —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é */
function hideSplash(){
  const s = document.getElementById('splash');
  if (s) { s.classList.add('hide'); setTimeout(() => s.remove(), 300); }
}
// –ü—Ä–∞–ø–æ—Ä–µ—Ü—å: –∫–æ–ª–∏ –º–æ–∂–Ω–∞ —Ö–æ–≤–∞—Ç–∏ —Å–ø–ª–µ—à. –°—Ç–∞—î true –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
window.__canHideSplash = false;

// –†–æ–∑–º—ñ—â–µ–Ω–Ω—è –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –¥–æ–∫—É (–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ —è–∫ –Ω–∞ –º–∞–∫–µ—Ç—ñ: –≤—ñ–¥ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—é –ª—ñ–≤–æ—ó –ø–∞–Ω–µ–ª—ñ –¥–æ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—é –µ–∫—Ä–∞–Ω—É)
function positionEntryDock(){
  const dock = document.getElementById('topEntryDock');
  if (!dock) return;
  let left = 8; // –≤—ñ–¥—Å—Ç—É–ø –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, –∫–æ–ª–∏ –ª—ñ–≤–∞ –ø–∞–Ω–µ–ª—å —Å—Ö–æ–≤–∞–Ω–∞
  const controls = document.getElementById('controls');
  if (controls) {
    const cs = getComputedStyle(controls);
    if (cs.display !== 'none' && cs.visibility !== 'hidden'){
      const rect = controls.getBoundingClientRect();
      if (rect && rect.right) left = Math.max(8, Math.round(rect.right + 8));
    }
  }
  dock.style.left = left + 'px';
  dock.style.right = '8px';
  dock.style.top = 'calc(var(--nav-real) + 8px)';
  // –î–∏–Ω–∞–º—ñ—á–Ω—ñ –∫–ª–∞—Å–∏ —à–∏—Ä–∏–Ω–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—ó —Å—ñ—Ç–∫–∏: –ø–æ—î–¥–Ω–∞–Ω–Ω—è –ø–æ—Ä–æ–≥—ñ–≤ —ñ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–º—ñ—Ä—É –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è
  try{
    const toolbar = document.getElementById('routeToolbar');
    dock.classList.remove('is-sm','is-md');

    const vw = window.innerWidth || document.documentElement.clientWidth || 0;
    const avail = Math.max(0, vw - left - 8); // —Ñ–∞–∫—Ç–∏—á–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–æ–∫—É
    // –ü–æ—á–∞—Ç–∫–æ–≤–µ –ø—Ä–∏–ø—É—â–µ–Ω–Ω—è –∑–∞ –ø–æ—Ä–æ–≥–∞–º–∏ (—Ç—Ä–æ—Ö–∏ –ø—ñ–¥–Ω—è–≤ –ø–æ—Ä–æ–≥–∏)
    if (avail < 1400) dock.classList.add('is-md');
    if (avail < 1100) dock.classList.add('is-sm');

    const isOverflowing = () => toolbar && (toolbar.scrollWidth - toolbar.clientWidth) > 2;

    // –Ø–∫—â–æ –≤—Å–µ —â–µ –Ω–µ –≤–ª–∞–∑–∏—Ç—å ‚Äî ¬´–µ—Å–∫–∞–ª—é—î–º–æ¬ª —Ä–µ–∂–∏–º
    if (!dock.classList.contains('is-md') && isOverflowing()) {
      dock.classList.add('is-md');
      // —Ñ–æ—Ä—Å—É—î–º–æ reflow –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
      void toolbar.offsetWidth;
    }
    if (!dock.classList.contains('is-sm') && isOverflowing()) {
      dock.classList.add('is-sm');
      void toolbar.offsetWidth;
    }
  }catch(_){}
  positionStatusDock();
}
window.addEventListener('resize', positionEntryDock);
document.addEventListener('DOMContentLoaded', positionEntryDock);
// —Ç–∞–∫–æ–∂ –ø—ñ–¥—Ç—Ä–∏–º—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—é —Å—Ç–∞—Ç—É—Å-–¥–æ–∫—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É/—Å—Ç–∞—Ä—Ç—ñ
window.addEventListener('resize', positionStatusDock);
document.addEventListener('DOMContentLoaded', positionStatusDock);
// –ü—ñ—Å–ª—è –∫–ª—ñ–∫—É —Å—Ö–æ–≤–∞—Ç–∏/–ø–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å ‚Äî –æ–Ω–æ–≤–∏–º–æ –ø–æ–∑–∏—Ü—ñ—é –¥–æ–∫—É
setTimeout(() => {
  const toggle = document.getElementById('panelToggle');
  if (toggle) toggle.addEventListener('click', () => setTimeout(positionEntryDock, 0));
}, 0);

// –ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å-–¥–æ–∫—É –ø—ñ–¥ –≤–µ—Ä—Ö–Ω—ñ–º –¥–æ–∫–æ–º, —è–∫—â–æ —Ç–æ–π —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π
// –ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞: –ø—Ä–∏—Ç–∏—Å–∫–∞—î–º–æ —Å—Ç–∞—Ç—É—Å-–¥–æ–∫ –¥–æ–Ω–∏–∑—É, –ø—Ä—è–º–æ –Ω–∞–¥ –∫–Ω–æ–ø–∫–∞–º–∏ –ø–∞–Ω–µ–ª–µ–π (panelDock)
function positionStatusDock(){
  try{
    const dock = document.getElementById('panelDock');
    const h = dock ? Math.round(dock.getBoundingClientRect().height) : 0;
    document.documentElement.style.setProperty('--panel-dock-h', h + 'px');
  }catch(_){
    document.documentElement.style.setProperty('--panel-dock-h', '0px');
  }
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–Ω–æ–ø–∫–∏ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –¥–æ–∫—É –∑ –∑–∞–ø–∞–º'—è—Ç–æ–≤—É–≤–∞–Ω–Ω—è–º —Å—Ç–∞–Ω—É
function initEntryDockCollapse(){
  const dock = document.getElementById('topEntryDock');
  const btn  = document.getElementById('entryDockCollapse');
  if (!dock || !btn) return;

  function updateBtn(){
    const collapsed = dock.classList.contains('collapsed');
    btn.textContent = collapsed ? '‚ñæ' : '‚ñ¥';
    try{
      btn.setAttribute('aria-label', collapsed ? '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏' : '–ó–≥–æ—Ä–Ω—É—Ç–∏');
      btn.title = collapsed ? '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –ø–∞–Ω–µ–ª—å' : '–ó–≥–æ—Ä–Ω—É—Ç–∏ –ø–∞–Ω–µ–ª—å';
    }catch(_){ }
  }

  try{
    const stored = localStorage.getItem('entryDockCollapsed');
    if (stored === '1' || stored === 'true') dock.classList.add('collapsed');
  } catch(_){}
  updateBtn();
  positionEntryDock();

  btn.addEventListener('click', () => {
    dock.classList.toggle('collapsed');
    try{ localStorage.setItem('entryDockCollapsed', dock.classList.contains('collapsed') ? '1' : '0'); } catch(_){}
    updateBtn();
    positionEntryDock();
  });
}

document.addEventListener('DOMContentLoaded', initEntryDockCollapse);

// –ë–µ–∑–ø–µ—á–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ Telegram —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π endpoint
function sendTelegramApprovalMessage(routeName, routeId){
  try{
    const reviewLink = (typeof reviewLinkForId === 'function') ? reviewLinkForId(routeId) : '';
    const endpoint = (window.APP_CONFIG && window.APP_CONFIG.telegramEndpoint)
      ? String(window.APP_CONFIG.telegramEndpoint)
      : '/api/telegram/send-approval'; // fallback to local/Firebase server if configured

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ routeName, routeId, reviewLink })
    })
    .then(r => r.json().catch(()=>({})))
    .then(res => {
      if (!res || res.ok !== true) console.warn('Telegram send failed:', res);
    })
    .catch(e => console.warn('Telegram request error:', e));
  } catch(e){
    console.warn('Telegram send error:', e);
  }
}

/* ==== MULTI TILESETS CONFIG (–∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Ñ–∞–π–ª) ==== */
let TILESETS = [];
let __tilesetsLoaded = false;
async function loadTilesetsConfigOnce(){
  if (__tilesetsLoaded) return;
  try{
    // 1) –°–ø—Ä–æ–±–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –∑ Firestore (–æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Ñ—ñ–≥, —è–∫–∏–π —Ä–µ–¥–∞–≥—É—î –∞–¥–º—ñ–Ω-UI)
    let fromFs = null;
    try{
      if (window.firebase?.firestore){
        const doc = await firebase.firestore().collection('config').doc('tilesets').get({ source: 'server' });
        if (doc.exists){
          const data = doc.data();
          if (Array.isArray(data)) fromFs = data;
          else if (data && Array.isArray(data.tilesets)) fromFs = data.tilesets;
        }
      }
    } catch(e){ console.warn('tilesets (Firestore) –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π:', e?.message||e); }

    if (Array.isArray(fromFs) && fromFs.length){
      TILESETS = fromFs;
    } else {
      // 2) –§–æ–ª–±–µ–∫ –Ω–∞ —Å—Ç–∞—Ç–∏—á–Ω–∏–π —Ñ–∞–π–ª
      try{
        const res = await fetch('/config/tilesets.json?v=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (Array.isArray(data)) TILESETS = data;
        else if (data && Array.isArray(data.tilesets)) TILESETS = data.tilesets;
        else {
          console.warn('tilesets.json: –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç (–æ—á—ñ–∫—É—î—Ç—å—Å—è –º–∞—Å–∏–≤ –∞–±–æ –ø–æ–ª–µ tilesets[])');
          TILESETS = [];
        }
      } catch(e){
        console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ /config/tilesets.json:', e?.message||e);
        TILESETS = [];
      }
    }
  } finally { __tilesetsLoaded = true; }
}
// –Ø–∫—â–æ —è–∫–∏–π—Å—å tileset –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –≤–∏–¥–∏–º–∏–º —É—Å—ñ–º ‚Äî —É –∫–æ–Ω—Ñ—ñ–≥—É –ø–æ—Å—Ç–∞–≤—Ç–µ hubs: ['*']

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –¥–æ–∑–≤–æ–ª–µ–Ω–æ tileset –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∑–∞ —Ö–∞–±–∞–º–∏
function tilesetAllowedForUser(ts){
  if (hasNoHubs()) return false;
  const tags = Array.isArray(ts.hubs) ? ts.hubs : [];
  if (!tags.length || tags.includes('*')) return true;    // –Ω–µ —Ä–æ–∑–º—ñ—á–µ–Ω–æ –∞–±–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π
  if (isAllHubs()) return true;                           // –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –¥–æ–∑–≤–æ–ª–µ–Ω–æ "–≤—Å—ñ —Ö–∞–±–∏"
  return tags.some(h => (ALLOWED_HUBS || []).includes(h));
}

// –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤–∏–¥–∏–º—ñ—Å—Ç—å —à–∞—Ä—ñ–≤ tileset-—ñ–≤ –∑–≥—ñ–¥–Ω–æ –¥–æ—Å—Ç—É–ø—É
function applyTilesetHubVisibility(){
  TILESETS.forEach(ts => {
    const vis = tilesetAllowedForUser(ts) ? 'visible' : 'none';
    const ids = [
      `tileset-fill-${ts.key}`,
      `tileset-outline-${ts.key}`,
      `tileset-hl-from-${ts.key}`,
      `tileset-hl-to-${ts.key}`,
      `tileset-hl-from-label-${ts.key}`,
      `tileset-hl-to-label-${ts.key}`,
    ];
    ids.forEach(id => { if (map.getLayer(id)) try{ map.setLayoutProperty(id, 'visibility', vis); }catch{} });
  });

  // –ü—ñ–¥–ø–∏—Å–∏ —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤ –ø–µ—Ä–µ–±—É–¥—É—î–º–æ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –≤–∏–¥–∏–º–∏—Ö —à–∞—Ä—ñ–≤
  try { buildGeozoneCentroids(); } catch(_) {}
}

// –ë–µ–∑–ø–µ—á–Ω–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ (–∫–æ–ª–∏ —Å—Ç–∏–ª—å —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è)
function applyTilesetHubVisibilitySafe(){
  try {
    if (!map || !map.isStyleLoaded || !map.isStyleLoaded()){
      map.once('style.load', applyTilesetHubVisibility);
    } else {
      applyTilesetHubVisibility();
    }
  } catch(_){}
}

// —Ç—Ä–µ–∫–∞—Ç–∏–º–µ–º–æ —Å—Ç–≤–æ—Ä–µ–Ω—ñ id —à–∞—Ä—ñ–≤, —â–æ–± –Ω–∞–≤–æ–¥–∏—Ç–∏/–ø—ñ–¥—Å–≤—ñ—á—É–≤–∞—Ç–∏
let TS_FILL_IDS = [];
let TS_OUTLINE_IDS = [];
let BOUND_HOVER_LAYERS = new Set(); // —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø–æ–¥—ñ—ó

/* ==== –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø–∞–Ω–µ–ª–µ–π (dock —É –ø—Ä–∞–≤–æ–º—É –Ω–∏–∂–Ω—å–æ–º—É –∫—É—Ç—ñ) ==== */
function showPanel(id){
  document.querySelectorAll('#controls .panel').forEach(p=>{
    p.classList.toggle('active', p.id === id);
  });
  // –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —É dock
  document.querySelectorAll('#panelDock .dock-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.panel === id);
  });
  // –ö–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–∞–Ω–µ–ª—å "–ë–∞–∑–∞" ‚Äî –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å,
  // —â–æ–± –ø–µ—Ä—à–∏–π –∫–ª—ñ–∫ –ø–æ —Å–µ–ª–µ–∫—Ç—É –≤—ñ–¥–∫—Ä–∏–≤–∞–≤—Å—è –æ–¥—Ä–∞–∑—É –±–µ–∑ "—Å—Ç—Ä–∏–±–∫–∞" —à–∏—Ä–∏–Ω–∏
  try {
    // –õ—ñ–Ω–∏–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: –±—ñ–ª—å—à–µ –ù–ï –≤–∞–Ω—Ç–∞–∂–∏–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –ø–∞–Ω–µ–ª—ñ.
    // –°–ø–∏—Å–æ–∫ –ø—ñ–¥—Ç—è–≥–Ω–µ–º–æ –ª–∏—à–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ –≤ –ø–æ–ª–µ –ø–æ—à—É–∫—É –∞–±–æ –ø—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ (–¥–∏–≤. –Ω–∏–∂—á–µ).
  } catch(_){}
  // –¥—Ä—ñ–±–Ω–∏–π —Ä–µ—Å–∞–π–∑ –∫–∞—Ä—Ç–∏ –ø—ñ—Å–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
  requestAnimationFrame(()=>{ try{ map.resize(); }catch(_){ } });
}

document.getElementById('panelDock').addEventListener('click', (e)=>{
  const btn = e.target.closest('.dock-btn');
  if (!btn) return;
  showPanel(btn.dataset.panel);
});

// —Å—Ç–∞—Ä—Ç–æ–≤–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
showPanel('panel-create');

/* ==== HIGHLIGHT (FROM/TO) CONFIG ==== */
// –î–æ–¥–∞—î–º–æ –±—ñ–ª—å—à–µ –º–æ–∂–ª–∏–≤–∏—Ö –∫–ª—é—á—ñ–≤ —ñ —Ä–æ–±–∏–º–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –±–µ–∑ —Ä–µ–≥—ñ—Å—Ç—Ä—É
const NAME_KEYS = ['Name','name','NAME','–ù–∞–∑–≤–∞','–ù–∞–∑–≤–∞ –ø–æ–ª—è','Title','title','Label','label'];
// –†–æ–∑—à–∏—Ä–µ–Ω–æ –ø–µ—Ä–µ–ª—ñ–∫ –º–æ–∂–ª–∏–≤–∏—Ö ¬´–∫–æ–¥—ñ–≤¬ª –¥–ª—è tileset/geojson, –±–æ –≤ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª–∞—Ö –∑—É—Å—Ç—Ä—ñ—á–∞—é—Ç—å—Å—è —Ä—ñ–∑–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏
// (id/fid/OBJECTID/OBJECTID_1 —Ç–æ—â–æ)
const CODE_KEYS = ['Code','code','CODE','–ö–æ–¥','Id','ID','id','fid','FID','OBJECTID','OBJECTID_1','objectid','objectid_1'];

let HL_IDS_FROM = [];
let HL_IDS_TO   = [];
// ‚¨áÔ∏è –Ω–æ–≤–µ ‚Äî id —Å–∏–º–≤–æ–ª-—à–∞—Ä—ñ–≤ (–ø—ñ–¥–ø–∏—Å–∏) –¥–ª—è –æ–±—Ä–∞–Ω–∏—Ö –í—ñ–¥/–î–æ
let HL_LABEL_IDS_FROM = [];
let HL_LABEL_IDS_TO   = [];

// OR-—Ñ—ñ–ª—å—Ç—Ä –ø–æ –∫—ñ–ª—å–∫–æ—Ö –Ω–∞–∑–≤–∞—Ö –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π
function buildAnyMatch(keys, value){
  if (value === null || value === undefined || String(value).trim() === '') return null;
  // –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –±–µ–∑ —Ä–µ–≥—ñ—Å—Ç—Ä—É + –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π –¥–æ —Ä—è–¥–∫–∞
  const vLower = String(value).trim().toLowerCase();
  const parts = keys.map(k => ['==',
    ['downcase', ['coalesce', ['to-string', ['get', k]], '' ]],
    vLower
  ]);
  return parts.length === 1 ? parts[0] : ['any', ...parts];
}

// —à—É–∫–∞—î–º–æ –∞–±–æ –ø–æ –ù–∞–∑–≤—ñ, –∞–±–æ –ø–æ –ö–æ–¥—É
function buildNameCodeFilter(nameVal, codeVal){
  const n = buildAnyMatch(NAME_KEYS, nameVal);
  const c = buildAnyMatch(CODE_KEYS, codeVal);
  if (n && c) return ['any', n, c];
  if (n) return n;
  if (c) return c;
  return ['==', ['get','__never__'], 1]; // –Ω—ñ—á–æ–≥–æ –Ω–µ –º–∞—Ç—á–∏–º–æ
}

// –≤–∏—Ç—è–≥—É—î–º–æ "—á–∏—Å—Ç—É" –Ω–∞–∑–≤—É –∑ —ñ–Ω–ø—É—Ç—É (—è–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ –∫–æ–¥ ‚Äî –±–µ—Ä–µ–º–æ –Ω–∞–∑–≤—É –∑ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞)
function getPureNameFromInput(inputId){
  const code = getCodeByInput(inputId);
  if (code) return getNameByCode(code);
  const raw = (document.getElementById(inputId).value || '').trim();
  return parseNameFromLabel(raw) || raw;
}

/* ===== Helpers –¥–ª—è –Ω–æ–≤–æ—ó —Å—Ö–µ–º–∏ GeoJSON (Client, Code, Name, Farm, Area) ===== */
function pickProp(obj, ...keys){
  for (const k of keys){
    const v = obj && obj[k];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return '';
}
function fmtArea(val){
  const n = Number(val);
  if (!isFinite(n)) return '';
  return n.toLocaleString('uk-UA', { maximumFractionDigits: 2 });
}
function getFieldProps(props){
  return {
    client: pickProp(props, 'Client', 'client', '–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ'),
    code:   pickProp(props, 'Code', 'code', '–ö–æ–¥'),
    name:   pickProp(props, 'Name', 'name', '–ù–∞–∑–≤–∞', '–ù–∞–∑–≤–∞ –ø–æ–ª—è'),
    farm:   pickProp(props, 'Farm', 'farm', '–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª', '–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª', 'department', 'unit'),
    area:   pickProp(props, 'Area', 'area', 'Area_ha', 'Area (ha)', '–ü–ª–æ—â–∞', '–ü–ª–æ—â–∞, –≥–∞')
  };
}

const topbarEl = document.querySelector('header.topbar');
function updateLayoutHeights(){
  const h = (topbarEl?.offsetHeight || 56);
  document.documentElement.style.setProperty('--nav-real', h + 'px');
  try { map.resize(); } catch(_) {}
}
window.addEventListener('resize', updateLayoutHeights);
updateLayoutHeights();

/* === –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –ø—ñ–¥–ø–∏—Å–∏ === */
function applyUkrainianLabels(){
  const style = map.getStyle();
  if (!style || !style.layers) return;
  const ukTextExpr = [
    'coalesce',['get','name_uk'],['get','name:uk'],['get','name_ua'],['get','name:ua'],['get','name_local'],['get','name']
  ];
  const skip = new Set(['geozones-labels','geozones-label']);
  style.layers.forEach(l => {
    if (l.type !== 'symbol') return;
    if (skip.has(l.id)) return; // üëà –Ω–µ —á—ñ–ø–∞—î–º–æ –Ω–∞—à—ñ –ø—ñ–¥–ø–∏—Å–∏ –ø–æ–ª—ñ–≤
    const hasTextField = map.getLayoutProperty(l.id, 'text-field') !== undefined;
    if (hasTextField) { try { map.setLayoutProperty(l.id, 'text-field', ukTextExpr); } catch(_) {} }
  });
}

let addMode = false, startLineMode = false, endLineMode = false;
let insertAfterMode = false; // legacy (–ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —Å—Ç–∞—Ä–æ—ó –≥—ñ–ª–∫–∏)
// –ù–æ–≤–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º –≤—Å—Ç–∞–≤–∫–∏: { type:'route'|'ruler-start'|'ruler-end', index:number, where:'before'|'after' }
let insertMode = null;
let points = [], markers = [], startRuler = [], endRuler = [], rulerLines = [], routeLayers = [];
// –ú–∞—Ä–∫–µ—Ä–∏ –ª—ñ–Ω—ñ–π–æ–∫ (–æ–∫—Ä–µ–º–æ –≤—ñ–¥ –º–∞—Ä–∫–µ—Ä—ñ–≤ –º–∞—Ä—à—Ä—É—Ç—É)
let startRulerMarkers = [], endRulerMarkers = [];
// HTML‚Äë–ª–µ–π–±–ª–∏ –¥–ª—è –Ω–æ–º–µ—Ä—ñ–≤ (–º–∞—Ä—à—Ä—É—Ç —ñ –ª—ñ–Ω—ñ–π–∫–∏)
// –ù—É–º–µ—Ä–∞—Ü—ñ—è –º–∞—Ä—à—Ä—É—Ç—É —Ç–µ–ø–µ—Ä —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–∞–º–æ—ó –º—ñ—Ç–∫–∏, –æ–∫—Ä–µ–º—ñ –±–µ–π–¥–∂—ñ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è
let selectedMarkerIndex = null;
let selectedMarkerType = null; // 'route' | 'ruler-start' | 'ruler-end'

// ====== Proposal overlay state ======
let PROPOSAL_VISIBLE = false;
let CURRENT_PROPOSAL = null; // { points: [[lng,lat],...], startRuler: [[lng,lat],...], endRuler: [[lng,lat],...], distance_km, snappedPoints? }
let HAS_PROPOSAL = false; // for status chip
let __proposalSnapInFlight = false;


let activeRuler = null; let lastActiveRuler = null;
function setActiveRuler(which){ activeRuler = which; if (which) lastActiveRuler = which; }

/* ====== Roles ====== */
let currentRole = 'guest';
let readOnly    = true;
// –ú–∏—Ç—Ç—î–≤–æ –ø—ñ–¥–Ω—è—Ç–∏ —Ä–æ–ª—å/—Ö–∞–±–∏ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (—è–∫—â–æ –≤–æ–Ω–∏ —î –≤ sessionStorage)
(function(){
  try{
    const raw = sessionStorage.getItem('role.cache.v1');
    if (!raw) return;
    const { role, hubs, all, ts } = JSON.parse(raw) || {};
    // 2 —Ö–≤ ‚Äî –¥–æ—Å—Ç–∞—Ç–Ω—å–æ, —â–æ–± ¬´–¥–æ–∂–∏—Ç–∏¬ª –¥–æ —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ —Ñ–µ—Ç—á—É –∑ Firestore
    if (!ts || (Date.now() - ts) > 2*60*1000) return;

    // –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥—Ä—ñ–≤–∞—î–º–æ –∑–º—ñ–Ω–Ω—ñ; applyRoleUI –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –Ω–∏–∂—á–µ –≤ onAuthStateChanged
    window.__userRole = role || 'guest';
    if (all === true)        window.ALLOWED_HUBS = null; // null = –≤—Å—ñ —Ö–∞–±–∏
    else if (Array.isArray(hubs)) window.ALLOWED_HUBS = hubs;
  }catch(_){}
})();

function applyRoleUI(role){
  // –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ
  role = (role || 'guest').toString().toLowerCase();
  currentRole = role;
  readOnly = (role === 'guest' || role === 'user');

  // ‚¨áÔ∏è –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∞–¥–º—ñ–Ω-–ª—ñ–Ω–∫ –ª–∏—à–µ –∞–¥–º—ñ–Ω–∞–º
  ['adminLink','adminLinkViewer','geojsonBuilderLink','uploadRoutesLink'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.style.display = (role === 'admin') ? '' : 'none';
});

  const disableIds = [
    'toggleAdd','startLineMode','endLineMode','clearRoute','popRulerPoint','clearRulers',
    'saveRoute','loadRoute','saveToDB','deleteFromDB','routeName',
    'fromName','toName','routeType','routePurpose','intermediateText',
	// ‚¨áÔ∏è –¥–æ–¥–∞–π —Ü—ñ –¥–≤—ñ –∫–Ω–æ–ø–∫–∏, —â–æ–± user –Ω–µ –º—ñ–≥ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
    'sendForApproval','copyReviewLink',
  'hubSelect' // üëà –¥–æ–¥–∞–Ω–æ
  ];
  disableIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
      el.disabled = readOnly;
    } else {
      el.disabled = readOnly;
      el.classList.toggle('muted', readOnly);
    }
  });

  document.getElementById('loadFromDB').disabled = false;
  document.getElementById('refreshList').disabled = false;
  document.getElementById('remoteRoutes').disabled = false;
  document.getElementById('routeSearch').disabled = false;

  document.getElementById('roleChip').textContent = '–†–æ–ª—å: ' + (currentRole || '‚Äì');
  try { setRoleVisual(currentRole); } catch(_){}
}

/* ===== Context menu ===== */
const contextMenu = document.getElementById('contextMenu');
const insertAfterBtn = document.getElementById('insertAfter');
const deletePointBtn = document.getElementById('deletePoint');

const insertBeforeBtn = document.getElementById('insertBefore');
insertAfterBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) {
    insertMode = { type: selectedMarkerType || 'route', index: selectedMarkerIndex, where: 'after' };
    insertAfterMode = false; // –≤–∏–º–∏–∫–∞—î–º–æ —Å—Ç–∞—Ä–∏–π —Ä–µ–∂–∏–º, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏
  }
  contextMenu.style.display = 'none';
};
insertBeforeBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) {
    insertMode = { type: selectedMarkerType || 'route', index: selectedMarkerIndex, where: 'before' };
    insertAfterMode = false;
  }
  contextMenu.style.display = 'none';
};
deletePointBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) {
    if ((selectedMarkerType||'route') === 'route') {
      points.splice(selectedMarkerIndex, 1);
      rebuildMarkers();
    } else if (selectedMarkerType === 'ruler-start') {
      startRuler.splice(selectedMarkerIndex, 1);
      rebuildRulerMarkers(); drawRulers(); updateRoute();
    } else if (selectedMarkerType === 'ruler-end') {
      endRuler.splice(selectedMarkerIndex, 1);
      rebuildRulerMarkers(); drawRulers(); updateRoute();
    }
  }
  contextMenu.style.display = 'none';
  selectedMarkerIndex = null; selectedMarkerType = null; insertMode = null;
};
document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

/* ========= ‚¨áÔ∏è –ì–µ–æ–∑–æ–Ω–∏ –∑ Mapbox Tilesets (multi) ========= */

// –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤ –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤ –∑ –£–°–Ü–• tileset fill-—à–∞—Ä—ñ–≤
function buildGeozoneCentroids(){
  if (!window.turf || TS_FILL_IDS.length === 0) return;

  const feats = map.queryRenderedFeatures({ layers: TS_FILL_IDS }) || [];
  const seen = new Set();
  const out = [];

  for (const f of feats){
    const p = f.properties || {};
    const fp = getFieldProps(p);
    const label = fp.name || fp.code || '–ü–æ–ª–µ';

    // –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á —ñ–∑ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π;
    // –¥–æ–¥–∞—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å –¥–∂–µ—Ä–µ–ª–∞, —â–æ–± –Ω–µ –∑–º—ñ—à—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ tilesets
    const src = f.source || 'ts';
    const key = `${src}:${p.id || p.fid || p.OBJECTID || p.OBJECTID_1 || p.Code || p.Name || label}`;
    if (seen.has(key)) continue;

    let center = null;
    try { center = turf.centerOfMass(f).geometry.coordinates; }
    catch(_){
      try { const b = turf.bbox(f); center = [(b[0]+b[2])/2,(b[1]+b[3])/2]; } catch(_){}
    }
    if (!center) continue;

    out.push({ type:'Feature', geometry:{ type:'Point', coordinates:center }, properties:{ label } });
    seen.add(key);
  }

  const fc = { type:'FeatureCollection', features: out };

  if (map.getSource('geozones-centroids')){
    map.getSource('geozones-centroids').setData(fc);
  } else {
    map.addSource('geozones-centroids', { type:'geojson', data: fc });
    map.addLayer({
      id: 'geozones-labels',
      type: 'symbol',
      source: 'geozones-centroids',
      layout: {
        'text-field': ['get','label'],
        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
        'text-size': 12,
        'text-anchor': 'center',
        'text-allow-overlap': false
      },
      paint: {
        'text-color': '#1f2937',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1.2
      }
    });
  }
}

// —Å—Ç–≤–æ—Ä—é—î–º–æ –í–°–Ü –≤–µ–∫—Ç–æ—Ä–Ω—ñ –¥–∂–µ—Ä–µ–ª–∞/—à–∞—Ä–∏ –∑ –º–∞—Å–∏–≤—É TILESETS
function addTilesets(){
  TS_FILL_IDS = [];
  TS_OUTLINE_IDS = [];

  TILESETS.forEach(ts => {
    if (ts.enabled === false) { console.warn('[tileset] disabled:', ts.key, ts.url); return; }
    const sourceId = `geozones-tileset-${ts.key}`;
    if (!map.getSource(sourceId)){
      map.addSource(sourceId, { type: 'vector', url: ts.url });
    }

    const fillId = `tileset-fill-${ts.key}`;
    const outlineId = `tileset-outline-${ts.key}`;

    if (!map.getLayer(fillId)){
      map.addLayer({
        id: fillId,
        type: 'fill',
        source: sourceId,
        'source-layer': ts.layer,
        minzoom: 0,
        maxzoom: 22,
        paint: {
          'fill-color': '#16a34a',
          'fill-opacity': ['interpolate',['linear'],['zoom'], 5, 0.22, 8, 0.30, 12, 0.38, 14, 0.44, 16, 0.50]
        }
      });
    }

    if (!map.getLayer(outlineId)){
      map.addLayer({
        id: outlineId,
        type: 'line',
        source: sourceId,
        'source-layer': ts.layer,
        minzoom: 0,
        maxzoom: 22,
        paint: {
          'line-color': '#0d7a3a',
          'line-width': ['interpolate',['linear'],['zoom'], 5, 0.8, 8, 1.2, 12, 1.8, 14, 2.4]
        }
      });
    }

    TS_FILL_IDS.push(fillId);
    TS_OUTLINE_IDS.push(outlineId);
  });

  // –∑–±—É–¥—É–≤–∞—Ç–∏ —Ü–µ–Ω—Ç—Ä–æ—ó–¥–∏-–ø—ñ–¥–ø–∏—Å–∏ –¥–ª—è –í–°–Ü–• fill-—à–∞—Ä—ñ–≤
  buildGeozoneCentroids();
  map.off('moveend', rebuildLabelsOnce);
  map.on('moveend', rebuildLabelsOnce);

  // –ø–æ–≤—ñ—Å–∏—Ç–∏ hover-handlers –Ω–∞ –≤—Å—ñ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è/–∫–æ–Ω—Ç—É—Ä–∏
  bindTilesetHoverHandlers();
    // ‚¨áÔ∏è –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤–∏–¥–∏–º—ñ—Å—Ç—å tileset-—ñ–≤ –∑–∞ –¥–æ—Å—Ç—É–ø–∞–º–∏ —Ö–∞–±—ñ–≤
    // —Ç—ñ–ª—å–∫–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–æ–º tileset-–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –≤–∏–¥–∏–º—ñ
  applyTilesetHubVisibility();
}

const rebuildLabelsOnce = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),150); }; })(buildGeozoneCentroids);
/* ==== HIGHLIGHT LAYERS (—Å—Ç–≤–æ—Ä—é—î–º–æ —Ä–∞–∑, –¥–∞–ª—ñ —Ç—ñ–ª—å–∫–∏ –º—ñ–Ω—è—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏) ==== */

function ensureHighlightLayers(){
  // tilesets (vector)
  TILESETS.forEach(ts => {
    const srcId = `geozones-tileset-${ts.key}`;
    if (!map.getSource(srcId)) return;

    const mk = (type) => `tileset-hl-${type}-${ts.key}`;

    // FROM ‚Äî —Å–∏–Ω—ñ–π
    if (!map.getLayer(mk('from'))){
      map.addLayer({
        id: mk('from'),
        type: 'fill',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#3b82f6', 'fill-opacity': 0.45 }
      });
      HL_IDS_FROM.push(mk('from'));
    }
    // TO ‚Äî —Ä–æ–∂–µ–≤–∏–π
    if (!map.getLayer(mk('to'))){
      map.addLayer({
        id: mk('to'),
        type: 'fill',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#f43f5e', 'fill-opacity': 0.45 }
      });
      HL_IDS_TO.push(mk('to'));
    }
  });

  // GeoJSON –∑—ñ Storage
  if (map.getSource('geozones')){
    if (!map.getLayer('geozones-hl-from')){
      map.addLayer({
        id: 'geozones-hl-from',
        type: 'fill',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#3b82f6', 'fill-opacity': 0.45 }
      });
      HL_IDS_FROM.push('geozones-hl-from');
    }
    if (!map.getLayer('geozones-hl-to')){
      map.addLayer({
        id: 'geozones-hl-to',
        type: 'fill',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#f43f5e', 'fill-opacity': 0.45 }
      });
      HL_IDS_TO.push('geozones-hl-to');
    }
  }
  // ‚¨áÔ∏è –î–û–î–ê–ô –¶–ï –°–Æ–î–ò (–ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏–≤–Ω–æ—é –¥—É–∂–∫–æ—é —Ñ—É–Ω–∫—Ü—ñ—ó)
  ensureHighlightLabelLayers();   // —Å—Ç–≤–æ—Ä—é—î–º–æ label-—à–∞—Ä–∏ –¥–ª—è FROM/TO
  bindHighlightHoverHandlers();   // –≤–º–∏–∫–∞—î–º–æ hover-–ø—ñ–¥–∫–∞–∑–∫–∏ –ª–∏—à–µ –¥–ª—è FROM/TO
}
function ensureHighlightLabelLayers(){
  // GeoJSON (storage)
  if (map.getSource('geozones')){
    if (!map.getLayer('geozones-hl-from-label')){
      map.addLayer({
        id: 'geozones-hl-from-label',
        type: 'symbol',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1], // –∑–∞–ø–æ–≤–Ω–∏–º–æ —Ñ—ñ–ª—å—Ç—Ä–æ–º –¥–∞–ª—ñ
        layout: {
          'text-field': ['coalesce', ['get','_label'], ['get','Name'], ['get','name'], ['get','–ù–∞–∑–≤–∞'], ['get','–ù–∞–∑–≤–∞ –ø–æ–ª—è'], ['get','Code'], ['get','code'], '–ü–æ–ª–µ'],
          'text-size': 12, 'text-anchor':'center', 'text-allow-overlap': false
        },
        paint: { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_FROM.push('geozones-hl-from-label');
    }
    if (!map.getLayer('geozones-hl-to-label')){
      map.addLayer({
        id: 'geozones-hl-to-label',
        type: 'symbol',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1],
        layout: {
          'text-field': ['coalesce', ['get','_label'], ['get','Name'], ['get','name'], ['get','–ù–∞–∑–≤–∞'], ['get','–ù–∞–∑–≤–∞ –ø–æ–ª—è'], ['get','Code'], ['get','code'], '–ü–æ–ª–µ'],
          'text-size': 12, 'text-anchor':'center', 'text-allow-overlap': false
        },
        paint: { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_TO.push('geozones-hl-to-label');
    }
  }

  // Tilesets (vector) ‚Äî —Ä–æ–±–∏–º–æ –ø—ñ–¥–ø–∏—Å–∏ –ø—Ä—è–º–æ –∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –¥–∂–µ—Ä–µ–ª–∞
  TILESETS.forEach(ts => {
    const srcId = `geozones-tileset-${ts.key}`;
    if (!map.getSource(srcId)) return;

    const mk = type => `tileset-hl-${type}-label-${ts.key}`;
    const textExpr = ['coalesce', ['get','Name'], ['get','name'], ['get','–ù–∞–∑–≤–∞'], ['get','–ù–∞–∑–≤–∞ –ø–æ–ª—è'], ['get','Code'], ['get','code']];

    if (!map.getLayer(mk('from'))){
      map.addLayer({
        id: mk('from'),
        type: 'symbol',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        layout: { 'text-field': textExpr, 'text-size': 12, 'text-anchor': 'center', 'text-allow-overlap': false },
        paint:  { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_FROM.push(mk('from'));
    }
    if (!map.getLayer(mk('to'))){
      map.addLayer({
        id: mk('to'),
        type: 'symbol',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        layout: { 'text-field': textExpr, 'text-size': 12, 'text-anchor': 'center', 'text-allow-overlap': false },
        paint:  { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_TO.push(mk('to'));
    }
  });
}
function bindHighlightHoverHandlers(){
  [...HL_IDS_FROM, ...HL_IDS_TO].forEach(id => {
    if (BOUND_HOVER_LAYERS.has(id)) return;
    map.on('mousemove',  id, onHover);
    map.on('mouseleave', id, onLeave);
    BOUND_HOVER_LAYERS.add(id);
  });
}

function updateHighlights(){
  const fromName = getPureNameFromInput('fromName');
  const toName   = getPureNameFromInput('toName');
  const fromCode = getCodeByInput('fromName');
  const toCode   = getCodeByInput('toName');

  const fromFilter = buildNameCodeFilter(fromName, fromCode);
  const toFilter   = buildNameCodeFilter(toName, toCode);

  HL_IDS_FROM.forEach(id => { if (map.getLayer(id)) map.setFilter(id, fromFilter); });
  HL_IDS_TO.forEach(id   => { if (map.getLayer(id)) map.setFilter(id, toFilter); });
  // ‚¨áÔ∏è –ø—ñ–¥–ø–∏—Å–∏ –≤–∏–±—Ä–∞–Ω–∏—Ö
HL_LABEL_IDS_FROM.forEach(id => { if (map.getLayer(id)) map.setFilter(id, fromFilter); });
HL_LABEL_IDS_TO.forEach(id   => { if (map.getLayer(id)) map.setFilter(id, toFilter); });

  fitToHighlights();
}

function fitToHighlights(){
  try{
    const ids = [...HL_IDS_FROM, ...HL_IDS_TO].filter(id => map.getLayer(id));
    let bounds = null;
    ids.forEach(id => {
      const feats = map.queryRenderedFeatures({ layers: [id] });
      feats.forEach(f => {
        const b = turf.bbox(f);
        if (!bounds){
          bounds = new mapboxgl.LngLatBounds([b[0], b[1]], [b[2], b[3]]);
        } else {
          bounds.extend([b[0], b[1]]);
          bounds.extend([b[2], b[3]]);
        }
      });
    });
    if (bounds) map.fitBounds(bounds, { padding: 40, maxZoom: 14 });
  }catch(_){}
}

/* ========= ‚¨ÜÔ∏è –ì–µ–æ–∑–æ–Ω–∏ –∑ Mapbox Tilesets (multi) ========= */

map.on('style.load', async () => {
// –°–ø–ª–µ—à —Ö–æ–≤–∞—î–º–æ –ª–∏—à–µ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, —ñ–Ω–∞–∫—à–µ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –ø–æ–±–∞—á–∞—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø–µ—Ä–µ–¥ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–æ–º
if (window.__canHideSplash) hideSplash();
  applyUkrainianLabels();
  updateRoute();
  drawRulers();
  // –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏ –ª—ñ–Ω—ñ–π–æ–∫, —è–∫—â–æ —Ç–æ—á–∫–∏ –≤–∂–µ —ñ—Å–Ω—É—é—Ç—å
  try { rebuildRulerMarkers(); } catch(_) {}

  if (geozonesDataCache) addGeozones(geozonesDataCache);
  // –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥ tilesets –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º —à–∞—Ä—ñ–≤
  await loadTilesetsConfigOnce();
  addTilesets();

  // üî¶ –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ FROM/TO
  ensureHighlightLayers();
  ensureHighlightLabelLayers();
  bindHighlightHoverHandlers();
  updateHighlights();
  setGeozonesVisibility(geozonesVisible);

  // –î–æ—Ä–æ–∂–Ω—è —Å—ñ—Ç–∫–∞ –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ —Å—Ç–∏–ª—é
  try { addRoadGridLayer(); setRoadGridVisibility(roadGridVisible); } catch(_) {}
});

function setMapStyle(val){
  try{
    if (!val || val === currentStyle) return;
    currentStyle = val;
    map.setStyle(currentStyle);
    // —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –æ–±–∏–¥–≤–∞ —Å–µ–ª–µ–∫—Ç–∏ –±–µ–∑ –ø–æ–¥—ñ—ó
    const s1 = document.getElementById('mapStyle');
    const s2 = document.getElementById('mapStyleDock');
    if (s1 && s1.value !== val) s1.value = val;
    if (s2 && s2.value !== val) s2.value = val;
  }catch(_){ }
}
document.getElementById('mapStyle').addEventListener('change', function() {
  setMapStyle(this.value);
});
document.getElementById('mapStyleDock').addEventListener('change', function(){
  setMapStyle(this.value);
});

/* ==== Bottom-left place search (Mapbox Geocoding) ==== */
let __placeSearchTimer = null;
let __placeResults = [];
async function suggestPlaces(q){
  try{
    const token = mapboxgl.accessToken || '';
    if (!token) return [];
    const url = new URL('https://api.mapbox.com/geocoding/v5/mapbox.places/' + encodeURIComponent(q) + '.json');
    url.searchParams.set('access_token', token);
    url.searchParams.set('autocomplete', 'true');
    url.searchParams.set('language', 'uk');
    url.searchParams.set('limit', '7');
    url.searchParams.set('types', 'place,locality,neighborhood');
    // –û–±–º–µ–∂–∏–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –£–∫—Ä–∞—ó–Ω–æ—é; –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –º–æ–∂–Ω–∞ –ø—Ä–∏–±—Ä–∞—Ç–∏
    url.searchParams.set('country', 'ua');
    try{
      const c = map.getCenter();
      url.searchParams.set('proximity', c.lng + ',' + c.lat);
    }catch(_){ }
    const res = await fetch(url.toString());
    const data = await res.json();
    const feats = Array.isArray(data?.features) ? data.features : [];
    return feats.map(f => ({ id:f.id, name:f.text_uk || f.text || '', full:f.place_name_uk || f.place_name || '', center:f.center }));
  }catch(_){ return []; }
}
function fillPlaceDatalist(rows){
  const list = document.getElementById('placeList');
  if (!list) return;
  list.innerHTML = '';
  rows.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.full || r.name;
    list.appendChild(opt);
  });
}
function flyToPlaceFromInput(){
  const input = document.getElementById('placeSearch');
  const q = (input?.value || '').trim();
  if (!q) return;
  // –ü—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–∏–π –∑–±—ñ–≥ —Å–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –ø—ñ–¥–∫–∞–∑–æ–∫
  let target = __placeResults.find(r => (r.full || r.name) === q);
  // –î–æ–ø–æ–º—ñ–∂–Ω–∞: —Å—Ö–æ–≤–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫–∏ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É, —â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ –Ω–∞–∫–ª–∞–¥–∞–ª–æ—Å—å –Ω–∞ –º–∞–ø—É
  const closePlaceSuggestions = () => {
    try {
      // –ó–Ω—è—Ç–∏ —Ñ–æ–∫—É—Å ‚Äî –Ω–∞—Ç–∏–≤–Ω–∏–π datalist –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –ø—Ä–∏ blur
      if (input) input.blur();
      // –ü—Ä–∏–±—Ä–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç–∏, —â–æ–± –Ω–µ ¬´–ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–ª–∏—Å—å¬ª –ø—ñ—Å–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
      fillPlaceDatalist([]);
    } catch(_) {}
  };

  const use = async () => {
    if (target && Array.isArray(target.center)){
      try{ map.flyTo({ center: target.center, zoom: Math.max(map.getZoom()||0, 11), essential:true }); }catch(_){ }
      // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É
      closePlaceSuggestions();
      return true;
    }
    return false;
  };
  use().then(async ok => {
    if (ok) return;
    // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ ‚Äî –∑—Ä–æ–±–∏–º–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π –≥–µ–æ–∫–æ–¥–∏–Ω–≥ —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –ø–µ—Ä—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const rows = await suggestPlaces(q);
    __placeResults = rows;
    if (rows.length && Array.isArray(rows[0].center)){
      try{ map.flyTo({ center: rows[0].center, zoom: Math.max(map.getZoom()||0, 11), essential:true }); }catch(_){ }
      closePlaceSuggestions();
    }
  });
}
const placeInput = document.getElementById('placeSearch');
if (placeInput){
  placeInput.addEventListener('input', () => {
    const q = placeInput.value.trim();
    if (__placeSearchTimer) clearTimeout(__placeSearchTimer);
    if (q.length < 2){ fillPlaceDatalist([]); __placeResults = []; return; }
    __placeSearchTimer = setTimeout(async () => {
      const rows = await suggestPlaces(q);
      __placeResults = rows;
      fillPlaceDatalist(rows);
    }, 450);
  });
  placeInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); flyToPlaceFromInput(); }
    if (e.key === 'Escape') { // —à–≤–∏–¥–∫–æ —Å—Ö–æ–≤–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫–∏
      fillPlaceDatalist([]);
      placeInput.blur();
    }
  });
  placeInput.addEventListener('change', flyToPlaceFromInput);
}

/* ==== POPUP (–ø–æ–≤–Ω–∏–π –ø–∞—Å–ø–æ—Ä—Ç –ø–æ–ª—è) ==== */
const popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false,
  maxWidth: '480px'   // ‚¨ÖÔ∏è –∑—Ä–æ–±–∏—Ç—å –≤—ñ–∫–Ω–æ —à–∏—Ä—à–∏–º
});

// –ø—Ä–æ—Å—Ç–µ –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å, —â–æ–± –Ω–µ –∑–ª–∞–º–∞—Ç–∏ HTML
function esc(v){
  return String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function hoverPopupHTML(props){
  const { name, client, farm, code, area } = getFieldProps(props || {});
  const rows = [
    ['–ù–∞–∑–≤–∞',         name],
    ['–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ',  client],
    ['–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª',     farm],
    ['–ö–æ–¥',           code],
    ['–ü–ª–æ—â–∞',         (area !== '' && area !== null && area !== undefined) ? (fmtArea(area) + ' –≥–∞') : '']
  ];

  const htmlRows = rows.map(([label, val]) =>
    `<div><b>${label}:</b> ${esc(val) || '‚Äî'}</div>`
  ).join('');

  return `<div style="font-size:13px;line-height:1.35;">${htmlRows}</div>`;
}

function onHover(e){
  const f = e.features && e.features[0];
  if (!f) return;
  map.getCanvas().style.cursor = 'pointer';
  popup
    .setLngLat(e.lngLat)
    .setHTML(hoverPopupHTML(f.properties || {}))
    .addTo(map);
}

function onLeave(){
  map.getCanvas().style.cursor = '';
  popup.remove();
}

function bindTilesetHoverHandlers(){
  // –ø—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å –Ω–∞ –≤—Å—ñ –∞–∫—Ç—É–∞–ª—å–Ω—ñ fill/outline
  [...TS_FILL_IDS, ...TS_OUTLINE_IDS].forEach(id => {
    if (BOUND_HOVER_LAYERS.has(id)) return;
    // —è–∫—â–æ —à–∞—Ä—É —â–µ –Ω–µ–º–∞ ‚Äî mapbox —Å–∞–º –∞–∫—Ç–∏–≤—É—î —Å–ª—É—Ö–∞—á, –∫–æ–ª–∏ —à–∞—Ä –∑'—è–≤–∏—Ç—å—Å—è
    map.on('mousemove',  id, onHover);
    map.on('mouseleave', id, onLeave);
    BOUND_HOVER_LAYERS.add(id);
  });
}

/* ===== Buttons state ===== */
// ‚¨áÔ∏è –¥–æ–¥–∞—Ç–∏ —Ç—É—Ç
function flyToRouteEdge(which){
  let target = null;

  // 1) –≥–æ–ª–æ–≤–Ω–∏–π –∫–µ–π—Å ‚Äî –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç (points)
  if (Array.isArray(points) && points.length){
    target = (which === 'start') ? points[0] : points[points.length - 1];
  }

  // 2) fallback ‚Äî —è–∫—â–æ points —â–µ –Ω–µ–º–∞—î, –±–µ—Ä–µ–º–æ –ª—ñ–Ω—ñ–π–∫–∏
  if (!target){
    if (which === 'start' && startRuler.length) target = startRuler[0];
    if (which === 'end'   && endRuler.length)   target = endRuler[endRuler.length - 1];
  }

  if (!target) return;
  try {
    map.flyTo({ center: target, zoom: Math.max(map.getZoom() || 0, 12), essential: true });
  } catch(_) {}
}
function toggleButton(id, flag) {
  const btn = document.getElementById(id);
  // –∑–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ª–µ–π–±–ª –æ–¥–∏–Ω —Ä–∞–∑
  if (!btn.dataset.label) btn.dataset.label = btn.textContent.split(':')[0].trim();

  // –ù–ï –º—ñ–Ω—è—î–º–æ —Ç–µ–∫—Å—Ç ‚Äî –ª–∏—à–∞—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π –ª–µ–π–±–ª
  btn.textContent = btn.dataset.label;

  // –≤—ñ–∑—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
  btn.classList.toggle('active', !!flag);
  btn.setAttribute('aria-pressed', !!flag);
}


document.getElementById('toggleAdd').onclick = () => {
  if (readOnly) return;
  addMode = !addMode; startLineMode = false; endLineMode = false; insertAfterMode = false;
  setActiveRuler(null);
  toggleButton('toggleAdd', addMode); toggleButton('startLineMode', false); toggleButton('endLineMode', false);
};
document.getElementById('startLineMode').onclick = () => {
  if (readOnly) return;
  startLineMode = !startLineMode; endLineMode = false; addMode = false; insertAfterMode = false;
  setActiveRuler(startLineMode ? 'start' : null);
  toggleButton('startLineMode', startLineMode); toggleButton('endLineMode', false); toggleButton('toggleAdd', false);
  // ‚¨áÔ∏è –¥–æ–¥–∞—Ç–∏
  if (startLineMode) flyToRouteEdge('start');
};
document.getElementById('endLineMode').onclick = () => {
  if (readOnly) return;
  endLineMode = !endLineMode; startLineMode = false; addMode = false; insertAfterMode = false;
  setActiveRuler(endLineMode ? 'end' : null);
  toggleButton('endLineMode', endLineMode); toggleButton('startLineMode', false); toggleButton('toggleAdd', false);
  // ‚¨áÔ∏è –¥–æ–¥–∞—Ç–∏
  if (endLineMode) flyToRouteEdge('end');
};

// ===== –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω—ñ —à–æ—Ä—Ç–∫–∞—Ç–∏ =====
document.addEventListener('keydown', (e) => {
  const tag = String(e.target?.tagName||'').toLowerCase();
  if (tag === 'input' || tag === 'textarea' || tag === 'select' || (e.target && e.target.isContentEditable)) return;
  if (readOnly) return;

  const key = String(e.key||'').toLowerCase();
  if (e.ctrlKey) {
    if (key === '1') { e.preventDefault(); document.getElementById('toggleAdd')?.click(); return; }
    if (key === 's') { e.preventDefault(); document.getElementById('startLineMode')?.click(); return; }
    if (key === 'e') { e.preventDefault(); document.getElementById('endLineMode')?.click(); return; }
  }
  if (key === 'escape'){
    e.preventDefault();
    addMode = false; startLineMode = false; endLineMode = false; insertAfterMode = false; insertMode = null; selectedMarkerIndex = null;
    setActiveRuler(null);
    try{ toggleButton('toggleAdd', false); toggleButton('startLineMode', false); toggleButton('endLineMode', false); }catch(_){ }
    try{ const m = document.getElementById('contextMenu'); if (m) m.style.display='none'; }catch(_){ }
  }
});

document.getElementById('popRulerPoint').onclick = () => {
  if (readOnly) return;
  const choose = () => activeRuler || lastActiveRuler || (startRuler.length >= endRuler.length ? 'start' : 'end');
  let target = choose();
  if (target === 'start' && startRuler.length === 0 && endRuler.length > 0) target = 'end';
  if (target === 'end' && endRuler.length === 0 && startRuler.length > 0) target = 'start';
  let did = false;
  if (target === 'start' && startRuler.length) { startRuler.pop(); did = true; }
  if (target === 'end' && endRuler.length) { endRuler.pop(); did = true; }
  if (did){ rebuildRulerMarkers(); drawRulers(); updateRoute(); }
};

document.getElementById('clearRulers').onclick = () => {
  if (readOnly) return;
  if (activeRuler === 'start') { startRuler = []; }
  else if (activeRuler === 'end') { endRuler = []; }
  else {
    // –Ø–∫—â–æ –æ–±–∏–¥–≤—ñ –ª—ñ–Ω—ñ–π–∫–∏ –≤–∂–µ –ø–æ—Ä–æ–∂–Ω—ñ ‚Äî –≤—Å–µ –æ–¥–Ω–æ –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –∑–∞–ª–∏—à–∫–æ–≤—ñ –º–∞—Ä–∫–µ—Ä–∏
    if (!startRuler.length && !endRuler.length) {
      try { clearRulerMarkers(); } catch(_) {}
      drawRulers(); updateRoute();
      return;
    }
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –æ–±–∏–¥–≤—ñ –ª—ñ–Ω—ñ–π–∫–∏?')) return;
    startRuler = []; endRuler = [];
  }
  rebuildRulerMarkers();
  drawRulers(); updateRoute();
};

document.getElementById('clearRoute').onclick = () => {
  if (readOnly) return;
  points = []; markers.forEach(m => m.remove()); markers = [];
  clearRouteLayers(); updateRoute();
};

/* ===== –°—Ö–æ–∂—ñ –º–∞—Ä—à—Ä—É—Ç–∏ (–∑–∞ –í—ñ–¥/–î–æ) ===== */
let previewLayerId = null;
function clearPreviewRoute(){
  try{
    if (previewLayerId){
      if (map.getLayer(previewLayerId)) map.removeLayer(previewLayerId);
      if (map.getSource(previewLayerId)) map.removeSource(previewLayerId);
    }
  }catch(_){ }
  previewLayerId = null;
  const btn = document.getElementById('similarClearPreview');
  if (btn) btn.style.display = 'none';
}
function showPreviewRoute(coords){
  clearPreviewRoute();
  if (!Array.isArray(coords) || coords.length < 2) return;
  previewLayerId = 'similar-preview';
  const geo = { type:'Feature', geometry:{ type:'LineString', coordinates: coords } };
  map.addSource(previewLayerId, { type:'geojson', data: geo });
  map.addLayer({
    id: previewLayerId,
    type: 'line', source: previewLayerId,
    layout: { 'line-join': 'round', 'line-cap': 'round' },
    paint: { 'line-color': '#0ea5e9', 'line-width': 4, 'line-dasharray': [1,2] }
  });
  const btn = document.getElementById('similarClearPreview');
  if (btn) btn.style.display = 'inline-block';
}

async function findSimilarRoutes(){
  const fromNameRaw = getPureNameFromInput('fromName');
  const toNameRaw   = getPureNameFromInput('toName');
  const fromName = (fromNameRaw||'').trim();
  const toName   = (toNameRaw||'').trim();
  const fLower   = fromName.toLowerCase();
  const tLower   = toName.toLowerCase();
  if (!fLower && !tLower){
    alert('–í–≤–µ–¥—ñ—Ç—å ‚Äú–í—ñ–¥‚Äù —ñ/–∞–±–æ ‚Äú–î–æ‚Äù –¥–ª—è –ø–æ—à—É–∫—É —Å—Ö–æ–∂–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –ø–æ –Ω–∞–∑–≤—ñ.');
    return;
  }
  const listEl = document.getElementById('similarList');
  const emptyEl= document.getElementById('similarEmpty');
  const modal  = document.getElementById('similarModal');
  listEl.innerHTML = '<div class="muted">–ü–æ—à—É–∫‚Ä¶</div>';
  emptyEl.style.display = 'none';
  modal.classList.add('show');

  // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–≤–µ–¥–µ–Ω–Ω—è: –±–µ—Ä–µ–º–æ –ª–∏—à–µ –±—É–∫–≤–µ–Ω—ñ —Ç–æ–∫–µ–Ω–∏ (—É–∫—Ä/–ª–∞—Ç), –≤—ñ–¥–∫–∏–¥–∞—î–º–æ —Ü–∏—Ñ—Ä–∏ (—Ç–∏–ø—É "025/00")
  const tokenize = (s) => (String(s||'').toLowerCase().match(/[a-z–∞-—â—å—é—è—î—ñ—ó“ë]+/gi) || []).filter(w=>w.length>=3);
  const fTokens = tokenize(fLower);
  const tTokens = tokenize(tLower);
  const bothSidesProvided = fTokens.length>0 && tTokens.length>0;
  const containsTokens = (hay, tokens) => tokens.every(tok => String(hay||'').includes(tok));

  const seen = new Set();
  const addDocs = (snap, acc) => {
    snap.forEach(doc => { if (!seen.has(doc.id)) { acc.push(doc); seen.add(doc.id); } });
  };
  const queries = [];
  try{
    let qBase = db.collection('routes');
    qBase = withHubFilter(qBase, 'hub');
    const acc = [];

    // 1) N-grams –ø–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤–∞—Ö (—Å—Ç—ñ–π–∫–∏–π contains)
  let gramsF = fLower ? trigrams(fLower) : [];
  let gramsT = tLower ? trigrams(tLower) : [];
  // Firestore array-contains-any –ø—Ä–∏–π–º–∞—î –æ–±–º–µ–∂–µ–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–Ω–∞—á–µ–Ω—å ‚Äî —É—Ä—ñ–∑–∞—î–º–æ –¥–æ 10
  if (gramsF.length > 10) gramsF = gramsF.slice(0,10);
  if (gramsT.length > 10) gramsT = gramsT.slice(0,10);
    const pushQ = (qb) => queries.push(qb.limit(50).get({source:'default'}));

    if (gramsF.length){
      pushQ(qBase.where('fromNgrams', 'array-contains-any', gramsF));
      pushQ(qBase.where('toNgrams',   'array-contains-any', gramsF)); // –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–º—É
    }
    if (gramsT.length){
      pushQ(qBase.where('toNgrams',   'array-contains-any', gramsT));
      pushQ(qBase.where('fromNgrams', 'array-contains-any', gramsT)); // –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–º—É
    }

    // 2) –ü—Ä–µ—Ñ—ñ–∫—Å —è–∫ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π (—à–≤–∏–¥–∫–∏–π) –∫–∞–Ω–∞–ª
    const pref = (field, val) => {
      if (!val) return;
      let q = db.collection('routes').orderBy(field).startAt(val).endBefore(val + '\uf8ff').limit(50);
      q = withHubFilter(q, 'hub');
      queries.push(q.get({source:'default'}));
    };
    pref('fromLabelLower', fLower);
    pref('toLabelLower',   tLower);

    const res = await Promise.allSettled(queries);
    res.forEach(r => { if (r.status==='fulfilled') addDocs(r.value, acc); });

    // –û—Ü—ñ–Ω—é—î–º–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∏ –∑–∞ –∑–±—ñ–≥–æ–º —É—Å—ñ—Ö —Ç–æ–∫–µ–Ω—ñ–≤: –ø—Ä—è–º–∏–π (0), –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π (1), —á–∞—Å—Ç–∫–æ–≤–∏–π (2), —ñ–Ω—à–µ (9)
    const scored = acc.map(d => {
      const x = d.data()||{}; const fL = (x.fromLabelLower||''); const tL = (x.toLabelLower||'');
      const fwd = containsTokens(fL, fTokens) && containsTokens(tL, tTokens);
      const rev = containsTokens(tL, fTokens) && containsTokens(fL, tTokens);
      let s = 9;
      if (fwd) s = 0; else if (rev) s = 1; else {
        const one = (fTokens.length && (containsTokens(fL, fTokens) || containsTokens(tL, fTokens))) ||
                    (tTokens.length && (containsTokens(fL, tTokens) || containsTokens(tL, tTokens)));
        s = one ? 2 : 9;
      }
      return {doc:d, score:s, fwd, rev};
    });

    // –Ø–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ –æ–±–∏–¥–≤—ñ —Å—Ç–æ—Ä–æ–Ω–∏ ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ–≤–Ω—ñ –∑–±—ñ–≥–∏
    const filtered = bothSidesProvided ? scored.filter(r => r.fwd || r.rev) : scored.filter(r => r.score < 9);
    filtered.sort((a,b)=> a.score - b.score);

    // –†–µ–Ω–¥–µ—Ä —É –º–æ–¥–∞–ª–∫—É
  listEl.innerHTML = '';
  if (filtered.length === 0){ emptyEl.style.display = 'block'; return; }

    const frag = document.createDocumentFragment();
    filtered.slice(0, 30).forEach(({doc}) => {
      const d = doc.data() || {};
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr auto auto';
      row.style.gap = '6px';
      row.style.alignItems = 'center';
      const title = document.createElement('div');
  title.textContent = formatRouteTitle(d);
      title.title = title.textContent;
      const btnPrev = document.createElement('button');
      btnPrev.className = 'btn xs'; btnPrev.textContent = 'üëÅ –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π';
      btnPrev.onclick = () => {
        const coords = fromObjPoints(d.points||[]);
        showPreviewRoute(coords);
        try{
          if (coords.length){ const b = new mapboxgl.LngLatBounds(coords[0], coords[0]); coords.forEach(p=>b.extend(p)); map.fitBounds(b, { padding: 50, maxZoom: 14 }); }
        }catch(_){ }
      };
      const btnApply = document.createElement('button');
      btnApply.className = 'btn xs'; btnApply.textContent = '‚úÖ –ù–∞–∫–ª–∞—Å—Ç–∏';
      btnApply.onclick = () => {
        // –ù–µ —á—ñ–ø–∞—î–º–æ –ø–æ–ª—è –í—ñ–¥/–î–æ ‚Äî –ª–∏—à–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç—É —Ç–∞ –ª—ñ–Ω—ñ–π–∫–∏
        points     = fromObjPoints(d.points||[]);
        startRuler = fromObjPoints(d.startRuler||[]);
        endRuler   = fromObjPoints(d.endRuler||[]);
        rebuildMarkers(); rebuildRulerMarkers(); drawRulers(); updateRoute();
        clearPreviewRoute();
        modal.classList.remove('show');
      };
      row.appendChild(title); row.appendChild(btnPrev); row.appendChild(btnApply);
      frag.appendChild(row);
    });
    listEl.appendChild(frag);
  }catch(e){
    console.error('similar search error:', e);
    listEl.innerHTML = '<div style="color:#b91c1c">–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É.</div>';
  }
}

document.getElementById('findSimilarBtn').onclick = () => {
  if (!db){ alert('–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
  findSimilarRoutes();
};
document.getElementById('similarClose').onclick = () => {
  document.getElementById('similarModal').classList.remove('show');
};
document.getElementById('similarClearPreview').onclick = () => clearPreviewRoute();

/* ===== Map click ===== */
map.on('click', (e) => {
  const lngLat = [e.lngLat.lng, e.lngLat.lat];
  contextMenu.style.display = 'none';
  if (readOnly) return;

  // –ù–æ–≤–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º –≤—Å—Ç–∞–≤–∫–∏
  if (insertMode && selectedMarkerIndex !== null){
    const where = (insertMode.where === 'before') ? 0 : 1;
    if (insertMode.type === 'route'){
      points.splice(selectedMarkerIndex + where, 0, lngLat);
      rebuildMarkers();
    } else if (insertMode.type === 'ruler-start'){
      startRuler.splice(selectedMarkerIndex + where, 0, lngLat);
      rebuildRulerMarkers(); drawRulers(); updateRoute();
    } else if (insertMode.type === 'ruler-end'){
      endRuler.splice(selectedMarkerIndex + where, 0, lngLat);
      rebuildRulerMarkers(); drawRulers(); updateRoute();
    }
    insertMode = null; selectedMarkerIndex = null; selectedMarkerType = null;
    return;
  }
  // –°—Ç–∞—Ä–∏–π —Ä–µ–∂–∏–º ¬´–≤—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ—Å–ª—è¬ª (—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å)
  if (insertAfterMode && selectedMarkerIndex !== null) {
    points.splice(selectedMarkerIndex + 1, 0, lngLat);
    insertAfterMode = false; rebuildMarkers(); return;
  }
  if (startLineMode) { startRuler.push(lngLat); setActiveRuler('start'); try{ addRulerMarker('start', lngLat, startRuler.length - 1); }catch(_){} drawRulers(); updateRoute(); return; }
  if (endLineMode)   { endRuler.push(lngLat); setActiveRuler('end');   try{ addRulerMarker('end',   lngLat, endRuler.length - 1);   }catch(_){} drawRulers(); updateRoute(); return; }
  if (addMode)       { points.push(lngLat); addMarker(lngLat); updateRoute(); }
});

function addMarker(lngLat, index = points.length - 1) {
  // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞—Å—Ç–æ–º–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –º–∞—Ä–∫–µ—Ä–∞ –∑ —Ü–∏—Ñ—Ä–æ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
  const el = document.createElement('div');
  el.className = 'route-marker';
  el.textContent = String((index ?? 0) + 1);
  if (!markersVisible) el.style.display = 'none';

  const marker = new mapboxgl.Marker({ element: el, draggable: !readOnly })
    .setLngLat(lngLat)
    .addTo(map);
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç-–º–µ–Ω—é: –ü–ö–ú + long-press (iOS/iPadOS)
  const openMenuAt = (x, y) => {
    if (readOnly) return;
    selectedMarkerIndex = index; selectedMarkerType = 'route';
    contextMenu.style.left = x + 'px';
    contextMenu.style.top  = y + 'px';
    contextMenu.style.display = 'block';
  };
  el.addEventListener('contextmenu', (e) => {
    e.preventDefault(); e.stopPropagation();
    openMenuAt(e.pageX, e.pageY);
  });
  // Long-press –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
  (function attachLongPress(node){
    let t = null, startX=0, startY=0, moved=false;
    const TH=12, DELAY=550;
    const clear = ()=>{ if(t){ clearTimeout(t); t=null; } moved=false; };
    const onDown = (e)=>{
      const touch = e.touches && e.touches[0];
      startX = (touch? touch.pageX : e.pageX) || 0;
      startY = (touch? touch.pageY : e.pageY) || 0;
      moved = false;
      clear();
      t = setTimeout(()=>{ openMenuAt(startX, startY); }, DELAY);
    };
    const onMove = (e)=>{
      const touch = e.touches && e.touches[0];
      const x = (touch? touch.pageX : e.pageX) || 0;
      const y = (touch? touch.pageY : e.pageY) || 0;
      if (Math.abs(x-startX) > TH || Math.abs(y-startY) > TH){ moved=true; clear(); }
    };
    const onUpCancel = ()=> clear();
    node.addEventListener('touchstart', onDown, { passive:true });
    node.addEventListener('touchmove', onMove, { passive:true });
    node.addEventListener('touchend', onUpCancel);
    node.addEventListener('touchcancel', onUpCancel);
    node.addEventListener('pointerdown', (e)=>{ if(e.pointerType==='touch') return; });
  })(el);
  marker.on('dragend', () => {
    if (readOnly) return;
    const ll = marker.getLngLat();
    points[index] = [ll.lng, ll.lat];
    updateRoute();
  });
  markers.push(marker);

  // –¢–µ–ø–µ—Ä –Ω–æ–º–µ—Ä –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–∞–º–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞; –æ–∫—Ä–µ–º–∏–π –±–µ–π–¥–∂ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
}

function rebuildMarkers() {
  markers.forEach(m => m.remove()); markers = [];
  points.forEach((pt, idx) => addMarker(pt, idx));
  selectedMarkerIndex = null; insertAfterMode = false; contextMenu.style.display = 'none';
  updateRoute();
}

// ===== –ú–∞—Ä–∫–µ—Ä–∏ –¥–ª—è –ª—ñ–Ω—ñ–π–æ–∫ (start/end) =====
function addRulerMarker(kind, lngLat, index){
  // kind: 'start' | 'end'
  const el = document.createElement('div');
  el.className = `ruler-marker ${kind}`;
  el.textContent = String((index ?? 0) + 1);
  if (!markersVisible) el.style.display = 'none';
  const marker = new mapboxgl.Marker({ element: el, draggable: !readOnly })
    .setLngLat(lngLat)
    .addTo(map);
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –¥–ª—è –ª—ñ–Ω—ñ–π–æ–∫: long-press / –ü–ö–ú
  const openMenuAt = (x, y) => {
    if (readOnly) return;
    selectedMarkerIndex = index;
    selectedMarkerType = (kind === 'start') ? 'ruler-start' : 'ruler-end';
    contextMenu.style.left = x + 'px';
    contextMenu.style.top  = y + 'px';
    contextMenu.style.display = 'block';
  };
  el.addEventListener('contextmenu', (e) => {
    e.preventDefault(); e.stopPropagation();
    openMenuAt(e.pageX, e.pageY);
  });
  (function attachLongPress(node){
    let t = null, startX=0, startY=0; const TH=12, DELAY=550;
    const clear=()=>{ if(t){ clearTimeout(t); t=null; } };
    node.addEventListener('touchstart', (e)=>{
      const touch=e.touches&&e.touches[0];
      startX=(touch?touch.pageX:e.pageX)||0; startY=(touch?touch.pageY:e.pageY)||0;
      clear(); t=setTimeout(()=>openMenuAt(startX,startY), DELAY);
    }, { passive:true });
    node.addEventListener('touchmove', (e)=>{
      const touch=e.touches&&e.touches[0];
      const x=(touch?touch.pageX:e.pageX)||0; const y=(touch?touch.pageY:e.pageY)||0;
      if (Math.abs(x-startX)>TH || Math.abs(y-startY)>TH) clear();
    }, { passive:true });
    node.addEventListener('touchend', clear);
    node.addEventListener('touchcancel', clear);
  })(el);
  marker.on('drag', () => {
    if (readOnly) return;
    const ll = marker.getLngLat();
    if (kind === 'start') {
      if (index >= 0 && index < startRuler.length) startRuler[index] = [ll.lng, ll.lat];
    } else {
      if (index >= 0 && index < endRuler.length)   endRuler[index]   = [ll.lng, ll.lat];
    }
    drawRulers();
    // –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –Ω–µ —á—ñ–ø–∞—î–º–æ –º–∞—Ä—à—Ä—É—Ç; —è–∫—â–æ –º–∞—Ä—à—Ä—É—Ç—É –Ω–µ–º–∞—î ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ —á—ñ–ø –∫–º
    if (points.length < 2){
      const km = calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler);
      setKmUI(km);
    }
  });
  marker.on('dragend', () => {
    if (readOnly) return;
    const ll = marker.getLngLat();
    if (kind === 'start') {
      if (index >= 0 && index < startRuler.length) startRuler[index] = [ll.lng, ll.lat];
    } else {
      if (index >= 0 && index < endRuler.length)   endRuler[index]   = [ll.lng, ll.lat];
    }
    drawRulers();
    updateRoute(); // –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –∫–º + –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, —è–∫—â–æ —î –º–∞—Ä—à—Ä—É—Ç
  });
  if (kind === 'start') startRulerMarkers.push(marker); else endRulerMarkers.push(marker);
}
function clearRulerMarkers(){
  startRulerMarkers.forEach(m => m.remove()); startRulerMarkers = [];
  endRulerMarkers.forEach(m => m.remove());   endRulerMarkers   = [];
}
function rebuildRulerMarkers(){
  clearRulerMarkers();
  startRuler.forEach((pt, idx) => addRulerMarker('start', pt, idx));
  endRuler.forEach((pt, idx)   => addRulerMarker('end',   pt, idx));
}

let markersVisible = (()=>{ try{ return JSON.parse(localStorage.getItem('ui.markersVisible') ?? 'true'); }catch(_){ return true; } })();
document.getElementById('toggleMarkers').onclick = () => {
  markersVisible = !markersVisible;
  markers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
  // —Ç–∞–∫–æ–∂ –∫–µ—Ä—É—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—é –º–∞—Ä–∫–µ—Ä—ñ–≤ –ª—ñ–Ω—ñ–π–æ–∫
  startRulerMarkers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
  endRulerMarkers.forEach(m   => m.getElement().style.display = markersVisible ? 'block' : 'none');
  // –ù—É–º–µ—Ä–∞—Ü—ñ—è –º–∞—Ä—à—Ä—É—Ç—É –≤–∂–µ –≤ —Å–∞–º–∏—Ö –º–∞—Ä–∫–µ—Ä–∞—Ö
  document.getElementById('toggleMarkers').textContent = markersVisible ? 'üìç –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–æ—á–∫–∏' : 'üìç –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–∫–∏';
  try{ localStorage.setItem('ui.markersVisible', JSON.stringify(markersVisible)); }catch(_){ }
  // –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –ø–æ–∫–∞–∑—ñ ‚Äî –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–±—É–¥—É–≤–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏, —â–æ–± –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é —ñ–Ω–¥–µ–∫—Å—ñ–≤/–ø–æ–∑–∏—Ü—ñ–π
  if (markersVisible){
    try{ rebuildMarkers(); }catch(_){ }
    try{ rebuildRulerMarkers(); drawRulers(); }catch(_){ }
  }
};

// –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω –≤–∏–¥–∏–º–æ—Å—Ç—ñ —Ç–æ—á–æ–∫ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
try{
  const applyMarkersVisibility = () => {
    markers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
    startRulerMarkers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
    endRulerMarkers.forEach(m   => m.getElement().style.display = markersVisible ? 'block' : 'none');
    const b = document.getElementById('toggleMarkers');
    if (b) b.textContent = markersVisible ? 'üìç –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–æ—á–∫–∏' : 'üìç –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–∫–∏';
  };
  // –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
  applyMarkersVisibility();
}catch(_){ }
/* ===== Geozones toggle (all related layers) ===== */
let geozonesVisible = (()=>{ try{ return JSON.parse(localStorage.getItem('ui.geozonesVisible') ?? 'true'); }catch(_){ return true; } })();

function setLayerVisibility(id, visible){
  try {
    if (map.getLayer(id)) {
      map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');
    }
  } catch(_) {}
}
// üîß –ë–∞–∑–æ–≤—ñ –Ω–µ–ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ –¥–ª—è –≥–µ–æ–∑–æ–Ω (–ø—ñ–¥–≤–∏—â–µ–Ω–æ fill –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ –Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –º–∞—Å—à—Ç–∞–±–∞—Ö)
const GZ_DEFAULTS = { fill: 0.35, line: 1, circle: 1, symbol: 1 };

// –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ opacity –¥–ª—è —à–∞—Ä—É –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –π–æ–≥–æ —Ç–∏–ø—É
function setLayerOpacity(id, opacity){
  if (!map.getLayer(id)) return;
  const type = map.getLayer(id).type;
  const prop = type === 'fill'   ? 'fill-opacity'
            : type === 'line'   ? 'line-opacity'
            : type === 'circle' ? 'circle-opacity'
            : type === 'symbol' ? 'text-opacity'
            : null;
  if (!prop) return;
  try { map.setPaintProperty(id, prop, opacity); } catch(_) {}
}

// –ú–∞—Å–æ–≤–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ opacity –¥–æ –ø–µ—Ä–µ–ª—ñ–∫—É —à–∞—Ä—ñ–≤
function setManyOpacity(ids, opacity){
  ids.forEach(id => setLayerOpacity(id, opacity));
}

function setGeozonesVisibility(visible){
  const hasFromSel = !!(getCodeByInput('fromName') || (document.getElementById('fromName').value || '').trim());
  const hasToSel   = !!(getCodeByInput('toName')   || (document.getElementById('toName').value   || '').trim());

  // –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ö–∞–π–ª–∞–π—Ç–∏ (–í—ñ–¥/–î–æ), —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –≥–µ–æ–∑–æ–Ω–∏ –ê–ë–û —î –≤–∏–±—ñ—Ä –ø–æ–ª—ñ–≤
  const showHL = visible || hasFromSel || hasToSel;

  // 1) –ë–∞–∑–æ–≤—ñ –ø—ñ–¥–ø–∏—Å–∏ —É—Å—ñ—Ö –≥–µ–æ–∑–æ–Ω:
  //    ‚Äî –≤–∏–¥–Ω–æ –¢–Ü–õ–¨–ö–ò –∫–æ–ª–∏ —Ç—É–º–±–ª–µ—Ä —É–≤—ñ–º–∫–Ω–µ–Ω–æ
  ['geozones-label','geozones-labels'].forEach(id => {
    if (map.getLayer(id)) setLayerVisibility(id, !!visible);
  });

  // 2) –ë–∞–∑–æ–≤—ñ –≥–µ–æ–∑–æ–Ω–∏ (—É—Å—ñ –ø–æ–ª—è):
  //    ‚Äî –∫–æ–ª–∏ —Ç—É–º–±–ª–µ—Ä –≤–∏–º–∫–Ω–µ–Ω–æ, –ø–æ–≤–Ω—ñ—Å—Ç—é —Ö–æ–≤–∞—î–º–æ (visibility:none), —â–æ–± –Ω–µ –±—É–ª–æ hover –ø–æ –≤—Å—ñ—Ö
  [['geozones-fill','fill'], ['geozones-outline','line'], ['geozones-point','circle']].forEach(([id, kind]) => {
    if (!map.getLayer(id)) return;
    setLayerVisibility(id, !!visible);
    setLayerOpacity(id, visible ? GZ_DEFAULTS[kind] : 0);
  });
  TS_FILL_IDS.forEach(id => {
  const key = id.replace('tileset-fill-','');
  const ts  = TILESETS.find(t => t.key === key);
  const allowed = ts ? tilesetAllowedForUser(ts) : true;
  setLayerVisibility(id, !!visible && allowed);
  setLayerOpacity(id, visible ? GZ_DEFAULTS.fill : 0);
});

TS_OUTLINE_IDS.forEach(id => {
  const key = id.replace('tileset-outline-','');
  const ts  = TILESETS.find(t => t.key === key);
  const allowed = ts ? tilesetAllowedForUser(ts) : true;
  setLayerVisibility(id, !!visible && allowed);
  setLayerOpacity(id, visible ? GZ_DEFAULTS.line : 0);
});

  // 3) –•–∞–π–ª–∞–π—Ç-–∑–∞–ª–∏–≤–∫–∏ —Ç–∞ —ó—Ö –ø—ñ–¥–ø–∏—Å–∏ (—Ç—ñ–ª—å–∫–∏ –í—ñ–¥/–î–æ)
  [...HL_IDS_FROM, ...HL_IDS_TO, ...HL_LABEL_IDS_FROM, ...HL_LABEL_IDS_TO]
    .forEach(id => setLayerVisibility(id, showHL));

  // –í—Å–µ: –∫–æ–ª–∏ –≥–µ–æ–∑–æ–Ω–∏ ¬´–≤–∏–º–∫–Ω–µ–Ω–æ¬ª, –≤–∏–¥–Ω–æ –π —Ä–µ–∞–≥—É—é—Ç—å —Ç—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω—ñ (—á–µ—Ä–µ–∑ —Ö–∞–π–ª–∞–π—Ç–∏).
}

function updateGeozonesToggleLabel(){
  const b = document.getElementById('toggleGeozones');
  if (!b) return;
  b.textContent = geozonesVisible ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏';
}

document.getElementById('toggleGeozones').onclick = () => {
  geozonesVisible = !geozonesVisible;
  setGeozonesVisibility(geozonesVisible);
  updateGeozonesToggleLabel();
  try{ localStorage.setItem('ui.geozonesVisible', JSON.stringify(geozonesVisible)); }catch(_){ }
};

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –Ω–∞–ø–∏—Å –Ω–∞ –∫–Ω–æ–ø—Ü—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
updateGeozonesToggleLabel();
// –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —ñ —Å—Ç–∞–Ω –≤–∏–¥–∏–º–æ—Å—Ç—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
try{ setGeozonesVisibility(geozonesVisible); }catch(_){ }
// –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω –≥–µ–æ–∑–æ–Ω –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∏–ª—é
try{
  if (map && map.isStyleLoaded && map.isStyleLoaded()) setGeozonesVisibility(geozonesVisible);
  else map.once('style.load', () => setGeozonesVisibility(geozonesVisible));
}catch(_){ }

/* ==== –î–æ—Ä–æ–∂–Ω—è —Å—ñ—Ç–∫–∞ (—Ç–æ–Ω–∫–∞ —Å–∏–Ω—è —Å—É—Ü—ñ–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è) ==== */
const ROAD_SRC_ID = 'road-grid-src';
const ROAD_LAYER_ID = 'road-grid';

function addRoadGridLayer(){
  try{
    if (!map.getSource(ROAD_SRC_ID)){
      map.addSource(ROAD_SRC_ID, { type: 'vector', url: 'mapbox://mapbox.mapbox-streets-v8' });
    }
    if (!map.getLayer(ROAD_LAYER_ID)){
      map.addLayer({
        id: ROAD_LAYER_ID,
        type: 'line',
        source: ROAD_SRC_ID,
        'source-layer': 'road',
        filter: ['in', ['get','class'], ['literal', [
          'motorway','trunk','primary','secondary','tertiary','street','street_limited','service','link','track'
        ]]],
        layout: { 'line-join':'round', 'line-cap':'round', 'visibility': roadGridVisible ? 'visible' : 'none' },
        paint: {
          'line-color': '#1d4ed8',
          // –ü—Ä–∏–≤'—è–∑–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç—ñ –¥–æ –∑—É–º–∞: –¥–æ ~10 –Ω–µ –≤–∏–¥–Ω–æ, –¥–∞–ª—ñ –ø–ª–∞–≤–Ω–æ –∑'—è–≤–ª—è—î—Ç—å—Å—è –ª—ñ–Ω—ñ—ó
          'line-opacity': ['interpolate',['linear'],['zoom'], 0, 0, 9.5, 0, 10, 0.25, 12, 0.4, 14, 0.6, 16, 0.75],
          // –¢—Ä—ñ—à–∫–∏ —Ç–æ–≤—Å—Ç—ñ—à–∞ –ª—ñ–Ω—ñ—è
          'line-width': ['interpolate',['linear'],['zoom'], 5, 0.22, 10, 0.35, 12, 0.55, 14, 0.8]
        }
      });
    }
    ensureRoadGridBelowRoutes();
    updateRoadGridToggleLabel();
  }catch(e){ console.warn('road grid add error:', e); }
}

function ensureRoadGridBelowRoutes(){
  try{
    if (!map.getLayer(ROAD_LAYER_ID)) return;
    if (routeLayers && routeLayers.length && map.getLayer(routeLayers[0])){
      map.moveLayer(ROAD_LAYER_ID, routeLayers[0]);
    }
  }catch(_){ }
}

function setRoadGridVisibility(v){
  roadGridVisible = !!v;
  try{
    if (map.getLayer(ROAD_LAYER_ID)){
      map.setLayoutProperty(ROAD_LAYER_ID, 'visibility', roadGridVisible ? 'visible' : 'none');
    }
  }catch(_){ }
  updateRoadGridToggleLabel();
  try{ localStorage.setItem('ui.roadGridVisible', JSON.stringify(roadGridVisible)); }catch(_){ }
}

function updateRoadGridToggleLabel(){
  const b = document.getElementById('toggleRoadGrid');
  if (!b) return;
  b.textContent = roadGridVisible ? 'üõ£ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Å—ñ—Ç–∫—É –¥–æ—Ä—ñ–≥' : 'üõ£ –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—ñ—Ç–∫—É –¥–æ—Ä—ñ–≥';
}

let roadGridVisible = (()=>{ try{ return JSON.parse(localStorage.getItem('ui.roadGridVisible') ?? 'true'); }catch(_){ return true; } })();
const __roadBtn = document.getElementById('toggleRoadGrid');
if (__roadBtn){
  __roadBtn.onclick = () => setRoadGridVisibility(!roadGridVisible);
  updateRoadGridToggleLabel();
  // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —à–∞—Ä—É
  try{ setRoadGridVisibility(roadGridVisible); }catch(_){ }
}

/* ===== –ï–∫—Å–ø–æ—Ä—Ç PNG —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞ –∫–∞—Ä—Ç–∏ ===== */
function downloadMapPng(){
  try{
    const baseCanvas = map.getCanvas();
    const dataUrl = baseCanvas.toDataURL('image/png');

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —â–æ–± –Ω–∞–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ–≤–µ—Ä—Ö –Ω—å–æ–≥–æ –ø—ñ–¥–ø–∏—Å (–Ω–∞–∑–≤–∞ + –≤—ñ–¥—Å—Ç–∞–Ω—å)
    const img = new Image();
    img.onload = () => {
      const w = img.naturalWidth || baseCanvas.width;
      const h = img.naturalHeight || baseCanvas.height;
      const can = document.createElement('canvas');
      can.width = w; can.height = h;
      const ctx = can.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      // –î–∞–Ω—ñ –¥–ª—è –ø—ñ–¥–ø–∏—Å—É
      const getVal = (id) => (document.getElementById(id)?.value || '').trim();
      const from = getVal('fromName');
      const to   = getVal('toName');
      const routeName = (from && to) ? `${from} ‚Üí ${to}` : (getVal('routeName') || '–ú–∞—Ä—à—Ä—É—Ç');
      const distText = (()=>{
        const t = (document.getElementById('distanceTop')?.textContent || '').trim();
        return t ? `${Number(t).toFixed(2)} –∫–º` : '';
      })();

      // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ –ø—ñ–¥–ø–∏—Å—É
      const padX = 12, padY = 10, gap = 4; // –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –≤—ñ–¥—Å—Ç—É–ø–∏
      const margin = 12;                   // –≤—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ –∫—Ä–∞—ó–≤ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      const titleFont = '600 18px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial';
      const metaFont  = '400 14px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial';
      ctx.save();
      ctx.textBaseline = 'top';

      // –û–±—á–∏—Å–ª–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ –∫–æ—Ä–æ–±–∫–∏
      ctx.font = titleFont; const titleW = ctx.measureText(routeName).width; const titleH = 22;
      ctx.font = metaFont;  const metaW  = distText ? ctx.measureText(`–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`).width : 0; const metaH = distText ? 18 : 0;
      const boxW = Math.ceil(Math.max(titleW, metaW) + padX*2);
      const boxH = Math.ceil(titleH + (distText ? (gap + metaH) : 0) + padY*2);

      // –ü–æ–∑–∏—Ü—ñ—è (–ª—ñ–≤–∏–π –Ω–∏–∑)
      const x = margin, y = h - boxH - margin;

      // –§–æ–Ω–æ–≤–∞ –∫–∞—Ä—Ç–∫–∞ –∑ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è–º
      const r = 10;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.lineTo(x+boxW-r, y);
      ctx.quadraticCurveTo(x+boxW, y, x+boxW, y+r);
      ctx.lineTo(x+boxW, y+boxH-r);
      ctx.quadraticCurveTo(x+boxW, y+boxH, x+boxW-r, y+boxH);
      ctx.lineTo(x+r, y+boxH);
      ctx.quadraticCurveTo(x, y+boxH, x, y+boxH-r);
      ctx.lineTo(x, y+r);
      ctx.quadraticCurveTo(x, y, x+r, y);
      ctx.closePath();
      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(0,0,0,0.12)';
      ctx.stroke();

      // –¢–µ–∫—Å—Ç: –Ω–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É
      let tx = x + padX, ty = y + padY;
      ctx.font = titleFont; ctx.fillStyle = '#111827';
      ctx.fillText(routeName, tx, ty);
      // –¢–µ–∫—Å—Ç: –≤—ñ–¥—Å—Ç–∞–Ω—å
      if (distText){
        ty += titleH + gap;
        ctx.font = metaFont; ctx.fillStyle = '#374151';
        ctx.fillText(`–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`, tx, ty);
      }
      ctx.restore();

  const out = can.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = out;
  // —ñ–º'—è —Ñ–∞–π–ª—É: –í—ñ–¥ ‚Üí –î–æ ‚Äî –¢–∏–ø (–æ—á–∏—â–µ–Ω–µ –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ —Ñ–∞–π–ª–æ–≤–æ—é —Å–∏—Å—Ç–µ–º–æ—é)
  const safeName = (s)=> (s||'').replace(/[\\\/:*?"<>|]+/g,' ').replace(/\s+/g,' ').trim().slice(0,120) || '–ú–∞—Ä—à—Ä—É—Ç';
  const routeTypeVal = (document.getElementById('routeType')?.value || '').trim();
  const fileBase = routeTypeVal ? `${routeName} ‚Äî ${routeTypeVal}` : routeName;
  a.download = `${safeName(fileBase)}.png`;
      if (typeof a.download !== 'string') window.open(out, '_blank');
      else a.click();
    };
    img.src = dataUrl;
  }catch(e){
    console.error('PNG export failed:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ PNG. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–±—ñ–ª—å—à–∏—Ç–∏ –º–∞—Å—à—Ç–∞–±.');
  }
}
document.getElementById('exportPng')?.addEventListener('click', downloadMapPng);

/* ===== Rulers (draw + distance) ===== */
function drawRulers() {
  rulerLines.forEach(id => { if (map.getLayer(id)) map.removeLayer(id); if (map.getSource(id)) map.removeSource(id); });
  rulerLines = [];
  drawRulerSegment(startRuler, 'start', '#0066ff');
  // –ö—ñ–Ω—Ü–µ–≤–∞ –ª—ñ–Ω—ñ–π–∫–∞: –ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∞
  drawRulerSegment(endRuler, 'end', '#f59e0b');
}
function drawRulerSegment(ruler, prefix, color) {
  for (let i = 0; i < ruler.length - 1; i++) {
    const lineId = `${prefix}-ruler-${i}`;
    const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: [ruler[i], ruler[i + 1]] } };
    map.addSource(lineId, { type: 'geojson', data: geojson });
    map.addLayer({ id: lineId, type: 'line', source: lineId,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 4, 'line-dasharray': [1, 2] } });
    rulerLines.push(lineId);
  }
}

/* Haversine fallback */
function haversineKm(a, b){
  const toRad = d => d * Math.PI / 180;
  const [lng1, lat1] = a, [lng2, lat2] = b;
  const R = 6371;
  const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const h = s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2;
  return 2 * R * Math.asin(Math.sqrt(h));
}
function calculateRulerDistance(ruler) {
  if (!Array.isArray(ruler) || ruler.length < 2) return 0;
  let dist = 0;
  if (window.turf && typeof turf.distance === 'function'){
    for (let i = 0; i < ruler.length - 1; i++) {
      dist += turf.distance(turf.point(ruler[i]), turf.point(ruler[i + 1]), { units: 'kilometers' });
    }
  } else {
    for (let i = 0; i < ruler.length - 1; i++) { dist += haversineKm(ruler[i], ruler[i + 1]); }
  }
  return dist;
}

/* ===== –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ ===== */
function updateCounters(){
  const routeCount = points.length;
  const startCount = startRuler.length;
  const endCount   = endRuler.length;
  const total      = routeCount + startCount + endCount;
  const byId = id => document.getElementById(id);
  byId('countRoute').textContent = routeCount;
  byId('countStart').textContent = startCount;
  byId('countEnd').textContent   = endCount;
  byId('countTotal').textContent = total;
}
// –ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª–æ–º–µ—Ç—Ä–∞–∂ —ñ–∑ –≤–∏–¥–∏–º–æ–≥–æ —á—ñ–ø–∞ –∑–≤–µ—Ä—Ö—É
function getUIKm(){
  const t = document.getElementById('distanceTop');
  const s = (t?.textContent || '0').replace(',', '.');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}

function setKmUI(km){
  const v = (km != null && isFinite(km)) ? Number(km).toFixed(2) : '0.00';
  const elSide = document.getElementById('distance');     // (–º–æ–∂–µ –≤–∂–µ –Ω–µ —ñ—Å–Ω—É–≤–∞—Ç–∏ ‚Äî –æ–∫)
  if (elSide) elSide.textContent = v;
  const elTop  = document.getElementById('distanceTop');  // –Ω–æ–≤–∏–π —á—ñ–ø –∑–≤–µ—Ä—Ö—É
  if (elTop) elTop.textContent = v;
}

/* ===== Route rendering ===== */
function splitIntoChunks(array, chunkSize) {
  const chunks = [];
  for (let i = 0; i < array.length - 1; i += chunkSize - 1) {
    const chunk = array.slice(i, i + chunkSize);
    if (chunk.length >= 2) chunks.push(chunk);
  }
  return chunks;
}

// ==== –î–æ–ø–æ–º—ñ–∂–Ω–µ: –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —á–∏ –Ω–∞—Å—Ç—É–ø–Ω–∞ —Ç–æ—á–∫–∞ –≤–∏–º–∞–≥–∞—î —Ä–æ–∑–≤–æ—Ä–æ—Ç—É (–º–∞–π–∂–µ 180¬∞) ====
function _toRad(d){ return d * Math.PI / 180; }
function _toDeg(r){ return r * 180 / Math.PI; }
function bearingDeg(a, b){
  // –ì–µ–æ–¥–µ–∑–∏—á–Ω–∏–π –∞–∑–∏–º—É—Ç a->b (WGS84, –Ω–∞–±–ª–∏–∂–µ–Ω–æ)
  const [lon1, lat1] = a; const [lon2, lat2] = b;
  const œÜ1 = _toRad(lat1), œÜ2 = _toRad(lat2);
  const ŒîŒª = _toRad(lon2 - lon1);
  const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
  const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  let Œ∏ = Math.atan2(y, x); // -œÄ..œÄ
  let deg = (_toDeg(Œ∏) + 360) % 360; // 0..360
  return deg;
}
function angleDiffDeg(a, b){
  let d = Math.abs(a - b) % 360;
  return d > 180 ? 360 - d : d; // 0..180
}
function detectUTurn(seq){
  // true, —è–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ–≤–æ—Ä–æ—Ç ‚âà —Ä–æ–∑–≤–æ—Ä–æ—Ç (–∫—É—Ç > 150¬∞)
  if (!Array.isArray(seq) || seq.length < 3) return false;
  const n = seq.length;
  const h1 = bearingDeg(seq[n-3], seq[n-2]);
  const h2 = bearingDeg(seq[n-2], seq[n-1]);
  const diff = angleDiffDeg(h1, h2);
  return diff >= 150; // –ø–æ—Ä—ñ–≥ –º–æ–∂–Ω–∞ –ø—ñ–¥–∫—Ä—É—Ç–∏—Ç–∏
}
function clearRouteLayers() {
  routeLayers.forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
    if (map.getSource(id)) map.removeSource(id);
  });
  routeLayers = [];
}
async function updateRoute() {
  if (points.length < 2) {
    setKmUI(calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler));
    updateCounters(); clearRouteLayers(); return;
  }
  const chunks = splitIntoChunks(points, 20);
  let totalDistance = 0;
  clearRouteLayers();

  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];
    const coordsStr = chunk.map(p => p.join(',')).join(';');
    // –î–æ–∑–≤–æ–ª—è—î–º–æ —Ä–æ–∑–≤–æ—Ä–æ—Ç–∏ –±—ñ–ª—è –ø—Ä–æ–º—ñ–∂–Ω–∏—Ö —Ç–æ—á–æ–∫, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É "–Ω–∞–∑–∞–¥"
    const allowUTurn = detectUTurn(chunk);
    const continueStraight = allowUTurn ? 'false' : 'true';
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}`+
                `?geometries=geojson&overview=full&continue_straight=${continueStraight}`+
                `&access_token=${mapboxgl.accessToken}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.routes && data.routes[0]) {
        const route = data.routes[0];
        totalDistance += route.distance;
        const layerId = `route-part-${i}`;
        const geo = { type: 'Feature', geometry: route.geometry };
        // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞: –æ–Ω–æ–≤–ª—é—î–º–æ —è–∫—â–æ —ñ—Å–Ω—É—î, —ñ–Ω–∞–∫—à–µ –¥–æ–¥–∞—î–º–æ
        if (map.getSource(layerId)) {
          try { map.getSource(layerId).setData(geo); } catch(_){}
          if (!map.getLayer(layerId)){
            map.addLayer({
              id: layerId, type: 'line', source: layerId,
              layout: { 'line-join': 'round', 'line-cap': 'round' },
              paint: { 'line-color': `hsl(${(i * 60) % 360}, 100%, 50%)`, 'line-width': 5 }
            });
          }
        } else {
          map.addSource(layerId, { type: 'geojson', data: geo });
          map.addLayer({
            id: layerId, type: 'line', source: layerId,
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': `hsl(${(i * 60) % 360}, 100%, 50%)`, 'line-width': 5 }
          });
        }
        routeLayers.push(layerId);
      }
    } catch (e) { console.error('–ü–æ–º–∏–ª–∫–∞ –º–∞—Ä—à—Ä—É—Ç—É:', e); }
  }

  totalDistance = (totalDistance / 1000) + calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler);
  setKmUI(totalDistance);
  updateCounters();
  // –ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–æ—Ä–æ–∂–Ω—é —Å—ñ—Ç–∫—É –ø—ñ–¥ –Ω–∏—Ö
  try { ensureRoadGridBelowRoutes(); } catch(_) {}
  // canvas-–ª–µ–π–±–ª–∏ –≤–∏–º–∫–Ω–µ–Ω—ñ; –Ω—É–º–µ—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ DOM-–º–∞—Ä–∫–µ—Ä–∏
}
 

/* turf */
const turfScript = document.createElement('script');
turfScript.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js';
turfScript.onload = () => { updateRoute(); };
document.head.appendChild(turfScript);

/* ===================== Firebase ===================== */
let db = null, auth = null;
let storage = null;
// üëá –¢—Ä–∏–º–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–æ–±–æ—Ç–∏ –∑ –ª—ñ–Ω–∫–æ–º/–ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è–º
let LAST_SAVED_ROUTE = { id: null, label: '', data: null };

try {
  const CFG = window.APP_CONFIG?.firebase;
  if (!CFG) console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js.');
  firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG);

  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();

  console.log('‚úÖ Firebase:', firebase.app().options.projectId);
  if (!window.__PERSISTENCE_PROMISE) {
  window.__PERSISTENCE_PROMISE =
    firebase.firestore().enablePersistence({ synchronizeTabs: true })
      .catch((e) => console.warn('Firestore persistence is off:', e.code || e.message));
}
} catch (e) {
  console.error('‚ùå Firebase –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:', e);
}
// ===== HUB ACCESS (–≥–ª–æ–±–∞–ª—å–Ω–æ) =====

// –°–µ–º–∞–Ω—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø—É:
//   ALLOWED_HUBS === null  ‚Üí –í–°–Ü —Ö–∞–±–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ (admin/security/allowAll)
//   ALLOWED_HUBS === []     ‚Üí –ñ–û–î–ù–û–ì–û —Ö–∞–±—É –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ
//   ALLOWED_HUBS === ['X','Y'] ‚Üí –¥–æ–∑–≤–æ–ª–µ–Ω–æ –ø–µ—Ä–µ–ª—ñ–∫
let ALLOWED_HUBS = null;

function isAllHubs(){ return ALLOWED_HUBS === null; }
function hasNoHubs(){ return Array.isArray(ALLOWED_HUBS) && ALLOWED_HUBS.length === 0; }

function userAllowsHub(h){
  if (!h) return isAllHubs();
  return isAllHubs() || (Array.isArray(ALLOWED_HUBS) && ALLOWED_HUBS.includes(h));
}

async function getAllowedHubsForUser(uid, role){
  try{
    // –∞–¥–º—ñ–Ω–∏/–°–ë ‚Äî –±–∞—á–∞—Ç—å –≤—Å—ñ
    const rl = String(role||'').toLowerCase();
    if (rl === 'admin' || rl === 'security') return null;
    const snap = await db.collection('users').doc(uid).get({ source: 'server' });
    const d = snap.exists ? (snap.data() || {}) : {};
    if (d.allowAllHubs === true || d.allowedHubs === '*' || d.hubs === '*') return null;
    if (Array.isArray(d.allowedHubs) && d.allowedHubs.length) return d.allowedHubs.slice(0, 10);
    if (Array.isArray(d.hubs) && d.hubs.length)               return d.hubs.slice(0, 10);
    if (typeof d.hub === 'string' && d.hub.trim())            return [d.hub.trim()];
    if (typeof d.hubAccess === 'string' && d.hubAccess.trim())return [d.hubAccess.trim()];
    return []; // –∂–æ–¥–Ω–æ–≥–æ
  }catch(e){
    console.warn('getAllowedHubsForUser:', e?.message||e);
    return []; // –±–µ–∑–ø–µ—á–Ω–∏–π –¥–µ—Ñ–æ–ª—Ç ‚Äî –∂–æ–¥–Ω–æ–≥–æ
  }
}

// –°—Ö–æ–≤–∞—Ç–∏ –æ–ø—Ü—ñ—ó –≤ —Å–µ–ª–µ–∫—Ç—ñ "–•–∞–±", —è–∫—ñ –Ω–µ –≤—Ö–æ–¥—è—Ç—å —É –¥–æ—Å—Ç—É–ø
function applyHubSelectVisibility(){
  const sel = document.getElementById('hubSelect');
  if (!sel) return;

  if (hasNoHubs()){
    sel.value='';
    sel.disabled = true;
    [...sel.options].forEach(o=>{ if (o.value){ o.hidden=true; o.disabled=true; }});
    return;
  }

  [...sel.options].forEach(opt => {
    if (!opt.value) return; // ‚Äú‚Äî –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî‚Äù
    const ok = userAllowsHub(opt.value);
    opt.hidden   = !ok;
    opt.disabled = !ok;
  });

  if (!userAllowsHub(sel.value)){
    const firstAllowed = [...sel.options].find(o => o.value && userAllowsHub(o.value));
    sel.value = firstAllowed ? firstAllowed.value : '';
  }

  const exactlyOne = Array.isArray(ALLOWED_HUBS) && ALLOWED_HUBS.length === 1;
  const roleNow = (window.__userRole || currentRole || '').toLowerCase();
  const canLock = !(roleNow === 'admin' || roleNow === 'security');
  sel.disabled = exactlyOne && canLock;
}

// –û–±–≥–æ—Ä—Ç–∞—á Firestore-–∑–∞–ø–∏—Ç—É —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ —Ö–∞–±—É
function withHubFilter(q, field = 'hub'){
  if (isAllHubs()) return q;
  if (hasNoHubs()) return q.where(field,'==','__NO_ACCESS__');
  if (ALLOWED_HUBS.length === 1) return q.where(field, '==', ALLOWED_HUBS[0]);
  return q.where(field, 'in', ALLOWED_HUBS.slice(0, 10)); // Firestore in: –¥–æ 10 –∑–Ω–∞—á–µ–Ω—å
}

// –•—Ç–æ –º–æ–∂–µ —Ä–µ–∑–µ—Ä–≤—É–≤–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ routeKey –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó routeKeys (–ø–æ—Ç—Ä–µ–±—É—î –ø—Ä–∞–≤ —É Rules)
function userRoleLower(){ return (window.__userRole || currentRole || '').toLowerCase(); }
function userCanReserveRouteKeys(){
  const r = userRoleLower();
  return r === 'admin' || r === 'security';
}
// –•—Ç–æ –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –æ—Å—Ç–∞—Ç–æ—á–Ω–µ (—Ñ—ñ–∑–∏—á–Ω–µ) –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤
function userCanHardDeleteRoutes(){
  const r = userRoleLower();
  return r === 'admin' || r === 'security';
}

/* ===================== Directory / helpers / UI ===================== */
const dirByCode = {};
const codeByName = {};
const routesLookup = {};
const logistById = {};
const logistIdByName = {};

const DIR_CACHE_KEY_BASE = 'directoryCache.v2';
function dirCacheKey(){
  return isAllHubs() ? (DIR_CACHE_KEY_BASE + ':ALL')
                     : (DIR_CACHE_KEY_BASE + ':' + ALLOWED_HUBS.slice().sort().join('|'));
}
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;
// üëá –î–û–î–ê–ô –¶–ï –¢–£–¢
const DIR_NAME_FIELD = 'nameLower'; // —è–∫—â–æ –ø–æ–ª—è –Ω–µ–º–∞—î ‚Äî —Ç–∏–º—á–∞—Å–æ–≤–æ –ø–æ—Å—Ç–∞–≤ 'name'
// –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ–± –Ω–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ loadDirectory(false) –¥–≤—ñ—á—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
let DIR_LOADED_ONCE = false;

const LOGISTS_CACHE_KEY = 'logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function _norm(s){ return String(s||'').trim().toLowerCase(); }
// ‚Üì‚Üì‚Üì –¥–æ–¥–∞—Ç–∏ –ø–æ—Ä—è–¥ —ñ–∑ _norm
function trigrams(s){
  const t = (s || '')
    .toString()
    .toLowerCase()
    .normalize('NFKD')                 // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –¥—ñ–∞–∫—Ä–∏—Ç–∏–∫—É
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\p{L}\p{N}]+/gu,' ')   // —É—Å–µ, —â–æ –Ω–µ –ª—ñ—Ç–µ—Ä–∞ –∞–±–æ —Ü–∏—Ñ—Ä–∞ ‚Äî —É –ø—Ä–æ–±—ñ–ª
    .replace(/\s+/g,' ')
    .trim();

  const out = new Set();
  if (!t) return [];
  if (t.length < 3) return [t];        // –∫–æ—Ä–æ—Ç–∫—ñ —Å–ª–æ–≤–∞ —Ç–µ–∂ —ñ–Ω–¥–µ–∫—Å—É—î–º–æ
  for (let i = 0; i <= t.length - 3; i++) out.add(t.slice(i, i+3));
  // Firestore: array-contains-any –ø—Ä–∏–π–º–∞—î ‚â§10 –∑–Ω–∞—á–µ–Ω—å ‚Äî –æ–±—Ä—ñ–∑–∞—î–º–æ
  return Array.from(out).slice(0, 10);
}

/* ---- Directory ---- */
function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  list.innerHTML = '';
  Object.keys(dirByCode).forEach(k => delete dirByCode[k]);
  Object.keys(codeByName).forEach(k => delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if (!(name in codeByName)) codeByName[name] = code;

    const opt = document.createElement('option');
    opt.value = name;
    opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
}
// –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –∑–∞–Ω–æ—Å–∏—Ç—å –ø–∞—Ä—É (code, name) —É –ª–æ–∫–∞–ª—å–Ω—ñ –º–∞–ø–∏ —ñ datalist ‚Äî
// –ø–æ—Ç—Ä—ñ–±–Ω–æ, –∫–æ–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î/—Ñ–∞–π–ª—É —ñ —Ö–æ—á–µ–º–æ –ó–ë–ï–†–ï–ì–¢–ò –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É –∑—ñ —Å–ø–∏—Å–∫—É
function registerDirEntry(code, labelOrName){
  const name = parseNameFromLabel(labelOrName) || labelOrName || getNameByCode(code) || '';
  if (!code || !name) return;

  if (!dirByCode[code]) dirByCode[code] = { name, company:'', unit:'' };
  codeByName[name] = code;

  const list = document.getElementById('directoryList');
  if (list && ![...list.options].some(o => o.value === name)){
    const opt = document.createElement('option');
    opt.value = name;
    opt.label = name;
    list.appendChild(opt);
  }
}

async function loadDirectory(force = false){
  try{
    if (!force){
      const raw = localStorage.getItem(dirCacheKey());
      if (raw){
        const { ts, rows } = JSON.parse(raw);
        if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){
          fillDirectoryUI(rows);
          updateRouteName();
          console.log('üìí Directory from localStorage cache:', rows.length);
          return;
        }
      }
      // ‚ùó –ë–µ–∑ force –±—ñ–ª—å—à–µ –ù–ï —Ç—è–≥–Ω–µ–º–æ –≤—Å—é –∫–æ–ª–µ–∫—Ü—ñ—é.
      // –ü—ñ–¥–∫–∞–∑–∫–∏ –ø—ñ–¥—Ç—è–≥—É–≤–∞—Ç–∏–º—É—Ç—å—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∑–∞–ø–∏—Ç–∞–º–∏ —á–µ—Ä–µ–∑ typeahead.
      console.log('üìí Directory: cache miss ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (—á–µ–∫–∞—î–º–æ typeahead/Refresh).');
      return;
    }
  }catch{}

  // force=true: —Ç—è–≥–Ω–µ–º–æ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–Ω–æ–ø–∫–∞ "–û–Ω–æ–≤–∏—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫")
  let q = db.collection('directory');
q = withHubFilter(q, 'hub');
const snap = await q.get({ source:'default' });
  const rows = [];
  snap.forEach(doc => {
    const d = doc.data() || {};
    rows.push({ code: (d.code || doc.id), name: d.name || (d.code || doc.id), company: d.company || '', unit: d.unit || '' });
  });

  fillDirectoryUI(rows);
  updateRouteName();
  try{ localStorage.setItem(dirCacheKey(), JSON.stringify({ ts: Date.now(), rows })); }catch{}
  console.log('üìí Directory loaded from Firestore (force):', rows.length);
}

// === Typeahead: –ø—Ä–µ—Ñ—ñ–∫—Å–Ω–∏–π –∑–∞–ø–∏—Ç —É Firestore —ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–∫–∞–∑–æ–∫ ===

// —â–æ–± —É–Ω–∏–∫–∞—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è option —É <datalist>:
function _resetDatalistOptions(datalistId){
  const list = document.getElementById(datalistId);
  if (list) list.innerHTML = '';
}
function _appendDatalistOptions(rows, datalistId){
  const list = document.getElementById(datalistId);
  if (!list) return;
  for (const r of rows){
    // ‚ú≥Ô∏è –ú–ê–ü–ò ‚Äî –ù–ï —á–∏—Å—Ç–∏–º–æ, –ª–∏—à–µ –¥–æ–ø–∏—Å—É—î–º–æ (—â–æ–± –∑–±–µ—Ä—ñ–≥–∞–ª–∏—Å—å –∑–Ω–∞–π–¥–µ–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ)
    dirByCode[r.code] = { name:r.name, company:r.company||'', unit:r.unit||'' };
    codeByName[r.name] = r.code;

    const opt = document.createElement('option');
    opt.value = r.name;
    opt.label = [r.name, r.unit, r.company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
}

async function queryDirectoryPrefix(prefix, limit = 20){
  try{
    const p = String(prefix||'').trim();
    // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ –¥–ª—è –∑–≤–µ—Ä–Ω–µ–Ω—å –¥–æ Firestore ‚Äî 2 —Å–∏–º–≤–æ–ª–∏
    if (!p || p.length < 2) { _resetDatalistOptions('directoryList'); return; }

    const pLower = p.toLowerCase();
    const accRows = [];
    const seen = new Set();

    // 1) –∑–≤–∏—á–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å –ø–æ nameLower (—à–≤–∏–¥–∫–æ –π –¥–µ—à–µ–≤–æ)
    try{
      let q1 = db.collection('directory')
        .orderBy('nameLower')
        .startAt(pLower)
        .endBefore(pLower + '\uf8ff')
        .limit(limit);
        q1 = withHubFilter(q1, 'hub');  // üëà –¥–æ–¥–∞–ª–∏

      const s1 = await q1.get({ source:'default' });
      s1.forEach(doc => {
        if (accRows.length >= limit) return;
        if (seen.has(doc.id)) return;
        const d = doc.data() || {};
        accRows.push({
          code: (d.code || doc.id),
          name: d.name || (d.code || doc.id),
          company: d.company || '',
          unit: d.unit || ''
        });
        seen.add(doc.id);
      });
    } catch(_) { /* —ñ–≥–Ω–æ—Ä—É—î–º–æ, –ø—ñ–¥–µ–º–æ –Ω–∞ fallback */ }

    // 2) —è–∫—â–æ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ‚Äî fallback: "–º—ñ—Å—Ç–∏—Ç—å" —á–µ—Ä–µ–∑ nameNgrams (—Å—Ç—Ä–æ–≥—ñ—à–µ: –≤—ñ–¥ 4 —Å–∏–º–≤–æ–ª—ñ–≤)
if (accRows.length < limit && pLower.length >= 4){
  const grams = trigrams(pLower);
  if (grams.length){
    // –ù–µ –æ–±–º–µ–∂—É—î–º–æ hubsForLoop (–∑–∞ –≤–∏–º–æ–≥–æ—é) ‚Äî —Å–∫–∞–Ω—É—î–º–æ —É—Å—ñ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏
    const hubsForLoop = isAllHubs() ? [null] : ALLOWED_HUBS;
    for (const h of hubsForLoop){
      let q2 = db.collection('directory')
        .where('nameNgrams', 'array-contains-any', grams)
        .limit(limit);
      if (h) q2 = q2.where('hub','==', h);  // üëà —É–Ω–∏–∫–∞—î–º–æ IN + array-contains-any
      const s2 = await q2.get({ source:'default' });
      s2.forEach(doc => {
        if (accRows.length >= limit) return;
        if (seen.has(doc.id)) return;
        const d = doc.data() || {};
        accRows.push({
          code: (d.code || doc.id),
          name: d.name || (d.code || doc.id),
          company: d.company || '',
          unit: d.unit || ''
        });
        seen.add(doc.id);
      });
    }
    const score = (row) => {
      const n = (row.name || '').toLowerCase();
      const pos = n.indexOf(pLower);
      return (pos === -1 ? 1e6 : pos) * 1000 + n.length;
    };
    accRows.sort((a,b) => score(a) - score(b));
  }
}

    _resetDatalistOptions('directoryList');
    _appendDatalistOptions(accRows.slice(0, limit), 'directoryList');
  }catch(e){
    console.warn('queryDirectoryPrefix error:', e?.message || e);
  }
}

// Debounce –¥–ª—è —ñ–Ω–ø—É—Ç—ñ–≤
const _typeTimers = new Map();
function attachTypeahead(inputId){
  const el = document.getElementById(inputId);
  if (!el) return;
  el.addEventListener('input', ()=>{
    const prev = _typeTimers.get(inputId);
    if (prev) clearTimeout(prev);
    // –ó–±—ñ–ª—å—à—É—î–º–æ –¥–µ–±–∞—É–Ω—Å –¥–æ 600–º—Å, —â–æ–± –∑–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —á–∏—Ç–∞–Ω—å
    const t = setTimeout(()=> queryDirectoryPrefix(el.value, 20), 600);
    _typeTimers.set(inputId, t);
  });
}

/* ---- Logists ---- */
function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  Object.keys(logistById).forEach(k=> delete logistById[k]);
  Object.keys(logistIdByName).forEach(k=> delete logistIdByName[k]);

  rows.forEach(r=>{
    logistById[r.id] = r; logistIdByName[r.name] = r.id;
    const opt = document.createElement('option'); opt.value = r.name; list.appendChild(opt);
  });

  if (rows.length === 0) { console.warn('üë• Logists: –ø—É—Å—Ç–æ.'); }
}
async function loadLogists(allowServer=true){
  const msg = document.getElementById('logistsMsg');
  const showMsg = (t) => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };

  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if(raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){
        fillLogistsUI(rows); showMsg('');
        console.log('üë• Logists from cache:', rows.length);
        return;
      }
    }
    if (!allowServer) { showMsg('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }

    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'default' }); }
    catch (e) {
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))) {
        console.warn('permission-denied –¥–ª—è logists');
        showMsg('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.');
        return;
      }
      throw e;
    }

    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });

    rows = rows.filter(r=>r.active).sort((a,b)=> (a.sort-b.sort) || a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    showMsg('');
    console.log('üë• Logists loaded from Firestore:', rows.length);
  } catch (e) {
    console.error('‚ùå Logists load error:', e);
    showMsg('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.');
  }
}
function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if(!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const candidates = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (candidates.length === 1) return candidates[0][1];
  return null;
}
function getLogistNameById(id){ return (logistById[id]?.name) || ''; }

/* Helpers for route points */
function toObjPoints(arr) { return (arr || []).map(p => ({ lng: p[0], lat: p[1] })); }
function fromObjPoints(arr) { return (arr || []).map(p => [p.lng, p.lat]); }

function getCodeByInput(inputId) {
  const raw = document.getElementById(inputId).value;
  const name = raw.trim();
  if (!name) return null;
  if (codeByName[name]) return codeByName[name];
  const n = _norm(name);
  for (const [label, code] of Object.entries(codeByName)){ if (_norm(label) === n) return code; }
  const candidates = Object.entries(codeByName).filter(([label]) => _norm(label).includes(n));
  if (candidates.length === 1) return candidates[0][1];
  return null;
}
function makeDirLabelByCode(code){
  const d = dirByCode[code];
  if (!d) return '';
  return [d.name, d.unit, d.company].filter(Boolean).join(' ‚Ä¢ ');
}
function parseNameFromLabel(label){
  const s = String(label||'').split('‚Ä¢')[0].trim();
  return s || '';
}
function getNameByCode(code) { return (dirByCode[code]?.name) || ''; }

/* –ù–∞–∑–≤—É –±—É–¥—É—î–º–æ —Å—Ç—ñ–π–∫–æ ‚Äî –ø—Ä–∞—Ü—é—î —ñ –¥–ª—è code, —ñ –¥–ª—è key, —ñ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö label */
function prettyFromTo(data){
  // 1) –Ø–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏, –±–µ—Ä–µ–º–æ –ª–∏—à–µ ¬´–Ω–∞–∑–≤—É¬ª (–±–µ–∑ —é–Ω—ñ—Ç—ñ–≤/–∫–æ–º–ø–∞–Ω—ñ–π)
  if (data.fromLabel || data.toLabel){
    const f = parseNameFromLabel(data.fromLabel) || data.fromLabel || '';
    const t = parseNameFromLabel(data.toLabel)   || data.toLabel   || '';
    return [f, t];
  }
  // 2) –Ø–∫—â–æ —î –∫–æ–¥–∏ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –∫–æ—Ä–æ—Ç–∫—É –Ω–∞–∑–≤—É –∑ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ (–±–µ–∑ —é–Ω—ñ—Ç—ñ–≤/–∫–æ–º–ø–∞–Ω—ñ–π)
  if (data.fromCode || data.toCode){
    const f = getNameByCode(data.fromCode) || '';
    const t = getNameByCode(data.toCode)   || '';
    return [f, t];
  }
  // 3) –Ø–∫—â–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ ¬´–∫–ª—é—á—ñ¬ª ‚Äî –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –≤ –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
  if (data.fromKey || data.toKey){
    const fmt = k => String(k||'').split('|').map(s=>s.trim()).filter(Boolean)[0] || '';
    return [fmt(data.fromKey), fmt(data.toKey)];
  }
  return ['',''];
}
function formatRouteTitle(data) {
  const [fromL, toL] = prettyFromTo(data);
  const type = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
  const parts = [type]; if (data.purpose) parts.push(data.purpose);
  return `${fromL ? fromL : '‚Äî'} ‚Üí ${toL ? toL : '‚Äî'} [${parts.join(' ‚Ä¢ ')}]`;
}
function updateRouteName() {
  const fromCode = getCodeByInput('fromName');
  const toCode = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;
  const routePurpose = document.getElementById('routePurpose').value;
  if (!fromCode || !toCode) return;
  const fromLabel = makeDirLabelByCode(fromCode);
  const toLabel   = makeDirLabelByCode(toCode);
  const parts = [routeType]; if (routePurpose) parts.push(routePurpose);
  document.getElementById('routeName').value = `${fromLabel} ‚Üí ${toLabel} [${parts.join(' ‚Ä¢ ')}]`;
}

/* ===== DUPLICATES ===== */
function sanitizeId(s){ return String(s||'').replace(/[\/\\#?\[\]]/g,'_'); }
async function findExistingRoute(fromCode, toCode, routeType){
  try{
    let q = db.collection('routes');
    // –ó–∞—Å—Ç–æ—Å—É—î–º–æ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–æ —Ö–∞–±—É, —â–æ–± –Ω–µ —á—ñ–ø–∞—Ç–∏ —á—É–∂—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (–ø—Ä–∞–≤–∏–ª–∞ –º–æ–∂—É—Ç—å —Ä—ñ–∑–∞—Ç–∏ –¥–æ—Å—Ç—É–ø)
    if (typeof withHubFilter === 'function') q = withHubFilter(q, 'hub');
    const snap = await q
      .where('fromCode','==',fromCode).where('toCode','==',toCode).where('routeType','==',routeType)
      .limit(1).get();
    let found = null; snap.forEach(doc => { if (!found) found = doc; });
    return found;
  }catch(e){ console.warn('findExistingRoute error:', e?.message || e); return null; }
}

// –§–æ–ª–±–µ–∫: –ø–æ—à—É–∫ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –∑–∞ –ù–ê–ó–í–ê–ú–ò (—Å—Ç–∞–±—ñ–ª—å–Ω–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –∫–æ–¥—ñ–≤)
async function findExistingRouteByName(fromNameLower, toNameLower, routeType){
  const tryExact = async (fieldFrom, fieldTo) => {
    try{
      let q = db.collection('routes');
      if (typeof withHubFilter === 'function') q = withHubFilter(q, 'hub');
      const s = await q
        .where(fieldFrom,'==', fromNameLower)
        .where(fieldTo,  '==', toNameLower)
        .where('routeType','==', routeType)
        .limit(1).get({ source:'default' });
      let found = null; s.forEach(d => { if (!found) found = d; });
      if (found) return found;
    }catch(_){ /* —ñ–Ω–¥–µ–∫—Å–∞ –º–æ–∂–µ –Ω–µ –±—É—Ç–∏ ‚Äî —ñ–¥–µ–º–æ –¥–∞–ª—ñ */ }
    return null;
  };

  // 1) –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–æ –Ω–æ–≤–∏—Ö –ø–æ–ª—è—Ö (fromNameLower/toNameLower)
  let doc = await tryExact('fromNameLower','toNameLower');
  if (doc) return doc;
  // 2) –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–æ —ñ—Å–Ω—É—é—á–∏—Ö –ø–æ–ª—è—Ö –ª–µ–π–±–ª—ñ–≤ (fromLabelLower/toLabelLower)
  doc = await tryExact('fromLabelLower','toLabelLower');
  if (doc) return doc;

  // 3) –ë–µ–∑ —ñ–Ω–¥–µ–∫—Å—É: –æ–¥–Ω–æ–ø–æ–ª–µ–≤–∞ –≤–∏–±—ñ—Ä–∫–∞ + –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π —Ñ—ñ–ª—å—Ç—Ä
  try{
    let q = db.collection('routes');
    if (typeof withHubFilter === 'function') q = withHubFilter(q, 'hub');
    const s = await q.where('fromLabelLower','==', fromNameLower).limit(50).get({ source:'default' });
    let found = null;
    s.forEach(d => {
      if (found) return;
      const x = d.data() || {};
      if ((x.toLabelLower||'') === toNameLower && (x.routeType||'') === routeType) found = d;
    });
    if (found) return found;
  }catch(_){ }

  // 4) –©–µ –æ–¥–Ω–∞ —Å–ø—Ä–æ–±–∞ –∑ –ø–æ–ª—è–º–∏ nameLower (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —Å—Ç–∞—Ä–∏—Ö/–Ω–æ–≤–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤)
  try{
    let q = db.collection('routes');
    if (typeof withHubFilter === 'function') q = withHubFilter(q, 'hub');
    const s = await q.where('fromNameLower','==', fromNameLower).limit(50).get({ source:'default' });
    let found = null;
    s.forEach(d => {
      if (found) return;
      const x = d.data() || {};
      if ((x.toNameLower||'') === toNameLower && (x.routeType||'') === routeType) found = d;
    });
    if (found) return found;
  }catch(_){ }

  return null;
}
function makeCopyId(baseSafeId){ return `${baseSafeId}__${Date.now()}`; }

const $dupModal = document.getElementById('dupModal');
const $dupText = document.getElementById('dupText');
const $dupOverwrite = document.getElementById('dupOverwrite');
const $dupCopy = document.getElementById('dupCopy');
const $dupCancel = document.getElementById('dupCancel');

function askDuplicateAction(existingName){
  return new Promise((resolve)=>{
    $dupText.textContent = `–ú–∞—Ä—à—Ä—É—Ç —ñ–∑ —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∂–µ —ñ—Å–Ω—É—î:\n‚Äú${existingName}‚Äù.\n–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:`;
    $dupModal.classList.add('show');
    const onEsc = (e)=>{ if(e.key==='Escape'){ cleanup(); resolve('cancel'); } };
    function cleanup(){ document.removeEventListener('keydown', onEsc); $dupModal.classList.remove('show'); }
    $dupOverwrite.onclick = ()=>{ cleanup(); resolve('overwrite'); };
    $dupCopy.onclick = ()=>{ cleanup(); resolve('copy'); };
    $dupCancel.onclick = ()=>{ cleanup(); resolve('cancel'); };
    $dupModal.onclick = (e)=>{ if(e.target===$dupModal){ cleanup(); resolve('cancel'); } };
    document.addEventListener('keydown', onEsc, { once:false });
  });
}

/* ===== Local JSON save/load ===== */
const fileInput = document.getElementById('fileInput');

document.getElementById('saveRoute').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  const fromCode = getCodeByInput('fromName');
  const toCode   = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;
  const purpose   = document.getElementById('routePurpose').value;
  const hub = (document.getElementById('hubSelect').value || '').trim();
  const intermediateText = document.getElementById('intermediateText').value.trim();
  const logistId = getLogistIdByInput('logistInput');
  const logistName = logistId ? getLogistNameById(logistId) : '';

  const routeData = {
    name: (document.getElementById('routeName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∏'),
    fromCode, toCode, routeType, purpose, intermediateText,
    fromLabel: makeDirLabelByCode(fromCode),
    toLabel:   makeDirLabelByCode(toCode),
    points: toObjPoints(points),
    startRuler: toObjPoints(startRuler),
    endRuler: toObjPoints(endRuler),
    logisticId: logistId || null,
    logisticName: logistName || '',
    distance_km: getUIKm(),
    date: new Date().toISOString(),
	hub: hub || '' // üëà –¥–æ–¥–∞–Ω–æ
  };
  const blob = new Blob([JSON.stringify(routeData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const safe = String(routeData.name || 'route').replace(/[\/\\#?[\]:]/g,'_');
  a.href = url; a.download = `route_${safe}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
};

document.getElementById('loadRoute').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  fileInput.value = null; fileInput.click();
};
fileInput.onchange = (event) => {
  if (readOnly) return;
  const file = event.target.files && event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const raw = JSON.parse(e.target.result);

// 1) –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —ñ –æ–±'—î–∫—Ç–∞, —ñ –º–∞—Å–∏–≤—É –æ–±'—î–∫—Ç—ñ–≤
let routeData = Array.isArray(raw) ? raw[0] : raw;
if (Array.isArray(raw) && raw.length > 1) {
  console.warn('–£ —Ñ–∞–π–ª—ñ –∫—ñ–ª—å–∫–∞ –º–∞—Ä—à—Ä—É—Ç—ñ–≤, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é –ø–µ—Ä—à–∏–π —ñ–∑', raw.length);
  alert(`–£ —Ñ–∞–π–ª—ñ ${raw.length} –º–∞—Ä—à—Ä—É—Ç(–∏/—ñ–≤). –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –ø–µ—Ä—à–∏–π.`);
}
if (!routeData || typeof routeData !== 'object') {
  alert('–§–∞–π–ª –º–∞—î –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç'); return;
}

// 2) –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è points —É [lng, lat], –ø—ñ–¥—Å—Ç—Ä–∞—Ö–æ–≤—É—î–º–æ—Å—è –ø–æ —Ä—ñ–∑–Ω–∏—Ö –≤–∞—Ä—ñ–∞–Ω—Ç–∞—Ö
const arrFrom = (pts) => {
  if (!Array.isArray(pts)) return [];
  // [ [lng,lat], ... ]
  if (pts.length && Array.isArray(pts[0])) {
    return pts
      .map(p => [Number(p[0]), Number(p[1])])
      .filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));
  }
  // [ {lng,lat}, ... ]
  if (pts.length && typeof pts[0] === 'object') {
    return fromObjPoints(pts)
      .filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));
  }
  return [];
};

      points = arrFrom(routeData.points || []);
      startRuler = arrFrom(routeData.startRuler || []);
      endRuler = arrFrom(routeData.endRuler || []);

      const fCode = routeData.fromCode || null;
      const tCode = routeData.toCode   || null;
      if (fCode) document.getElementById('fromName').value = getNameByCode(fCode) || parseNameFromLabel(routeData.fromLabel);
      if (tCode) document.getElementById('toName').value   = getNameByCode(tCode) || parseNameFromLabel(routeData.toLabel);
      registerDirEntry(fCode, routeData.fromLabel || document.getElementById('fromName').value);
      registerDirEntry(tCode, routeData.toLabel   || document.getElementById('toName').value);
      if (routeData.routeType) document.getElementById('routeType').value = routeData.routeType;
      if (routeData.purpose)   document.getElementById('routePurpose').value = routeData.purpose;
      document.getElementById('intermediateText').value = routeData.intermediateText || '';
      document.getElementById('routeName').value = routeData.name || '';
	  if (routeData.hub) document.getElementById('hubSelect').value = routeData.hub;

	// ‚¨áÔ∏è –¥–æ–¥–∞–π
	updateHighlights();

      document.getElementById('logistInput').value =
        routeData.logisticName || (routeData.logisticId ? getLogistNameById(routeData.logisticId) : '');


      // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏ –ª—ñ–Ω—ñ–π–æ–∫ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      rebuildMarkers(); rebuildRulerMarkers(); drawRulers(); updateRoute();
      if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
      alert('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ —Ñ–∞–π–ª—É!');
    } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: ' + err.message); }
  };
  reader.readAsText(file);
};

/* ===== KML save/load ===== */
function kmlEsc(s){ return String(s||'').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
function kmlCoords(arr){ return (arr||[]).map(([lng,lat])=>`${lng},${lat},0`).join(' '); }
function buildCurrentRouteKml(){
  const name = (document.getElementById('routeName')?.value || '–ú–∞—Ä—à—Ä—É—Ç');
  const parts = [];
  parts.push('<?xml version="1.0" encoding="UTF-8"?>');
  parts.push('<kml xmlns="http://www.opengis.net/kml/2.2"><Document>');
  parts.push(`<name>${kmlEsc(name)}</name>`);
  // –æ—Å–Ω–æ–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç
  if (points.length >= 2){
    parts.push('<Placemark>');
    parts.push(`<name>${kmlEsc('Route')}</name>`);
    parts.push('<LineString><tessellate>1</tessellate><coordinates>');
    parts.push(kmlCoords(points));
    parts.push('</coordinates></LineString></Placemark>');
  }
  // –ª—ñ–Ω—ñ–π–∫–∏
  if (startRuler.length >= 2){
    parts.push('<Placemark>');
    parts.push('<name>Ruler start</name>');
    parts.push('<LineString><tessellate>1</tessellate><coordinates>');
    parts.push(kmlCoords(startRuler));
    parts.push('</coordinates></LineString></Placemark>');
  }
  if (endRuler.length >= 2){
    parts.push('<Placemark>');
    parts.push('<name>Ruler end</name>');
    parts.push('<LineString><tessellate>1</tessellate><coordinates>');
    parts.push(kmlCoords(endRuler));
    parts.push('</coordinates></LineString></Placemark>');
  }
  parts.push('</Document></kml>');
  return parts.join('');
}
document.getElementById('saveRouteKml').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  const kml = buildCurrentRouteKml();
  const safe = (document.getElementById('routeName')?.value || 'route').replace(/[\/:*?"<>|\[\]#]/g,'_');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([kml], { type:'application/vnd.google-earth.kml+xml' }));
  a.download = `route_${safe}.kml`;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 3000);
};

document.getElementById('loadRouteKml').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  const fi = document.getElementById('fileInputKml');
  fi.value = null; fi.click();
};

document.getElementById('fileInputKml').addEventListener('change', (ev)=>{
  if (readOnly) return;
  const file = ev.target.files && ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try{
      const xml = String(e.target.result || '');
      const doc = new DOMParser().parseFromString(xml, 'text/xml');
      const ls = doc.getElementsByTagName('LineString');
      const lines = [];
      for (let i=0;i<ls.length;i++){
        const coordsEl = ls[i].getElementsByTagName('coordinates')[0];
        const txt = coordsEl ? coordsEl.textContent : '';
        const nums = txt.trim().split(/[\s\n\r]+/).map(p=>p.trim()).filter(Boolean);
        const arr = [];
        for (const t of nums){
          const parts = t.split(',').map(Number);
          if (parts.length>=2 && isFinite(parts[0]) && isFinite(parts[1])) arr.push([parts[0], parts[1]]);
        }
        if (arr.length>=2) lines.push(arr);
      }
      if (!lines.length){ alert('KML –Ω–µ –º—ñ—Å—Ç–∏—Ç—å LineString –∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.'); return; }
      // –≥–æ–ª–æ–≤–Ω–∞ –ª—ñ–Ω—ñ—è ‚Äî –ø–µ—Ä—à–∞; –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤ –ª—ñ–Ω—ñ–π–∫–∏
      points = lines[0];
      startRuler = lines[1] || [];
      endRuler   = lines[2] || [];
      rebuildMarkers(); rebuildRulerMarkers(); drawRulers(); updateRoute();
      alert('KML –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.');
    }catch(err){ alert('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è KML: ' + (err?.message || err)); }
  };
  reader.readAsText(file);
});

/* ================= NEW routeKey helpers ================= */
function firstLetter(str){
  const s = String(str || '').trim();
  if (!s) return 'X';
  const re = /[A-Za-z–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–Ñ—î“ê“ë]/u;
  for (const ch of s){
    if (re.test(ch)) return ch.toUpperCase();
  }
  return 'X';
}
function randomDigits(len=10){
  const a = new Uint32Array(len);
  (crypto && crypto.getRandomValues) ? crypto.getRandomValues(a) : a.fill(Math.floor(Math.random()*10));
  return Array.from(a, n => (n % 10).toString()).join('');
}
async function reserveKeyTx(tx, prefix, docId, meta){
  for (let tries = 0; tries < 10; tries++){
    const key = `${prefix}-${randomDigits(10)}`;
    const keyRef = db.collection('routeKeys').doc(key);
    const snap = await tx.get(keyRef);
    if (!snap.exists){
      tx.set(keyRef, {
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        routeId: docId,
        fromCode: meta.fromCode, toCode: meta.toCode,
        fromName: meta.fromName, toName: meta.toName
      });
      return key;
    }
  }
  throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É (—Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑).');
}

/* ===== Firestore: save/list/load/delete ===== */
async function saveToDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
    if (points.length === 0 && startRuler.length === 0 && endRuler.length === 0) {
      alert('–ù–µ–º–∞—î —â–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏'); return;
    }

    const fromCode = getCodeByInput('fromName');
    const toCode   = getCodeByInput('toName');
    const routeType = document.getElementById('routeType').value;
    const purpose   = document.getElementById('routePurpose').value;
    const intermediateText = document.getElementById('intermediateText').value.trim();
    const hub = (document.getElementById('hubSelect').value || '').trim();

    if (!hub && !isAllHubs()) {
      alert('–û–±–µ—Ä—ñ—Ç—å —Ö–∞–± (–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ).'); return;
    }
    if (!userAllowsHub(hub)) {
      alert('‚õî –í–∏ –Ω–µ –º–∞—î—Ç–µ –ø—Ä–∞–≤–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –¥–ª—è —Ö–∞–±—É: ' + hub); return;
    }

    const logistId = getLogistIdByInput('logistInput');
    if (!fromCode || !toCode) {
      alert('–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äú–í—ñ–¥‚Äù —Ç–∞ ‚Äú–î–æ‚Äù –∑—ñ —Å–ø–∏—Å–∫—É –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.'); return;
    }
    if (!logistId) {
      alert('–û–±–µ—Ä—ñ—Ç—å –ª–æ–≥—ñ—Å—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É.'); return;
    }

  const from = dirByCode[fromCode] || {};
  const to   = dirByCode[toCode]   || {};
    const fromLabel = makeDirLabelByCode(fromCode);
    const toLabel   = makeDirLabelByCode(toCode);
  // –°—Ç–∞–±—ñ–ª—å–Ω–∞ –ø—Ä–∏–≤'—è–∑–∫–∞ –∑–∞ –ù–ê–ó–í–û–Æ: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∏—Å—Ç—ñ –Ω–∞–∑–≤–∏ (–±–µ–∑ —é–Ω—ñ—Ç—ñ–≤/–∫–æ–º–ø–∞–Ω—ñ–π)
  const fromNameInput = (getPureNameFromInput && getPureNameFromInput('fromName')) || '';
  const toNameInput   = (getPureNameFromInput && getPureNameFromInput('toName'))   || '';
  const fromNamePlain = (from.name || '').trim() || String(fromNameInput||'').trim();
  const toNamePlain   = (to.name   || '').trim() || String(toNameInput||'').trim();

    const generatedName = `${fromLabel} ‚Üí ${toLabel} [${routeType}${purpose ? ' ‚Ä¢ '+purpose : ''}]`;
    const manual = (document.getElementById('routeName').value || '').trim();
    const finalName = manual || generatedName;

    const user = auth?.currentUser || null;

    const payload = {
  name: finalName,
  fromCode, toCode, routeType, purpose, intermediateText,
  fromLabel, toLabel,
  fromName: fromNamePlain,
  toName:   toNamePlain,
  points: toObjPoints(points),
  startRuler: toObjPoints(startRuler),
  endRuler: toObjPoints(endRuler),
  logisticId: logistId,          // ‚úÖ –∫–ª—é—á —É –ë–î –ª–∏—à–∞—î—Ç—å—Å—è logisticId, –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äî –∑–º—ñ–Ω–Ω–∞ logistId
  logisticName: getLogistNameById(logistId),
  createdByUid: user?.uid || null,
  createdByEmail: user?.email || null,
  distance_km: getUIKm(),
  updatedAt: new Date().toISOString(),
  hub: hub || null
};
    // –ü–æ–ª–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (–¥–ª—è soft-delete). –Ø–∫—â–æ —ñ—Å–Ω—É—é—á–∏–π (overwrite) –±—É–≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–º ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å.
    try { if (existing) { payload.isActive = (existing.data()?.isActive === false ? false : true); } else { payload.isActive = true; } } catch(_){ payload.isActive = true; }

    // üß† –Ü–ù–î–ï–ö–°–ù–Ü –ü–û–õ–Ø –†–ê–•–£–Ñ–ú–û –û–î–ò–ù –†–ê–ó (–ø–æ–∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—î—é)
    const searchText = [finalName, fromLabel, toLabel].filter(Boolean).join(' | ');
    const indexFields = {
      nameLower:      (finalName || '').toLowerCase(),
      fromLabelLower: (fromLabel || '').toLowerCase(),
      toLabelLower:   (toLabel   || '').toLowerCase(),
      fromNameLower:  (fromNamePlain || '').toLowerCase(),
      toNameLower:    (toNamePlain   || '').toLowerCase(),
      nameNgrams:     trigrams(finalName),
      fromNgrams:     trigrams(fromLabel),
      toNgrams:       trigrams(toLabel),
      searchNgrams:   trigrams(searchText),
      updatedAt:      new Date().toISOString()
    };

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—è
    let existing = await findExistingRoute(fromCode, toCode, routeType);
    if (!existing){
      const fLowerFB = (fromNamePlain || '').toLowerCase();
      const tLowerFB = (toNamePlain   || '').toLowerCase();
      if (fLowerFB && tLowerFB){
        existing = await findExistingRouteByName(fLowerFB, tLowerFB, routeType);
      }
    }
    const baseId = sanitizeId(finalName);
    let docId = baseId;
    let mode = 'new'; // 'new' | 'overwrite' | 'copy'

    if (existing) {
      const existingName = existing.data()?.name || existing.id;
      const choice = await askDuplicateAction(existingName);
      if (choice === 'cancel'){ alert('‚ùé –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ'); return; }
      if (choice === 'overwrite'){ docId = existing.id; mode = 'overwrite'; }
      if (choice === 'copy'){ docId = `${baseId}__${Date.now()}`; payload.name = `${payload.name} (–∫–æ–ø—ñ—è)`; mode = 'copy'; }
    }

    const prefix = firstLetter(from.name) + firstLetter(to.name);
    const meta = { fromCode, toCode, fromName: from.name || '', toName: to.name || '' };

    let routeKeySaved = null;
    let savedApproval = null;

    if (userCanReserveRouteKeys()){
      // üßæ –¢–†–ê–ù–ó–ê–ö–¶–Ü–Ø: –∞–¥–º—ñ–Ω/–°–ë ‚Äî —Ä–µ–∑–µ—Ä–≤—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á —É routeKeys
      try {
        await db.runTransaction(async (tx) => {
          const routeRef  = db.collection('routes').doc(docId);
          const routeSnap = await tx.get(routeRef);

          // routeKey
          let routeKey = null;
          if (mode === 'overwrite' && routeSnap.exists && routeSnap.data()?.routeKey){
            routeKey = String(routeSnap.data().routeKey);
            const keyRef = db.collection('routeKeys').doc(routeKey);
            await tx.get(keyRef); // —â–æ–± –Ω–µ –≤–ø–∞—Å—Ç–∏ –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ
            tx.set(keyRef, {
              routeId: docId,
              updatedAt: new Date().toISOString(),
              fromCode, toCode,
              fromName: meta.fromName, toName: meta.toName
            }, { merge:true });
          } else {
            routeKey = await reserveKeyTx(tx, prefix, docId, meta);
          }

          // –Ü–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –∑–º—ñ–Ω–∏–≤—Å—è –∫—ñ–ª–æ–º–µ—Ç—Ä–∞–∂ —ñ –±—É–ª–æ approved
          let approvalUpdate = null;
          const prev = routeSnap.exists ? routeSnap.data() : null;
          if (prev && prev.approval?.status === 'approved'){
            const oldDist = (typeof prev.distance_km === 'number') ? prev.distance_km : null;
            const newDist = payload.distance_km;
            if (oldDist !== null && Math.abs(newDist - oldDist) > 0.01){
              const rev = (prev.approval.revision || 0) + 1;
              approvalUpdate = {
                status: 'draft',
                revision: rev,
                comment: `–í—ñ–¥—Å—Ç–∞–Ω—å –∑–º—ñ–Ω–µ–Ω–∞: –±—É–ª–æ ${oldDist.toFixed(2)} –∫–º ‚Üí —Å—Ç–∞–ª–æ ${newDist.toFixed(2)} –∫–º`,
                submittedAt: null, submittedByUid: null, submittedByEmail: null,
                decidedByUid: null, decidedByEmail: null, decisionAt: null
              };
            }
          }

          const updateObj = {
            ...payload,
            ...indexFields,
            routeKey
          };
          if (approvalUpdate){
            updateObj.approval = approvalUpdate;
            savedApproval = approvalUpdate;
          } else {
            savedApproval = prev?.approval || null;
          }

          tx.set(routeRef, updateObj, { merge: true });
          routeKeySaved = routeKey;
        });

        alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ë–î: ${payload.name}\n–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ${routeKeySaved}`);
        try{
          const prevTrack = pickTrackedFields(prev || {});
          const nextTrack = pickTrackedFields({ ...payload, ...indexFields, routeKey: routeKeySaved });
          const changes = diffFields(prevTrack, nextTrack).filter(c => c.field !== 'updatedAt');
          const summary = buildChangeSummary(changes);
          const summaryShort = buildShortSummary(changes);
          await clientWriteRouteLog(docId, 'updated', { routeKey: routeKeySaved, distance_km: payload.distance_km, approvalStatus: savedApproval?.status || null, changes, summary, summaryShort, via:'client' });
        }catch(_){ }
      } catch (txErr) {
        // Fallback –¥–ª—è –∞–¥–º—ñ–Ω–∞: —è–∫—â–æ –∫–ª—é—á –Ω–µ –∑–∞—Ä–µ–∑–µ—Ä–≤—É–≤–∞–≤—Å—è, –≤—Å–µ –æ–¥–Ω–æ –∑–±–µ—Ä–µ–∂–µ–º–æ –±–µ–∑ –Ω—å–æ–≥–æ
        console.warn('–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è (routeKeys) –Ω–µ –≤–¥–∞–ª–∞—Å—è:', txErr?.code || txErr, txErr?.message);
        await db.collection('routes').doc(docId).set(
          { ...payload, ...indexFields },
          { merge: true }
        );
        alert('‚ö†Ô∏è –ó–±–µ—Ä–µ–∂–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç –ë–ï–ó –∫–æ–¥—É (routeKey).\n–ü—Ä–∏—á–∏–Ω–∞: ' + (txErr?.message || txErr));
      }
    } else {
      // –õ–æ–≥—ñ—Å—Ç–∏ —Ç–∞ —ñ–Ω—à—ñ: –Ω–µ —Ç–æ—Ä–∫–∞—î–º–æ—Å—å routeKeys (—á–∞—Å—Ç–æ –Ω–µ–º–∞—î –ø—Ä–∞–≤). –ì–µ–Ω–µ—Ä—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π routeKey.
      // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ –î–û —Å–ø—Ä–æ–±–∏ –∑–∞–ø–∏—Å—É, —â–æ–± —É catch –º–∞—Ç–∏ –≥–æ—Ç–æ–≤–∏–π payload –¥–ª—è —Ñ–æ–ª–±–µ–∫—É.
      const routeRef  = db.collection('routes').doc(docId);
      let prev = null;
      try{
        const prevSnap = await routeRef.get();
        prev = prevSnap.exists ? (prevSnap.data() || null) : null;
      }catch(prevErr){
        console.warn('read prev route failed (will continue with fallback if needed):', prevErr?.message || prevErr);
        prev = null;
      }
      let keepKey = prev && prev.routeKey ? String(prev.routeKey) : null;
      const localKey = keepKey || (prefix + '-' + randomDigits(10));

      // –Ü–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –∑–º—ñ–Ω–µ–Ω–∞
      let approvalUpdate = null;
  // prev –≤–∏–∑–Ω–∞—á–µ–Ω–æ –≤–∏—â–µ —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ –º–æ–∂–µ –±—É—Ç–∏ null
      if (prev && prev.approval?.status === 'approved'){
        const oldDist = (typeof prev.distance_km === 'number') ? prev.distance_km : null;
        const newDist = payload.distance_km;
        if (oldDist !== null && Math.abs(newDist - oldDist) > 0.01){
          const rev = (prev.approval.revision || 0) + 1;
          approvalUpdate = {
            status: 'draft',
            revision: rev,
            comment: `–í—ñ–¥—Å—Ç–∞–Ω—å –∑–º—ñ–Ω–µ–Ω–∞: –±—É–ª–æ ${oldDist?.toFixed ? oldDist.toFixed(2) : oldDist} –∫–º ‚Üí —Å—Ç–∞–ª–æ ${newDist?.toFixed ? newDist.toFixed(2) : newDist} –∫–º`,
            submittedAt: null, submittedByUid: null, submittedByEmail: null,
            decidedByUid: null, decidedByEmail: null, decisionAt: null
          };
        }
      }

      const updateObj = {
        ...payload,
        ...indexFields,
        routeKey: localKey
      };
      if (approvalUpdate){
        updateObj.approval = approvalUpdate;
        savedApproval = approvalUpdate;
      } else {
        savedApproval = prev?.approval || null;
      }

      try {
        await routeRef.set(updateObj, { merge: true });
        routeKeySaved = localKey;
        alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ë–î: ${payload.name}\n–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ${routeKeySaved}`);
        try{
          const prevTrack = pickTrackedFields(prev || {});
          const nextTrack = pickTrackedFields(updateObj || {});
          const changes = diffFields(prevTrack, nextTrack).filter(c => c.field !== 'updatedAt');
          const summary = buildChangeSummary(changes);
          const summaryShort = buildShortSummary(changes);
          await clientWriteRouteLog(docId, 'updated', { routeKey: routeKeySaved, distance_km: updateObj.distance_km, approvalStatus: savedApproval?.status || null, changes, summary, summaryShort, via:'client' });
        }catch(_){ }
      } catch (errNonAdmin) {
        console.error('save (no routeKeys) failed:', errNonAdmin);
        // Fallback: server-side save via Cloud Function for permission issues
        if (errNonAdmin && (errNonAdmin.code === 'permission-denied' || /insufficient permissions/i.test(String(errNonAdmin.message||'')))){
          try{
            await saveRouteViaFunction(docId, updateObj);
            routeKeySaved = updateObj.routeKey;
            alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä: ${payload.name}\n–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ${routeKeySaved}`);
            try{
              const prevTrack = pickTrackedFields(prev || {});
              const nextTrack = pickTrackedFields(updateObj || {});
              const changes = diffFields(prevTrack, nextTrack).filter(c => c.field !== 'updatedAt');
              const summary = buildChangeSummary(changes);
              const summaryShort = buildShortSummary(changes);
              await clientWriteRouteLog(docId, 'updated', { routeKey: routeKeySaved, distance_km: updateObj.distance_km, approvalStatus: savedApproval?.status || null, changes, summary, summaryShort, via:'client-fallback' });
            }catch(_){ }
          }catch(fnErr){
            console.error('saveRoute function failed:', fnErr);
            throw fnErr;
          }
        } else {
          throw errNonAdmin;
        }
      }
    }

    // ‚§¥Ô∏è –ü–Ü–°–õ–Ø –ó–ê–ü–ò–°–£ ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ UI/—Å–ø–∏—Å–æ–∫
    setApprovalUI(savedApproval);
    // –õ–æ–∫–∞–ª—å–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ/select –±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∑ –ë–î, —â–æ–± –Ω–µ –≤–∏—Ç—Ä–∞—á–∞—Ç–∏ —Ä—ñ–¥–∏
    ensureRouteOptionSelected(docId, { ...payload, approval: savedApproval });

  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore:', err);
    // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ñ–æ–ª–±–µ–∫ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ä—ñ–≤–Ω—è: —è–∫—â–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏ ‚Äî —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –∑–∞–ø–∏—Å
    const msg = String(err?.message || '');
    const code = String(err?.code || '');
    if (code === 'permission-denied' || /insufficient permissions/i.test(msg)){
      try{
        // –Ø–∫—â–æ –ª–æ–∫–∞–ª—å–Ω–∏–π updateObj –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É —Ü—ñ–π –æ–±–ª–∞—Å—Ç—ñ, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –Ω–∞–±—ñ—Ä
        // (routeKey —Å–µ—Ä–≤–µ—Ä –∑–≥–µ–Ω–µ—Ä—É—î –∑–∞ –ø–æ—Ç—Ä–µ–±–∏)
        const dataForFn = { ...payload, ...indexFields };
        if (!dataForFn.updatedAt) dataForFn.updatedAt = new Date().toISOString();
        await saveRouteViaFunction(docId, dataForFn);
        setApprovalUI(savedApproval);
        ensureRouteOptionSelected(docId, { ...payload, approval: savedApproval });
        alert('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä.');
        try{
          const prevTrack = pickTrackedFields(prev || {});
          const nextTrack = pickTrackedFields(dataForFn || {});
          const changes = diffFields(prevTrack, nextTrack).filter(c => c.field !== 'updatedAt');
          const summary = buildChangeSummary(changes);
          const summaryShort = buildShortSummary(changes);
          await clientWriteRouteLog(docId, 'updated', { routeKey: dataForFn.routeKey || null, distance_km: dataForFn.distance_km, approvalStatus: savedApproval?.status || null, changes, summary, summaryShort, via:'client-top-fallback' });
        }catch(_){ }
        return;
      }catch(fnErr){
        console.error('Top-level fallback save failed:', fnErr);
      }
    }
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î: ' + (err?.message || err));
  }
}
// ---- Server-side fallback (HTTPS Cloud Function) ----
async function saveRouteViaFunction(docId, data){
  const url = '/api/routes/save';
  const token = await auth.currentUser.getIdToken();
  const r = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ id: docId, data })
  });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || !j || j.ok !== true){
    throw new Error((j && j.error) || ('HTTP ' + r.status));
  }
  // sync possibly generated routeKey back
  if (j.routeKey && (!data.routeKey || data.routeKey !== j.routeKey)){
    data.routeKey = j.routeKey;
  }
}

// ---- Lightweight client-side route_logs writer (Spark safe) ----
async function clientWriteRouteLog(routeId, type, extra){
  if (!db) return;
  const payload = Object.assign({
    routeId,
    type: type || 'updated',
    ts: new Date().toISOString(),
    actor: {
      updatedByUid: auth?.currentUser?.uid || null,
      updatedByEmail: auth?.currentUser?.email || null
    }
  }, extra || {});
  try{ await db.collection('route_logs').add(payload); }
  catch(e){
    try{ console.warn('route_logs write failed:', e?.code || '', e?.message || e); }catch(_){ }
  }
}

// ---- Helpers to build readable change logs on Spark ----
function pickTrackedFields(d){
  d = d || {};
  return {
    routeKey: d.routeKey || '',
    hub: d.hub || '',
    fromCode: d.fromCode || '',
    toCode: d.toCode || '',
    fromName: d.fromName || d.fromLabel || '',
    toName: d.toName || d.toLabel || '',
    routeType: d.routeType || '',
    distance_km: (typeof d.distance_km === 'number') ? d.distance_km : null,
    logisticName: d.logisticName || '',
    logisticId: d.logisticId || '',
    approvalStatus: (d.approval && (d.approval.status ?? d.approval.result ?? d.approval.decision)) || d.approvalStatus || d.approved || d.status || '',
    updatedAt: d.updatedAt || null
  };
}
function diffFields(prev, next){
  const changes = [];
  const keys = new Set([...Object.keys(prev||{}), ...Object.keys(next||{})]);
  const pretty = v => (typeof v === 'number' && Number.isFinite(v)) ? v : (v ?? '');
  for (const k of keys){
    const was = prev ? prev[k] : undefined;
    const now = next ? next[k] : undefined;
    const eq = (was === now) || (was == null && now == null);
    if (!eq) changes.push({ field:k, was: pretty(was), now: pretty(now) });
  }
  return changes;
}
function buildChangeSummary(changes){
  if (!Array.isArray(changes) || !changes.length) return '';
  const important = ['distance_km','routeType','approvalStatus','hub','fromCode','toCode','fromName','toName','routeKey','logisticName'];
  const labels = {
    distance_km: '–í—ñ–¥—Å—Ç–∞–Ω—å',
    routeType: '–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç—É',
    approvalStatus: '–°—Ç–∞—Ç—É—Å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è',
    hub: '–•–∞–±',
    fromCode: '–ö–æ–¥ ¬´–∑¬ª',
    toCode: '–ö–æ–¥ ¬´–¥–æ¬ª',
    fromName: '–ù–∞–∑–≤–∞ ¬´–∑¬ª',
    toName: '–ù–∞–∑–≤–∞ ¬´–¥–æ¬ª',
    routeKey: '–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É',
    logisticName: '–õ–æ–≥—ñ—Å—Ç',
    logisticId: 'ID –ª–æ–≥—ñ—Å—Ç–∞'
  };
  const fmt = (field, v) => {
    if (v === undefined || v === null || v === '') return '‚Äî';
    if (field === 'distance_km' && typeof v === 'number' && Number.isFinite(v)) return v.toFixed(2) + ' –∫–º';
    return String(v);
  };
  const items = changes
    .slice()
    .sort((a,b)=> (important.indexOf(a.field) === -1 ? 999 : important.indexOf(a.field)) - (important.indexOf(b.field) === -1 ? 999 : important.indexOf(b.field)))
    .map(c => {
      const label = labels[c.field] || c.field;
      const was = fmt(c.field, c.was);
      const now = fmt(c.field, c.now);
      if (c.field === 'distance_km') return `–ó–º—ñ–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ: –±—É–ª–æ ${was} ‚Üí —Å—Ç–∞–ª–æ ${now}`;
      return `${label}: –±—É–ª–æ ${was} ‚Üí —Å—Ç–∞–ª–æ ${now}`;
    });
  return items.join('; ');
}

// –ö–æ—Ä–æ—Ç–∫–∏–π –ø—ñ–¥—Å—É–º–æ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ: —è–∫—â–æ —î –∑–º—ñ–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ª–∏—à–µ —ó—ó, —ñ–Ω–∞–∫—à–µ –ø–µ—Ä—à–∏–π —Å—É—Ç—Ç—î–≤–∏–π –ø—É–Ω–∫—Ç
function buildShortSummary(changes){
  if (!Array.isArray(changes) || !changes.length) return '';
  const fmtKm = v => (typeof v === 'number' && Number.isFinite(v)) ? v.toFixed(2) + ' –∫–º' : '‚Äî';
  const dist = changes.find(c => c.field === 'distance_km');
  if (dist){
    const was = fmtKm(dist.was);
    const now = fmtKm(dist.now);
    return `–ó–º—ñ–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ: –±—É–ª–æ ${was} ‚Üí —Å—Ç–∞–ª–æ ${now}`;
  }
  // —ñ–Ω–∞–∫—à–µ –ø–µ—Ä—à–∏–π –µ–ª–µ–º–µ–Ω—Ç —É —Å—Ç–∏–ª—ñ ¬´–±—É–ª–æ ‚Üí —Å—Ç–∞–ª–æ¬ª
  const c = changes[0];
  const was = (c.was === undefined || c.was === null || c.was === '') ? '‚Äî' : String(c.was);
  const now = (c.now === undefined || c.now === null || c.now === '') ? '‚Äî' : String(c.now);
  const label = c.field;
  return `${label}: –±—É–ª–æ ${was} ‚Üí —Å—Ç–∞–ª–æ ${now}`;
}

let isRefreshingRoutes = false;
let routesPageLastDoc = null;   // –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
let routesDone = false;         // —á–∏ –≤—Å–µ –¥–æ–≥—Ä—É–∑–∏–ª–∏
let routesLoadedCount = 0;      // —Å–∫—ñ–ª—å–∫–∏ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –Ω–∞ –∫–ª—ñ—î–Ω—Ç
let routesInitLoaded = false;
async function ensureRoutesLoaded(){
  if (routesInitLoaded) return;
  routesInitLoaded = true;
  await refreshRoutesList('reset');
}

function renderRoutesDocs(docs){
  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');
  const popup = document.getElementById('routesPopup');
  // store current search results for single-form selection
  window.currentSearchResults = window.currentSearchResults || [];
  const currentResults = [];

  if (sel.options.length === 0) {
    sel.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
  }

  const clip = (s, n=80) => {
    const str = String(s||'');
    return str.length > n ? (str.slice(0, n-1) + '‚Ä¶') : str;
  };

  docs.forEach(doc=>{
    const d = doc.data() || {};
    const km = (typeof d.distance_km === 'number') ? ` (${d.distance_km.toFixed(2)} –∫–º)` : '';
    const labelNow = formatRouteTitle(d);
    const label = labelNow + km;

    // —É–Ω–∏–∫–∞—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
    if (routesLookup[label]) return;
    routesLookup[label] = doc.id;

  const opt = document.createElement('option');
  opt.value = doc.id;
  opt.textContent = clip(label, 80);
  opt.title = label; // –ø–æ–≤–Ω–∏–π –ø—ñ–¥–ø–∏—Å —É –ø—ñ–¥–∫–∞–∑—Ü—ñ
    sel.appendChild(opt);

  // –†–∞–Ω—ñ—à–µ –¥—É–±–ª—é–≤–∞–ª–∏ —É datalist. –í–∏–º–∫–Ω–µ–Ω–æ, —â–æ–± –Ω–µ –∑ º—è–≤–ª—è–≤—Å—è –Ω–∞—Ç–∏–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–≤–µ—Ä—Ö –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ø–∞–ø—É.
  // const sOpt = document.createElement('option');
  // sOpt.value = label; list && list.appendChild(sOpt);
    // collect results for single-form use
    currentResults.push({ id: doc.id, label, data: d });
  });

  // update global search results
  window.currentSearchResults = currentResults;
  routesLoadedCount = Object.keys(routesLookup).length;

  // üîΩ –ó–∞–ø–æ–≤–Ω—é—î–º–æ –∫–∞—Å—Ç–æ–º–Ω–∏–π –ø–æ–ø–∞–ø –ø—ñ–¥–∫–∞–∑–æ–∫ (—ñ–∑ —Ç—É–ª—Ç—ñ–ø–∞–º–∏)
  try {
    if (!popup) return;
    if (!currentResults.length) { popup.style.display = 'none'; popup.innerHTML = ''; return; }
    popup.innerHTML = '';
    const frag = document.createDocumentFragment();
    currentResults.forEach(r => {
      const item = document.createElement('div');
      item.textContent = r.label;
      item.title = r.label; // –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç —É —Ç—É–ª—Ç—ñ–ø—ñ
      item.setAttribute('data-id', r.id);
      item.style.padding = '6px 10px';
      item.style.cursor = 'pointer';
      item.style.whiteSpace = 'nowrap';
      item.style.overflow = 'hidden';
      item.style.textOverflow = 'ellipsis';
      item.addEventListener('mouseenter', () => { item.style.background = '#f2f6ff'; });
      item.addEventListener('mouseleave', () => { item.style.background = 'transparent'; });
      item.addEventListener('mousedown', (ev) => {
        ev.preventDefault();
        // –í–∏–±–∏—Ä–∞—î–º–æ –º–∞—Ä—à—Ä—É—Ç, –∞–ª–µ –ù–ï –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
        sel.value = r.id;
        const input = document.getElementById('routeSearch');
        if (input) input.value = r.label;
        // —Å—Ö–æ–≤–∞—Ç–∏ –ø–æ–ø–∞–ø –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É
        popup.style.display = 'none';
      });
      frag.appendChild(item);
    });
    // –ø–µ—Ä–µ–Ω–µ—Å–µ–º–æ –ø–æ–ø–∞–ø —É body (–ø–æ—Ä—Ç–∞–ª) —Ç–∞ —Å–ø–æ–∑–∏—Ü—ñ–æ–Ω—É—î–º–æ –ø—ñ–¥ —ñ–Ω–ø—É—Ç
    const bodyPopup = (function(){
      if (popup.parentElement !== document.body) {
        try { document.body.appendChild(popup); } catch(_) {}
      }
      return popup;
    })();
    bodyPopup.appendChild(frag);
    // –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–∏—Å–æ–∫ –ª–∏—à–µ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É —Ñ–æ–∫—É—Å—ñ –ø–æ–ª—è –ø–æ—à—É–∫—É –∞–±–æ –≤–∂–µ —â–æ—Å—å –≤–≤—ñ–≤
    const input = document.getElementById('routeSearch');
    const hasFocus = (document.activeElement === input);
    const hasQuery = (input && input.value && input.value.trim().length > 0);
    if (hasFocus || hasQuery){
      positionRoutesPopup();
      bodyPopup.style.display = 'block';
    } else {
      bodyPopup.style.display = 'none';
    }
  } catch(_) {}
}
// –î–æ–¥–∞—î/–æ–Ω–æ–≤–ª—é—î –æ–ø—Ü—ñ—é —É <select id="remoteRoutes"> —ñ –æ–¥—Ä–∞–∑—É —ó—ó –æ–±–∏—Ä–∞—î.
// –¢–∞–∫–æ–∂ –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ –º–∞—Ä—à—Ä—É—Ç —É LAST_SAVED_ROUTE —Ç–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª—é—î–º–æ –ª—ñ–Ω–∫ "–ü–µ—Ä–µ–≥–ª—è–¥".
function ensureRouteOptionSelected(id, data){
  if (!id) return;
  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');

  // –ü—ñ–¥–ø–∏—Å –¥–ª—è –æ–ø—Ü—ñ—ó
  const label = formatRouteTitle(data) + (typeof data.distance_km === 'number' ? ` (${data.distance_km.toFixed(2)} –∫–º)` : '');
  const clip = (s, n=80) => String(s||'').length > n ? (String(s).slice(0,n-1) + '‚Ä¶') : String(s||'');

  // –Ø–∫—â–æ —Ç–∞–∫–æ—ó –æ–ø—Ü—ñ—ó –Ω–µ–º–∞—î ‚Äî –¥–æ–¥–∞—î–º–æ; —è–∫—â–æ —î ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç
  let opt = [...sel.options].find(o => o.value === id);
  if (!opt) {
    opt = document.createElement('option');
    opt.value = id;
    opt.textContent = clip(label, 80);
    opt.title = label;
    sel.appendChild(opt);
  } else {
    opt.textContent = clip(label, 80);
    opt.title = label;
  }

  // –ë—ñ–ª—å—à–µ –Ω–µ –¥–æ–¥–∞—î–º–æ –≤ datalist (—â–æ–± –Ω–µ –Ω–∞–∫–ª–∞–¥–∞–≤—Å—è –Ω–∞—Ç–∏–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–∏–π –ø–æ–ø–∞–ø)

  // –û–±—Ä–∞—Ç–∏ —â–æ–π–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π
  sel.value = id;

  // –ó–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π
  LAST_SAVED_ROUTE = { id, label, data };
  try { window.__currentRouteActive = (data && data.isActive === false) ? false : true; } catch(_){}

  // –û–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–≥–ª—è–¥" —É –ø–∞–Ω–µ–ª—ñ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
  const open = document.getElementById('openReviewLink');
  if (open) {
    open.style.display = 'inline-block';
    open.href = reviewLinkForId(id);
  }
}

async function refreshRoutesList(mode='reset'){
  if (!db || isRefreshingRoutes) return;
  isRefreshingRoutes = true;

  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');

  if (mode === 'reset'){
    routesPageLastDoc = null;
    routesDone = false;
    for (const k in routesLookup) delete routesLookup[k];
    sel.innerHTML  = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
    list.innerHTML = '';
  }
  if (routesDone){ isRefreshingRoutes = false; return; }

  const pageSize = 100; // —Å–∫—ñ–ª—å–∫–∏ –ø—ñ–¥—Ç—è–≥—É–≤–∞—Ç–∏ –∑–∞ —Ä–∞–∑
  let q = db.collection('routes');
  // –ü–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –∞–∫—Ç–∏–≤–Ω—ñ –¥–ª—è –Ω–µ-–∞–¥–º—ñ–Ω—ñ–≤. –ê–¥–º—ñ–Ω/–°–ë –±–∞—á–∞—Ç—å —É—Å—ñ (–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∫–µ—Ä—É–≤–∞—Ç–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–º–∏).
  if (!userCanHardDeleteRoutes()){
    try { q = q.where('isActive','==', true); } catch(_){ /* —è–∫—â–æ —â–µ –Ω–µ–º–∞—î –ø–æ–ª—è –∞–±–æ —ñ–Ω–¥–µ–∫—Å—É */ }
  }
  q = withHubFilter(q, 'hub');
  q = q.orderBy('updatedAt','desc').limit(pageSize);
  if (routesPageLastDoc) q = q.startAfter(routesPageLastDoc);

  try{
    const snap = await q.get({ source:'default' });
    if (snap.empty){
      routesDone = true;
    }else{
      renderRoutesDocs(snap.docs);
      routesPageLastDoc = snap.docs[snap.docs.length-1];
      if (snap.size < pageSize) routesDone = true;
    }
  } finally {
    isRefreshingRoutes = false;
  }
}

// –¥–æ–≥—Ä—É–∑–∏—Ç–∏ –≤—Å–µ (–ø–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö)
async function loadAllRoutes(){
  const HARD_CAP = 1000; // –º–∞–∫—Å–∏–º—É–º, —â–æ–± –Ω–µ –∑–±–∞–Ω–∫—Ä—É—Ç–∏—Ç–∏ —Ä—ñ–¥–∞–º–∏
  if (!confirm('–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫? –¶–µ –º–æ–∂–µ –∑—Ä–æ–±–∏—Ç–∏ –±–∞–≥–∞—Ç–æ —Ä—ñ–¥—ñ–≤ –¥–æ –ë–î.')){
    return;
  }
  while(!routesDone && routesLoadedCount < HARD_CAP){
    await refreshRoutesList('next');
  }
  if (!routesDone) {
    alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${HARD_CAP}. –£—Ç–æ—á–Ω—ñ—Ç—å –ø–æ—à—É–∫ –∑–∞–º—ñ—Å—Ç—å –ø–æ–≤–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.`);
  } else {
    alert(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç—ñ–≤: ${routesLoadedCount}`);
  }
}

async function loadFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const sel = document.getElementById('remoteRoutes');
    let id = sel.value;
    // If there are current search results, prefer the first one
    const cur = (window.currentSearchResults || []);
    if ((!id || id === '') && cur.length) {
      id = cur[0].id;
    }
    // –§–æ–ª–±–µ–∫: —è–∫—â–æ –≤ —Å–µ–ª–µ–∫—Ç—ñ –Ω—ñ—á–æ–≥–æ –Ω–µ –æ–±—Ä–∞–Ω–æ, –∞–ª–µ –≤ –ø–æ–ª—ñ –ø–æ—à—É–∫—É —î —Ç–µ–∫—Å—Ç ‚Äî –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å –∑–Ω–∞–π—Ç–∏ id —Ä—ñ–∑–Ω–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    if (!id) {
      let label = (document.getElementById('routeSearch')?.value || '').trim();
      if (label) {
        // 0) –ü—Ä–∏–±—Ä–∞—Ç–∏ —Å—É—Ñ—ñ–∫—Å –∑ –∫—ñ–ª–æ–º–µ—Ç—Ä–∞–º–∏, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∫–æ–ø—ñ—é–≤–∞–≤ –ø—ñ–¥–ø–∏—Å –∑ "(xx –∫–º)"
        const kmSuffix = label.match(/^(.*)\s*\(\s*\d+[\.,]?\d*\s*–∫–º\s*\)$/i);
        if (kmSuffix && kmSuffix[1]) label = kmSuffix[1].trim();

        const mapped = routesLookup[label];
        if (mapped) { id = mapped; sel.value = id; }
        // –î–æ–∑–≤–æ–ª–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∑ rid=... –∞–±–æ —Å–∞–º ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
        if (!id) {
          // 1) –°–ø—Ä–æ–±–∞ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ rid –∑ URL/—Ä—è–¥–∫–∞
          const m = label.match(/[?&]rid=([a-zA-Z0-9_-]{10,})/);
          if (m && m[1]) { id = m[1]; }
        }
        if (!id) {
          // 2) –Ø–∫—â–æ —Å—Ö–æ–∂–µ –Ω–∞ Firestore ID ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –Ω–∞–ø—Ä—è–º—É –æ–¥–Ω–∏–º —Ä—ñ–¥–æ–º
          const looksLikeId = /^[a-zA-Z0-9_-]{10,}$/.test(label);
          if (looksLikeId) {
            try {
              const probe = await db.collection('routes').doc(label).get();
              if (probe.exists) { id = label; }
            } catch(_) { /* ignore */ }
          }
        }
        if (!id) {
          // 3) –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫ –ø–æ routeKey, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—Å—Ç–∞–≤–∏–≤ –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É
          const rk = label.replace(/^–∫–æ–¥[:\s]*/i,'').trim();
          if (rk && /^[A-Z0-9-]{4,}$/.test(rk)){
            try {
              const q = await db.collection('routes').where('routeKey','==', rk).limit(1).get({ source:'default' });
              if (!q.empty) { id = q.docs[0].id; }
            } catch(_) { /* ignore */ }
          }
        }
        if (!id && label.length >= 2) {
          // 4) –¢–æ—á–Ω–∏–π –∑–±—ñ–≥ –ø–æ nameLower
          try {
            const exact = await withHubFilter(db.collection('routes'), 'hub')
              .where('nameLower','==', label.toLowerCase())
              .limit(1).get({ source:'default' });
            if (!exact.empty) { id = exact.docs[0].id; }
          } catch(_) { /* ignore */ }
        }
        if (!id && label.length >= 2) {
          // 5) –ü—Ä–µ—Ñ—ñ–∫—Å–Ω–∏–π –ø–æ—à—É–∫ –ø–æ nameLower (–≤—ñ–∑—å–º–µ–º–æ –ø–µ—Ä—à–∏–π –∑–±—ñ–≥)
          try {
            let qRef = db.collection('routes')
              .orderBy('nameLower')
              .startAt(label.toLowerCase())
              .endBefore(label.toLowerCase() + '\uf8ff')
              .limit(1);
            qRef = withHubFilter(qRef, 'hub');
            const s = await qRef.get({ source:'default' });
            if (!s.empty) { id = s.docs[0].id; }
          } catch(_) { /* ignore */ }
        }
        if (id) { sel.value = id; }
      }
    }
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É –∞–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É –ø—ñ–¥–∫–∞–∑–æ–∫ –ø–æ—à—É–∫—É'); return; }

    const docRef = db.collection('routes').doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
    const data = docSnap.data();
    if (!userAllowsHub(data.hub || '')) {
  alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (data.hub || '‚Äî'));
  return;
}
    // –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤–∏–±—Ä–∞–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å—Ç–∞–Ω—ñ ‚Äî –¥–æ setApprovalUI
    try { window.__currentRouteActive = (data.isActive === false) ? false : true; } catch(_){}
    // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π (soft-deleted) –º–∞—Ä—à—Ä—É—Ç
    if (data.isActive === false){
      alert('‚ÑπÔ∏è –ú–∞—Ä—à—Ä—É—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π (–≤–∏–¥–∞–ª–µ–Ω–∏–π –ª–æ–≥—ñ—Å—Ç–æ–º). –ê–¥–º—ñ–Ω –º–æ–∂–µ –π–æ–≥–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ.');
      try { const chip = document.getElementById('statusChip'); if (chip) chip.dataset.active='false'; } catch(_){}
    }

    const fName = getNameByCode(data.fromCode) || parseNameFromLabel(data.fromLabel);
    const tName = getNameByCode(data.toCode)   || parseNameFromLabel(data.toLabel);

    document.getElementById('fromName').value = fName || '';
    document.getElementById('toName').value   = tName || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('routePurpose').value = data.purpose || '–ó–µ—Ä–Ω–æ';
    document.getElementById('intermediateText').value = data.intermediateText || '';
	document.getElementById('hubSelect').value = data.hub || '';
    document.getElementById('routeName').value = formatRouteTitle(data);
	setApprovalUI(data.approval);

    document.getElementById('logistInput').value =
      data.logisticName || (data.logisticId ? getLogistNameById(data.logisticId) : '');

    points = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler = fromObjPoints(data.endRuler || []);
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –Ω–∞–∑–≤–∞ ‚Üî –∫–æ–¥ —É –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫–µ—à—ñ
registerDirEntry(data.fromCode, data.fromLabel || document.getElementById('fromName').value);
registerDirEntry(data.toCode,   data.toLabel   || document.getElementById('toName').value);

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏ –ª—ñ–Ω—ñ–π–æ–∫ –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∫–ª—ñ–∫—ñ–≤
    rebuildMarkers(); rebuildRulerMarkers(); drawRulers(); updateRoute();
	updateHighlights();
    if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
  // ‚¨áÔ∏è Proposal: refresh overlay/UI if present
  try { updateProposalUIForData(data); } catch(_){ }
  // üî¥ Live-–ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–º—ñ–Ω–∏ –º–∞—Ä—à—Ä—É—Ç—É (—Å—Ç–∞—Ç—É—Å/–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è)
  try { subscribeToRouteLive(id); } catch(_){ }
    alert('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ –ë–î: ' + id + (data.routeKey ? `\n–ö–æ–¥: ${data.routeKey}` : ''));
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏: ' + (err?.message || err));
  }
}

async function deleteFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }
    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É –∑–∞ —Ö–∞–±–æ–º –ø–µ—Ä–µ–¥ –≤–∏–¥–∞–ª–µ–Ω–Ω—è–º
    let snap = null;
    try { snap = await db.collection('routes').doc(id).get(); } catch(_){ snap = null; }
    let data = snap && snap.exists ? (snap.data()||{}) : {};
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É
    if (snap && snap.exists && !userAllowsHub(data.hub || '')){
      alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (data.hub || '‚Äî'));
      return;
    }
    const role = userRoleLower();
    const isInactive = (data && data.isActive === false);

    if (!userCanHardDeleteRoutes()){
      // –õ–æ–≥—ñ—Å—Ç/—ñ–Ω—à–∏–π ‚Äî –ª–∏—à–µ soft-delete
      if (isInactive){
        alert('–ú–∞—Ä—à—Ä—É—Ç –≤–∂–µ –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–±–æ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è.');
        return;
      }
      if (!confirm('–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π (–≤–∏–¥–∞–ª–µ–Ω–∏–π –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)?')) return;
      await markRouteInactive(id);
      alert('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π. –ê–¥–º—ñ–Ω –º–æ–∂–µ –π–æ–≥–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ.');
      await refreshRoutesList();
      return;
    }

    // –ê–¥–º—ñ–Ω / –°–ë ‚Äî –ø—Ä–æ–ø–æ–Ω—É—î–º–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ —á–µ—Ä–µ–∑ –≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫
    const choice = await promptRouteActionDropdown(isInactive);
    if (!choice) return; // —Å–∫–∞—Å–æ–≤–∞–Ω–æ
    if (!isInactive && choice === 'inactive'){
      await markRouteInactive(id);
      alert('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π.');
    } else if (isInactive && (choice === 'restore')){
      await restoreRoute(id);
      alert('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ (–∞–∫—Ç–∏–≤–Ω–∏–π).');
    } else if (choice === 'hard'){
      if (!confirm('–û—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç? –¶–µ –ù–ï–ú–û–ñ–õ–ò–í–û –ø–æ–≤–µ—Ä–Ω—É—Ç–∏.')) return;
      await hardDeleteRoute(id);
      alert('üóëÔ∏è –ú–∞—Ä—à—Ä—É—Ç –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ.');
    } else {
      alert('‚ùé –ù–µ–≤—ñ–¥–æ–º–∞ –¥—ñ—è –∞–±–æ —Å–∫–∞—Å–æ–≤–∞–Ω–æ.');
      return;
    }
    await refreshRoutesList();
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: ' + (err?.message || err));
  }
}
// Soft-delete: –ø–æ–∑–Ω–∞—á–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–º
async function markRouteInactive(id){
  const ref = db.collection('routes').doc(id);
  await ref.set({
    isActive: false,
    deletedAt: new Date().toISOString(),
    deletedByUid: auth?.currentUser?.uid || null,
    deletedByEmail: auth?.currentUser?.email || null,
    deletedByRole: userRoleLower()
  }, { merge:true });
  try { await clientWriteRouteLog(id, 'mark-deleted', { isActive:false }); } catch(_){ }
}
// Restore soft-deleted route
async function restoreRoute(id){
  const ref = db.collection('routes').doc(id);
  await ref.set({
    isActive: true,
    restoredAt: new Date().toISOString(),
    restoredByUid: auth?.currentUser?.uid || null,
    restoredByEmail: auth?.currentUser?.email || null,
    deletedAt: null
  }, { merge:true });
  try { await clientWriteRouteLog(id, 'restore', { isActive:true }); } catch(_){ }
}
// Hard delete (admin/security only)
async function hardDeleteRoute(id){
  await db.collection('routes').doc(id).delete();
  try { await clientWriteRouteLog(id, 'hard-delete', { isActive:null }); } catch(_){ }
}

// ---------- –ù–µ–≤–µ–ª–∏–∫–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –≤–∏–ø–∞–¥–∞—é—á–∏–º —Å–ø–∏—Å–∫–æ–º –¥—ñ–π –¥–ª—è –∞–¥–º—ñ–Ω–∞ ----------
async function promptRouteActionDropdown(isInactive){
  return new Promise((resolve)=>{
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999;display:flex;align-items:center;justify-content:center;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#111827;color:#e5e7eb;max-width:420px;width:92vw;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.3);padding:16px;border:1px solid #374151;';
    const title = document.createElement('div');
    title.style.cssText = 'font-weight:600;margin-bottom:8px;';
    title.textContent = isInactive ? '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π' : '–ú–∞—Ä—à—Ä—É—Ç –∞–∫—Ç–∏–≤–Ω–∏–π';
    const msg = document.createElement('div');
    msg.style.cssText = 'font-size:13px;margin-bottom:10px;line-height:1.35;';
    msg.textContent = isInactive
      ? '–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é: –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏, –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –∞–±–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.'
      : '–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é: –ø–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π, –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –∞–±–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.';

    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:12px;';
    const label = document.createElement('label');
    label.style.cssText = 'font-size:13px;';
    label.textContent = '–î—ñ—è:';
    const select = document.createElement('select');
    select.style.cssText = 'flex:1 1 auto;padding:8px 10px;border:1px solid #6b7280;border-radius:8px;background:#111827;color:#e5e7eb;';

    const makeOpt = (val, text) => { const o=document.createElement('option'); o.value=val; o.textContent=text; return o; };
    if (isInactive){
      select.appendChild(makeOpt('restore','–í—ñ–¥–Ω–æ–≤–∏—Ç–∏'));
      select.appendChild(makeOpt('hard','–û—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏'));
    } else {
      select.appendChild(makeOpt('inactive','–ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π'));
      select.appendChild(makeOpt('hard','–û—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏'));
    }
    select.value = isInactive ? 'restore' : 'inactive';

    row.appendChild(label); row.appendChild(select);

    const actions = document.createElement('div');
    actions.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;';
    const ok = document.createElement('button');
    ok.textContent = 'OK';
    ok.style.cssText = 'padding:8px 12px;border-radius:8px;border:1px solid #2563eb;background:#2563eb;color:#fff;cursor:pointer;';
    const cancel = document.createElement('button');
    cancel.textContent = '–°–∫–∞—Å—É–≤–∞—Ç–∏';
    cancel.style.cssText = 'padding:8px 12px;border-radius:8px;border:1px solid #6b7280;background:#374151;color:#e5e7eb;cursor:pointer;';
    actions.appendChild(ok); actions.appendChild(cancel);

    box.appendChild(title); box.appendChild(msg); box.appendChild(row); box.appendChild(actions);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    const cleanup = ()=>{ try{ document.body.removeChild(overlay); }catch(_){} };
    ok.addEventListener('click', ()=>{ const v = String(select.value||''); cleanup(); resolve(v || null); });
    cancel.addEventListener('click', ()=>{ cleanup(); resolve(null); });
    overlay.addEventListener('click', (e)=>{ if (e.target === overlay){ cleanup(); resolve(null); } });
    document.addEventListener('keydown', function onKey(ev){ if (ev.key==='Escape'){ ev.preventDefault(); document.removeEventListener('keydown', onKey); cleanup(); resolve(null);} });

    try{ select.focus(); }catch(_){ }
  });
}
/* ======== APPROVAL: helpers + UI ======== */

// —Ñ–æ—Ä–º—É—î–º–æ –ª—ñ–Ω–∫ –Ω–∞ review.html
function reviewLinkForId(id){
  return location.origin.replace(/\/$/,'') + '/review.html?rid=' + encodeURIComponent(id);
}

// –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∏–º–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –ø–∞–Ω–µ–ª—ñ
function setApprovalUI(approval){
  const mapNames = { draft:'–ß–µ—Ä–Ω–µ—Ç–∫–∞', pending:'–û—á—ñ–∫—É—î', approved:'–ü–æ–≥–æ–¥–∂–µ–Ω–æ', rejected:'–í—ñ–¥—Ö–∏–ª–µ–Ω–æ' };
  // ‚¨áÔ∏è –¥–æ–¥–∞–Ω–æ —ñ–∫–æ–Ω–∫—É –¥–ª—è draft
  const icons    = { draft:'üìù', pending:'‚è≥', approved:'‚úÖ', rejected:'‚õî' };
  const st = (approval && approval.status) || 'draft';

  // ‚Äî‚Äî –ø–∞–Ω–µ–ª—å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è (—è–∫ –±—É–ª–æ)
  const statusEl = document.getElementById('approvalStatus');
  if (statusEl) statusEl.textContent = mapNames[st] || st;

  const wrap = document.getElementById('approvalCommentWrap');
  const ta   = document.getElementById('approvalComment');
  if (st === 'rejected' && approval && approval.comment){
    wrap.style.display = 'block'; ta.value = approval.comment || '';
  } else {
    wrap.style.display = 'none';  ta.value = '';
  }

  const sel  = document.getElementById('remoteRoutes');
const open = document.getElementById('openReviewLink');
if (open){
  const rid = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
  if (rid){
    open.style.display = 'inline-block';
    open.href = reviewLinkForId(rid);
  } else {
    open.style.display = 'none';
  }
}

  // ‚Äî‚Äî —Å—Ç–∞—Ç—É—Å-—á—ñ–ø (–ø—Ä–∞–≤–æ—Ä—É—á –∑–≤–µ—Ä—Ö—É) –∑ —ñ–∫–æ–Ω–∫–∞–º–∏
  const chip = document.getElementById('statusChip');
  if (chip){
    let label = mapNames[st] || '‚Äî';
    let icon  = icons[st] || '';
    // –Ø–∫—â–æ —î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å —è–∫ ¬´–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è¬ª (–∂–æ–≤—Ç–∏–π), –∫—Ä—ñ–º –≤–∏–ø–∞–¥–∫—É approved
    if (HAS_PROPOSAL && st !== 'approved'){
      label = '–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è';
      icon = 'üí°';
      chip.dataset.status = 'proposal';
    } else {
      chip.dataset.status = st;           // —Ç—Ä–∏–≥–µ—Ä –¥–ª—è —Å—Ç–∏–ª—ñ–≤ (pending/approved/rejected)
    }
    // –ü–æ–∑–Ω–∞—á–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (üü© / üü•) ‚Äî –±–µ—Ä–µ–º–æ –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É
    try {
      const act = (window.__currentRouteActive !== false); // undefined => true
      chip.dataset.active = act ? 'true' : 'false';
      chip.title = act ? '–ú–∞—Ä—à—Ä—É—Ç –∞–∫—Ç–∏–≤–Ω–∏–π' : '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π';
    } catch(_){ chip.dataset.active = 'true'; }
    chip.textContent = (icon ? (icon + ' ') : '') + '–°—Ç–∞—Ç—É—Å: ' + label;
  }
}

// –∫–æ–ø—ñ—é—î–º–æ –ª—ñ–Ω–∫ –Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥/–ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
async function copyReviewLink(){
  const sel = document.getElementById('remoteRoutes');
  const id  = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
  if (!id){
    alert('–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É –ë–î ‚Äî –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª—ñ–Ω–∫ –∑‚Äô—è–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.');
    return;
  }
  const url = reviewLinkForId(id);
  try { await navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.'); }
  catch { prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', url); }
}

// –≤–∏—Å—Ç–∞–≤–ª—è—î–º–æ —Å—Ç–∞—Ç—É—Å pending —Ç–∞ –ø—ñ–¥–≤–∏—â—É—î–º–æ revision
// –≤–∏—Å—Ç–∞–≤–ª—è—î–º–æ —Å—Ç–∞—Ç—É—Å pending —Ç–∞ –ø—ñ–¥–≤–∏—â—É—î–º–æ revision
async function sendForApproval(){
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  if (!db || !auth?.currentUser){ alert('–£–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É.'); return; }

  const sel = document.getElementById('remoteRoutes');
  const id  = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
  if (!id){
    alert('–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É –ë–î ‚Äî –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –π–æ–≥–æ –º–æ–∂–Ω–∞ –≤—ñ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Ç–∏ –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è.');
    return;
  }

  const user = auth.currentUser;
  const ref  = db.collection('routes').doc(id);

  await ref.set({
    approval: {
      status: 'pending',
      revision: firebase.firestore.FieldValue.increment(1),
      submittedAt: new Date().toISOString(),
      submittedByUid: user.uid || null,
      submittedByEmail: user.email || null,
      decisionAt: null,
      decidedByUid: null,
      decidedByEmail: null,
      comment: null
    },
    updatedAt: new Date().toISOString()
  }, { merge:true });

  setApprovalUI({ status:'pending' });
  await copyReviewLink();

  // --- –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram ---
  const routeName = document.getElementById('routeName')?.value || '';
  sendTelegramApprovalMessage(routeName, id);
}

// –∫–Ω–æ–ø–∫–∏ –ø–∞–Ω–µ–ª—ñ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
document.getElementById('copyReviewLink').onclick  = copyReviewLink;
document.getElementById('sendForApproval').onclick = sendForApproval;

/* ===== Proposal (preview/accept/reject) ===== */
function ensureProposalLayers(){
  if (!map || !map.getSource) return;
  const addIfMissing = () => {
    if (!map.getSource('proposal-route')){
      map.addSource('proposal-route', { type:'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({ id:'proposal-route', type:'line', source:'proposal-route', layout:{ visibility:'none' }, paint:{ 'line-color':'#f59e0b', 'line-width': 4, 'line-opacity': 0.9 } });
    }
    if (!map.getSource('proposal-ruler-start')){
      map.addSource('proposal-ruler-start', { type:'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({ id:'proposal-ruler-start', type:'line', source:'proposal-ruler-start', layout:{ visibility:'none' }, paint:{ 'line-color':'#2563eb', 'line-width': 3, 'line-dasharray':[2,2], 'line-opacity': 0.9 } });
    }
    if (!map.getSource('proposal-ruler-end')){
      map.addSource('proposal-ruler-end', { type:'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({ id:'proposal-ruler-end', type:'line', source:'proposal-ruler-end', layout:{ visibility:'none' }, paint:{ 'line-color':'#ea580c', 'line-width': 3, 'line-dasharray':[2,2], 'line-opacity': 0.9 } });
    }
  };
  try {
    if (!map.isStyleLoaded || !map.isStyleLoaded()){
      map.once('style.load', addIfMissing);
    } else {
      addIfMissing();
    }
  } catch(_){}
}

// Snap raw proposal polyline to roads using Mapbox Directions (chunked)
async function snapProposalRouteCoords(coords){
  try{
    if (!Array.isArray(coords) || coords.length < 2) return [];
    const chunks = splitIntoChunks(coords, 20);
    const out = [];
    for (let i = 0; i < chunks.length; i++){
      const coordsStr = chunks[i].map(p => p.join(',')).join(';');
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?geometries=geojson&overview=full&continue_straight=true&access_token=${mapboxgl.accessToken}`;
      try{
        const r = await fetch(url);
        const j = await r.json();
        const g = j?.routes?.[0]?.geometry;
        if (g?.coordinates) out.push(...g.coordinates);
      }catch(_){ /* ignore this chunk */ }
    }
    return out.length ? out : coords;
  }catch(_){ return coords || []; }
}

async function ensureProposalSnapped(prop){
  try{
    if (!prop || __proposalSnapInFlight) return;
    if (Array.isArray(prop.snappedPoints) && prop.snappedPoints.length >= 2) return;
    __proposalSnapInFlight = true;
    const snapped = await snapProposalRouteCoords(prop.points || []);
    prop.snappedPoints = snapped;
  } finally {
    __proposalSnapInFlight = false;
    try{ setProposalOverlayData(prop); }catch(_){}
  }
}

function setProposalOverlayData(prop){
  ensureProposalLayers();
  const makeLine = (coords) => ({ type:'Feature', geometry:{ type:'LineString', coordinates: coords || [] }, properties:{} });
  try{
    const routeFC = { type:'FeatureCollection', features: [] };
    const startFC = { type:'FeatureCollection', features: [] };
    const endFC   = { type:'FeatureCollection', features: [] };
    const routeCoords = (Array.isArray(prop?.snappedPoints) && prop.snappedPoints.length >= 2)
      ? prop.snappedPoints : (prop?.points || []);
    if (Array.isArray(routeCoords) && routeCoords.length >= 2){ routeFC.features.push(makeLine(routeCoords)); }
    if (Array.isArray(prop?.startRuler) && prop.startRuler.length >= 2){ startFC.features.push(makeLine(prop.startRuler)); }
    if (Array.isArray(prop?.endRuler) && prop.endRuler.length >= 2){ endFC.features.push(makeLine(prop.endRuler)); }
    if (map.getSource('proposal-route')) map.getSource('proposal-route').setData(routeFC);
    if (map.getSource('proposal-ruler-start')) map.getSource('proposal-ruler-start').setData(startFC);
    if (map.getSource('proposal-ruler-end'))   map.getSource('proposal-ruler-end').setData(endFC);
  }catch(_){ }
}

function setProposalVisibility(show){
  // –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ —à–∞—Ä–∏ —ñ—Å–Ω—É—é—Ç—å, —ñ –¥–∞–Ω—ñ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ, –ø–µ—Ä—à –Ω—ñ–∂ –º—ñ–Ω—è—Ç–∏ –≤–∏–¥–∏–º—ñ—Å—Ç—å.
  ensureProposalLayers();
  if (CURRENT_PROPOSAL) {
    try { setProposalOverlayData(CURRENT_PROPOSAL); } catch(_) {}
    // —è–∫—â–æ —â–µ –Ω–µ —Å–Ω–∞–ø–Ω—É—Ç–æ ‚Äî –∑–∞–ø—É—Å–∫–∞—î–º–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫
    try { ensureProposalSnapped(CURRENT_PROPOSAL); } catch(_) {}
  }

  PROPOSAL_VISIBLE = !!show;
  const vis = PROPOSAL_VISIBLE ? 'visible' : 'none';
  try{ map.setLayoutProperty('proposal-route','visibility', vis); }catch(_){ }
  try{ map.setLayoutProperty('proposal-ruler-start','visibility', vis); }catch(_){ }
  try{ map.setLayoutProperty('proposal-ruler-end','visibility', vis); }catch(_){ }

  // –ü—ñ–¥—ñ–π–º–∞—î–º–æ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –Ω–∞–¥ —É—Å—ñ–º–∞ –º–∞—Ä—à—Ä—É—Ç–Ω–∏–º–∏ —à–∞—Ä–∞–º–∏, —â–æ–± —ó—ó —Ç–æ—á–Ω–æ –±—É–ª–æ –≤–∏–¥–Ω–æ
  try{
    if (map.getLayer('proposal-ruler-end'))   map.moveLayer('proposal-ruler-end');
    if (map.getLayer('proposal-ruler-start')) map.moveLayer('proposal-ruler-start');
    if (map.getLayer('proposal-route'))       map.moveLayer('proposal-route');
  }catch(_){ }

  const btn = document.getElementById('btnShowProposal');
  if (btn) btn.textContent = PROPOSAL_VISIBLE ? 'üôà –°—Ö–æ–≤–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é' : 'üëÅ –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é';
}

function clearProposalOverlay(){
  CURRENT_PROPOSAL = null; HAS_PROPOSAL = false;
  try{
    if (map.getSource('proposal-route')) map.getSource('proposal-route').setData({ type:'FeatureCollection', features: [] });
    if (map.getSource('proposal-ruler-start')) map.getSource('proposal-ruler-start').setData({ type:'FeatureCollection', features: [] });
    if (map.getSource('proposal-ruler-end'))   map.getSource('proposal-ruler-end').setData({ type:'FeatureCollection', features: [] });
  }catch(_){ }
  setProposalVisibility(false);
  const wrap = document.getElementById('proposalWrapMain'); if (wrap) wrap.style.display = 'none';
  const chip = document.getElementById('proposalKmChip');  if (chip) chip.textContent = '–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –°–ë: ‚Äî';
  // refresh status chip without proposal
  try { setApprovalUI((LAST_SAVED_ROUTE.data && LAST_SAVED_ROUTE.data.approval) || null); } catch(_){ }
}

function updateProposalUIForData(data){
  const role = String(window.__userRole || currentRole || '').toLowerCase();
  const p = data && data.proposal ? data.proposal : null;
  const has = !!(p && Array.isArray(p.points) && p.points.length >= 2);
  HAS_PROPOSAL = has;
  const wrap = document.getElementById('proposalWrapMain');
  if (wrap) wrap.style.display = (has && (role === 'logist' || role === 'admin')) ? '' : 'none';
  const km = (typeof p?.distance_km === 'number') ? p.distance_km : NaN;
  const chip = document.getElementById('proposalKmChip');
  if (chip) chip.textContent = '–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –°–ë: ' + (Number.isFinite(km) ? km.toFixed(3) + ' –∫–º' : '‚Äî');
  if (has){
    CURRENT_PROPOSAL = {
      points: fromObjPoints(p.points || p.route || []),
      startRuler: fromObjPoints(p.startRuler || []),
      endRuler: fromObjPoints(p.endRuler || []),
      distance_km: km
    };
    // –ü—ñ–¥–≥–æ—Ç—É—î–º–æ —à–∞—Ä–∏ —ñ –¥–∞–Ω—ñ; —Å–ø–æ—á–∞—Ç–∫—É –ø–æ–∫–∞–∂–µ–º–æ ¬´—è–∫ —î¬ª, –ø–æ—Ç—ñ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ—Ç—è–≥–Ω–µ–º–æ —Å–Ω–∞–ø–Ω—É—Ç—É –≥–µ–æ–º–µ—Ç—Ä—ñ—é
  setProposalOverlayData(CURRENT_PROPOSAL);
  // –ù–µ —Å–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: —è–∫—â–æ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –≤–∂–µ –±—É–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ ‚Äî –ª–∏—à–∞—î–º–æ —è–∫ —î
  setProposalVisibility(PROPOSAL_VISIBLE); // –∫–Ω–æ–ø–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å–Ω–∞–ø–Ω—É—Ç—É –¥–æ –¥–æ—Ä—ñ–≥ –ª—ñ–Ω—ñ—é —ñ –æ–Ω–æ–≤–∏—Ç–∏ –æ–≤–µ—Ä–ª–µ–π
    ensureProposalSnapped(CURRENT_PROPOSAL);
  } else {
    clearProposalOverlay();
  }
  // Update the status chip to reflect proposal presence
  try { setApprovalUI((data && data.approval) || null); } catch(_){ }
}

async function acceptProposal(){
  try{
    const sel = document.getElementById('remoteRoutes');
    const id  = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
    if (!id){ alert('–ù–µ–º–∞—î –≤–∏–±—Ä–∞–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –≤ –ë–î. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –º–∞—Ä—à—Ä—É—Ç —Å–ø–µ—Ä—à—É.'); return; }
    if (!db){ alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const snap = await db.collection('routes').doc(id).get();
    if (!snap.exists){ alert('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –ë–î'); return; }
    const d = snap.data() || {};
    if (!CURRENT_PROPOSAL){ alert('–ù–µ–º–∞—î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –¥–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è'); return; }
    // –•–∞–±-–¥–æ—Å—Ç—É–ø –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å–æ–º
    if (!userAllowsHub(d.hub || '')){ alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (d.hub || '‚Äî')); return; }

    // –õ–æ–∫–∞–ª—å–Ω–∞ –∫–æ–ø—ñ—è, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –≥–æ–Ω–∫–∏ –∑—ñ live onSnapshot (—è–∫–∏–π –æ–¥—Ä–∞–∑—É –≤–∏–¥–∞–ª–∏—Ç—å proposal —ñ –æ–±–Ω—É–ª–∏—Ç—å CURRENT_PROPOSAL)
    const propLocal = {
      points: (CURRENT_PROPOSAL.points || []).slice(),
      startRuler: (CURRENT_PROPOSAL.startRuler || []).slice(),
      endRuler: (CURRENT_PROPOSAL.endRuler || []).slice(),
      distance_km: (typeof CURRENT_PROPOSAL.distance_km === 'number') ? CURRENT_PROPOSAL.distance_km : undefined,
    };

    const payload = {
      points: toObjPoints(propLocal.points),
      startRuler: toObjPoints(propLocal.startRuler),
      endRuler: toObjPoints(propLocal.endRuler),
      distance_km: propLocal.distance_km,
      updatedAt: new Date().toISOString(),
      proposal: firebase.firestore.FieldValue.delete()
    };

    await db.collection('routes').doc(id).set(payload, { merge:true });

    // üîé –ó–∞–ø–∏—à–µ–º–æ –ª–æ–≥ –∑–º—ñ–Ω–∏ (–≤ —Ç.—á. –≤—ñ–¥—Å—Ç–∞–Ω—ñ) –ø—ñ—Å–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó
    try{
      const prevTrack = pickTrackedFields(d || {});
      const nextData = Object.assign({}, d || {}, payload);
      const nextTrack = pickTrackedFields(nextData || {});
      const changes = diffFields(prevTrack, nextTrack).filter(c => c.field !== 'updatedAt');
      const summary = buildChangeSummary(changes);
      const summaryShort = buildShortSummary(changes);
      await clientWriteRouteLog(id, 'updated', {
        routeKey: nextData.routeKey || null,
        distance_km: nextData.distance_km,
        changes,
        summary,
        summaryShort,
        via: 'client-accept-proposal'
      });
    }catch(_){ }

    // Apply to local editor state as well
  points = propLocal.points.slice();
  startRuler = propLocal.startRuler.slice();
  endRuler = propLocal.endRuler.slice();
    rebuildMarkers(); rebuildRulerMarkers(); drawRulers(); updateRoute();
    clearProposalOverlay();
    alert('‚úÖ –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –¥–æ –º–∞—Ä—à—Ä—É—Ç—É.');
  }catch(e){
    console.error('acceptProposal error:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏–π–Ω—è—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é: ' + (e?.message || e));
  }
}

async function rejectProposal(){
  try{
    const sel = document.getElementById('remoteRoutes');
    const id  = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
    if (!id){ alert('–ù–µ–º–∞—î –≤–∏–±—Ä–∞–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –≤ –ë–î. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –º–∞—Ä—à—Ä—É—Ç —Å–ø–µ—Ä—à—É.'); return; }
    if (!db){ alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const snap = await db.collection('routes').doc(id).get();
    if (!snap.exists){ alert('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –ë–î'); return; }
    const d = snap.data() || {};
    if (!d.proposal){ alert('–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –Ω–µ–º–∞—î'); return; }
    if (!userAllowsHub(d.hub || '')){ alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (d.hub || '‚Äî')); return; }
    await db.collection('routes').doc(id).set({ proposal: firebase.firestore.FieldValue.delete(), updatedAt: new Date().toISOString() }, { merge:true });
    clearProposalOverlay();
    alert('‚ùå –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–æ.');
  }catch(e){
    console.error('rejectProposal error:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é: ' + (e?.message || e));
  }
}

// Wire buttons
document.getElementById('btnShowProposal').onclick = () => setProposalVisibility(!PROPOSAL_VISIBLE);
document.getElementById('btnAcceptProposal').onclick = acceptProposal;
document.getElementById('btnRejectProposal').onclick = rejectProposal;

/* ===== Buttons bindings ===== */
document.getElementById('saveToDB').onclick = saveToDB;
let lastRefreshClick = 0;
document.getElementById('refreshList').onclick = () => {
  const now = Date.now();
  if (now - lastRefreshClick < 500) return;
  lastRefreshClick = now;
  routesInitLoaded = true;       // —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ lazy-–ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  refreshRoutesList('reset');
};
document.getElementById('loadMoreRoutes').onclick = () => refreshRoutesList('next');
document.getElementById('loadAllRoutes').onclick  = () => loadAllRoutes();
document.getElementById('loadFromDB').onclick = loadFromDB;
document.getElementById('deleteFromDB').onclick = deleteFromDB;
document.getElementById('clearForm').onclick = clearForm;

// –ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ–±—Ä–∞–≤ –º–∞—Ä—à—Ä—É—Ç —É —Å–µ–ª–µ–∫—Ç—ñ ‚Äî —Å–∫–∞—Å–æ–≤—É—î–º–æ —Ç–∞–π–º–µ—Ä –ø–æ—à—É–∫—É —ñ –æ—á–∏—â–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä,
// —â–æ–± —á–µ—Ä–µ–∑ 3 —Å–µ–∫. UI –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–≤—Å—è –ø—É—Å—Ç–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
// –ü—Ä–∏–≤'—è–∑—É—î–º–æ —Å–ª—É—Ö–∞—á –Ω–∞–ø—Ä—è–º—É –¥–æ –µ–ª–µ–º–µ–Ω—Ç–∞, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –∑–º—ñ–Ω–Ω–æ—ó –¥–æ —ó—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
document.getElementById('remoteRoutes').addEventListener('change', () => {
  try { if (_rsTimer) { clearTimeout(_rsTimer); _rsTimer = null; } } catch {}
  routesSearchQ = '';
  try { document.getElementById('routeSearch').value = ''; } catch {}
  updateRoutesFoundLabel('');
  lockRoutesSelection();
});

/* Directory buttons */
document.getElementById('refreshDirectory').onclick = () => loadDirectory(true);
document.getElementById('clearDirCache').onclick = () => {
  try { localStorage.removeItem(dirCacheKey()); } catch {}
  loadDirectory(true);
};

/* Logists buttons */
document.getElementById('refreshLogists').onclick = async () => {
  const isLogged = !!(auth && auth.currentUser);
  await loadLogists(isLogged);
};
document.getElementById('clearLogistsCache').onclick = () => {
  try { localStorage.removeItem(LOGISTS_CACHE_KEY); } catch {}
  const isLogged = !!(auth && auth.currentUser);
  loadLogists(isLogged);
};

/* ===== Live updates for selected route (approval/proposal) ===== */
let __routeLiveUnsub = null;
let __routeLiveId = null;
let __routeLivePrev = null; // { status, hasProposal }
// ===== Notifications state =====
let __notifs = [];
let __notifRecent = new Set(); // dedupe short-term (kind+id+status)
function formatFromToShort(d){
  const from = getNameByCode(d.fromCode) || parseNameFromLabel(d.fromLabel) || d.fromLabel || '';
  const to   = getNameByCode(d.toCode)   || parseNameFromLabel(d.toLabel)   || d.toLabel   || '';
  return `${from} ‚Üí ${to}`;
}
function pushNotif(kind, text, opts={}){
  const n = { id: Date.now() + ':' + Math.random().toString(36).slice(2), kind, text, at: new Date(), rid: opts.rid || null };
  __notifs.unshift(n); // –Ω–æ–≤—ñ –∑–≤–µ—Ä—Ö—É
  renderNotifs();
}
function notifUrl(n){
  const rid = n.rid || '';
  if (!rid) return '#';
  const base = '/index.html';
  const qp = (n.kind === 'proposal') ? `?rid=${encodeURIComponent(rid)}&showProposal=1` : `?rid=${encodeURIComponent(rid)}`;
  return base + qp;
}
async function handleNotifClick(n, ev){
  try{ if (!n) return; const rid = n.rid; if (!rid) return;
    const newTab = !!(ev && (ev.ctrlKey || ev.metaKey || ev.button === 1));
    const url = notifUrl(n);
    if (newTab){ window.open(url, '_blank'); return; }
    await loadRouteById(rid);
    if (n.kind === 'proposal') {
      try{ setProposalVisibility(true); }catch(_){ }
    }
  }catch(_){ }
}
function renderNotifs(){
  const list = document.getElementById('notifList'); if (!list) return;
  list.innerHTML = '';
  __notifs.forEach(n =>{
    const li = document.createElement('li');
    li.style.cursor = n.rid ? 'pointer' : 'default';
    li.addEventListener('click', (ev)=> handleNotifClick(n, ev));
    li.addEventListener('mousedown', (ev)=>{ if (ev.button===1) { handleNotifClick(n, ev); } });
    const msg = document.createElement('div'); msg.className='notif-msg';
    if (n.rid){
      const a = document.createElement('a'); a.href = notifUrl(n); a.textContent = n.text; a.style.color = '#111'; a.style.textDecoration='none';
      a.addEventListener('click', (ev)=>{ ev.preventDefault(); handleNotifClick(n, ev); });
      msg.appendChild(a);
    } else {
      msg.textContent = n.text;
    }
    const right = document.createElement('div'); right.style.display='grid'; right.style.gridAutoFlow='column'; right.style.alignItems='center'; right.style.gap='8px';
    const time = document.createElement('div'); time.className='notif-time'; time.textContent = n.at.toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit'});
    const x = document.createElement('button'); x.className='notif-dismiss'; x.textContent='‚úï'; x.onclick=(e)=>{ e.stopPropagation(); __notifs = __notifs.filter(m=>m.id!==n.id); renderNotifs(); };
    right.appendChild(time); right.appendChild(x);
    li.appendChild(msg); li.appendChild(right);
    list.appendChild(li);
  });
  const cnt = document.getElementById('notifCount'); if (cnt){ cnt.style.display = __notifs.length ? 'inline-block' : 'none'; cnt.textContent = __notifs.length; }
}
function bindNotifUI(){
  const bell = document.getElementById('notifBell'); const drop = document.getElementById('notifDropdown'); const clr = document.getElementById('notifClear');
  if (bell && drop){ bell.onclick = (e)=>{ e.stopPropagation(); drop.style.display = (drop.style.display==='block' ? 'none' : 'block'); }; }
  if (clr){ clr.onclick = ()=>{ __notifs = []; renderNotifs(); }; }
  document.addEventListener('click', (ev)=>{
    try{ const drop = document.getElementById('notifDropdown'); const bell = document.getElementById('notifBell'); if (!drop) return; const path = ev.composedPath ? ev.composedPath() : []; if (drop.style.display==='block' && !path.includes(drop) && !path.includes(bell)) drop.style.display='none'; }catch(_){ }
  });
}
bindNotifUI();
function subscribeToRouteLive(id){
  try{ if (__routeLiveUnsub) { __routeLiveUnsub(); __routeLiveUnsub = null; } }catch(_){ }
  if (!id || !db) return;
  __routeLiveId = id;
  __routeLivePrev = null;
  __routeLiveUnsub = db.collection('routes').doc(id).onSnapshot((doc)=>{
    if (!doc.exists) return;
    const data = doc.data() || {};
    // –¢—ñ–ª—å–∫–∏ UI-—á–∞—Å—Ç–∏–Ω–∞: —Å—Ç–∞—Ç—É—Å/–∫–æ–º–µ–Ω—Ç–∞—Ä —ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è; —Å–∞–º—ñ —Ç–æ—á–∫–∏ –Ω–µ —á—ñ–ø–∞—î–º–æ, —â–æ–± –Ω–µ –∑–±–∏–≤–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    try { setApprovalUI(data.approval || null); } catch(_){ }
    try { updateProposalUIForData(data); } catch(_){ }
    // –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è: –≤–∏–∑–Ω–∞—á–∞—î–º–æ –∑–º—ñ–Ω–∏ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç—É
    const st = String(data?.approval?.status || 'draft');
    const hasProp = !!(data?.proposal && Array.isArray(data.proposal.points) && data.proposal.points.length>=2);
    if (__routeLivePrev){
      if (__routeLivePrev.status !== st){
        if (st === 'approved') _dedupePush('approved', __routeLiveId, st, `‚úÖ –ü–æ–≥–æ–¥–∂–µ–Ω–æ: ${formatFromToShort(data)}`);
        else if (st === 'rejected') _dedupePush('rejected', __routeLiveId, st, `‚õî –í—ñ–¥—Ö–∏–ª–µ–Ω–æ: ${formatFromToShort(data)}`);
        else if (st === 'pending') _dedupePush('pending', __routeLiveId, st, `‚è≥ –ù–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—ñ: ${formatFromToShort(data)}`);
      }
      if (!__routeLivePrev.hasProposal && hasProp){
        _dedupePush('proposal', __routeLiveId, 'proposal', `üí° –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –°–ë: ${formatFromToShort(data)}`);
      }
    }
    __routeLivePrev = { status: st, hasProposal: hasProp };
  }, (err)=>{ console.warn('live route subscription error', err); });
}

// ===== –ì–ª–æ–±–∞–ª—å–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (–≤—Å—ñ –º–∞—Ä—à—Ä—É—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö —Ö–∞–±–∞—Ö) =====
let __globalUnsubs = [];
let __globalPrimed = new Map(); // hubKey -> bool
const GLOBAL_LIMIT = 200;       // –æ—Å—Ç–∞–Ω–Ω—ñ N –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
function _dedupePush(kind, id, status, text){
  const key = kind + '|' + id + '|' + (status||'');
  if (__notifRecent.has(key)) return;
  __notifRecent.add(key);
  setTimeout(()=> __notifRecent.delete(key), 60_000); // 60s TTL
  pushNotif(kind, text, { rid: id });
}
function subscribeToGlobalNotifications(){
  // –í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—å –≤—ñ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö
  try{ __globalUnsubs.forEach(u=>u&&u()); }catch(_){ }
  __globalUnsubs = [];
  __globalPrimed.clear();
  if (!db) return;
  const hubs = (typeof isAllHubs === 'function' && isAllHubs()) ? [null] : (ALLOWED_HUBS || []);
  const mkHubKey = (h)=> String(h||'__ALL__');
  hubs.forEach(h =>{
    let q = db.collection('routes').orderBy('updatedAt','desc').limit(GLOBAL_LIMIT);
    if (h) q = q.where('hub','==', h);
    const hubKey = mkHubKey(h);
    const unsub = q.onSnapshot((snap)=>{
      const primed = __globalPrimed.get(hubKey) === true;
      snap.docChanges().forEach(ch =>{
        if (ch.type !== 'added' && ch.type !== 'modified') return;
        const d = ch.doc.data() || {};
        // –ó–∞—Ö–∏—Å—Ç: —Ç—ñ–ª—å–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ö–∞–±–∏
        if (!userAllowsHub(d.hub || '')) return;
        const st = String(d?.approval?.status || 'draft');
        const hasProp = !!(d?.proposal && Array.isArray(d.proposal.points) && d.proposal.points.length>=2);
        if (!primed) return; // –ø–µ—Ä—à–∏–π —Å–Ω–∞–ø—à–æ—Ç ‚Äî —Ç—ñ–ª—å–∫–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        if (ch.oldIndex !== ch.newIndex || ch.type === 'modified'){
          // –ü—É—à–∏–º–æ —Å—Ç–∞—Ç—É—Å–∏ —ñ –ø–æ—è–≤—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó
          if (st === 'approved') _dedupePush('approved', ch.doc.id, st, `‚úÖ –ü–æ–≥–æ–¥–∂–µ–Ω–æ: ${formatFromToShort(d)}`);
          else if (st === 'rejected') _dedupePush('rejected', ch.doc.id, st, `‚õî –í—ñ–¥—Ö–∏–ª–µ–Ω–æ: ${formatFromToShort(d)}`);
          else if (st === 'pending') _dedupePush('pending', ch.doc.id, st, `‚è≥ –ù–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—ñ: ${formatFromToShort(d)}`);
          if (hasProp) _dedupePush('proposal', ch.doc.id, 'proposal', `üí° –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –°–ë: ${formatFromToShort(d)}`);
        }
      });
      __globalPrimed.set(hubKey, true);
    }, (err)=> console.warn('global notif error', err));
    __globalUnsubs.push(unsub);
  });
}
window.addEventListener('beforeunload', ()=>{ try{ __routeLiveUnsub && __routeLiveUnsub(); }catch(_){ } });

/* ===================== Search helper (–æ–Ω–æ–≤–ª–µ–Ω–æ) ===================== */
const routeSearch       = document.getElementById('routeSearch');
const remoteRoutesSel   = document.getElementById('remoteRoutes');

// –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ-—Å–∫–∏–¥–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –≤—ñ–¥ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –ø–æ—à—É–∫—ñ–≤ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –≤ —Å–µ–ª–µ–∫—Ç—ñ
let _routesSelectLock = false;
function lockRoutesSelection(ms = 2500){
  _routesSelectLock = true;
  setTimeout(() => { _routesSelectLock = false; }, ms);
}

let routesSearchQ       = '';
let routesSearchLastDoc = null;   // –ø–∞–≥—ñ–Ω–∞—Ü—ñ—è —Å–∞–º–µ –¥–ª—è –ø—Ä–µ—Ñ—ñ–∫—Å–Ω–æ–≥–æ –ø–æ—à—É–∫—É
let routesSearchDone    = true;
let routesFoundSoFar    = 0;      // –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö (–ø–æ—Ç–æ—á–Ω–∏–π –∑–∞–ø–∏—Ç)

// ===== –ü–æ–∑–∏—Ü—ñ—é–≤–∞–Ω–Ω—è –ø–æ–ø–∞–ø—É –ø—ñ–¥–∫–∞–∑–æ–∫ –ø–æ–≤–µ—Ä—Ö —É—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ =====
function __ensurePopupInBody(){
  const el = document.getElementById('routesPopup');
  if (!el) return null;
  if (el.parentElement !== document.body){
    try { document.body.appendChild(el); } catch(_) {}
  }
  return el;
}
function positionRoutesPopup(){
  const popup = __ensurePopupInBody();
  const input = document.getElementById('routeSearch');
  if (!popup || !input) return;
  const r = input.getBoundingClientRect();
  popup.style.position = 'fixed';
  popup.style.left = Math.round(r.left) + 'px';
  popup.style.top  = Math.round(r.bottom + 4) + 'px';
  popup.style.width = Math.round(r.width) + 'px';
  popup.style.maxHeight = '40vh';
  popup.style.zIndex = '10050'; // –≤–∏—â–µ –∑–∞ –ø–∞–Ω–µ–ª—ñ
}
window.addEventListener('resize', positionRoutesPopup);
window.addEventListener('scroll', positionRoutesPopup, true);

function updateRoutesFoundLabel(n, hasMore){
  const el = document.getElementById('routesFound');
  if (!el) return;
  // –ü–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫, null/undefined –∞–±–æ 0 ‚Äî –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä
  if (n === '' || n == null || n === 0){ el.textContent = ''; return; }
  el.textContent = `–ó–Ω–∞–π–¥–µ–Ω–æ: ${n}${hasMore ? '+' : ''}`;
}

function resetRoutesUI(){
  routesPageLastDoc = null;       // –Ω–µ —á—ñ–ø–∞—î –±–∞–∑–æ–≤—É –ø–∞–≥—ñ–Ω–∞—Ü—ñ—é ¬´–∑–∞ –¥–∞—Ç–æ—é¬ª, –∞–ª–µ –º–∏ —ó—ó —Ç—É—Ç –Ω–µ —é–∑–∞—î–º–æ
  routesDone = false;
  for (const k in routesLookup) delete routesLookup[k];
  remoteRoutesSel.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
  document.getElementById('routesList').innerHTML = '';
  routesLoadedCount = 0;
  routesFoundSoFar = 0;
  window.currentSearchResults = [];
  updateRoutesFoundLabel('');
}

function scoreByPosition(rowNameLower, qLower){
  const pos = (rowNameLower || '').indexOf(qLower);
  return (pos === -1 ? 1e6 : pos) * 1000 + (rowNameLower || '').length;
}

/** –ü–æ—à—É–∫: –ø—Ä–µ—Ñ—ñ–∫—Å –ø–æ nameLower + (fallback) —Ç—Ä—ñ–≥—Ä–∞–º–Ω–∏–π contains.
 *  mode: 'reset' | 'next'
 */
async function searchRoutes(q, mode='reset'){
  if (_routesSelectLock) return; // –Ω–µ –∑–∞—Ç–∏—Ä–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
  const qLower = String(q||'').trim().toLowerCase();

  if (mode === 'reset'){
    routesSearchQ = qLower;
    routesSearchLastDoc = null;
    routesSearchDone = true;
    // –ù–µ –æ—á–∏—â–∞—î–º–æ —Å–µ–ª–µ–∫—Ç/–ø—ñ–¥–∫–∞–∑–∫–∏, —è–∫—â–æ –∑–∞–ø–∏—Ç –∫–æ—Ä–æ—Ç—à–∏–π –∑–∞ 3 —Å–∏–º–≤–æ–ª–∏ ‚Äî
    // —Ü–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –∑–Ω–∏–∫–Ω–µ–Ω–Ω—é —Å–ø–∏—Å–∫—É –ø—ñ–¥ —á–∞—Å –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö –Ω–∞—Ç–∏—Å–∫–∞–Ω—å
    if (qLower.length < 3){ updateRoutesFoundLabel(''); return; } // —á–µ–∫–∞—î–º–æ 3+ —Å–∏–º–≤–æ–ª–∏
    resetRoutesUI();
  }

  if (!routesSearchQ) return;

  const limit = 50;
  const acc = [];
  const seen = new Set();
  const addDocs = (snap) => snap.forEach(d => { if (!seen.has(d.id)) { acc.push(d); seen.add(d.id); } });

  // -------- 1) –ü–†–ï–§–Ü–ö–° ‚Äî –ø–æ nameLower, fromLabelLower, toLabelLower --------
  const mkPrefix = (field) => {
    let qRef = db.collection('routes')
      .orderBy(field)
      .startAt(routesSearchQ)
      .endBefore(routesSearchQ + '\uf8ff')
      .limit(limit);
    qRef = withHubFilter(qRef, 'hub');
    return qRef.get({ source:'default' });
  };

  if (mode === 'reset') {
    // –ü–µ—Ä—à–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞: —Ç—Ä–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –ø—Ä–µ—Ñ—ñ–∫—Å–Ω—ñ –∑–∞–ø–∏—Ç–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –º–µ—Ä–¥–∂–∏–º–æ
    const [sName, sFrom, sTo] = await Promise.allSettled([
      mkPrefix('nameLower'),
      mkPrefix('fromLabelLower'),
      mkPrefix('toLabelLower')
    ]);
    [sName, sFrom, sTo].forEach(r => { if (r.status === 'fulfilled') addDocs(r.value); });
    // –¥–ª—è –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó –∑–∞–ø–∞–º'—è—Ç–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ "nameLower" (–ø—Ä–æ—Å—Ç–æ —ñ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ)
    if (sName.status === 'fulfilled' && sName.value.docs.length) {
      routesSearchLastDoc = sName.value.docs[sName.value.docs.length - 1];
      routesSearchDone = sName.value.size < limit;
    } else {
      routesSearchLastDoc = null;
      routesSearchDone = true;
    }
  } else {
    // –ù–∞—Å—Ç—É–ø–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏: –¥–æ–≥—Ä—É–∂–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ nameLower (–≥–æ–ª–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫)
    let qRef = db.collection('routes')
      .orderBy('nameLower')
      .startAt(routesSearchQ)
      .endBefore(routesSearchQ + '\uf8ff')
      .limit(limit);
    qRef = withHubFilter(qRef, 'hub');
    if (routesSearchLastDoc) qRef = qRef.startAfter(routesSearchLastDoc);
    const sNext = await qRef.get({ source:'default' });
    addDocs(sNext);
    routesSearchLastDoc = sNext.docs.length ? sNext.docs[sNext.docs.length - 1] : routesSearchLastDoc;
    routesSearchDone = sNext.size < limit;
  }

  // -------- 2) FALLBACK CONTAINS ‚Äî –ø–æ searchNgrams (–∑–≤–µ–¥–µ–Ω–∏–π, —Å—Ç—Ä–∏–º–∞–Ω—ñ—à–µ: –≤—ñ–¥ 4 —Å–∏–º–≤–æ–ª—ñ–≤) --------
  if (mode === 'reset' && acc.length < limit && routesSearchQ.length >= 4){
    const grams = trigrams(routesSearchQ);
    if (grams.length){
      // –ù–µ –æ–±–º–µ–∂—É—î–º–æ —Ö–∞–±–∏ (–∑–∞ –≤–∏–º–æ–≥–æ—é)
      const hubs = isAllHubs() ? [null] : ALLOWED_HUBS;
      for (const h of hubs){
        let q2 = db.collection('routes')
          .where('searchNgrams','array-contains-any', grams)
          .limit(limit);
        if (h) q2 = q2.where('hub','==', h);
        const s2 = await q2.get({ source:'default' });
        addDocs(s2);
      }
    }
  }

  // -------- 3) –†–ê–ù–ñ–£–í–ê–ù–ù–Ø ‚Äî –±–ª–∏–∂—á–µ –¥–æ –ø–æ—á–∞—Ç–∫—É —É –±—É–¥—å-—è–∫–æ–º—É –∑ –ø–æ–ª—ñ–≤ --------
  const pos = (s) => (s || '').indexOf(routesSearchQ);
  const score = (d) => {
    const x = d.data() || {};
    const toNum = (v) => (v < 0 ? 1e6 : v); // -1 ‚Üí –¥—É–∂–µ –¥–∞–ª–µ–∫–æ
    return Math.min(
      toNum(pos(x.nameLower)),
      toNum(pos(x.fromLabelLower)),
      toNum(pos(x.toLabelLower))
    ) * 1000 + (x.nameLower || '').length;
  };

  // üîé –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π —Ñ—ñ–ª—å—Ç—Ä: –ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –º–∞—Ä—à—Ä—É—Ç–∏,
  // —É —è–∫–∏—Ö –∑–∞–ø–∏—Ç –≤—Ö–æ–¥–∏—Ç—å —É –Ω–∞–∑–≤—É –∞–±–æ —É –∫–æ—Ä–æ—Ç–∫—ñ –≤—ñ–¥/–¥–æ
  const containsQ = (x, q) => {
    if (!x) return false;
    if ((x.nameLower||'').includes(q)) return true;
    if ((x.fromLabelLower||'').includes(q)) return true;
    if ((x.toLabelLower||'').includes(q)) return true;
    const fb = (formatRouteTitle(x) || '').toLowerCase();
    return fb.includes(q);
  };

  const onlyMatches = acc.filter(doc => {
    const x = doc.data() || {};
    return containsQ(x, routesSearchQ);
  });

  onlyMatches.sort((a,b)=> score(a) - score(b));
  let results = onlyMatches.slice();

  // üîÅ –î–æ–¥–∞—Ç–∫–æ–≤–∏–π "—Å–∫–∞–Ω" –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ ‚Äî –í–ò–ú–ö–ù–ï–ù–û –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —â–æ–± –Ω–µ —Å–ø–∞–ª—é–≤–∞—Ç–∏ –∫–≤–æ—Ç—É
  let scanHasMore = false;
  const ENABLE_ROUTES_SCAN = false;
  if (ENABLE_ROUTES_SCAN && mode === 'reset' && results.length < 10){
    const SCAN_PAGE = 100;   // –∑–∞ —Ä–∞–∑
    const SCAN_PAGES = 3;    // –º–∞–∫—Å–∏–º—É–º —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (300 –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤)
    let last = null;
    const seen = new Set(results.map(d=>d.id));
    for (let i=0; i<SCAN_PAGES && results.length < 50; i++){
      let qRef = db.collection('routes').orderBy('updatedAt','desc').limit(SCAN_PAGE);
      qRef = withHubFilter(qRef, 'hub');
      if (last) qRef = qRef.startAfter(last);
      const s = await qRef.get({ source:'default' });
      if (s.empty) break;
      s.forEach(doc=>{
        if (seen.has(doc.id)) return;
        const x = doc.data() || {};
        if (containsQ(x, routesSearchQ)){
          results.push(doc);
          seen.add(doc.id);
        }
      });
      last = s.docs[s.docs.length-1];
      if (s.size < SCAN_PAGE){ break; }
      // —è–∫—â–æ –ø—ñ—Å–ª—è 3 —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —â–µ —î ‚Äî –≤–≤–∞–∂–∞–π, —â–æ —î —â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
      if (i === SCAN_PAGES-1) scanHasMore = true;
    }
  }

  renderRoutesDocs(results);
  routesFoundSoFar += results.length;
  const hasMore = !routesSearchDone || scanHasMore;
  updateRoutesFoundLabel(routesFoundSoFar, hasMore);
}

/* ‚Äî‚Äî‚Äî –ó–í‚Äô–Ø–ó–£–í–ê–ù–ù–Ø UI ‚Äî‚Äî‚Äî */

// –ê–≤—Ç–æ–ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–ø–µ—Ä –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è, –∫–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å –ø–∞–Ω–µ–ª—å "–ë–∞–∑–∞" (–¥–∏–≤. showPanel).
// –û–Ω–æ–≤–ª–µ–Ω–æ: –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –∞–≤—Ç–æ–ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Äî —Ä–æ–±–∏–º–æ –ª—ñ–Ω–∏–≤–µ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É —Ñ–æ–∫—É—Å—ñ/–≤–≤–µ–¥–µ–Ω–Ω—ñ –≤ –ø–æ–ª–µ –ø–æ—à—É–∫—É.

// debounce, —â–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏ Firestore –ø—ñ–¥ —á–∞—Å –¥—Ä—É–∫—É
let _rsTimer = null;
routeSearch.addEventListener('input', () => {
  // –õ—ñ–Ω–∏–≤–µ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä—à–∏–º –ø–æ—à—É–∫–æ–º
  if (!routesInitLoaded){ routesInitLoaded = true; refreshRoutesList('reset'); }
  if (_rsTimer) clearTimeout(_rsTimer);
  // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–æ—à—É–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–µ—Ä–µ—Å—Ç–∞–≤ –¥—Ä—É–∫—É–≤–∞—Ç–∏
  _rsTimer = setTimeout(() => searchRoutes(routeSearch.value, 'reset'), 1000);
});

// Enter = —è–∫—â–æ —â–æ—Å—å –∑–Ω–∞–π—à–ª–∏ ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ
routeSearch.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    // —è–∫—â–æ —î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É ‚Äî –±–µ—Ä–µ–º–æ –ø–µ—Ä—à–∏–π —ñ –≤–∞–Ω—Ç–∞–∂–∏–º–æ –π–æ–≥–æ
    const cur = (window.currentSearchResults || []);
    if (cur.length) {
      remoteRoutesSel.value = cur[0].id;
      document.getElementById('loadFromDB').click();
      e.preventDefault();
      return;
    }
    // fallback: —è–∫—â–æ –≤ —Å–µ–ª–µ–∫—Ç—ñ —É–∂–µ —î —è–∫—ñ—Å—å –≤–∞—Ä—ñ–∞–Ω—Ç–∏ ‚Äî —Å—Ç–∞–≤–∏–º–æ –ø–µ—Ä—à–∏–π —ñ –≤–∞–Ω—Ç–∞–∂–∏–º–æ
    for (const opt of remoteRoutesSel.options) {
      if (opt.value) { remoteRoutesSel.value = opt.value; break; }
    }
    if (remoteRoutesSel.value) {
      document.getElementById('loadFromDB').click();
    } else if ((routeSearch.value||'').trim()) {
      // —è–∫—â–æ –Ω–µ–º–∞—î –≤–∏–¥–∏–º–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤, –∞–ª–µ —î —Ç–µ–∫—Å—Ç —É –ø–æ–ª—ñ ‚Äî —Å–ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ø—Ä—è–º—É (ID/rid/routeKey)
      document.getElementById('loadFromDB').click();
    }
  }
});

// –ö–Ω–æ–ø–∫–∞ ¬´–©–µ¬ª —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î —ñ –¥–ª—è –ø–æ—à—É–∫—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–µ—Ñ—ñ–∫—Å–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é)
document.getElementById('loadMoreRoutes').onclick = () => {
  if (routesSearchQ) return searchRoutes(routesSearchQ, 'next');
  return refreshRoutesList('next'); // –Ω–∞–∑–∞–¥ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å, —è–∫—â–æ –ø–æ—à—É–∫ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π
};

// –ü—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ —Ñ–æ–∫—É—Å—É —ñ–Ω–ø—É—Ç—É ‚Äî —Ö–æ–≤–∞—î–º–æ –ø–æ–ø–∞–ø —á–µ—Ä–µ–∑ –º–∏—Ç—å (—â–æ–± —Å–ø—Ä–∞—Ü—é–≤–∞–≤ –∫–ª—ñ–∫)
routeSearch.addEventListener('blur', () => {
  const popup = document.getElementById('routesPopup');
  setTimeout(() => { if (popup) popup.style.display = 'none'; }, 150);
});
// –ü—Ä–∏ —Ñ–æ–∫—É—Å—ñ ‚Äî —è–∫—â–æ –≤–∂–µ —î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏, –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–ø–∞–ø
routeSearch.addEventListener('focus', () => {
  // –õ—ñ–Ω–∏–≤–µ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É —Ñ–æ–∫—É—Å—ñ
  if (!routesInitLoaded){ routesInitLoaded = true; refreshRoutesList('reset'); }
  const popup = document.getElementById('routesPopup');
  if (popup && (window.currentSearchResults||[]).length){
    positionRoutesPopup();
    popup.style.display = 'block';
  }
});

/* Load by ?rid= */
async function loadRouteById(rid) {
  try {
    const snap = await db.collection('routes').doc(rid).get();
    if (!snap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –∑ —Ç–∞–∫–∏–º ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ' + rid); return; }
    const data = snap.data();
    if (!userAllowsHub(data.hub || '')) {
  alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (data.hub || '‚Äî'));
  return;
}
    document.getElementById('fromName').value = getNameByCode(data.fromCode) || parseNameFromLabel(data.fromLabel) || '';
    document.getElementById('toName').value   = getNameByCode(data.toCode)   || parseNameFromLabel(data.toLabel)   || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('routePurpose').value = data.purpose || '–ó–µ—Ä–Ω–æ';
    document.getElementById('intermediateText').value = data.intermediateText || '';
	document.getElementById('hubSelect').value = data.hub || '';
    document.getElementById('routeName').value = formatRouteTitle(data);
	setApprovalUI(data.approval);

    document.getElementById('logistInput').value =
      data.logisticName || (data.logisticId ? getLogistNameById(data.logisticId) : '');

    points     = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler   = fromObjPoints(data.endRuler || []);
    registerDirEntry(data.fromCode, data.fromLabel || document.getElementById('fromName').value);
    registerDirEntry(data.toCode,   data.toLabel   || document.getElementById('toName').value);
    // –û–¥—Ä–∞–∑—É –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏ –ª—ñ–Ω—ñ–π–æ–∫, —è–∫—â–æ –≤–æ–Ω–∏ —î –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ
    rebuildMarkers(); rebuildRulerMarkers(); drawRulers(); updateRoute();
    if (points.length) {
      const b = new mapboxgl.LngLatBounds(points[0], points[0]);
      for (const p of points) b.extend(p);
      map.fitBounds(b, { padding: 40 });
    }
    // ‚úÖ –í–ê–ñ–õ–ò–í–û: –∑—Ä–æ–±–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç ¬´–æ–±—Ä–∞–Ω–∏–º¬ª —É —Å–µ–ª–µ–∫—Ç—ñ —ñ –∑–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –π–æ–≥–æ —è–∫ –æ—Å—Ç–∞–Ω–Ω—ñ–π,
    // —â–æ–± –∫–Ω–æ–ø–∫–∏ "–ù–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è" —Ç–∞ "–ü–æ—Å–∏–ª–∞–Ω–Ω—è" –ø—Ä–∞—Ü—é–≤–∞–ª–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    try { ensureRouteOptionSelected(rid, data); } catch(_) {}
  // –û–Ω–æ–≤–∏—Ç–∏ UI –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó (—è–∫—â–æ —î), —â–æ–± –ª–æ–≥—ñ—Å—Ç –º—ñ–≥ –æ–¥—Ä–∞–∑—É –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏/–ø—Ä–∏–π–Ω—è—Ç–∏/–≤—ñ–¥—Ö–∏–ª–∏—Ç–∏
    try { updateProposalUIForData(data); } catch(_) {}
  // üî¥ Live-–ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–º—ñ–Ω–∏ –º–∞—Ä—à—Ä—É—Ç—É (—Å—Ç–∞—Ç—É—Å/–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è) ‚Äî –¥–ª—è –æ–Ω–ª–∞–π–Ω –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
  try { subscribeToRouteLive(rid); } catch(_) {}
    if (data.routeKey) alert('–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ' + data.routeKey);
  } catch (e) {
    console.error('loadRouteById error:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ' + (e?.message || e));
  }
}
function clearForm() {
  document.getElementById('fromName').value = '';
  document.getElementById('toName').value = '';
  document.getElementById('routeType').value = '–û—Å–Ω–æ–≤–Ω–∏–π';
  document.getElementById('routePurpose').value = '–ó–µ—Ä–Ω–æ';
  document.getElementById('intermediateText').value = '';
  document.getElementById('hubSelect').value = '';
  document.getElementById('routeName').value = '';
  document.getElementById('logistInput').value = '';
  setKmUI(0);
  // –°–∫–∏–¥–∞—î–º–æ –¥–∞–Ω—ñ
  points = []; startRuler = []; endRuler = [];
  // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –í–°–Ü –º–∞—Ä–∫–µ—Ä–∏ (–º–∞—Ä—à—Ä—É—Ç—É —ñ –ª—ñ–Ω—ñ–π–æ–∫)
  try { rebuildMarkers(); } catch(_) {}
  try { clearRulerMarkers(); } catch(_) {}
  // –°–∫–∞—Å–æ–≤—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ —Ä–µ–∂–∏–º–∏ —ñ –≤–∏–±—ñ—Ä —ñ–Ω–¥–µ–∫—Å—É
  addMode = false; startLineMode = false; endLineMode = false; insertAfterMode = false;
  setActiveRuler(null); lastActiveRuler = null; selectedMarkerIndex = null;
  // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫ (—â–æ–± ¬´–ú–∞—Ä—à—Ä—É—Ç¬ª –Ω–µ –≤–∏–≥–ª—è–¥–∞–≤ –∞–∫—Ç–∏–≤–Ω–∏–º)
  try {
    toggleButton('toggleAdd', false);
    toggleButton('startLineMode', false);
    toggleButton('endLineMode', false);
  } catch(_){}
  // –ü–µ—Ä–µ–º–∞–ª—é–≤–∞—Ç–∏ –ª—ñ–Ω—ñ—ó/–∫–º
  drawRulers(); updateRoute();
  document.getElementById('remoteRoutes').value = '';

  // ‚¨áÔ∏è –¥–æ–¥–∞–π —Ü—é —Å—Ç—Ä–æ–∫—É
  updateHighlights();
  setApprovalUI(null);

  // Canvas-–Ω—É–º–µ—Ä–∞—Ü—ñ—ó –±—ñ–ª—å—à–µ –Ω–µ–º–∞—î ‚Äî –ª–∏—à–µ–Ω–æ DOM‚Äë–º–∞—Ä–∫–µ—Ä–∏

  alert('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞');
}

/* ===== Panel toggle ===== */
const panelToggleBtn = document.getElementById('panelToggle');
function updatePanelToggleLabel(){
  const hidden = document.body.classList.contains('controls-hidden');
  const isMobile = window.matchMedia && window.matchMedia('(max-width: 1024px)').matches;
  panelToggleBtn.textContent = hidden
    ? (isMobile ? '‚ñ∂' : '‚ñ∂ –ü–∞–Ω–µ–ª—å')
    : (isMobile ? '‚óÄ' : '‚óÄ –°—Ö–æ–≤–∞—Ç–∏');
  if (typeof map?.resize === 'function') requestAnimationFrame(() => map.resize());
}
panelToggleBtn.addEventListener('click', () => {
  document.body.classList.toggle('controls-hidden'); updatePanelToggleLabel();
});
window.addEventListener('resize', () => updatePanelToggleLabel());
updatePanelToggleLabel();

/* ===== –ü—Ä–∏–º—É—Å–æ–≤–∏–π –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º (—Ç—É–º–±–ª–µ—Ä) ===== */
try{
  const compactBtn = document.getElementById('compactToggle');
  const applyCompact = () => {
    const forced = document.body.classList.contains('force-compact');
    if (compactBtn) compactBtn.setAttribute('aria-pressed', String(forced));
    // –æ–Ω–æ–≤–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å —Å—Ç—Ä—ñ–ª–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–µ–∂–∏–º—É
    try{ updatePanelToggleLabel(); }catch(_){ }
  };
  if (compactBtn){
    compactBtn.addEventListener('click', () => {
      document.body.classList.toggle('force-compact');
      applyCompact();
    });
  }
  applyCompact();
}catch(_){ }

/* ======== ‚¨áÔ∏è –ì–ï–û–ó–û–ù–ò –∑—ñ STORAGE (geozones/all.geojson) ========= */
const STORAGE_GEOJSON_PATH = 'geozones/all.geojson';
// –Ø–∫—â–æ –≥–µ–æ–∑–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò –≤ Mapbox tilesets ‚Äî –≤–∏–º–∫–Ω—ñ—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑—ñ Storage
const ENABLE_STORAGE_GEOZONES = false;
let geozonesDataCache = null;
let geozonesFitted = false;
let geoClickHandler = null;

function removeLayerIfExists(id){ try{ if(map.getLayer(id)) map.removeLayer(id); }catch{} }
function removeSourceIfExists(id){ try{ if(map.getSource(id)) map.removeSource(id); }catch{} }

function buildLabel(props){
  const { name, farm, client, code } = getFieldProps(props || {});
  const parts = [name, farm, client].filter(Boolean);
  return parts.length ? parts.join(' ‚Ä¢ ') : (code || '–ü–æ–ª–µ');
}
function normalizeGeoJSON(obj){
  if (!obj || !obj.features) return obj;
  return {
    type: 'FeatureCollection',
    features: obj.features.map(f=>{
      const p = f.properties || {};
      return { ...f, properties: { ...p, _label: buildLabel(p) } };
    })
  };
}

function geozoneCardHTML(props){
  const { client, code, name, farm, area } = getFieldProps(props || {});
  const row = (label, val) => (val || val === 0) ?
    `<div style="display:flex;justify-content:space-between;gap:10px;border-bottom:1px dashed #e5e7eb;padding:4px 0;">
       <div style="color:#6b7280">${label}</div>
       <div style="font-weight:600">${esc(val)}</div>
     </div>` : '';
  return `<div style="min-width:260px;font-size:13px;line-height:1.35">
    ${row('–ü–ª–æ—â–∞', (area || area === 0) ? (fmtArea(area) + ' –≥–∞') : '')}
    ${row('–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ', client)}
    ${row('–ö–æ–¥', code)}
    ${row('–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª', farm)}
    ${row('–ù–∞–∑–≤–∞', name)}
  </div>`;
}
function attachGeozoneHandlers(){
  const clickLayers = ['geozones-fill','geozones-outline','geozones-point','geozones-label'];

  // –ö–ª—ñ–∫ ‚Äî –ø–æ–∫–∞–∑—É—î –∫–∞—Ä—Ç–∫—É (–ø–∞—Å–ø–æ—Ä—Ç –ø–æ–ª—è)
  if (geoClickHandler){
    clickLayers.forEach(id => { try { map.off('click', id, geoClickHandler); } catch{} });
  }
  geoClickHandler = (e) => {
    const feat = e.features && e.features[0];
    if (!feat) return;
    new mapboxgl.Popup({ closeButton:true, closeOnClick:true, maxWidth:'480px' })
      .setLngLat(e.lngLat)
      .setHTML(geozoneCardHTML(feat.properties || {}))
      .addTo(map);
  };
  clickLayers.forEach(id => { if (map.getLayer(id)) map.on('click', id, geoClickHandler); });

  // üîé Hover (mousemove) ‚Äî —è–∫ —É tilesets: –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ "–ø—Ä–æ–∑–æ—Ä—ñ"
  ['geozones-fill','geozones-outline','geozones-point'].forEach(id => {
    if (BOUND_HOVER_LAYERS.has(id)) return;
    if (!map.getLayer(id)) return;
    map.on('mousemove',  id, onHover);
    map.on('mouseleave', id, onLeave);
    BOUND_HOVER_LAYERS.add(id);
  });
}

function addGeozones(obj){
  geozonesDataCache = normalizeGeoJSON(obj);
  // —á–∏—Å—Ç–∏–º–æ, —è–∫—â–æ –±—É–ª–∏
  removeLayerIfExists('geozones-label');
  removeLayerIfExists('geozones-point');
  removeLayerIfExists('geozones-outline');
  removeLayerIfExists('geozones-fill');
  removeSourceIfExists('geozones');

  map.addSource('geozones', { type:'geojson', data: geozonesDataCache });

  const isPoly = ['any',
    ['==', ['geometry-type'], 'Polygon'],
    ['==', ['geometry-type'], 'MultiPolygon']
  ];
  const isPoint = ['==', ['geometry-type'], 'Point'];

  map.addLayer({
    id:'geozones-fill', type:'fill', source:'geozones', filter:isPoly,
    paint:{ 'fill-color':'#22c55e', 'fill-opacity':0.18 }
  });

  map.addLayer({
    id:'geozones-outline', type:'line', source:'geozones', filter:isPoly,
    paint:{ 'line-color':'#16a34a', 'line-width':1.2 }
  });

  map.addLayer({
    id:'geozones-point', type:'circle', source:'geozones', filter:isPoint,
    paint:{ 'circle-radius':4, 'circle-color':'#f59e0b', 'circle-stroke-width':1, 'circle-stroke-color':'#fff' }
  });

  map.addLayer({
    id:'geozones-label', type:'symbol', source:'geozones',
    layout:{
      'text-field':['get','_label'],
      'text-size':12,
      'text-offset':[0,0.8],
      'text-allow-overlap':false,
      'text-anchor':'top'
    },
    paint:{
      'text-color':'#111',
      'text-halo-color':'#fff',
      'text-halo-width':1.2
    }
  });

    attachGeozoneHandlers();
  // üî¶ –ü—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞ GeoJSON –ø—ñ–¥—Å—Ç—Ä–∞—Ö—É—î–º–æ—Å—å —ñ –æ–Ω–æ–≤–∏–º–æ –ø—ñ–¥—Å–≤—ñ—Ç–∫—É
  ensureHighlightLayers();
  ensureHighlightLabelLayers();
  bindHighlightHoverHandlers();
  updateHighlights();
  setGeozonesVisibility(geozonesVisible);
}

function fitGeozones(){
  try{
    if (!geozonesDataCache || geozonesFitted === true || !window.turf) return;
    const b = turf.bbox(geozonesDataCache); // [minX, minY, maxX, maxY]
    if (!b || b.some(v=>!isFinite(v))) return;
    geozonesFitted = true;
    map.fitBounds([[b[0], b[1]],[b[2], b[3]]], { padding: 40, maxZoom: 14 });
  }catch(e){ console.warn('fitGeozones:', e?.message||e); }
}
async function loadGeozonesFromStorage(path = STORAGE_GEOJSON_PATH, force=false){
  // –ì–ª–æ–±–æ–≤–∏–π –≤–∏–º–∏–∫–∞—á: —è–∫—â–æ Storage-–≥–µ–æ–∑–æ–Ω–∏ –≤–∏–º–∫–Ω–µ–Ω—ñ ‚Äî —Ç–∏—Ö–æ –≤–∏—Ö–æ–¥–∏–º–æ
  if (!ENABLE_STORAGE_GEOZONES) {
    console.debug('[geozones] Storage disabled, skip load:', path);
    return;
  }
  try{
    if (!storage){ console.warn('Storage –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ'); return; }
    let url = await storage.ref(path).getDownloadURL();
    if (force) url += (url.includes('?')?'&':'?') + 'v=' + Date.now(); // bust cache
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const obj = await res.json();
    addGeozones(obj);
    fitGeozones();
    console.log('üåê GeoJSON –≥–µ–æ–∑–æ–Ω–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑—ñ Storage:', path);
  }catch(e){
    console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏ –∑—ñ Storage:', e?.message||e);
  }
}
/* ========= ‚¨ÜÔ∏è –ì–ï–û–ó–û–ù–ò ========= */

/* ===== Auth ===== */
const authHello = document.getElementById('authHello');
const authEmail = document.getElementById('authEmail');
const authPass  = document.getElementById('authPass');
const loginBtn  = document.getElementById('authLogin');
const logoutBtn  = document.getElementById('authLogout');

// üîß ROLE helpers
let roleUnsub = null;
async function fetchRoleFromServer(u){
  try{
    const snap = await db.collection('users').doc(u.uid).get({ source: 'server' });
    return snap.exists ? (snap.data().role || 'pending') : 'pending';
  }catch{ return 'pending'; }
}

document.getElementById('mobileAuthToggle').addEventListener('click', () => {
  document.getElementById('authBar').classList.toggle('collapsed');
  requestAnimationFrame(updateLayoutHeights);
});
loginBtn.onclick = async () => {
  try{ await auth.signInWithEmailAndPassword(authEmail.value.trim(), authPass.value); }
  catch(e){ alert('üö´ –í—Ö—ñ–¥ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ: ' + (e?.message || e)); }
};
logoutBtn.onclick = async () => {
  try{ await auth.signOut(); }
  finally{
    location.replace('/login.html?next=' + encodeURIComponent('/index.html'));
  }
};
auth?.onAuthStateChanged(async (user) => {
  if (user){
  window.__canHideSplash = true;
  hideSplash();          // ‚¨ÖÔ∏è —Ö–æ–≤–∞—î–º–æ —Å–ø–ª–µ—à —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    {
      const dn = (user && typeof user.displayName === 'string' && user.displayName.trim())
        ? user.displayName.trim()
        : (`–•—Ç–æ—Å—å –Ω–µ –º—ñ—Å—Ü–µ–≤–∏–π —ñ ${user.email || user.uid}`);
      authHello.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + dn;
    }
    loginBtn.style.display='none'; authEmail.style.display='none'; authPass.style.display='none';
    logoutBtn.style.display='inline-block';
    if (window.matchMedia('(max-width: 1024px)').matches || document.body.classList.contains('force-compact')) {
      document.getElementById('authBar').classList.add('collapsed');
    }
    requestAnimationFrame(updateLayoutHeights);

    // —Ä–æ–ª—å —ñ–∑ guard –∞–±–æ –Ω–∞–ø—Ä—è–º—É –∑ —Å–µ—Ä–≤–µ—Ä–∞ (—â–æ–± –Ω–µ ‚Äú–∑–∞–ª–∏–ø–∞–ª–æ‚Äù –Ω–∞ guest)
    let role = window.__userRole || 'pending';
if (!['admin','logist','user'].includes(role)) {
  role = await fetchRoleFromServer(user);
  window.__userRole = role;
}
// ‚úÖ –ø–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∞–ª—å–Ω—É —Ä–æ–ª—å, —É —Ç.—á. user (read-only)
applyRoleUI(['admin','logist','user'].includes(role) ? role : 'guest');
// ‚¨áÔ∏è –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
try {
  ALLOWED_HUBS = await getAllowedHubsForUser(user.uid, window.__userRole || role || 'user');
} catch (_) {
  ALLOWED_HUBS = [];
}
applyHubSelectVisibility();
// –Ø–∫—â–æ –Ω–µ–º–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∂–æ–¥–Ω–æ–≥–æ —Ö–∞–±—É ‚Äî –∑–∞–ª–æ—á–∏—Ç–∏ UI —ñ –ø–æ–∫–∞–∑–∞—Ç–∏ –±–∞–Ω–µ—Ä
if (hasNoHubs()) {
  (function lockUiForNoHub(){
    let b = document.getElementById('noHubBanner');
    if (!b){
      b = document.createElement('div');
      b.id = 'noHubBanner';
      b.style.cssText = 'position:absolute;left:50%;top:12px;transform:translateX(-50%);background:#fee2e2;color:#b91c1c;padding:8px 16px;border:1px solid #fecaca;border-radius:10px;font-size:14px;z-index:1200;box-shadow:0 2px 6px rgba(0,0,0,.08);';
      b.textContent = '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∂–æ–¥–Ω–æ–≥–æ —Ö–∞–±—É. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.';
      document.body.appendChild(b);
    }
    b.style.display='block';
    const ids = [
      'fromName','toName','routeType','routePurpose','intermediateText','logistInput','hubSelect',
      'toggleAdd','startLineMode','endLineMode','clearRoute','clearRulers','popRulerPoint','toggleMarkers',
      'findSimilarBtn','saveRoute','loadRoute','saveRouteKml','loadRouteKml','saveToDB','deleteFromDB',
      'refreshDirectory','refreshList','loadMoreRoutes','loadAllRoutes','loadFromDB'
    ];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.disabled=true; el.classList.add('muted'); }});
    try{ geozonesVisible=false; setGeozonesVisibility(false); updateGeozonesToggleLabel(); }catch(_){ }
  })();
} else {
  const b = document.getElementById('noHubBanner'); if (b) b.style.display='none';
}

// –ü–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫ –ø—ñ–¥ –¥–æ—Å—Ç—É–ø–∏ (–±–µ–∑ force ‚Äî —Å–ø—Ä–æ–±—É—î –∫–µ—à)
if (!DIR_LOADED_ONCE) {
  await loadDirectory(false);
  DIR_LOADED_ONCE = true;
}
// –ü—ñ—Å–ª—è —Ç–æ–≥–æ —è–∫ –≤—ñ–¥–æ–º—ñ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏ ‚Äî —Å—Ö–æ–≤–∞—Ç–∏ —á—É–∂—ñ tileset-–∏
applyTilesetHubVisibilitySafe();
// –Ü –ø–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω—É –≤–∏–¥–∏–º—ñ—Å—Ç—å, —â–æ–± —É—Å–µ –±—É–ª–æ —É–∑–≥–æ–¥–∂–µ–Ω–æ
setGeozonesVisibility(geozonesVisible);

// üîî –ì–ª–æ–±–∞–ª—å–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑–∞ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–º–∏ —Ö–∞–±–∞–º–∏
try{ subscribeToGlobalNotifications(); }catch(_){ }

    // live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ (–ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ users/{uid})
    if (roleUnsub) try{ roleUnsub(); }catch{}
    const ALLOWED = new Set(['admin','logist','user']);

roleUnsub = db.collection('users').doc(user.uid)
  .onSnapshot((doc) => {
    const r = doc.exists ? (String(doc.data().role || 'pending').toLowerCase()) : 'pending';
    window.__userRole = r;
    applyRoleUI(ALLOWED.has(r) ? r : 'guest'); // ‚úÖ 'user' –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ read-only
  });

    await loadLogists(true);
    // –í—ñ–¥–∫–ª–∞—Å—Ç–∏, —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ –ø–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä UI/–∫–∞—Ä—Ç–∏ ‚Äî –ª–∏—à–µ —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ Storage-–≥–µ–æ–∑–æ–Ω–∏
    if (ENABLE_STORAGE_GEOZONES) {
      (window.requestIdleCallback ? window.requestIdleCallback : setTimeout)(() => {
        loadGeozonesFromStorage(STORAGE_GEOJSON_PATH, true);
      });
    } else {
      console.log('GeoJSON –∑—ñ Storage –≤–∏–º–∫–Ω–µ–Ω–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–∏—à–µ Mapbox Tilesets');
    }

  } else {
  // –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–º —Å–ø–ª–µ—à –Ω–µ –∑–Ω—ñ–º–∞—î–º–æ –¥–æ —Ä–µ–¥—ñ—Ä–µ–∫—Ç—É –Ω–∞ /login.html
  window.__canHideSplash = false;
    if (roleUnsub) try{ roleUnsub(); }catch{}
    authHello.textContent = '–ì—ñ—Å—Ç—å';
    loginBtn.style.display='inline-block'; authEmail.style.display='inline-block'; authPass.style.display='inline-block';
    logoutBtn.style.display='none';
    requestAnimationFrame(updateLayoutHeights);
    applyRoleUI('guest');
    await loadLogists(false);
  }
});

/* ===== Start ===== */
window.addEventListener('load', async () => {
  if (!db) return;
  if (!DIR_LOADED_ONCE) {      // —Ç—ñ–ª—å–∫–∏ –∫–µ—à, –±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ fetch
    await loadDirectory(false);
    DIR_LOADED_ONCE = true;
  }
  const rid = new URLSearchParams(location.search).get('rid');
  const showProp = new URLSearchParams(location.search).get('showProposal');
  if (rid) {
    // –î–ª—è –ª–æ–≥—ñ—Å—Ç–∞ ensureRoutesLoaded –º–æ–∂–µ –≤–ø–∞—Å—Ç–∏ –Ω–∞ –ø—Ä–∞–≤–∞–ª–∞—Ö (—à–∏—Ä–æ–∫–∏–π –∑–∞–ø–∏—Ç –±–µ–∑ —Ñ—ñ–ª—å—Ç—Ä—É –ø–æ —Ö–∞–±–∞—Ö)
    // –ù–µ –±–ª–æ–∫—É—î–º–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–∞—Ä—à—Ä—É—Ç—É –∑–∞ –ø—Ä—è–º–∏–º ID ‚Äî –ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ –ø–æ–ø—Ä–∏ –ø–æ–º–∏–ª–∫—É —Å–ø–∏—Å–∫—É
    try { await ensureRoutesLoaded(); } catch (e) { console.warn('ensureRoutesLoaded skipped:', e?.message||e); }
    await loadRouteById(rid);
    if (String(showProp||'').toLowerCase() === '1' || String(showProp||'').toLowerCase() === 'true'){
      try{ setProposalVisibility(true); }catch(_){ }
    }
  }
  requestAnimationFrame(updateLayoutHeights);
});

document.getElementById('logistInput').addEventListener('focus', function(){
  const isLogged = !!(auth && auth.currentUser);
  loadLogists(isLogged);
  try { this.dispatchEvent(new KeyboardEvent('keydown', {key:'ArrowDown'})); } catch {}
});

// –æ–¥–Ω–µ –º—ñ—Å—Ü–µ, —è–∫–µ –æ–Ω–æ–≤–ª—é—î –Ω–∞–∑–≤—É –º–∞—Ä—à—Ä—É—Ç—É + –ø—ñ–¥—Å–≤—ñ—Ç–∫—É
const onFromToChange = () => {
  updateRouteName();
  updateHighlights();                 // –æ–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏
  setGeozonesVisibility(geozonesVisible); // —ñ –æ–¥—Ä–∞–∑—É –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ "—Ä–æ–∑—É–º–Ω—É" –≤–∏–¥–∏–º—ñ—Å—Ç—å
};

// —Ä–µ–∞–≥—É—î–º–æ —ñ –Ω–∞ input (–∫–æ–ª–∏ —Ç–∏ —Å—Ç–∏—Ä–∞—î—à —Ç–µ–∫—Å—Ç), —ñ –Ω–∞ change (–∫–æ–ª–∏ –ø–æ–ª–µ –≤—Ç—Ä–∞—Ç–∏–ª–æ —Ñ–æ–∫—É—Å)
['input','change'].forEach(ev => {
  document.getElementById('fromName').addEventListener(ev, onFromToChange);
  document.getElementById('toName').addEventListener(ev,   onFromToChange);
});
// ‚¨áÔ∏è –î–û–î–ê–ô –¶–ï (—É–≤—ñ–º–∫–Ω—É—Ç–∏ typeahead)
attachTypeahead('fromName');
attachTypeahead('toName');

document.getElementById('routeType').addEventListener('change', updateRouteName);
document.getElementById('routePurpose').addEventListener('change', updateRouteName);

// –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç—ñ–º
async function backfillRoutes(){
  const ref = firebase.firestore().collection('routes');
  let snap = await ref.limit(500).get();
  let done = 0;

  while (!snap.empty) {
    const batch = firebase.firestore().batch();
    snap.docs.forEach(doc => {
      const d = doc.data() || {};
      const name      = d.name || '';
      const fromLabel = d.fromLabel || '';
      const toLabel   = d.toLabel   || '';
      const searchText= [name, fromLabel, toLabel].filter(Boolean).join(' | ');

      batch.set(doc.ref, {
        nameLower:        (name||'').toLowerCase(),
        fromLabelLower:   (fromLabel||'').toLowerCase(),
        toLabelLower:     (toLabel||'').toLowerCase(),
        nameNgrams:       trigrams(name),
        fromNgrams:       trigrams(fromLabel),
        toNgrams:         trigrams(toLabel),
        searchNgrams:     trigrams(searchText),
        updatedAt:        new Date().toISOString()
      }, { merge:true });
    });
    await batch.commit();
    done += snap.size;
    const last = snap.docs[snap.docs.length-1];
    snap = await ref.startAfter(last).limit(500).get();
  }
  console.log('Backfill done:', done);
}

</script>
</body>
</html>