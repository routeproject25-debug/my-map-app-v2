<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üöö–ú–∞—Ä—à—Ä—É—Ç–∏ Mapbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
  :root { --nav-h:56px; --nav-real:56px; --card:#fff; --line:#e5e7eb; --muted:#6b7280; }

  /* base */
  *{box-sizing:border-box}
  body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  /* top bar */
  header.topbar{
    position:sticky; top:0; z-index:5000; min-height:var(--nav-h);
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px;
    background:#2563eb; color:#fff;
  }
  header.topbar a{ color:#fff; text-decoration:none; margin-right:12px; white-space:nowrap; }
  header .left, header .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  header .spacer{ flex:1 1 auto; }

  /* auth bar */
  #authBar{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  #authBar input{
    height:34px; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.15); color:#fff; outline:none; width:180px;
  }
  #authBar input::placeholder{ color:rgba(255,255,255,.85) }
  #authBar input[type="password"]{ width:120px }
  #authBar .chip{
    font-size:12px; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3);
    border-radius:999px; padding:4px 10px; white-space:nowrap;
  }
  #authBar .btn{
    height:34px; padding:0 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
    background:#fff; color:#111; cursor:pointer; touch-action:manipulation;
  }

  /* mobile auth toggle */
  #mobileAuthToggle{ display:none; }
  @media (max-width: 640px){
    #mobileAuthToggle{
      display:inline-flex; align-items:center; justify-content:center;
      height:34px; padding:0 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
      background:#fff; color:#111; cursor:pointer;
    }
    #authBar.collapsed input,
    #authBar.collapsed #authLogin,
    #authBar.collapsed #authLogout{ display:none !important; }
  }

  /* map */
  #map{position:absolute; top:var(--nav-real); bottom:0; width:100%}

  /* side panel */
  #controls{
    position:absolute; z-index:3000; top:calc(var(--nav-real) + 8px); left:8px;
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 1px 8px rgba(0,0,0,.12); padding:12px;
    max-width:380px; max-height:90vh; overflow-y:auto; overflow-x:hidden;
  }
  .controls-hidden #controls{ display:none }

  #controls .row>*{min-width:0}
  #controls input[type=text], #controls select, #controls textarea{
    width:100%; max-width:100%; padding:9px 11px; font-size:14px;
    border:1px solid var(--line); border-radius:10px; outline:none;
  }
  #controls textarea{min-height:48px; resize:vertical}
  label{display:block;font-size:13px;color:#444;margin:2px 0 6px}
  small.muted{color:#6b7280}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:420px){ .row{grid-template-columns:1fr} }

  .btn{
    cursor:pointer;border:1px solid var(--line);background:#fff;border-radius:10px;
    padding:8px 12px;font-size:14px; line-height:1.2; touch-action:manipulation;
  }
  .btn.xs{ padding:8px 12px; font-size:14px }
  .btn.active{background:#e6f4ea;border-color:#22c55e}

  .panel-head{display:grid;gap:10px;margin-bottom:8px}
  .segment{display:flex;gap:6px;flex-wrap:wrap}
  .btn-row{display:flex;gap:6px;flex-wrap:wrap}

  @media (max-width: 640px){
    #controls{ left:8px; right:8px; max-width:unset; width:auto; }
    .segment, .btn-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .btn, .btn.xs{ min-height:44px; font-size:15px; padding:10px 12px; }
    .km-chip{ font-size:13px; padding:6px 10px; }
  }

  .km-chip{margin-top:2px;font-size:12.5px;color:#111;background:#f3f4f6;
           border:1px solid var(--line);border-radius:999px;display:inline-block;
           padding:4px 10px;width:max-content}

  .section{border-top:1px dashed var(--line);padding-top:8px;margin-top:8px}
  details>summary{cursor:pointer;font-weight:700;margin:4px 0}
  #dbControls{margin-top:10px;padding-top:10px;border-top:1px dashed var(--line)}
  #dbControls input,#dbControls select{margin:5px 0}

  #contextMenu{position:absolute;background:#fff;border:1px solid #ccc;display:none;z-index:3500;
               box-shadow:0 2px 6px rgba(0,0,0,.15)}
  #contextMenu div{padding:6px 10px;cursor:pointer}
  #contextMenu div:hover{background:#f3f4f6}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000}
  .modal.show{display:flex}
  .modal-box{background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; width:min(440px,92vw); box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-weight:700; margin-bottom:6px}
  .modal-body{color:#374151; font-size:14px; margin-bottom:10px; white-space:pre-line}
  .modal-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .modal-actions .btn{min-width:140px}

  .mapboxgl-canvas{z-index:0!important}
  .mapboxgl-control-container{z-index:1!important}
  .mapboxgl-marker{z-index:2!important}

  #logistsMsg{display:none;font-size:12px;color:#b91c1c;margin-top:4px}
  </style>
</head>
<body>

<header class="topbar">
  <div class="left">
    <button id="panelToggle" class="btn xs" title="–°—Ö–æ–≤–∞—Ç–∏/–ø–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å">‚óÄ –°—Ö–æ–≤–∞—Ç–∏</button>
    <!-- CHANGED: —Ä–æ–±–∏–º–æ –≤—ñ–¥–Ω–æ—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è -->
    <a href="./">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="./export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <a href="./import/">üì• –Ü–º–ø–æ—Ä—Ç</a>
  </div>

  <div class="spacer"></div>

  <div id="authBar" class="right collapsed">
    <span id="authHello" class="chip">–ì—ñ—Å—Ç—å</span>
    <span id="roleChip" class="chip">–†–æ–ª—å: ‚Äì</span>

    <input id="authEmail" type="text" placeholder="email (–Ω–∞–ø—Ä–∏–∫–ª. user@demo.fake)" autocomplete="username">
    <input id="authPass"  type="password" placeholder="–ø–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button id="authLogin"  class="btn">–£–≤—ñ–π—Ç–∏</button>
    <button id="authLogout" class="btn" style="display:none">–í–∏–π—Ç–∏</button>
  </div>

  <button id="mobileAuthToggle" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –≤—Ö—ñ–¥">üîê –í—Ö—ñ–¥</button>
</header>

<div id="controls">
  <div class="panel-head">
    <div class="segment">
      <button id="toggleAdd" class="btn xs">–ú–∞—Ä—à—Ä—É—Ç</button>
      <button id="startLineMode" class="btn xs" title="–î–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">–õ—ñ–Ω—ñ–π–∫–∞(–ø–æ—á.)</button>
      <button id="endLineMode" class="btn xs" title="–î–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –∫—ñ–Ω—Ü–µ–≤–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">–õ—ñ–Ω—ñ–π–∫–∞(–∫—ñ–Ω.)</button>
    </div>

    <div class="btn-row">
      <button id="clearRoute" class="btn xs">–û—á–∏—Å—Ç. –º–∞—Ä—à.</button>
      <button id="popRulerPoint" class="btn xs" title="–í–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é —Ç–æ—á–∫—É –∞–∫—Ç–∏–≤–Ω–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">‚Üê –û—Å—Ç–∞–Ω–Ω—è —Ç–æ—á–∫–∞ (–ª—ñ–Ω.)</button>
      <button id="clearRulers" class="btn xs" title="–û—á–∏—Å—Ç–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É –ª—ñ–Ω—ñ–π–∫—É, –∞–±–æ –æ–±–∏–¥–≤—ñ —è–∫—â–æ —Ä–µ–∂–∏–º –ª—ñ–Ω—ñ–π–∫–∏ –≤–∏–º–∫–Ω–µ–Ω–æ">–û—á–∏—Å—Ç. –ª—ñ–Ω.</button>
      <button id="toggleMarkers" class="btn xs">üìç –¢–æ—á–∫–∏</button>
    </div>

    <div class="btn-row">
      <button id="saveRoute" class="btn xs">üíæ Route JSON</button>
      <button id="loadRoute" class="btn xs">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
      <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>

    <div class="km-chip">–∫–º: <span id="distance">0</span></div>
    <div class="km-chip">
      —Ç–æ—á–∫–∏: <span id="countRoute">0</span> ‚Ä¢
      –ª—ñ–Ω(–ø–æ—á): <span id="countStart">0</span> ‚Ä¢
      –ª—ñ–Ω(–∫—ñ–Ω): <span id="countEnd">0</span> ‚Ä¢
      –≤—Å—å–æ–≥–æ: <span id="countTotal">0</span>
    </div>
  </div>

  <hr/>
  <div class="row">
    <div>
      <label>–í—ñ–¥</label>
      <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
    </div>
    <div>
      <label>–î–æ</label>
      <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
    </div>
  </div>
  <datalist id="directoryList"></datalist>

  <div class="row" style="margin-top:6px;">
    <div>
      <label>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç—É</label>
      <select id="routeType">
        <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
      </select>
    </div>
    <div>
      <label>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</label>
      <select id="routePurpose">
        <option value="–ó–µ—Ä–Ω–æ" selected>–ó–µ—Ä–Ω–æ</option>
        <option value="–û–î">–û–î</option>
        <option value="–¢–ú–¶">–¢–ú–¶</option>
      </select>
    </div>
    <div style="grid-column:1 / -1">
      <label>–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏</label>
      <input id="intermediateText" type="text" placeholder="–ù–∞–ø—Ä.: –ù–µ–º–∏—Ä—ñ–≤; –ì–∞–π—Å–∏–Ω; –¢—É–ª—å—á–∏–Ω">
    </div>
  </div>

  <!-- –õ–û–ì–Ü–°–¢ -->
  <div class="row" style="margin-top:6px;">
    <div style="grid-column:1 / -1">
      <label>–õ–æ–≥—ñ—Å—Ç (—Ö—Ç–æ —Å—Ç–≤–æ—Ä—é—î)</label>
      <input id="logistInput" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –ø—Ä—ñ–∑–≤–∏—â–µ..." list="logistsList" autocomplete="off">
      <datalist id="logistsList"></datalist>
      <small class="muted">–°–ø–∏—Å–æ–∫ –±–µ—Ä–µ—Ç—å—Å—è –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó <b>logists</b> (–∞–∫—Ç–∏–≤–Ω—ñ). –û–±–µ—Ä–∏ —Å–µ–±–µ –∑—ñ —Å–ø–∏—Å–∫—É.</small>
      <div id="logistsMsg"></div>
    </div>
  </div>

  <small class="muted">–£ –ë–î –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è <b>–∫–æ–¥–∏</b> ‚Äú–í—ñ–¥/–î–æ‚Äù. –ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑ –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –Ω–∞–∑–≤ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.</small>

  <details>
    <summary><b>–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏</b></summary>
    <div id="styleSelector" style="margin-top:10px;">
      <label for="mapStyle">–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏:</label>
      <select id="mapStyle">
        <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
        <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
        <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
        <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
        <option value="mapbox://styles/mapbox/light-v11">Light</option>
        <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
        <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
        <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
        <option value="mapbox://styles/tkchk/cmdzvf97b00vq01qscpgsf1jt">map</option>
      </select>
    </div>
  </details>

  <div id="dirControls" class="section">
    <div class="btn-row">
      <button id="refreshDirectory" class="btn xs">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫</button>
      <button id="clearDirCache" class="btn xs">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à</button>
    </div>

    <div class="btn-row" style="margin-top:6px;">
      <button id="refreshLogists" class="btn xs">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤</button>
      <button id="clearLogistsCache" class="btn xs">üßπ –ö–µ—à –ª–æ–≥—ñ—Å—Ç—ñ–≤</button>
    </div>
    <small class="muted">–î–∞–Ω—ñ –ª–æ–≥—ñ—Å—Ç—ñ–≤ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∑ Firestore. –ê–¥–º—ñ–Ω –∑–º—ñ–Ω—é—î —ó—Ö —É –∫–æ–ª–µ–∫—Ü—ñ—ó <b>logists</b>.</small>
  </div>

  <div id="dbControls">
    <div><strong>–ë–∞–∑–∞ (Firestore)</strong></div>
    <input id="routeName" type="text" placeholder="–ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É (–∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏)" />
    <button id="saveToDB" class="btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î</button>
    <br/>
    <input id="routeSearch" type="text" placeholder="üîé –ü–æ—à—É–∫ –º–∞—Ä—à—Ä—É—Ç—É..." list="routesList" autocomplete="off" />
    <datalist id="routesList"></datalist>
    <select id="remoteRoutes" style="min-width:260px">
      <option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>
    </select>
    <div class="btn-row" style="margin-top:6px;">
      <button id="refreshList" class="btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
      <button id="loadFromDB" class="btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ –ë–î</button>
      <button id="deleteFromDB" class="btn">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –ë–î</button>
      <button id="clearForm" class="btn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
    </div>
  </div>
</div>

<div id="map"></div>

<div id="contextMenu">
  <div id="insertAfter">‚ûï–í—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ—Å–ª—è</div>
  <div id="deletePoint">‚ùå–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É</div>
</div>

<div id="dupModal" class="modal" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="dupTitle">
    <div id="dupTitle" class="modal-title">–ú–∞—Ä—à—Ä—É—Ç –≤–∂–µ —ñ—Å–Ω—É—î</div>
    <div class="modal-body">
      <div id="dupText"></div>
    </div>
    <div class="modal-actions">
      <button id="dupOverwrite" class="btn">–û–∫ ‚Äî –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏</button>
      <button id="dupCopy" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–ø—ñ—é</button>
      <button id="dupCancel" class="btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<!-- ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è AUTH GUARD: —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –Ω–∞ login -->
<script>
(function(){
  // —Å—Ö–æ–≤–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —â–æ–± –Ω–µ –º–∏–≥–æ—Ç—ñ–ª–∞ –Ω–µ–∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∞
  document.documentElement.style.visibility = 'hidden';

  const firebaseConfig = {
    apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
    authDomain: "my-map-app-58312.firebaseapp.com",
    projectId: "my-map-app-58312",
    storageBucket: "my-map-app-58312.firebasestorage.app",
    messagingSenderId: "53260611353",
    appId: "1:53260611353:web:f25e120996ad8305405f88",
    measurementId: "G-9LRX1FLTKL"
  };

  try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig); } catch(e) {}

  const auth = firebase.auth();

  // CHANGED: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ª–æ–≥—ñ–Ω—É
  // —è–∫—â–æ —É —Ç–µ–±–µ –ª–æ–≥—ñ–Ω —É –∫–æ—Ä–µ–Ω—ñ —è–∫ login.html ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–º—ñ–Ω–∏ —Ä—è–¥–æ–∫ –Ω–∏–∂—á–µ –Ω–∞ './login.html'
  const LOGIN_PATH = './login.html';              // ‚Üê –±—É–ª–æ ./login/index.html
const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);

  auth.onAuthStateChanged(u => {
    if (!u) { location.href = loginURL; return; } // CHANGED: href –∑–∞–º—ñ—Å—Ç—å replace
    document.documentElement.style.visibility = '';
  });
})();
</script>
<!-- ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è AUTH GUARD -->

<script>
/* ===================== Mapbox init ===================== */
mapboxgl.accessToken = 'pk.eyJ1IjoidGtjaGsiLCJhIjoiY21keTN0bXVlMjN6djJrczZ2NDk5bXRoMiJ9.6n1kuiUJ3EdGUpz5I6-wdg';
let currentStyle = 'mapbox://styles/mapbox/streets-v12';
const map = new mapboxgl.Map({ container: 'map', style: currentStyle, center: [30.5238, 50.4547], zoom: 10 });

/* === –î–∏–Ω–∞–º—ñ—á–Ω–∞ –≤–∏—Å–æ—Ç–∞ —à–∞–ø–∫–∏ === */
const topbarEl = document.querySelector('header.topbar');
function updateLayoutHeights(){
  const h = (topbarEl?.offsetHeight || 56);
  document.documentElement.style.setProperty('--nav-real', h + 'px');
  try { map.resize(); } catch(_) {}
}
window.addEventListener('resize', updateLayoutHeights);
updateLayoutHeights();

/* === –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –ø—ñ–¥–ø–∏—Å–∏ === */
function applyUkrainianLabels(){
  const style = map.getStyle();
  if (!style || !style.layers) return;
  const ukTextExpr = [
    'coalesce',['get','name_uk'],['get','name:uk'],['get','name_ua'],['get','name:ua'],['get','name_local'],['get','name']
  ];
  style.layers.forEach(l => {
    if (l.type === 'symbol') {
      const hasTextField = map.getLayoutProperty(l.id, 'text-field') !== undefined;
      if (hasTextField) { try { map.setLayoutProperty(l.id, 'text-field', ukTextExpr); } catch(_) {} }
    }
  });
}

let addMode = false, startLineMode = false, endLineMode = false;
let insertAfterMode = false;
let points = [], markers = [], startRuler = [], endRuler = [], rulerLines = [], routeLayers = [];
let selectedMarkerIndex = null;

let activeRuler = null; let lastActiveRuler = null;
function setActiveRuler(which){ activeRuler = which; if (which) lastActiveRuler = which; }

/* ====== Roles ====== */
let currentRole = 'guest';
let readOnly    = true;

function applyRoleUI(role){
  currentRole = role || 'guest';
  readOnly = (currentRole === 'guest' || currentRole === 'user');

  const disableIds = [
    'toggleAdd','startLineMode','endLineMode','clearRoute','popRulerPoint','clearRulers',
    'saveRoute','loadRoute','saveToDB','deleteFromDB','routeName',
    'fromName','toName','routeType','routePurpose','intermediateText'
  ];
  disableIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
      el.disabled = readOnly;
    } else {
      el.disabled = readOnly;
      el.classList.toggle('muted', readOnly);
    }
  });

  document.getElementById('loadFromDB').disabled = false;
  document.getElementById('refreshList').disabled = false;
  document.getElementById('remoteRoutes').disabled = false;
  document.getElementById('routeSearch').disabled = false;

  document.getElementById('roleChip').textContent = '–†–æ–ª—å: ' + (currentRole || '‚Äì');
}

/* ===== Context menu ===== */
const contextMenu = document.getElementById('contextMenu');
const insertAfterBtn = document.getElementById('insertAfter');
const deletePointBtn = document.getElementById('deletePoint');

insertAfterBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) insertAfterMode = true;
  contextMenu.style.display = 'none';
};
deletePointBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) {
    points.splice(selectedMarkerIndex, 1);
    rebuildMarkers();
  }
  contextMenu.style.display = 'none';
  selectedMarkerIndex = null;
};
document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

map.on('style.load', () => { applyUkrainianLabels(); updateRoute(); drawRulers(); });
document.getElementById('mapStyle').addEventListener('change', function() {
  currentStyle = this.value; map.setStyle(currentStyle);
});

/* ===== Buttons state ===== */
function toggleButton(id, flag) {
  const btn = document.getElementById(id);
  btn.textContent = btn.textContent.split(':')[0] + `: ${flag ? '–£–í–Ü–ú–ö–ù–ï–ù–û.' : '–í–ò–ú–ö–ù–ï–ù–û.'}`;
  if (flag) btn.classList.add('active'); else btn.classList.remove('active');
}

document.getElementById('toggleAdd').onclick = () => {
  if (readOnly) return;
  addMode = !addMode; startLineMode = false; endLineMode = false; insertAfterMode = false;
  setActiveRuler(null);
  toggleButton('toggleAdd', addMode); toggleButton('startLineMode', false); toggleButton('endLineMode', false);
};
document.getElementById('startLineMode').onclick = () => {
  if (readOnly) return;
  startLineMode = !startLineMode; endLineMode = false; addMode = false; insertAfterMode = false;
  setActiveRuler(startLineMode ? 'start' : null);
  toggleButton('startLineMode', startLineMode); toggleButton('endLineMode', false); toggleButton('toggleAdd', false);
};
document.getElementById('endLineMode').onclick = () => {
  if (readOnly) return;
  endLineMode = !endLineMode; startLineMode = false; addMode = false; insertAfterMode = false;
  setActiveRuler(endLineMode ? 'end' : null);
  toggleButton('endLineMode', endLineMode); toggleButton('startLineMode', false); toggleButton('toggleAdd', false);
};

document.getElementById('popRulerPoint').onclick = () => {
  if (readOnly) return;
  const choose = () => activeRuler || lastActiveRuler || (startRuler.length >= endRuler.length ? 'start' : 'end');
  let target = choose();
  if (target === 'start' && startRuler.length === 0 && endRuler.length > 0) target = 'end';
  if (target === 'end' && endRuler.length === 0 && startRuler.length > 0) target = 'start';
  let did = false;
  if (target === 'start' && startRuler.length) { startRuler.pop(); did = true; }
  if (target === 'end' && endRuler.length) { endRuler.pop(); did = true; }
  if (did){ drawRulers(); updateRoute(); }
};

document.getElementById('clearRulers').onclick = () => {
  if (readOnly) return;
  if (activeRuler === 'start') { startRuler = []; }
  else if (activeRuler === 'end') { endRuler = []; }
  else {
    if (!startRuler.length && !endRuler.length) return;
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –æ–±–∏–¥–≤—ñ –ª—ñ–Ω—ñ–π–∫–∏?')) return;
    startRuler = []; endRuler = [];
  }
  drawRulers(); updateRoute();
};

document.getElementById('clearRoute').onclick = () => {
  if (readOnly) return;
  points = []; markers.forEach(m => m.remove()); markers = [];
  clearRouteLayers(); updateRoute();
};

/* ===== Map click ===== */
map.on('click', (e) => {
  const lngLat = [e.lngLat.lng, e.lngLat.lat];
  contextMenu.style.display = 'none';
  if (readOnly) return;

  if (insertAfterMode && selectedMarkerIndex !== null) {
    points.splice(selectedMarkerIndex + 1, 0, lngLat);
    insertAfterMode = false; rebuildMarkers(); return;
  }
  if (startLineMode) { startRuler.push(lngLat); setActiveRuler('start'); drawRulers(); updateRoute(); return; }
  if (endLineMode)   { endRuler.push(lngLat); setActiveRuler('end');   drawRulers(); updateRoute(); return; }
  if (addMode)       { points.push(lngLat); addMarker(lngLat); updateRoute(); }
});

function addMarker(lngLat, index = points.length - 1) {
  const marker = new mapboxgl.Marker({ draggable: !readOnly }).setLngLat(lngLat).addTo(map);
  marker.getElement().addEventListener('contextmenu', (e) => {
    e.preventDefault(); e.stopPropagation();
    if (readOnly) return;
    selectedMarkerIndex = index;
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top  = e.pageY + 'px';
    contextMenu.style.display = 'block';
  });
  marker.on('dragend', () => {
    if (readOnly) return;
    const ll = marker.getLngLat();
    points[index] = [ll.lng, ll.lat];
    updateRoute();
  });
  markers.push(marker);
}

function rebuildMarkers() {
  markers.forEach(m => m.remove()); markers = [];
  points.forEach((pt, idx) => addMarker(pt, idx));
  selectedMarkerIndex = null; insertAfterMode = false; contextMenu.style.display = 'none';
  updateRoute();
}

let markersVisible = true;
document.getElementById('toggleMarkers').onclick = () => {
  markersVisible = !markersVisible;
  markers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
  document.getElementById('toggleMarkers').textContent = markersVisible ? 'üìç –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–æ—á–∫–∏' : 'üìç –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–∫–∏';
};

/* ===== Rulers (draw + distance) ===== */
function drawRulers() {
  rulerLines.forEach(id => { if (map.getLayer(id)) map.removeLayer(id); if (map.getSource(id)) map.removeSource(id); });
  rulerLines = [];
  drawRulerSegment(startRuler, 'start', '#0066ff');
  drawRulerSegment(endRuler, 'end', '#33cc33');
}
function drawRulerSegment(ruler, prefix, color) {
  for (let i = 0; i < ruler.length - 1; i++) {
    const lineId = `${prefix}-ruler-${i}`;
    const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: [ruler[i], ruler[i + 1]] } };
    map.addSource(lineId, { type: 'geojson', data: geojson });
    map.addLayer({ id: lineId, type: 'line', source: lineId,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 4, 'line-dasharray': [1, 2] } });
    rulerLines.push(lineId);
  }
}

/* Haversine fallback */
function haversineKm(a, b){
  const toRad = d => d * Math.PI / 180;
  const [lng1, lat1] = a, [lng2, lat2] = b;
  const R = 6371;
  const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const h = s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function calculateRulerDistance(ruler) {
  if (!Array.isArray(ruler) || ruler.length < 2) return 0;
  let dist = 0;
  if (window.turf && typeof turf.distance === 'function'){
    for (let i = 0; i < ruler.length - 1; i++) {
      dist += turf.distance(turf.point(ruler[i]), turf.point(ruler[i + 1]), { units: 'kilometers' });
    }
  } else {
    for (let i = 0; i < ruler.length - 1; i++) { dist += haversineKm(ruler[i], ruler[i + 1]); }
  }
  return dist;
}

/* ===== –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ ===== */
function updateCounters(){
  const routeCount = points.length;
  const startCount = startRuler.length;
  const endCount   = endRuler.length;
  const total      = routeCount + startCount + endCount;
  const byId = id => document.getElementById(id);
  byId('countRoute').textContent = routeCount;
  byId('countStart').textContent = startCount;
  byId('countEnd').textContent   = endCount;
  byId('countTotal').textContent = total;
}

/* ===== Route rendering ===== */
function splitIntoChunks(array, chunkSize) {
  const chunks = [];
  for (let i = 0; i < array.length - 1; i += chunkSize - 1) {
    const chunk = array.slice(i, i + chunkSize);
    if (chunk.length >= 2) chunks.push(chunk);
  }
  return chunks;
}

function clearRouteLayers() {
  routeLayers.forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
    if (map.getSource(id)) map.removeSource(id);
  });
  routeLayers = [];
}

async function updateRoute() {
  if (points.length < 2) {
    document.getElementById('distance').textContent =
      (calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler)).toFixed(2);
    updateCounters(); clearRouteLayers(); return;
  }
  const chunks = splitIntoChunks(points, 20);
  let totalDistance = 0;
  clearRouteLayers();

  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];
    const coordsStr = chunk.map(p => p.join(',')).join(';');
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.routes && data.routes[0]) {
        const route = data.routes[0];
        totalDistance += route.distance;
        const layerId = `route-part-${i}`;
        map.addSource(layerId, { type: 'geojson', data: { type: 'Feature', geometry: route.geometry } });
        map.addLayer({
          id: layerId, type: 'line', source: layerId,
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': `hsl(${(i * 60) % 360}, 100%, 50%)`, 'line-width': 5 }
        });
        routeLayers.push(layerId);
      }
    } catch (e) { console.error('–ü–æ–º–∏–ª–∫–∞ –º–∞—Ä—à—Ä—É—Ç—É:', e); }
  }

  totalDistance = (totalDistance / 1000) + calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler);
  document.getElementById('distance').textContent = totalDistance.toFixed(2);
  updateCounters();
}

/* turf */
const turfScript = document.createElement('script');
turfScript.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js';
turfScript.onload = () => { updateRoute(); };
document.head.appendChild(turfScript);

/* ===================== Firebase ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
  authDomain: "my-map-app-58312.firebaseapp.com",
  projectId: "my-map-app-58312",
  storageBucket: "my-map-app-58312.firebasestorage.app",
  messagingSenderId: "53260611353",
  appId: "1:53260611353:web:f25e120996ad8305405f88",
  measurementId: "G-9LRX1FLTKL"
};

let db = null, auth = null;
try {
  const fbApp = firebase.apps && firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  console.log('‚úÖ Firebase —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:', firebaseConfig.projectId);
  firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch((e) => {
    console.warn('Firestore persistence is off:', e.code || e.message);
  });
} catch (e) {
  console.error('‚ùå Firebase –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:', e);
}

/* ===================== Directory / helpers / UI ===================== */
const dirByCode = {};
const codeByName = {};
const routesLookup = {};
const logistById = {};
const logistIdByName = {};

const DIR_CACHE_KEY = 'directoryCache.v2';
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

const LOGISTS_CACHE_KEY = 'logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function _norm(s){ return String(s||'').trim().toLowerCase(); }

/* ---- Directory ---- */
function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  list.innerHTML = '';
  Object.keys(dirByCode).forEach(k => delete dirByCode[k]);
  Object.keys(codeByName).forEach(k => delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if (!(name in codeByName)) codeByName[name] = code;

    const opt = document.createElement('option');
    opt.value = name;
    opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
}

async function loadDirectory(force=false){
  try{
    if (!force){
      const raw = localStorage.getItem(DIR_CACHE_KEY);
      if (raw){
        const { ts, rows } = JSON.parse(raw);
        if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){
          fillDirectoryUI(rows); updateRouteName(); refreshRoutesList();
          console.log('üìí Directory from localStorage cache:', rows.length);
          return;
        }
      }
    }
  }catch{}

  let snap = null;
  try { snap = await db.collection('directory').get({ source: force ? 'default' : 'cache' }); } catch {}
  if (!snap || snap.empty) snap = await db.collection('directory').get();

  const rows = [];
  snap.forEach(doc => {
    const d = doc.data() || {};
    rows.push({ code: doc.id, name: d.name || doc.id, company: d.company || '', unit: d.unit || '' });
  });

  fillDirectoryUI(rows);
  updateRouteName();
  refreshRoutesList();

  try{ localStorage.setItem(DIR_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
  console.log('üìí Directory loaded from Firestore:', rows.length, 'force=', force);
}

/* ---- Logists ---- */
function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  Object.keys(logistById).forEach(k=> delete logistById[k]);
  Object.keys(logistIdByName).forEach(k=> delete logistIdByName[k]);

  rows.forEach(r=>{
    logistById[r.id] = r; logistIdByName[r.name] = r.id;
    const opt = document.createElement('option'); opt.value = r.name; list.appendChild(opt);
  });

  if (rows.length === 0) { console.warn('üë• Logists: –ø—É—Å—Ç–æ.'); }
}

async function loadLogists(allowServer=true){
  const msg = document.getElementById('logistsMsg');
  const showMsg = (t) => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };

  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if(raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){
        fillLogistsUI(rows); showMsg('');
        console.log('üë• Logists from cache:', rows.length);
        return;
      }
    }
    if (!allowServer) { showMsg('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }

    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'default' }); }
    catch (e) {
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))) {
        console.warn('permission-denied –¥–ª—è logists');
        showMsg('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.');
        return;
      }
      throw e;
    }

    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });

    rows = rows.filter(r=>r.active).sort((a,b)=> (a.sort-b.sort) || a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    showMsg('');
    console.log('üë• Logists loaded from Firestore:', rows.length);
  } catch (e) {
    console.error('‚ùå Logists load error:', e);
    showMsg('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.');
  }
}

function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if(!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const candidates = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (candidates.length === 1) return candidates[0][1];
  return null;
}
function getLogistNameById(id){ return (logistById[id]?.name) || ''; }

/* Helpers for route points */
function toObjPoints(arr) { return (arr || []).map(p => ({ lng: p[0], lat: p[1] })); }
function fromObjPoints(arr) { return (arr || []).map(p => [p.lng, p.lat]); }

function getCodeByInput(inputId) {
  const raw = document.getElementById(inputId).value;
  const name = raw.trim();
  if (!name) return null;
  if (codeByName[name]) return codeByName[name];
  const n = _norm(name);
  for (const [label, code] of Object.entries(codeByName)){ if (_norm(label) === n) return code; }
  const candidates = Object.entries(codeByName).filter(([label]) => _norm(label).includes(n));
  if (candidates.length === 1) return candidates[0][1];
  return null;
}

function getNameByCode(code) { return (dirByCode[code]?.name) || ''; }
function formatRouteTitle(data) {
  const from = dirByCode[data.fromCode]?.name || '–Ω–µ–≤—ñ–¥–æ–º–æ';
  const to   = dirByCode[data.toCode]?.name   || '–Ω–µ–≤—ñ–¥–æ–º–æ';
  const type = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
  const parts = [type]; if (data.purpose) parts.push(data.purpose);
  return `${from} ‚Üí ${to} [${parts.join(' ‚Ä¢ ')}]`;
}
function updateRouteName() {
  const fromCode = getCodeByInput('fromName');
  const toCode = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;
  const routePurpose = document.getElementById('routePurpose').value;
  if (!fromCode || !toCode) return;
  const from = dirByCode[fromCode] || {};
  const to   = dirByCode[toCode] || {};
  const fromLabel = [from.name, from.unit, from.company].filter(Boolean).join(' ‚Ä¢ ');
  const toLabel   = [to.name, to.unit, to.company].filter(Boolean).join(' ‚Ä¢ ');
  const parts = [routeType]; if (routePurpose) parts.push(routePurpose);
  document.getElementById('routeName').value = `${fromLabel} ‚Üí ${toLabel} [${parts.join(' ‚Ä¢ ')}]`;
}

/* ===== DUPLICATES ===== */
function sanitizeId(s){ return String(s||'').replace(/[\/\\#?\[\]]/g,'_'); }

async function findExistingRoute(fromCode, toCode, routeType){
  try{
    const snap = await db.collection('routes')
      .where('fromCode','==',fromCode).where('toCode','==',toCode).where('routeType','==',routeType)
      .limit(1).get();
    let found = null; snap.forEach(doc => { if (!found) found = doc; });
    return found;
  }catch(e){ console.warn('findExistingRoute error:', e?.message || e); return null; }
}
function makeCopyId(baseSafeId){ return `${baseSafeId}__${Date.now()}`; }

const $dupModal = document.getElementById('dupModal');
const $dupText = document.getElementById('dupText');
const $dupOverwrite = document.getElementById('dupOverwrite');
const $dupCopy = document.getElementById('dupCopy');
const $dupCancel = document.getElementById('dupCancel');

function askDuplicateAction(existingName){
  return new Promise((resolve)=>{
    $dupText.textContent = `–ú–∞—Ä—à—Ä—É—Ç —ñ–∑ —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∂–µ —ñ—Å–Ω—É—î:\n‚Äú${existingName}‚Äù.\n–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:`;
    $dupModal.classList.add('show');
    const onEsc = (e)=>{ if(e.key==='Escape'){ cleanup(); resolve('cancel'); } };
    function cleanup(){ document.removeEventListener('keydown', onEsc); $dupModal.classList.remove('show'); }
    $dupOverwrite.onclick = ()=>{ cleanup(); resolve('overwrite'); };
    $dupCopy.onclick = ()=>{ cleanup(); resolve('copy'); };
    $dupCancel.onclick = ()=>{ cleanup(); resolve('cancel'); };
    $dupModal.onclick = (e)=>{ if(e.target===$dupModal){ cleanup(); resolve('cancel'); } };
    document.addEventListener('keydown', onEsc, { once:false });
  });
}

/* ===== Local JSON save/load ===== */
const fileInput = document.getElementById('fileInput');

document.getElementById('saveRoute').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  const fromCode = getCodeByInput('fromName');
  const toCode   = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;
  const purpose   = document.getElementById('routePurpose').value;
  const intermediateText = document.getElementById('intermediateText').value.trim();
  const logistId = getLogistIdByInput('logistInput');
  const logistName = logistId ? getLogistNameById(logistId) : '';

  const routeData = {
    name: (document.getElementById('routeName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∏'),
    fromCode, toCode, routeType, purpose, intermediateText,
    points: toObjPoints(points),
    startRuler: toObjPoints(startRuler),
    endRuler: toObjPoints(endRuler),
    logisticId: logistId || null,
    logisticName: logistName || '',
    distance_km: parseFloat(document.getElementById('distance').textContent) || 0,
    date: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(routeData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const safe = String(routeData.name || 'route').replace(/[\/\\#?[\]:]/g,'_');
  a.href = url; a.download = `route_${safe}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
};

document.getElementById('loadRoute').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  fileInput.value = null; fileInput.click();
};

fileInput.onchange = (event) => {
  if (readOnly) return;
  const file = event.target.files && event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const routeData = JSON.parse(e.target.result);
      const arrFrom = (pts) => {
        if (!Array.isArray(pts)) return [];
        if (pts.length && typeof pts[0] === 'object' && pts[0] !== null && 'lng' in pts[0]) { return fromObjPoints(pts); }
        return pts;
      };

      points = arrFrom(routeData.points || []);
      startRuler = arrFrom(routeData.startRuler || []);
      endRuler = arrFrom(routeData.endRuler || []);

      if (routeData.fromCode) document.getElementById('fromName').value = getNameByCode(routeData.fromCode) || '';
      if (routeData.toCode)   document.getElementById('toName').value   = getNameByCode(routeData.toCode)   || '';
      if (routeData.routeType) document.getElementById('routeType').value = routeData.routeType;
      if (routeData.purpose)   document.getElementById('routePurpose').value = routeData.purpose;
      document.getElementById('intermediateText').value = routeData.intermediateText || '';
      document.getElementById('routeName').value = routeData.name || '';

      document.getElementById('logistInput').value =
        routeData.logisticName || (routeData.logisticId ? getLogistNameById(routeData.logisticId) : '');

      rebuildMarkers(); drawRulers(); updateRoute();
      if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
      alert('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ —Ñ–∞–π–ª—É!');
    } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: ' + err.message); }
  };
  reader.readAsText(file);
};

/* ================= NEW routeKey helpers ================= */
function firstLetter(str){
  const s = String(str || '').trim();
  if (!s) return 'X';
  const re = /[A-Za-z–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–Ñ—î“ê“ë]/u;
  for (const ch of s){
    if (re.test(ch)) return ch.toUpperCase();
  }
  return 'X';
}
function randomDigits(len=10){
  const a = new Uint32Array(len);
  (crypto && crypto.getRandomValues) ? crypto.getRandomValues(a) : a.fill(Math.floor(Math.random()*10));
  return Array.from(a, n => (n % 10).toString()).join('');
}
async function reserveKeyTx(tx, prefix, docId, meta){
  for (let tries = 0; tries < 10; tries++){
    const key = `${prefix}-${randomDigits(10)}`;
    const keyRef = db.collection('routeKeys').doc(key);
    const snap = await tx.get(keyRef);
    if (!snap.exists){
      tx.set(keyRef, {
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        routeId: docId,
        fromCode: meta.fromCode, toCode: meta.toCode,
        fromName: meta.fromName, toName: meta.toName
      });
      return key;
    }
  }
  throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É (—Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑).');
}
/* ======================================================= */

/* ===== Firestore: save/list/load/delete ===== */
async function saveToDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
    if (points.length === 0 && startRuler.length === 0 && endRuler.length === 0) { alert('–ù–µ–º–∞—î —â–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏'); return; }

    const fromCode = getCodeByInput('fromName');
    const toCode   = getCodeByInput('toName');
    const routeType = document.getElementById('routeType').value;
    const purpose   = document.getElementById('routePurpose').value;
    const intermediateText = document.getElementById('intermediateText').value.trim();
    const logistId = getLogistIdByInput('logistInput');

    if (!fromCode || !toCode) { alert('–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äú–í—ñ–¥‚Äù —Ç–∞ ‚Äú–î–æ‚Äù –∑—ñ —Å–ø–∏—Å–∫—É –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.'); return; }
    if (!logistId) { alert('–û–±–µ—Ä—ñ—Ç—å –ª–æ–≥—ñ—Å—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É.'); return; }

    const from = dirByCode[fromCode] || {};
    const to   = dirByCode[toCode] || {};
    const fromLabel = [from.name, from.unit, from.company].filter(Boolean).join(' ‚Ä¢ ');
    const toLabel   = [to.name, to.unit, to.company].filter(Boolean).join(' ‚Ä¢ ');
    const generatedName = `${fromLabel} ‚Üí ${toLabel} [${routeType}${purpose ? ' ‚Ä¢ '+purpose : ''}]`;

    const manual = (document.getElementById('routeName').value || '').trim();
    const finalName = manual || generatedName;

    const user = auth?.currentUser || null;

    // üëá –≤–∏—Ä—ñ–≤–Ω—é—î–º–æ —ñ–º–µ–Ω–∞ –ø–æ–ª—ñ–≤ –ø—ñ–¥ –ø—Ä–∞–≤–∏–ª–∞: distanceKm (camelCase)
    const payload = {
      name: finalName,
      fromCode, toCode, routeType, purpose, intermediateText,
      points: toObjPoints(points),
      startRuler: toObjPoints(startRuler),
      endRuler: toObjPoints(endRuler),
      logisticId: logistId,
      logisticName: getLogistNameById(logistId),
      createdByUid: user?.uid || null,
      createdByEmail: user?.email || null,
      distanceKm: parseFloat(document.getElementById('distance').textContent) || 0,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const existing = await findExistingRoute(fromCode, toCode, routeType);
    const baseId = sanitizeId(finalName);
    let docId = baseId;
    let mode = 'new'; // 'new' | 'overwrite' | 'copy'

    if (existing){
      const existingName = existing.data()?.name || existing.id;
      const choice = await askDuplicateAction(existingName);
      if (choice === 'cancel'){ alert('‚ùé –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ'); return; }
      if (choice === 'overwrite'){ docId = existing.id; mode = 'overwrite'; }
      if (choice === 'copy'){ docId = makeCopyId(baseId); payload.name = `${payload.name} (–∫–æ–ø—ñ—è)`; mode = 'copy'; }
    }

    const prefix = firstLetter(from.name) + firstLetter(to.name);
    const meta = { fromCode, toCode, fromName: from.name || '', toName: to.name || '' };

    let routeKeySaved = null;

    await db.runTransaction(async (tx) => {
      const routeRef = db.collection('routes').doc(docId);
      const routeSnap = await tx.get(routeRef);

      let routeKey = null;

      if (mode === 'overwrite' && routeSnap.exists && routeSnap.data()?.routeKey) {
        routeKey = String(routeSnap.data().routeKey);
        const keyRef = db.collection('routeKeys').doc(routeKey);
        await tx.get(keyRef); // —á–∏—Ç–∞—î–º–æ –¥–ª—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ
        tx.set(keyRef, {
          routeId: docId,
          updatedAt: new Date().toISOString(),
          fromCode, toCode,
          fromName: meta.fromName, toName: meta.toName
        }, { merge: true });
      } else {
        // —Ä–µ–∑–µ—Ä–≤—É—î–º–æ –Ω–æ–≤–∏–π –∫–ª—é—á
        routeKey = await reserveKeyTx(tx, prefix, docId, meta);
      }

      routeKeySaved = routeKey;
      tx.set(routeRef, { ...payload, routeKey }, { merge: true });
    });

    alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ë–î: ${payload.name}\n–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ${routeKeySaved}`);
    await refreshRoutesList();
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore:', err);
    const code = err?.code || err?.name || '';
    const msg  = err?.message || String(err);
    alert(`‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î (${code}): ${msg}`);
  }
}

let isRefreshingRoutes = false;
async function refreshRoutesList(limitNum = 100) {
  if (!db || isRefreshingRoutes) return;
  isRefreshingRoutes = true;

  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');
  const current = sel.value;

  const q = db.collection('routes').orderBy('updatedAt','desc').limit(limitNum);

  const render = (snap) => {
    sel.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
    list.innerHTML = '';
    for (const k in routesLookup) delete routesLookup[k];

    snap.forEach(doc => {
      const d = doc.data();
      const km = (typeof d.distance_km === 'number') ? ` (${d.distance_km.toFixed(2)} –∫–º)` : '';
      const labelNow = formatRouteTitle(d);
      const label = labelNow + km;

      const opt = document.createElement('option');
      opt.value = doc.id; opt.textContent = label; sel.appendChild(opt);

      routesLookup[label] = doc.id;
      const sOpt = document.createElement('option'); sOpt.value = label; list.appendChild(sOpt);
    });

    if (Array.from(sel.options).some(o => o.value === current)) { sel.value = current; }
  };

  try {
    const snapCache = await q.get({ source: 'cache' }).catch(()=>null);
    if (snapCache && !snapCache.empty) render(snapCache);
    const snapServer = await q.get({ source: 'default' }).catch(()=>null);
    if (snapServer) render(snapServer);
  } finally { isRefreshingRoutes = false; }
}

async function loadFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }

    const docRef = db.collection('routes').doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
    const data = docSnap.data();
    updateRouteName();

    document.getElementById('fromName').value = getNameByCode(data.fromCode) || '';
    document.getElementById('toName').value   = getNameByCode(data.toCode) || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('routePurpose').value = data.purpose || '–ó–µ—Ä–Ω–æ';
    document.getElementById('intermediateText').value = data.intermediateText || '';
    document.getElementById('routeName').value = formatRouteTitle(data);

    document.getElementById('logistInput').value =
      data.logisticName || (data.logisticId ? getLogistNameById(data.logisticId) : '');

    points = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler = fromObjPoints(data.endRuler || []);

    rebuildMarkers(); drawRulers(); updateRoute();
    if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
    alert('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ –ë–î: ' + id + (data.routeKey ? `\n–ö–æ–¥: ${data.routeKey}` : ''));
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏: ' + (err?.message || err));
  }
}

async function deleteFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }
    if (!confirm(`–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç "${id}"?`)) return;

    await db.collection('routes').doc(id).delete();
    alert('–í–∏–¥–∞–ª–µ–Ω–æ –∑ –ë–î: ' + id);
    await refreshRoutesList();
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: ' + (err?.message || err));
  }
}

/* ===== Buttons bindings ===== */
document.getElementById('saveToDB').onclick = saveToDB;
let lastRefreshClick = 0;
document.getElementById('refreshList').onclick = () => {
  const now = Date.now();
  if (now - lastRefreshClick < 500) return;
  lastRefreshClick = now;
  refreshRoutesList();
};
document.getElementById('loadFromDB').onclick = loadFromDB;
document.getElementById('deleteFromDB').onclick = deleteFromDB;
document.getElementById('clearForm').onclick = clearForm;

/* Directory buttons */
document.getElementById('refreshDirectory').onclick = () => loadDirectory(true);
document.getElementById('clearDirCache').onclick = () => {
  try { localStorage.removeItem(DIR_CACHE_KEY); } catch {}
  loadDirectory(true);
};

/* Logists buttons */
document.getElementById('refreshLogists').onclick = async () => {
  const isLogged = !!(auth && auth.currentUser);
  await loadLogists(isLogged);
};
document.getElementById('clearLogistsCache').onclick = () => {
  try { localStorage.removeItem(LOGISTS_CACHE_KEY); } catch {}
  const isLogged = !!(auth && auth.currentUser);
  loadLogists(isLogged);
};

/* Search helper */
const routeSearch = document.getElementById('routeSearch');
const remoteRoutesSel = document.getElementById('remoteRoutes');
routeSearch.addEventListener('input', () => {
  const q = routeSearch.value.trim().toLowerCase();
  let matched = false;
  for (const opt of remoteRoutesSel.options) {
    const text = (opt.textContent || '').toLowerCase();
    if (text.includes(q) && opt.value) { remoteRoutesSel.value = opt.value; matched = true; break; }
  }
  if (!matched) remoteRoutesSel.value = '';
});
routeSearch.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (!remoteRoutesSel.value) routeSearch.dispatchEvent(new Event('input'));
    if (remoteRoutesSel.value) document.getElementById('loadFromDB').click();
  }
});

/* Load by ?rid= */
async function loadRouteById(rid) {
  try {
    const snap = await db.collection('routes').doc(rid).get();
    if (!snap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –∑ —Ç–∞–∫–∏–º ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ' + rid); return; }
    const data = snap.data();
    document.getElementById('fromName').value = getNameByCode(data.fromCode) || '';
    document.getElementById('toName').value   = getNameByCode(data.toCode) || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('routePurpose').value = data.purpose || '–ó–µ—Ä–Ω–æ';
    document.getElementById('intermediateText').value = data.intermediateText || '';
    document.getElementById('routeName').value = formatRouteTitle(data);

    document.getElementById('logistInput').value =
      data.logisticName || (data.logisticId ? getLogistNameById(data.logisticId) : '');

    points     = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler   = fromObjPoints(data.endRuler || []);
    rebuildMarkers(); drawRulers(); updateRoute();
    if (points.length) {
      const b = new mapboxgl.LngLatBounds(points[0], points[0]);
      for (const p of points) b.extend(p);
      map.fitBounds(b, { padding: 40 });
    }
    if (data.routeKey) alert('–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ' + data.routeKey);
  } catch (e) {
    console.error('loadRouteById error:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ' + (e?.message || e));
  }
}

function clearForm() {
  document.getElementById('fromName').value = '';
  document.getElementById('toName').value = '';
  document.getElementById('routeType').value = '–û—Å–Ω–æ–≤–Ω–∏–π';
  document.getElementById('routePurpose').value = '–ó–µ—Ä–Ω–æ';
  document.getElementById('intermediateText').value = '';
  document.getElementById('routeName').value = '';
  document.getElementById('logistInput').value = '';
  document.getElementById('distance').textContent = '0';
  points = []; startRuler = []; endRuler = [];
  rebuildMarkers(); drawRulers(); updateRoute();
  document.getElementById('remoteRoutes').value = '';
  alert('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞');
}

/* ===== Panel toggle ===== */
const panelToggleBtn = document.getElementById('panelToggle');
function updatePanelToggleLabel(){
  const hidden = document.body.classList.contains('controls-hidden');
  panelToggleBtn.textContent = hidden ? '‚ñ∂ –ü–∞–Ω–µ–ª—å' : '‚óÄ –°—Ö–æ–≤–∞—Ç–∏';
  if (typeof map?.resize === 'function') requestAnimationFrame(() => map.resize());
}
panelToggleBtn.addEventListener('click', () => {
  document.body.classList.toggle('controls-hidden'); updatePanelToggleLabel();
});
updatePanelToggleLabel();

/* ===== Auth ===== */
const authHello = document.getElementById('authHello');
const authEmail = document.getElementById('authEmail');
const authPass  = document.getElementById('authPass');
const loginBtn  = document.getElementById('authLogin');
const logoutBtn  = document.getElementById('authLogout');

document.getElementById('mobileAuthToggle').addEventListener('click', () => {
  document.getElementById('authBar').classList.toggle('collapsed');
  requestAnimationFrame(updateLayoutHeights);
});

loginBtn.onclick = async () => {
  try{ await auth.signInWithEmailAndPassword(authEmail.value.trim(), authPass.value); }
  catch(e){ alert('üö´ –í—Ö—ñ–¥ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ: ' + (e?.message || e)); }
};
logoutBtn.onclick = async () => {
  try{ await auth.signOut(); }
  finally{
    // CHANGED: –ø—ñ—Å–ª—è –≤–∏—Ö–æ–¥—É ‚Äî —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –ª–æ–≥—ñ–Ω—É
    const LOGIN_PATH = './login.html';              // ‚Üê –±—É–ª–æ ./login/index.html
    location.replace(LOGIN_PATH + '?next=' + encodeURIComponent('./index.html'));
  }
};

auth?.onAuthStateChanged(async (user) => {
  if (user){
    authHello.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + (user.email || user.uid);
    loginBtn.style.display='none'; authEmail.style.display='none'; authPass.style.display='none';
    logoutBtn.style.display='inline-block';
    if (window.matchMedia('(max-width: 640px)').matches) {
      document.getElementById('authBar').classList.add('collapsed');
    }
    requestAnimationFrame(updateLayoutHeights);
    let role = 'user';
    try{
      const r = await db.collection('roles').doc(user.uid).get();
      if (r.exists && r.data()?.role) role = String(r.data().role);
    }catch{}
    applyRoleUI(role);
    await loadLogists(true);
  } else {
    authHello.textContent = '–ì—ñ—Å—Ç—å';
    loginBtn.style.display='inline-block'; authEmail.style.display='inline-block'; authPass.style.display='inline-block';
    logoutBtn.style.display='none';
    requestAnimationFrame(updateLayoutHeights);
    applyRoleUI('guest');
    await loadLogists(false);
  }
});

/* ===== Start ===== */
window.addEventListener('load', async () => {
  if (!db) return;
  await loadDirectory(true);
  await refreshRoutesList();
  const rid = new URLSearchParams(location.search).get('rid');
  if (rid) await loadRouteById(rid);
  requestAnimationFrame(updateLayoutHeights);
});

document.getElementById('logistInput').addEventListener('focus', function(){
  const isLogged = !!(auth && auth.currentUser);
  loadLogists(isLogged);
  try { this.dispatchEvent(new KeyboardEvent('keydown', {key:'ArrowDown'})); } catch {}
});

document.getElementById('fromName').addEventListener('change', updateRouteName);
document.getElementById('toName').addEventListener('change', updateRouteName);
document.getElementById('routeType').addEventListener('change', updateRouteName);
document.getElementById('routePurpose').addEventListener('change', updateRouteName);
</script>
</body>
</html>
