<!-- Telegram notification for approval -->
<script>
const telegramToken = "8491491118:AAGjgtnwh4wXLR0C6bQKKAD-w-95_G3tgL0";
const chatId = "-4864467412";

function sendTelegramApprovalMessage(routeName, routeId) {
  if (!telegramToken || !chatId) return;
  const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
  const reviewLink = reviewLinkForId(routeId);
  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ HTML —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–æ–≥–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
  const text = `üö¶ –ú–∞—Ä—à—Ä—É—Ç –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è:\n${routeName}\n<a href='${reviewLink}'>–ú–∞—Ä—à—Ä—É—Ç</a>`;
  fetch(`${url}?chat_id=${chatId}&text=${encodeURIComponent(text)}&parse_mode=HTML`)
    .then(r => r.json())
    .then(res => {
      console.log('Telegram response:', res);
      if (!res.ok) console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram:', res);
    })
    .catch(e => console.warn('Telegram fetch error:', e));
}
</script>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üöö–ú–∞—Ä—à—Ä—É—Ç–∏ Mapbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="preconnect" href="https://api.mapbox.com" crossorigin>
<link rel="preconnect" href="https://events.mapbox.com" crossorigin>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="https://firestore.googleapis.com">
<link rel="dns-prefetch" href="https://firebasestorage.googleapis.com">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <!-- ‚¨áÔ∏è Firebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <!-- App config -->
<script src="/config/config.js"></script>

  <style>
  :root { --nav-h:56px; --nav-real:56px; --card:#fff; --line:#e5e7eb; --muted:#6b7280; }

  *{box-sizing:border-box}
  body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  header.topbar{
    position:sticky; top:0; z-index:5000; min-height:var(--nav-h);
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px;
    background:#2563eb; color:#fff;
  }
  header.topbar a{ color:#fff; text-decoration:none; margin-right:12px; white-space:nowrap; }
  header .left, header .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  header .spacer{ flex:1 1 auto; }

  #authBar{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  #authBar input{
    height:34px; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.15); color:#fff; outline:none; width:180px;
  }
  #authBar input::placeholder{ color:rgba(255,255,255,.85) }
  #authBar input[type="password"]{ width:120px }
  #authBar .chip{
    font-size:12px; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3);
    border-radius:999px; padding:4px 10px; white-space:nowrap;
  }
  #authBar .btn{
    height:34px; padding:0 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
    background:#fff; color:#111; cursor:pointer; touch-action:manipulation;
  }

  #mobileAuthToggle{ display:none; }
  @media (max-width: 640px){
    #mobileAuthToggle{
      display:inline-flex; align-items:center; justify-content:center;
      height:34px; padding:0 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
      background:#fff; color:#111; cursor:pointer;
    }
    #authBar.collapsed input,
    #authBar.collapsed #authLogin,
    #authBar.collapsed #authLogout{ display:none !important; }
  }

  #map{position:absolute; top:var(--nav-real); bottom:0; width:100%}

  #controls{
    position:absolute; z-index:3000; top:calc(var(--nav-real) + 8px); left:8px;
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 1px 8px rgba(0,0,0,.12); padding:12px;
    max-width:380px; max-height:90vh; overflow-y:auto; overflow-x:hidden;
  }
  .controls-hidden #controls{ display:none }

  #controls .row>*{min-width:0}
  #controls input[type=text], #controls select, #controls textarea{
    width:100%; max-width:100%; padding:9px 11px; font-size:14px;
    border:1px solid var(--line); border-radius:10px; outline:none;
  }
  #controls textarea{min-height:48px; resize:vertical}
  label{display:block;font-size:13px;color:#444;margin:2px 0 6px}
  small.muted{color:#6b7280}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:420px){ .row{grid-template-columns:1fr} }

  .btn{
    cursor:pointer;border:1px solid var(--line);background:#fff;border-radius:10px;
    padding:8px 12px;font-size:14px; line-height:1.2; touch-action:manipulation;
  }
  .btn.xs{ padding:8px 12px; font-size:14px }
  .btn.active{background:#e6f4ea;border-color:#22c55e}

  .panel-head{display:grid;gap:10px;margin-bottom:8px}
  .segment{display:flex;gap:6px;flex-wrap:wrap}
  .btn-row{display:flex;gap:6px;flex-wrap:wrap}

  @media (max-width: 640px){
    #controls{ left:8px; right:8px; max-width:unset; width:auto; }
    .segment, .btn-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .btn, .btn.xs{ min-height:44px; font-size:15px; padding:10px 12px; }
    .km-chip{ font-size:13px; padding:6px 10px; }
  }

  .km-chip{margin-top:2px;font-size:12.5px;color:#111;background:#f3f4f6;
           border:1px solid var(--line);border-radius:999px;display:inline-block;
           padding:4px 10px;width:max-content}

  .section{border-top:1px dashed var(--line);padding-top:8px;margin-top:8px}
  details>summary{cursor:pointer;font-weight:700;margin:4px 0}
  #dbControls{margin-top:10px;padding-top:10px;border-top:1px dashed var(--line)}
  #dbControls input,#dbControls select{margin:5px 0}

  #contextMenu{position:absolute;background:#fff;border:1px solid #ccc;display:none;z-index:3500;
               box-shadow:0 2px 6px rgba(0,0,0,.15)}
  #contextMenu div{padding:6px 10px;cursor:pointer}
  #contextMenu div:hover{background:#f3f4f6}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000}
  .modal.show{display:flex}
  .modal-box{background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; width:min(440px,92vw); box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-weight:700; margin-bottom:6px}
  .modal-body{color:#374151; font-size:14px; margin-bottom:10px; white-space:pre-line}
  .modal-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .modal-actions .btn{min-width:140px}

  .mapboxgl-canvas{z-index:0!important}
  .mapboxgl-control-container{z-index:1!important}
  .mapboxgl-marker{z-index:2!important}

  #logistsMsg{display:none;font-size:12px;color:#b91c1c;margin-top:4px}
  
  #splash{
  position:fixed; inset:0; display:grid; place-items:center;
  background:#fff; z-index:9999; transition:opacity .25s ease;
  font-size:14px; color:#111; gap:12px;
}
#splash.hide{ opacity:0; pointer-events:none }
.spinner{
  width:40px; height:40px; border:3px solid #e5e7eb;
  border-top-color:#2563eb; border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg) } }
/* ==== –ü–∞–Ω–µ–ª—ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è ==== */
#controls .panel{ display:none; }
#controls .panel.active{ display:block; }

/* ==== –î–æ–∫ —É –ø—Ä–∞–≤–æ–º—É –≤–µ—Ä—Ö–Ω—å–æ–º—É –∫—É—Ç—ñ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –∫–º ==== */
#statusDock{
  position:fixed;
  top:calc(var(--nav-real) + 8px);
  right:8px;
  z-index:3500;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.status-chip{
  background:#f3f4f6;
  color:#111;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 12px;
  font-size:12.5px;
  box-shadow:0 1px 8px rgba(0,0,0,.08);
  width:max-content;
  max-width:46vw;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* –∫–æ–ª—å–æ—Ä–∏ —Å—Ç–∞—Ç—É—Å—ñ–≤ */
#statusChip.status-chip[data-status="pending"]{ background:#fff7ed; border-color:#f59e0b; }
#statusChip.status-chip[data-status="approved"]{ background:#e6f4ea; border-color:#22c55e; }
#statusChip.status-chip[data-status="rejected"]{ background:#fee2e2; border-color:#ef4444; }
#statusChip.status-chip[data-status="draft"]{ background:#eef2ff; border-color:#c7d2fe; }

@media (max-width:640px){
  #statusDock{ right:8px; top:calc(var(--nav-real) + 8px); }
}
/* –ñ–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–Ω–∞—á–µ–Ω–Ω—è –∫–º —É –≤–µ—Ä—Ö–Ω—å–æ–º—É —á—ñ–ø—ñ */
#distanceChip #distanceTop{
  font-weight: 700;
  font-variant-numeric: tabular-nums; /* –æ–ø—Ü—ñ–π–Ω–æ: —Ä—ñ–≤–Ω—ñ —à–∏—Ä–∏–Ω–∏ —Ü–∏—Ñ—Ä */
}

/* –î–æ–∫-–ø–µ—Ä–µ–º–∏–∫–∞—á –ø–∞–Ω–µ–ª–µ–π (–ø—Ä–∞–≤–æ—Ä—É—á –≤–Ω–∏–∑—É) */
#panelDock{
  position:fixed;
  right:8px; bottom:8px;
  z-index:3500;
  display:flex; gap:6px; flex-wrap:wrap;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 12px rgba(0,0,0,.12);
}
#panelDock .dock-btn{
  cursor:pointer; border:1px solid var(--line); background:#fff;
  border-radius:10px; padding:8px 10px; font-size:13px;
}
#panelDock .dock-btn.active{
  background:#e6f4ea; border-color:#22c55e;
}

/* –¥—Ä—ñ–±–Ω—ñ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ –ø—Ä–∞–≤–∫–∏ */
@media (max-width:640px){
  #statusChip{ right:8px; top:calc(var(--nav-real) + 8px); }
  #panelDock{ right:8px; bottom:8px; }
}
/* –≤–µ—Ä—Ö–Ω—ñ–π —Å–µ–≥–º–µ–Ω—Ç –∑ —Ç—Ä—å–æ–º–∞ –∫–Ω–æ–ø–∫–∞–º–∏ */
#panel-create .segment{
  display:flex;
  gap:6px;
  flex-wrap:nowrap;        /* –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–∏ */
}
#panel-create .segment .btn{
  white-space:nowrap;      /* –Ω–µ –ª–∞–º–∞—Ç–∏ —Ç–µ–∫—Å—Ç –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ */
  flex: 1 1 auto;          /* —Ä—ñ–≤–Ω—ñ —à–∏—Ä–∏–Ω–∏, —è–∫—â–æ —Ö–æ—á–µ—à */
}
#panel-create .segment .btn.active::after{
  content: "";                 /* –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—É –∫—Ä–∞–ø–∫—É */
  display: inline-block;       /* –∑—Ä–æ–±–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–æ–º, —â–æ–± –∑–∞–¥–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä–∏ */
  width: 8px;                  /* –º–∞–ª–µ–Ω—å–∫–∏–π –∫—Ä—É–∂–µ—á–æ–∫ */
  height: 8px;
  margin-left: .35rem;         /* –≤—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ —Ç–µ–∫—Å—Ç—É –∫–Ω–æ–ø–∫–∏ */
  border-radius: 50%;          /* –∫–æ–ª–æ */
  background: #22c55e;         /* –∑–µ–ª–µ–Ω–∏–π */
  border: 1px solid rgba(0,0,0,.25); /* —Ç–æ–Ω–∫–∞ –æ–±–≤–æ–¥–∫–∞, —â–æ–± –±—É–ª–æ —á—ñ—Ç–∫–æ –≤–∏–¥–Ω–æ */
  vertical-align: middle;
}
/* —Ä—ñ–∑–Ω—ñ –∫–æ–ª—å–æ—Ä–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–Ω–æ–ø–∫–∏ ‚Äî –¶–ï–ô –í–ê–†–Ü–ê–ù–¢ –ó –ü–†–ê–í–ò–õ–¨–ù–û–Æ –°–ü–ï–¶–ò–§–Ü–ß–ù–Ü–°–¢–Æ */
#panel-create #toggleAdd.active::after     { background:#22c55e; } /* –ú–∞—Ä—à—Ä—É—Ç ‚Äì –∑–µ–ª–µ–Ω–∏–π */
#panel-create #startLineMode.active::after { background:#2563eb; } /* –õ—ñ–Ω—ñ–π–∫–∞(–ø–æ—á.) ‚Äì —Å–∏–Ω—ñ–π */
#panel-create #endLineMode.active::after   { background:#f59e0b; } /* –õ—ñ–Ω—ñ–π–∫–∞(–∫—ñ–Ω.) ‚Äì –ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π */

  </style>
</head>
<body>

<header class="topbar">
  <div class="left">
    <button id="panelToggle" class="btn xs" title="–°—Ö–æ–≤–∞—Ç–∏/–ø–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å">‚óÄ –°—Ö–æ–≤–∞—Ç–∏</button>
    <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <a href="/import/">üì• –Ü–º–ø–æ—Ä—Ç</a>
	<a id="adminLink" href="/admin.html" style="display:none;">üë®‚Äçüíª –ê–¥–º—ñ–Ω</a>
	<a id="adminLinkViewer" href="/Firestore_Viewe.html" target="_blank" style="display:none;">üìÇ Firestore</a>
	<a id="uploadRoutesLink" href="/import/upload-routes.html" style="display:none;">‚¨Ü –Ü–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤</a>
  </div>

  <div class="spacer"></div>

  <div id="authBar" class="right collapsed">
    <span id="authHello" class="chip">–ì—ñ—Å—Ç—å</span>
    <span id="roleChip" class="chip">–†–æ–ª—å: ‚Äì</span>

    <input id="authEmail" type="text" placeholder="email (–Ω–∞–ø—Ä–∏–∫–ª. user@demo.fake)" autocomplete="username">
    <input id="authPass"  type="password" placeholder="–ø–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button id="authLogin"  class="btn">–£–≤—ñ–π—Ç–∏</button>
    <button id="authLogout" class="btn" style="display:none">–í–∏–π—Ç–∏</button>
  </div>

  <button id="mobileAuthToggle" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –≤—Ö—ñ–¥">üîê –í—Ö—ñ–¥</button>
</header>
<div id="splash">
  <div class="spinner"></div>
  <div>–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞—Ä—Ç—É‚Ä¶</div>
</div>

<div id="controls">
  <!-- === –ü–ê–ù–ï–õ–¨ 1: –°–¢–í–û–†–ï–ù–ù–Ø –ú–ê–†–®–†–£–¢–£ (–æ—Å–Ω–æ–≤–Ω–∞) === -->
  <div id="panel-create" class="panel active">
    <div class="panel-head">
      <div class="segment">
        <button id="toggleAdd" class="btn xs">–ú–∞—Ä—à—Ä—É—Ç</button>
        <button id="startLineMode" class="btn xs" title="–î–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">–õ—ñ–Ω—ñ–π–∫–∞(–ø–æ—á.)</button>
        <button id="endLineMode" class="btn xs" title="–î–æ–¥–∞–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –∫—ñ–Ω—Ü–µ–≤–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">–õ—ñ–Ω—ñ–π–∫–∞(–∫—ñ–Ω.)</button>
      </div>

      <div class="btn-row">
        <button id="clearRoute" class="btn xs">–û—á–∏—Å—Ç. –º–∞—Ä—à.</button>
        <button id="popRulerPoint" class="btn xs" title="–í–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é —Ç–æ—á–∫—É –∞–∫—Ç–∏–≤–Ω–æ—ó –ª—ñ–Ω—ñ–π–∫–∏">‚Üê –û—Å—Ç–∞–Ω–Ω—è —Ç–æ—á–∫–∞ (–ª—ñ–Ω.)</button>
        <button id="clearRulers" class="btn xs" title="–û—á–∏—Å—Ç–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É –ª—ñ–Ω—ñ–π–∫—É, –∞–±–æ –æ–±–∏–¥–≤—ñ —è–∫—â–æ —Ä–µ–∂–∏–º –ª—ñ–Ω—ñ–π–∫–∏ –≤–∏–º–∫–Ω–µ–Ω–æ">–û—á–∏—Å—Ç. –ª—ñ–Ω.</button>
        <button id="toggleMarkers" class="btn xs">üìç –¢–æ—á–∫–∏</button>
        <button id="toggleGeozones" class="btn xs">üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏</button>
      </div>

      <div class="btn-row">
        <button id="saveRoute" class="btn xs">üíæ Route JSON</button>
        <button id="loadRoute" class="btn xs">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
      </div>

      <div class="km-chip">
        —Ç–æ—á–∫–∏: <span id="countRoute">0</span> ‚Ä¢
        –ª—ñ–Ω(–ø–æ—á): <span id="countStart">0</span> ‚Ä¢
        –ª—ñ–Ω(–∫—ñ–Ω): <span id="countEnd">0</span> ‚Ä¢
        –≤—Å—å–æ–≥–æ: <span id="countTotal">0</span>
      </div>
    </div>

    <hr/>
    <!-- –í—ñ–¥/–î–æ -->
    <div class="row">
      <div>
        <label>–í—ñ–¥</label>
        <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
      </div>
      <div>
        <label>–î–æ</label>
        <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." list="directoryList" autocomplete="off">
      </div>
    </div>
    <datalist id="directoryList"></datalist>

    <!-- –¢–∏–ø/–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è/–•–∞–±/–ü—Ä–æ–º—ñ–∂–Ω—ñ -->
    <div class="row" style="margin-top:6px;">
      <div>
        <label>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç—É</label>
        <select id="routeType">
          <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
          <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
          <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
        </select>
      </div>
      <div>
        <label>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</label>
        <select id="routePurpose">
          <option value="–ó–µ—Ä–Ω–æ" selected>–ó–µ—Ä–Ω–æ</option>
          <option value="–û–î">–û–î</option>
          <option value="–¢–ú–¶">–¢–ú–¶</option>
        </select>
      </div>
      <div>
        <label>–•–∞–±</label>
        <select id="hubSelect">
          <option value="">‚Äî –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî</option>
          <option value="–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π">–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π</option>
          <option value="–ó–∞—Ö—ñ–¥–Ω–∏–π">–ó–∞—Ö—ñ–¥–Ω–∏–π</option>
          <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π</option>
          <option value="–£—Ä–æ–∂–∞–π–Ω–∞ –∫—Ä–∞—ó–Ω–∞">–£—Ä–æ–∂–∞–π–Ω–∞ –∫—Ä–∞—ó–Ω–∞</option>
        </select>
      </div>
      <div style="grid-column:1 / -1">
        <label>–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏</label>
        <input id="intermediateText" type="text" placeholder="–ù–∞–ø—Ä.: –ù–µ–º–∏—Ä—ñ–≤; –ì–∞–π—Å–∏–Ω; –¢—É–ª—å—á–∏–Ω">
      </div>
    </div>

    <!-- –õ–æ–≥—ñ—Å—Ç -->
    <div class="row" style="margin-top:6px;">
      <div style="grid-column:1 / -1">
        <label>–õ–æ–≥—ñ—Å—Ç (—Ö—Ç–æ —Å—Ç–≤–æ—Ä—é—î)</label>
        <input id="logistInput" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –ø—Ä—ñ–∑–≤–∏—â–µ..." list="logistsList" autocomplete="off">
        <datalist id="logistsList"></datalist>
        <small class="muted">–°–ø–∏—Å–æ–∫ –±–µ—Ä–µ—Ç—å—Å—è –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó <b>logists</b> (–∞–∫—Ç–∏–≤–Ω—ñ). –û–±–µ—Ä–∏ —Å–µ–±–µ –∑—ñ —Å–ø–∏—Å–∫—É.</small>
        <div id="logistsMsg"></div>
      </div>
    </div>

    <small class="muted">–£ –ë–î –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è <b>–∫–æ–¥–∏</b> ‚Äú–í—ñ–¥/–î–æ‚Äù + –ø—ñ–¥–ø–∏—Å–∏. –ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑ –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –Ω–∞–∑–≤ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.</small>

    <!-- –°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏ (–∑–∞–ª–∏—à–∏–≤ —É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ) -->
    <details>
      <summary><b>–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏</b></summary>
      <div id="styleSelector" style="margin-top:10px;">
        <label for="mapStyle">–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏:</label>
        <select id="mapStyle">
          <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
          <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
          <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
          <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
          <option value="mapbox://styles/mapbox/light-v11">Light</option>
          <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
          <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
          <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
        </select>
      </div>
    </details>

    <!-- –ë–∞–∑–∞ (–ª–∏—à–µ –Ω–∞–∑–≤–∞ + –∑–±–µ—Ä–µ–≥—Ç–∏ + –æ—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É) -->
    <div id="dbCreate" class="section">
      <div><strong>–ë–∞–∑–∞ (Firestore)</strong></div>
      <input id="routeName" type="text" placeholder="–ù–∞–∑–≤–∞ –º–∞—Ä—à—Ä—É—Ç—É (–∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏)" />
      <div class="btn-row" style="margin-top:6px;">
        <button id="saveToDB" class="btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î</button>
        <button id="clearForm" class="btn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
      </div>
    </div>
  </div>

  <!-- === –ü–ê–ù–ï–õ–¨ 2: –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –Ü–ó –ë–ê–ó–ò / –°–ï–†–í–Ü–°–ù–Ü –ö–ù–ü–ö–ò === -->
  <div id="panel-load" class="panel">
    <!-- –î–æ–≤—ñ–¥–Ω–∏–∫–∏/–∫–µ—à—ñ -->
    <div id="dirControls">
      <div><strong>–î–æ–≤—ñ–¥–Ω–∏–∫–∏</strong></div>
      <div class="btn-row" style="margin-top:4px;">
        <button id="refreshDirectory" class="btn xs">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫</button>
        <button id="clearDirCache" class="btn xs">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à</button>
      </div>
      <div class="btn-row" style="margin-top:6px;">
        <button id="refreshLogists" class="btn xs">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤</button>
        <button id="clearLogistsCache" class="btn xs">üßπ –ö–µ—à –ª–æ–≥—ñ—Å—Ç—ñ–≤</button>
      </div>
      <small class="muted">–î–∞–Ω—ñ –ª–æ–≥—ñ—Å—Ç—ñ–≤ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∑ Firestore. –ê–¥–º—ñ–Ω –∑–º—ñ–Ω—é—î —ó—Ö —É –∫–æ–ª–µ–∫—Ü—ñ—ó <b>logists</b>.</small>
    </div>

    <!-- –†–æ–±–æ—Ç–∞ –∑ –ø–µ—Ä–µ–ª—ñ–∫–æ–º –º–∞—Ä—à—Ä—É—Ç—ñ–≤ -->
    <div id="dbLoad" class="section">
      <div><strong>–ú–∞—Ä—à—Ä—É—Ç–∏ (–ë–î)</strong></div>

      <input id="routeSearch" type="text" placeholder="üîé –ü–æ—à—É–∫ –º–∞—Ä—à—Ä—É—Ç—É..." list="routesList" autocomplete="off" />
      <datalist id="routesList"></datalist>

      <select id="remoteRoutes" style="min-width:260px; margin-top:6px;">
        <option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>
      </select>

      <div class="btn-row" style="margin-top:6px;">
        <button id="refreshList" class="btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
        <button id="loadMoreRoutes" class="btn">‚¨áÔ∏è –©–µ</button>
        <button id="loadAllRoutes" class="btn">üì• –í—Å—ñ</button>
        <button id="loadFromDB" class="btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ –ë–î</button>
        <button id="deleteFromDB" class="btn">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –ë–î</button>
      </div>
    </div>
  </div>

  <!-- === –ü–ê–ù–ï–õ–¨ 3: –ü–û–ì–û–î–ñ–ï–ù–ù–Ø === -->
  <div id="panel-approve" class="panel">
    <div id="approvalPanel">
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <span class="km-chip">–°—Ç–∞—Ç—É—Å: <b id="approvalStatus">‚Äî</b></span>
        <button id="sendForApproval" class="btn xs" title="–ü–æ–¥–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è –°–ë">üì® –ù–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è</button>
        <button id="copyReviewLink" class="btn xs" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –°–ë">üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <a id="openReviewLink" class="btn xs" target="_blank" style="display:none">üëÅ‚Äçüó® –ü–µ—Ä–µ–≥–ª—è–¥</a>
      </div>

      <div id="approvalCommentWrap" style="margin-top:6px; display:none;">
        <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –°–ë (—è–∫—â–æ –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ)</label>
        <textarea id="approvalComment" readonly></textarea>
      </div>
    </div>
  </div>
</div>

<div id="map"></div>
<!-- –ó–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∏–π —Å—Ç–∞—Ç—É—Å –º–∞—Ä—à—Ä—É—Ç—É -->
<!-- –î–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó (–ø—Ä–∞–≤–æ—Ä—É—á —É–≥–æ—Ä—ñ) -->
<div id="statusDock">
  <div id="statusChip" class="status-chip" data-status="draft">üìù –°—Ç–∞—Ç—É—Å: –ß–µ—Ä–Ω–µ—Ç–∫–∞</div>
  <div id="distanceChip" class="status-chip">üìè –í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º: <span id="distanceTop">0</span></div>
</div>

<!-- –ü–µ—Ä–µ–º–∏–∫–∞—á –ø–∞–Ω–µ–ª–µ–π (–ø—Ä–∞–≤–æ—Ä—É—á –≤–Ω–∏–∑—É) -->
<div id="panelDock">
  <button class="dock-btn active" data-panel="panel-create">‚úèÔ∏è –°—Ç–≤–æ—Ä–µ–Ω–Ω—è</button>
  <button class="dock-btn" data-panel="panel-load">üìö –ë–∞–∑–∞</button>
  <button class="dock-btn" data-panel="panel-approve">‚úÖ –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è</button>
</div>

<div id="contextMenu">
  <div id="insertAfter">‚ûï–í—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ—Å–ª—è</div>
  <div id="deletePoint">‚ùå–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É</div>
</div>

<div id="dupModal" class="modal" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="dupTitle">
    <div id="dupTitle" class="modal-title">–ú–∞—Ä—à—Ä—É—Ç –≤–∂–µ —ñ—Å–Ω—É—î</div>
    <div class="modal-body">
      <div id="dupText"></div>
    </div>
    <div class="modal-actions">
      <button id="dupOverwrite" class="btn">–û–∫ ‚Äî –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏</button>
      <button id="dupCopy" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–ø—ñ—é</button>
      <button id="dupCancel" class="btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<!-- AUTH GUARD (cache-first, –±–µ–∑ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏) -->
<script>
(function(){
  const CFG = window.APP_CONFIG?.firebase;
  if (!CFG) {
    console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js');
    return;
  }
    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) {}

  // (–†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û) —Ñ–æ—Ä—Å—É–≤–∞—Ç–∏ long-polling —É ¬´–≤—É–∑—å–∫–∏—Ö¬ª –º–µ—Ä–µ–∂–∞—Ö
  try {
    firebase.firestore().settings({
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });
  } catch(_) {}

  // –£–≤—ñ–º–∫–Ω—É—Ç–∏ persistence –î–û –ø–µ—Ä—à–∏—Ö —á–∏—Ç–∞–Ω—å —ñ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ–º—ñ—Å –≥–ª–æ–±–∞–ª—å–Ω–æ
  window.__PERSISTENCE_PROMISE = (async () => {
    try { await firebase.firestore().enablePersistence({ synchronizeTabs: true }); }
    catch(_) {} // –æ–∫, —è–∫—â–æ –≤–∂–µ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –∞–±–æ —ñ–Ω—à–∞ –≤–∫–ª–∞–¥–∫–∞
  })();

  const auth = firebase.auth();
  const db   = firebase.firestore();

  const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
  const ALLOWED  = new Set(['admin','logist','user']);

  // –ù–ï —Ö–æ–≤–∞—î–º–æ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äì –ø–æ–∫–∞–∑—É—î–º–æ –æ–¥—Ä–∞–∑—É.
  auth.onAuthStateChanged(async (u) => {
    if (!u) { location.replace(loginURL); return; }
        // –¥–æ—á–µ–∫–∞—Ç–∏—Å—è, —â–æ–± –∫–µ—à —Ä–µ–∞–ª—å–Ω–æ –ø—ñ–¥–≥–æ—Ç—É–≤–∞–≤—Å—è
    if (window.__PERSISTENCE_PROMISE) {
      try { await window.__PERSISTENCE_PROMISE; } catch(_) {}
    }

    // 1) —à–≤–∏–¥–∫–æ –±–µ—Ä–µ–º–æ —Ä–æ–ª—å —ñ–∑ –∫–µ—à—É (—è–∫—â–æ —î) ‚Äî –ª–∏—à–µ users/{uid}
    let role = null;
    try {
      const snap = await db.collection('users').doc(u.uid).get({ source: 'cache' });
      role = snap.exists ? String(snap.data().role ?? 'pending').trim().toLowerCase() : null;
      console.log('[role][cache] uid:', u.uid, 'role:', role, 'data:', snap.data());
    } catch (e) { console.warn('[role][cache] error:', e?.message||e); }

    window.__userRole = role || 'guest';

    // –ü–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è –∞–¥–º—ñ–Ω-–ª—ñ–Ω–∫—ñ–≤ ¬´–Ω–∞ –∑–∞—Ä–∞–∑¬ª
    ['adminLink','adminLinkViewer','uploadRoutesLink'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = (window.__userRole === 'admin') ? '' : 'none';
    });

    // 2) —Ç–∏—Ö–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–ª—å –∑ —Å–µ—Ä–≤–µ—Ä–∞ —ñ, —è–∫—â–æ –Ω–µ –æ–∫ ‚Äî —Ä–µ–¥—ñ—Ä–µ–∫—Ç–∏–º–æ
    (async () => {
      try {
        const s = await db.collection('users').doc(u.uid).get({ source: 'server' });
        const r = s.exists ? String(s.data().role ?? 'pending').trim().toLowerCase() : 'pending';
        window.__userRole = r;
        console.log('[role][server] uid:', u.uid, 'role:', r, 'data:', s.data());

        ['adminLink','adminLinkViewer','uploadRoutesLink'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = (r === 'admin') ? '' : 'none';
        });

        if (!ALLOWED.has(r)) {
          alert(r === 'pending'
            ? '–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
            : '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏.');
          location.replace(loginURL);
        }
      } catch (e) {
        console.error('Role check (server) failed:', e);
        if (e && (e.code === 'permission-denied' || /permission/i.test(String(e.message||'')))){
          alert('–ù–µ–º–∞—î –¥–æ–∑–≤–æ–ª—É —á–∏—Ç–∞—Ç–∏ users/' + u.uid + '. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore (allow read –¥–ª—è —Å–≤–æ–≥–æ uid).');
        }
      }
    })();
  });
})();
</script>

<script>
/* ===================== Mapbox init ===================== */
mapboxgl.accessToken = window.APP_CONFIG?.mapboxToken || '';
if (!mapboxgl.accessToken) console.error('APP_CONFIG.mapboxToken –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.');
let currentStyle = 'mapbox://styles/mapbox/streets-v12';
const map = new mapboxgl.Map({ container: 'map', style: currentStyle, center: [28.468, 49.234], zoom: 12 });

/* ‚¨áÔ∏è –¥–æ–¥–∞–π —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é */
function hideSplash(){
  const s = document.getElementById('splash');
  if (s) { s.classList.add('hide'); setTimeout(() => s.remove(), 300); }
}

/* ==== MULTI TILESETS CONFIG (–∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é –¥–æ —Ö–∞–±—ñ–≤) ==== */
const TILESETS = [
  { key: 'bb2', url: 'mapbox://route-project.28u0jygh', layer: 'hmilnik-1xdu96',       hubs: ['–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π'] },
  { key: '06s', url: 'mapbox://route-project.bv9r5t6a', layer: 'uarushiv-1602z5',      hubs: ['–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π'] },
  { key: '61a', url: 'mapbox://route-project.cwrw3fvi', layer: 'tomashpil-14pg1k',     hubs: ['–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π'] },
  { key: '62a', url: 'mapbox://route-project.dfky75m6', layer: 'sklad-0knlqz',         hubs: ['–ú–•–ü'] },
  { key: '63a', url: 'mapbox://route-project.04u4bn8m', layer: 'vin_hub1-d77dfz',      hubs: ['–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π'] },
  { key: '64a', url: 'mapbox://route-project.bym769jm', layer: 'elevator2-7kdj7j',     hubs: ['–ú–•–ü'] },
  { key: '65a', url: 'mapbox://route-project.5m3es1zq', layer: 'let-agro-bar-2cw520',  hubs: ['–ú–•–ü'] },
];
// –Ø–∫—â–æ —è–∫–∏–π—Å—å tileset –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –≤–∏–¥–∏–º–∏–º —É—Å—ñ–º ‚Äî –ø–æ—Å—Ç–∞–≤ hubs: ['*']

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –¥–æ–∑–≤–æ–ª–µ–Ω–æ tileset –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∑–∞ —Ö–∞–±–∞–º–∏
function tilesetAllowedForUser(ts){
  const tags = Array.isArray(ts.hubs) ? ts.hubs : [];
  if (!tags.length || tags.includes('*')) return true;    // –Ω–µ —Ä–æ–∑–º—ñ—á–µ–Ω–æ –∞–±–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π
  if (isAllHubs()) return true;                           // –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –¥–æ–∑–≤–æ–ª–µ–Ω–æ "–≤—Å—ñ —Ö–∞–±–∏"
  return tags.some(h => (ALLOWED_HUBS || []).includes(h));
}

// –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤–∏–¥–∏–º—ñ—Å—Ç—å —à–∞—Ä—ñ–≤ tileset-—ñ–≤ –∑–≥—ñ–¥–Ω–æ –¥–æ—Å—Ç—É–ø—É
function applyTilesetHubVisibility(){
  TILESETS.forEach(ts => {
    const vis = tilesetAllowedForUser(ts) ? 'visible' : 'none';
    const ids = [
      `tileset-fill-${ts.key}`,
      `tileset-outline-${ts.key}`,
      `tileset-hl-from-${ts.key}`,
      `tileset-hl-to-${ts.key}`,
      `tileset-hl-from-label-${ts.key}`,
      `tileset-hl-to-label-${ts.key}`,
    ];
    ids.forEach(id => { if (map.getLayer(id)) try{ map.setLayoutProperty(id, 'visibility', vis); }catch{} });
  });

  // –ü—ñ–¥–ø–∏—Å–∏ —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤ –ø–µ—Ä–µ–±—É–¥—É—î–º–æ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –≤–∏–¥–∏–º–∏—Ö —à–∞—Ä—ñ–≤
  try { buildGeozoneCentroids(); } catch(_) {}
}

// –ë–µ–∑–ø–µ—á–Ω–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ (–∫–æ–ª–∏ —Å—Ç–∏–ª—å —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è)
function applyTilesetHubVisibilitySafe(){
  try {
    if (!map || !map.isStyleLoaded || !map.isStyleLoaded()){
      map.once('style.load', applyTilesetHubVisibility);
    } else {
      applyTilesetHubVisibility();
    }
  } catch(_){}
}

// —Ç—Ä–µ–∫–∞—Ç–∏–º–µ–º–æ —Å—Ç–≤–æ—Ä–µ–Ω—ñ id —à–∞—Ä—ñ–≤, —â–æ–± –Ω–∞–≤–æ–¥–∏—Ç–∏/–ø—ñ–¥—Å–≤—ñ—á—É–≤–∞—Ç–∏
let TS_FILL_IDS = [];
let TS_OUTLINE_IDS = [];
let BOUND_HOVER_LAYERS = new Set(); // —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø–æ–¥—ñ—ó

/* ==== –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø–∞–Ω–µ–ª–µ–π (dock —É –ø—Ä–∞–≤–æ–º—É –Ω–∏–∂–Ω—å–æ–º—É –∫—É—Ç—ñ) ==== */
function showPanel(id){
  document.querySelectorAll('#controls .panel').forEach(p=>{
    p.classList.toggle('active', p.id === id);
  });
  // –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —É dock
  document.querySelectorAll('#panelDock .dock-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.panel === id);
  });
  // –¥—Ä—ñ–±–Ω–∏–π —Ä–µ—Å–∞–π–∑ –∫–∞—Ä—Ç–∏ –ø—ñ—Å–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
  requestAnimationFrame(()=>{ try{ map.resize(); }catch(_){ } });
}

document.getElementById('panelDock').addEventListener('click', (e)=>{
  const btn = e.target.closest('.dock-btn');
  if (!btn) return;
  showPanel(btn.dataset.panel);
});

// —Å—Ç–∞—Ä—Ç–æ–≤–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
showPanel('panel-create');

/* ==== HIGHLIGHT (FROM/TO) CONFIG ==== */
const NAME_KEYS = ['Name','name','–ù–∞–∑–≤–∞','–ù–∞–∑–≤–∞ –ø–æ–ª—è'];
const CODE_KEYS = ['Code','code','–ö–æ–¥'];

let HL_IDS_FROM = [];
let HL_IDS_TO   = [];
// ‚¨áÔ∏è –Ω–æ–≤–µ ‚Äî id —Å–∏–º–≤–æ–ª-—à–∞—Ä—ñ–≤ (–ø—ñ–¥–ø–∏—Å–∏) –¥–ª—è –æ–±—Ä–∞–Ω–∏—Ö –í—ñ–¥/–î–æ
let HL_LABEL_IDS_FROM = [];
let HL_LABEL_IDS_TO   = [];

// OR-—Ñ—ñ–ª—å—Ç—Ä –ø–æ –∫—ñ–ª—å–∫–æ—Ö –Ω–∞–∑–≤–∞—Ö –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π
function buildAnyMatch(keys, value){
  if (value === null || value === undefined || String(value).trim() === '') return null;
  const v = String(value);
  const parts = keys.map(k => ['==', ['get', k], v]);
  return parts.length === 1 ? parts[0] : ['any', ...parts];
}

// —à—É–∫–∞—î–º–æ –∞–±–æ –ø–æ –ù–∞–∑–≤—ñ, –∞–±–æ –ø–æ –ö–æ–¥—É
function buildNameCodeFilter(nameVal, codeVal){
  const n = buildAnyMatch(NAME_KEYS, nameVal);
  const c = buildAnyMatch(CODE_KEYS, codeVal);
  if (n && c) return ['any', n, c];
  if (n) return n;
  if (c) return c;
  return ['==', ['get','__never__'], 1]; // –Ω—ñ—á–æ–≥–æ –Ω–µ –º–∞—Ç—á–∏–º–æ
}

// –≤–∏—Ç—è–≥—É—î–º–æ "—á–∏—Å—Ç—É" –Ω–∞–∑–≤—É –∑ —ñ–Ω–ø—É—Ç—É (—è–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ –∫–æ–¥ ‚Äî –±–µ—Ä–µ–º–æ –Ω–∞–∑–≤—É –∑ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞)
function getPureNameFromInput(inputId){
  const code = getCodeByInput(inputId);
  if (code) return getNameByCode(code);
  const raw = (document.getElementById(inputId).value || '').trim();
  return parseNameFromLabel(raw) || raw;
}

/* ===== Helpers –¥–ª—è –Ω–æ–≤–æ—ó —Å—Ö–µ–º–∏ GeoJSON (Client, Code, Name, Farm, Area) ===== */
function pickProp(obj, ...keys){
  for (const k of keys){
    const v = obj && obj[k];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return '';
}
function fmtArea(val){
  const n = Number(val);
  if (!isFinite(n)) return '';
  return n.toLocaleString('uk-UA', { maximumFractionDigits: 2 });
}
function getFieldProps(props){
  return {
    client: pickProp(props, 'Client', 'client', '–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ'),
    code:   pickProp(props, 'Code', 'code', '–ö–æ–¥'),
    name:   pickProp(props, 'Name', 'name', '–ù–∞–∑–≤–∞', '–ù–∞–∑–≤–∞ –ø–æ–ª—è'),
    farm:   pickProp(props, 'Farm', 'farm', '–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª', '–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª', 'department', 'unit'),
    area:   pickProp(props, 'Area', 'area', 'Area_ha', 'Area (ha)', '–ü–ª–æ—â–∞', '–ü–ª–æ—â–∞, –≥–∞')
  };
}

const topbarEl = document.querySelector('header.topbar');
function updateLayoutHeights(){
  const h = (topbarEl?.offsetHeight || 56);
  document.documentElement.style.setProperty('--nav-real', h + 'px');
  try { map.resize(); } catch(_) {}
}
window.addEventListener('resize', updateLayoutHeights);
updateLayoutHeights();

/* === –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –ø—ñ–¥–ø–∏—Å–∏ === */
function applyUkrainianLabels(){
  const style = map.getStyle();
  if (!style || !style.layers) return;
  const ukTextExpr = [
    'coalesce',['get','name_uk'],['get','name:uk'],['get','name_ua'],['get','name:ua'],['get','name_local'],['get','name']
  ];
  const skip = new Set(['geozones-labels','geozones-label']);
  style.layers.forEach(l => {
    if (l.type !== 'symbol') return;
    if (skip.has(l.id)) return; // üëà –Ω–µ —á—ñ–ø–∞—î–º–æ –Ω–∞—à—ñ –ø—ñ–¥–ø–∏—Å–∏ –ø–æ–ª—ñ–≤
    const hasTextField = map.getLayoutProperty(l.id, 'text-field') !== undefined;
    if (hasTextField) { try { map.setLayoutProperty(l.id, 'text-field', ukTextExpr); } catch(_) {} }
  });
}

let addMode = false, startLineMode = false, endLineMode = false;
let insertAfterMode = false;
let points = [], markers = [], startRuler = [], endRuler = [], rulerLines = [], routeLayers = [];
let selectedMarkerIndex = null;

let activeRuler = null; let lastActiveRuler = null;
function setActiveRuler(which){ activeRuler = which; if (which) lastActiveRuler = which; }

/* ====== Roles ====== */
let currentRole = 'guest';
let readOnly    = true;
// –ú–∏—Ç—Ç—î–≤–æ –ø—ñ–¥–Ω—è—Ç–∏ —Ä–æ–ª—å/—Ö–∞–±–∏ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (—è–∫—â–æ –≤–æ–Ω–∏ —î –≤ sessionStorage)
(function(){
  try{
    const raw = sessionStorage.getItem('role.cache.v1');
    if (!raw) return;
    const { role, hubs, all, ts } = JSON.parse(raw) || {};
    // 2 —Ö–≤ ‚Äî –¥–æ—Å—Ç–∞—Ç–Ω—å–æ, —â–æ–± ¬´–¥–æ–∂–∏—Ç–∏¬ª –¥–æ —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ —Ñ–µ—Ç—á—É –∑ Firestore
    if (!ts || (Date.now() - ts) > 2*60*1000) return;

    // –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥—Ä—ñ–≤–∞—î–º–æ –∑–º—ñ–Ω–Ω—ñ; applyRoleUI –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –Ω–∏–∂—á–µ –≤ onAuthStateChanged
    window.__userRole = role || 'guest';
    if (all === true)        window.ALLOWED_HUBS = []; // [] = –≤—Å—ñ —Ö–∞–±–∏
    else if (Array.isArray(hubs)) window.ALLOWED_HUBS = hubs;
  }catch(_){}
})();

function applyRoleUI(role){
  // –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ
  role = (role || 'guest').toString().toLowerCase();
  currentRole = role;
  readOnly = (role === 'guest' || role === 'user');

  // ‚¨áÔ∏è –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∞–¥–º—ñ–Ω-–ª—ñ–Ω–∫ –ª–∏—à–µ –∞–¥–º—ñ–Ω–∞–º
  ['adminLink','adminLinkViewer','uploadRoutesLink'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.style.display = (role === 'admin') ? '' : 'none';
});

  const disableIds = [
    'toggleAdd','startLineMode','endLineMode','clearRoute','popRulerPoint','clearRulers',
    'saveRoute','loadRoute','saveToDB','deleteFromDB','routeName',
    'fromName','toName','routeType','routePurpose','intermediateText',
	// ‚¨áÔ∏è –¥–æ–¥–∞–π —Ü—ñ –¥–≤—ñ –∫–Ω–æ–ø–∫–∏, —â–æ–± user –Ω–µ –º—ñ–≥ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
    'sendForApproval','copyReviewLink',
  'hubSelect' // üëà –¥–æ–¥–∞–Ω–æ
  ];
  disableIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
      el.disabled = readOnly;
    } else {
      el.disabled = readOnly;
      el.classList.toggle('muted', readOnly);
    }
  });

  document.getElementById('loadFromDB').disabled = false;
  document.getElementById('refreshList').disabled = false;
  document.getElementById('remoteRoutes').disabled = false;
  document.getElementById('routeSearch').disabled = false;

  document.getElementById('roleChip').textContent = '–†–æ–ª—å: ' + (currentRole || '‚Äì');
}

/* ===== Context menu ===== */
const contextMenu = document.getElementById('contextMenu');
const insertAfterBtn = document.getElementById('insertAfter');
const deletePointBtn = document.getElementById('deletePoint');

insertAfterBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) insertAfterMode = true;
  contextMenu.style.display = 'none';
};
deletePointBtn.onclick = (e) => {
  e.preventDefault(); e.stopPropagation();
  if (readOnly) { contextMenu.style.display='none'; return; }
  if (selectedMarkerIndex !== null) {
    points.splice(selectedMarkerIndex, 1);
    rebuildMarkers();
  }
  contextMenu.style.display = 'none';
  selectedMarkerIndex = null;
};
document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

/* ========= ‚¨áÔ∏è –ì–µ–æ–∑–æ–Ω–∏ –∑ Mapbox Tilesets (multi) ========= */

// –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤ –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤ –∑ –£–°–Ü–• tileset fill-—à–∞—Ä—ñ–≤
function buildGeozoneCentroids(){
  if (!window.turf || TS_FILL_IDS.length === 0) return;

  const feats = map.queryRenderedFeatures({ layers: TS_FILL_IDS }) || [];
  const seen = new Set();
  const out = [];

  for (const f of feats){
    const p = f.properties || {};
    const fp = getFieldProps(p);
    const label = fp.name || fp.code || '–ü–æ–ª–µ';

    // –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á —ñ–∑ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π;
    // –¥–æ–¥–∞—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å –¥–∂–µ—Ä–µ–ª–∞, —â–æ–± –Ω–µ –∑–º—ñ—à—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ tilesets
    const src = f.source || 'ts';
    const key = `${src}:${p.id || p.fid || p.OBJECTID || p.OBJECTID_1 || p.Code || p.Name || label}`;
    if (seen.has(key)) continue;

    let center = null;
    try { center = turf.centerOfMass(f).geometry.coordinates; }
    catch(_){
      try { const b = turf.bbox(f); center = [(b[0]+b[2])/2,(b[1]+b[3])/2]; } catch(_){}
    }
    if (!center) continue;

    out.push({ type:'Feature', geometry:{ type:'Point', coordinates:center }, properties:{ label } });
    seen.add(key);
  }

  const fc = { type:'FeatureCollection', features: out };

  if (map.getSource('geozones-centroids')){
    map.getSource('geozones-centroids').setData(fc);
  } else {
    map.addSource('geozones-centroids', { type:'geojson', data: fc });
    map.addLayer({
      id: 'geozones-labels',
      type: 'symbol',
      source: 'geozones-centroids',
      layout: {
        'text-field': ['get','label'],
        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
        'text-size': 12,
        'text-anchor': 'center',
        'text-allow-overlap': false
      },
      paint: {
        'text-color': '#1f2937',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1.2
      }
    });
  }
}

// —Å—Ç–≤–æ—Ä—é—î–º–æ –í–°–Ü –≤–µ–∫—Ç–æ—Ä–Ω—ñ –¥–∂–µ—Ä–µ–ª–∞/—à–∞—Ä–∏ –∑ –º–∞—Å–∏–≤—É TILESETS
function addTilesets(){
  TS_FILL_IDS = [];
  TS_OUTLINE_IDS = [];

  TILESETS.forEach(ts => {
    const sourceId = `geozones-tileset-${ts.key}`;
    if (!map.getSource(sourceId)){
      map.addSource(sourceId, { type: 'vector', url: ts.url });
    }

    const fillId = `tileset-fill-${ts.key}`;
    const outlineId = `tileset-outline-${ts.key}`;

    if (!map.getLayer(fillId)){
      map.addLayer({
        id: fillId,
        type: 'fill',
        source: sourceId,
        'source-layer': ts.layer,
        paint: { 'fill-color': '#22c55e', 'fill-opacity': 0.18 }
      });
    }

    if (!map.getLayer(outlineId)){
      map.addLayer({
        id: outlineId,
        type: 'line',
        source: sourceId,
        'source-layer': ts.layer,
        paint: { 'line-color': '#16a34a', 'line-width': 1.2 }
      });
    }

    TS_FILL_IDS.push(fillId);
    TS_OUTLINE_IDS.push(outlineId);
  });

  // –∑–±—É–¥—É–≤–∞—Ç–∏ —Ü–µ–Ω—Ç—Ä–æ—ó–¥–∏-–ø—ñ–¥–ø–∏—Å–∏ –¥–ª—è –í–°–Ü–• fill-—à–∞—Ä—ñ–≤
  buildGeozoneCentroids();
  map.off('moveend', rebuildLabelsOnce);
  map.on('moveend', rebuildLabelsOnce);

  // –ø–æ–≤—ñ—Å–∏—Ç–∏ hover-handlers –Ω–∞ –≤—Å—ñ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è/–∫–æ–Ω—Ç—É—Ä–∏
  bindTilesetHoverHandlers();
    // ‚¨áÔ∏è –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤–∏–¥–∏–º—ñ—Å—Ç—å tileset-—ñ–≤ –∑–∞ –¥–æ—Å—Ç—É–ø–∞–º–∏ —Ö–∞–±—ñ–≤
    // —Ç—ñ–ª—å–∫–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–æ–º tileset-–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –≤–∏–¥–∏–º—ñ
  applyTilesetHubVisibility();
}

const rebuildLabelsOnce = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),150); }; })(buildGeozoneCentroids);
/* ==== HIGHLIGHT LAYERS (—Å—Ç–≤–æ—Ä—é—î–º–æ —Ä–∞–∑, –¥–∞–ª—ñ —Ç—ñ–ª—å–∫–∏ –º—ñ–Ω—è—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏) ==== */

function ensureHighlightLayers(){
  // tilesets (vector)
  TILESETS.forEach(ts => {
    const srcId = `geozones-tileset-${ts.key}`;
    if (!map.getSource(srcId)) return;

    const mk = (type) => `tileset-hl-${type}-${ts.key}`;

    // FROM ‚Äî —Å–∏–Ω—ñ–π
    if (!map.getLayer(mk('from'))){
      map.addLayer({
        id: mk('from'),
        type: 'fill',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#3b82f6', 'fill-opacity': 0.45 }
      });
      HL_IDS_FROM.push(mk('from'));
    }
    // TO ‚Äî —Ä–æ–∂–µ–≤–∏–π
    if (!map.getLayer(mk('to'))){
      map.addLayer({
        id: mk('to'),
        type: 'fill',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#f43f5e', 'fill-opacity': 0.45 }
      });
      HL_IDS_TO.push(mk('to'));
    }
  });

  // GeoJSON –∑—ñ Storage
  if (map.getSource('geozones')){
    if (!map.getLayer('geozones-hl-from')){
      map.addLayer({
        id: 'geozones-hl-from',
        type: 'fill',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#3b82f6', 'fill-opacity': 0.45 }
      });
      HL_IDS_FROM.push('geozones-hl-from');
    }
    if (!map.getLayer('geozones-hl-to')){
      map.addLayer({
        id: 'geozones-hl-to',
        type: 'fill',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1],
        paint: { 'fill-color': '#f43f5e', 'fill-opacity': 0.45 }
      });
      HL_IDS_TO.push('geozones-hl-to');
    }
  }
  // ‚¨áÔ∏è –î–û–î–ê–ô –¶–ï –°–Æ–î–ò (–ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏–≤–Ω–æ—é –¥—É–∂–∫–æ—é —Ñ—É–Ω–∫—Ü—ñ—ó)
  ensureHighlightLabelLayers();   // —Å—Ç–≤–æ—Ä—é—î–º–æ label-—à–∞—Ä–∏ –¥–ª—è FROM/TO
  bindHighlightHoverHandlers();   // –≤–º–∏–∫–∞—î–º–æ hover-–ø—ñ–¥–∫–∞–∑–∫–∏ –ª–∏—à–µ –¥–ª—è FROM/TO
}
function ensureHighlightLabelLayers(){
  // GeoJSON (storage)
  if (map.getSource('geozones')){
    if (!map.getLayer('geozones-hl-from-label')){
      map.addLayer({
        id: 'geozones-hl-from-label',
        type: 'symbol',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1], // –∑–∞–ø–æ–≤–Ω–∏–º–æ —Ñ—ñ–ª—å—Ç—Ä–æ–º –¥–∞–ª—ñ
        layout: {
          'text-field': ['coalesce', ['get','_label'], ['get','Name'], ['get','name'], ['get','–ù–∞–∑–≤–∞'], ['get','–ù–∞–∑–≤–∞ –ø–æ–ª—è'], ['get','Code'], ['get','code'], '–ü–æ–ª–µ'],
          'text-size': 12, 'text-anchor':'center', 'text-allow-overlap': false
        },
        paint: { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_FROM.push('geozones-hl-from-label');
    }
    if (!map.getLayer('geozones-hl-to-label')){
      map.addLayer({
        id: 'geozones-hl-to-label',
        type: 'symbol',
        source: 'geozones',
        filter: ['==', ['get','__never__'], 1],
        layout: {
          'text-field': ['coalesce', ['get','_label'], ['get','Name'], ['get','name'], ['get','–ù–∞–∑–≤–∞'], ['get','–ù–∞–∑–≤–∞ –ø–æ–ª—è'], ['get','Code'], ['get','code'], '–ü–æ–ª–µ'],
          'text-size': 12, 'text-anchor':'center', 'text-allow-overlap': false
        },
        paint: { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_TO.push('geozones-hl-to-label');
    }
  }

  // Tilesets (vector) ‚Äî —Ä–æ–±–∏–º–æ –ø—ñ–¥–ø–∏—Å–∏ –ø—Ä—è–º–æ –∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –¥–∂–µ—Ä–µ–ª–∞
  TILESETS.forEach(ts => {
    const srcId = `geozones-tileset-${ts.key}`;
    if (!map.getSource(srcId)) return;

    const mk = type => `tileset-hl-${type}-label-${ts.key}`;
    const textExpr = ['coalesce', ['get','Name'], ['get','name'], ['get','–ù–∞–∑–≤–∞'], ['get','–ù–∞–∑–≤–∞ –ø–æ–ª—è'], ['get','Code'], ['get','code']];

    if (!map.getLayer(mk('from'))){
      map.addLayer({
        id: mk('from'),
        type: 'symbol',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        layout: { 'text-field': textExpr, 'text-size': 12, 'text-anchor': 'center', 'text-allow-overlap': false },
        paint:  { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_FROM.push(mk('from'));
    }
    if (!map.getLayer(mk('to'))){
      map.addLayer({
        id: mk('to'),
        type: 'symbol',
        source: srcId,
        'source-layer': ts.layer,
        filter: ['==', ['get','__never__'], 1],
        layout: { 'text-field': textExpr, 'text-size': 12, 'text-anchor': 'center', 'text-allow-overlap': false },
        paint:  { 'text-color':'#111', 'text-halo-color':'#fff', 'text-halo-width':1.2 }
      });
      HL_LABEL_IDS_TO.push(mk('to'));
    }
  });
}
function bindHighlightHoverHandlers(){
  [...HL_IDS_FROM, ...HL_IDS_TO].forEach(id => {
    if (BOUND_HOVER_LAYERS.has(id)) return;
    map.on('mousemove',  id, onHover);
    map.on('mouseleave', id, onLeave);
    BOUND_HOVER_LAYERS.add(id);
  });
}

function updateHighlights(){
  const fromName = getPureNameFromInput('fromName');
  const toName   = getPureNameFromInput('toName');
  const fromCode = getCodeByInput('fromName');
  const toCode   = getCodeByInput('toName');

  const fromFilter = buildNameCodeFilter(fromName, fromCode);
  const toFilter   = buildNameCodeFilter(toName, toCode);

  HL_IDS_FROM.forEach(id => { if (map.getLayer(id)) map.setFilter(id, fromFilter); });
  HL_IDS_TO.forEach(id   => { if (map.getLayer(id)) map.setFilter(id, toFilter); });
  // ‚¨áÔ∏è –ø—ñ–¥–ø–∏—Å–∏ –≤–∏–±—Ä–∞–Ω–∏—Ö
HL_LABEL_IDS_FROM.forEach(id => { if (map.getLayer(id)) map.setFilter(id, fromFilter); });
HL_LABEL_IDS_TO.forEach(id   => { if (map.getLayer(id)) map.setFilter(id, toFilter); });

  fitToHighlights();
}

function fitToHighlights(){
  try{
    const ids = [...HL_IDS_FROM, ...HL_IDS_TO].filter(id => map.getLayer(id));
    let bounds = null;
    ids.forEach(id => {
      const feats = map.queryRenderedFeatures({ layers: [id] });
      feats.forEach(f => {
        const b = turf.bbox(f);
        if (!bounds){
          bounds = new mapboxgl.LngLatBounds([b[0], b[1]], [b[2], b[3]]);
        } else {
          bounds.extend([b[0], b[1]]);
          bounds.extend([b[2], b[3]]);
        }
      });
    });
    if (bounds) map.fitBounds(bounds, { padding: 40, maxZoom: 14 });
  }catch(_){}
}

/* ========= ‚¨ÜÔ∏è –ì–µ–æ–∑–æ–Ω–∏ –∑ Mapbox Tilesets (multi) ========= */

map.on('style.load', () => {
hideSplash();            // ‚¨ÖÔ∏è —Å—Ö–æ–≤–∞—Ç–∏ —Å–ø–ª–µ—à, –∫–æ–ª–∏ —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–∏ –≥–æ—Ç–æ–≤–∏–π
  applyUkrainianLabels();
  updateRoute();
  drawRulers();

  if (geozonesDataCache) addGeozones(geozonesDataCache);
  addTilesets();

  // üî¶ –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ FROM/TO
  ensureHighlightLayers();
  ensureHighlightLabelLayers();
  bindHighlightHoverHandlers();
  updateHighlights();
  setGeozonesVisibility(geozonesVisible);
});

document.getElementById('mapStyle').addEventListener('change', function() {
  currentStyle = this.value;
  map.setStyle(currentStyle);
});

/* ==== POPUP (–ø–æ–≤–Ω–∏–π –ø–∞—Å–ø–æ—Ä—Ç –ø–æ–ª—è) ==== */
const popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false,
  maxWidth: '480px'   // ‚¨ÖÔ∏è –∑—Ä–æ–±–∏—Ç—å –≤—ñ–∫–Ω–æ —à–∏—Ä—à–∏–º
});

// –ø—Ä–æ—Å—Ç–µ –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å, —â–æ–± –Ω–µ –∑–ª–∞–º–∞—Ç–∏ HTML
function esc(v){
  return String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function hoverPopupHTML(props){
  const { name, client, farm, code, area } = getFieldProps(props || {});
  const rows = [
    ['–ù–∞–∑–≤–∞',         name],
    ['–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ',  client],
    ['–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª',     farm],
    ['–ö–æ–¥',           code],
    ['–ü–ª–æ—â–∞',         (area !== '' && area !== null && area !== undefined) ? (fmtArea(area) + ' –≥–∞') : '']
  ];

  const htmlRows = rows.map(([label, val]) =>
    `<div><b>${label}:</b> ${esc(val) || '‚Äî'}</div>`
  ).join('');

  return `<div style="font-size:13px;line-height:1.35;">${htmlRows}</div>`;
}

function onHover(e){
  const f = e.features && e.features[0];
  if (!f) return;
  map.getCanvas().style.cursor = 'pointer';
  popup
    .setLngLat(e.lngLat)
    .setHTML(hoverPopupHTML(f.properties || {}))
    .addTo(map);
}

function onLeave(){
  map.getCanvas().style.cursor = '';
  popup.remove();
}

function bindTilesetHoverHandlers(){
  // –ø—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å –Ω–∞ –≤—Å—ñ –∞–∫—Ç—É–∞–ª—å–Ω—ñ fill/outline
  [...TS_FILL_IDS, ...TS_OUTLINE_IDS].forEach(id => {
    if (BOUND_HOVER_LAYERS.has(id)) return;
    // —è–∫—â–æ —à–∞—Ä—É —â–µ –Ω–µ–º–∞ ‚Äî mapbox —Å–∞–º –∞–∫—Ç–∏–≤—É—î —Å–ª—É—Ö–∞—á, –∫–æ–ª–∏ —à–∞—Ä –∑'—è–≤–∏—Ç—å—Å—è
    map.on('mousemove',  id, onHover);
    map.on('mouseleave', id, onLeave);
    BOUND_HOVER_LAYERS.add(id);
  });
}

/* ===== Buttons state ===== */
// ‚¨áÔ∏è –¥–æ–¥–∞—Ç–∏ —Ç—É—Ç
function flyToRouteEdge(which){
  let target = null;

  // 1) –≥–æ–ª–æ–≤–Ω–∏–π –∫–µ–π—Å ‚Äî –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç (points)
  if (Array.isArray(points) && points.length){
    target = (which === 'start') ? points[0] : points[points.length - 1];
  }

  // 2) fallback ‚Äî —è–∫—â–æ points —â–µ –Ω–µ–º–∞—î, –±–µ—Ä–µ–º–æ –ª—ñ–Ω—ñ–π–∫–∏
  if (!target){
    if (which === 'start' && startRuler.length) target = startRuler[0];
    if (which === 'end'   && endRuler.length)   target = endRuler[endRuler.length - 1];
  }

  if (!target) return;
  try {
    map.flyTo({ center: target, zoom: Math.max(map.getZoom() || 0, 12), essential: true });
  } catch(_) {}
}
function toggleButton(id, flag) {
  const btn = document.getElementById(id);
  // –∑–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ª–µ–π–±–ª –æ–¥–∏–Ω —Ä–∞–∑
  if (!btn.dataset.label) btn.dataset.label = btn.textContent.split(':')[0].trim();

  // –ù–ï –º—ñ–Ω—è—î–º–æ —Ç–µ–∫—Å—Ç ‚Äî –ª–∏—à–∞—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π –ª–µ–π–±–ª
  btn.textContent = btn.dataset.label;

  // –≤—ñ–∑—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
  btn.classList.toggle('active', !!flag);
  btn.setAttribute('aria-pressed', !!flag);
}


document.getElementById('toggleAdd').onclick = () => {
  if (readOnly) return;
  addMode = !addMode; startLineMode = false; endLineMode = false; insertAfterMode = false;
  setActiveRuler(null);
  toggleButton('toggleAdd', addMode); toggleButton('startLineMode', false); toggleButton('endLineMode', false);
};
document.getElementById('startLineMode').onclick = () => {
  if (readOnly) return;
  startLineMode = !startLineMode; endLineMode = false; addMode = false; insertAfterMode = false;
  setActiveRuler(startLineMode ? 'start' : null);
  toggleButton('startLineMode', startLineMode); toggleButton('endLineMode', false); toggleButton('toggleAdd', false);
  // ‚¨áÔ∏è –¥–æ–¥–∞—Ç–∏
  if (startLineMode) flyToRouteEdge('start');
};
document.getElementById('endLineMode').onclick = () => {
  if (readOnly) return;
  endLineMode = !endLineMode; startLineMode = false; addMode = false; insertAfterMode = false;
  setActiveRuler(endLineMode ? 'end' : null);
  toggleButton('endLineMode', endLineMode); toggleButton('startLineMode', false); toggleButton('toggleAdd', false);
  // ‚¨áÔ∏è –¥–æ–¥–∞—Ç–∏
  if (endLineMode) flyToRouteEdge('end');
};

document.getElementById('popRulerPoint').onclick = () => {
  if (readOnly) return;
  const choose = () => activeRuler || lastActiveRuler || (startRuler.length >= endRuler.length ? 'start' : 'end');
  let target = choose();
  if (target === 'start' && startRuler.length === 0 && endRuler.length > 0) target = 'end';
  if (target === 'end' && endRuler.length === 0 && startRuler.length > 0) target = 'start';
  let did = false;
  if (target === 'start' && startRuler.length) { startRuler.pop(); did = true; }
  if (target === 'end' && endRuler.length) { endRuler.pop(); did = true; }
  if (did){ drawRulers(); updateRoute(); }
};

document.getElementById('clearRulers').onclick = () => {
  if (readOnly) return;
  if (activeRuler === 'start') { startRuler = []; }
  else if (activeRuler === 'end') { endRuler = []; }
  else {
    if (!startRuler.length && !endRuler.length) return;
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –æ–±–∏–¥–≤—ñ –ª—ñ–Ω—ñ–π–∫–∏?')) return;
    startRuler = []; endRuler = [];
  }
  drawRulers(); updateRoute();
};

document.getElementById('clearRoute').onclick = () => {
  if (readOnly) return;
  points = []; markers.forEach(m => m.remove()); markers = [];
  clearRouteLayers(); updateRoute();
};

/* ===== Map click ===== */
map.on('click', (e) => {
  const lngLat = [e.lngLat.lng, e.lngLat.lat];
  contextMenu.style.display = 'none';
  if (readOnly) return;

  if (insertAfterMode && selectedMarkerIndex !== null) {
    points.splice(selectedMarkerIndex + 1, 0, lngLat);
    insertAfterMode = false; rebuildMarkers(); return;
  }
  if (startLineMode) { startRuler.push(lngLat); setActiveRuler('start'); drawRulers(); updateRoute(); return; }
  if (endLineMode)   { endRuler.push(lngLat); setActiveRuler('end');   drawRulers(); updateRoute(); return; }
  if (addMode)       { points.push(lngLat); addMarker(lngLat); updateRoute(); }
});

function addMarker(lngLat, index = points.length - 1) {
  const marker = new mapboxgl.Marker({ draggable: !readOnly }).setLngLat(lngLat).addTo(map);
  marker.getElement().addEventListener('contextmenu', (e) => {
    e.preventDefault(); e.stopPropagation();
    if (readOnly) return;
    selectedMarkerIndex = index;
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top  = e.pageY + 'px';
    contextMenu.style.display = 'block';
  });
  marker.on('dragend', () => {
    if (readOnly) return;
    const ll = marker.getLngLat();
    points[index] = [ll.lng, ll.lat];
    updateRoute();
  });
  markers.push(marker);
}

function rebuildMarkers() {
  markers.forEach(m => m.remove()); markers = [];
  points.forEach((pt, idx) => addMarker(pt, idx));
  selectedMarkerIndex = null; insertAfterMode = false; contextMenu.style.display = 'none';
  updateRoute();
}

let markersVisible = true;
document.getElementById('toggleMarkers').onclick = () => {
  markersVisible = !markersVisible;
  markers.forEach(m => m.getElement().style.display = markersVisible ? 'block' : 'none');
  document.getElementById('toggleMarkers').textContent = markersVisible ? 'üìç –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–æ—á–∫–∏' : 'üìç –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–∫–∏';
};
/* ===== Geozones toggle (all related layers) ===== */
let geozonesVisible = true;

function setLayerVisibility(id, visible){
  try {
    if (map.getLayer(id)) {
      map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');
    }
  } catch(_) {}
}
// üîß –ë–∞–∑–æ–≤—ñ –Ω–µ–ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ –¥–ª—è –≥–µ–æ–∑–æ–Ω
const GZ_DEFAULTS = { fill: 0.18, line: 1, circle: 1, symbol: 1 };

// –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ opacity –¥–ª—è —à–∞—Ä—É –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –π–æ–≥–æ —Ç–∏–ø—É
function setLayerOpacity(id, opacity){
  if (!map.getLayer(id)) return;
  const type = map.getLayer(id).type;
  const prop = type === 'fill'   ? 'fill-opacity'
            : type === 'line'   ? 'line-opacity'
            : type === 'circle' ? 'circle-opacity'
            : type === 'symbol' ? 'text-opacity'
            : null;
  if (!prop) return;
  try { map.setPaintProperty(id, prop, opacity); } catch(_) {}
}

// –ú–∞—Å–æ–≤–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ opacity –¥–æ –ø–µ—Ä–µ–ª—ñ–∫—É —à–∞—Ä—ñ–≤
function setManyOpacity(ids, opacity){
  ids.forEach(id => setLayerOpacity(id, opacity));
}

function setGeozonesVisibility(visible){
  const hasFromSel = !!(getCodeByInput('fromName') || (document.getElementById('fromName').value || '').trim());
  const hasToSel   = !!(getCodeByInput('toName')   || (document.getElementById('toName').value   || '').trim());

  // –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ö–∞–π–ª–∞–π—Ç–∏ (–í—ñ–¥/–î–æ), —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –≥–µ–æ–∑–æ–Ω–∏ –ê–ë–û —î –≤–∏–±—ñ—Ä –ø–æ–ª—ñ–≤
  const showHL = visible || hasFromSel || hasToSel;

  // 1) –ë–∞–∑–æ–≤—ñ –ø—ñ–¥–ø–∏—Å–∏ —É—Å—ñ—Ö –≥–µ–æ–∑–æ–Ω:
  //    ‚Äî –≤–∏–¥–Ω–æ –¢–Ü–õ–¨–ö–ò –∫–æ–ª–∏ —Ç—É–º–±–ª–µ—Ä —É–≤—ñ–º–∫–Ω–µ–Ω–æ
  ['geozones-label','geozones-labels'].forEach(id => {
    if (map.getLayer(id)) setLayerVisibility(id, !!visible);
  });

  // 2) –ë–∞–∑–æ–≤—ñ –≥–µ–æ–∑–æ–Ω–∏ (—É—Å—ñ –ø–æ–ª—è):
  //    ‚Äî –∫–æ–ª–∏ —Ç—É–º–±–ª–µ—Ä –≤–∏–º–∫–Ω–µ–Ω–æ, –ø–æ–≤–Ω—ñ—Å—Ç—é —Ö–æ–≤–∞—î–º–æ (visibility:none), —â–æ–± –Ω–µ –±—É–ª–æ hover –ø–æ –≤—Å—ñ—Ö
  [['geozones-fill','fill'], ['geozones-outline','line'], ['geozones-point','circle']].forEach(([id, kind]) => {
    if (!map.getLayer(id)) return;
    setLayerVisibility(id, !!visible);
    setLayerOpacity(id, visible ? GZ_DEFAULTS[kind] : 0);
  });
  TS_FILL_IDS.forEach(id => {
  const key = id.replace('tileset-fill-','');
  const ts  = TILESETS.find(t => t.key === key);
  const allowed = ts ? tilesetAllowedForUser(ts) : true;
  setLayerVisibility(id, !!visible && allowed);
  setLayerOpacity(id, visible ? GZ_DEFAULTS.fill : 0);
});

TS_OUTLINE_IDS.forEach(id => {
  const key = id.replace('tileset-outline-','');
  const ts  = TILESETS.find(t => t.key === key);
  const allowed = ts ? tilesetAllowedForUser(ts) : true;
  setLayerVisibility(id, !!visible && allowed);
  setLayerOpacity(id, visible ? GZ_DEFAULTS.line : 0);
});

  // 3) –•–∞–π–ª–∞–π—Ç-–∑–∞–ª–∏–≤–∫–∏ —Ç–∞ —ó—Ö –ø—ñ–¥–ø–∏—Å–∏ (—Ç—ñ–ª—å–∫–∏ –í—ñ–¥/–î–æ)
  [...HL_IDS_FROM, ...HL_IDS_TO, ...HL_LABEL_IDS_FROM, ...HL_LABEL_IDS_TO]
    .forEach(id => setLayerVisibility(id, showHL));

  // –í—Å–µ: –∫–æ–ª–∏ –≥–µ–æ–∑–æ–Ω–∏ ¬´–≤–∏–º–∫–Ω–µ–Ω–æ¬ª, –≤–∏–¥–Ω–æ –π —Ä–µ–∞–≥—É—é—Ç—å —Ç—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω—ñ (—á–µ—Ä–µ–∑ —Ö–∞–π–ª–∞–π—Ç–∏).
}

function updateGeozonesToggleLabel(){
  const b = document.getElementById('toggleGeozones');
  if (!b) return;
  b.textContent = geozonesVisible ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏';
}

document.getElementById('toggleGeozones').onclick = () => {
  geozonesVisible = !geozonesVisible;
  setGeozonesVisibility(geozonesVisible);
  updateGeozonesToggleLabel();
};

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –Ω–∞–ø–∏—Å –Ω–∞ –∫–Ω–æ–ø—Ü—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
updateGeozonesToggleLabel();

/* ===== Rulers (draw + distance) ===== */
function drawRulers() {
  rulerLines.forEach(id => { if (map.getLayer(id)) map.removeLayer(id); if (map.getSource(id)) map.removeSource(id); });
  rulerLines = [];
  drawRulerSegment(startRuler, 'start', '#0066ff');
  drawRulerSegment(endRuler, 'end', '#33cc33');
}
function drawRulerSegment(ruler, prefix, color) {
  for (let i = 0; i < ruler.length - 1; i++) {
    const lineId = `${prefix}-ruler-${i}`;
    const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: [ruler[i], ruler[i + 1]] } };
    map.addSource(lineId, { type: 'geojson', data: geojson });
    map.addLayer({ id: lineId, type: 'line', source: lineId,
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': color, 'line-width': 4, 'line-dasharray': [1, 2] } });
    rulerLines.push(lineId);
  }
}

/* Haversine fallback */
function haversineKm(a, b){
  const toRad = d => d * Math.PI / 180;
  const [lng1, lat1] = a, [lng2, lat2] = b;
  const R = 6371;
  const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const h = s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2;
  return 2 * R * Math.asin(Math.sqrt(h));
}
function calculateRulerDistance(ruler) {
  if (!Array.isArray(ruler) || ruler.length < 2) return 0;
  let dist = 0;
  if (window.turf && typeof turf.distance === 'function'){
    for (let i = 0; i < ruler.length - 1; i++) {
      dist += turf.distance(turf.point(ruler[i]), turf.point(ruler[i + 1]), { units: 'kilometers' });
    }
  } else {
    for (let i = 0; i < ruler.length - 1; i++) { dist += haversineKm(ruler[i], ruler[i + 1]); }
  }
  return dist;
}

/* ===== –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ ===== */
function updateCounters(){
  const routeCount = points.length;
  const startCount = startRuler.length;
  const endCount   = endRuler.length;
  const total      = routeCount + startCount + endCount;
  const byId = id => document.getElementById(id);
  byId('countRoute').textContent = routeCount;
  byId('countStart').textContent = startCount;
  byId('countEnd').textContent   = endCount;
  byId('countTotal').textContent = total;
}
// –ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª–æ–º–µ—Ç—Ä–∞–∂ —ñ–∑ –≤–∏–¥–∏–º–æ–≥–æ —á—ñ–ø–∞ –∑–≤–µ—Ä—Ö—É
function getUIKm(){
  const t = document.getElementById('distanceTop');
  const s = (t?.textContent || '0').replace(',', '.');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}

function setKmUI(km){
  const v = (km != null && isFinite(km)) ? Number(km).toFixed(2) : '0.00';
  const elSide = document.getElementById('distance');     // (–º–æ–∂–µ –≤–∂–µ –Ω–µ —ñ—Å–Ω—É–≤–∞—Ç–∏ ‚Äî –æ–∫)
  if (elSide) elSide.textContent = v;
  const elTop  = document.getElementById('distanceTop');  // –Ω–æ–≤–∏–π —á—ñ–ø –∑–≤–µ—Ä—Ö—É
  if (elTop) elTop.textContent = v;
}

/* ===== Route rendering ===== */
function splitIntoChunks(array, chunkSize) {
  const chunks = [];
  for (let i = 0; i < array.length - 1; i += chunkSize - 1) {
    const chunk = array.slice(i, i + chunkSize);
    if (chunk.length >= 2) chunks.push(chunk);
  }
  return chunks;
}
function clearRouteLayers() {
  routeLayers.forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
    if (map.getSource(id)) map.removeSource(id);
  });
  routeLayers = [];
}
async function updateRoute() {
  if (points.length < 2) {
    setKmUI(calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler));
    updateCounters(); clearRouteLayers(); return;
  }
  const chunks = splitIntoChunks(points, 20);
  let totalDistance = 0;
  clearRouteLayers();

  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];
    const coordsStr = chunk.map(p => p.join(',')).join(';');
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?geometries=geojson&overview=full&continue_straight=true&access_token=${mapboxgl.accessToken}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.routes && data.routes[0]) {
        const route = data.routes[0];
        totalDistance += route.distance;
        const layerId = `route-part-${i}`;
        map.addSource(layerId, { type: 'geojson', data: { type: 'Feature', geometry: route.geometry } });
        map.addLayer({
          id: layerId, type: 'line', source: layerId,
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': `hsl(${(i * 60) % 360}, 100%, 50%)`, 'line-width': 5 }
        });
        routeLayers.push(layerId);
      }
    } catch (e) { console.error('–ü–æ–º–∏–ª–∫–∞ –º–∞—Ä—à—Ä—É—Ç—É:', e); }
  }

  totalDistance = (totalDistance / 1000) + calculateRulerDistance(startRuler) + calculateRulerDistance(endRuler);
  setKmUI(totalDistance);
  updateCounters();
}

/* turf */
const turfScript = document.createElement('script');
turfScript.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js';
turfScript.onload = () => { updateRoute(); };
document.head.appendChild(turfScript);

/* ===================== Firebase ===================== */
let db = null, auth = null;
let storage = null;
// üëá –¢—Ä–∏–º–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–æ–±–æ—Ç–∏ –∑ –ª—ñ–Ω–∫–æ–º/–ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è–º
let LAST_SAVED_ROUTE = { id: null, label: '', data: null };

try {
  const CFG = window.APP_CONFIG?.firebase;
  if (!CFG) console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js.');
  firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG);

  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();

  console.log('‚úÖ Firebase:', firebase.app().options.projectId);
  if (!window.__PERSISTENCE_PROMISE) {
  window.__PERSISTENCE_PROMISE =
    firebase.firestore().enablePersistence({ synchronizeTabs: true })
      .catch((e) => console.warn('Firestore persistence is off:', e.code || e.message));
}
} catch (e) {
  console.error('‚ùå Firebase –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:', e);
}
// ===== HUB ACCESS (–≥–ª–æ–±–∞–ª—å–Ω–æ) =====

let ALLOWED_HUBS = null;   // null –∞–±–æ [] => –í–°–Ü —Ö–∞–±–∏

function isAllHubs(){
  // null –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤ –æ–∑–Ω–∞—á–∞—î "–≤—Å—ñ —Ö–∞–±–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ"
  return !Array.isArray(ALLOWED_HUBS) || ALLOWED_HUBS.length === 0;
}

function userAllowsHub(h){
  if (!h) return isAllHubs();
  return isAllHubs() || ALLOWED_HUBS.includes(h);
}

async function getAllowedHubsForUser(uid, role){
  try{
    // –∞–¥–º—ñ–Ω–∏/–°–ë ‚Äî –±–∞—á–∞—Ç—å –≤—Å—ñ
    if (String(role).toLowerCase() === 'admin' || String(role).toLowerCase() === 'security') return [];
    const snap = await db.collection('users').doc(uid).get({ source: 'server' });
    const d = snap.exists ? (snap.data() || {}) : {};
    if (Array.isArray(d.allowedHubs) && d.allowedHubs.length) return d.allowedHubs.slice(0, 10);
    if (Array.isArray(d.hubs) && d.hubs.length)               return d.hubs.slice(0, 10);
    if (typeof d.hub === 'string' && d.hub.trim())            return [d.hub.trim()];
    if (typeof d.hubAccess === 'string' && d.hubAccess.trim())return [d.hubAccess.trim()];
    return []; // –¥–µ—Ñ–æ–ª—Ç ‚Äî –≤—Å—ñ
  }catch(e){
    console.warn('getAllowedHubsForUser:', e?.message||e);
    return [];
  }
}

// –°—Ö–æ–≤–∞—Ç–∏ –æ–ø—Ü—ñ—ó –≤ —Å–µ–ª–µ–∫—Ç—ñ "–•–∞–±", —è–∫—ñ –Ω–µ –≤—Ö–æ–¥—è—Ç—å —É –¥–æ—Å—Ç—É–ø
function applyHubSelectVisibility(){
  const sel = document.getElementById('hubSelect');
  if (!sel) return;

  [...sel.options].forEach(opt => {
    if (!opt.value) return; // ‚Äú‚Äî –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî‚Äù
    const ok = userAllowsHub(opt.value);
    opt.hidden   = !ok;
    opt.disabled = !ok;
  });

  if (!userAllowsHub(sel.value)){
    const firstAllowed = [...sel.options].find(o => o.value && userAllowsHub(o.value));
    sel.value = firstAllowed ? firstAllowed.value : '';
  }

  const exactlyOne = Array.isArray(ALLOWED_HUBS) && ALLOWED_HUBS.length === 1;
  const roleNow = (window.__userRole || currentRole || '').toLowerCase();
  const canLock = !(roleNow === 'admin' || roleNow === 'security');
  sel.disabled = exactlyOne && canLock;
}

// –û–±–≥–æ—Ä—Ç–∞—á Firestore-–∑–∞–ø–∏—Ç—É —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ —Ö–∞–±—É
function withHubFilter(q, field = 'hub'){
  if (isAllHubs()) return q;
  if (ALLOWED_HUBS.length === 1) return q.where(field, '==', ALLOWED_HUBS[0]);
  return q.where(field, 'in', ALLOWED_HUBS.slice(0, 10)); // Firestore in: –¥–æ 10 –∑–Ω–∞—á–µ–Ω—å
}

/* ===================== Directory / helpers / UI ===================== */
const dirByCode = {};
const codeByName = {};
const routesLookup = {};
const logistById = {};
const logistIdByName = {};

const DIR_CACHE_KEY_BASE = 'directoryCache.v2';
function dirCacheKey(){
  return isAllHubs() ? (DIR_CACHE_KEY_BASE + ':ALL')
                     : (DIR_CACHE_KEY_BASE + ':' + ALLOWED_HUBS.slice().sort().join('|'));
}
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;
// üëá –î–û–î–ê–ô –¶–ï –¢–£–¢
const DIR_NAME_FIELD = 'nameLower'; // —è–∫—â–æ –ø–æ–ª—è –Ω–µ–º–∞—î ‚Äî —Ç–∏–º—á–∞—Å–æ–≤–æ –ø–æ—Å—Ç–∞–≤ 'name'
// –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ–± –Ω–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ loadDirectory(false) –¥–≤—ñ—á—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
let DIR_LOADED_ONCE = false;

const LOGISTS_CACHE_KEY = 'logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function _norm(s){ return String(s||'').trim().toLowerCase(); }
// ‚Üì‚Üì‚Üì –¥–æ–¥–∞—Ç–∏ –ø–æ—Ä—è–¥ —ñ–∑ _norm
function trigrams(s){
  const t = (s || '')
    .toString()
    .toLowerCase()
    .normalize('NFKD')                 // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –¥—ñ–∞–∫—Ä–∏—Ç–∏–∫—É
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\p{L}\p{N}]+/gu,' ')   // —É—Å–µ, —â–æ –Ω–µ –ª—ñ—Ç–µ—Ä–∞ –∞–±–æ —Ü–∏—Ñ—Ä–∞ ‚Äî —É –ø—Ä–æ–±—ñ–ª
    .replace(/\s+/g,' ')
    .trim();

  const out = new Set();
  if (!t) return [];
  if (t.length < 3) return [t];        // –∫–æ—Ä–æ—Ç–∫—ñ —Å–ª–æ–≤–∞ —Ç–µ–∂ —ñ–Ω–¥–µ–∫—Å—É—î–º–æ
  for (let i = 0; i <= t.length - 3; i++) out.add(t.slice(i, i+3));
  // Firestore: array-contains-any –ø—Ä–∏–π–º–∞—î ‚â§10 –∑–Ω–∞—á–µ–Ω—å ‚Äî –æ–±—Ä—ñ–∑–∞—î–º–æ
  return Array.from(out).slice(0, 10);
}

/* ---- Directory ---- */
function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  list.innerHTML = '';
  Object.keys(dirByCode).forEach(k => delete dirByCode[k]);
  Object.keys(codeByName).forEach(k => delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if (!(name in codeByName)) codeByName[name] = code;

    const opt = document.createElement('option');
    opt.value = name;
    opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
}
// –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –∑–∞–Ω–æ—Å–∏—Ç—å –ø–∞—Ä—É (code, name) —É –ª–æ–∫–∞–ª—å–Ω—ñ –º–∞–ø–∏ —ñ datalist ‚Äî
// –ø–æ—Ç—Ä—ñ–±–Ω–æ, –∫–æ–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î/—Ñ–∞–π–ª—É —ñ —Ö–æ—á–µ–º–æ –ó–ë–ï–†–ï–ì–¢–ò –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É –∑—ñ —Å–ø–∏—Å–∫—É
function registerDirEntry(code, labelOrName){
  const name = parseNameFromLabel(labelOrName) || labelOrName || getNameByCode(code) || '';
  if (!code || !name) return;

  if (!dirByCode[code]) dirByCode[code] = { name, company:'', unit:'' };
  codeByName[name] = code;

  const list = document.getElementById('directoryList');
  if (list && ![...list.options].some(o => o.value === name)){
    const opt = document.createElement('option');
    opt.value = name;
    opt.label = name;
    list.appendChild(opt);
  }
}

async function loadDirectory(force = false){
  try{
    if (!force){
      const raw = localStorage.getItem(dirCacheKey());
      if (raw){
        const { ts, rows } = JSON.parse(raw);
        if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){
          fillDirectoryUI(rows);
          updateRouteName();
          console.log('üìí Directory from localStorage cache:', rows.length);
          return;
        }
      }
      // ‚ùó –ë–µ–∑ force –±—ñ–ª—å—à–µ –ù–ï —Ç—è–≥–Ω–µ–º–æ –≤—Å—é –∫–æ–ª–µ–∫—Ü—ñ—é.
      // –ü—ñ–¥–∫–∞–∑–∫–∏ –ø—ñ–¥—Ç—è–≥—É–≤–∞—Ç–∏–º—É—Ç—å—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∑–∞–ø–∏—Ç–∞–º–∏ —á–µ—Ä–µ–∑ typeahead.
      console.log('üìí Directory: cache miss ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (—á–µ–∫–∞—î–º–æ typeahead/Refresh).');
      return;
    }
  }catch{}

  // force=true: —Ç—è–≥–Ω–µ–º–æ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–Ω–æ–ø–∫–∞ "–û–Ω–æ–≤–∏—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫")
  let q = db.collection('directory');
q = withHubFilter(q, 'hub');
const snap = await q.get({ source:'default' });
  const rows = [];
  snap.forEach(doc => {
    const d = doc.data() || {};
    rows.push({ code: doc.id, name: d.name || doc.id, company: d.company || '', unit: d.unit || '' });
  });

  fillDirectoryUI(rows);
  updateRouteName();
  try{ localStorage.setItem(dirCacheKey(), JSON.stringify({ ts: Date.now(), rows })); }catch{}
  console.log('üìí Directory loaded from Firestore (force):', rows.length);
}

// === Typeahead: –ø—Ä–µ—Ñ—ñ–∫—Å–Ω–∏–π –∑–∞–ø–∏—Ç —É Firestore —ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–∫–∞–∑–æ–∫ ===

// —â–æ–± —É–Ω–∏–∫–∞—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è option —É <datalist>:
function _resetDatalistOptions(datalistId){
  const list = document.getElementById(datalistId);
  if (list) list.innerHTML = '';
}
function _appendDatalistOptions(rows, datalistId){
  const list = document.getElementById(datalistId);
  if (!list) return;
  for (const r of rows){
    // ‚ú≥Ô∏è –ú–ê–ü–ò ‚Äî –ù–ï —á–∏—Å—Ç–∏–º–æ, –ª–∏—à–µ –¥–æ–ø–∏—Å—É—î–º–æ (—â–æ–± –∑–±–µ—Ä—ñ–≥–∞–ª–∏—Å—å –∑–Ω–∞–π–¥–µ–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ)
    dirByCode[r.code] = { name:r.name, company:r.company||'', unit:r.unit||'' };
    codeByName[r.name] = r.code;

    const opt = document.createElement('option');
    opt.value = r.name;
    opt.label = [r.name, r.unit, r.company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
}

async function queryDirectoryPrefix(prefix, limit = 20){
  try{
    const p = String(prefix||'').trim();
    if (!p) { _resetDatalistOptions('directoryList'); return; }

    const pLower = p.toLowerCase();
    const accRows = [];
    const seen = new Set();

    // 1) –∑–≤–∏—á–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å –ø–æ nameLower (—à–≤–∏–¥–∫–æ –π –¥–µ—à–µ–≤–æ)
    try{
      let q1 = db.collection('directory')
        .orderBy('nameLower')
        .startAt(pLower)
        .endBefore(pLower + '\uf8ff')
        .limit(limit);
        q1 = withHubFilter(q1, 'hub');  // üëà –¥–æ–¥–∞–ª–∏

      const s1 = await q1.get({ source:'default' });
      s1.forEach(doc => {
        if (accRows.length >= limit) return;
        if (seen.has(doc.id)) return;
        const d = doc.data() || {};
        accRows.push({
          code: doc.id,
          name: d.name || doc.id,
          company: d.company || '',
          unit: d.unit || ''
        });
        seen.add(doc.id);
      });
    } catch(_) { /* —ñ–≥–Ω–æ—Ä—É—î–º–æ, –ø—ñ–¥–µ–º–æ –Ω–∞ fallback */ }

    // 2) —è–∫—â–æ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ‚Äî fallback: "–º—ñ—Å—Ç–∏—Ç—å" —á–µ—Ä–µ–∑ nameNgrams
if (accRows.length < limit && pLower.length >= 3){
  const grams = trigrams(pLower);
  if (grams.length){
    const hubsForLoop = isAllHubs() ? [null] : ALLOWED_HUBS.slice(0, 10);
    for (const h of hubsForLoop){
      let q2 = db.collection('directory')
        .where('nameNgrams', 'array-contains-any', grams)
        .limit(limit);
      if (h) q2 = q2.where('hub','==', h);  // üëà —É–Ω–∏–∫–∞—î–º–æ IN + array-contains-any
      const s2 = await q2.get({ source:'default' });
      s2.forEach(doc => {
        if (accRows.length >= limit) return;
        if (seen.has(doc.id)) return;
        const d = doc.data() || {};
        accRows.push({
          code: doc.id,
          name: d.name || doc.id,
          company: d.company || '',
          unit: d.unit || ''
        });
        seen.add(doc.id);
      });
    }
    const score = (row) => {
      const n = (row.name || '').toLowerCase();
      const pos = n.indexOf(pLower);
      return (pos === -1 ? 1e6 : pos) * 1000 + n.length;
    };
    accRows.sort((a,b) => score(a) - score(b));
  }
}

    _resetDatalistOptions('directoryList');
    _appendDatalistOptions(accRows.slice(0, limit), 'directoryList');
  }catch(e){
    console.warn('queryDirectoryPrefix error:', e?.message || e);
  }
}

// Debounce –¥–ª—è —ñ–Ω–ø—É—Ç—ñ–≤
const _typeTimers = new Map();
function attachTypeahead(inputId){
  const el = document.getElementById(inputId);
  if (!el) return;
  el.addEventListener('input', ()=>{
    const prev = _typeTimers.get(inputId);
    if (prev) clearTimeout(prev);
    const t = setTimeout(()=> queryDirectoryPrefix(el.value, 20), 200);
    _typeTimers.set(inputId, t);
  });
}

/* ---- Logists ---- */
function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  Object.keys(logistById).forEach(k=> delete logistById[k]);
  Object.keys(logistIdByName).forEach(k=> delete logistIdByName[k]);

  rows.forEach(r=>{
    logistById[r.id] = r; logistIdByName[r.name] = r.id;
    const opt = document.createElement('option'); opt.value = r.name; list.appendChild(opt);
  });

  if (rows.length === 0) { console.warn('üë• Logists: –ø—É—Å—Ç–æ.'); }
}
async function loadLogists(allowServer=true){
  const msg = document.getElementById('logistsMsg');
  const showMsg = (t) => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };

  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if(raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){
        fillLogistsUI(rows); showMsg('');
        console.log('üë• Logists from cache:', rows.length);
        return;
      }
    }
    if (!allowServer) { showMsg('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }

    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'default' }); }
    catch (e) {
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))) {
        console.warn('permission-denied –¥–ª—è logists');
        showMsg('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.');
        return;
      }
      throw e;
    }

    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });

    rows = rows.filter(r=>r.active).sort((a,b)=> (a.sort-b.sort) || a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    showMsg('');
    console.log('üë• Logists loaded from Firestore:', rows.length);
  } catch (e) {
    console.error('‚ùå Logists load error:', e);
    showMsg('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.');
  }
}
function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if(!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const candidates = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (candidates.length === 1) return candidates[0][1];
  return null;
}
function getLogistNameById(id){ return (logistById[id]?.name) || ''; }

/* Helpers for route points */
function toObjPoints(arr) { return (arr || []).map(p => ({ lng: p[0], lat: p[1] })); }
function fromObjPoints(arr) { return (arr || []).map(p => [p.lng, p.lat]); }

function getCodeByInput(inputId) {
  const raw = document.getElementById(inputId).value;
  const name = raw.trim();
  if (!name) return null;
  if (codeByName[name]) return codeByName[name];
  const n = _norm(name);
  for (const [label, code] of Object.entries(codeByName)){ if (_norm(label) === n) return code; }
  const candidates = Object.entries(codeByName).filter(([label]) => _norm(label).includes(n));
  if (candidates.length === 1) return candidates[0][1];
  return null;
}
function makeDirLabelByCode(code){
  const d = dirByCode[code];
  if (!d) return '';
  return [d.name, d.unit, d.company].filter(Boolean).join(' ‚Ä¢ ');
}
function parseNameFromLabel(label){
  const s = String(label||'').split('‚Ä¢')[0].trim();
  return s || '';
}
function getNameByCode(code) { return (dirByCode[code]?.name) || ''; }

/* –ù–∞–∑–≤—É –±—É–¥—É—î–º–æ —Å—Ç—ñ–π–∫–æ ‚Äî –ø—Ä–∞—Ü—é—î —ñ –¥–ª—è code, —ñ –¥–ª—è key, —ñ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö label */
function prettyFromTo(data){
  if (data.fromLabel || data.toLabel){
    return [data.fromLabel || '', data.toLabel || ''];
  }
  if (data.fromCode || data.toCode){
    return [makeDirLabelByCode(data.fromCode) || '', makeDirLabelByCode(data.toCode) || ''];
  }
  if (data.fromKey || data.toKey){
    const fmt = k => String(k||'').split('|').map(s=>s.trim()).filter(Boolean).join(' ‚Ä¢ ');
    return [fmt(data.fromKey), fmt(data.toKey)];
  }
  return ['',''];
}
function formatRouteTitle(data) {
  const [fromL, toL] = prettyFromTo(data);
  const type = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
  const parts = [type]; if (data.purpose) parts.push(data.purpose);
  return `${fromL ? fromL : '‚Äî'} ‚Üí ${toL ? toL : '‚Äî'} [${parts.join(' ‚Ä¢ ')}]`;
}
function updateRouteName() {
  const fromCode = getCodeByInput('fromName');
  const toCode = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;
  const routePurpose = document.getElementById('routePurpose').value;
  if (!fromCode || !toCode) return;
  const fromLabel = makeDirLabelByCode(fromCode);
  const toLabel   = makeDirLabelByCode(toCode);
  const parts = [routeType]; if (routePurpose) parts.push(routePurpose);
  document.getElementById('routeName').value = `${fromLabel} ‚Üí ${toLabel} [${parts.join(' ‚Ä¢ ')}]`;
}

/* ===== DUPLICATES ===== */
function sanitizeId(s){ return String(s||'').replace(/[\/\\#?\[\]]/g,'_'); }
async function findExistingRoute(fromCode, toCode, routeType){
  try{
    const snap = await db.collection('routes')
      .where('fromCode','==',fromCode).where('toCode','==',toCode).where('routeType','==',routeType)
      .limit(1).get();
    let found = null; snap.forEach(doc => { if (!found) found = doc; });
    return found;
  }catch(e){ console.warn('findExistingRoute error:', e?.message || e); return null; }
}
function makeCopyId(baseSafeId){ return `${baseSafeId}__${Date.now()}`; }

const $dupModal = document.getElementById('dupModal');
const $dupText = document.getElementById('dupText');
const $dupOverwrite = document.getElementById('dupOverwrite');
const $dupCopy = document.getElementById('dupCopy');
const $dupCancel = document.getElementById('dupCancel');

function askDuplicateAction(existingName){
  return new Promise((resolve)=>{
    $dupText.textContent = `–ú–∞—Ä—à—Ä—É—Ç —ñ–∑ —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∂–µ —ñ—Å–Ω—É—î:\n‚Äú${existingName}‚Äù.\n–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:`;
    $dupModal.classList.add('show');
    const onEsc = (e)=>{ if(e.key==='Escape'){ cleanup(); resolve('cancel'); } };
    function cleanup(){ document.removeEventListener('keydown', onEsc); $dupModal.classList.remove('show'); }
    $dupOverwrite.onclick = ()=>{ cleanup(); resolve('overwrite'); };
    $dupCopy.onclick = ()=>{ cleanup(); resolve('copy'); };
    $dupCancel.onclick = ()=>{ cleanup(); resolve('cancel'); };
    $dupModal.onclick = (e)=>{ if(e.target===$dupModal){ cleanup(); resolve('cancel'); } };
    document.addEventListener('keydown', onEsc, { once:false });
  });
}

/* ===== Local JSON save/load ===== */
const fileInput = document.getElementById('fileInput');

document.getElementById('saveRoute').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  const fromCode = getCodeByInput('fromName');
  const toCode   = getCodeByInput('toName');
  const routeType = document.getElementById('routeType').value;
  const purpose   = document.getElementById('routePurpose').value;
  const hub = (document.getElementById('hubSelect').value || '').trim();
  const intermediateText = document.getElementById('intermediateText').value.trim();
  const logistId = getLogistIdByInput('logistInput');
  const logistName = logistId ? getLogistNameById(logistId) : '';

  const routeData = {
    name: (document.getElementById('routeName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∏'),
    fromCode, toCode, routeType, purpose, intermediateText,
    fromLabel: makeDirLabelByCode(fromCode),
    toLabel:   makeDirLabelByCode(toCode),
    points: toObjPoints(points),
    startRuler: toObjPoints(startRuler),
    endRuler: toObjPoints(endRuler),
    logisticId: logistId || null,
    logisticName: logistName || '',
    distance_km: getUIKm(),
    date: new Date().toISOString(),
	hub: hub || '' // üëà –¥–æ–¥–∞–Ω–æ
  };
  const blob = new Blob([JSON.stringify(routeData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const safe = String(routeData.name || 'route').replace(/[\/\\#?[\]:]/g,'_');
  a.href = url; a.download = `route_${safe}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
};

document.getElementById('loadRoute').onclick = () => {
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  fileInput.value = null; fileInput.click();
};
fileInput.onchange = (event) => {
  if (readOnly) return;
  const file = event.target.files && event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const raw = JSON.parse(e.target.result);

// 1) –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —ñ –æ–±'—î–∫—Ç–∞, —ñ –º–∞—Å–∏–≤—É –æ–±'—î–∫—Ç—ñ–≤
let routeData = Array.isArray(raw) ? raw[0] : raw;
if (Array.isArray(raw) && raw.length > 1) {
  console.warn('–£ —Ñ–∞–π–ª—ñ –∫—ñ–ª—å–∫–∞ –º–∞—Ä—à—Ä—É—Ç—ñ–≤, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é –ø–µ—Ä—à–∏–π —ñ–∑', raw.length);
  alert(`–£ —Ñ–∞–π–ª—ñ ${raw.length} –º–∞—Ä—à—Ä—É—Ç(–∏/—ñ–≤). –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –ø–µ—Ä—à–∏–π.`);
}
if (!routeData || typeof routeData !== 'object') {
  alert('–§–∞–π–ª –º–∞—î –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç'); return;
}

// 2) –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è points —É [lng, lat], –ø—ñ–¥—Å—Ç—Ä–∞—Ö–æ–≤—É—î–º–æ—Å—è –ø–æ —Ä—ñ–∑–Ω–∏—Ö –≤–∞—Ä—ñ–∞–Ω—Ç–∞—Ö
const arrFrom = (pts) => {
  if (!Array.isArray(pts)) return [];
  // [ [lng,lat], ... ]
  if (pts.length && Array.isArray(pts[0])) {
    return pts
      .map(p => [Number(p[0]), Number(p[1])])
      .filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));
  }
  // [ {lng,lat}, ... ]
  if (pts.length && typeof pts[0] === 'object') {
    return fromObjPoints(pts)
      .filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));
  }
  return [];
};

      points = arrFrom(routeData.points || []);
      startRuler = arrFrom(routeData.startRuler || []);
      endRuler = arrFrom(routeData.endRuler || []);

      const fCode = routeData.fromCode || null;
      const tCode = routeData.toCode   || null;
      if (fCode) document.getElementById('fromName').value = getNameByCode(fCode) || parseNameFromLabel(routeData.fromLabel);
      if (tCode) document.getElementById('toName').value   = getNameByCode(tCode) || parseNameFromLabel(routeData.toLabel);
      registerDirEntry(fCode, routeData.fromLabel || document.getElementById('fromName').value);
      registerDirEntry(tCode, routeData.toLabel   || document.getElementById('toName').value);
      if (routeData.routeType) document.getElementById('routeType').value = routeData.routeType;
      if (routeData.purpose)   document.getElementById('routePurpose').value = routeData.purpose;
      document.getElementById('intermediateText').value = routeData.intermediateText || '';
      document.getElementById('routeName').value = routeData.name || '';
	  if (routeData.hub) document.getElementById('hubSelect').value = routeData.hub;

	// ‚¨áÔ∏è –¥–æ–¥–∞–π
	updateHighlights();

      document.getElementById('logistInput').value =
        routeData.logisticName || (routeData.logisticId ? getLogistNameById(routeData.logisticId) : '');


      rebuildMarkers(); drawRulers(); updateRoute();
      if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
      alert('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ —Ñ–∞–π–ª—É!');
    } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: ' + err.message); }
  };
  reader.readAsText(file);
};

/* ================= NEW routeKey helpers ================= */
function firstLetter(str){
  const s = String(str || '').trim();
  if (!s) return 'X';
  const re = /[A-Za-z–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–Ñ—î“ê“ë]/u;
  for (const ch of s){
    if (re.test(ch)) return ch.toUpperCase();
  }
  return 'X';
}
function randomDigits(len=10){
  const a = new Uint32Array(len);
  (crypto && crypto.getRandomValues) ? crypto.getRandomValues(a) : a.fill(Math.floor(Math.random()*10));
  return Array.from(a, n => (n % 10).toString()).join('');
}
async function reserveKeyTx(tx, prefix, docId, meta){
  for (let tries = 0; tries < 10; tries++){
    const key = `${prefix}-${randomDigits(10)}`;
    const keyRef = db.collection('routeKeys').doc(key);
    const snap = await tx.get(keyRef);
    if (!snap.exists){
      tx.set(keyRef, {
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        routeId: docId,
        fromCode: meta.fromCode, toCode: meta.toCode,
        fromName: meta.fromName, toName: meta.toName
      });
      return key;
    }
  }
  throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É (—Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑).');
}

/* ===== Firestore: save/list/load/delete ===== */
async function saveToDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
    if (points.length === 0 && startRuler.length === 0 && endRuler.length === 0) {
      alert('–ù–µ–º–∞—î —â–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏'); return;
    }

    const fromCode = getCodeByInput('fromName');
    const toCode   = getCodeByInput('toName');
    const routeType = document.getElementById('routeType').value;
    const purpose   = document.getElementById('routePurpose').value;
    const intermediateText = document.getElementById('intermediateText').value.trim();
    const hub = (document.getElementById('hubSelect').value || '').trim();

    if (!hub && !isAllHubs()) {
      alert('–û–±–µ—Ä—ñ—Ç—å —Ö–∞–± (–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ).'); return;
    }
    if (!userAllowsHub(hub)) {
      alert('‚õî –í–∏ –Ω–µ –º–∞—î—Ç–µ –ø—Ä–∞–≤–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –¥–ª—è —Ö–∞–±—É: ' + hub); return;
    }

    const logistId = getLogistIdByInput('logistInput');
    if (!fromCode || !toCode) {
      alert('–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äú–í—ñ–¥‚Äù —Ç–∞ ‚Äú–î–æ‚Äù –∑—ñ —Å–ø–∏—Å–∫—É –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.'); return;
    }
    if (!logistId) {
      alert('–û–±–µ—Ä—ñ—Ç—å –ª–æ–≥—ñ—Å—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É.'); return;
    }

    const from = dirByCode[fromCode] || {};
    const to   = dirByCode[toCode]   || {};
    const fromLabel = makeDirLabelByCode(fromCode);
    const toLabel   = makeDirLabelByCode(toCode);

    const generatedName = `${fromLabel} ‚Üí ${toLabel} [${routeType}${purpose ? ' ‚Ä¢ '+purpose : ''}]`;
    const manual = (document.getElementById('routeName').value || '').trim();
    const finalName = manual || generatedName;

    const user = auth?.currentUser || null;

    const payload = {
  name: finalName,
  fromCode, toCode, routeType, purpose, intermediateText,
  fromLabel, toLabel,
  points: toObjPoints(points),
  startRuler: toObjPoints(startRuler),
  endRuler: toObjPoints(endRuler),
  logisticId: logistId,          // ‚úÖ –∫–ª—é—á —É –ë–î –ª–∏—à–∞—î—Ç—å—Å—è logisticId, –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äî –∑–º—ñ–Ω–Ω–∞ logistId
  logisticName: getLogistNameById(logistId),
  createdByUid: user?.uid || null,
  createdByEmail: user?.email || null,
  distance_km: getUIKm(),
  updatedAt: new Date().toISOString(),
  hub: hub || null
};

    // üß† –Ü–ù–î–ï–ö–°–ù–Ü –ü–û–õ–Ø –†–ê–•–£–Ñ–ú–û –û–î–ò–ù –†–ê–ó (–ø–æ–∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—î—é)
    const searchText = [finalName, fromLabel, toLabel].filter(Boolean).join(' | ');
    const indexFields = {
      nameLower:      (finalName || '').toLowerCase(),
      fromLabelLower: (fromLabel || '').toLowerCase(),
      toLabelLower:   (toLabel   || '').toLowerCase(),
      nameNgrams:     trigrams(finalName),
      fromNgrams:     trigrams(fromLabel),
      toNgrams:       trigrams(toLabel),
      searchNgrams:   trigrams(searchText),
      updatedAt:      new Date().toISOString()
    };

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—è
    const existing = await findExistingRoute(fromCode, toCode, routeType);
    const baseId = sanitizeId(finalName);
    let docId = baseId;
    let mode = 'new'; // 'new' | 'overwrite' | 'copy'

    if (existing) {
      const existingName = existing.data()?.name || existing.id;
      const choice = await askDuplicateAction(existingName);
      if (choice === 'cancel'){ alert('‚ùé –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ'); return; }
      if (choice === 'overwrite'){ docId = existing.id; mode = 'overwrite'; }
      if (choice === 'copy'){ docId = `${baseId}__${Date.now()}`; payload.name = `${payload.name} (–∫–æ–ø—ñ—è)`; mode = 'copy'; }
    }

    const prefix = firstLetter(from.name) + firstLetter(to.name);
    const meta = { fromCode, toCode, fromName: from.name || '', toName: to.name || '' };

    let routeKeySaved = null;
    let savedApproval = null;

    // üßæ –¢–†–ê–ù–ó–ê–ö–¶–Ü–Ø: –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è route —Ç–∞ —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è routeKey
    try {
      await db.runTransaction(async (tx) => {
        const routeRef  = db.collection('routes').doc(docId);
        const routeSnap = await tx.get(routeRef);

        // routeKey
        let routeKey = null;
        if (mode === 'overwrite' && routeSnap.exists && routeSnap.data()?.routeKey){
          routeKey = String(routeSnap.data().routeKey);
          const keyRef = db.collection('routeKeys').doc(routeKey);
          await tx.get(keyRef); // —â–æ–± –Ω–µ –≤–ø–∞—Å—Ç–∏ –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ
          tx.set(keyRef, {
            routeId: docId,
            updatedAt: new Date().toISOString(),
            fromCode, toCode,
            fromName: meta.fromName, toName: meta.toName
          }, { merge:true });
        } else {
          routeKey = await reserveKeyTx(tx, prefix, docId, meta);
        }

        // –Ü–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –∑–º—ñ–Ω–∏–≤—Å—è –∫—ñ–ª–æ–º–µ—Ç—Ä–∞–∂ —ñ –±—É–ª–æ approved
        let approvalUpdate = null;
        const prev = routeSnap.exists ? routeSnap.data() : null;
        if (prev && prev.approval?.status === 'approved'){
          const oldDist = (typeof prev.distance_km === 'number') ? prev.distance_km : null;
          const newDist = payload.distance_km;
          if (oldDist !== null && Math.abs(newDist - oldDist) > 0.01){
            const rev = (prev.approval.revision || 0) + 1;
            approvalUpdate = {
              status: 'draft',
              revision: rev,
              comment: `–í—ñ–¥—Å—Ç–∞–Ω—å –∑–º—ñ–Ω–µ–Ω–∞: –±—É–ª–æ ${oldDist.toFixed(2)} –∫–º ‚Üí —Å—Ç–∞–ª–æ ${newDist.toFixed(2)} –∫–º`,
              submittedAt: null, submittedByUid: null, submittedByEmail: null,
              decidedByUid: null, decidedByEmail: null, decisionAt: null
            };
          }
        }

        const updateObj = {
          ...payload,
          ...indexFields,
          routeKey
        };
        if (approvalUpdate){
          updateObj.approval = approvalUpdate;
          savedApproval = approvalUpdate;
        } else {
          savedApproval = prev?.approval || null;
        }

        tx.set(routeRef, updateObj, { merge: true });
        routeKeySaved = routeKey;
      });

      alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ë–î: ${payload.name}\n–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ${routeKeySaved}`);
    } catch (txErr) {
      // Fallback: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –º–∞—Ä—à—Ä—É—Ç –±–µ–∑ routeKey
      console.warn('–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è (routeKeys) –Ω–µ –≤–¥–∞–ª–∞—Å—è:', txErr?.code || txErr, txErr?.message);
      try {
        await db.collection('routes').doc(docId).set(
          { ...payload, ...indexFields },
          { merge: true }
        );
        alert('‚ö†Ô∏è –ó–±–µ—Ä–µ–∂–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç –ë–ï–ó –∫–æ–¥—É (routeKey).\n–ü—Ä–∏—á–∏–Ω–∞: ' + (txErr?.message || txErr));
      } catch (saveErr) {
        throw saveErr;
      }
    }

    // ‚§¥Ô∏è –ü–Ü–°–õ–Ø –ó–ê–ü–ò–°–£ ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ UI/—Å–ø–∏—Å–æ–∫
    setApprovalUI(savedApproval);
    ensureRouteOptionSelected(docId, { ...payload, approval: savedApproval });
    await refreshRoutesList('reset');
    ensureRouteOptionSelected(docId, { ...payload, approval: savedApproval });

  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ –ë–î: ' + (err?.message || err));
  }
}

let isRefreshingRoutes = false;
let routesPageLastDoc = null;   // –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
let routesDone = false;         // —á–∏ –≤—Å–µ –¥–æ–≥—Ä—É–∑–∏–ª–∏
let routesLoadedCount = 0;      // —Å–∫—ñ–ª—å–∫–∏ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –Ω–∞ –∫–ª—ñ—î–Ω—Ç
let routesInitLoaded = false;
async function ensureRoutesLoaded(){
  if (routesInitLoaded) return;
  routesInitLoaded = true;
  await refreshRoutesList('reset');
}

function renderRoutesDocs(docs){
  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');

  if (sel.options.length === 0) {
    sel.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
  }

  docs.forEach(doc=>{
    const d = doc.data() || {};
    const km = (typeof d.distance_km === 'number') ? ` (${d.distance_km.toFixed(2)} –∫–º)` : '';
    const labelNow = formatRouteTitle(d);
    const label = labelNow + km;

    // —É–Ω–∏–∫–∞—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
    if (routesLookup[label]) return;
    routesLookup[label] = doc.id;

    const opt = document.createElement('option');
    opt.value = doc.id; opt.textContent = label;
    sel.appendChild(opt);

    const sOpt = document.createElement('option');
    sOpt.value = label; list.appendChild(sOpt);
  });

  routesLoadedCount = Object.keys(routesLookup).length;
}
// –î–æ–¥–∞—î/–æ–Ω–æ–≤–ª—é—î –æ–ø—Ü—ñ—é —É <select id="remoteRoutes"> —ñ –æ–¥—Ä–∞–∑—É —ó—ó –æ–±–∏—Ä–∞—î.
// –¢–∞–∫–æ–∂ –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ –º–∞—Ä—à—Ä—É—Ç —É LAST_SAVED_ROUTE —Ç–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª—é—î–º–æ –ª—ñ–Ω–∫ "–ü–µ—Ä–µ–≥–ª—è–¥".
function ensureRouteOptionSelected(id, data){
  if (!id) return;
  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');

  // –ü—ñ–¥–ø–∏—Å –¥–ª—è –æ–ø—Ü—ñ—ó
  const label = formatRouteTitle(data) + (typeof data.distance_km === 'number' ? ` (${data.distance_km.toFixed(2)} –∫–º)` : '');

  // –Ø–∫—â–æ —Ç–∞–∫–æ—ó –æ–ø—Ü—ñ—ó –Ω–µ–º–∞—î ‚Äî –¥–æ–¥–∞—î–º–æ; —è–∫—â–æ —î ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç
  let opt = [...sel.options].find(o => o.value === id);
  if (!opt) {
    opt = document.createElement('option');
    opt.value = id;
    opt.textContent = label;
    sel.appendChild(opt);
  } else {
    opt.textContent = label;
  }

  // –î–æ–¥–∞–º–æ –∑–∞–ø–∏—Å —É datalist –ø–æ—à—É–∫—É (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –∞–ª–µ –∑—Ä—É—á–Ω–æ)
  const existsInDatalist = [...list.options].some(o => o.value === label);
  if (!existsInDatalist) {
    const sOpt = document.createElement('option');
    sOpt.value = label;
    list.appendChild(sOpt);
  }

  // –û–±—Ä–∞—Ç–∏ —â–æ–π–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π
  sel.value = id;

  // –ó–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π
  LAST_SAVED_ROUTE = { id, label, data };

  // –û–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–≥–ª—è–¥" —É –ø–∞–Ω–µ–ª—ñ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
  const open = document.getElementById('openReviewLink');
  if (open) {
    open.style.display = 'inline-block';
    open.href = reviewLinkForId(id);
  }
}

async function refreshRoutesList(mode='reset'){
  if (!db || isRefreshingRoutes) return;
  isRefreshingRoutes = true;

  const sel  = document.getElementById('remoteRoutes');
  const list = document.getElementById('routesList');

  if (mode === 'reset'){
    routesPageLastDoc = null;
    routesDone = false;
    for (const k in routesLookup) delete routesLookup[k];
    sel.innerHTML  = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
    list.innerHTML = '';
  }
  if (routesDone){ isRefreshingRoutes = false; return; }

  const pageSize = 100; // —Å–∫—ñ–ª—å–∫–∏ –ø—ñ–¥—Ç—è–≥—É–≤–∞—Ç–∏ –∑–∞ —Ä–∞–∑
  let q = db.collection('routes');
q = withHubFilter(q, 'hub');
q = q.orderBy('updatedAt','desc').limit(pageSize);
  if (routesPageLastDoc) q = q.startAfter(routesPageLastDoc);

  try{
    const snap = await q.get({ source:'default' });
    if (snap.empty){
      routesDone = true;
    }else{
      renderRoutesDocs(snap.docs);
      routesPageLastDoc = snap.docs[snap.docs.length-1];
      if (snap.size < pageSize) routesDone = true;
    }
  } finally {
    isRefreshingRoutes = false;
  }
}

// –¥–æ–≥—Ä—É–∑–∏—Ç–∏ –≤—Å–µ (–ø–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö)
async function loadAllRoutes(){
  const HARD_CAP = 1000; // –º–∞–∫—Å–∏–º—É–º, —â–æ–± –Ω–µ –∑–±–∞–Ω–∫—Ä—É—Ç–∏—Ç–∏ —Ä—ñ–¥–∞–º–∏
  if (!confirm('–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫? –¶–µ –º–æ–∂–µ –∑—Ä–æ–±–∏—Ç–∏ –±–∞–≥–∞—Ç–æ —Ä—ñ–¥—ñ–≤ –¥–æ –ë–î.')){
    return;
  }
  while(!routesDone && routesLoadedCount < HARD_CAP){
    await refreshRoutesList('next');
  }
  if (!routesDone) {
    alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${HARD_CAP}. –£—Ç–æ—á–Ω—ñ—Ç—å –ø–æ—à—É–∫ –∑–∞–º—ñ—Å—Ç—å –ø–æ–≤–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.`);
  } else {
    alert(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç—ñ–≤: ${routesLoadedCount}`);
  }
}

async function loadFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }

    const docRef = db.collection('routes').doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
    const data = docSnap.data();
    if (!userAllowsHub(data.hub || '')) {
  alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (data.hub || '‚Äî'));
  return;
}

    const fName = getNameByCode(data.fromCode) || parseNameFromLabel(data.fromLabel);
    const tName = getNameByCode(data.toCode)   || parseNameFromLabel(data.toLabel);

    document.getElementById('fromName').value = fName || '';
    document.getElementById('toName').value   = tName || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('routePurpose').value = data.purpose || '–ó–µ—Ä–Ω–æ';
    document.getElementById('intermediateText').value = data.intermediateText || '';
	document.getElementById('hubSelect').value = data.hub || '';
    document.getElementById('routeName').value = formatRouteTitle(data);
	setApprovalUI(data.approval);

    document.getElementById('logistInput').value =
      data.logisticName || (data.logisticId ? getLogistNameById(data.logisticId) : '');

    points = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler = fromObjPoints(data.endRuler || []);
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –Ω–∞–∑–≤–∞ ‚Üî –∫–æ–¥ —É –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫–µ—à—ñ
registerDirEntry(data.fromCode, data.fromLabel || document.getElementById('fromName').value);
registerDirEntry(data.toCode,   data.toLabel   || document.getElementById('toName').value);

    rebuildMarkers(); drawRulers(); updateRoute();
	updateHighlights();
    if (points.length > 0) map.flyTo({ center: points[0], zoom: 12 });
    alert('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ –ë–î: ' + id + (data.routeKey ? `\n–ö–æ–¥: ${data.routeKey}` : ''));
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏: ' + (err?.message || err));
  }
}

async function deleteFromDB() {
  try {
    if (!db) { alert('–ë–î –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞'); return; }
    if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
    const sel = document.getElementById('remoteRoutes');
    const id = sel.value;
    if (!id) { alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É —Å–ø–∏—Å–∫—É'); return; }
    if (!confirm(`–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç "${id}"?`)) return;

    await db.collection('routes').doc(id).delete();
    alert('–í–∏–¥–∞–ª–µ–Ω–æ –∑ –ë–î: ' + id);
    await refreshRoutesList();
  } catch (err) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ –ë–î:', err);
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: ' + (err?.message || err));
  }
}
/* ======== APPROVAL: helpers + UI ======== */

// —Ñ–æ—Ä–º—É—î–º–æ –ª—ñ–Ω–∫ –Ω–∞ review.html
function reviewLinkForId(id){
  return location.origin.replace(/\/$/,'') + '/review.html?rid=' + encodeURIComponent(id);
}

// –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∏–º–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –ø–∞–Ω–µ–ª—ñ
function setApprovalUI(approval){
  const mapNames = { draft:'–ß–µ—Ä–Ω–µ—Ç–∫–∞', pending:'–û—á—ñ–∫—É—î', approved:'–ü–æ–≥–æ–¥–∂–µ–Ω–æ', rejected:'–í—ñ–¥—Ö–∏–ª–µ–Ω–æ' };
  // ‚¨áÔ∏è –¥–æ–¥–∞–Ω–æ —ñ–∫–æ–Ω–∫—É –¥–ª—è draft
  const icons    = { draft:'üìù', pending:'‚è≥', approved:'‚úÖ', rejected:'‚õî' };
  const st = (approval && approval.status) || 'draft';

  // ‚Äî‚Äî –ø–∞–Ω–µ–ª—å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è (—è–∫ –±—É–ª–æ)
  const statusEl = document.getElementById('approvalStatus');
  if (statusEl) statusEl.textContent = mapNames[st] || st;

  const wrap = document.getElementById('approvalCommentWrap');
  const ta   = document.getElementById('approvalComment');
  if (st === 'rejected' && approval && approval.comment){
    wrap.style.display = 'block'; ta.value = approval.comment || '';
  } else {
    wrap.style.display = 'none';  ta.value = '';
  }

  const sel  = document.getElementById('remoteRoutes');
const open = document.getElementById('openReviewLink');
if (open){
  const rid = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
  if (rid){
    open.style.display = 'inline-block';
    open.href = reviewLinkForId(rid);
  } else {
    open.style.display = 'none';
  }
}

  // ‚Äî‚Äî —Å—Ç–∞—Ç—É—Å-—á—ñ–ø (–ø—Ä–∞–≤–æ—Ä—É—á –∑–≤–µ—Ä—Ö—É) –∑ —ñ–∫–æ–Ω–∫–∞–º–∏
  const chip = document.getElementById('statusChip');
  if (chip){
    const label = mapNames[st] || '‚Äî';
    const icon  = icons[st] || '';      // –¥–ª—è draft —ñ–∫–æ–Ω–∫–∏ –Ω–µ–º–∞—î (–∑–∞ –ø–æ–±–∞–∂–∞–Ω–Ω—è–º)
    chip.textContent = (icon ? (icon + ' ') : '') + '–°—Ç–∞—Ç—É—Å: ' + label;
    chip.dataset.status = st;           // —Ç—Ä–∏–≥–µ—Ä –¥–ª—è —Å—Ç–∏–ª—ñ–≤ (pending/approved/rejected)
  }
}

// –∫–æ–ø—ñ—é—î–º–æ –ª—ñ–Ω–∫ –Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥/–ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
async function copyReviewLink(){
  const sel = document.getElementById('remoteRoutes');
  const id  = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
  if (!id){
    alert('–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É –ë–î ‚Äî –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª—ñ–Ω–∫ –∑‚Äô—è–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.');
    return;
  }
  const url = reviewLinkForId(id);
  try { await navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.'); }
  catch { prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', url); }
}

// –≤–∏—Å—Ç–∞–≤–ª—è—î–º–æ —Å—Ç–∞—Ç—É—Å pending —Ç–∞ –ø—ñ–¥–≤–∏—â—É—î–º–æ revision
// –≤–∏—Å—Ç–∞–≤–ª—è—î–º–æ —Å—Ç–∞—Ç—É—Å pending —Ç–∞ –ø—ñ–¥–≤–∏—â—É—î–º–æ revision
async function sendForApproval(){
  if (readOnly) { alert('‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤'); return; }
  if (!db || !auth?.currentUser){ alert('–£–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É.'); return; }

  const sel = document.getElementById('remoteRoutes');
  const id  = (sel && sel.value) || (LAST_SAVED_ROUTE.id || '');
  if (!id){
    alert('–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —É –ë–î ‚Äî –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –π–æ–≥–æ –º–æ–∂–Ω–∞ –≤—ñ–¥—Ä–∞–∑—É –ø–æ–¥–∞—Ç–∏ –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è.');
    return;
  }

  const user = auth.currentUser;
  const ref  = db.collection('routes').doc(id);

  await ref.set({
    approval: {
      status: 'pending',
      revision: firebase.firestore.FieldValue.increment(1),
      submittedAt: new Date().toISOString(),
      submittedByUid: user.uid || null,
      submittedByEmail: user.email || null,
      decisionAt: null,
      decidedByUid: null,
      decidedByEmail: null,
      comment: null
    },
    updatedAt: new Date().toISOString()
  }, { merge:true });

  setApprovalUI({ status:'pending' });
  await copyReviewLink();

  // --- –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram ---
  const routeName = document.getElementById('routeName')?.value || '';
  sendTelegramApprovalMessage(routeName, id);
}

// –∫–Ω–æ–ø–∫–∏ –ø–∞–Ω–µ–ª—ñ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
document.getElementById('copyReviewLink').onclick  = copyReviewLink;
document.getElementById('sendForApproval').onclick = sendForApproval;

/* ===== Buttons bindings ===== */
document.getElementById('saveToDB').onclick = saveToDB;
let lastRefreshClick = 0;
document.getElementById('refreshList').onclick = () => {
  const now = Date.now();
  if (now - lastRefreshClick < 500) return;
  lastRefreshClick = now;
  routesInitLoaded = true;       // —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ lazy-–ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  refreshRoutesList('reset');
};
document.getElementById('loadMoreRoutes').onclick = () => refreshRoutesList('next');
document.getElementById('loadAllRoutes').onclick  = () => loadAllRoutes();
document.getElementById('loadFromDB').onclick = loadFromDB;
document.getElementById('deleteFromDB').onclick = deleteFromDB;
document.getElementById('clearForm').onclick = clearForm;

/* Directory buttons */
document.getElementById('refreshDirectory').onclick = () => loadDirectory(true);
document.getElementById('clearDirCache').onclick = () => {
  try { localStorage.removeItem(dirCacheKey()); } catch {}
  loadDirectory(true);
};

/* Logists buttons */
document.getElementById('refreshLogists').onclick = async () => {
  const isLogged = !!(auth && auth.currentUser);
  await loadLogists(isLogged);
};
document.getElementById('clearLogistsCache').onclick = () => {
  try { localStorage.removeItem(LOGISTS_CACHE_KEY); } catch {}
  const isLogged = !!(auth && auth.currentUser);
  loadLogists(isLogged);
};

/* ===================== Search helper (–æ–Ω–æ–≤–ª–µ–Ω–æ) ===================== */
const routeSearch       = document.getElementById('routeSearch');
const remoteRoutesSel   = document.getElementById('remoteRoutes');

let routesSearchQ       = '';
let routesSearchLastDoc = null;   // –ø–∞–≥—ñ–Ω–∞—Ü—ñ—è —Å–∞–º–µ –¥–ª—è –ø—Ä–µ—Ñ—ñ–∫—Å–Ω–æ–≥–æ –ø–æ—à—É–∫—É
let routesSearchDone    = true;

function resetRoutesUI(){
  routesPageLastDoc = null;       // –Ω–µ —á—ñ–ø–∞—î –±–∞–∑–æ–≤—É –ø–∞–≥—ñ–Ω–∞—Ü—ñ—é ¬´–∑–∞ –¥–∞—Ç–æ—é¬ª, –∞–ª–µ –º–∏ —ó—ó —Ç—É—Ç –Ω–µ —é–∑–∞—î–º–æ
  routesDone = false;
  for (const k in routesLookup) delete routesLookup[k];
  remoteRoutesSel.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –ë–î ‚Äî</option>';
  document.getElementById('routesList').innerHTML = '';
  routesLoadedCount = 0;
}

function scoreByPosition(rowNameLower, qLower){
  const pos = (rowNameLower || '').indexOf(qLower);
  return (pos === -1 ? 1e6 : pos) * 1000 + (rowNameLower || '').length;
}

/** –ü–æ—à—É–∫: –ø—Ä–µ—Ñ—ñ–∫—Å –ø–æ nameLower + (fallback) —Ç—Ä—ñ–≥—Ä–∞–º–Ω–∏–π contains.
 *  mode: 'reset' | 'next'
 */
async function searchRoutes(q, mode='reset'){
  const qLower = String(q||'').trim().toLowerCase();

  if (mode === 'reset'){
    routesSearchQ = qLower;
    routesSearchLastDoc = null;
    routesSearchDone = true;
    resetRoutesUI();
    if (qLower.length < 3) return;     // —á–µ–∫–∞—î–º–æ –ø–æ–∫–∏ —Å—Ç–∞–Ω–µ –æ—Å–º–∏—Å–ª–µ–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞
  }

  if (!routesSearchQ) return;

  const limit = 50;
  const acc = [];
  const seen = new Set();
  const addDocs = (snap) => snap.forEach(d => { if (!seen.has(d.id)) { acc.push(d); seen.add(d.id); } });

  // -------- 1) –ü–†–ï–§–Ü–ö–° ‚Äî –ø–æ nameLower, fromLabelLower, toLabelLower --------
  const mkPrefix = (field) => {
    let qRef = db.collection('routes')
      .orderBy(field)
      .startAt(routesSearchQ)
      .endBefore(routesSearchQ + '\uf8ff')
      .limit(limit);
    qRef = withHubFilter(qRef, 'hub');
    return qRef.get({ source:'default' });
  };

  if (mode === 'reset') {
    // –ü–µ—Ä—à–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞: —Ç—Ä–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –ø—Ä–µ—Ñ—ñ–∫—Å–Ω—ñ –∑–∞–ø–∏—Ç–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –º–µ—Ä–¥–∂–∏–º–æ
    const [sName, sFrom, sTo] = await Promise.allSettled([
      mkPrefix('nameLower'),
      mkPrefix('fromLabelLower'),
      mkPrefix('toLabelLower')
    ]);
    [sName, sFrom, sTo].forEach(r => { if (r.status === 'fulfilled') addDocs(r.value); });
    // –¥–ª—è –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó –∑–∞–ø–∞–º'—è—Ç–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ "nameLower" (–ø—Ä–æ—Å—Ç–æ —ñ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ)
    if (sName.status === 'fulfilled' && sName.value.docs.length) {
      routesSearchLastDoc = sName.value.docs[sName.value.docs.length - 1];
      routesSearchDone = sName.value.size < limit;
    } else {
      routesSearchLastDoc = null;
      routesSearchDone = true;
    }
  } else {
    // –ù–∞—Å—Ç—É–ø–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏: –¥–æ–≥—Ä—É–∂–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ nameLower (–≥–æ–ª–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫)
    let qRef = db.collection('routes')
      .orderBy('nameLower')
      .startAt(routesSearchQ)
      .endBefore(routesSearchQ + '\uf8ff')
      .limit(limit);
    qRef = withHubFilter(qRef, 'hub');
    if (routesSearchLastDoc) qRef = qRef.startAfter(routesSearchLastDoc);
    const sNext = await qRef.get({ source:'default' });
    addDocs(sNext);
    routesSearchLastDoc = sNext.docs.length ? sNext.docs[sNext.docs.length - 1] : routesSearchLastDoc;
    routesSearchDone = sNext.size < limit;
  }

  // -------- 2) FALLBACK CONTAINS ‚Äî –ø–æ searchNgrams (–∑–≤–µ–¥–µ–Ω–∏–π) --------
  if (mode === 'reset' && acc.length < limit && routesSearchQ.length >= 3){
    const grams = trigrams(routesSearchQ);
    if (grams.length){
      const hubs = isAllHubs() ? [null] : ALLOWED_HUBS.slice(0,10);
      for (const h of hubs){
        let q2 = db.collection('routes')
          .where('searchNgrams','array-contains-any', grams)
          .limit(limit);
        if (h) q2 = q2.where('hub','==', h);
        const s2 = await q2.get({ source:'default' });
        addDocs(s2);
      }
    }
  }

  // -------- 3) –†–ê–ù–ñ–£–í–ê–ù–ù–Ø ‚Äî –±–ª–∏–∂—á–µ –¥–æ –ø–æ—á–∞—Ç–∫—É —É –±—É–¥—å-—è–∫–æ–º—É –∑ –ø–æ–ª—ñ–≤ --------
  const pos = (s) => (s || '').indexOf(routesSearchQ);
  const score = (d) => {
    const x = d.data() || {};
    const toNum = (v) => (v < 0 ? 1e6 : v); // -1 ‚Üí –¥—É–∂–µ –¥–∞–ª–µ–∫–æ
    return Math.min(
      toNum(pos(x.nameLower)),
      toNum(pos(x.fromLabelLower)),
      toNum(pos(x.toLabelLower))
    ) * 1000 + (x.nameLower || '').length;
  };

  acc.sort((a,b)=> score(a) - score(b));
  renderRoutesDocs(acc);
}

/* ‚Äî‚Äî‚Äî –ó–í‚Äô–Ø–ó–£–í–ê–ù–ù–Ø UI ‚Äî‚Äî‚Äî */

// –í–ê–ñ–õ–ò–í–û: –©–æ–± –Ω–µ —Ä–æ–±–∏—Ç–∏ –∑–∞–π–≤–∏–π –∑–∞–ø–∏—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ –Ω–∞ –ø–æ–ª—ñ –ø–æ—à—É–∫—É ‚Äî –ù–ï —Ç—è–≥–Ω–µ–º–æ "ensureRoutesLoaded" —Ç—É—Ç.
// –Ø–∫—â–æ —Ö–æ—á–µ—à –∑–∞–ª–∏—à–∏—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤—É –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∫—É ¬´–æ—Å—Ç–∞–Ω–Ω—ñ—Ö¬ª ‚Äî –ø—Ä–∏–≤‚Äô—è–∂–∏ ensureRoutesLoaded –ª–∏—à–µ –¥–æ —Ñ–æ–∫—É—Å–∞ –Ω–∞ <select>.
remoteRoutesSel.addEventListener('focus', ensureRoutesLoaded);

// debounce, —â–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏ Firestore –ø—ñ–¥ —á–∞—Å –¥—Ä—É–∫—É
let _rsTimer = null;
routeSearch.addEventListener('input', () => {
  if (_rsTimer) clearTimeout(_rsTimer);
  _rsTimer = setTimeout(() => searchRoutes(routeSearch.value, 'reset'), 300);
});

// Enter = —è–∫—â–æ —â–æ—Å—å –∑–Ω–∞–π—à–ª–∏ ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ
routeSearch.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    // —è–∫—â–æ –≤ —Å–ø–∏—Å–∫—É —É–∂–µ —î —è–∫—ñ—Å—å –≤–∞—Ä—ñ–∞–Ω—Ç–∏ ‚Äî —Å—Ç–∞–≤–∏–º–æ –ø–µ—Ä—à–∏–π —ñ –≤–∞–Ω—Ç–∞–∂–∏–º–æ
    for (const opt of remoteRoutesSel.options) {
      if (opt.value) { remoteRoutesSel.value = opt.value; break; }
    }
    if (remoteRoutesSel.value) document.getElementById('loadFromDB').click();
  }
});

// –ö–Ω–æ–ø–∫–∞ ¬´–©–µ¬ª —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î —ñ –¥–ª—è –ø–æ—à—É–∫—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–µ—Ñ—ñ–∫—Å–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é)
document.getElementById('loadMoreRoutes').onclick = () => {
  if (routesSearchQ) return searchRoutes(routesSearchQ, 'next');
  return refreshRoutesList('next'); // –Ω–∞–∑–∞–¥ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å, —è–∫—â–æ –ø–æ—à—É–∫ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π
};

/* Load by ?rid= */
async function loadRouteById(rid) {
  try {
    const snap = await db.collection('routes').doc(rid).get();
    if (!snap.exists) { alert('–ú–∞—Ä—à—Ä—É—Ç –∑ —Ç–∞–∫–∏–º ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ' + rid); return; }
    const data = snap.data();
    if (!userAllowsHub(data.hub || '')) {
  alert('‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—É —Ü—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: ' + (data.hub || '‚Äî'));
  return;
}
    document.getElementById('fromName').value = getNameByCode(data.fromCode) || parseNameFromLabel(data.fromLabel) || '';
    document.getElementById('toName').value   = getNameByCode(data.toCode)   || parseNameFromLabel(data.toLabel)   || '';
    document.getElementById('routeType').value = data.routeType || '–û—Å–Ω–æ–≤–Ω–∏–π';
    document.getElementById('routePurpose').value = data.purpose || '–ó–µ—Ä–Ω–æ';
    document.getElementById('intermediateText').value = data.intermediateText || '';
	document.getElementById('hubSelect').value = data.hub || '';
    document.getElementById('routeName').value = formatRouteTitle(data);
	setApprovalUI(data.approval);

    document.getElementById('logistInput').value =
      data.logisticName || (data.logisticId ? getLogistNameById(data.logisticId) : '');

    points     = fromObjPoints(data.points || []);
    startRuler = fromObjPoints(data.startRuler || []);
    endRuler   = fromObjPoints(data.endRuler || []);
    registerDirEntry(data.fromCode, data.fromLabel || document.getElementById('fromName').value);
    registerDirEntry(data.toCode,   data.toLabel   || document.getElementById('toName').value);
    rebuildMarkers(); drawRulers(); updateRoute();
    if (points.length) {
      const b = new mapboxgl.LngLatBounds(points[0], points[0]);
      for (const p of points) b.extend(p);
      map.fitBounds(b, { padding: 40 });
    }
    if (data.routeKey) alert('–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É: ' + data.routeKey);
  } catch (e) {
    console.error('loadRouteById error:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ' + (e?.message || e));
  }
}
function clearForm() {
  document.getElementById('fromName').value = '';
  document.getElementById('toName').value = '';
  document.getElementById('routeType').value = '–û—Å–Ω–æ–≤–Ω–∏–π';
  document.getElementById('routePurpose').value = '–ó–µ—Ä–Ω–æ';
  document.getElementById('intermediateText').value = '';
  document.getElementById('hubSelect').value = '';
  document.getElementById('routeName').value = '';
  document.getElementById('logistInput').value = '';
  setKmUI(0);
  points = []; startRuler = []; endRuler = [];
  rebuildMarkers(); drawRulers(); updateRoute();
  document.getElementById('remoteRoutes').value = '';

  // ‚¨áÔ∏è –¥–æ–¥–∞–π —Ü—é —Å—Ç—Ä–æ–∫—É
  updateHighlights();
  setApprovalUI(null);

  alert('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞');
}

/* ===== Panel toggle ===== */
const panelToggleBtn = document.getElementById('panelToggle');
function updatePanelToggleLabel(){
  const hidden = document.body.classList.contains('controls-hidden');
  panelToggleBtn.textContent = hidden ? '‚ñ∂ –ü–∞–Ω–µ–ª—å' : '‚óÄ –°—Ö–æ–≤–∞—Ç–∏';
  if (typeof map?.resize === 'function') requestAnimationFrame(() => map.resize());
}
panelToggleBtn.addEventListener('click', () => {
  document.body.classList.toggle('controls-hidden'); updatePanelToggleLabel();
});
updatePanelToggleLabel();

/* ======== ‚¨áÔ∏è –ì–ï–û–ó–û–ù–ò –∑—ñ STORAGE (geozones/all.geojson) ========= */
const STORAGE_GEOJSON_PATH = 'geozones/all.geojson';
// –Ø–∫—â–æ –≥–µ–æ–∑–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò –≤ Mapbox tilesets ‚Äî –≤–∏–º–∫–Ω—ñ—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑—ñ Storage
const ENABLE_STORAGE_GEOZONES = false;
let geozonesDataCache = null;
let geozonesFitted = false;
let geoClickHandler = null;

function removeLayerIfExists(id){ try{ if(map.getLayer(id)) map.removeLayer(id); }catch{} }
function removeSourceIfExists(id){ try{ if(map.getSource(id)) map.removeSource(id); }catch{} }

function buildLabel(props){
  const { name, farm, client, code } = getFieldProps(props || {});
  const parts = [name, farm, client].filter(Boolean);
  return parts.length ? parts.join(' ‚Ä¢ ') : (code || '–ü–æ–ª–µ');
}
function normalizeGeoJSON(obj){
  if (!obj || !obj.features) return obj;
  return {
    type: 'FeatureCollection',
    features: obj.features.map(f=>{
      const p = f.properties || {};
      return { ...f, properties: { ...p, _label: buildLabel(p) } };
    })
  };
}

function geozoneCardHTML(props){
  const { client, code, name, farm, area } = getFieldProps(props || {});
  const row = (label, val) => (val || val === 0) ?
    `<div style="display:flex;justify-content:space-between;gap:10px;border-bottom:1px dashed #e5e7eb;padding:4px 0;">
       <div style="color:#6b7280">${label}</div>
       <div style="font-weight:600">${esc(val)}</div>
     </div>` : '';
  return `<div style="min-width:260px;font-size:13px;line-height:1.35">
    ${row('–ü–ª–æ—â–∞', (area || area === 0) ? (fmtArea(area) + ' –≥–∞') : '')}
    ${row('–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ', client)}
    ${row('–ö–æ–¥', code)}
    ${row('–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª', farm)}
    ${row('–ù–∞–∑–≤–∞', name)}
  </div>`;
}
function attachGeozoneHandlers(){
  const clickLayers = ['geozones-fill','geozones-outline','geozones-point','geozones-label'];

  // –ö–ª—ñ–∫ ‚Äî –ø–æ–∫–∞–∑—É—î –∫–∞—Ä—Ç–∫—É (–ø–∞—Å–ø–æ—Ä—Ç –ø–æ–ª—è)
  if (geoClickHandler){
    clickLayers.forEach(id => { try { map.off('click', id, geoClickHandler); } catch{} });
  }
  geoClickHandler = (e) => {
    const feat = e.features && e.features[0];
    if (!feat) return;
    new mapboxgl.Popup({ closeButton:true, closeOnClick:true, maxWidth:'480px' })
      .setLngLat(e.lngLat)
      .setHTML(geozoneCardHTML(feat.properties || {}))
      .addTo(map);
  };
  clickLayers.forEach(id => { if (map.getLayer(id)) map.on('click', id, geoClickHandler); });

  // üîé Hover (mousemove) ‚Äî —è–∫ —É tilesets: –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ "–ø—Ä–æ–∑–æ—Ä—ñ"
  ['geozones-fill','geozones-outline','geozones-point'].forEach(id => {
    if (BOUND_HOVER_LAYERS.has(id)) return;
    if (!map.getLayer(id)) return;
    map.on('mousemove',  id, onHover);
    map.on('mouseleave', id, onLeave);
    BOUND_HOVER_LAYERS.add(id);
  });
}

function addGeozones(obj){
  geozonesDataCache = normalizeGeoJSON(obj);
  // —á–∏—Å—Ç–∏–º–æ, —è–∫—â–æ –±—É–ª–∏
  removeLayerIfExists('geozones-label');
  removeLayerIfExists('geozones-point');
  removeLayerIfExists('geozones-outline');
  removeLayerIfExists('geozones-fill');
  removeSourceIfExists('geozones');

  map.addSource('geozones', { type:'geojson', data: geozonesDataCache });

  const isPoly = ['any',
    ['==', ['geometry-type'], 'Polygon'],
    ['==', ['geometry-type'], 'MultiPolygon']
  ];
  const isPoint = ['==', ['geometry-type'], 'Point'];

  map.addLayer({
    id:'geozones-fill', type:'fill', source:'geozones', filter:isPoly,
    paint:{ 'fill-color':'#22c55e', 'fill-opacity':0.18 }
  });

  map.addLayer({
    id:'geozones-outline', type:'line', source:'geozones', filter:isPoly,
    paint:{ 'line-color':'#16a34a', 'line-width':1.2 }
  });

  map.addLayer({
    id:'geozones-point', type:'circle', source:'geozones', filter:isPoint,
    paint:{ 'circle-radius':4, 'circle-color':'#f59e0b', 'circle-stroke-width':1, 'circle-stroke-color':'#fff' }
  });

  map.addLayer({
    id:'geozones-label', type:'symbol', source:'geozones',
    layout:{
      'text-field':['get','_label'],
      'text-size':12,
      'text-offset':[0,0.8],
      'text-allow-overlap':false,
      'text-anchor':'top'
    },
    paint:{
      'text-color':'#111',
      'text-halo-color':'#fff',
      'text-halo-width':1.2
    }
  });

    attachGeozoneHandlers();
  // üî¶ –ü—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞ GeoJSON –ø—ñ–¥—Å—Ç—Ä–∞—Ö—É—î–º–æ—Å—å —ñ –æ–Ω–æ–≤–∏–º–æ –ø—ñ–¥—Å–≤—ñ—Ç–∫—É
  ensureHighlightLayers();
  ensureHighlightLabelLayers();
  bindHighlightHoverHandlers();
  updateHighlights();
  setGeozonesVisibility(geozonesVisible);
}

function fitGeozones(){
  try{
    if (!geozonesDataCache || geozonesFitted === true || !window.turf) return;
    const b = turf.bbox(geozonesDataCache); // [minX, minY, maxX, maxY]
    if (!b || b.some(v=>!isFinite(v))) return;
    geozonesFitted = true;
    map.fitBounds([[b[0], b[1]],[b[2], b[3]]], { padding: 40, maxZoom: 14 });
  }catch(e){ console.warn('fitGeozones:', e?.message||e); }
}
async function loadGeozonesFromStorage(path = STORAGE_GEOJSON_PATH, force=false){
  try{
    if (!storage){ console.warn('Storage –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ'); return; }
    let url = await storage.ref(path).getDownloadURL();
    if (force) url += (url.includes('?')?'&':'?') + 'v=' + Date.now(); // bust cache
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const obj = await res.json();
    addGeozones(obj);
    fitGeozones();
    console.log('üåê GeoJSON –≥–µ–æ–∑–æ–Ω–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑—ñ Storage:', path);
  }catch(e){
    console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏ –∑—ñ Storage:', e?.message||e);
  }
}
/* ========= ‚¨ÜÔ∏è –ì–ï–û–ó–û–ù–ò ========= */

/* ===== Auth ===== */
const authHello = document.getElementById('authHello');
const authEmail = document.getElementById('authEmail');
const authPass  = document.getElementById('authPass');
const loginBtn  = document.getElementById('authLogin');
const logoutBtn  = document.getElementById('authLogout');

// üîß ROLE helpers
let roleUnsub = null;
async function fetchRoleFromServer(u){
  try{
    const snap = await db.collection('users').doc(u.uid).get({ source: 'server' });
    return snap.exists ? (snap.data().role || 'pending') : 'pending';
  }catch{ return 'pending'; }
}

document.getElementById('mobileAuthToggle').addEventListener('click', () => {
  document.getElementById('authBar').classList.toggle('collapsed');
  requestAnimationFrame(updateLayoutHeights);
});
loginBtn.onclick = async () => {
  try{ await auth.signInWithEmailAndPassword(authEmail.value.trim(), authPass.value); }
  catch(e){ alert('üö´ –í—Ö—ñ–¥ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ: ' + (e?.message || e)); }
};
logoutBtn.onclick = async () => {
  try{ await auth.signOut(); }
  finally{
    location.replace('/login.html?next=' + encodeURIComponent('/index.html'));
  }
};
auth?.onAuthStateChanged(async (user) => {
  if (user){
  hideSplash();          // ‚¨ÖÔ∏è –æ—Å—å —Ç—É—Ç
    authHello.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + (user.email || user.uid);
    loginBtn.style.display='none'; authEmail.style.display='none'; authPass.style.display='none';
    logoutBtn.style.display='inline-block';
    if (window.matchMedia('(max-width: 640px)').matches) {
      document.getElementById('authBar').classList.add('collapsed');
    }
    requestAnimationFrame(updateLayoutHeights);

    // —Ä–æ–ª—å —ñ–∑ guard –∞–±–æ –Ω–∞–ø—Ä—è–º—É –∑ —Å–µ—Ä–≤–µ—Ä–∞ (—â–æ–± –Ω–µ ‚Äú–∑–∞–ª–∏–ø–∞–ª–æ‚Äù –Ω–∞ guest)
    let role = window.__userRole || 'pending';
if (!['admin','logist','user'].includes(role)) {
  role = await fetchRoleFromServer(user);
  window.__userRole = role;
}
// ‚úÖ –ø–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∞–ª—å–Ω—É —Ä–æ–ª—å, —É —Ç.—á. user (read-only)
applyRoleUI(['admin','logist','user'].includes(role) ? role : 'guest');
// ‚¨áÔ∏è –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
try {
  ALLOWED_HUBS = await getAllowedHubsForUser(user.uid, window.__userRole || role || 'user');
} catch (_) {
  ALLOWED_HUBS = [];
}
applyHubSelectVisibility();

// –ü–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫ –ø—ñ–¥ –¥–æ—Å—Ç—É–ø–∏ (–±–µ–∑ force ‚Äî —Å–ø—Ä–æ–±—É—î –∫–µ—à)
if (!DIR_LOADED_ONCE) {
  await loadDirectory(false);
  DIR_LOADED_ONCE = true;
}
// –ü—ñ—Å–ª—è —Ç–æ–≥–æ —è–∫ –≤—ñ–¥–æ–º—ñ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏ ‚Äî —Å—Ö–æ–≤–∞—Ç–∏ —á—É–∂—ñ tileset-–∏
applyTilesetHubVisibilitySafe();
// –Ü –ø–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω—É –≤–∏–¥–∏–º—ñ—Å—Ç—å, —â–æ–± —É—Å–µ –±—É–ª–æ —É–∑–≥–æ–¥–∂–µ–Ω–æ
setGeozonesVisibility(geozonesVisible);

    // live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ (–ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ users/{uid})
    if (roleUnsub) try{ roleUnsub(); }catch{}
    const ALLOWED = new Set(['admin','logist','user']);

roleUnsub = db.collection('users').doc(user.uid)
  .onSnapshot((doc) => {
    const r = doc.exists ? (String(doc.data().role || 'pending').toLowerCase()) : 'pending';
    window.__userRole = r;
    applyRoleUI(ALLOWED.has(r) ? r : 'guest'); // ‚úÖ 'user' –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ read-only
  });

    await loadLogists(true);
    // –í—ñ–¥–∫–ª–∞—Å—Ç–∏, —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ –ø–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä UI/–∫–∞—Ä—Ç–∏ ‚Äî –ª–∏—à–µ —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ Storage-–≥–µ–æ–∑–æ–Ω–∏
    if (ENABLE_STORAGE_GEOZONES) {
      (window.requestIdleCallback ? window.requestIdleCallback : setTimeout)(() => {
        loadGeozonesFromStorage(STORAGE_GEOJSON_PATH, true);
      });
    } else {
      console.log('GeoJSON –∑—ñ Storage –≤–∏–º–∫–Ω–µ–Ω–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–∏—à–µ Mapbox Tilesets');
    }

  } else {
  hideSplash();          // ‚¨ÖÔ∏è —ñ —Ç—É—Ç
    if (roleUnsub) try{ roleUnsub(); }catch{}
    authHello.textContent = '–ì—ñ—Å—Ç—å';
    loginBtn.style.display='inline-block'; authEmail.style.display='inline-block'; authPass.style.display='inline-block';
    logoutBtn.style.display='none';
    requestAnimationFrame(updateLayoutHeights);
    applyRoleUI('guest');
    await loadLogists(false);
  }
});

/* ===== Start ===== */
window.addEventListener('load', async () => {
  if (!db) return;
  if (!DIR_LOADED_ONCE) {      // —Ç—ñ–ª—å–∫–∏ –∫–µ—à, –±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ fetch
    await loadDirectory(false);
    DIR_LOADED_ONCE = true;
  }
  const rid = new URLSearchParams(location.search).get('rid');
  if (rid) { await ensureRoutesLoaded(); await loadRouteById(rid); }
  requestAnimationFrame(updateLayoutHeights);
});

document.getElementById('logistInput').addEventListener('focus', function(){
  const isLogged = !!(auth && auth.currentUser);
  loadLogists(isLogged);
  try { this.dispatchEvent(new KeyboardEvent('keydown', {key:'ArrowDown'})); } catch {}
});

// –æ–¥–Ω–µ –º—ñ—Å—Ü–µ, —è–∫–µ –æ–Ω–æ–≤–ª—é—î –Ω–∞–∑–≤—É –º–∞—Ä—à—Ä—É—Ç—É + –ø—ñ–¥—Å–≤—ñ—Ç–∫—É
const onFromToChange = () => {
  updateRouteName();
  updateHighlights();                 // –æ–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏
  setGeozonesVisibility(geozonesVisible); // —ñ –æ–¥—Ä–∞–∑—É –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ "—Ä–æ–∑—É–º–Ω—É" –≤–∏–¥–∏–º—ñ—Å—Ç—å
};

// —Ä–µ–∞–≥—É—î–º–æ —ñ –Ω–∞ input (–∫–æ–ª–∏ —Ç–∏ —Å—Ç–∏—Ä–∞—î—à —Ç–µ–∫—Å—Ç), —ñ –Ω–∞ change (–∫–æ–ª–∏ –ø–æ–ª–µ –≤—Ç—Ä–∞—Ç–∏–ª–æ —Ñ–æ–∫—É—Å)
['input','change'].forEach(ev => {
  document.getElementById('fromName').addEventListener(ev, onFromToChange);
  document.getElementById('toName').addEventListener(ev,   onFromToChange);
});
// ‚¨áÔ∏è –î–û–î–ê–ô –¶–ï (—É–≤—ñ–º–∫–Ω—É—Ç–∏ typeahead)
attachTypeahead('fromName');
attachTypeahead('toName');

document.getElementById('routeType').addEventListener('change', updateRouteName);
document.getElementById('routePurpose').addEventListener('change', updateRouteName);

// –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç—ñ–º
async function backfillRoutes(){
  const ref = firebase.firestore().collection('routes');
  let snap = await ref.limit(500).get();
  let done = 0;

  while (!snap.empty) {
    const batch = firebase.firestore().batch();
    snap.docs.forEach(doc => {
      const d = doc.data() || {};
      const name      = d.name || '';
      const fromLabel = d.fromLabel || '';
      const toLabel   = d.toLabel   || '';
      const searchText= [name, fromLabel, toLabel].filter(Boolean).join(' | ');

      batch.set(doc.ref, {
        nameLower:        (name||'').toLowerCase(),
        fromLabelLower:   (fromLabel||'').toLowerCase(),
        toLabelLower:     (toLabel||'').toLowerCase(),
        nameNgrams:       trigrams(name),
        fromNgrams:       trigrams(fromLabel),
        toNgrams:         trigrams(toLabel),
        searchNgrams:     trigrams(searchText),
        updatedAt:        new Date().toISOString()
      }, { merge:true });
    });
    await batch.commit();
    done += snap.size;
    const last = snap.docs[snap.docs.length-1];
    snap = await ref.startAfter(last).limit(500).get();
  }
  console.log('Backfill done:', done);
}

</script>
</body>
</html>