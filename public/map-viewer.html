<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>üó∫ –ö–∞—Ä—Ç–∞ –ø–æ–ª—ñ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="preconnect" href="https://api.mapbox.com" crossorigin>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Turf.js –¥–ª—è –≥–µ–æ–º–µ—Ç—Ä—ñ—ó -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  
  <script src="/config/config.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      touch-action: pan-x pan-y;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* –•–µ–¥–µ—Ä */
    header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(99,102,241,0.95) 0%, rgba(99,102,241,0.85) 100%);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 18px;
      color: #fff;
      font-weight: 600;
    }

    #authInfo {
      font-size: 13px;
      color: rgba(255,255,255,0.9);
    }

    #btnLogout {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }

    #btnLogout:active {
      background: rgba(255,255,255,0.3);
    }

    /* –ü–æ—à—É–∫ */
    .search-box {
      position: absolute;
      top: 80px;
      left: 16px;
      right: 16px;
      z-index: 10;
      max-width: 400px;
    }

    #placeSearch {
      width: 100%;
      height: 52px;
      padding: 0 48px 0 16px;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    #placeSearch::placeholder {
      color: #94a3b8;
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: #6366f1;
      pointer-events: none;
    }

    /* –ü–ª–∞–≤–∞—é—á–∞ –ø–∞–Ω–µ–ª—å –∑–Ω–∏–∑—É */
    .bottom-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      padding: 10px 12px;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.1);
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 120px;
      height: 44px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: #fff;
    }

    .btn-primary:active {
      transform: scale(0.96);
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }

    .btn-secondary {
      background: #fff;
      color: #6366f1;
      border: 2px solid #e0e7ff;
    }

    .btn-secondary:active {
      background: #f8fafc;
      transform: scale(0.96);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç–∏–ª—é –∫–∞—Ä—Ç–∏ */
    .map-style-selector {
      position: absolute;
      top: 160px;
      left: 16px;
      z-index: 10;
      background: #fff;
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    #mapStyleSelect {
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 600;
      color: #6366f1;
      cursor: pointer;
      padding: 4px;
      outline: none;
    }

    /* –ú–∞—Ä–∫–µ—Ä –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è */
    .user-location-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      border: 3px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .user-location-pulse {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(59,130,246,0.3);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 2s ease-out infinite;
    }

    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }

    /* –°–ø—ñ–Ω–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
    #splash {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: #fff;
      font-size: 18px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Popup - –∑–±—ñ–ª—å—à–µ–Ω–∏–π —Ö—Ä–µ—Å—Ç–∏–∫ */
    .mapboxgl-popup-close-button {
      width: 48px !important;
      height: 48px !important;
      font-size: 32px !important;
      line-height: 48px !important;
      padding: 0 !important;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤ */
    @media (max-width: 640px) {
      .bottom-panel {
        padding: 8px;
        gap: 6px;
      }
      
      .btn {
        min-width: 0;
        flex: 1 1 calc(50% - 3px);
        height: 40px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <!-- –°–ø—ñ–Ω–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
  <div id="splash">
    <div class="spinner"></div>
    <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>

  <!-- –•–µ–¥–µ—Ä -->
  <header>
    <h1>üó∫ –ö–∞—Ä—Ç–∞ –ø–æ–ª—ñ–≤</h1>
    <div style="display:flex; gap:8px; align-items:center;">
      <span id="authInfo">‚Äî</span>
      <button id="btnLogout" style="display:none;">–í–∏–π—Ç–∏</button>
    </div>
  </header>

  <!-- –ü–æ—à—É–∫ -->
  <div class="search-box">
    <input id="placeSearch" type="text" list="placeList" placeholder="–ü–æ—à—É–∫ –ø–æ–ª—ñ–≤ –∞–±–æ –º—ñ—Å—Ü—å..." autocomplete="off" />
    <span class="search-icon">üîç</span>
    <datalist id="placeList"></datalist>
  </div>

  <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç–∏–ª—é –∫–∞—Ä—Ç–∏ -->
  <div class="map-style-selector">
    <select id="mapStyleSelect">
      <option value="mapbox://styles/mapbox/streets-v12" selected>üó∫ –°—Ö–µ–º–∞</option>
      <option value="mapbox://styles/mapbox/outdoors-v12">üèû –ù–∞ –ø—Ä–∏—Ä–æ–¥—ñ</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">üõ∞ –°—É–ø—É—Ç–Ω–∏–∫</option>
      <option value="mapbox://styles/mapbox/satellite-v9">üì° –°—É–ø—É—Ç–Ω–∏–∫ (—á–∏—Å—Ç–∏–π)</option>
    </select>
  </div>

  <!-- –ö–∞—Ä—Ç–∞ -->
  <div id="map"></div>

  <!-- –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ -->
  <div class="bottom-panel">
    <button class="btn btn-primary" id="btnMyLocation">
      <span>üß≠</span>
      <span>–ú–æ—î –º—ñ—Å—Ü–µ</span>
    </button>
    <button class="btn btn-secondary" id="btnToggleGeozones">
      <span>üó∫</span>
      <span>–ì–µ–æ–∑–æ–Ω–∏</span>
    </button>
  </div>

  <script>
    'use strict';

    // ===== AUTH GUARD =====
    const CFG = window.APP_CONFIG?.firebase;
    if (!CFG) {
      alert('–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase –≤—ñ–¥—Å—É—Ç–Ω—è');
      throw new Error('No APP_CONFIG.firebase');
    }

    firebase.initializeApp(CFG);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let allowedHubs = null;

    db.enablePersistence({ synchronizeTabs: true }).catch(() => {});

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É
    async function checkAccess(uid) {
      try {
        const snap = await db.collection('users').doc(uid).get({ source: 'server' });
        if (!snap.exists) return false;
        
        const data = snap.data() || {};
        const role = String(data.role || 'user').toLowerCase();
        const additionalRoles = Array.isArray(data.additionalRoles) ? data.additionalRoles : [];
        
        // Admin - –∑–∞–≤–∂–¥–∏ –¥–æ—Å—Ç—É–ø, —ñ–Ω—à—ñ - —Ç—ñ–ª—å–∫–∏ –∑ allowMapViewer
        const isAdmin = role === 'admin';
        if (!isAdmin && data.allowMapViewer !== true) {
          alert('–£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫–∞—Ä—Ç–∏. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
          return false;
        }

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏
        if (role === 'admin' || role === 'security' || additionalRoles.includes('security') || data.allowAllHubs === true) {
          allowedHubs = null; // –≤—Å—ñ —Ö–∞–±–∏
        } else if (Array.isArray(data.allowedHubs)) {
          allowedHubs = data.allowedHubs;
        } else if (Array.isArray(data.hubs)) {
          allowedHubs = data.hubs;
        } else {
          allowedHubs = [];
        }

        return true;
      } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É:', e);
        return false;
      }
    }

    auth.onAuthStateChanged(async (user) => {
      try {
        console.log('[map-viewer] Auth state changed:', user?.uid);
        
        if (!user) {
          window.location.replace('/login.html?next=' + encodeURIComponent(location.pathname));
          return;
        }

        currentUser = user;
        
        console.log('[map-viewer] Checking access...');
        const hasAccess = await checkAccess(user.uid);
        if (!hasAccess) {
          await auth.signOut();
          window.location.replace('/login.html');
          return;
        }

        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–º'—è
        const displayName = user.displayName || user.email || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
        document.getElementById('authInfo').textContent = displayName;
        document.getElementById('btnLogout').style.display = '';

        console.log('[map-viewer] Initializing map...');
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—Ç—É
        initMap();
      } catch (error) {
        console.error('[map-viewer] Error in auth handler:', error);
        document.getElementById('splash').innerHTML = `
          <div style="color:#fee2e2; background:#991b1b; padding:16px; border-radius:12px; max-width:400px; text-align:center;">
            <div style="font-size:32px; margin-bottom:8px;">‚ö†Ô∏è</div>
            <div style="font-size:16px; font-weight:600; margin-bottom:8px;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>
            <div style="font-size:14px; opacity:0.9;">${error.message || error}</div>
            <button onclick="location.reload()" style="margin-top:16px; padding:8px 16px; background:#fff; color:#991b1b; border:none; border-radius:8px; cursor:pointer; font-weight:600;">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
          </div>
        `;
      }
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
      await auth.signOut();
      window.location.replace('/login.html');
    });

    // ===== MAPBOX =====
    mapboxgl.accessToken = window.APP_CONFIG?.mapboxToken || '';
    if (!mapboxgl.accessToken) {
      console.error('Mapbox token –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É APP_CONFIG');
      document.getElementById('splash').innerHTML = `
        <div style="color:#fee2e2; background:#991b1b; padding:16px; border-radius:12px; max-width:400px; text-align:center;">
          <div style="font-size:32px; margin-bottom:8px;">‚ö†Ô∏è</div>
          <div style="font-size:16px; font-weight:600; margin-bottom:8px;">–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó</div>
          <div style="font-size:14px; opacity:0.9;">Mapbox token –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π</div>
        </div>
      `;
      throw new Error('Mapbox token missing');
    }

    let map;
    let userLocationMarker = null;
    let geozonesVisible = true;
    let currentStyle = 'mapbox://styles/mapbox/streets-v12';
    let TILESETS = [];
    let TS_FILL_IDS = [];
    let TS_OUTLINE_IDS = [];
    let highlightTimeout = null;
    let popup = null;

    async function loadTilesetsConfig() {
      try {
        const res = await fetch('/config/tilesets.json?v=' + Date.now());
        const data = await res.json();
        TILESETS = Array.isArray(data) ? data : (data.tilesets || []);
      } catch (e) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è tilesets:', e);
        TILESETS = [];
      }
    }

    function initMap() {
      try {
        console.log('[map-viewer] Creating Mapbox instance...');
        map = new mapboxgl.Map({
          container: 'map',
          style: currentStyle,
          center: [30.5, 49.0],
          zoom: 7,
          attributionControl: false
        });

        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

        map.on('load', async () => {
          try {
            console.log('[map-viewer] Map loaded, adding tilesets...');
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—ñ
            setMapLanguage('uk');
            
            await loadTilesetsConfig();
            addTilesets();
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ popup
            popup = new mapboxgl.Popup({
              closeButton: true,
              closeOnClick: true,
              maxWidth: '360px'
            });
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ –≥–µ–æ–∑–æ–Ω–∏
            setupGeozoneClickHandler();
            
            console.log('[map-viewer] Tilesets added, hiding splash...');
            document.getElementById('splash').style.display = 'none';
          } catch (error) {
            console.error('[map-viewer] Error loading tilesets:', error);
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å–ø—ñ–Ω–µ—Ä –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞
            document.getElementById('splash').style.display = 'none';
            alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–µ–æ–∑–æ–Ω: ' + (error.message || error));
          }
        });

        // –ü—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∏–ª—é –∫–∞—Ä—Ç–∏ - –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≥–µ–æ–∑–æ–Ω–∏
        map.on('style.load', () => {
          console.log('[map-viewer] Style loaded event');
          // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É
          setMapLanguage('uk');
          // –ó–∞–≤–∂–¥–∏ –¥–æ–¥–∞—î–º–æ –≥–µ–æ–∑–æ–Ω–∏ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∏–ª—é
          setTimeout(() => {
            addTilesets();
          }, 200);
        });

        map.on('error', (e) => {
          console.error('[map-viewer] Map error:', e);
          document.getElementById('splash').style.display = 'none';
        });

        // –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è
        setupGeolocation();
        
        // –ü–æ—à—É–∫
        setupSearch();
        
        // –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–∑–æ–Ω
        document.getElementById('btnToggleGeozones').addEventListener('click', toggleGeozones);
        
        // –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç–∏–ª—é –∫–∞—Ä—Ç–∏
        document.getElementById('mapStyleSelect').addEventListener('change', (e) => {
          const newStyle = e.target.value;
          if (newStyle !== currentStyle) {
            currentStyle = newStyle;
            map.setStyle(currentStyle);
          }
        });
      } catch (error) {
        console.error('[map-viewer] Error initializing map:', error);
        document.getElementById('splash').style.display = 'none';
        alert('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏: ' + (error.message || error));
      }
    }

    // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –º–æ–≤–∏ –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—ñ
    function setMapLanguage(lang) {
      const style = map.getStyle();
      if (!style || !style.layers) return;
      
      const ukTextExpr = [
        'coalesce',
        ['get', 'name_uk'],
        ['get', 'name:uk'],
        ['get', 'name_ua'],
        ['get', 'name:ua'],
        ['get', 'name_local'],
        ['get', 'name']
      ];
      
      const skip = new Set(['geozones-labels']);
      
      style.layers.forEach(l => {
        if (l.type !== 'symbol') return;
        if (skip.has(l.id)) return; // –Ω–µ —á—ñ–ø–∞—î–º–æ –ø—ñ–¥–ø–∏—Å–∏ –ø–æ–ª—ñ–≤
        
        const hasTextField = map.getLayoutProperty(l.id, 'text-field') !== undefined;
        if (hasTextField) {
          try {
            map.setLayoutProperty(l.id, 'text-field', ukTextExpr);
          } catch (e) {
            // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –¥–ª—è –æ–∫—Ä–µ–º–∏—Ö —à–∞—Ä—ñ–≤
          }
        }
      });
      
      console.log('[map-viewer] Ukrainian labels applied');
    }

    // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –ø–ª–æ—â—ñ
    function fmtArea(a) {
      const n = parseFloat(a);
      if (isNaN(n)) return '';
      return n.toLocaleString('uk-UA', { maximumFractionDigits: 2 });
    }

    // –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
    function esc(v) {
      return String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // HTML –¥–ª—è popup
    function getPopupHTML(props, sourceId) {
      const fp = getFieldProps(props || {});
      const name = fp.name || fp.code || '';
      const code = fp.code || '';
      const client = props.Client || props.client || props.–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ || props.–ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ || '';
      const farm = props.Farm || props.farm || props.–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª || props.–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª || '';
      
      // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ –≤–∑—è—Ç–∏ —Ö–∞–± –∑ properties
      let hub = props.Hub || props.hub || props.–•–∞–± || props.—Ö–∞–± || '';
      
      // –Ø–∫—â–æ —Ö–∞–±—É –Ω–µ–º–∞—î –≤ properties - –±–µ—Ä–µ–º–æ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞–π–ª—Å–µ—Ç–∞
      if (!hub && sourceId) {
        const tileset = TILESETS.find(ts => `geozones-tileset-${ts.key}` === sourceId);
        if (tileset && Array.isArray(tileset.hubs) && tileset.hubs.length > 0) {
          hub = tileset.hubs.join(', ');
        }
      }
      
      const area = props.Area || props.area || props.–ü–ª–æ—â–∞ || props.–ø–ª–æ—â–∞ || '';
      
      const rows = [
        ['–•–∞–±', hub],
        ['–ù–∞–∑–≤–∞', name],
        ['–ö–æ–¥', code],
        ['–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ', client],
        ['–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª', farm],
        ['–ü–ª–æ—â–∞', (area !== '' && area !== null && area !== undefined) ? (fmtArea(area) + ' –≥–∞') : '']
      ];

      const htmlRows = rows.map(([label, val]) =>
        `<div style="margin-bottom:4px;"><b>${label}:</b> ${esc(val) || '‚Äî'}</div>`
      ).join('');

      return `<div style="font-size:14px;line-height:1.5;">${htmlRows}</div>`;
    }

    function addTilesets() {
      // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ ID —à–∞—Ä—ñ–≤
      TS_FILL_IDS = [];
      TS_OUTLINE_IDS = [];
      
      TILESETS.forEach(ts => {
        if (ts.enabled === false) return;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É –∑–∞ —Ö–∞–±–∞–º–∏
        const tsHubs = Array.isArray(ts.hubs) ? ts.hubs : [];
        if (allowedHubs !== null && allowedHubs.length > 0) {
          if (tsHubs.length > 0 && !tsHubs.some(h => allowedHubs.includes(h))) {
            return; // –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É
          }
        }

        const sourceId = `geozones-tileset-${ts.key}`;
        const fillId = `tileset-fill-${ts.key}`;
        const outlineId = `tileset-outline-${ts.key}`;

        if (!map.getSource(sourceId)) {
          map.addSource(sourceId, { type: 'vector', url: ts.url });
        }

        if (!map.getLayer(fillId)) {
          map.addLayer({
            id: fillId,
            type: 'fill',
            source: sourceId,
            'source-layer': ts.layer,
            paint: {
              'fill-color': '#16a34a',
              'fill-opacity': 0.35
            }
          });
          TS_FILL_IDS.push(fillId);
        }

        if (!map.getLayer(outlineId)) {
          map.addLayer({
            id: outlineId,
            type: 'line',
            source: sourceId,
            'source-layer': ts.layer,
            paint: {
              'line-color': '#0d7a3a',
              'line-width': 2
            }
          });
          TS_OUTLINE_IDS.push(outlineId);
        }
      });

      // –ü—ñ–¥–ø–∏—Å–∏ —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤
      buildGeozoneCentroids();

      // Source —ñ layer –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ—ó –≥–µ–æ–∑–æ–Ω–∏
      if (!map.getSource('geozone-highlight')) {
        map.addSource('geozone-highlight', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        });
      }

      if (!map.getLayer('geozone-highlight-fill')) {
        map.addLayer({
          id: 'geozone-highlight-fill',
          type: 'fill',
          source: 'geozone-highlight',
          paint: {
            'fill-color': '#fbbf24',
            'fill-opacity': 0.6
          }
        });
      }

      if (!map.getLayer('geozone-highlight-outline')) {
        map.addLayer({
          id: 'geozone-highlight-outline',
          type: 'line',
          source: 'geozone-highlight',
          paint: {
            'line-color': '#f59e0b',
            'line-width': 3
          }
        });
      }
    }

    function buildGeozoneCentroids() {
      if (!window.turf || TS_FILL_IDS.length === 0) return;

      const features = map.queryRenderedFeatures({ layers: TS_FILL_IDS }) || [];
      const seen = new Set();
      const out = [];

      for (const f of features) {
        const props = f.properties || {};
        const label = props.Name || props.name || props.Code || props.code || '–ü–æ–ª–µ';
        const key = `${f.source}:${props.id || props.OBJECTID || label}`;
        
        if (seen.has(key)) continue;
        seen.add(key);

        let center = null;
        try {
          center = turf.centerOfMass(f).geometry.coordinates;
        } catch (_) {
          try {
            const bbox = turf.bbox(f);
            center = [(bbox[0] + bbox[2]) / 2, (bbox[1] + bbox[3]) / 2];
          } catch (_) {}
        }

        if (center) {
          out.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: center },
            properties: { label }
          });
        }
      }

      const fc = { type: 'FeatureCollection', features: out };

      if (map.getSource('geozones-centroids')) {
        map.getSource('geozones-centroids').setData(fc);
      } else {
        map.addSource('geozones-centroids', { type: 'geojson', data: fc });
        map.addLayer({
          id: 'geozones-labels',
          type: 'symbol',
          source: 'geozones-centroids',
          layout: {
            'text-field': ['get', 'label'],
            'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
            'text-size': 13,
            'text-allow-overlap': false,
            'text-ignore-placement': false
          },
          paint: {
            'text-color': '#1f2937',
            'text-halo-color': '#fff',
            'text-halo-width': 2
          }
        });
      }
    }

    function toggleGeozones() {
      geozonesVisible = !geozonesVisible;
      const visibility = geozonesVisible ? 'visible' : 'none';
      
      [...TS_FILL_IDS, ...TS_OUTLINE_IDS, 'geozones-labels'].forEach(id => {
        if (map.getLayer(id)) {
          map.setLayoutProperty(id, 'visibility', visibility);
        }
      });

      const btn = document.getElementById('btnToggleGeozones');
      btn.querySelector('span:last-child').textContent = geozonesVisible ? '–°—Ö–æ–≤–∞—Ç–∏' : '–ü–æ–∫–∞–∑–∞—Ç–∏';
    }

    function highlightGeozone(geozonenName) {
      if (!map || !window.turf || TS_FILL_IDS.length === 0) return;

      // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ç–∞–π–º–µ—Ä
      if (highlightTimeout) {
        clearTimeout(highlightTimeout);
        highlightTimeout = null;
      }

      console.log('[highlightGeozone] –®—É–∫–∞—î–º–æ –≥–µ–æ–∑–æ–Ω—É:', geozonenName);
      
      // –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –Ω–∞–∑–≤—É –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è (trim + lowercase)
      const normalizedSearchName = geozonenName.trim().toLowerCase();

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –í–°–Ü features –≥–µ–æ–∑–æ–Ω–∏ –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é (–º–æ–∂–µ –±—É—Ç–∏ —Ä–æ–∑–±–∏—Ç–∞ –Ω–∞ —Ç–∞–π–ª–∏)
      const features = map.queryRenderedFeatures({ layers: TS_FILL_IDS }) || [];
      console.log('[highlightGeozone] –í—Å—å–æ–≥–æ features –Ω–∞ –∫–∞—Ä—Ç—ñ:', features.length);
      
      const targetFeatures = features.filter(f => {
        const props = f.properties || {};
        const fp = getFieldProps(props);
        const name = fp.name || fp.code || '';
        const normalizedFeatureName = name.trim().toLowerCase();
        
        // –î–ª—è –¥–µ–±–∞–≥—É
        if (normalizedFeatureName.includes('—Å–∫–ª–∞–¥') || normalizedFeatureName.includes('—è—Ä–∏—à')) {
          console.log('[highlightGeozone] –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ:', {
            feature: name,
            normalized: normalizedFeatureName,
            search: normalizedSearchName,
            match: normalizedFeatureName === normalizedSearchName
          });
        }
        
        return normalizedFeatureName === normalizedSearchName;
      });

      console.log('[highlightGeozone] –ó–Ω–∞–π–¥–µ–Ω–æ features:', targetFeatures.length);

      if (targetFeatures.length === 0) {
        console.warn('[highlightGeozone] –ì–µ–æ–∑–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ:', geozonenName);
        return;
      }

      // –û–Ω–æ–≤–ª—é—î–º–æ source –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è - –¥–æ–¥–∞—î–º–æ –≤—Å—ñ —á–∞—Å—Ç–∏–Ω–∏
      const fc = {
        type: 'FeatureCollection',
        features: targetFeatures
      };

      if (map.getSource('geozone-highlight')) {
        map.getSource('geozone-highlight').setData(fc);
        console.log('[highlightGeozone] –ü—ñ–¥—Å–≤—ñ—á–µ–Ω–æ features:', targetFeatures.length);
      }

      // –ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ - –æ—á–∏—â–∞—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
      highlightTimeout = setTimeout(() => {
        if (map.getSource('geozone-highlight')) {
          map.getSource('geozone-highlight').setData({
            type: 'FeatureCollection',
            features: []
          });
        }
        highlightTimeout = null;
      }, 30000);
    }

    // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ –≥–µ–æ–∑–æ–Ω—É
    function setupGeozoneClickHandler() {
      const clickHandler = (e) => {
        if (!e.features || !e.features[0]) return;
        const feature = e.features[0];
        const props = feature.properties || {};
        const sourceId = feature.source;
        
        if (popup) {
          popup
            .setLngLat(e.lngLat)
            .setHTML(getPopupHTML(props, sourceId))
            .addTo(map);
        }
      };

      // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—ñ—Ö fill layers
      TS_FILL_IDS.forEach(id => {
        map.on('click', id, clickHandler);
      });

      // –ö—É—Ä—Å–æ—Ä pointer –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ
      TS_FILL_IDS.forEach(id => {
        map.on('mouseenter', id, () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', id, () => {
          map.getCanvas().style.cursor = '';
        });
      });
    }

    // ===== –ì–ï–û–õ–û–ö–ê–¶–Ü–Ø =====
    function setupGeolocation() {
      let watchId = null;

      document.getElementById('btnMyLocation').addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≤–∞—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó');
          return;
        }

        if (watchId) {
          // –í–∏–º–∫–Ω—É—Ç–∏ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          if (userLocationMarker) {
            userLocationMarker.remove();
            userLocationMarker = null;
          }
          document.getElementById('btnMyLocation').querySelector('span:last-child').textContent = '–ú–æ—î –º—ñ—Å—Ü–µ';
          return;
        }

        // –£–≤—ñ–º–∫–Ω—É—Ç–∏ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è
        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const { longitude, latitude } = pos.coords;
            
            if (!userLocationMarker) {
              const el = document.createElement('div');
              el.className = 'user-location-marker';
              const pulse = document.createElement('div');
              pulse.className = 'user-location-pulse';
              el.appendChild(pulse);
              
              userLocationMarker = new mapboxgl.Marker({ element: el })
                .setLngLat([longitude, latitude])
                .addTo(map);
              
              map.flyTo({ center: [longitude, latitude], zoom: 14 });
            } else {
              userLocationMarker.setLngLat([longitude, latitude]);
            }

            document.getElementById('btnMyLocation').querySelector('span:last-child').textContent = '–í–∏–º–∫–Ω—É—Ç–∏';
          },
          (error) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó:', error);
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è');
          },
          { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
        );
      });
    }

    // ===== –ü–û–®–£–ö =====
    function getFieldProps(props) {
      return {
        name: props.Name || props.name || props.–ù–ê–ó–í–ê || props.–Ω–∞–∑–≤–∞ || '',
        code: props.Code || props.code || props.–ö–û–î || props.–∫–æ–¥ || ''
      };
    }

    function searchGeozones(query) {
      if (!query || query.length < 2) return [];
      const q = query.toLowerCase().trim();
      const results = [];

      if (map && TS_FILL_IDS.length > 0) {
        try {
          const features = map.queryRenderedFeatures({ layers: TS_FILL_IDS }) || [];
          const seen = new Set();

          for (const f of features) {
            const props = f.properties || {};
            const fp = getFieldProps(props);
            const name = fp.name || fp.code || '';

            if (!name || !name.toLowerCase().includes(q)) continue;
            if (seen.has(name)) continue;
            seen.add(name);

            let center = null;
            try {
              if (window.turf) center = turf.centerOfMass(f).geometry.coordinates;
            } catch (_) {
              try {
                if (window.turf) {
                  const bbox = turf.bbox(f);
                  center = [(bbox[0] + bbox[2]) / 2, (bbox[1] + bbox[3]) / 2];
                }
              } catch (_) {}
            }

            if (center) {
              results.push({
                id: `geozone-${name}`,
                name,
                full: `üó∫ ${name}`,
                center,
                type: 'geozone'
              });
            }
          }
        } catch (e) {
          console.warn('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É –≥–µ–æ–∑–æ–Ω:', e);
        }
      }

      return results;
    }

    async function suggestPlaces(q) {
      const geozones = searchGeozones(q);

      try {
        const url = new URL('https://api.mapbox.com/geocoding/v5/mapbox.places/' + encodeURIComponent(q) + '.json');
        url.searchParams.set('access_token', mapboxgl.accessToken);
        url.searchParams.set('autocomplete', 'true');
        url.searchParams.set('language', 'uk');
        url.searchParams.set('limit', '5');
        url.searchParams.set('types', 'place,locality,region,district');
        url.searchParams.set('country', 'ua');

        const res = await fetch(url.toString());
        const data = await res.json();
        const places = (data.features || []).map(f => ({
          id: f.id,
          name: f.text_uk || f.text || '',
          full: `üìç ${f.place_name_uk || f.place_name || ''}`,
          center: f.center,
          type: 'place'
        }));

        return [...geozones, ...places];
      } catch (_) {
        return geozones;
      }
    }

    function setupSearch() {
      const input = document.getElementById('placeSearch');
      const list = document.getElementById('placeList');
      let timer = null;
      let results = [];

      input.addEventListener('input', () => {
        const q = input.value.trim();
        if (timer) clearTimeout(timer);
        
        if (q.length < 2) {
          list.innerHTML = '';
          return;
        }

        timer = setTimeout(async () => {
          results = await suggestPlaces(q);
          list.innerHTML = '';
          results.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.full;
            list.appendChild(opt);
          });
        }, 400);
      });

      input.addEventListener('change', () => {
        const q = input.value.trim();
        const found = results.find(r => r.full === q);
        console.log('[search] Change event:', { q, found });
        if (found && found.center) {
          map.flyTo({ center: found.center, zoom: Math.max(map.getZoom() || 0, 12) });
          
          // –Ø–∫—â–æ —Ü–µ –≥–µ–æ–∑–æ–Ω–∞ - –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ —ó—ó
          if (found.type === 'geozone') {
            console.log('[search] –í–∏–∫–ª–∏–∫–∞—î–º–æ highlightGeozone –∑:', found.name);
            highlightGeozone(found.name);
          }
          
          input.blur();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const q = input.value.trim();
          const found = results.find(r => r.full === q);
          console.log('[search] Enter event:', { q, found });
          if (found && found.center) {
            map.flyTo({ center: found.center, zoom: Math.max(map.getZoom() || 0, 12) });
            
            // –Ø–∫—â–æ —Ü–µ –≥–µ–æ–∑–æ–Ω–∞ - –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ —ó—ó
            if (found.type === 'geozone') {
              console.log('[search] –í–∏–∫–ª–∏–∫–∞—î–º–æ highlightGeozone –∑:', found.name);
              highlightGeozone(found.name);
            }
            
            input.blur();
          }
        }
      });
    }
  </script>
</body>
</html>
