<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- App config -->
  <script src="/config/config.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- LZ-String (srcz) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
  html, body { overflow-x: clip; } /* fallback: hidden */
  .table-wrap { overflow:auto; max-width:100%; }
    :root { --w: min(1400px, 96vw); }  /* —à–∏—Ä—à–µ —ñ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ */
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; }
    .wrap { max-width:var(--w); margin:24px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }
    h1 { margin:0 0 12px; font-size:20px; }

    .row { display:grid; gap:12px; }
    .row.cols-2 { grid-template-columns: 1fr 1fr; }
    .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .row.dates { grid-template-columns: minmax(180px,1fr) minmax(180px,1fr); gap:10px; }
    @media (max-width: 860px) { .row.cols-4 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { .row.cols-2, .row.cols-3, .row.cols-4, .row.dates { grid-template-columns: 1fr; } }

    label { display:block; font-size:13px; color:#555; margin:4px 0; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width:100%; padding:8px 10px; border:1px solid #d5d9e0; border-radius:8px; background:#fff; font-size:14px;
    }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.sm { padding:4px 8px; font-size:12.5px; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#667085; font-size:12.5px; }
    .warn { color:#b91c1c; font-size:12px; }

    /* —Ç–∞–±–ª–∏—Ü—è */
    table { width:100%; border-collapse:collapse; table-layout: fixed; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; text-align:left; vertical-align: top; }
    th { background:#f1f5f9; position:relative; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }

    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#111827; }
    .stats .chip { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; }

    /* –∫–∞—Ä—Ç–∫–∞ –∑ —Ç–∞–±–ª–∏—Ü–µ—é –≤ –º–µ–∂–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.card.edge{
  width: 100%;
  margin-left: 0;
  margin-right: 0;
  border-radius: 12px;
}
    /* —à–∏—Ä–∏–Ω–∏/–ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –∫–æ–º—ñ—Ä–æ–∫ */
    .col-code { width: 120px; }
    .cell-code { word-break: break-all; overflow-wrap: anywhere; white-space: normal; line-height:1.25; }

    /* –ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏ */
    .col-via { width: clamp(220px, 28%, 520px); } /* –∞–±–æ 40ch / 30% ‚Äî —è–∫ –∑—Ä—É—á–Ω—ñ—à–µ */
    .cell-via { white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height: 1.25; }

    .col-key { width: clamp(140px, 16vw, 200px); }
    .col-id  { width: clamp(120px, 18vw, 220px); }

    .col-status { width: clamp(140px, 18vw, 200px); }
    .col-comment { width: clamp(220px, 36vw, 520px); }
    .cell-comment { white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height:1.25; }

    .cell-key, .cell-id { position:relative; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right:28px; }
    .copy-btn { position:absolute; right:6px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:14px; opacity:.75; }
    .copy-btn:hover { opacity:1; }

    /* —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è / —Ñ—ñ–ª—å—Ç—Ä–∏ –≤ —à–∞–ø—Ü—ñ */
    th.sortable { cursor:pointer; user-select:none; }
    th.sortable .s { font-size:11px; opacity:.6; margin-left:6px; }
    th.sortable.active .s { opacity:1; }
    thead tr.filters th { background:#fafafa; }
    thead tr.filters input, thead tr.filters select {
      width:100%; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px; font-size:12px; background:#fff;
    }
    .range { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }

    /* === –†—É—á–∫–∏ –¥–ª—è –∑–º—ñ–Ω–∏ —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ === */
    .col-resizer{
  position:absolute; top:0; right:0; width:10px; height:100%;
  cursor:col-resize; user-select:none;
}
    .col-resizer:hover { background:rgba(37,99,235,.15); }
    .resizing .col-resizer { background:rgba(37,99,235,.25); }
	
	/* ==== –õ—ñ–≤–∏–π —Å–∞–π–¥–±–∞—Ä –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏ ==== */
/* —Å—Ç–∞–ª–æ ‚Äî —Å–∞–π–¥–±–∞—Ä –≥–Ω—É—á–∫–∏–π —ñ –º–æ–∂–µ –∑–≥–æ—Ä—Ç–∞—Ç–∏—Å—è */
.layout{
  display:grid;
  grid-template-columns: 1fr; /* –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç—è–≥–Ω—É—Ç—å—Å—è –Ω–∞ –≤—Å—é, —ñ–Ω—à–µ —Ü–µ–Ω—Ç—Ä—É—î–º–æ */
  gap:16px;
  align-items:start;
}

/* –î—ñ—Ç–∏ .main —Ä–æ–∑–∫–ª–∞–¥–∞—é—Ç—å—Å—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –≥—Ä—ñ–¥ .layout */
.layout .main{
  display: contents;
  min-width: 0; /* —Ç–µ —Å–∞–º–µ, —â–æ –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ */
}

/* –§—ñ–ª—å—Ç—Ä–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É, –æ–±–º–µ–∂—É—î–º–æ —à–∏—Ä–∏–Ω—É */
.filters-card{
  grid-column: 1 / -1;     /* –∑–∞–π–º–∞—î –≤—Å—é —Å—ñ—Ç–∫—É, –∞–ª–µ‚Ä¶ */
  max-width: 1100px;       /* ‚Ä¶–≤—ñ–∑—É–∞–ª—å–Ω–æ –Ω–µ —Ä–æ–∑–ª—è–ø—É—î—Ç—å—Å—è */
  justify-self: center;    /* —Ü–µ–Ω—Ç—Ä—É—î–º–æ */
}

/* –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî —Ñ—É–ª-–±—Ä—ñ–¥ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤—ñ–∫–Ω–∞ */
.results-card{
  grid-column: 1 / -1;
  margin-left:  calc(50% - 50vw + 16px);
  margin-right: calc(50% - 50vw + 16px);
  max-width: 100vw;     /* —â–æ–± –Ω–µ —Ä–æ–∑–ø–æ–≤–∑–ª–æ—Å—å —à–∏—Ä—à–µ –≤—ñ–∫–Ω–∞ */
  border-radius: 12px;
}


.colpicker{
  grid-column: 1 / -1;           /* –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É, —è–∫ –∫–∞—Ä—Ç–∫–∞ */
  position: static;              /* –±—ñ–ª—å—à–µ –Ω–µ sticky */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:12px;
  max-height: none;
  overflow: visible;
}

.colpicker h3{ margin:0 0 8px; font-size:14px; }
.colpicker .list{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 8px 12px;
}
.colpicker label{ display:flex; align-items:center; gap:8px; font-size:13px; }
.colpicker .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
/* ‚ñ∫ –°–∞–º–µ —Ü–µ –¥–æ–¥–∞–π */
.colpicker.is-hidden{ display:none; }
.filters-card.is-hidden{ display:none; }

/* –∫–Ω–æ–ø–∫–∞-—Ç–æ–≥–ª –∑–≤–µ—Ä—Ö—É –ø—Ä–∞–≤–æ—Ä—É—á */
.coltoggle{ margin-left:8px; }

/* –¥—Ä—ñ–±–Ω–∏—Ü—è: —Ö–∞–π –æ—Å–Ω–æ–≤–Ω–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å —Å—Ç–∏—Å–∫–∞—î—Ç—å—Å—è */
.layout .main{ min-width:0; }

/* —Ç–∞–±–ª–∏—Ü—è: —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –•–ê–ë */
.col-hub { width: 120px; }

/* —â–æ–± ¬´–†–µ–∑—É–ª—å—Ç–∞—Ç–∏¬ª –Ω–µ —Ä–æ–∑—Ç—è–≥—É–≤–∞–ª–∏—Å—å –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤ –º–µ–∂–∞—Ö layout */
.layout .main .card.edge { width:100%; margin-left:0; margin-right:0; border-radius:12px; }

/* –º–æ–±—ñ–ª—å–Ω–µ: —Å–∞–π–¥–±–∞—Ä –ø—ñ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç */
@media (max-width: 980px){
  .layout{ grid-template-columns: 1fr; }
  .colpicker{ position:static; }
  .filters-card{ grid-column: 1 / -1; }   /* —â–æ–± –∫–∞—Ä—Ç–∫–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–µ ¬´—Ç—è–≥–Ω—É–ª–∞—Å—è¬ª –≤ –Ω–µ—ñ—Å–Ω—É—é—á—É 2-–≥—É –∫–æ–ª–æ–Ω–∫—É */
}

.card { overflow:hidden; }  /* —â–æ–± –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–µ ¬´–≤–∏–≥—Ä–∏–∑–∞–ª–∏¬ª –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª */

/* –•–µ–¥–µ—Ä: –∑–ª—ñ–≤–∞ –Ω–∞–∑–≤–∞, —Å–ø—Ä–∞–≤–∞ –∫–Ω–æ–ø–∫–∏ */
.topbar.header-grid{
  display:grid;
  grid-template-columns: 260px 1fr; /* –ª—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ –ø—ñ–¥ –Ω–∞–∑–≤—É */
  align-items:start;                /* –∫–Ω–æ–ø–∫–∏ –∑–≤–µ—Ä—Ö—É –ø—Ä–∞–≤–æ—Ä—É—á */
  gap:16px;
  margin-bottom:12px;               /* —è–∫ —ñ –±—É–ª–æ */
}

/* –ù–∞–∑–≤–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É –±–ª–æ–∫—É –∑–ª—ñ–≤–∞ */
.page-title{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:120px;                 /* —â–æ–± –±—É–ª–æ ¬´–ø–æ —Ü–µ–Ω—Ç—Ä—É¬ª */
  background:#fff;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  padding:12px;
  text-align:center;
  font-size:20px;
  font-weight:600;
  margin:0;                         /* –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø h1 */
}

/* –ö–Ω–æ–ø–∫–∏ –≤–≥–æ—Ä—ñ –ø—Ä–∞–≤–æ—Ä—É—á */
.header-actions{
  display:flex;
  justify-content:flex-end;         /* –ü–†–ê–í–û–†–£–ß */
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}

/* –ê–¥–∞–ø—Ç–∏–≤ */
@media (max-width: 980px){
  .topbar.header-grid{ grid-template-columns: 1fr; }
  .page-title{ min-height:auto; }
  .header-actions{ justify-content:flex-start; }
}

/* –©–æ–± –∫–æ—Ä–æ—Ç–∫—ñ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —Å—Ç–∏—Å–∫–∞–ª–∏—Å—å –∑–æ–≤—Å—ñ–º */
#resTable th, #resTable td { min-width: 90px; }

/* –õ–∏–ø–∫–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª –ø–æ–≤–µ—Ä—Ö —Ç–∞–±–ª–∏—Ü—ñ */
.results-card { position: relative; }
#xScroller{
  position: sticky;
  top: 8px;              /* —è–∫—â–æ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—î—Ç—å—Å—è —Ö–µ–¥–µ—Ä–æ–º ‚Äì –∑–±—ñ–ª—å—à —Ü–µ —á–∏—Å–ª–æ */
  z-index: 20;
  height: 16px;          /* –≤–∏—Å–æ—Ç–∞ –∑–æ–Ω–∏ —Å–∫—Ä–æ–ª—É */
  overflow-x: auto;
  overflow-y: hidden;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 8px;
}
#xScroller::-webkit-scrollbar { height: 12px; }   /* —Ç–æ–≤—Å—Ç—ñ—à–∏–π —Å–∫—Ä–æ–ª —É WebKit */
#xScroller > div { height: 1px; }                 /* ¬´–¥–æ—Ä—ñ–∂–∫–∞¬ª –¥–ª—è —à–∏—Ä–∏–Ω–∏ */

  </style>
  
  <!-- AUTH GUARD: /export ‚Äî –ª–∏—à–µ admin | logist -->
<script>
(function () {
  // —Ö–æ–≤–∞—î–º–æ DOM, –ø–æ–∫–∏ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –¥–æ—Å—Ç—É–ø
  document.documentElement.style.visibility = 'hidden';

  // –ª–æ–∫–∞–ª—å–Ω–∞ (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó) –∫–æ–ø—ñ—è –∫–æ–Ω—Ñ—ñ–≥–∞, —â–æ–± –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É–≤–∞—Ç–∏ –∑ –Ω–∏–∂–Ω—ñ–º const firebaseConfig
  const CFG = window.APP_CONFIG?.firebase;
if (!CFG) console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js —ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è <script src="/config/config.js">.');
try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) {}
  const auth = firebase.auth();
  const db   = firebase.firestore();

  const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);

  // —Ö–µ–ª–ø–µ—Ä: –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏/–æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –±–µ–π–¥–∂ —Ä–æ–ª—ñ —É —à–∞–ø—Ü—ñ (—è–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç —É–∂–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–∏–π)
  function setRoleBadge(r) {
    const el = document.getElementById('authRole');
    if (el) {
      el.textContent = `–†–æ–ª—å: ${r || '‚Äî'}`;
      el.style.display = '';
    }
  }

  // –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ/–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ ‚Äî –≤—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –≤—ñ–¥ live-—Ä–æ–ª—ñ
  window.addEventListener('beforeunload', () => { try { window.__roleUnsub?.(); } catch(_) {} });

  auth.onAuthStateChanged(async (u) => {
    if (!u) { location.replace(loginURL); return; }

    try {
      // ‚úÖ —Ä–æ–ª—ñ ‚Äî –ª–∏—à–µ –∑ —Å–µ—Ä–≤–µ—Ä–∞, —â–æ–± –Ω–µ –±—É–ª–æ "–∑–∞–ª–∏–ø–∞–Ω–Ω—è" –∫–µ—à—É
      const snap = await db.collection('users').doc(u.uid).get({ source: 'server' });
      const role = snap.exists ? (snap.data().role || 'pending') : 'pending';

      // –∑—Ä–æ–±–∏–º–æ —Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–Ω–æ—é –Ω–∏–∂–Ω—ñ–º —Å–∫—Ä–∏–ø—Ç–∞–º
      window.__userRole = role;
      setRoleBadge(role);

      // —è–∫—â–æ —â–µ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π –∞–±–æ –±–µ–∑ –ø—Ä–∞–≤ ‚Äî –æ–¥—Ä–∞–∑—É –Ω–∞–∑–∞–¥ –Ω–∞ –ª–æ–≥—ñ–Ω
      if (role === 'pending') {
        alert('–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
        location.replace(loginURL); return;
      }
      if (!['admin','logist','user','security'].includes(role)) {
  alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ï–∫—Å–ø–æ—Ä—Ç—É.');
  location.replace(loginURL); return;
}

      // ‚ùó Live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ: —è–∫—â–æ –∞–¥–º—ñ–Ω –∑–º—ñ–Ω–∏—Ç—å —Ä–æ–ª—å —É –ø—Ä–æ—Ü–µ—Å—ñ ‚Äî –æ–¥—Ä–∞–∑—É —Ä–µ–∞–≥—É—î–º–æ
      try {
        window.__roleUnsub?.();
        window.__roleUnsub = db.collection('users').doc(u.uid).onSnapshot((ds) => {
          const r = ds.exists ? (ds.data().role || 'pending') : 'pending';
          window.__userRole = r;
          setRoleBadge(r);
          if (r === 'pending' || !['admin','logist','user','security'].includes(r)) {
  alert('–î–æ—Å—Ç—É–ø –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–æ –∞–±–æ —Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤—Ö—ñ–¥.');
  location.replace(loginURL);
}
        });
      } catch (_) {}

      // –≤—Å–µ –¥–æ–±—Ä–µ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ DOM
      document.documentElement.style.visibility = '';
    } catch (e) {
      console.error('Role check failed:', e);
      location.replace(loginURL);
    }
  });
})();
</script>
</head>
<body>
<header class="top">
  <nav style="display:flex;gap:16px;align-items:center;">
    <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <a href="/import/">üì• –Ü–º–ø–æ—Ä—Ç</a>
  </nav>
  <div class="authbar">
    <span id="authInfo">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</span>
    <span id="authRole" class="role-badge" style="display:none;"></span>
    <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
    <span id="status" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
  </div>
</header>

  <div class="wrap">
    <div class="topbar header-grid">
  <h1 class="page-title">–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤<br>(Firestore ‚Üí Excel)</h1>

  <div class="header-actions">
    <a class="btn" href="/index.html">‚Üê –î–æ –∫–∞—Ä—Ç–∏</a>
    <button id="btnToggleFilters" class="btn coltoggle">‚ò∞ –§—ñ–ª—å—Ç—Ä–∏</button>
    <button id="btnToggleSidebar" class="btn coltoggle">‚ò∞ –ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ</button>
  </div>
</div>

<div class="layout">
  <aside id="columnPicker" class="colpicker"></aside>

  <div class="main">
    <div class="card filters-card" style="margin-bottom:12px;">
      <div id="filtersArea">
        <div class="row cols-2">
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –í—ñ–¥</label>
            <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
          </div>
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –î–æ</label>
            <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
          </div>
        </div>

        <div class="row cols-2" style="margin-top:12px;">
          <div>
            <label>–¢–∏–ø</label>
            <select id="routeType">
              <option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option>
              <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
              <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
              <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
            </select>
          </div>
          <div>
            <label>–û–Ω–æ–≤–ª–µ–Ω–æ: –∑ ‚Üí –ø–æ</label>
            <div class="row dates">
              <input id="dateFrom" type="date">
              <input id="dateTo" type="date">
            </div>
          </div>
        </div>

        <div class="row cols-4" style="margin-top:12px;">
          <div>
            <label>–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (—É –í—ñ–¥ –∞–±–æ –î–æ)</label>
            <select id="unitFilter"><option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option></select>
          </div>
          <div>
            <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –≤—ñ–¥</label>
            <input id="distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
          </div>
          <div>
            <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –¥–æ</label>
            <input id="distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
          </div>
          <div>
            <label>–õ–æ–≥—ñ—Å—Ç</label>
            <input id="logistFilter" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="logistsList" autocomplete="off">
            <datalist id="logistsList"></datalist>
            <div id="logistsMsg" class="warn" style="display:none;margin-top:4px"></div>
          </div>
        </div>

        <div class="bar" style="margin-top:12px;">
          <button id="btnPreview" class="btn" disabled>üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
          <button id="btnExport" class="btn primary" disabled>üì• –ï–∫—Å–ø–æ—Ä—Ç —É Excel</button>
          <button id="btnRefresh" class="btn" disabled>üîÑ –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É</button>
          <button id="btnExportJson" class="btn">JSON (–≤–∏–¥–∏–º—ñ)</button>
          <button id="btnExportJsonAll" class="btn ghost" title="–î–æ–≤–∞–Ω—Ç–∞–∂–∏—Ç—å —É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —ñ –∑–±–µ—Ä–µ–∂–µ –≤ JSON">JSON (—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏)</button>
          <span class="muted">–ü–æ—Ä–æ–∂–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ = –Ω–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏. –Ø–∫—â–æ Firestore –ø–æ–ø—Ä–æ—Å–∏—Ç—å —ñ–Ω–¥–µ–∫—Å ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å, –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —ñ–∑ –∫–æ–Ω—Å–æ–ª—ñ.</span>
        </div>

        <datalist id="directoryList"></datalist>
      </div>
    </div>

   <div class="card results-card">
      <div class="bar" style="justify-content:space-between; margin-bottom:8px;">
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</strong>
        <span class="muted" id="countInfo">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª</span>
      </div>

      <div class="stats" id="statsInfo" style="display:none; margin-bottom:8px;">
        <div class="chip" id="statMax">–ù–∞–π–±—ñ–ª—å—à–∞: ‚Äî</div>
        <div class="chip" id="statMin">–ù–∞–π–º–µ–Ω—à–∞: ‚Äî</div>
        <div class="chip" id="statAvg">–°–µ—Ä–µ–¥–Ω—è: ‚Äî</div>
      </div>

      <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è / –¥—ñ—ó -->
      <div class="bar" id="moreBox" style="gap:6px; display:none; margin:6px 0 10px;">
        <button id="btnMore" class="btn sm">+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–µ</button>
        <button id="btnAll" class="btn sm">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å–µ</button>
        <button id="btnClearFilters" class="btn sm">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ñ</button>
        <button id="btnAutosize" class="btn sm">‚ÜîÔ∏è –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫</button>
      </div>
<!-- –õ–∏–ø–∫–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª -->
<div id="xScroller"><div></div></div>

      <div class="table-wrap">
        <table id="resTable">
          <colgroup>
            <!-- 16 –∫–æ–ª–æ–Ω–æ–∫ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –Ω–æ–≤–∏—Ö ¬´–°—Ç–∞—Ç—É—Å¬ª —ñ ¬´–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è¬ª -->
			<col class="col-hub">
            <col class="col-code"><col class="col-code">
            <col><col><col class="col-via">  <!-- –í—ñ–¥, –î–æ, –ü—Ä–æ–º—ñ–∂–Ω—ñ -->
            <col><col><col>                  <!-- –í—ñ–¥—Å—Ç–∞–Ω—å, –¢–∏–ø, –õ–æ–≥—ñ—Å—Ç -->
            <col class="col-status"><col class="col-comment"> <!-- –°—Ç–∞—Ç—É—Å, –ü—Ä–∏—á–∏–Ω–∞ -->
            <col>             <!-- –û–Ω–æ–≤–ª–µ–Ω–æ -->
            <col class="col-key"> <!-- –ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É -->
            <col class="col-id">  <!-- ID -->
            <col>                 <!-- –ö–∞—Ä—Ç–∞ -->
            <col>                 <!-- –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è -->
            <col>                 <!-- –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä -->
            <col>                 <!-- JSON -->

          </colgroup>
<thead>
  <!-- –†—è–¥–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
  <tr>
    <th class="sortable" data-sort="hub"           data-colkey="hub">–•–ê–ë <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="fromCode"      data-colkey="fromCode">–ö–æ–¥ –í—ñ–¥ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="toCode"        data-colkey="toCode">–ö–æ–¥ –î–æ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="fromName"      data-colkey="fromName">–í—ñ–¥ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="toName"        data-colkey="toName">–î–æ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="viaNames"      data-colkey="via">–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="distance_km"   data-colkey="distance">–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="type"          data-colkey="type">–¢–∏–ø <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="logisticName"  data-colkey="logist">–õ–æ–≥—ñ—Å—Ç <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="statusLabel"   data-colkey="status">–°—Ç–∞—Ç—É—Å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="rejectComment" data-colkey="comment">–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="updatedAtRaw"  data-colkey="updated">–û–Ω–æ–≤–ª–µ–Ω–æ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="routeKey"      data-colkey="routeKey">–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="id"            data-colkey="id">ID <span class="s">‚Üï</span></th>
    <th data-colkey="map">–ö–∞—Ä—Ç–∞</th>
    <th data-colkey="review">–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è</th>
    <th data-colkey="navigator">–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä</th>
    <th data-colkey="json">JSON</th>
  </tr>

  <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–±–µ–∑ –∑–º—ñ–Ω –ø–æ —Å—É—Ç—ñ) -->
  <tr class="filters">
    <th><input id="f_hub" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
    <th><input id="f_fromCode" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
    <th><input id="f_toCode" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
    <th><input id="f_fromName" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="directoryList"></th>
    <th><input id="f_toName" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="directoryList"></th>
    <th><input id="f_via" type="text" placeholder="–ø—Ä–æ–º—ñ–∂–Ω—ñ‚Ä¶"></th>
    <th>
      <div class="range">
        <input id="f_distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
        <input id="f_distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
      </div>
    </th>
    <th>
      <select id="f_type">
        <option value=""></option>
        <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
      </select>
    </th>
    <th><input id="f_logist" type="text" placeholder="–ª–æ–≥—ñ—Å—Ç‚Ä¶" list="logistsList"></th>
    <th>
      <select id="f_status">
        <option value=""></option>
        <option>–ü–æ–≥–æ–¥–∂–µ–Ω–æ</option>
        <option>–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</option>
        <option>–û—á—ñ–∫—É—î</option>
      </select>
    </th>
    <th><input id="f_comment" type="text" placeholder="–∫–æ–º–µ–Ω—Ç–∞—Ä‚Ä¶"></th>
    <th>
      <div class="range">
        <input id="f_dateFrom" type="date">
        <input id="f_dateTo" type="date">
      </div>
    </th>
    <th><input id="f_routeKey" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
    <th><input id="f_id" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶"></th>
    <th></th>  <!-- –¥–ª—è "–ö–∞—Ä—Ç–∞" -->
    <th></th>  <!-- –¥–ª—è "–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è" -->
    <th></th>  <!-- –¥–ª—è "–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä" -->
    <th></th>  <!-- –¥–ª—è "JSON" -->

  </tr>
</thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* === –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ === */
const MAP_URL = '/index.html';
const NAVIGATE_PAGE = '/navigate.html';
const DEFAULT_PROFILE = 'driving';
const REVIEW_PAGE = '/review.html';

/* --- –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä --- */
window.addEventListener('error', (e) => {
  console.error('Global error:', e.message, 'at', e.filename, e.lineno);
  try { document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞'; } catch(_) {}
});

const statusEl = document.getElementById('status');
let db = null, auth = null;
let currentUser = null;
let currentRole = null;

try {
  // –î–æ–¥–∞—Ç–æ–∫ —É–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ guard-—Å–∫—Ä–∏–ø—Ç–æ–º –≤–∏—â–µ
  const app = firebase.app();
  db = firebase.firestore();
  auth = firebase.auth();

  statusEl.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
  // –æ—Ñ–ª–∞–π–Ω-–∫–µ—à
  db.enablePersistence({ synchronizeTabs: true }).catch((e) => {
    console.warn('Persistence off:', e.code || e.message);
  });
} catch (e) {
  console.error('Init error:', e);
  statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
}

/* ---------- Auth UI ---------- */
const authInfo = document.getElementById('authInfo');
const authRoleBadge = document.getElementById('authRole');
const btnLogout = document.getElementById('btnLogout');
const btnPreview = document.getElementById('btnPreview');
const btnExport  = document.getElementById('btnExport');
const btnRefresh = document.getElementById('btnRefresh');
const btnMore    = document.getElementById('btnMore');
const btnAll     = document.getElementById('btnAll');
const btnClearFilters = document.getElementById('btnClearFilters');
const btnAutosize = document.getElementById('btnAutosize');
const btnExportJson     = document.getElementById('btnExportJson');
const btnExportJsonAll  = document.getElementById('btnExportJsonAll');

function setBusy(b){
  btnPreview.disabled = b || !currentUser;
  btnExport.disabled  = b || !currentUser;
  btnRefresh.disabled = b || !currentUser;
  btnExportJson.disabled    = b || !currentUser;
btnExportJsonAll.disabled = b || !currentUser;
  if (btnMore) btnMore.disabled = b;
  if (btnAll)  btnAll.disabled  = b;
  if (btnClearFilters) btnClearFilters.disabled = b;
  if (btnAutosize) btnAutosize.disabled = b;
  statusEl.textContent = b ? '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è‚Ä¶' : (currentUser ? '–ì–æ—Ç–æ–≤–æ' : '–£–≤—ñ–π–¥—ñ—Ç—å');
}

btnLogout.addEventListener('click', async () => { try{ await auth.signOut(); }catch(e){ console.warn(e); } });

auth?.onAuthStateChanged(async (u) => {
  currentUser = u || null;
  if (!u){
    const next = encodeURIComponent(location.pathname + location.search);
    location.replace(`/login.html?next=${next}`);
    return;
  }

  // —Ä–æ–ª—å —É–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤ –≤–µ—Ä—Ö–Ω—ñ–π AUTH GUARD
  currentRole = window.__userRole || 'pending';

  authInfo.textContent = `–£–≤—ñ–π—à–ª–∏ —è–∫ ${u.email || u.uid}`;
  btnLogout.style.display = '';
  authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`;
  authRoleBadge.style.display = '';
  setBusy(false);
  
  // ‚¨á‚¨á‚¨á –í–°–¢–ê–í –°–Æ–î–ò ‚¨á‚¨á‚¨á
  const syncRoleAndRerender = () => {
    const r = String(window.__userRole || '').toLowerCase();
    if (r && r !== currentRole) {
      currentRole = r;
      // –æ–Ω–æ–≤–ª—é—î–º–æ –±–µ–π–¥–∂ —ñ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é (—â–æ–± –∑‚Äô—è–≤–∏–≤—Å—è –ª—ñ–Ω–∫ ‚Äú–ü–æ–≥–æ–¥–∏—Ç–∏‚Äù)
      try { authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`; reRender(); } catch(_) {}
    }
  };
  syncRoleAndRerender();
  setTimeout(syncRoleAndRerender, 100); // —è–∫—â–æ guard –¥–æ–ø–∏—à–µ —Ä–æ–ª—å —ñ–∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é
  // ‚¨Ü‚¨Ü‚¨Ü –í–°–¢–ê–í –°–Æ–î–ò ‚¨Ü‚¨Ü‚¨Ü

  try { await Promise.all([loadDirectory(), loadLogists(true)]); }
  catch (e) { console.warn(e); }
});

/* ---------- –î–æ–≤—ñ–¥–Ω–∏–∫ ---------- */
const dirByCode = {}, codeByName = {}; const unitsSet = new Set();
const DIR_CACHE_KEY = 'export.directoryCache.v1';
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  const unitSelect = document.getElementById('unitFilter');
  list.innerHTML = '';
  unitSelect.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
  unitsSet.clear();
  Object.keys(dirByCode).forEach(k=>delete dirByCode[k]);
  Object.keys(codeByName).forEach(k=>delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if(!(name in codeByName)) codeByName[name]=code;
    if (unit) unitsSet.add(unit);
    const opt = document.createElement('option');
    opt.value = name; opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
  Array.from(unitsSet).sort((a,b)=>a.localeCompare(b,'uk')).forEach(u=>{
    const o=document.createElement('option'); o.value=u; o.textContent=u; unitSelect.appendChild(o);
  });
}

async function loadDirectory(forceServer){
  if (!db || !currentUser) return;
  try{
    if (!forceServer){
      const raw = localStorage.getItem(DIR_CACHE_KEY);
      if (raw){
        const { ts, rows } = JSON.parse(raw);
        if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){ fillDirectoryUI(rows); return; }
      }
    }
  }catch{}
  let snap = null;
  try {
    snap = await db.collection('directory').get({ source: forceServer ? 'server' : 'cache' });
  } catch {}
  if (!snap || snap.empty) { snap = await db.collection('directory').get({ source: 'default' }); }
  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    rows.push({ code: doc.id, name: d.name || doc.id, company: d.company || '', unit: d.unit || '' });
  });
  fillDirectoryUI(rows);
  try{ localStorage.setItem(DIR_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
}

/* ---------- –õ–æ–≥—ñ—Å—Ç–∏ ---------- */
const logistById = {}, logistIdByName = {};
const LOGISTS_CACHE_KEY = 'export.logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;
const _norm = s => String(s||'').trim().toLowerCase();

function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  for (const k in logistById) delete logistById[k];
  for (const k in logistIdByName) delete logistIdByName[k];
  rows.forEach(r=>{ logistById[r.id]=r; logistIdByName[r.name]=r.id;
    const opt=document.createElement('option'); opt.value=r.name; list.appendChild(opt);
  });
}

async function loadLogists(allowServer){
  const msg = document.getElementById('logistsMsg');
  const show = t => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };
  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if (raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){ fillLogistsUI(rows); show(''); return; }
    }
    if (!allowServer){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'server' }); }
    catch(e){
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
      throw e;
    }
    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });
    rows = rows.filter(r=>r.active).sort((a,b)=>(a.sort-b.sort)||a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    show('');
  }catch(e){ console.error('logists load error:', e); show('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); }
}

function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if (!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const cand = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (cand.length === 1) return cand[0][1];
  return null;
}

/* ---------- –•–µ–ª–ø–µ—Ä–∏ ---------- */
function getCodeByNameInput(id){ const name=(document.getElementById(id).value||'').trim(); return codeByName[name] || ''; }
function nameByCode(code){ return (dirByCode[code]?.name)||''; }
function unitByCode(code){ return (dirByCode[code]?.unit)||''; }
function dayStartISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString(); }
function dayEndISO(d){ const x=new Date(d); x.setHours(23,59,59,999); return x.toISOString(); }
function formatDate(dt){ if (!dt) return ''; const d=new Date(dt); if (isNaN(d)) return ''; const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
function normalizeForJson(val){
  if (val === undefined || val === null) return null;

  // Firestore —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Ç–∏–ø–∏
  if (val instanceof firebase.firestore.Timestamp) return val.toDate().toISOString();
  if (val instanceof firebase.firestore.GeoPoint)  return { lat: val.latitude, lng: val.longitude };
  // DocumentReference ‚Üí —à–ª—è—Ö
  if (val && typeof val === 'object' && typeof val.path === 'string' && val.parent) return val.path;

  if (Array.isArray(val)) return val.map(normalizeForJson);
  if (typeof val === 'object'){
    const out = {}; for (const [k,v] of Object.entries(val)) out[k] = normalizeForJson(v); return out;
  }
  return val;
}

function downloadJson(objOrArray, filename){
  const blob = new Blob([JSON.stringify(objOrArray, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 5000);
}

/* ===== –í–µ—Ä—Ö–Ω—ñ–π –ª–∏–ø–∫–∏–π —Å–∫—Ä–æ–ª: —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ .table-wrap ===== */
let _xScroller = null, _xInner = null, _xBound = false, _xRO = null;

function ensureXScroller(){
  _xScroller = document.getElementById('xScroller');
  if (!_xScroller){
    const card = document.querySelector('.results-card');
    if (!card) return;
    const s = document.createElement('div'); s.id = 'xScroller';
    const i = document.createElement('div'); s.appendChild(i);
    card.insertBefore(s, card.querySelector('.table-wrap'));
    _xScroller = s; _xInner = i;
  } else {
    _xInner = _xScroller.firstElementChild;
  }
}

function syncXWidth(){
  ensureXScroller();
  const table = document.getElementById('resTable');
  const wrap  = document.querySelector('.table-wrap');
  if (!_xScroller || !_xInner || !table || !wrap) return;
  _xInner.style.width = table.scrollWidth + 'px';
  _xScroller.scrollLeft = wrap.scrollLeft;
}

function bindXSync(){
  ensureXScroller();
  const wrap = document.querySelector('.table-wrap');
  if (!wrap || !_xScroller || _xBound) return;

  let lock = false;
  wrap.addEventListener('scroll', () => {
    if (lock) return; lock = true;
    _xScroller.scrollLeft = wrap.scrollLeft;
    lock = false;
  }, { passive:true });

  _xScroller.addEventListener('scroll', () => {
    if (lock) return; lock = true;
    wrap.scrollLeft = _xScroller.scrollLeft;
    lock = false;
  }, { passive:true });

  // —Å—Ç–µ–∂–∏–º–æ –∑–∞ –∑–º—ñ–Ω–æ—é —à–∏—Ä–∏–Ω–∏ —Ç–∞–±–ª–∏—Ü—ñ
  try {
    _xRO?.disconnect();
    _xRO = new ResizeObserver(syncXWidth);
    _xRO.observe(document.getElementById('resTable'));
  } catch(_) {}

  window.addEventListener('resize', debounce(syncXWidth, 120));
  _xBound = true;
}

const toNum = v => (v==='' || v==null) ? NaN : Number(v);

/* --- –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–æ—á–æ–∫ --- */
function toLonLat(p){
  if (Array.isArray(p) && p.length>=2){ const a=Number(p[0]); const b=Number(p[1]); return (Math.abs(a)<=90 && Math.abs(b)<=180)?[b,a]:[a,b]; }
  if (typeof p==='string'){ const parts=p.split(/[;, ]+/).map(Number).filter(v=>!Number.isNaN(v)); if (parts.length>=2) return toLonLat(parts); }
  if (p && typeof p==='object'){ const lat=Number(p.lat ?? p.latitude ?? p.Lat ?? p.Latitude); const lon=Number(p.lon ?? p.lng ?? p.longitude ?? p.Lon ?? p.Lng ?? p.Longitude); if (!Number.isNaN(lat)&&!Number.isNaN(lon)) return [lon,lat]; }
  return null;
}
function normalizePoints(raw){
  if (!raw) return null;
  if (raw.type==='Feature' && raw.geometry?.type==='LineString') return normalizePoints(raw.geometry.coordinates);
  if (raw.geometry?.type==='LineString' && Array.isArray(raw.geometry.coordinates)) return normalizePoints(raw.geometry.coordinates);
  if (raw.type==='FeatureCollection' && Array.isArray(raw.features)){ const f=raw.features.find(f=>f.geometry?.type==='LineString'); if (f) return normalizePoints(f.geometry.coordinates); }
  if (Array.isArray(raw)){ const out=[]; for (const item of raw){ const pt=toLonLat(item); if (pt && Number.isFinite(pt[0]) && Number.isFinite(pt[1])) out.push(pt); } return out.length?out:null; }
  return null;
}
  /* ===== ZIP helpers ===== */
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 5000);
}

// –ë–µ–∑–ø–µ—á–Ω—ñ —ñ –∫–æ—Ä–æ—Ç–∫—ñ —ñ–º–µ–Ω–∞ —Ñ–∞–π–ª—ñ–≤
function safeName(s, max = 120){
  return String(s || '')
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '_')
    .replace(/\s+/g, ' ')
    .trim()
    .slice(0, max);
}

/* 
 * –ï–∫—Å–ø–æ—Ä—Ç: –∫–æ–∂–µ–Ω –º–∞—Ä—à—Ä—É—Ç –æ–∫—Ä–µ–º–∏–º JSON —É ZIP
 * rows ‚Äî —Ç—ñ —Å–∞–º—ñ —Ä—è–¥–∫–∏, —è–∫—ñ —Ç–∏ –≤—ñ–¥–¥–∞–≤–∞–≤ —É exportJsonFromRows
 */
async function exportJsonZipFromRows(rows){
  if (!rows || !rows.length){
    alert('–ù–µ–º–∞—î —Ä—è–¥–∫—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.');
    return;
  }

  const zip = new JSZip();
  const folder = zip.folder('routes');

  // —ñ–Ω–¥–µ–∫—Å: –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–∫–ª–∞–¥—É –∞—Ä—Ö—ñ–≤—É
  const index = [];

  // –ù–∞–∑–≤–∞ –∞—Ä—Ö—ñ–≤—É
  const ts = new Date();
  const pad = n => String(n).padStart(2,'0');
  const zipName = `routes_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.zip`;

  // –ù–∞–ø–æ–≤–Ω—é—î–º–æ ZIP —Ñ–∞–π–ª–∞–º–∏
  let i = 0;
  for (const r of rows){
    const raw = r.raw || {};
    const jsonObj = Object.assign({ id: r.id }, normalizeForJson(raw));
    const pretty = `${r.fromName || ''} ‚Üí ${r.toName || ''}`.trim();
    const base =
      safeName(
        `route_${r.routeKey ? r.routeKey + '_' : ''}${r.id || ''}_${pretty || ''}`
      ) || `route_${i+1}`;

    folder.file(`${base}.json`, JSON.stringify(jsonObj, null, 2));
    index.push({
      id: r.id,
      routeKey: r.routeKey || null,
      name: pretty || null,
      updatedAt: r.updatedAtRaw || null,
      distance_km: Number.isFinite(r.distance_km) ? r.distance_km : null
    });

    // —â–æ–± –Ω–µ "–∑–∞–º–æ—Ä–æ–∂—É–≤–∞—Ç–∏" UI –Ω–∞ –¥—É–∂–µ –≤–µ–ª–∏–∫–∏—Ö –≤–∏–±—ñ—Ä–∫–∞—Ö
    if (++i % 200 === 0) await new Promise(requestAnimationFrame);
  }

  // –¥–æ–∫–ª–∞–¥–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å
  zip.file('index.json', JSON.stringify(index, null, 2));

  // –ì–µ–Ω–µ—Ä—É—î–º–æ –∞—Ä—Ö—ñ–≤ –∑ –∫–æ–º–ø—Ä–µ—Å—ñ—î—é
  const blob = await zip.generateAsync(
    { type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } },
    (meta) => { try { statusEl.textContent = `–ê—Ä—Ö—ñ–≤—É—î—Ç—å—Å—è‚Ä¶ ${meta.percent.toFixed(1)}%`; } catch(_) {} }
  );

  downloadBlob(blob, zipName);
  try { statusEl.textContent = '–ì–æ—Ç–æ–≤–æ'; } catch(_) {}
}

/* === UTF-8 Base64 === */
function b64encodeUtf8(objOrString){
  const s = typeof objOrString === 'string' ? objOrString : JSON.stringify(objOrString);
  const bytes = new TextEncoder().encode(s); let bin='';
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]); return btoa(bin);
}

/* –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
const round6 = n => Math.round(n * 1e6) / 1e6;
const roundCoords = arr => (arr || []).map(([lng,lat]) => [round6(lng), round6(lat)]);

/* –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–º–∞–ª—å–æ–≤–∞–Ω–∏—Ö —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ */
function normalizeSegments(source){
  const segments=[];
  function pushLine(arr){ if (!Array.isArray(arr)) return; const pts=arr.map(toLonLat).filter(Boolean); if (pts.length>=2) segments.push(pts); }
  function scan(val){
    if (!val) return;
    if (val.type==='FeatureCollection' && Array.isArray(val.features)){ val.features.forEach(f=>{ if (f?.geometry?.type==='LineString') pushLine(f.geometry.coordinates); if (f?.geometry?.type==='MultiLineString') (f.geometry.coordinates||[]).forEach(pushLine); }); return; }
    if (val.type==='Feature' && val.geometry) return scan(val.geometry);
    if (val.type==='LineString' && Array.isArray(val.coordinates)) return pushLine(val.coordinates);
    if (val.type==='MultiLineString' && Array.isArray(val.coordinates)) return val.coordinates.forEach(pushLine);
    if (Array.isArray(val)){ if (val.length && Array.isArray(val[0])) return pushLine(val); if (val.length && typeof val[0]==='object'){ const pts=val.map(toLonLat).filter(Boolean); if (pts.length>=2) return segments.push(pts); val.forEach(scan); return; } if (val.length && typeof val[0]==='string') return pushLine(val); }
    if (typeof val==='object'){ for (const [k,v] of Object.entries(val)){ if (/(ruler|manual|line|path|segment|polyline|draw)/i.test(k)) scan(v); } }
  }
  scan(source); return segments;
}

/* ---------- –í–∏—Ç—è–≥ ¬´–ü—Ä–æ–º—ñ–∂–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤¬ª ---------- */
function extractViaList(d){
  const acc = [];
  const seen = new Set();
  const push = (s) => {
    const t = String(s || '').trim();
    if (!t) return;
    const key = t.toLowerCase();
    if (!seen.has(key)) { seen.add(key); acc.push(t); }
  };
  const mapCode = (code) => nameByCode(code) || String(code || '').trim();

  const splitNames = s => String(s || '')
    .split(/[\|,;]|[‚Äì‚Äî-]|‚Üí/g)
    .map(x => x.trim())
    .filter(Boolean);

  ['intermediateText','viaNames','midNames','waypointNames','stopsNames'].forEach(k => {
    const v = d[k];
    if (Array.isArray(v)) v.forEach(push);
    else if (typeof v === 'string') splitNames(v).forEach(push);
  });

  ['intermediateCodes','viaCodes','midCodes','waypointCodes','stopsCodes'].forEach(k => {
    const v = d[k];
    if (Array.isArray(v)) v.forEach(c => push(mapCode(c)));
    else if (typeof v === 'string') splitNames(v).forEach(c => push(mapCode(c)));
  });

  ['intermediate','intermediates','via','vias','mid','mids','waypoints','midpoints','stops'].forEach(k => {
    const v = d[k];
    if (Array.isArray(v)) {
      for (const it of v) {
        if (typeof it === 'string') { splitNames(it).forEach(x => push(mapCode(x))); continue; }
        if (Array.isArray(it)) { const p = toLonLat(it); if (p) push(`${p[1].toFixed(6)}, ${p[0].toFixed(6)}`); continue; }
        if (it && typeof it === 'object') {
          if (it.name || it.label || it.title) { push(it.name || it.label || it.title); continue; }
          if (it.code) { push(mapCode(it.code)); continue; }
          const p = toLonLat(it); if (p) push(`${p[1].toFixed(6)}, ${p[0].toFixed(6)}`);
        }
      }
    } else if (typeof v === 'string') {
      splitNames(v).forEach(x => push(mapCode(x)));
    }
  });

  if (!acc.length) {
    const label = d.name || d.fromLabel || '';
    const parts = splitNames(label);
    if (parts.length >= 3) parts.slice(1, -1).forEach(push);
  }

  return acc;
}

/* ---------- –ü–ê–ì–Ü–ù–ê–¶–Ü–Ø / –°–¢–ê–ù ---------- */
const PAGE_SIZE = 1000;
let _baseQuery = null;
let _cursor = null;
let _hasMore = false;
let allRows = [];
let FORCE_SERVER = false;

/* ---------- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è ---------- */
const sortState = { key: 'updatedAtRaw', dir: -1 };

/* ---------- –ú–∞–ø—ñ–Ω–≥ —Å—Ç–∞—Ç—É—Å—ñ–≤ ---------- */
function toStatusLabel(v){
  const s = (typeof v === 'string') ? v.trim().toLowerCase() : v;

  const YES = new Set([
    'approved','approve','ok','okay','okey','allow','allowed',
    'accept','accepted','yes','true','y','done','success','passed'
  ]);
  const NO = new Set([
    'rejected','reject','denied','deny','declined','no','false',
    'not_approved','disallow','blocked','failed'
  ]);

  if (s === true || s === 1 || YES.has(s)) return '–ü–æ–≥–æ–¥–∂–µ–Ω–æ';
  if (s === false || s === 0 || NO.has(s))  return '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';

  if (typeof s === 'string' && [
    'pending','in_review','inreview','review','waiting','wait','on_approval','submitted'
  ].includes(s)) return '–û—á—ñ–∫—É—î';

  // –Ø–∫—â–æ –ø—Ä–∏–ª–µ—Ç—ñ–ª–æ –≤–∂–µ –≥–æ—Ç–æ–≤–µ —É–∫—Ä–∞—ó–Ω–æ–º–æ–≤–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —è–∫ —î
  return (typeof v === 'string') ? v : '';
}

function computeApprovalStatus(d){
  if (!d || typeof d !== 'object') return null;

  // 1) –ù–∞–π—Ç–∏–ø–æ–≤—ñ—à–µ: –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ d.approval
  const A = (d.approval && typeof d.approval === 'object') ? d.approval : null;
  if (A){
    if (A.status     !== undefined && A.status     !== null) return A.status;     // 'approved' | 'rejected' | 'pending' | ...
    if (A.approved   !== undefined && A.approved   !== null) return A.approved;   // true/false
    if (A.result     !== undefined && A.result     !== null) return A.result;     // 'approved' | 'rejected'
    if (A.decision   !== undefined && A.decision   !== null) return A.decision;   // 'approve' | 'reject'
    if (A.approvedAt) return true;                                                // —Å–∞–º —Ñ–∞–∫—Ç –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –º—ñ—Ç–∫–∏ —á–∞—Å—É
    if (A.updatedAt && (A.approvedBy || A.approver)) return true;                 // –µ–≤—Ä–∏—Å—Ç–∏–∫–∞
  }

  // 2) –ü–æ—à–∏—Ä–µ–Ω—ñ –ø–æ–ª—è –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ
  if (d.approvalStatus !== undefined && d.approvalStatus !== null) return d.approvalStatus;
  if (d.status         !== undefined && d.status         !== null) return d.status;
  if (d.state          !== undefined && d.state          !== null) return d.state;
  if (d.approved       !== undefined && d.approved       !== null) return d.approved;  // true/false
  if (d.approvedAt) return true;                                                       // —Ç–æ–ø-—Ä—ñ–≤–µ–Ω—å
  if (d.decision)  return d.decision;

  return null;
}

/* ---------- –ü–æ–±—É–¥–æ–≤–∞ –∑–∞–ø–∏—Ç—É ---------- */
function buildBaseQuery(){
  if (!db || !currentUser) throw new Error('–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏');
  let q = db.collection('routes');

  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value;
  const df       = document.getElementById('dateFrom')?.value;
  const dt       = document.getElementById('dateTo')?.value;
  const logistId = getLogistIdByInput('logistFilter');

  if (fromCode) q = q.where('fromCode','==',fromCode);
  if (toCode)   q = q.where('toCode','==',toCode);
  if (type)     q = q.where('routeType','==',type);
  if (logistId) q = q.where('logisticId','==',logistId);

  q = q.orderBy('updatedAt','desc');
  if (df) q = q.where('updatedAt','>=', dayStartISO(df));
  if (dt) q = q.where('updatedAt','<=', dayEndISO(dt));

  return q;
}

function parseSnap(snap){
  const rows=[];
  snap.forEach(doc=>{
    const d=doc.data()||{};
    const viaArr = extractViaList(d);

   const statusValue = computeApprovalStatus(d);
const statusLabel = toStatusLabel(statusValue);

    const rejectComment =
      (d?.approval && 'comment' in d.approval ? (d.approval.comment || '') : '') ||
      (typeof d.comment === 'string' ? d.comment : '');

    rows.push({
      id: doc.id,
      routeKey: d.routeKey || '',
	  hub: d.hub || '',
      fromCode: d.fromCode||'',
      toCode: d.toCode||'',
      fromName: nameByCode(d.fromCode)||'',
      toName: nameByCode(d.toCode)||'',
      fromUnit: unitByCode(d.fromCode)||'',
      toUnit: unitByCode(d.toCode)||'',
      viaNames: viaArr.join(' ‚Ä¢ '),
      distance_km: (typeof d.distance_km==='number')? d.distance_km : NaN,
      type: d.routeType||'',
      logisticName: d.logisticName || '',
      logisticId: d.logisticId || '',
      statusRaw: statusValue, statusLabel, rejectComment,
      updatedAtRaw: d.updatedAt || null,
	  updatedAt: formatDate(d.updatedAt),
	  raw: d
    });
  });
  const lastDoc = snap.docs[snap.docs.length-1] || null;
  return { rows, lastDoc };
}

async function loadFirstPage(forceServer=false){
  FORCE_SERVER = !!forceServer;
  _baseQuery = buildBaseQuery();
  _cursor = null; _hasMore = false; allRows = [];
  let snap = null;
  try { snap = await _baseQuery.limit(PAGE_SIZE).get({source: FORCE_SERVER ? 'server' : 'default'}); }
  catch(e){
    console.warn('loadFirstPage fallback:', e?.message||e);
    try { snap = await _baseQuery.limit(PAGE_SIZE).get({source:'cache'}); } catch(_){}
  }
  if (!snap) return [];
  const { rows, lastDoc } = parseSnap(snap);
  allRows = rows;
  _cursor = lastDoc;
  _hasMore = !!lastDoc && snap.size === PAGE_SIZE;
  return rows;
}

async function loadNextPage(){
  if (!_baseQuery || !_cursor) return [];
  let snap = null;
  try { snap = await _baseQuery.startAfter(_cursor).limit(PAGE_SIZE).get({source: FORCE_SERVER ? 'server' : 'default'}); }
  catch(e){
    console.warn('loadNextPage fallback:', e?.message||e);
    try { snap = await _baseQuery.startAfter(_cursor).limit(PAGE_SIZE).get({source:'cache'}); } catch(_){}
  }
  if (!snap) return [];
  const { rows, lastDoc } = parseSnap(snap);
  _cursor = lastDoc;
  _hasMore = !!lastDoc && snap.size === PAGE_SIZE;
  allRows = allRows.concat(rows);
  return rows;
}

/* ---------- –§—ñ–ª—å—Ç—Ä–∏ (–≤–µ—Ä—Ö–Ω—ñ) ---------- */
function applyTopFilters(rows){
  const unit = document.getElementById('unitFilter')?.value.trim() || '';
  const dmin = parseFloat(document.getElementById('distMin')?.value);
  const dmax = parseFloat(document.getElementById('distMax')?.value);
  const logistText = (document.getElementById('logistFilter')?.value || '').trim();
  const logistId = getLogistIdByInput('logistFilter');

  return rows.filter(r=>{
    if (unit && !(r.fromUnit === unit || r.toUnit === unit)) return false;
    const dist = r.distance_km;
    if (!Number.isFinite(dist)) return false;
    if (!Number.isNaN(dmin) && isFinite(dmin) && dist < dmin) return false;
    if (!Number.isNaN(dmax) && isFinite(dmax) && dist > dmax) return false;
    if (logistText && !logistId) {
      const n = _norm(logistText);
      if (!_norm(r.logisticName).includes(n)) return false;
    }
    return true;
  });
}

/* ---------- –§—ñ–ª—å—Ç—Ä–∏ (—Ä—è–¥–æ–∫ —É —à–∞–ø—Ü—ñ —Ç–∞–±–ª–∏—Ü—ñ) ---------- */
function getTableFilterState(){
  return {
    hub: document.getElementById('f_hub').value.trim(),
    fromCode:  document.getElementById('f_fromCode').value.trim(),
    toCode:    document.getElementById('f_toCode').value.trim(),
    fromName:  document.getElementById('f_fromName').value.trim(),
    toName:    document.getElementById('f_toName').value.trim(),
    via:       document.getElementById('f_via').value.trim(),
    distMin:   toNum(document.getElementById('f_distMin').value),
    distMax:   toNum(document.getElementById('f_distMax').value),
    type:      document.getElementById('f_type').value,
    logist:    document.getElementById('f_logist').value.trim(),
    status:    document.getElementById('f_status').value.trim(),
    comment:   document.getElementById('f_comment').value.trim(),
    df:        document.getElementById('f_dateFrom').value,
    dt:        document.getElementById('f_dateTo').value,
    routeKey:  document.getElementById('f_routeKey').value.trim(),
    id:        document.getElementById('f_id').value.trim(),
  };
}

function applyTableFilters(rows){
  const f = getTableFilterState();
  const normInc = (val, needle) => _norm(String(val||'')).includes(_norm(needle||''));
  const df = f.df ? new Date(dayStartISO(f.df)) : null;
  const dt = f.dt ? new Date(dayEndISO(f.dt))   : null;

  return rows.filter(r=>{
    if (f.hub && !normInc(r.hub, f.hub)) return false;
    if (f.fromCode && !normInc(r.fromCode, f.fromCode)) return false;
    if (f.toCode   && !normInc(r.toCode,   f.toCode))   return false;
    if (f.fromName && !normInc(r.fromName, f.fromName)) return false;
    if (f.toName   && !normInc(r.toName,   f.toName))   return false;
    if (f.via      && !normInc(r.viaNames, f.via)) return false;
    const dist = r.distance_km;
    if (Number.isFinite(f.distMin) && dist < f.distMin) return false;
    if (Number.isFinite(f.distMax) && dist > f.distMax) return false;
    if (f.type && r.type !== f.type) return false;
    if (f.logist && !normInc(r.logisticName, f.logist)) return false;
    if (f.status && r.statusLabel !== f.status) return false;
    if (f.comment && !normInc(r.rejectComment, f.comment)) return false;
    if ((df || dt) && r.updatedAtRaw){
      const d = new Date(r.updatedAtRaw);
      if (df && d < df) return false;
      if (dt && d > dt) return false;
    }
    if (f.routeKey && !normInc(r.routeKey, f.routeKey)) return false;
    if (f.id && !normInc(r.id, f.id)) return false;
    return true;
  });
}

/* ---------- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è ---------- */
function compareRows(a,b,key){
  const dir = sortState.dir;
  const getStr = s => String(s||'').toLocaleLowerCase('uk');
  switch(key){
    case 'distance_km': {
      const av = Number.isFinite(a.distance_km) ? a.distance_km : -Infinity;
      const bv = Number.isFinite(b.distance_km) ? b.distance_km : -Infinity;
      return (av - bv) * dir;
    }
    case 'updatedAtRaw': {
      const av = a.updatedAtRaw ? new Date(a.updatedAtRaw).getTime() : 0;
      const bv = b.updatedAtRaw ? new Date(b.updatedAtRaw).getTime() : 0;
      return (av - bv) * dir;
    }
    default: {
      const av = getStr(a[key]);
      const bv = getStr(b[key]);
      const r = av.localeCompare(bv,'uk');
      return r * dir;
    }
  }
}

function sortRows(rows){
  if (!sortState.key) return rows;
  const arr = rows.slice();
  arr.sort((a,b)=>{
    const r = compareRows(a,b,sortState.key);
    if (r !== 0) return r;
    const av = a.updatedAtRaw ? new Date(a.updatedAtRaw).getTime() : 0;
    const bv = b.updatedAtRaw ? new Date(b.updatedAtRaw).getTime() : 0;
    return (bv - av);
  });
  return arr;
}

function updateSortIcons(){
  document.querySelectorAll('#resTable thead th.sortable').forEach(th=>{
    const k = th.getAttribute('data-sort');
    const s = th.querySelector('.s');
    th.classList.toggle('active', sortState.key === k);
    if (!s) return;
    if (sortState.key !== k){ s.textContent = '‚Üï'; return; }
    s.textContent = sortState.dir === 1 ? '‚ñ≤' : '‚ñº';
  });
}

/* ---------- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---------- */
function updateStats(rows){
  const statsBox = document.getElementById('statsInfo');
  if (!rows.length){ statsBox.style.display='none'; return; }
  const nums = rows.map(r=>r.distance_km).filter(Number.isFinite);
  if (!nums.length){ statsBox.style.display='none'; return; }
  const max = Math.max(...nums), min = Math.min(...nums), avg = nums.reduce((a,b)=>a+b,0)/nums.length;
  document.getElementById('statMax').textContent = `–ù–∞–π–±—ñ–ª—å—à–∞: ${max.toFixed(3)}`;
  document.getElementById('statMin').textContent = `–ù–∞–π–º–µ–Ω—à–∞: ${min.toFixed(3)}`;
  document.getElementById('statAvg').textContent = `–°–µ—Ä–µ–¥–Ω—è: ${avg.toFixed(3)}`;
  statsBox.style.display='';
}

/* ---------- –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä ---------- */
async function buildNavigatePayloadById(routeId, prettyName){
  const ref = db.collection('routes').doc(routeId);
  const doc = await ref.get();
  if (!doc.exists) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  const d = doc.data() || {};

  let points =
      normalizePoints(d.points) ||
      normalizePoints(d.coordinates) ||
      normalizePoints(d.route) ||
      normalizePoints(d.geojson) ||
      normalizePoints(d.geometry);

  if (!points) {
    const parts = [];
    if (d.start) { const p = toLonLat(d.start); if (p) parts.push(p); }
    if (Array.isArray(d.midpoints)) for (const m of d.midpoints){ const p=toLonLat(m); if (p) parts.push(p); }
    if (d.end) { const p = toLonLat(d.end); if (p) parts.push(p); }
    if (parts.length >= 2) points = parts;
  }
  if (!points || points.length < 2) throw new Error('–£ –º–∞—Ä—à—Ä—É—Ç—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –º–∞—Å–∏–≤ —Ç–æ—á–æ–∫');

  const manualSegments = normalizeSegments(d);
  return { name: prettyName || '–ú–∞—Ä—à—Ä—É—Ç', points: roundCoords(points), manualSegments: (manualSegments || []).map(roundCoords) };
}

function buildNavigateURLFromPayload(payloadObj){
  const base = `${location.origin}${NAVIGATE_PAGE}`;
  const q = new URLSearchParams();
  try { const json = JSON.stringify(payloadObj); const srcz = LZString.compressToEncodedURIComponent(json); q.set('srcz', srcz); } catch(e){ console.warn('Compression failed:', e); }
  try { q.set('src', b64encodeUtf8(payloadObj)); } catch(e){}
  return `${base}?${q.toString()}`;
}

function isMobileUA(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || ''); }
async function shareURL(url, title){
  if (isMobileUA() && navigator.share){ try { await navigator.share({ title: title || '–ú–∞—Ä—à—Ä—É—Ç', url }); return; } catch{} }
  try { await navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!'); }
  catch { prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤—Ä—É—á–Ω—É:', url); }
}

async function exportJsonFromRows(rows){
  // rows ‚Äî —Ü–µ —Ä—è–¥–∫–∏ —Ç–∞–±–ª–∏—Ü—ñ –∑ –ø–æ–ª–µ–º raw (–ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
  const data = rows.map(r => {
    const full = r.raw ? r.raw : {};        // –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
    const normalized = (full);
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å id —É –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Å—ñ
    return Object.assign({ id: r.id }, normalized);
  });

  const ts = new Date(); const pad = n=>String(n).padStart(2,'0');
  const fname = `routes_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
  downloadJson(data, fname);
}
/* ==== –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–¥–∏–º—ñ—Å—Ç—é –∫–æ–ª–æ–Ω–æ–∫ (—á–µ–∫–±–æ–∫—Å–∏ –ª—ñ–≤–æ—Ä—É—á) ==== */
const COLS_ORDER = [
  'hub','fromCode','toCode','fromName','toName','via','distance','type',
  'logist','status','comment','updated','routeKey','id','map','review','navigator','json'
];
const COL_LABEL = {
  hub:'–•–ê–ë', fromCode:'–ö–æ–¥ –í—ñ–¥', toCode:'–ö–æ–¥ –î–æ', fromName:'–í—ñ–¥', toName:'–î–æ',
  via:'–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏', distance:'–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º', type:'–¢–∏–ø', logist:'–õ–æ–≥—ñ—Å—Ç',
  status:'–°—Ç–∞—Ç—É—Å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è', comment:'–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è', updated:'–û–Ω–æ–≤–ª–µ–Ω–æ',
  routeKey:'–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É', id:'ID', map:'–ö–∞—Ä—Ç–∞', navigator:'–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä', json:'JSON', review:'–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è'
};
const COL_INDEX = Object.fromEntries(COLS_ORDER.map((k,i)=>[k,i+1]));
const DEFAULT_VISIBLE = new Set(['hub','fromName','toName','via','distance','type','status','map', 'review']);
const VCOL_KEY = 'export.visibleCols.v2';
const EXCEL_EXCLUDE = new Set(['map','navigator','json', 'review']); // —Ü—ñ –≤ Excel –Ω–µ –¥–æ–¥–∞—î–º–æ

// --- –†–æ–∑–ø–æ–¥—ñ–ª —à–∏—Ä–∏–Ω–∏ –≤–∏–¥–∏–º–∏—Ö –∫–æ–ª–æ–Ω–æ–∫, —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ "–ø—É—Å—Ç–µ–ª—é" –ø—Ä–∞–≤–æ—Ä—É—á ---
const COL_WEIGHTS = {
  via: 2.2, comment: 2.0, fromName: 1.3, toName: 1.3,
  hub: 1, fromCode: 1, toCode: 1, distance: 1, type: 1,
  logist: 1, status: 1, updated: 1, routeKey: 1, id: 1,
  map: 1, navigator: 1, json: 1
};

const COL_MIN_PX = {
  via: 280, comment: 240, fromName: 160, toName: 160,
  hub: 110, fromCode: 110, toCode: 110, distance: 120, type: 120,
  logist: 140, status: 140, updated: 160, routeKey: 160, id: 160,
  map: 120, navigator: 120, json: 120
};

/// –Ø–∫—â–æ –≤–∏–¥–∏–º–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –º–∞–ª–æ —ñ –≤–æ–Ω–∏ –≤–ª–∞–∑—è—Ç—å —É –≤—ñ–∫–Ω–æ ‚Äî —Ä–æ–∑—Ç—è–≥—É—î–º–æ –≤—ñ–¥—Å–æ—Ç–∫–∞–º–∏.
// –Ø–∫—â–æ —É –∫–æ–ª–æ–Ω–æ–∫ –≤–∂–µ –∑–∞–¥–∞–Ω—ñ —Ä—É—á–Ω—ñ —à–∏—Ä–∏–Ω–∏ (–ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è/–∞–≤—Ç–æ—à–∏—Ä–∏–Ω–∞) ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ —á—ñ–ø–∞—î–º–æ.
function fitTableToViewport() {
  const card  = document.querySelector('.results-card');
  const wrap  = card?.querySelector('.table-wrap');
  const table = document.getElementById('resTable');
  if (!wrap || !table) return;

  const cols = table.querySelectorAll('colgroup col');
  const visibleKeys = COLS_ORDER.filter(k => visibleCols.has(k));

  // —è–∫—â–æ —î —Ö–æ—á –æ–¥–Ω–∞ –∑–∞–¥–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ ‚Äî –ø–æ–≤–∞–∂–∞—î–º–æ —ó—ó —ñ –Ω–µ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î–º–æ
  const hasManual = Array.from(cols).some(c => c.style.width);
  if (hasManual){
    table.style.tableLayout = 'fixed';
    syncXWidth();
    return;
  }

  // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –≤–∏–¥–∏–º–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
  const needed = visibleKeys.reduce((s, k) => s + (COL_MIN_PX[k] || 140), 0) + 24;
  const avail  = wrap.clientWidth;

  // –æ—á–∏—â–∞—î–º–æ –ª–∏—à–µ —è–∫—â–æ –Ω–µ–º–∞—î —Ä—É—á–Ω–∏—Ö —à–∏—Ä–∏–Ω
  cols.forEach(c => (c.style.width = ''));

  if (needed <= avail) {
    // –í–º—ñ—â–∞—î—Ç—å—Å—è ‚Äî —Ä–æ–∑—Ç—è–≥—É—î–º–æ –≤—ñ–¥—Å–æ—Ç–∫–∞–º–∏ –∑ –≤–∞–≥–∞–º–∏
    table.style.tableLayout = 'fixed';
    const totalWeight = visibleKeys.reduce((s, k) => s + (COL_WEIGHTS[k] || 1), 0);
    visibleKeys.forEach(k => {
      const idx = COL_INDEX[k] - 1;
      if (!cols[idx]) return;
      const pct = ((COL_WEIGHTS[k] || 1) / totalWeight) * 100;
      cols[idx].style.width = pct.toFixed(4) + '%';
    });
  } else {
    // –ù–µ –≤–º—ñ—â–∞—î—Ç—å—Å—è ‚Äî ¬´–ø—Ä–∏—Ä–æ–¥–Ω–∞¬ª —à–∏—Ä–∏–Ω–∞ + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª
    table.style.tableLayout = 'auto';
  }

  syncXWidth();
}

let visibleCols = new Set();
function loadVisibleCols(){
  try{
    const raw = localStorage.getItem(VCOL_KEY);
    if (raw){
      const arr = JSON.parse(raw);
      const ok = (arr||[]).filter(k=>COLS_ORDER.includes(k));
      if (ok.length){ visibleCols = new Set(ok); return; }
    }
  }catch{}
  visibleCols = new Set(DEFAULT_VISIBLE);
}
function saveVisibleCols(){
  try{ localStorage.setItem(VCOL_KEY, JSON.stringify([...visibleCols])); }catch{}
}
function setColVisible(key, show){
  const idx = COL_INDEX[key];
  if (!idx) return;

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ñ—ñ–ª—å—Ç—Ä–∏ + —Ç—ñ–ª–æ
  const sel = `#resTable thead tr > *:nth-child(${idx}), #resTable tbody tr > *:nth-child(${idx})`;
  document.querySelectorAll(sel).forEach(el => { el.style.display = show ? '' : 'none'; });

  // –í–ê–ñ–õ–ò–í–û: —Å–∞–º <col>, —â–æ–± –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ –≤–ø–ª–∏–≤–∞–ª–∞ –Ω–∞ —Ä–æ–∑–∫–ª–∞–¥–∫—É
  const colEl = document.querySelector(`#resTable colgroup col:nth-child(${idx})`);
  if (colEl) colEl.style.display = show ? '' : 'none';
}

function applyColumnVisibility(){
  COLS_ORDER.forEach(k => setColVisible(k, visibleCols.has(k)));
  fitTableToViewport();       // ‚Üê –∫–ª—é—á–æ–≤–∏–π –≤–∏–∫–ª–∏–∫
  enableResizableColumns();  // ‚Üê –î–û–î–ê–í
}

function buildColumnPickerUI(){
  loadVisibleCols();
  const box = document.getElementById('columnPicker');
  if (!box) return;
  box.innerHTML = `
    <h3>–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ</h3>
    <div class="list">
      ${COLS_ORDER.map(k=>`
        <label><input type="checkbox" data-colkey="${k}" ${visibleCols.has(k)?'checked':''}> ${COL_LABEL[k]}</label>
      `).join('')}
    </div>
    <div class="btns">
      <button type="button" class="btn sm" id="colsDefault">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</button>
      <button type="button" class="btn sm" id="colsAll">–£—Å—ñ</button>
      <button type="button" class="btn sm" id="colsNone">–ñ–æ–¥–Ω—ñ</button>
    </div>
  `;
  box.onchange = (e)=>{
    const cb = e.target.closest('input[type="checkbox"][data-colkey]'); if (!cb) return;
    const key = cb.getAttribute('data-colkey');
    if (cb.checked) visibleCols.add(key); else visibleCols.delete(key);
    saveVisibleCols(); applyColumnVisibility();
  };
  box.querySelector('#colsDefault')?.addEventListener('click', ()=>{
    visibleCols = new Set(DEFAULT_VISIBLE); saveVisibleCols(); buildColumnPickerUI(); applyColumnVisibility();
  });
  box.querySelector('#colsAll')?.addEventListener('click', ()=>{
    visibleCols = new Set(COLS_ORDER); saveVisibleCols(); buildColumnPickerUI(); applyColumnVisibility();
  });
  box.querySelector('#colsNone')?.addEventListener('click', ()=>{
    visibleCols = new Set(); saveVisibleCols(); buildColumnPickerUI(); applyColumnVisibility();
  });
}

/* ---------- –¢–∞–±–ª–∏—Ü—è ---------- */
function renderTable(rows){
  // —Ö—Ç–æ –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –ª—ñ–Ω–∫ –Ω–∞ review
  const roleNow   = String(window.__userRole ?? currentRole ?? '').toLowerCase();
  const canReview = (roleNow === 'admin' || roleNow === 'security');

  const tb = document.querySelector('#resTable tbody');
  
  tb.innerHTML = rows.map(r=>`<tr data-id="${r.id}">
    <td>${r.hub || ''}</td>
    <td class="cell-code" title="${r.fromCode}">${r.fromCode}</td>
    <td class="cell-code" title="${r.toCode}">${r.toCode}</td>
    <td>${r.fromName}</td>
    <td>${r.toName}</td>
    <td class="cell-via">${r.viaNames || ''}</td>
    <td>${Number.isFinite(r.distance_km) ? r.distance_km.toFixed(3) : ''}</td>
    <td>${r.type}</td>
    <td>${r.logisticName || ''}</td>
    <td>${r.statusLabel || ''}</td>
    <td class="cell-comment">${r.rejectComment ? r.rejectComment : ''}</td>
    <td>${r.updatedAt}</td>
    <td class="cell-key" title="${r.routeKey || ''}">
      ${r.routeKey || ''}
      ${r.routeKey ? `<button class="copy-btn copy-key" data-val="${r.routeKey}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥">üìã</button>` : ''}
    </td>
    <td class="cell-id" title="${r.id}">
      ${r.id}
      <button class="copy-btn copy-id" data-val="${r.id}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ ID">üìã</button>
    </td>
    <td><a href="${MAP_URL}?rid=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a></td>
<td>${
  (r.statusLabel === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ')
    ? '‚Äî'
    : (canReview
        ? `<a href="${REVIEW_PAGE}?rid=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">–ü–æ–≥–æ–¥–∏—Ç–∏</a>`
        : '‚Äî')
}</td>
<td><button class="btn sm share-btn" data-id="${r.id}" data-name="${(r.fromName||'') + ' ‚Üí ' + (r.toName||'')}">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button></td>
<td><button class="btn sm json-one" data-id="${r.id}">JSON</button></td>
  </tr>`).join('');
  document.getElementById('countInfo').textContent = `–ó–∞–ø–∏—Å—ñ–≤ (–ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—É): ${rows.length}`;
  updateStats(rows);
}

/* ---------- –ï–∫—Å–ø–æ—Ä—Ç —É Excel ---------- */
function exportToExcel(rows){
  const keys = COLS_ORDER.filter(k => visibleCols.has(k) && !EXCEL_EXCLUDE.has(k));
  if (!keys.length){ alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.'); return; }
  const header = keys.map(k => COL_LABEL[k]);

  const body = rows.map(r => keys.map(k => {
    switch(k){
      case 'hub':        return r.hub || '';
      case 'fromCode':   return r.fromCode || '';
      case 'toCode':     return r.toCode || '';
      case 'fromName':   return r.fromName || '';
      case 'toName':     return r.toName || '';
      case 'via':        return r.viaNames || '';
      case 'distance':   return Number.isFinite(r.distance_km) ? Number(r.distance_km.toFixed(3)) : '';
      case 'type':       return r.type || '';
      case 'logist':     return r.logisticName || '';
      case 'status':     return r.statusLabel || '';
      case 'comment':    return r.rejectComment || '';
      case 'updated':    return r.updatedAt || '';
      case 'routeKey':   return r.routeKey || '';
      case 'id':         return r.id || '';
      case 'map': {
        const mapUrl = `${location.origin}${MAP_URL}?rid=${encodeURIComponent(r.id)}`;
        return { t:'s', v:'üó∫Ô∏è –í—ñ–¥–∫—Ä–∏—Ç–∏', l:{ Target: mapUrl, Tooltip: '–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç—ñ' } };
      }
      default:           return '';
    }
  }));

  const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
  ws['!cols'] = header.map(() => ({ wch: 18 }));
  ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{c:0,r:0}, e:{c:header.length-1,r:body.length} }) };

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä—à—Ä—É—Ç–∏');
  XLSX.writeFile(wb, 'routes_export.xlsx');
}

/* ---------- UI –¥–æ–ø–æ–º—ñ–∂–Ω–µ ---------- */
function updatePagerUI(){
  const moreBox = document.getElementById('moreBox');
  moreBox.style.display = allRows.length ? '' : 'none';
  btnMore.style.display = _hasMore ? '' : 'none';
  btnAll.style.display  = _hasMore ? '' : 'none';
}

/* ---------- –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É (—Ñ–æ—Ä—Å —ñ–∑ —Å–µ—Ä–≤–µ—Ä–∞) ---------- */
async function refreshAll(){
  try{
    setBusy(true);
    try{ localStorage.removeItem(DIR_CACHE_KEY); }catch{}
    try{ localStorage.removeItem(LOGISTS_CACHE_KEY); }catch{}
    await Promise.all([loadDirectory(true), loadLogists(true)]);
    await loadFirstPage(true);
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
}

/* ---------- –ü–æ–º–∏–ª–∫–∏ Firestore ---------- */
function handleFirestoreError(e){
  console.error('Firestore error:', e);
  const msg = e?.message || '';
  if (e?.code === 'failed-precondition' && msg.includes('create it here')) {
    const m = msg.match(/https:\/\/console\.firebase\.google\.com\/[^\s"]+/);
    if (m && m[0]) { const url = m[0]; try { window.open(url, '_blank'); } catch(_) {} alert('–î–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å —É Firestore.\n–Ø –≤—ñ–¥–∫—Ä–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.\n\n–ü–æ—Å–∏–ª–∞–Ω–Ω—è:\n' + url); return; }
  }
  alert(msg || e);
}

/* ---------- –†–µ–Ω–¥–µ—Ä ---------- */
function reRender(){
  let rows = applyTopFilters(allRows);
  rows = applyTableFilters(rows);
  rows = sortRows(rows);
  renderTable(rows);
  applyColumnVisibility();
  updatePagerUI();
  updateSortIcons();
  syncXWidth();           // ‚Üê –¥–æ–¥–∞–ª–∏
}

/* ---------- –ü–æ–¥—ñ—ó ---------- */
btnPreview.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    await loadFirstPage(true);   // ‚Üê –±—É–ª–æ false
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnMore.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    await loadNextPage();
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnAll.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    const MAX_ROWS = 50000; // –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫
    while(_hasMore && allRows.length < MAX_ROWS){ await loadNextPage(); }
    reRender();
    if (_hasMore) alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${MAX_ROWS.toLocaleString()} —Ä—è–¥–∫—ñ–≤. –ó–≤—É–∑—å—Ç–µ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –µ–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ —á–∞—Å—Ç–∏–Ω–∞–º–∏.`);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnExport.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    if (_hasMore){
      const agree = confirm(`–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –í–°–Ü —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –µ–∫—Å–ø–æ—Ä—Ç–æ–º? –ó–∞—Ä–∞–∑ —É –ø–∞–º'—è—Ç—ñ ${allRows.length}+ —Ä—è–¥–∫—ñ–≤.`);
      if (agree){
        const MAX_ROWS = 50000;
        while(_hasMore && allRows.length < MAX_ROWS){ await loadNextPage(); }
        if (_hasMore) alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${MAX_ROWS.toLocaleString()} —Ä—è–¥–∫—ñ–≤. –ï–∫—Å–ø–æ—Ä—Ç –ø–æ –ø–µ—Ä—à–∏—Ö ${MAX_ROWS.toLocaleString()}.`);
      }
    }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    exportToExcel(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnRefresh.addEventListener('click', refreshAll);

document.querySelector('#resTable thead').addEventListener('click', (ev)=>{
  const th = ev.target.closest('th.sortable');
  if (!th) return;
  const key = th.getAttribute('data-sort');
  if (sortState.key === key) sortState.dir *= -1;
  else { sortState.key = key; sortState.dir = 1; }
  reRender();
});

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const onFilterChange = debounce(()=> reRender(), 200);
document.querySelector('#resTable thead').addEventListener('input', onFilterChange);
btnClearFilters.addEventListener('click', ()=>{
  document.querySelectorAll('#resTable thead .filters input, #resTable thead .filters select')
    .forEach(el=>{ el.value=''; });
  reRender();
});

/* –î–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤: –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è + –ö–æ–ø—ñ—é–≤–∞—Ç–∏ ID/–ö–æ–¥ */
document.querySelector('#resTable tbody').addEventListener('click', async (ev)=>{
  const shareBtn = ev.target.closest('.share-btn');
  if (shareBtn){
    const id = shareBtn.getAttribute('data-id');
    const prettyName = shareBtn.getAttribute('data-name') || '–ú–∞—Ä—à—Ä—É—Ç';
    try{
      setBusy(true);
      const payload = await buildNavigatePayloadById(id, prettyName);
      const url = buildNavigateURLFromPayload(payload);
      await shareURL(url, prettyName);
    }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ç–æ—Ä–∞: ' + (e?.message || e)); }
    finally{ setBusy(false); }
    return;
  }

const jsonOne = ev.target.closest('.json-one');
if (jsonOne){
  const id = jsonOne.getAttribute('data-id');
  try{
    setBusy(true);
    // –∑–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–æ–∫ —É –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö
    const row = allRows.find(x => x.id === id);
    if (row && row.raw){
      downloadJson(Object.assign({ id }, normalizeForJson(row.raw)), `route_${id}.json`);
    } else {
      // —Ñ–æ–ª–±–µ–∫: –¥–æ—á–∏—Ç–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É
      const doc = await db.collection('routes').doc(id).get({ source:'server' });
      const raw = doc.exists ? doc.data() : {};
      downloadJson(Object.assign({ id }, normalizeForJson(raw)), `route_${id}.json`);
    }
  }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ' + (e?.message || e)); }
  finally{ setBusy(false); }
  return;
}

  const copyBtn = ev.target.closest('.copy-btn');
  if (copyBtn){
    const val = copyBtn.getAttribute('data-val') || '';
    try{
      await navigator.clipboard.writeText(val);
      copyBtn.textContent = '‚úÖ';
      setTimeout(()=>{ copyBtn.textContent = 'üìã'; }, 1000);
    }catch{ prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Ä—É—á–Ω—É:', val); }
  }
});

/* ---------- –†–æ–∑—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –∞–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ ---------- */
const WIDTHS_KEY = 'export.tableWidths.v1';

function freezeTableWidths(){
  const table = document.getElementById('resTable');
  if (!table || !table.tHead || !table.tHead.rows.length) return;

  const headerRow = table.tHead.rows[0];
  const cols = Array.from(table.querySelector('colgroup').children);

  // –í–º–∏–∫–∞—î–º–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π –ª–µ–π–∞—É—Ç ‚Äî –≤—ñ–Ω —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π –ø—ñ–¥ —á–∞—Å drag
  table.style.tableLayout = 'fixed';

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ —Ñ–∞–∫—Ç–∏—á–Ω—ñ —à–∏—Ä–∏–Ω–∏ —É px
  for (let i = 0; i < cols.length; i++){
    const th = headerRow.cells[i];
    const col = cols[i];
    if (!th || !col) continue;
    const w = Math.round(th.getBoundingClientRect().width);
    if (w > 0) col.style.width = w + 'px';
  }
}

function enableResizableColumns() {
  const table = document.getElementById('resTable');
  if (!table || !table.tHead || !table.tHead.rows.length) return;

  const headerRow = table.tHead.rows[0];
  const cols = Array.from(table.querySelector('colgroup').children);

  // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ä—ñ —Ä—É—á–∫–∏ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –ø–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è)
  headerRow.querySelectorAll('.col-resizer').forEach(el => el.remove());

  // –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ, –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω—ñ –¥–æ data-colkey
  Array.from(headerRow.cells).forEach((th) => {
    const key = th.dataset.colkey;
    if (!key || !COL_INDEX[key]) return;

    const colIdx = COL_INDEX[key] - 1;    // 0-based —É <colgroup>
    const colEl = cols[colIdx];
    if (!colEl) return;

    const h = document.createElement('span');
    h.className = 'col-resizer';
    th.style.position = 'relative';
    th.appendChild(h);

    let startX = 0, startW = 0;

    const onMove = (e) => {
      const dx = e.clientX - startX;
      const w = Math.max(60, Math.min(900, startW + dx));
      colEl.style.width = w + 'px';
      table.classList.add('resizing');
    };

    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      table.classList.remove('resizing');
      saveColumnWidths();
    };

    h.addEventListener('mousedown', (e) => {
  e.preventDefault();

  // 1) –∑–∞–º–æ—Ä–æ–∑–∏–ª–∏ –ø–æ—Ç–æ—á–Ω—ñ —à–∏—Ä–∏–Ω–∏ ‚Äî —â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ —Å—Ç—Ä–∏–±–∞–ª–æ
  freezeTableWidths();

  // 2) —Å—Ç–∞—Ä—Ç–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—ñ—Å–ª—è ¬´–∑–∞–º–æ—Ä–æ–∑–∫–∏¬ª
  startX = e.clientX;
  startW = parseFloat(colEl.style.width) || th.getBoundingClientRect().width;

  // 3) –ª–µ–≥–∫–∏–π –≤—ñ–∑—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –ø—ñ–¥ —á–∞—Å drag (—ñ —Å–∏–Ω—Ö—Ä–æ–Ω —Å–∫—Ä–æ–ª–µ—Ä–∞)
  document.getElementById('resTable').classList.add('resizing');

  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
});

    // –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ ‚Äî –∞–≤—Ç–æ–ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ —à–∏—Ä–∏–Ω—É —Å–∞–º–µ —Ü—ñ—î—ó –∫–æ–ª–æ–Ω–∫–∏
    h.addEventListener('dblclick', () => {
      const w = measureColumnWidth(colIdx);
      colEl.style.width = w + 'px';
      saveColumnWidths();
    });
  });
}

function getTableFont(){
  const table = document.getElementById('resTable');
  const cs = getComputedStyle(table);
  return cs.font || `${cs.fontStyle||'normal'} ${cs.fontWeight||'400'} ${cs.fontSize||'13px'} ${cs.fontFamily||'system-ui'}`;
}

function measureColumnWidth(index){
  const table = document.getElementById('resTable');
  const sampleLimit = 200; // –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—ó –æ—Ü—ñ–Ω–∫–∏
  const ctx = document.createElement('canvas').getContext('2d');
  ctx.font = getTableFont();

  const pad = 24; // –ø–∞–¥—ñ–Ω–≥/—ñ–∫–æ–Ω–∫–∏
  let max = 80;

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const headText = (table.tHead.rows[0].cells[index].innerText || '').trim();
  max = Math.max(max, ctx.measureText(headText).width + pad);

  // —Ñ—ñ–ª—å—Ç—Ä —É —à–∞–ø—Ü—ñ (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä / –Ω–∞–∑–≤–∞ –æ–ø—Ü—ñ—ó)
  const fcell = table.tHead.rows[1].cells[index];
  if (fcell){
    const input = fcell.querySelector('input,select');
    if (input){
      const txt = (input.value || input.placeholder || '').trim();
      if (txt) max = Math.max(max, ctx.measureText(txt).width + pad);
    }
  }

  // –∫–æ–º—ñ—Ä–∫–∏ —Ç—ñ–ª–∞
  const rows = Array.from(table.tBodies[0].rows).slice(0, sampleLimit);
  for (const tr of rows){
    const txt = (tr.cells[index]?.innerText || '').trim();
    if (txt){
      max = Math.max(max, ctx.measureText(txt).width + pad);
    }
  }

  return Math.min(Math.max(Math.ceil(max), 60), 900);
}

function autosizeColumns(){
  const table = document.getElementById('resTable');
  const cols = Array.from(table.querySelector('colgroup').children);
  for (let i=0;i<cols.length;i++){
    const w = measureColumnWidth(i);
    cols[i].style.width = w + 'px';
  }
  saveColumnWidths();
  syncXWidth();
}

function saveColumnWidths(){
  try{
    const cols = document.querySelectorAll('#resTable colgroup col');
    const arr = Array.from(cols).map(c => (c.style.width || c.getBoundingClientRect().width + 'px'));
    localStorage.setItem(WIDTHS_KEY, JSON.stringify(arr));
  }catch{}
}

function restoreColumnWidths(){
  try{
    const raw = localStorage.getItem(WIDTHS_KEY);
    if (!raw) return;
    const arr = JSON.parse(raw);
    const cols = document.querySelectorAll('#resTable colgroup col');
    arr.forEach((w, i)=>{ if (cols[i]) cols[i].style.width = w; });
  }catch{}
}

btnAutosize.addEventListener('click', autosizeColumns);

/* ---------- –°—Ç–∞—Ä—Ç ---------- */
(async ()=>{
  if (!db) return;
  statusEl.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å';
  if (auth?.currentUser) { await Promise.all([loadDirectory(), loadLogists(true)]); }
  // –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–æ–∫: –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∏—Ä–∏–Ω–∏ —ñ —É–≤—ñ–º–∫–Ω—É—Ç–∏ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
  restoreColumnWidths();
  enableResizableColumns();
  buildColumnPickerUI();
  fitTableToViewport();      // ‚Üê –¥–æ–¥–∞–ª–∏
  bindXSync();            // ‚Üê –¥–æ–¥–∞–ª–∏
})();

btnExportJson.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    await exportJsonZipFromRows(rows);        // <-- –∑–∞–º—ñ—Å—Ç—å exportJsonFromRows
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnExportJsonAll.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    while(_hasMore){ await loadNextPage(); }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    await exportJsonZipFromRows(rows);        // <-- –∑–∞–º—ñ—Å—Ç—å exportJsonFromRows
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});
/* ==== –¢–æ–≥–ª ¬´–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ¬ª —è–∫ —Å–µ–∫—Ü—ñ—ó (–ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏) ==== */
const COLPICKER = document.getElementById('columnPicker');
const COLPICKER_STATE_KEY = 'export.colpickerHidden.v1';

function applyColpickerState(){
  const hidden = localStorage.getItem(COLPICKER_STATE_KEY) === '1';
  COLPICKER.classList.toggle('is-hidden', hidden);
}
applyColpickerState();

document.getElementById('btnToggleSidebar')?.addEventListener('click', () => {
  const hidden = COLPICKER.classList.toggle('is-hidden');
  localStorage.setItem(COLPICKER_STATE_KEY, hidden ? '1' : '0');
});

/* ==== –¢–æ–≥–ª ¬´–§—ñ–ª—å—Ç—Ä–∏¬ª —è–∫ —Å–µ–∫—Ü—ñ—ó (–ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏) ==== */
const FILTERS = document.querySelector('.filters-card');
const FILTERS_STATE_KEY = 'export.filtersHidden.v1';

function applyFiltersState(){
  const hidden = localStorage.getItem(FILTERS_STATE_KEY) === '1';
  FILTERS.classList.toggle('is-hidden', hidden);
}
applyFiltersState();

document.getElementById('btnToggleFilters')?.addEventListener('click', () => {
  const hidden = FILTERS.classList.toggle('is-hidden');
  localStorage.setItem(FILTERS_STATE_KEY, hidden ? '1' : '0');
});

</script>
</body>
</html>