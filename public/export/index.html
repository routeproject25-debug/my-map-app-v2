<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>üíæ –ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- App config -->
  <script src="/config/config.js"></script>
  <!-- –°–ø—ñ–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ -->
  <link rel="stylesheet" href="/styles/common.css">
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- LZ-String (srcz) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
  html, body { overflow-x: clip; } /* fallback: hidden */
  .table-wrap { overflow:auto; max-width:100%; }
    :root { --w: min(1400px, 96vw); }  /* —à–∏—Ä—à–µ —ñ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ */
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; padding-bottom: 24px; }
    .wrap { max-width:var(--w); margin:12px auto 24px; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }
    h1 { margin:0 0 12px; font-size:20px; }

    .row { display:grid; gap:12px; }
    .row.cols-2 { grid-template-columns: 1fr 1fr; }
    .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .row.dates { grid-template-columns: minmax(180px,1fr) minmax(180px,1fr); gap:10px; }
    @media (max-width: 860px) { .row.cols-4 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { .row.cols-2, .row.cols-3, .row.cols-4, .row.dates { grid-template-columns: 1fr; } }

    label { display:block; font-size:13px; color:#555; margin:4px 0; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width:100%; padding:8px 10px; border:1px solid #d5d9e0; border-radius:8px; background:#fff; font-size:14px;
    }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    /* —á–µ—Ä–≤–æ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è */
    .btn.danger { background:#dc2626; border-color:#dc2626; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.sm { padding:4px 8px; font-size:12.5px; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#667085; font-size:12.5px; }
    .warn { color:#b91c1c; font-size:12px; }

    /* —Ç–∞–±–ª–∏—Ü—è */
    table { width:100%; border-collapse:collapse; table-layout: fixed; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; text-align:left; vertical-align: top; }
    th { background:#f1f5f9; position:relative; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }

    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#111827; }
    .stats .chip { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; }

    /* –∫–∞—Ä—Ç–∫–∞ –∑ —Ç–∞–±–ª–∏—Ü–µ—é –≤ –º–µ–∂–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.card.edge{
  width: 100%;
  margin-left: 0;
  margin-right: 0;
  border-radius: 12px;
}
  /* —à–∏—Ä–∏–Ω–∏/–ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –∫–æ–º—ñ—Ä–æ–∫ */
    .col-code { width: 120px; }
    .cell-code { word-break: break-all; overflow-wrap: anywhere; white-space: normal; line-height:1.25; }

    /* –ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏ */
    .col-via { width: clamp(220px, 28%, 520px); } /* –∞–±–æ 40ch / 30% ‚Äî —è–∫ –∑—Ä—É—á–Ω—ñ—à–µ */
    .cell-via { white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height: 1.25; }

  .col-key { width: clamp(140px, 16vw, 200px); }
  .col-unit { width: clamp(120px, 16vw, 200px); }
    .col-id  { width: clamp(120px, 18vw, 220px); }

    .col-status { width: clamp(140px, 18vw, 200px); }
    .col-comment { width: clamp(220px, 36vw, 520px); }
    .cell-comment { white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height:1.25; }

    .cell-key, .cell-id { position:relative; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right:28px; }
    .copy-btn { position:absolute; right:6px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:14px; opacity:.75; }
    .copy-btn:hover { opacity:1; }

    /* —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è / —Ñ—ñ–ª—å—Ç—Ä–∏ –≤ —à–∞–ø—Ü—ñ */
    th.sortable { cursor:pointer; user-select:none; }
    th.sortable .s { font-size:11px; opacity:.6; margin-left:6px; }
    th.sortable.active .s { opacity:1; }
    thead tr.filters th { background:#fafafa; }
    thead tr.filters input, thead tr.filters select {
      width:100%; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px; font-size:12px; background:#fff;
    }
    /* –±–∞–≥–∞—Ç–æ–≤–∞—Ä—ñ–∞–Ω—Ç–Ω–∏–π –≤–∏–±—ñ—Ä —É —Ñ—ñ–ª—å—Ç—Ä–∞—Ö —Ç–∞–±–ª–∏—Ü—ñ */
    thead tr.filters select[multiple]{ min-height:2.6em; height:auto; }
    .range { display:flex; flex-wrap:wrap; gap:4px; }
    .range input { flex:1 1 90px; min-width:90px; max-width:100%; }
    
      /* ===== Excel-like column filter ===== */
      .excel-filter-btn{
        margin-left:6px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; padding:1px 4px; border-radius:4px; font-size:11px; line-height:1; color:#111;
      }
      .excel-filter-btn.active{ background:#e6f4ea; border-color:#22c55e; }
      .excel-filter-panel{ position:absolute; z-index:2000; min-width:220px; max-width:360px; max-height:60vh; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 10px 24px rgba(0,0,0,.12); padding:8px; display:none; }
      .excel-filter-panel .head{ display:flex; gap:6px; align-items:center; margin-bottom:6px; }
      .excel-filter-panel .head input[type="text"]{ flex:1 1 auto; padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px; font-size:12px; }
      .excel-filter-panel .list{ display:flex; flex-direction:column; gap:4px; margin-bottom:8px; max-height:44vh; overflow:auto; }
      .excel-filter-panel .actions{ display:flex; gap:6px; justify-content:flex-end; }
      .excel-filter-panel .actions .btn{ padding:6px 10px; font-size:12px; }

    /* === –†—É—á–∫–∏ –¥–ª—è –∑–º—ñ–Ω–∏ —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ === */
    .col-resizer{
  position:absolute; top:0; right:0; width:10px; height:100%;
  cursor:col-resize; user-select:none;
}
    .col-resizer:hover { background:rgba(37,99,235,.15); }
    .resizing .col-resizer { background:rgba(37,99,235,.25); }
	
	/* ==== –õ—ñ–≤–∏–π —Å–∞–π–¥–±–∞—Ä –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏ ==== */
/* —Å—Ç–∞–ª–æ ‚Äî —Å–∞–π–¥–±–∞—Ä –≥–Ω—É—á–∫–∏–π —ñ –º–æ–∂–µ –∑–≥–æ—Ä—Ç–∞—Ç–∏—Å—è */
.layout{
  display:grid;
  grid-template-columns: 1fr; /* –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç—è–≥–Ω—É—Ç—å—Å—è –Ω–∞ –≤—Å—é, —ñ–Ω—à–µ —Ü–µ–Ω—Ç—Ä—É—î–º–æ */
  gap:16px;
  align-items:start;
}

/* –î—ñ—Ç–∏ .main —Ä–æ–∑–∫–ª–∞–¥–∞—é—Ç—å—Å—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –≥—Ä—ñ–¥ .layout */
.layout .main{
  display: contents;
  min-width: 0; /* —Ç–µ —Å–∞–º–µ, —â–æ –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ */
}

/* –§—ñ–ª—å—Ç—Ä–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É, –æ–±–º–µ–∂—É—î–º–æ —à–∏—Ä–∏–Ω—É */
.filters-card{
  grid-column: 1 / -1;
  max-width: 100vw;
  justify-self: stretch;
  padding: 10px 12px;
  margin-left:  calc(50% - 50vw + 16px);
  margin-right: calc(50% - 50vw + 16px);
  border-radius: 12px;
}
.filters-card #filtersArea{
  display: grid;
  grid-template-columns: repeat(6, minmax(150px, 1fr));
  gap: 6px 10px;
  align-items: end;
}
.filters-card #filtersArea .row{ display: contents; }
.filters-card #filtersArea .row > div{ min-width: 0; }
.filters-card #filtersArea label{ font-size:12px; margin:0 0 2px; }
.filters-card #filtersArea input[type="text"],
.filters-card #filtersArea input[type="date"],
.filters-card #filtersArea input[type="number"],
.filters-card #filtersArea select{
  padding:6px 8px;
  font-size:13px;
}
.filters-card #filtersArea .row.dates{
  display:grid !important;
  grid-template-columns: minmax(140px,1fr) minmax(140px,1fr);
  gap:6px;
}
.filters-card #testModeRow,
.filters-card .bar{ grid-column: 1 / -1; }
.filters-card .bar{ margin-top: 6px !important; }
.filters-card .bar .btn{ padding:6px 10px; font-size:12.5px; }
.filters-card .bar .muted{ font-size:11.5px; }

@media (max-width: 1400px){
  .filters-card #filtersArea{ grid-template-columns: repeat(5, minmax(150px, 1fr)); }
}
@media (max-width: 1100px){
  .filters-card #filtersArea{ grid-template-columns: repeat(4, minmax(150px, 1fr)); }
}
@media (max-width: 820px){
  .filters-card #filtersArea{ grid-template-columns: repeat(2, minmax(150px, 1fr)); }
}
@media (max-width: 560px){
  .filters-card #filtersArea{ grid-template-columns: 1fr; }
}

/* –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî —Ñ—É–ª-–±—Ä—ñ–¥ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤—ñ–∫–Ω–∞ */
.results-card{
  grid-column: 1 / -1;
  margin-left:  calc(50% - 50vw + 16px);
  margin-right: calc(50% - 50vw + 16px);
  max-width: 100vw;     /* —â–æ–± –Ω–µ —Ä–æ–∑–ø–æ–≤–∑–ª–æ—Å—å —à–∏—Ä—à–µ –≤—ñ–∫–Ω–∞ */
  border-radius: 12px;
  overflow: visible;    /* –ø–æ—Ç—Ä—ñ–±–Ω–µ –¥–ª—è sticky –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Å–∫—Ä–æ–ª—É */
}


.colpicker{
  position: fixed;
  right: 12px;
  top: 96px;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:12px;
  max-width: min(920px, calc(100vw - 24px));
  max-height: 85vh;
  overflow: auto;
  box-shadow: 0 10px 24px rgba(0,0,0,.12);
  z-index: 2600;
}

.colpicker h3{ margin:0 0 8px; font-size:14px; }
.colpicker .list{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 8px 12px;
}
.colpicker label{ display:flex; align-items:center; gap:8px; font-size:13px; }
.colpicker .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
/* ‚ñ∫ –°–∞–º–µ —Ü–µ –¥–æ–¥–∞–π */
.colpicker.is-hidden{ display:none; }
.filters-card.is-hidden{ display:none; }

/* –∫–Ω–æ–ø–∫–∞-—Ç–æ–≥–ª –∑–≤–µ—Ä—Ö—É –ø—Ä–∞–≤–æ—Ä—É—á */
.coltoggle{ margin-left:8px; }

/* –¥—Ä—ñ–±–Ω–∏—Ü—è: —Ö–∞–π –æ—Å–Ω–æ–≤–Ω–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å —Å—Ç–∏—Å–∫–∞—î—Ç—å—Å—è */
.layout .main{ min-width:0; }

/* —Ç–∞–±–ª–∏—Ü—è: —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –•–ê–ë */
.col-hub { width: 120px; }
/* –∫–æ–ª–æ–Ω–∫–∞ "–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä" */
.col-navigator { width: 140px; }
/* –∫–æ–ª–æ–Ω–∫–∞ "–í–∏–¥–∞–ª–∏—Ç–∏" */
.col-delete { width: 140px; }

/* —â–æ–± ¬´–†–µ–∑—É–ª—å—Ç–∞—Ç–∏¬ª –Ω–µ —Ä–æ–∑—Ç—è–≥—É–≤–∞–ª–∏—Å—å –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤ –º–µ–∂–∞—Ö layout */
.layout .main .card.edge { width:100%; margin-left:0; margin-right:0; border-radius:12px; }

/* –º–æ–±—ñ–ª—å–Ω–µ: —Å–∞–π–¥–±–∞—Ä –ø—ñ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç */
@media (max-width: 980px){
  .layout{ grid-template-columns: 1fr; }
  .colpicker{ right: 8px; left: 8px; max-width: calc(100vw - 16px); }
  .filters-card{ grid-column: 1 / -1; }   /* —â–æ–± –∫–∞—Ä—Ç–∫–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–µ ¬´—Ç—è–≥–Ω—É–ª–∞—Å—è¬ª –≤ –Ω–µ—ñ—Å–Ω—É—é—á—É 2-–≥—É –∫–æ–ª–æ–Ω–∫—É */
}

.card { overflow:hidden; }  /* —â–æ–± –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–µ ¬´–≤–∏–≥—Ä–∏–∑–∞–ª–∏¬ª –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª */

/* –•–µ–¥–µ—Ä: –∑–ª—ñ–≤–∞ –Ω–∞–∑–≤–∞, —Å–ø—Ä–∞–≤–∞ –∫–Ω–æ–ø–∫–∏ */
.topbar.header-grid{
  display:grid;
  grid-template-columns: 1fr auto;  /* –Ω–∞–∑–≤–∞ –∑–∞–π–º–∞—î –≤—Å–µ –∑–ª—ñ–≤–∞, –∫–Ω–æ–ø–∫–∏ ‚Äî —Å–≤–æ—ó —Ä–æ–∑–º—ñ—Ä–∏ */
  align-items:start;                /* –∫–Ω–æ–ø–∫–∏ –π –Ω–∞–∑–≤–∞ –ø—Ä–∏—Ç–∏—Å–Ω—É—Ç—ñ –¥–æ –≤–µ—Ä—Ö—É */
  gap:16px;
  margin-bottom:12px;               /* –≤—ñ–¥—Å—Ç—É–ø –ø—ñ–¥ —Ö–µ–¥–µ—Ä–æ–º */
}

/* –ù–∞–∑–≤–∞: –æ–¥–Ω–∞ –ª—ñ–Ω—ñ—è –∑–≤–µ—Ä—Ö—É –∑–ª—ñ–≤–∞ */
.page-title{
  margin:0;                         /* –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≤—ñ–¥—Å—Ç—É–ø—ñ–≤ */
  font-size:20px;
  font-weight:600;
  line-height:1.25;
  white-space:nowrap;               /* 1 —Ä—è–¥–æ–∫ */
  overflow:hidden;                  /* –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è */
  text-overflow:ellipsis;
}

/* –ö–Ω–æ–ø–∫–∏ –≤–≥–æ—Ä—ñ –ø—Ä–∞–≤–æ—Ä—É—á */
.header-actions{
  display:flex;
  justify-content:flex-end;         /* –ü–†–ê–í–û–†–£–ß */
  align-items:flex-start;           /* –≤–∏—â–µ –ø—ñ–¥ –≤–µ—Ä—Ö */
  gap:8px;
  flex-wrap:wrap;
}

/* –ï–∫—Å–ø–æ—Ä—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥–∫—É –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó —à–∞–ø–∫–∏ */
.export-topnav{
  display:flex;
  align-items:center;
  gap:12px;
  flex:1 1 auto;
  flex-wrap:nowrap;
}
.export-title{
  margin:0;
  font-size:16px;
  font-weight:600;
  line-height:1.25;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  flex:1 1 auto;
  color:#fff;
}
.export-actions{
  margin-left:0;
}

/* –®–∞–ø–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É: nav –∑–ª—ñ–≤–∞, authbar —Å–ø—Ä–∞–≤–∞ –∑–≤–µ—Ä—Ö—É */
header.top{ flex-wrap:nowrap; }
header.top .authbar{
  margin-left:auto;
  align-self:flex-start;
  white-space:nowrap;
}

/* –ê–¥–∞–ø—Ç–∏–≤ */
@media (max-width: 980px){
  .topbar.header-grid{ grid-template-columns: 1fr; }
  .page-title{ min-height:auto; }
  .header-actions{ justify-content:flex-start; }
  .export-title{ order: 3; flex-basis:100%; white-space:normal; }
  .export-actions{ order: 4; width:100%; justify-content:flex-start; }
  .export-topnav{ flex-wrap:wrap; }
  header.top{ flex-wrap:wrap; }
  header.top .authbar{ width:100%; justify-content:flex-start; white-space:normal; }
}

/* –©–æ–± –∫–æ—Ä–æ—Ç–∫—ñ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —Å—Ç–∏—Å–∫–∞–ª–∏—Å—å –∑–æ–≤—Å—ñ–º */
#resTable th, #resTable td { min-width: 90px; }
th[data-colkey="navigator"], th[data-colkey="delete"],
td.cell-nav, td.cell-delete{
  white-space: nowrap;
  text-align: center;
}
td.cell-nav .btn.nav-btn{
  padding: 4px 8px;
  font-size: 12px;
  min-height: 28px;
}
td.cell-nav, td.cell-delete{
  overflow: hidden;
}
td.cell-nav .btn, td.cell-delete .btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 140px;
  box-sizing: border-box;
}

/* –õ–∏–ø–∫–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª –ø–æ–≤–µ—Ä—Ö —Ç–∞–±–ª–∏—Ü—ñ */
.results-card { position: relative; }
#xScroller{
  position: sticky;
  top: 8px;              /* —è–∫—â–æ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—î—Ç—å—Å—è —Ö–µ–¥–µ—Ä–æ–º ‚Äì –∑–±—ñ–ª—å—à —Ü–µ —á–∏—Å–ª–æ */
  z-index: 30;
  height: 18px;          /* –≤–∏—Å–æ—Ç–∞ –∑–æ–Ω–∏ —Å–∫—Ä–æ–ª—É */
  overflow-x: scroll;
  overflow-y: hidden;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 8px;
  scrollbar-gutter: stable both-edges;
  display: block !important;
}
#xScroller::-webkit-scrollbar { height: 14px; }   /* —Ç–æ–≤—Å—Ç—ñ—à–∏–π —Å–∫—Ä–æ–ª —É WebKit */
#xScroller > div { height: 1px; }                 /* ¬´–¥–æ—Ä—ñ–∂–∫–∞¬ª –¥–ª—è —à–∏—Ä–∏–Ω–∏ */

/* –ù–∏–∂–Ω—ñ–π —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å–∫—Ä–æ–ª–±–∞—Ä */
#bottomScroller{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 150;
  height: 20px;
  overflow-x: scroll;
  overflow-y: hidden;
  background: #fff;
  border-top: 2px solid #e5e7eb;
  box-shadow: 0 -2px 8px rgba(0,0,0,.1);
  scrollbar-gutter: stable both-edges;
  display: block !important;
}
#bottomScroller::-webkit-scrollbar { height: 16px; }
#bottomScroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
#bottomScroller::-webkit-scrollbar-track { background: #f3f4f6; }
#bottomScroller > div { height: 1px; }
/* –ö–æ–ª–∏ –∫–∞—Ä—Ç–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞, –Ω–∏–∂–Ω—ñ–π —Å–∫—Ä–æ–ª –Ω–∞–¥ –∫–∞—Ä—Ç–æ—é */
body.map-open #bottomScroller{
  bottom: var(--map-h);
}

/* ===== –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–ø–∞–ø–∞ –≥–µ–æ–∑–æ–Ω–∏ ===== */
.gz-popup {
  font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
  padding: 4px;
}
.gz-info {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.gz-info td {
  padding: 10px 12px;
  border-bottom: 1px solid #e5e7eb;
  line-height: 1.4;
}
.gz-info td:first-child {
  font-weight: 600;
  color: #6b7280;
  width: 90px;
  text-align: right;
  padding-right: 16px;
  white-space: nowrap;
}
.gz-info td:last-child {
  color: #111827;
  font-weight: 500;
}
.gz-info tr:last-child td {
  border-bottom: none;
}
.gz-popup details {
  margin-top: 12px;
  padding: 8px 12px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}
.gz-popup summary {
  cursor: pointer;
  font-size: 13px;
  color: #6b7280;
  font-weight: 500;
  user-select: none;
  padding: 4px 0;
}
.gz-popup summary:hover {
  color: #2563eb;
}
.gz-popup pre {
  margin: 8px 0 0;
  padding: 12px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  font-size: 12px;
  line-height: 1.5;
  color: #374151;
  max-width: 340px;
  max-height: 200px;
  overflow: auto;
  white-space: pre-wrap;
  word-break: break-word;
}

  </style>
  
  <!-- Proposal flag styling in table comment column -->
  <style>
  .proposal-flag{
    display:inline-block;
    background:#fef9c3;
    color:#92400e;
    border:1px solid #fcd34d;
    border-radius:999px;
    padding:2px 6px;
    font-size:12px;
    margin-top:4px;
    white-space:nowrap;
  }
  .cell-comment .proposal-flag{ display:inline-block; margin-left:4px; }
  </style>
  
  <!-- Inline map panel (lazy-loaded) -->
  <style>
  /* Bottom resizable map panel */
  :root{ --map-h: 50vh; }
  .map-panel{position:fixed;left:0;right:0;bottom:0;height:var(--map-h);background:#eef2f7;border-top:1px solid #e5e7eb;z-index:100;transform:translateY(100%);transition:transform .25s ease;display:none;opacity:1}
  .map-panel.open{transform:translateY(0);display:block;opacity:1}
  body.map-open{padding-bottom:var(--map-h)}
  /* –ö–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∫–∞—Ä—Ç–∞, –≤–µ—Ä—Ö–Ω—ñ–π —Å–∫—Ä–æ–ª–±–∞—Ä —Ç–∞–±–ª–∏—Ü—ñ –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –Ω–∞–∫—Ä–∏–≤–∞—Ç–∏/–ø–µ—Ä–µ–∫—Ä–∏–≤–∞—Ç–∏ –º–∞–ø—É */
  body.map-open .table-wrap{position:relative;z-index:1;background:#fff}
  body.map-open #xScroller{display:none}
  #routeMap{width:100%;height:100%}
  .map-panel .map-resize{position:absolute;left:0;right:0;top:0;height:10px;cursor:ns-resize;z-index:2;background:linear-gradient(to bottom, rgba(0,0,0,.06), rgba(0,0,0,0));}
  .map-panel .map-resize::after{content:"";position:absolute;left:50%;top:2px;transform:translateX(-50%);width:36px;height:4px;border-radius:999px;background:#9ca3af}
  /* Selected row highlight */
  #resTable tbody tr.is-selected{background:#fff7ed}
  /* –ù–µ–∞–∫—Ç–∏–≤–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏ (soft-deleted) –≤–∏–¥—ñ–ª—è—î–º–æ –º'—è–∫–∏–º —á–µ—Ä–≤–æ–Ω–∏–º —Ñ–æ–Ω–æ–º */
  #resTable tbody tr.is-inactive{background:#fef2f2;}
  #resTable tbody tr.is-inactive td{color:#374151;}
  #resTable tbody tr.is-inactive .cell-id{position:relative;}
  #resTable tbody tr.is-inactive .cell-id::after{content:"üü•"; position:absolute; right:4px; top:4px; font-size:12px;}
  /* –¢–µ—Å—Ç–æ–≤—ñ –º–∞—Ä—à—Ä—É—Ç–∏ –≤–∏–¥—ñ–ª—è—î–º–æ —Å–≤—ñ—Ç–ª–æ-–∂–æ–≤—Ç–∏–º —Ñ–æ–Ω–æ–º */
  #resTable tbody tr.is-test{background:#fefce8;border-left:3px solid #eab308;}
  #resTable tbody tr.is-test td{color:#713f12;}

  /* Mini style dock (bottom-left) like on main page */
  .style-dock{position:fixed;left:8px;bottom:8px;z-index:3500;display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px 8px;box-shadow:0 2px 12px rgba(0,0,0,.12)}
  .style-dock select{border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;font-size:13px;background:#fff;color:#111}
  .style-dock .mapbox-brand{font-size:11px;color:#6b7280;border-left:1px dashed #e5e7eb;padding-left:8px}
  .style-dock.export{display:none}
  body.map-open .style-dock.export{display:flex}
  </style>
  
  <!-- AUTH GUARD: /export ‚Äî –ª–∏—à–µ admin | logist -->
<script>
(function () {
  // –•–æ–≤–∞—î–º–æ –¥–æ–∫—É–º–µ–Ω—Ç, —â–æ–± –Ω–µ –±—É–ª–æ –±–ª–∏–º–∞–Ω–Ω—è –¥–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É
  document.documentElement.style.visibility = 'hidden';
  // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ –ø–æ–¥—ñ—è auth –Ω–µ –ø—Ä–∏–π–¥–µ (–¥—É–±–ª—ñ–∫–∞—Ç–∏ –≤–∫–ª–∞–¥–æ–∫, —Ç—Ä–æ—Ç–ª—ñ–Ω–≥ –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–æ—â–æ)
  const __visFailsafeMs = 2000;
  let __visTimer = setTimeout(() => {
    try { document.documentElement.style.visibility = ''; } catch(_) {}
  }, __visFailsafeMs);

  const CFG = window.APP_CONFIG?.firebase;
  if (!CFG) console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js —ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è <script src="/config/config.js">.');
  try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) {}

  const auth = firebase.auth();
  const db   = firebase.firestore();
  const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);

  const unhideDoc = () => { try { document.documentElement.style.visibility = ''; } catch(_) {} };
  const clearVisTimer = () => { try { clearTimeout(__visTimer); } catch(_) {} };

  function setRoleBadge(r) {
    const el = document.getElementById('authRole');
    if (el) {
      // üîë –ü–æ–∫–∞–∑—É—î–º–æ –æ—Å–Ω–æ–≤–Ω—É —Ä–æ–ª—å + –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–æ–ª—ñ
      const additionalRoles = window.__userAdditionalRoles || [];
      let roleText = r || '‚Äî';
      if (additionalRoles.length > 0) {
        roleText += ' + ' + additionalRoles.join(', ');
      }
      el.textContent = `–†–æ–ª—å: ${roleText}`;
      el.style.display = '';
    }
    
    // üîë –ü–æ–∫–∞–∑—É—î–º–æ –≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ –∞–¥–º—ñ–Ω-—Å—Ç–æ—Ä—ñ–Ω–æ–∫ —Ç—ñ–ª—å–∫–∏ –¥–ª—è admin
    const adminMenu = document.getElementById('adminMenuExport');
    if (adminMenu) {
      adminMenu.style.display = userHasRole('admin') ? '' : 'none';
    }
  }
  
  // üîë –û–±—Ä–æ–±–∫–∞ –≤–∏–ø–∞–¥–∞—é—á–æ–≥–æ –º–µ–Ω—é –∞–¥–º—ñ–Ω–∞
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('adminMenuBtn');
    const dropdown = document.getElementById('adminDropdown');
    
    if (btn && dropdown) {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      });
      
      // –ó–∞–∫—Ä–∏—Ç–∏ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –º–µ–Ω—é
      document.addEventListener('click', () => {
        dropdown.style.display = 'none';
      });
      
      // –ù–µ –∑–∞–∫—Ä–∏–≤–∞—Ç–∏ –ø—Ä–∏ –∫–ª—ñ–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ dropdown
      dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  });

  // üëâ –£–Ω—ñ—Ñ—ñ–∫–∞—Ç–æ—Ä –¥–æ—Å—Ç—É–ø—É –¥–æ —Ö–∞–±—ñ–≤ –∑ users/{uid}
  function readHubsFromUserDoc(d){
  if (!d || typeof d !== 'object') return { hubs: [], all: false };

  let hubs = [];

  // –º–∞—Å–∏–≤–∏/—Ä—è–¥–∫–∏/–º–∞–ø–∏ –∑ —Ö–∞–±–∞–º–∏
  if (Array.isArray(d.hubs)) hubs = d.hubs;
  else if (Array.isArray(d.hubIds)) hubs = d.hubIds;
  else if (Array.isArray(d.hubCodes)) hubs = d.hubCodes;
  else if (Array.isArray(d.allowedHubs)) hubs = d.allowedHubs;            // ‚úÖ –≤–∞—à–µ –ø–æ–ª–µ
  else if (d.hubs && typeof d.hubs === 'object') hubs = Object.keys(d.hubs).filter(k => !!d.hubs[k]);
  else if (d.access && Array.isArray(d.access.hubs)) hubs = d.access.hubs;
  else if (d.access && Array.isArray(d.access.allowedHubs)) hubs = d.access.allowedHubs; // ‚úÖ —Ç–µ–∂ –ø—ñ–¥—Ö–æ–ø–∏–º–æ
  else if (typeof d.hub === 'string') hubs = [d.hub];
  else if (d.hub && typeof d.hub === 'object') hubs = [d.hub.code || d.hub.id || d.hub.name || d.hub.title || ''];

  hubs = (hubs || []).map(x => String(x || '').trim()).filter(Boolean);

  // –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ ¬´–≤—Å—ñ —Ö–∞–±–∏¬ª —á–µ—Ä–µ–∑ –∑—ñ—Ä–æ—á–∫—É
  const hasStar = hubs.includes('*');
  hubs = Array.from(new Set(hubs.filter(v => v !== '*')));

  const all = hasStar || !!(
    d.allHubs || d.allowAllHubs || d.hubsAll ||
    (d.access && (d.access.allHubs || d.access.allowAllHubs))
  );

  return { hubs, all };
}

  window.addEventListener('beforeunload', () => { try { window.__roleUnsub?.(); } catch(_) {} });

  let _authHandled = false;
  async function handleUser(u){
    if (!u) { location.replace(loginURL); return; }
    if (_authHandled) return; // –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤
    _authHandled = true;
    
    try {
      const snap = await db.collection('users').doc(u.uid).get({ source: 'server' });
      const data = snap.exists ? (snap.data() || {}) : {};
      const role = snap.exists ? (data.role || 'pending') : 'pending';
      const { hubs, all } = readHubsFromUserDoc(data);

      // –∑—Ä–æ–±–∏–º–æ –¥–æ—Å—Ç—É–ø–Ω–∏–º –¥–ª—è –Ω–∏–∂–Ω—å–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
      window.__userRole     = role;
      window.__userHubs     = hubs;    // –º–∞—Å–∏–≤ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö —Ö–∞–±—ñ–≤
      window.__userAllHubs  = !!all;   // –ø—Ä–∞–ø–æ—Ä ¬´–≤—Å—ñ —Ö–∞–±–∏¬ª
      window.__userTestMode = data.testMode === true; // üß™ —Ç–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º per-user
      window.__userAdditionalRoles = Array.isArray(data.additionalRoles) ? data.additionalRoles : []; // üîë –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–æ–ª—ñ

      setRoleBadge(role);

      if (role === 'pending') {
        alert('–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
        location.replace(loginURL); return;
      }
      // üîë –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ—ó —Ä–æ–ª—ñ –ê–ë–û –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ä–æ–ª–µ–π
      const additionalRolesInitial = Array.isArray(data.additionalRoles) ? data.additionalRoles : [];
      const hasAllowedRole = ['admin','logist','user','security'].includes(role) || 
                             additionalRolesInitial.some(r => ['admin','logist','user','security'].includes(r));
      if (!hasAllowedRole) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ï–∫—Å–ø–æ—Ä—Ç—É.');
        location.replace(loginURL); return;
      }

      // Live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ/—Ö–∞–±—ñ–≤
      try {
        window.__roleUnsub?.();
        window.__roleUnsub = db.collection('users').doc(u.uid).onSnapshot((ds) => {
          const dd = ds.exists ? (ds.data() || {}) : {};
          const r  = ds.exists ? (dd.role || 'pending') : 'pending';
          const hh = readHubsFromUserDoc(dd);
          window.__userRole    = r;
          window.__userHubs    = hh.hubs;
          window.__userAllHubs = !!hh.all;
          window.__userTestMode = dd.testMode === true; // üß™ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è testMode –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
          window.__userAdditionalRoles = Array.isArray(dd.additionalRoles) ? dd.additionalRoles : []; // üîë –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ä–æ–ª–µ–π
          setRoleBadge(r);
          // üîë –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ—ó —Ä–æ–ª—ñ –ê–ë–û –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ä–æ–ª–µ–π
          const hasAllowedRoleLive = ['admin','logist','user','security'].includes(r) || 
                                     window.__userAdditionalRoles.some(role => ['admin','logist','user','security'].includes(role));
          if (r === 'pending' || !hasAllowedRoleLive) {
            alert('–î–æ—Å—Ç—É–ø –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–æ –∞–±–æ —Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤—Ö—ñ–¥.');
            location.replace(loginURL);
          }
        });
      } catch (_) {}
    } catch (e) {
      console.error('Role/hubs check failed:', e);
      location.replace(loginURL);
      return;
    } finally {
      clearVisTimer();
      unhideDoc();
    }
  }

  // –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å –Ω–∞ onAuthStateChanged –æ–¥–∏–Ω —Ä–∞–∑
  auth.onAuthStateChanged((u) => { handleUser(u); });
})();
</script>

</head>
<body>
<header class="top">
  <nav class="export-topnav" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
    <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    
    <!-- üîë –í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ –∞–¥–º—ñ–Ω-—Å—Ç–æ—Ä—ñ–Ω–æ–∫ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è admin) -->
    <div id="adminMenuExport" style="position:relative;display:none;">
      <button id="adminMenuBtn" class="btn" style="padding:8px 12px;background:#f3f4f6;border:1px solid #e5e7eb;">
        ‚öôÔ∏è –ê–¥–º—ñ–Ω ‚ñæ
      </button>
      <div id="adminDropdown" style="display:none;position:absolute;top:100%;left:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);min-width:220px;margin-top:4px;z-index:1000;">
        <a href="/admin.html" style="display:block;padding:10px 16px;text-decoration:none;color:#111;border-bottom:1px solid #f3f4f6;">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
        <a href="/Firestore_Viewe.html" style="display:block;padding:10px 16px;text-decoration:none;color:#111;border-bottom:1px solid #f3f4f6;">üîç Firestore Viewer</a>
        <a href="/admin/geojson-builder.html" style="display:block;padding:10px 16px;text-decoration:none;color:#111;border-bottom:1px solid #f3f4f6;">üìê GeoJSON Builder</a>
        <a href="/import/" style="display:block;padding:10px 16px;text-decoration:none;color:#111;border-bottom:1px solid #f3f4f6;">üì• –Ü–º–ø–æ—Ä—Ç</a>
        <a href="/import/upload-routes.html" style="display:block;padding:10px 16px;text-decoration:none;color:#111;">üì• –Ü–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (—Ñ–∞–π–ª)</a>
      </div>
    </div>

    <h1 class="page-title export-title">–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</h1>

    <div class="header-actions export-actions">
      <button id="btnToggleFilters" class="btn coltoggle">‚ò∞ –§—ñ–ª—å—Ç—Ä–∏</button>
      <button id="btnToggleSidebar" class="btn coltoggle">‚ò∞ –ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ</button>
    </div>
  </nav>
  <div class="authbar">
    <span id="authInfo">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</span>
    <span id="authRole" class="role-badge" style="display:none;"></span>
    <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
    <span id="status" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
  </div>
</header>

  <div class="wrap">
<div class="layout">
  <aside id="columnPicker" class="colpicker"></aside>

  <div class="main">
    <div class="card filters-card" style="margin-bottom:12px;">
      <div id="filtersArea">
        <!-- ‚ûä –•–∞–± ‚Äî –≤–µ—Ä—Ö–Ω—ñ–π —Ñ—ñ–ª—å—Ç—Ä, –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Å–∞–º –∑–∞–ø–∏—Ç -->
<div class="row cols-2">
  <div>
    <label>–•–∞–±</label>
    <input id="hubFilter" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="hubsList" autocomplete="off">
    <datalist id="hubsList"></datalist>
  </div>
</div>
        <div class="row cols-2">
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –í—ñ–¥</label>
            <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
          </div>
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –î–æ</label>
            <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
          </div>
        </div>

        <div class="row cols-2" style="margin-top:12px;">
          <div>
            <label>–¢–∏–ø</label>
            <select id="routeType">
              <option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option>
              <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
              <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
              <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
            </select>
          </div>
          <div>
            <label>–û–Ω–æ–≤–ª–µ–Ω–æ: –∑ ‚Üí –ø–æ</label>
            <div class="row dates">
              <input id="dateFrom" type="date">
              <input id="dateTo" type="date">
            </div>
          </div>
        </div>



        <div class="row cols-4" style="margin-top:12px;">
          <div>
            <label>–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (—É –í—ñ–¥ –∞–±–æ –î–æ)</label>
            <select id="unitFilter"><option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option></select>
          </div>
          <div>
            <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –≤—ñ–¥</label>
            <input id="distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
          </div>
          <div>
            <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –¥–æ</label>
            <input id="distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
          </div>
          <div>
            <label>–õ–æ–≥—ñ—Å—Ç</label>
            <input id="logistFilter" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="logistsList" autocomplete="off">
            <datalist id="logistsList"></datalist>
            <div id="logistsMsg" class="warn" style="display:none;margin-top:4px"></div>
          </div>
        </div>

        <div id="testModeRow" class="row" style="margin-top:12px;display:none;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input id="testModeFilter" type="checkbox" style="width:auto;cursor:pointer;">
            <span style="font-size:14px;font-weight:500;">üß™ –¢—ñ–ª—å–∫–∏ —Ç–µ—Å—Ç–æ–≤—ñ –º–∞—Ä—à—Ä—É—Ç–∏ (isTest = true)</span>
          </label>
        </div>

        <div class="bar" style="margin-top:12px;">
          <button id="btnPreview" class="btn" disabled>üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
          <button id="btnExport" class="btn primary" disabled>üì• –ï–∫—Å–ø–æ—Ä—Ç —É Excel</button>
          <button id="btnRefresh" class="btn" disabled>üîÑ –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É</button>
          <button id="btnExportJson" class="btn">JSON (–≤–∏–¥–∏–º—ñ)</button>
          <button id="btnExportJsonAll" class="btn ghost" title="–î–æ–≤–∞–Ω—Ç–∞–∂–∏—Ç—å —É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —ñ –∑–±–µ—Ä–µ–∂–µ –≤ JSON">JSON (—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏)</button>
          <button id="btnExportKml" class="btn">KML (–≤–∏–¥–∏–º—ñ)</button>
          <button id="btnExportKmlAll" class="btn ghost" title="–î–æ–≤–∞–Ω—Ç–∞–∂–∏—Ç—å —É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —ñ –∑–±–µ—Ä–µ–∂–µ –≤ KML">KML (—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏)</button>
          <span class="muted">–ü–æ—Ä–æ–∂–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ = –Ω–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏. –Ø–∫—â–æ Firestore –ø–æ–ø—Ä–æ—Å–∏—Ç—å —ñ–Ω–¥–µ–∫—Å ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å, –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —ñ–∑ –∫–æ–Ω—Å–æ–ª—ñ.</span>
        </div>

        <datalist id="directoryList"></datalist>
      </div>
    </div>

   <div class="card results-card">
      <div class="bar" style="justify-content:space-between; margin-bottom:8px;">
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</strong>
        <span class="muted" id="countInfo">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª</span>
      </div>

      <div class="stats" id="statsInfo" style="display:none; margin-bottom:8px;">
        <div class="chip" id="statMax">–ù–∞–π–±—ñ–ª—å—à–∞: ‚Äî</div>
        <div class="chip" id="statMin">–ù–∞–π–º–µ–Ω—à–∞: ‚Äî</div>
        <div class="chip" id="statAvg">–°–µ—Ä–µ–¥–Ω—è: ‚Äî</div>
      </div>

      <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è / –¥—ñ—ó -->
      <div class="bar" id="moreBox" style="gap:6px; display:none; margin:6px 0 10px;">
        <button id="btnMore" class="btn sm">+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–µ</button>
        <button id="btnAll" class="btn sm">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å–µ</button>
        <button id="btnClearFilters" class="btn sm">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ñ</button>
        <button id="btnAutosize" class="btn sm">‚ÜîÔ∏è –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫</button>
        <button id="btnToggleMap" class="btn sm">üó∫Ô∏è –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–∞—Ä—Ç—É</button>
      </div>
<!-- –õ–∏–ø–∫–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª -->
<div id="xScroller"><div></div></div>

      <div class="table-wrap">
        <table id="resTable">
          <colgroup>
      <!-- 16+ –∫–æ–ª–æ–Ω–æ–∫ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –Ω–æ–≤–∏—Ö ¬´–°—Ç–∞—Ç—É—Å¬ª —ñ ¬´–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è¬ª -->
			<col class="col-hub">           <!-- –•–ê–ë -->
      <col class="col-unit">        <!-- –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª -->
      <col class="col-code">        <!-- –ö–æ–¥ –í—ñ–¥ -->
      <col class="col-code">        <!-- –ö–æ–¥ –î–æ -->
      <col>                           <!-- –í—ñ–¥ -->
      <col>                           <!-- –î–æ -->
      <col class="col-via">          <!-- –ü—Ä–æ–º—ñ–∂–Ω—ñ -->
            <col><col><col><col>            <!-- –í—ñ–¥—Å—Ç–∞–Ω—å, –¢–∏–ø, –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è, –õ–æ–≥—ñ—Å—Ç -->
            <col class="col-status"> <!-- –°—Ç–∞—Ç—É—Å -->
            <col>                     <!-- –¢–µ—Å—Ç -->
            <col>                     <!-- –î–∞—Ç–∞ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è -->
            <col>                     <!-- –î–∞—Ç–∞ –ó–º—ñ–Ω–∏ -->
            <col>                     <!-- –î–∞—Ç–∞ –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è -->
            <col class="col-comment"> <!-- –ü—Ä–∏—á–∏–Ω–∞ -->
            <col class="col-key"> <!-- –ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É -->
            <col class="col-id">  <!-- ID -->
            <col>                 <!-- –ö–∞—Ä—Ç–∞ -->
            <col>                 <!-- –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è -->
            <col class="col-navigator"> <!-- –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä -->
            <col>                 <!-- JSON -->
            <col class="col-delete"> <!-- –í–∏–¥–∞–ª–∏—Ç–∏ -->
          </colgroup>
<thead>
  <!-- –†—è–¥–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ -->
  <tr>
    <th class="sortable" data-sort="hub"           data-colkey="hub">–•–ê–ë <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="fromUnit"      data-colkey="unit">–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="fromCode"      data-colkey="fromCode">–ö–æ–¥ –í—ñ–¥ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="toCode"        data-colkey="toCode">–ö–æ–¥ –î–æ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="fromName"      data-colkey="fromName">–í—ñ–¥ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="toName"        data-colkey="toName">–î–æ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="viaNames"      data-colkey="via">–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="distance_km"   data-colkey="distance">–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="type"          data-colkey="type">–¢–∏–ø <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="purpose"       data-colkey="purpose">–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="logisticName"  data-colkey="logist">–õ–æ–≥—ñ—Å—Ç <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="statusLabel"   data-colkey="status">–°—Ç–∞—Ç—É—Å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="isTest"        data-colkey="testMode">–¢–µ—Å—Ç <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="createdAtRaw"  data-colkey="created">–î–∞—Ç–∞ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="updatedAtRaw"  data-colkey="changed">–î–∞—Ç–∞ –ó–º—ñ–Ω–∏ <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="decisionAtRaw" data-colkey="decided">–î–∞—Ç–∞ –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="rejectComment" data-colkey="comment">–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="routeKey"      data-colkey="routeKey">–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É <span class="s">‚Üï</span></th>
    <th class="sortable" data-sort="id"            data-colkey="id">ID <span class="s">‚Üï</span></th>
    <th data-colkey="map">–ö–∞—Ä—Ç–∞</th>
    <th data-colkey="review">–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è</th>
    <th data-colkey="navigator">–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä</th>
    <th data-colkey="json">JSON</th>
    <th data-colkey="delete">–í–∏–¥–∞–ª–∏—Ç–∏</th>
  </tr>

  <!-- –†—è–¥–æ–∫ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–±–µ–∑ –∑–º—ñ–Ω –ø–æ —Å—É—Ç—ñ) -->
  <tr class="filters">
    <th><input id="f_hub" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fHubsList"></th>
    <th><input id="f_unitFrom" type="text" placeholder="–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª‚Ä¶" list="fUnitsList"></th>
    <th><input id="f_fromCode" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fFromCodesList"></th>
    <th><input id="f_toCode" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fToCodesList"></th>
    <th><input id="f_fromName" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fFromNamesList"></th>
    <th><input id="f_toName" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fToNamesList"></th>
  <th><input id="f_via" type="text" placeholder="–ø—Ä–æ–º—ñ–∂–Ω—ñ‚Ä¶" list="fViaList"></th>
    <th>
      <div class="range">
        <input id="f_distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
        <input id="f_distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
      </div>
    </th>
    <th>
      <select id="f_type" title="–¢–∏–ø">
        <option value=""></option>
        <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
        <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
      </select>
    </th>
    <th><input id="f_purpose" type="text" placeholder="–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è‚Ä¶" list="fPurposeList"></th>
    <th><input id="f_logist" type="text" placeholder="–ª–æ–≥—ñ—Å—Ç‚Ä¶" list="fLogistsList"></th>
    <th>
      <select id="f_status" title="–°—Ç–∞—Ç—É—Å">
        <option value=""></option>
        <option>–ü–æ–≥–æ–¥–∂–µ–Ω–æ</option>
        <option>–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</option>
        <option>–û—á—ñ–∫—É—î</option>
      </select>
    </th>
    <th></th>
    <th>
      <div class="range">
        <input id="f_createdFrom" type="date" placeholder="–≤—ñ–¥">
        <input id="f_createdTo" type="date" placeholder="–¥–æ">
      </div>
    </th>
    <th>
      <div class="range">
        <input id="f_changedFrom" type="date" placeholder="–≤—ñ–¥">
        <input id="f_changedTo" type="date" placeholder="–¥–æ">
      </div>
    </th>
    <th>
      <div class="range">
        <input id="f_decidedFrom" type="date" placeholder="–≤—ñ–¥">
        <input id="f_decidedTo" type="date" placeholder="–¥–æ">
      </div>
    </th>
  <th><input id="f_comment" type="text" placeholder="–∫–æ–º–µ–Ω—Ç–∞—Ä‚Ä¶" list="fCommentsList"></th>
  <th><input id="f_routeKey" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fRouteKeysList"></th>
  <th><input id="f_id" type="text" placeholder="–ø–æ—à—É–∫‚Ä¶" list="fIdsList"></th>
    <th></th>  <!-- –¥–ª—è "–ö–∞—Ä—Ç–∞" -->
    <th></th>  <!-- –¥–ª—è "–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è" -->
    <th></th>  <!-- –¥–ª—è "–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä" -->
    <th></th>  <!-- –¥–ª—è "JSON" -->
    <th></th>  <!-- –¥–ª—è "–í–∏–¥–∞–ª–∏—Ç–∏" -->
  </tr>
</thead>
          <tbody></tbody>
        </table>
        <!-- –î–∏–Ω–∞–º—ñ—á–Ω—ñ —Å–ø–∏—Å–∫–∏ –ø—ñ–¥–∫–∞–∑–æ–∫ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —É —à–∞–ø—Ü—ñ —Ç–∞–±–ª–∏—Ü—ñ (–æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∑–∞ –≤–∏–¥–∏–º–∏–º–∏ —Ä—è–¥–∫–∞–º–∏) -->
        <datalist id="fHubsList"></datalist>
        <datalist id="fFromCodesList"></datalist>
        <datalist id="fToCodesList"></datalist>
        <datalist id="fFromNamesList"></datalist>
  <datalist id="fUnitsList"></datalist>
        <datalist id="fToNamesList"></datalist>
        <datalist id="fLogistsList"></datalist>
        <datalist id="fPurposeList"></datalist>
        <datalist id="fViaList"></datalist>
        <datalist id="fCommentsList"></datalist>
        <datalist id="fRouteKeysList"></datalist>
        <datalist id="fIdsList"></datalist>
      </div>
    </div>
  </div>

  <!-- –ù–∏–∂–Ω—ñ–π —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å–∫—Ä–æ–ª–±–∞—Ä -->
  <div id="bottomScroller"><div></div></div>

  <!-- Bottom map panel (initially hidden, lazy-loaded) -->
  <div id="mapPanel" class="map-panel" aria-hidden="true" role="region">
    <div class="map-resize" id="mapResizeHandle" title="–ü–µ—Ä–µ—Ç—è–≥–Ω–∏, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –≤–∏—Å–æ—Ç—É"></div>
    <div id="routeMap"></div>
  </div>
  <!-- Basemap style switcher (shown only when map is open) -->
  <div id="styleDockExport" class="style-dock export" title="–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏">
    <select id="mapStyleDockExport">
      <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
      <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
      <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
    </select>
    <div class="mapbox-brand">mapbox</div>
  </div>

<script>
/* === –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ === */
const MAP_URL = '/index.html';
const NAVIGATE_PAGE = '/navigate.html';
const DEFAULT_PROFILE = 'driving';
const REVIEW_PAGE = '/review.html';

/* === Inline Map (lazy Mapbox) === */
let _mapPanelOpen = false;
let _mapboxReady = false;
let _map = null;
let _selectedId = null;
let _tilesets = [];
let _tsFillIds = [];
let _tsOutlineIds = [];
let _tsHlFrom = [];
let _tsHlTo = [];

function loadMapboxOnce(){
  return new Promise((resolve, reject)=>{
    if (_mapboxReady){ resolve(); return; }
    // CSS
    const haveCss = !!document.querySelector('link[data-mapbox="1"]');
    if (!haveCss){
      const l = document.createElement('link');
      l.dataset.mapbox = '1';
      l.rel = 'stylesheet';
      l.href = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css';
      document.head.appendChild(l);
    }
    // JS
    if (window.mapboxgl){ _mapboxReady = true; resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
    s.async = true;
    s.onload = ()=>{ _mapboxReady = true; resolve(); };
    s.onerror = (e)=> reject(new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Mapbox GL JS'));
    document.head.appendChild(s);
  });
}

async function ensureMap(){
  await loadMapboxOnce();
  if (_map) return _map;
  const token = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
  if (!token) console.warn('APP_CONFIG.mapboxToken –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî –∫–∞—Ä—Ç–∞ –º–æ–∂–µ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—è.');
  try{ window.mapboxgl.accessToken = token; }catch(_){ }
  const el = document.getElementById('routeMap');
  _map = new window.mapboxgl.Map({
    container: el,
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [30.5, 50.45],
    zoom: 5
  });
  _map.addControl(new window.mapboxgl.NavigationControl({ showCompass:false }), 'top-right');
  _map.on('load', async ()=>{
    ensureOverlaySourcesAndLayers();
    // –î–æ—á–µ–∫–∞—Ç–∏—Å—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ALLOWED_HUBS (–∫–æ—Ä–æ—Ç–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ —è–∫—â–æ —â–µ null)
    if (ALLOWED_HUBS === null) { await new Promise(r=>setTimeout(r,150)); }
    await loadTilesetsForExport();
    applyUkrainianLabelsExport();
    // –¥–æ–¥–∞—Ç–∫–æ–≤–æ —Ñ–æ—Ä—Å—É—î–º–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ –ø—ñ—Å–ª—è –ø–µ—Ä–≤–∏–Ω–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∏–ª—é
    try { applyTilesetHubVisibilitySafe(); } catch(_){ }
  });
  _map.on('style.load', async ()=>{
    // re-add overlays and tilesets after style change
    ensureOverlaySourcesAndLayers();
    await loadTilesetsForExport();
    applyUkrainianLabelsExport();
  try { applyTilesetHubVisibilitySafe(); } catch(_){ }
    // redraw selection if exists
    if (_selectedId){
      const row = allRows.find(r=>r.id===_selectedId);
      if (row){ try{ await drawRouteOnMap(row); }catch(_){} }
    }
  });
  return _map;
}

function ensureOverlaySourcesAndLayers(){
  if (!_map) return;
  const addIf = (id, src)=>{ if (!_map.getSource(id)) _map.addSource(id, src); };
  addIf('route-line', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
  addIf('route-snap', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
  addIf('route-segs', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
  addIf('pts',        { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
  addIf('zones',      { type:'geojson', data:{ type:'FeatureCollection', features:[] } });

  const addLayerOnce = (def)=>{ if (!_map.getLayer(def.id)) _map.addLayer(def); };
  addLayerOnce({ id:'route-snap', type:'line', source:'route-snap', paint:{ 'line-color':'#ef4444', 'line-width':4 }});
  addLayerOnce({ id:'route-segs', type:'line', source:'route-segs', paint:{ 'line-color':'#ef4444', 'line-width':2, 'line-dasharray':[2,2] }});
  addLayerOnce({ id:'pts', type:'circle', source:'pts', paint:{ 'circle-radius':6, 'circle-color':['match',['get','kind'], 'start', '#22c55e', 'end', '#ef4444', '#64748b'], 'circle-stroke-width':2, 'circle-stroke-color':'#fff' }});
  addLayerOnce({ id:'zones-fill', type:'fill', source:'zones', paint:{ 'fill-color':'#fde68a', 'fill-opacity':0.25 }});
  addLayerOnce({ id:'zones-line', type:'line', source:'zones', paint:{ 'line-color':'#f59e0b', 'line-width':2 }});
}

async function loadTilesetsForExport(){
  if (!_map) return;
  // 1) –°–ø—Ä–æ–±–∞ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ –∑ Firestore (config/tilesets)
  if (!_tilesets.length){
    try {
      const fsDoc = await firebase.firestore().collection('config').doc('tilesets').get({ source:'server' });
      if (fsDoc.exists){
        const data = fsDoc.data() || {};
        if (Array.isArray(data.tilesets)) _tilesets = data.tilesets;
        else if (Array.isArray(data)) _tilesets = data;
      }
    } catch(e){ console.warn('Firestore tilesets –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π:', e?.message||e); }
  }
  // 2) –§–æ–ª–±–µ–∫ –Ω–∞ —Å—Ç–∞—Ç–∏—á–Ω–∏–π JSON
  if (!_tilesets.length){
    try {
      const r = await fetch('/config/tilesets.json?v=' + Date.now(), { cache:'no-cache' });
      const json = await r.json();
      if (Array.isArray(json)) _tilesets = json; else if (json && Array.isArray(json.tilesets)) _tilesets = json.tilesets; else _tilesets = [];
    } catch(e){ console.warn('tilesets.json error:', e?.message||e); }
  }

  // –Ø–∫—â–æ —â–µ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ ‚Äî —Å–ø—Ä–æ–±—É—î–º–æ –ø—ñ–¥—Ö–æ–ø–∏—Ç–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏ –∑ window
  try{
    if (!Array.isArray(ALLOWED_HUBS)){
      const hubsNow = Array.isArray(window.__userHubs) ? window.__userHubs.slice() : (Array.isArray(allowedHubs) ? allowedHubs.slice() : []);
      const allNow  = !!(window.__userAllHubs ?? allowAllHubs);
      ALLOWED_HUBS = allNow ? [] : hubsNow;
    }
  }catch(_){ }

  _tsFillIds = []; _tsOutlineIds = []; _tsHlFrom = []; _tsHlTo = [];
  for (const ts of _tilesets){
    if (ts.enabled === false) continue;
    const srcId = `geozones-tileset-${ts.key}`;
    if (!_map.getSource(srcId)){
      _map.addSource(srcId, { type:'vector', url: ts.url });
    }
    const fillId = `tileset-fill-${ts.key}`;
    const outlineId = `tileset-outline-${ts.key}`;
    if (!_map.getLayer(fillId)){
      _map.addLayer({ id: fillId, type:'fill', source: srcId, 'source-layer': ts.layer, paint:{ 'fill-color':'#22c55e','fill-opacity':0.15 } });
    }
    if (!_map.getLayer(outlineId)){
      _map.addLayer({ id: outlineId, type:'line', source: srcId, 'source-layer': ts.layer, paint:{ 'line-color':'#16a34a','line-width':1.0 } });
    }
    const hlFrom = `tileset-hl-from-${ts.key}`;
    const hlTo   = `tileset-hl-to-${ts.key}`;
    if (!_map.getLayer(hlFrom)){
      _map.addLayer({ id: hlFrom, type:'fill', source: srcId, 'source-layer': ts.layer, filter:['==',['get','__never__'],1], paint:{ 'fill-color':'#3b82f6','fill-opacity':0.45 } });
    }
    if (!_map.getLayer(hlTo)){
      _map.addLayer({ id: hlTo, type:'fill', source: srcId, 'source-layer': ts.layer, filter:['==',['get','__never__'],1], paint:{ 'fill-color':'#f43f5e','fill-opacity':0.45 } });
    }
    _tsFillIds.push(fillId); _tsOutlineIds.push(outlineId); _tsHlFrom.push(hlFrom); _tsHlTo.push(hlTo);

    // –†–µ—î—Å—Ç—Ä—É—î–º–æ –∫–ª—ñ–∫ –ø–æ –≥–µ–æ–∑–æ–Ω–∞—Ö –¥–ª—è –ø–æ–∫–∞–∑—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
    try { registerGeozoneInfoHandlers(ts, [fillId, hlFrom, hlTo]); } catch(_) {}
  }

  // –ó–∞—Å—Ç–æ—Å—É—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –≥–µ–æ–∑–æ–Ω –∑–∞ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–º–∏ —Ö–∞–±–∞–º–∏
  try { applyTilesetHubVisibilitySafe(); } catch(_) {}
}

// ======= –ü–æ–ø–∞–ø –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –≥–µ–æ–∑–æ–Ω—É (—Ç—ñ–ª—å–∫–∏ –∑–∞ –∫–ª—ñ–∫–æ–º; –±–µ–∑ –ø—ñ–¥–ø–∏—Å—ñ–≤) =======
const _gzHandlersBound = new Set();
let _gzPopup = null;

function pickProp(props, keys){
  for (const k of keys){
    const v = props?.[k];
    if (v === 0) return '0';
    if (v !== undefined && v !== null && String(v).trim() !== '') return String(v);
  }
  return '';
}

function formatGeozonePopupHTML(props, tilesetKey){
  const name = pickProp(props, ['Name','name','–ù–∞–∑–≤–∞','–ù–∞–∑–≤–∞ –ø–æ–ª—è','field','–ü–æ–ª–µ']);
  const code = pickProp(props, ['Code','code','–ö–æ–¥','field_code','fieldCode']);
  const hub  = pickProp(props, ['Hub','hub','–•–∞–±','hubs']);
  const area = pickProp(props, ['Area','area','–ü–ª–æ—â–∞','Area_ha','area_ha','–ü–ª–æ—â–∞_–≥–∞']);
  const rows = [];
  if (name) rows.push(`<tr><td>üìç –ù–∞–∑–≤–∞</td><td>${escapeHtml(name)}</td></tr>`);
  if (code) rows.push(`<tr><td>üî¢ –ö–æ–¥</td><td>${escapeHtml(code)}</td></tr>`);
  if (hub)  rows.push(`<tr><td>üè¢ –•–∞–±</td><td>${escapeHtml(hub)}</td></tr>`);
  if (area) rows.push(`<tr><td>üìê –ü–ª–æ—â–∞</td><td>${escapeHtml(area)}</td></tr>`);
  if (tilesetKey) rows.push(`<tr><td>üóÇÔ∏è Tileset</td><td style="font-size:12px;color:#6b7280;">${escapeHtml(tilesetKey)}</td></tr>`);
  const table = rows.length ? `<table class="gz-info"><tbody>${rows.join('')}</tbody></table>` : '<div style="padding:12px;color:#9ca3af;text-align:center;">–ù–µ–º–∞—î –≤—ñ–¥–æ–º–∏—Ö –ø–æ–ª—ñ–≤</div>';
  return `
    <div class="gz-popup">
      ${table}
      <details>
        <summary>üîç –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ</summary>
        <pre>${escapeHtml(JSON.stringify(props, null, 2))}</pre>
      </details>
    </div>`;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

function registerGeozoneInfoHandlers(ts, ids){
  if (!_map) return;
  ids.forEach(id => {
    if (_gzHandlersBound.has(id)) return;
    _gzHandlersBound.add(id);
    try{
      _map.on('mouseenter', id, ()=>{ _map.getCanvas().style.cursor = 'pointer'; });
      _map.on('mouseleave', id, ()=>{ _map.getCanvas().style.cursor = ''; });
      _map.on('click', id, (e)=>{
        const f = e?.features && e.features[0];
        if (!f) return;
        const html = formatGeozonePopupHTML(f.properties || {}, ts.key);
        try { if (_gzPopup) _gzPopup.remove(); } catch(_){ }
        _gzPopup = new window.mapboxgl.Popup({ 
          closeButton: true, 
          closeOnClick: true, 
          maxWidth: '400px',
          className: 'geozone-popup'
        })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(_map);
      });
    }catch(_){ }
  });
}

// ---- –•–∞–±-—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è tilesets (—ñ–¥–µ–Ω—Ç–∏—á–Ω–æ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ) ----
let ALLOWED_HUBS = null; // null –∞–±–æ [] => –≤—Å—ñ —Ö–∞–±–∏
function isAllHubs(){
  return !Array.isArray(ALLOWED_HUBS) || ALLOWED_HUBS.length === 0;
}
function tilesetAllowedForUser(ts){
  const tags = Array.isArray(ts.hubs) ? ts.hubs : [];
  if (!tags.length || tags.includes('*')) return true;
  if (isAllHubs()) return true;
  return tags.some(h => (ALLOWED_HUBS || []).includes(h));
}
function applyTilesetHubVisibility(){
  if (!_map || !_tilesets || !_tilesets.length) return;
  try { console.log('[HUB DEBUG] ALLOWED_HUBS =', ALLOWED_HUBS); } catch(_){ }
  let anyAllowed = false;
  _tilesets.forEach(ts => {
    const allowed = tilesetAllowedForUser(ts);
    const vis = allowed ? 'visible' : 'none';
    try { console.log('[HUB DEBUG] tileset', ts.key, 'hubs=', ts.hubs, '=> allowed?', allowed); } catch(_){ }
    if (allowed) anyAllowed = true;
    const ids = [
      `tileset-fill-${ts.key}`,
      `tileset-outline-${ts.key}`,
      `tileset-hl-from-${ts.key}`,
      `tileset-hl-to-${ts.key}`,
    ];
    ids.forEach(id => { if (_map.getLayer(id)) { try{ _map.setLayoutProperty(id, 'visibility', vis); }catch(_){} } });
  });
  // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Å–∏—Ç—É–∞—Ü—ñ—ó, –∫–æ–ª–∏ –≤—Å—ñ —à–∞—Ä–∏ –≤–∏—è–≤–∏–ª–∏—Å—å –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–º–∏ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ —Ö–∞–±–∏
  if (!anyAllowed) {
    try { console.warn('[HUB DEBUG] None of tilesets allowed by hubs. Falling back to show all for visibility.'); } catch(_){ }
    _tilesets.forEach(ts => {
      const ids = [
        `tileset-fill-${ts.key}`,
        `tileset-outline-${ts.key}`,
        `tileset-hl-from-${ts.key}`,
        `tileset-hl-to-${ts.key}`,
      ];
      ids.forEach(id => { if (_map.getLayer(id)) { try{ _map.setLayoutProperty(id, 'visibility', 'visible'); }catch(_){} } });
    });
  }
}
function applyTilesetHubVisibilitySafe(){
  try {
    if (!_map || !_map.isStyleLoaded || !_map.isStyleLoaded()){
      _map?.once('style.load', applyTilesetHubVisibility);
      return;
    }
  } catch(_) {}
  applyTilesetHubVisibility();
}

function anyPropEqualsExpr(propList, value){
  const clauses = propList.map(k => ['==',['get',k], value]);
  if (clauses.length === 0) return ['==',['get','__never__'],1];
  if (clauses.length === 1) return clauses[0];
  return ['any', ...clauses];
}

function updateGeozoneHighlights(row){
  if (!_map) return;
  const propsToTry = ['Name','name','–ù–∞–∑–≤–∞','–ù–∞–∑–≤–∞ –ø–æ–ª—è','Code','code','–ö–æ–¥'];
  const fromVals = [row.fromName, row.fromCode].filter(Boolean);
  const toVals   = [row.toName, row.toCode].filter(Boolean);
  const fromExpr = fromVals.length ? ['any', ...fromVals.map(v => anyPropEqualsExpr(propsToTry, v))] : ['==',['get','__never__'],1];
  const toExpr   = toVals.length ? ['any', ...toVals.map(v => anyPropEqualsExpr(propsToTry, v))]   : ['==',['get','__never__'],1];
  for (const id of _tsHlFrom){ try{ _map.setFilter(id, fromExpr); }catch(_){ } }
  for (const id of _tsHlTo){   try{ _map.setFilter(id, toExpr); }catch(_){ } }
}

function applyUkrainianLabelsExport(){
  if (!_map) return;
  const style = _map.getStyle();
  if (!style || !style.layers) return;
  // –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø–æ–ª—ñ–≤
  const ukExpr = [
    'coalesce', ['get','name_uk'], ['get','name:uk'], ['get','name_ua'], ['get','name:ua'], ['get','name_local'], ['get','name']
  ];
  const skip = new Set([
    'route-snap','route-segs','pts','zones-fill','zones-line'
  ]);
  style.layers.forEach(l => {
    if (l.type !== 'symbol') return;
    if (skip.has(l.id)) return;
    const has = _map.getLayoutProperty(l.id, 'text-field') !== undefined;
    if (!has) return;
    try { _map.setLayoutProperty(l.id, 'text-field', ukExpr); } catch(_){ }
  });
}

function openMapPanel(open){
  const panel = document.getElementById('mapPanel');
  _mapPanelOpen = open;
  if (open){
    panel.classList.add('open');
    panel.setAttribute('aria-hidden','false');
    document.body.classList.add('map-open');
    if (btnToggleMap) btnToggleMap.textContent = 'üó∫Ô∏è –°—Ö–æ–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É';
    // slight delay to resize after visible
    setTimeout(()=>{ try{ _map && _map.resize(); }catch(_){ } }, 120);
  } else {
    panel.classList.remove('open');
    panel.setAttribute('aria-hidden','true');
    document.body.classList.remove('map-open');
    if (btnToggleMap) btnToggleMap.textContent = 'üó∫Ô∏è –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–∞—Ä—Ç—É';
  }
}

const MAP_H_KEY = 'export.mapPanelHeight.v1';
function setMapHeight(px){
  const min = Math.max(160, Math.round(window.innerHeight * 0.2)); // >=20vh
  const max = Math.max(min+40, Math.round(window.innerHeight * 0.9)); // <=90vh
  const clamped = Math.min(max, Math.max(min, Math.round(px)));
  document.documentElement.style.setProperty('--map-h', clamped + 'px');
  try{ localStorage.setItem(MAP_H_KEY, String(clamped)); }catch(_){ }
  try{ _map && _map.resize(); }catch(_){ }
}

function createCircle(lon, lat, radiusM, steps=64){
  const R = 6371000; // meters
  const coords = [];
  for (let i=0;i<=steps;i++){
    const brng = (i/steps) * 2*Math.PI;
    const lat1 = lat * Math.PI/180;
    const lon1 = lon * Math.PI/180;
    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(radiusM/R) + Math.cos(lat1)*Math.sin(radiusM/R)*Math.cos(brng));
    const lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(radiusM/R)*Math.cos(lat1), Math.cos(radiusM/R)-Math.sin(lat1)*Math.sin(lat2));
    coords.push([lon2*180/Math.PI, lat2*180/Math.PI]);
  }
  return coords;
}

function feature(type, coords, props){
  return { type:'Feature', geometry:{ type, coordinates:coords }, properties: props || {} };
}

function bboxOfFeatures(features){
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  function visit(coord){ const x=coord[0], y=coord[1]; if (x<minX)minX=x; if (y<minY)minY=y; if (x>maxX)maxX=x; if (y>maxY)maxY=y; }
  for (const f of features||[]){
    const g=f.geometry; if (!g) continue;
    const t=g.type; const c=g.coordinates;
    if (t==='Point') visit(c);
    else if (t==='LineString') c.forEach(visit);
    else if (t==='Polygon') c.flat().forEach(visit);
    else if (t==='MultiLineString') c.flat().forEach(visit);
    else if (t==='MultiPolygon') c.flat(2).forEach(visit);
  }
  if (!Number.isFinite(minX)) return null;
  return [[minX,minY],[maxX,maxY]];
}

function setGeoJSON(id, fc){ try{ const s=_map.getSource(id); if (s) s.setData(fc); }catch(_){ } }

function buildZonesForRow(raw, start, end){
  const feats = [];
  const tryPoly = (val, prop) => {
    if (!val) return;
    // accept Polygon/MultiPolygon, or array of points (closed automatically if not)
    try{
      if (val.type==='Feature' && val.geometry){ return tryPoly(val.geometry, prop); }
      if (val.type==='Polygon' || val.type==='MultiPolygon'){ feats.push(feature(val.type, val.coordinates, prop)); return; }
      if (Array.isArray(val) && Array.isArray(val[0]) && typeof val[0][0] !== 'number'){
        // nested rings
        feats.push(feature('Polygon', val, prop)); return;
      }
    }catch(_){ }
  };
  tryPoly(raw?.startZone, { which:'start' });
  tryPoly(raw?.endZone,   { which:'end' });
  tryPoly(raw?.geofenceStart, { which:'start' });
  tryPoly(raw?.geofenceEnd,   { which:'end' });
  return feats;
}

async function drawRouteOnMap(row){
  await ensureMap();
  const d = row.raw || {};
  // route line
  const savedPts = normalizePoints(d.routeGeometry);
  const pts = savedPts || normalizePoints(d.points) || normalizePoints(d.coordinates) || normalizePoints(d.route) || normalizePoints(d.geojson) || normalizePoints(d.geometry);
  let points = pts;
  if (!points || points.length < 2){
    const parts = [];
    if (d.start){ const p = toLonLat(d.start); if (p) parts.push(p); }
    if (Array.isArray(d.midpoints)) for (const m of d.midpoints){ const p=toLonLat(m); if (p) parts.push(p); }
    if (d.end){ const p = toLonLat(d.end); if (p) parts.push(p); }
    if (parts.length>=2) points = parts;
  }
  const segs = normalizeSegments(d) || [];
  const start = points && points.length ? points[0] : (d.start ? toLonLat(d.start) : null);
  const end   = points && points.length ? points[points.length-1] : (d.end ? toLonLat(d.end) : null);

  const lineFC = { type:'FeatureCollection', features: points && points.length>=2 ? [feature('LineString', points, { kind:'route' })] : [] };
  const segFC  = { type:'FeatureCollection', features: segs.map(s => feature('LineString', s, { kind:'segment' })) };
  const ptsFC  = { type:'FeatureCollection', features: [] };
  if (start) ptsFC.features.push(feature('Point', start, { kind:'start' }));
  if (end)   ptsFC.features.push(feature('Point', end,   { kind:'end' }));
  const zonesFC = { type:'FeatureCollection', features: buildZonesForRow(d, start, end) };

  // Try to snap to roads using Mapbox Directions if feasible
  try{
    if (!savedPts && points && points.length >= 2){
      const snapped = await fetchSnappedRoute(points);
      const snapCoords = snapped || points; // —è–∫—â–æ Directions –Ω–µ –¥–∞–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –º–∞–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ —Ç–æ—á–∫–∏, –∞–ª–µ —Ç—ñ–ª—å–∫–∏ —É snap-—à–∞—Ä—ñ
      const snapFC = (snapCoords && snapCoords.length>=2)
        ? { type:'FeatureCollection', features:[ feature('LineString', snapCoords, { kind:'snap' }) ] }
        : { type:'FeatureCollection', features:[] };
      setGeoJSON('route-snap', snapFC);
    } else {
      setGeoJSON('route-snap', { type:'FeatureCollection', features:[] });
    }
  }catch(e){ console.warn('snap error:', e); setGeoJSON('route-snap', { type:'FeatureCollection', features:[] }); }
  setGeoJSON('route-segs', segFC);
  setGeoJSON('pts', ptsFC);
  setGeoJSON('zones', zonesFC);
  // highlight external tileset zones by from/to
  try{ updateGeozoneHighlights(row); }catch(_){ }

  // Fit bounds
  // –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç ‚Äî snapped –ª—ñ–Ω—ñ—è; —è–∫—â–æ –ø–æ—Ä–æ–∂–Ω—è, –±–µ—Ä–µ–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É
  let forBbox = [];
  try { const s = _map.getSource('route-snap'); const dta = s ? s._data || s._options?.data : null; if (dta && dta.features) forBbox = forBbox.concat(dta.features); } catch(_){ }
  if (!forBbox.length) forBbox = forBbox.concat(lineFC.features);
  const allForBbox = [...forBbox, ...segFC.features, ...ptsFC.features, ...zonesFC.features];
  const b = bboxOfFeatures(allForBbox);
  if (b){
    try{ _map.fitBounds(b, { padding: 40, maxZoom: 14, duration: 500 }); }catch(_){ }
  }
}

function selectRowVisual(id){
  _selectedId = id;
  document.querySelectorAll('#resTable tbody tr').forEach(tr => tr.classList.remove('is-selected'));
  const tr = document.querySelector(`#resTable tbody tr[data-id="${CSS.escape(id)}"]`);
  if (tr) tr.classList.add('is-selected');
}

async function fetchSnappedRoute(points){
  try{
    if (!Array.isArray(points) || points.length < 2) return null;
    const token = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
    if (!token) return null;
    // Limit waypoints to avoid API limits (max 25)
    const capped = points.slice(0, 25);
    const coords = capped.map(([lon,lat]) => `${lon},${lat}`).join(';');
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&access_token=${encodeURIComponent(token)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`Directions ${r.status}`);
    const j = await r.json();
    const geom = j && j.routes && j.routes[0] && j.routes[0].geometry;
    if (geom && geom.type === 'LineString' && Array.isArray(geom.coordinates)) return geom.coordinates;
    return null;
  }catch(e){ console.warn('Directions API error:', e); return null; }
}

/* --- –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä --- */
window.addEventListener('error', (e) => {
  console.error('Global error:', e.message, 'at', e.filename, e.lineno);
  try { document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞'; } catch(_) {}
});

const statusEl = document.getElementById('status');
let db = null, auth = null;
let currentUser = null;
let currentRole = null;
let allowedHubs = [];     // ‚Üê –º–∞—Å–∏–≤ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö —Ö–∞–±—ñ–≤
let allowAllHubs = false; // ‚Üê –ø—Ä–∞–ø–æ—Ä ¬´–≤—Å—ñ —Ö–∞–±–∏¬ª
/* === 2.2 –ö–µ—à —Ä–æ–ª—ñ/—Ö–∞–±—ñ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ –≥–æ–ª–æ–≤–Ω—É (index.html) === */
function cacheRoleAndHubs(){
  try{
    const payload = JSON.stringify({
      uid:  String(currentUser?.uid || ''),
      role: String(window.__userRole ?? currentRole ?? ''),
      hubs: Array.isArray(window.__userHubs) ? window.__userHubs : (allowedHubs || []),
      all:  !!(window.__userAllHubs ?? allowAllHubs),
      ts:   Date.now()
    });
    // sessionStorage –º–æ–∂–µ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–∏—Å—è —É –Ω–æ–≤—É –≤–∫–ª–∞–¥–∫—É —É –≤—Å—ñ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö/—Ä–µ–∂–∏–º–∞—Ö,
    // —Ç–æ–º—É –¥—É–±–ª—é—î–º–æ –≤ localStorage (–∫–æ—Ä–æ—Ç–∫–∏–π TTL –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è –Ω–∞ /index).
    try { sessionStorage.setItem('role.cache.v1', payload); } catch(_){ }
    try { localStorage.setItem('role.cache.v1', payload); } catch(_){ }
  }catch(_){}
}

// –ö–µ—à –º–∞—Ä—à—Ä—É—Ç—É –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –Ω–∞ /index.html?rid=...
function cacheRouteForOpen(rid){
  try{
    if (!rid) return;
    const row = (Array.isArray(allRows) ? allRows : []).find(r => String(r?.id||'') === String(rid));
    if (!row) return;
    const d = row.raw || {};
    const data = {
      // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä—É/—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π
      fromCode: d.fromCode || row.fromCode || '',
      toCode:   d.toCode   || row.toCode   || '',
      fromLabel: d.fromLabel || row.fromName || '',
      toLabel:   d.toLabel   || row.toName   || '',
      fromName: row.fromName || d.fromName || '',
      toName:   row.toName   || d.toName   || '',
      hub: d.hub || row.hub || '',
      routeType: d.routeType || row.type || '–û—Å–Ω–æ–≤–Ω–∏–π',
      purpose: (d.purpose || d.routePurpose || row.purpose || ''),
      intermediateText: d.intermediateText || '',
      logisticId: d.logisticId || row.logisticId || '',
      logisticName: d.logisticName || row.logisticName || '',
      createdAt: d.createdAt || null,
      updatedAt: d.updatedAt || null,
      distance_km: (typeof d.distance_km === 'number') ? d.distance_km : row.distance_km,
      routeKey: d.routeKey || row.routeKey || '',
      name: d.name || '',
      approval: d.approval || null,
      proposal: d.proposal || null,
      points: d.points || [],
      startRuler: d.startRuler || [],
      endRuler: d.endRuler || []
    };
    const payload = {
      uid: String(currentUser?.uid || ''),
      rid: String(rid),
      ts: Date.now(),
      data
    };
    try { localStorage.setItem('open.route.cache.v1', JSON.stringify(payload)); } catch(_){ }
  }catch(_){ }
}

/* –ü–µ—Ä–µ—Ö–æ–ø–ª—é—î–º–æ –±—É–¥—å-—è–∫—ñ –∫–ª—ñ–∫–∏ –ø–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è—Ö –Ω–∞ –≥–æ–ª–æ–≤–Ω—É,
   —â–æ–± —Å–ø–æ—á–∞—Ç–∫—É –∑–∞–∫–µ—à—É–≤–∞—Ç–∏ —Ä–æ–ª—å/—Ö–∞–±–∏, –∞ –≤–∂–µ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏. */
document.addEventListener('click', (e) => {
  const a = e.target.closest('a[href]');
  if (!a) return;

  const href = a.getAttribute('href') || '';
  const isMain = href === '/' || href === '/index.html' || href.startsWith('/index.html?');
  if (!isMain) return;

  e.preventDefault();
  cacheRoleAndHubs();

  // –Ø–∫—â–æ —Ü–µ –ª—ñ–Ω–∫ –≤–∏–¥—É /index.html?rid=... ‚Äî –∑–∞–∫–µ—à—É—î–º–æ —Å–∞–º –º–∞—Ä—à—Ä—É—Ç,
  // —â–æ–± —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ –≤—ñ–Ω –∑'—è–≤–∏–≤—Å—è –º–∏—Ç—Ç—î–≤–æ –±–µ–∑ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è Firestore.
  try{
    const url = new URL(a.href, location.origin);
    const rid = url.searchParams.get('rid');
    if (rid) cacheRouteForOpen(rid);
  }catch(_){ }

  if (a.target === '_blank') {
    window.open(a.href, '_blank');
  } else {
    location.href = a.href;
  }
}, true);

try {
  // –î–æ–¥–∞—Ç–æ–∫ —É–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ guard-—Å–∫—Ä–∏–ø—Ç–æ–º –≤–∏—â–µ
  const app = firebase.app();
  db = firebase.firestore();
  auth = firebase.auth();

  statusEl.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
  // –æ—Ñ–ª–∞–π–Ω-–∫–µ—à
  db.enablePersistence({ synchronizeTabs: true }).catch((e) => {
    console.warn('Persistence off:', e.code || e.message);
  });
} catch (e) {
  console.error('Init error:', e);
  statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
}

/* ---------- Auth UI ---------- */
const authInfo = document.getElementById('authInfo');
const authRoleBadge = document.getElementById('authRole');
const btnLogout = document.getElementById('btnLogout');
const btnPreview = document.getElementById('btnPreview');
const btnExport  = document.getElementById('btnExport');
const btnRefresh = document.getElementById('btnRefresh');
const btnMore    = document.getElementById('btnMore');
const btnAll     = document.getElementById('btnAll');
const btnClearFilters = document.getElementById('btnClearFilters');
const btnAutosize = document.getElementById('btnAutosize');
const btnExportJson     = document.getElementById('btnExportJson');
const btnExportJsonAll  = document.getElementById('btnExportJsonAll');
const btnToggleMap = document.getElementById('btnToggleMap');
const mapResizeHandle = document.getElementById('mapResizeHandle');

function setBusy(b){
  btnPreview.disabled = b || !currentUser;
  btnExport.disabled  = b || !currentUser;
  btnRefresh.disabled = b || !currentUser;
  btnExportJson.disabled    = b || !currentUser;
btnExportJsonAll.disabled = b || !currentUser;
  if (btnMore) btnMore.disabled = b;
  if (btnAll)  btnAll.disabled  = b;
  if (btnClearFilters) btnClearFilters.disabled = b;
  if (btnAutosize) btnAutosize.disabled = b;
  statusEl.textContent = b ? '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è‚Ä¶' : (currentUser ? '–ì–æ—Ç–æ–≤–æ' : '–£–≤—ñ–π–¥—ñ—Ç—å');
}

btnLogout.addEventListener('click', async () => { try{ await auth.signOut(); }catch(e){ console.warn(e); } });

// üîë –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ (–æ—Å–Ω–æ–≤–Ω–∞ –∞–±–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∞)
function userHasRole(checkRole) {
  const primary = (window.__userRole || currentRole || '').toLowerCase();
  const additional = window.__userAdditionalRoles || [];
  return primary === checkRole || additional.includes(checkRole);
}

// –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ö–∞–±–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–∞–Ω–∞–ª–æ–≥ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
async function getAllowedHubsForUser(uid, role){
  try{
    const r = String(role||'').toLowerCase();
    const snap = await firebase.firestore().collection('users').doc(uid).get({ source: 'server' });
    const d = snap.exists ? (snap.data() || {}) : {};
    const additionalRoles = Array.isArray(d.additionalRoles) ? d.additionalRoles : []; // üîë –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–æ–ª—ñ
    
    let hubs = [];
    // üîë admin, security –∞–±–æ –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ—é —Ä–æ–ª–ª—é security –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö —Ö–∞–±—ñ–≤
    if (r === 'admin' || r === 'security' || additionalRoles.includes('security')) hubs = [];
    else if (Array.isArray(d.allowedHubs) && d.allowedHubs.length) hubs = d.allowedHubs.slice(0,10);
    else if (Array.isArray(d.hubs) && d.hubs.length) hubs = d.hubs.slice(0,10);
    else if (typeof d.hub === 'string' && d.hub.trim()) hubs = [d.hub.trim()];
    else if (typeof d.hubAccess === 'string' && d.hubAccess.trim()) hubs = [d.hubAccess.trim()];
    
    const displayName = (d.displayName && typeof d.displayName === 'string' && d.displayName.trim())
      ? d.displayName.trim()
      : '';
    
    return { hubs, displayName };
  }catch(e){ console.warn('getAllowedHubsForUser(export):', e?.message||e); return { hubs: [], displayName: '' }; }
}

auth?.onAuthStateChanged(async (u) => {
  currentUser = u || null;
  if (!u){
    const next = encodeURIComponent(location.pathname + location.search);
    location.replace(`/login.html?next=${next}`);
    return;
  }

  currentRole   = window.__userRole || 'pending';
  let displayNameFromFirestore = '';
  try {
    const result = await getAllowedHubsForUser(u.uid, currentRole);
    const hubsSrv = result.hubs || [];
    displayNameFromFirestore = result.displayName || '';
    ALLOWED_HUBS = hubsSrv;
    allowedHubs  = Array.isArray(hubsSrv) ? hubsSrv.slice() : [];
    allowAllHubs = !Array.isArray(ALLOWED_HUBS) || ALLOWED_HUBS.length === 0;
    applyTilesetHubVisibilitySafe();
  } catch(_) {
    allowedHubs  = Array.isArray(window.__userHubs) ? window.__userHubs.slice() : [];
    allowAllHubs = !!window.__userAllHubs;
    ALLOWED_HUBS = allowAllHubs ? [] : allowedHubs.slice();
    try { applyTilesetHubVisibilitySafe(); } catch(_) {}
  }
  fillHubsList();

  {
    const dn = displayNameFromFirestore
      || (u && typeof u.displayName === 'string' && u.displayName.trim())
      || (`–•—Ç–æ—Å—å –Ω–µ –º—ñ—Å—Ü–µ–≤–∏–π —ñ ${u.email || u.uid}`);
    authInfo.textContent = `–£–≤—ñ–π—à–ª–∏ —è–∫ ${dn}`;
  }
  btnLogout.style.display = '';
  authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`;
  authRoleBadge.style.display = '';
  setBusy(false);

  // üîë –ü–æ–∫–∞–∑—É—î–º–æ —á–µ–∫–±–æ–∫—Å "–¢—ñ–ª—å–∫–∏ —Ç–µ—Å—Ç–æ–≤—ñ –º–∞—Ä—à—Ä—É—Ç–∏" —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞
  if (userHasRole('admin')) {
    const testModeRow = document.getElementById('testModeRow');
    if (testModeRow) testModeRow.style.display = '';
  }

  const syncRoleAndRerender = () => {
  const r = String(window.__userRole || '').toLowerCase();
  if (r && r !== currentRole) {
    currentRole = r;
    try { authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`; } catch(_) {}
  }
  const hubsNow  = Array.isArray(window.__userHubs) ? window.__userHubs : [];
  // –Ø–∫—â–æ –ø—Ä–∏—Å–ª–∞–ª–∏ –ù–ï–ø–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤ —Ö–∞–±—ñ–≤ ‚Äî –æ–Ω–æ–≤–∏–º–æ ALLOWED_HUBS –Ω–∏–º (–±–µ–∑ –ø—Ä–∞–ø–æ—Ä–∞ all)
  if (hubsNow.length && JSON.stringify(hubsNow) !== JSON.stringify(allowedHubs)) {
    allowedHubs  = hubsNow.slice();
    allowAllHubs = false;
    ALLOWED_HUBS = hubsNow.slice();
  }

  try { fillHubsList(); } catch(_) {}
  try { reRender(); } catch(_) {}
  // –æ–Ω–æ–≤–∏–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –≥–µ–æ–∑–æ–Ω –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–ª—ñ/—Ö–∞–±—ñ–≤
  try { applyTilesetHubVisibilitySafe(); } catch(_){ }
};
  syncRoleAndRerender();
  setTimeout(syncRoleAndRerender, 100);

  try { await Promise.all([loadDirectory(), loadLogists(true)]); }
  catch (e) { console.warn(e); }
});

/* ---------- –î–æ–≤—ñ–¥–Ω–∏–∫ ---------- */
const dirByCode = {}, codeByName = {}; const unitsSet = new Set();
const DIR_CACHE_KEY = 'export.directoryCache.v1';
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  const unitSelect = document.getElementById('unitFilter');
  list.innerHTML = '';
  unitSelect.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
  unitsSet.clear();
  Object.keys(dirByCode).forEach(k=>delete dirByCode[k]);
  Object.keys(codeByName).forEach(k=>delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit, isTest } = r;
    dirByCode[code] = { name, company, unit, isTest };
    if(!(name in codeByName)) codeByName[name]=code;
    if (unit) unitsSet.add(unit);
    const opt = document.createElement('option');
    opt.value = name; opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }
  Array.from(unitsSet).sort((a,b)=>a.localeCompare(b,'uk')).forEach(u=>{
    const o=document.createElement('option'); o.value=u; o.textContent=u; unitSelect.appendChild(o);
  });
}

async function loadDirectory(forceServer){
  if (!db || !currentUser) return;

  // –†–∞–Ω—ñ—à–µ –º–∏ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–ª–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫ –∑–∞ —Ö–∞–±–∞–º–∏ –¥–ª—è –ª–æ–≥—ñ—Å—Ç–∞. –¶–µ –ø—Ä–∏–∑–≤–æ–¥–∏–ª–æ –¥–æ –ø—Ä–æ–≥–∞–ª–∏–Ω,
  // —è–∫—â–æ —É –¥–µ—è–∫–∏—Ö –∑–∞–ø–∏—Å–∞—Ö directory –≤—ñ–¥—Å—É—Ç–Ω—ñ–π ¬´hub¬ª. –¢–µ–ø–µ—Ä –∑–∞–≤–∂–¥–∏ —Ç—è–≥–Ω–µ–º–æ –ø–æ–≤–Ω–∏–π –¥–æ–≤—ñ–¥–Ω–∏–∫,
  // –∫–µ—à—É—î–º–æ –π–æ–≥–æ –Ω–∞ 12 –≥–æ–¥–∏–Ω —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω–æ. –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î –∫–æ—Ä–µ–∫—Ç–Ω–∏–π ¬´–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª¬ª –Ω–∞ –≤—Å—ñ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö.
  const limitByHub = false;

  try{
    if (!forceServer && !limitByHub){
      const raw = localStorage.getItem(DIR_CACHE_KEY);
      if (raw){
        const { ts, rows } = JSON.parse(raw);
        if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){ fillDirectoryUI(rows); return; }
      }
    }
  }catch{}

  let q = db.collection('directory');

  let snap = null;
  try {
    snap = await q.get({ source: forceServer ? 'server' : 'cache' });
  } catch {}
  if (!snap || snap.empty) { snap = await q.get({ source: 'default' }); }

  const rows = [];
  const isTestMode = window.__userTestMode === true; // —á–∏—Ç–∞—î–º–æ –∑ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  
  snap.forEach(doc=>{
    const d = doc.data()||{};
    const code = d.code || doc.id;
    const name = d.name || code;
    const unit = d.unit || '';
    const isTest = d.isTest === true;
    
    // üß™ TEST MODE: —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞–ø–∏—Å–∏ (per-user –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è)
    if (isTestMode) {
      const isTestEntry = isTest || /^(—Ç–µ—Å—Ç|test)/i.test(name) || /^(—Ç–µ—Å—Ç|test)/i.test(code);
      if (!isTestEntry) return; // –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –Ω–µ-—Ç–µ—Å—Ç–æ–≤—ñ –∑–∞–ø–∏—Å–∏
    }
    
    // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤ –±–µ–∑ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É
    if (!unit) {
      console.warn(`[directory] –í—ñ–¥—Å—É—Ç–Ω—ñ–π unit –¥–ª—è –∫–æ–¥—É: ${code}, name: ${name}`);
    }
    rows.push({ code, name, company: d.company || '', unit, isTest });
  });
  fillDirectoryUI(rows);
  try { 
    const withoutUnit = rows.filter(r => !r.unit).length;
    const mode = isTestMode ? ' [TEST MODE]' : '';
    console.log(`[directory]${mode} loaded rows:`, rows.length, '–±–µ–∑ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É:', withoutUnit, 'forceServer=', !!forceServer); 
  } catch(_) {}

  try{
    // –∫–µ—à—É—î–º–æ –ø–æ–≤–Ω–∏–π –¥–æ–≤—ñ–¥–Ω–∏–∫
    localStorage.setItem(DIR_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows }));
  }catch{}
}

/* ---------- –õ–æ–≥—ñ—Å—Ç–∏ ---------- */
const logistById = {}, logistIdByName = {};
const LOGISTS_CACHE_KEY = 'export.logistsCache.v1';
const LOGISTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;
const _norm = s => String(s||'').trim().toLowerCase();

function fillLogistsUI(rows){
  const list = document.getElementById('logistsList');
  list.innerHTML = '';
  for (const k in logistById) delete logistById[k];
  for (const k in logistIdByName) delete logistIdByName[k];
  rows.forEach(r=>{ logistById[r.id]=r; logistIdByName[r.name]=r.id;
    const opt=document.createElement('option'); opt.value=r.name; list.appendChild(opt);
  });
}

async function loadLogists(allowServer){
  const msg = document.getElementById('logistsMsg');
  const show = t => { msg.textContent = t || ''; msg.style.display = t ? 'block' : 'none'; };
  try{
    const raw = localStorage.getItem(LOGISTS_CACHE_KEY);
    if (raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < LOGISTS_CACHE_TTL_MS){ fillLogistsUI(rows); show(''); return; }
    }
    if (!allowServer){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
    let snap = null;
    try { snap = await db.collection('logists').get({ source: 'server' }); }
    catch(e){
      if (e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message))){ show('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); return; }
      throw e;
    }
    let rows = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      rows.push({ id: doc.id, name: d.name || doc.id, active: d.active !== false, sort: typeof d.sort === 'number' ? d.sort : 0 });
    });
    rows = rows.filter(r=>r.active).sort((a,b)=>(a.sort-b.sort)||a.name.localeCompare(b.name,'uk'));
    fillLogistsUI(rows);
    try{ localStorage.setItem(LOGISTS_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}
    show('');
  }catch(e){ console.error('logists load error:', e); show('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥—ñ—Å—Ç—ñ–≤.'); }
}

function getLogistIdByInput(inputId){
  const name = (document.getElementById(inputId).value || '').trim();
  if (!name) return null;
  if (logistIdByName[name]) return logistIdByName[name];
  const n = _norm(name);
  for (const [label, id] of Object.entries(logistIdByName)){ if (_norm(label) === n) return id; }
  const cand = Object.entries(logistIdByName).filter(([label])=> _norm(label).includes(n));
  if (cand.length === 1) return cand[0][1];
  return null;
}

/* ---------- –•–µ–ª–ø–µ—Ä–∏ ---------- */
function getCodeByNameInput(id){ const name=(document.getElementById(id).value||'').trim(); return codeByName[name] || ''; }
function nameByCode(code){ return (dirByCode[code]?.name)||''; }
function unitByCode(code){ return (dirByCode[code]?.unit)||''; }
// –í–∏—Ç—è–≥–Ω—É—Ç–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª –∑ Label —Ñ–æ—Ä–º–∞—Ç—É "–ù–∞–∑–≤–∞ ‚Ä¢ –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª ‚Ä¢ –ö–æ–º–ø–∞–Ω—ñ—è"
function extractUnitFromLabel(label) {
  if (!label || typeof label !== 'string') return '';
  const parts = label.split('‚Ä¢').map(p => p.trim()).filter(Boolean);
  // –î—Ä—É–≥–∏–π –µ–ª–µ–º–µ–Ω—Ç - —Ü–µ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª
  return parts.length >= 2 ? parts[1] : '';
}
function dayStartISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString(); }
function dayEndISO(d){ const x=new Date(d); x.setHours(23,59,59,999); return x.toISOString(); }
function formatDate(dt){ if (!dt) return ''; const d=new Date(dt); if (isNaN(d)) return ''; const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
function normalizeForJson(val){
  if (val === undefined || val === null) return null;

  // Firestore —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Ç–∏–ø–∏
  if (val instanceof firebase.firestore.Timestamp) return val.toDate().toISOString();
  if (val instanceof firebase.firestore.GeoPoint)  return { lat: val.latitude, lng: val.longitude };
  // DocumentReference ‚Üí —à–ª—è—Ö
  if (val && typeof val === 'object' && typeof val.path === 'string' && val.parent) return val.path;

  if (Array.isArray(val)) return val.map(normalizeForJson);
  if (typeof val === 'object'){
    const out = {}; for (const [k,v] of Object.entries(val)) out[k] = normalizeForJson(v); return out;
  }
  return val;
}

function downloadJson(objOrArray, filename){
  const blob = new Blob([JSON.stringify(objOrArray, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 5000);
}

/* ---------- KML helpers ---------- */
function kmlEsc(s){ return String(s||'').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
function kmlCoords(arr){ return (arr||[]).map(([lng,lat])=>`${lng},${lat},0`).join(' '); }
function buildKmlForRoute(raw, title){
  const name = kmlEsc(title || '–ú–∞—Ä—à—Ä—É—Ç');
  const pts = normalizePoints(raw?.points) || normalizePoints(raw?.coordinates) || normalizePoints(raw?.route) || normalizePoints(raw?.geojson) || normalizePoints(raw?.geometry);
  const startR = normalizePoints(raw?.startRuler);
  const endR   = normalizePoints(raw?.endRuler);
  const segs   = normalizeSegments(raw);
  const out = [];
  out.push('<?xml version="1.0" encoding="UTF-8"?>');
  out.push('<kml xmlns="http://www.opengis.net/kml/2.2"><Document>');
  out.push(`<name>${name}</name>`);
  if (pts && pts.length>=2){
    out.push('<Placemark><name>Route</name><LineString><tessellate>1</tessellate><coordinates>');
    out.push(kmlCoords(pts));
    out.push('</coordinates></LineString></Placemark>');
  }
  if (Array.isArray(startR) && startR.length>=2){
    out.push('<Placemark><name>Ruler start</name><LineString><tessellate>1</tessellate><coordinates>');
    out.push(kmlCoords(startR));
    out.push('</coordinates></LineString></Placemark>');
  }
  if (Array.isArray(endR) && endR.length>=2){
    out.push('<Placemark><name>Ruler end</name><LineString><tessellate>1</tessellate><coordinates>');
    out.push(kmlCoords(endR));
    out.push('</coordinates></LineString></Placemark>');
  }
  if (Array.isArray(segs)){
    segs.forEach((s, i)=>{
      if (!s || s.length<2) return;
      out.push(`<Placemark><name>Segment ${i+1}</name><LineString><tessellate>1</tessellate><coordinates>`);
      out.push(kmlCoords(s));
      out.push('</coordinates></LineString></Placemark>');
    });
  }
  out.push('</Document></kml>');
  return out.join('');
}

/* ===== –í–µ—Ä—Ö–Ω—ñ–π —ñ –Ω–∏–∂–Ω—ñ–π –ª–∏–ø–∫–∏–π —Å–∫—Ä–æ–ª: —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ .table-wrap ===== */
let _xScroller = null, _xInner = null, _xBound = false, _xRO = null;
let _bottomScroller = null, _bottomInner = null;

function ensureXScroller(){
  _xScroller = document.getElementById('xScroller');
  if (!_xScroller){
    const card = document.querySelector('.results-card');
    if (!card) return;
    const s = document.createElement('div'); s.id = 'xScroller';
    const i = document.createElement('div'); s.appendChild(i);
    card.insertBefore(s, card.querySelector('.table-wrap'));
    _xScroller = s; _xInner = i;
  } else {
    _xInner = _xScroller.firstElementChild;
  }
  
  // –¢–∞–∫–æ–∂ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –Ω–∏–∂–Ω—ñ–π —Å–∫—Ä–æ–ª–±–∞—Ä
  _bottomScroller = document.getElementById('bottomScroller');
  if (_bottomScroller) {
    _bottomInner = _bottomScroller.firstElementChild;
  }
}

function syncXWidth(){
  ensureXScroller();
  const table = document.getElementById('resTable');
  const wrap  = document.querySelector('.table-wrap');
  if (!_xScroller || !_xInner || !table || !wrap) return;
  const wTop = table.scrollWidth + 'px';
  _xInner.style.width = wTop;
  if (_xScroller.scrollLeft !== wrap.scrollLeft) _xScroller.scrollLeft = wrap.scrollLeft;
  
  // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –Ω–∏–∂–Ω—ñ–π —Å–∫—Ä–æ–ª–±–∞—Ä
  if (_bottomScroller && _bottomInner) {
    const minBottom = Math.max(table.scrollWidth, wrap.clientWidth + 1);
    _bottomInner.style.width = minBottom + 'px';
    if (_bottomScroller.scrollLeft !== wrap.scrollLeft) _bottomScroller.scrollLeft = wrap.scrollLeft;
  }
}

function bindXSync(){
  ensureXScroller();
  const wrap = document.querySelector('.table-wrap');
  if (!wrap || !_xScroller || _xBound) return;

  let lock = false;

  const setLeft = (el, x) => {
    if (!el) return;
    const nx = Math.max(0, x || 0);
    if (Math.abs(el.scrollLeft - nx) < 0.5) return;
    el.scrollLeft = nx;
  };
  const maxScroll = (el) => el ? Math.max(0, (el.scrollWidth || 0) - (el.clientWidth || 0)) : 0;
  const syncScroll = (fromEl, toEl) => {
    if (!fromEl || !toEl) return;
    const maxFrom = maxScroll(fromEl);
    const maxTo = maxScroll(toEl);
    const ratio = maxFrom ? (fromEl.scrollLeft / maxFrom) : 0;
    setLeft(toEl, ratio * maxTo);
  };
  
  // –¢–∞–±–ª–∏—Ü—è ‚Üí –≤–µ—Ä—Ö–Ω—ñ–π —ñ –Ω–∏–∂–Ω—ñ–π —Å–∫—Ä–æ–ª–±–∞—Ä–∏
  wrap.addEventListener('scroll', () => {
    if (lock) return; lock = true;
    syncScroll(wrap, _xScroller);
    syncScroll(wrap, _bottomScroller);
    lock = false;
  }, { passive:true });

  // –í–µ—Ä—Ö–Ω—ñ–π —Å–∫—Ä–æ–ª–±–∞—Ä ‚Üí —Ç–∞–±–ª–∏—Ü—è —ñ –Ω–∏–∂–Ω—ñ–π
  _xScroller.addEventListener('scroll', () => {
    if (lock) return; lock = true;
    syncScroll(_xScroller, wrap);
    syncScroll(_xScroller, _bottomScroller);
    lock = false;
  }, { passive:true });
  
  // –ù–∏–∂–Ω—ñ–π —Å–∫—Ä–æ–ª–±–∞—Ä ‚Üí —Ç–∞–±–ª–∏—Ü—è —ñ –≤–µ—Ä—Ö–Ω—ñ–π
  if (_bottomScroller) {
    _bottomScroller.addEventListener('scroll', () => {
      if (lock) return; lock = true;
      syncScroll(_bottomScroller, wrap);
      syncScroll(_bottomScroller, _xScroller);
      lock = false;
    }, { passive:true });
  }

  // —Å—Ç–µ–∂–∏–º–æ –∑–∞ –∑–º—ñ–Ω–æ—é —à–∏—Ä–∏–Ω–∏ —Ç–∞–±–ª–∏—Ü—ñ
  try {
    _xRO?.disconnect();
    _xRO = new ResizeObserver(syncXWidth);
    _xRO.observe(document.getElementById('resTable'));
  } catch(_) {}

  window.addEventListener('resize', debounce(syncXWidth, 120));
  _xBound = true;
}

const toNum = v => (v==='' || v==null) ? NaN : Number(v);

/* --- –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–æ—á–æ–∫ --- */
function toLonLat(p){
  if (Array.isArray(p) && p.length>=2){ const a=Number(p[0]); const b=Number(p[1]); return (Math.abs(a)<=90 && Math.abs(b)<=180)?[b,a]:[a,b]; }
  if (typeof p==='string'){ const parts=p.split(/[;, ]+/).map(Number).filter(v=>!Number.isNaN(v)); if (parts.length>=2) return toLonLat(parts); }
  if (p && typeof p==='object'){ const lat=Number(p.lat ?? p.latitude ?? p.Lat ?? p.Latitude); const lon=Number(p.lon ?? p.lng ?? p.longitude ?? p.Lon ?? p.Lng ?? p.Longitude); if (!Number.isNaN(lat)&&!Number.isNaN(lon)) return [lon,lat]; }
  return null;
}
function normalizePoints(raw){
  if (!raw) return null;
  if (raw.type==='Feature' && raw.geometry?.type==='LineString') return normalizePoints(raw.geometry.coordinates);
  if (raw.geometry?.type==='LineString' && Array.isArray(raw.geometry.coordinates)) return normalizePoints(raw.geometry.coordinates);
  if (raw.type==='FeatureCollection' && Array.isArray(raw.features)){ const f=raw.features.find(f=>f.geometry?.type==='LineString'); if (f) return normalizePoints(f.geometry.coordinates); }
  if (Array.isArray(raw)){ const out=[]; for (const item of raw){ const pt=toLonLat(item); if (pt && Number.isFinite(pt[0]) && Number.isFinite(pt[1])) out.push(pt); } return out.length?out:null; }
  return null;
}
  /* ===== ZIP helpers ===== */
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 5000);
}

// –ë–µ–∑–ø–µ—á–Ω—ñ —ñ –∫–æ—Ä–æ—Ç–∫—ñ —ñ–º–µ–Ω–∞ —Ñ–∞–π–ª—ñ–≤
function safeName(s, max = 120){
  return String(s || '')
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '_')
    .replace(/\s+/g, ' ')
    .trim()
    .slice(0, max);
}

/* 
 * –ï–∫—Å–ø–æ—Ä—Ç: –∫–æ–∂–µ–Ω –º–∞—Ä—à—Ä—É—Ç –æ–∫—Ä–µ–º–∏–º JSON —É ZIP
 * rows ‚Äî —Ç—ñ —Å–∞–º—ñ —Ä—è–¥–∫–∏, —è–∫—ñ —Ç–∏ –≤—ñ–¥–¥–∞–≤–∞–≤ —É exportJsonFromRows
 */
async function exportJsonZipFromRows(rows){
  if (!rows || !rows.length){
    alert('–ù–µ–º–∞—î —Ä—è–¥–∫—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.');
    return;
  }

  const zip = new JSZip();
  const folder = zip.folder('routes');

  // —ñ–Ω–¥–µ–∫—Å: –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–∫–ª–∞–¥—É –∞—Ä—Ö—ñ–≤—É
  const index = [];

  // –ù–∞–∑–≤–∞ –∞—Ä—Ö—ñ–≤—É
  const ts = new Date();
  const pad = n => String(n).padStart(2,'0');
  const zipName = `routes_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.zip`;

  // –ù–∞–ø–æ–≤–Ω—é—î–º–æ ZIP —Ñ–∞–π–ª–∞–º–∏
  let i = 0;
  for (const r of rows){
    const raw = r.raw || {};
    const jsonObj = Object.assign({ id: r.id }, normalizeForJson(raw));
    const pretty = `${r.fromName || ''} ‚Üí ${r.toName || ''}`.trim();
    const base =
      safeName(
        `route_${r.routeKey ? r.routeKey + '_' : ''}${r.id || ''}_${pretty || ''}`
      ) || `route_${i+1}`;

    folder.file(`${base}.json`, JSON.stringify(jsonObj, null, 2));
    index.push({
      id: r.id,
      routeKey: r.routeKey || null,
      name: pretty || null,
      updatedAt: r.updatedAtRaw || null,
      distance_km: Number.isFinite(r.distance_km) ? r.distance_km : null
    });

    // —â–æ–± –Ω–µ "–∑–∞–º–æ—Ä–æ–∂—É–≤–∞—Ç–∏" UI –Ω–∞ –¥—É–∂–µ –≤–µ–ª–∏–∫–∏—Ö –≤–∏–±—ñ—Ä–∫–∞—Ö
    if (++i % 200 === 0) await new Promise(requestAnimationFrame);
  }

  // –¥–æ–∫–ª–∞–¥–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å
  zip.file('index.json', JSON.stringify(index, null, 2));

  // –ì–µ–Ω–µ—Ä—É—î–º–æ –∞—Ä—Ö—ñ–≤ –∑ –∫–æ–º–ø—Ä–µ—Å—ñ—î—é
  const blob = await zip.generateAsync(
    { type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } },
    (meta) => { try { statusEl.textContent = `–ê—Ä—Ö—ñ–≤—É—î—Ç—å—Å—è‚Ä¶ ${meta.percent.toFixed(1)}%`; } catch(_) {} }
  );

  downloadBlob(blob, zipName);
  try { statusEl.textContent = '–ì–æ—Ç–æ–≤–æ'; } catch(_) {}
}

/*
 * –ï–∫—Å–ø–æ—Ä—Ç: –∫–æ–∂–µ–Ω –º–∞—Ä—à—Ä—É—Ç –æ–∫—Ä–µ–º–∏–º KML —É ZIP
 */
async function exportKmlZipFromRows(rows){
  if (!rows || !rows.length){ alert('–ù–µ–º–∞—î —Ä—è–¥–∫—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.'); return; }
  const zip = new JSZip();
  const folder = zip.folder('routes');

  const ts = new Date();
  const pad = n => String(n).padStart(2,'0');
  const zipName = `routes_kml_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.zip`;

  let i = 0;
  for (const r of rows){
    const raw = r.raw || {};
    const pretty = `${r.fromName || ''} ‚Üí ${r.toName || ''}`.trim();
    const base = safeName(`route_${r.routeKey ? r.routeKey + '_' : ''}${r.id || ''}_${pretty || ''}`) || `route_${i+1}`;
    const kml = buildKmlForRoute(raw, pretty || r.routeKey || r.id || '–ú–∞—Ä—à—Ä—É—Ç');
    folder.file(`${base}.kml`, kml);
    if (++i % 200 === 0) await new Promise(requestAnimationFrame);
  }

  const blob = await zip.generateAsync(
    { type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } },
    (meta) => { try { statusEl.textContent = `–ê—Ä—Ö—ñ–≤—É—î—Ç—å—Å—è‚Ä¶ ${meta.percent.toFixed(1)}%`; } catch(_) {} }
  );
  downloadBlob(blob, zipName);
  try { statusEl.textContent = '–ì–æ—Ç–æ–≤–æ'; } catch(_) {}
}

/* === UTF-8 Base64 === */
function b64encodeUtf8(objOrString){
  const s = typeof objOrString === 'string' ? objOrString : JSON.stringify(objOrString);
  const bytes = new TextEncoder().encode(s); let bin='';
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]); return btoa(bin);
}

/* –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
const round6 = n => Math.round(n * 1e6) / 1e6;
const roundCoords = arr => (arr || []).map(([lng,lat]) => [round6(lng), round6(lat)]);

/* –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–º–∞–ª—å–æ–≤–∞–Ω–∏—Ö —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ */
function normalizeSegments(source){
  const segments=[];
  function pushLine(arr){ if (!Array.isArray(arr)) return; const pts=arr.map(toLonLat).filter(Boolean); if (pts.length>=2) segments.push(pts); }
  function scan(val){
    if (!val) return;
    if (val.type==='FeatureCollection' && Array.isArray(val.features)){ val.features.forEach(f=>{ if (f?.geometry?.type==='LineString') pushLine(f.geometry.coordinates); if (f?.geometry?.type==='MultiLineString') (f.geometry.coordinates||[]).forEach(pushLine); }); return; }
    if (val.type==='Feature' && val.geometry) return scan(val.geometry);
    if (val.type==='LineString' && Array.isArray(val.coordinates)) return pushLine(val.coordinates);
    if (val.type==='MultiLineString' && Array.isArray(val.coordinates)) return val.coordinates.forEach(pushLine);
    if (Array.isArray(val)){ if (val.length && Array.isArray(val[0])) return pushLine(val); if (val.length && typeof val[0]==='object'){ const pts=val.map(toLonLat).filter(Boolean); if (pts.length>=2) return segments.push(pts); val.forEach(scan); return; } if (val.length && typeof val[0]==='string') return pushLine(val); }
    if (typeof val==='object'){ for (const [k,v] of Object.entries(val)){ if (/(ruler|manual|line|path|segment|polyline|draw)/i.test(k)) scan(v); } }
  }
  scan(source); return segments;
}

/* ---------- –í–∏—Ç—è–≥ ¬´–ü—Ä–æ–º—ñ–∂–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤¬ª ---------- */
function extractViaList(d){
  const acc = [];
  const seen = new Set();
  const push = (s) => {
    const t = String(s || '').trim();
    if (!t) return;
    const key = t.toLowerCase();
    if (!seen.has(key)) { seen.add(key); acc.push(t); }
  };
  const mapCode = (code) => nameByCode(code) || String(code || '').trim();

  const splitNames = s => String(s || '')
    .split(/[\|,;]|[‚Äì‚Äî-]|‚Üí/g)
    .map(x => x.trim())
    .filter(Boolean);

  ['intermediateText','viaNames','midNames','waypointNames','stopsNames'].forEach(k => {
    const v = d[k];
    if (Array.isArray(v)) v.forEach(push);
    else if (typeof v === 'string') splitNames(v).forEach(push);
  });

  ['intermediateCodes','viaCodes','midCodes','waypointCodes','stopsCodes'].forEach(k => {
    const v = d[k];
    if (Array.isArray(v)) v.forEach(c => push(mapCode(c)));
    else if (typeof v === 'string') splitNames(v).forEach(c => push(mapCode(c)));
  });

  ['intermediate','intermediates','via','vias','mid','mids','waypoints','midpoints','stops'].forEach(k => {
    const v = d[k];
    if (Array.isArray(v)) {
      for (const it of v) {
        if (typeof it === 'string') { splitNames(it).forEach(x => push(mapCode(x))); continue; }
        if (Array.isArray(it)) { const p = toLonLat(it); if (p) push(`${p[1].toFixed(6)}, ${p[0].toFixed(6)}`); continue; }
        if (it && typeof it === 'object') {
          if (it.name || it.label || it.title) { push(it.name || it.label || it.title); continue; }
          if (it.code) { push(mapCode(it.code)); continue; }
          const p = toLonLat(it); if (p) push(`${p[1].toFixed(6)}, ${p[0].toFixed(6)}`);
        }
      }
    } else if (typeof v === 'string') {
      splitNames(v).forEach(x => push(mapCode(x)));
    }
  });

  if (!acc.length) {
    const label = d.name || d.fromLabel || '';
    const parts = splitNames(label);
    if (parts.length >= 3) parts.slice(1, -1).forEach(push);
  }

  return acc;
}

/* ---------- –ü–ê–ì–Ü–ù–ê–¶–Ü–Ø / –°–¢–ê–ù ---------- */
const PAGE_SIZE = 1000;
let _baseQuery = null;
let _cursor = null;
let _hasMore = false;
let allRows = [];
let FORCE_SERVER = false;

/* === LIVE –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (onSnapshot) === */
let _liveUnsub = null;     // –∞–∫—Ç—É–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–∏—Å–∫–∞
let _liveLimit = PAGE_SIZE;
let _liveEnabled = false;

function stopLive(){
  try { _liveUnsub && _liveUnsub(); } catch(_) {}
  _liveUnsub = null;
  _liveEnabled = false;
}

function startLive(limit){
  if (!_baseQuery) return;
  _liveLimit = Math.max(1, limit || PAGE_SIZE);
  stopLive();
  _liveEnabled = true;

  // —Å–ª—É—Ö–∞—î–º–æ —Ç–æ–π —Å–∞–º–∏–π "–±–∞–∑–æ–≤–∏–π" –∑–∞–ø–∏—Ç –∑ –ø–æ—Ç–æ—á–Ω–∏–º –ª—ñ–º—ñ—Ç–æ–º
  const q = _baseQuery.limit(_liveLimit);
  _liveUnsub = q.onSnapshot(
    (snap) => {
      const { rows, lastDoc } = parseSnap(snap);
      allRows = rows;
      _cursor = lastDoc;
      _hasMore = snap.size === _liveLimit;   // —è–∫—â–æ –¥–æ—Ä—ñ–≤–Ω—é—î –ª—ñ–º—ñ—Ç—É ‚Äî —î —â–æ –¥–æ–≥—Ä—É–∂–∞—Ç–∏
      reRender();                             // –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é
    },
    (e) => {
      console.error('Live listener error:', e);
      statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è';
    }
  );
}

/* ---------- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è ---------- */
const sortState = { key: 'updatedAtRaw', dir: -1 };

/* ---------- –ú–∞–ø—ñ–Ω–≥ —Å—Ç–∞—Ç—É—Å—ñ–≤ (fixed) ---------- */
function toStatusLabelRaw(v){
  // —É–Ω—ñ—Ñ—ñ–∫—É—î–º–æ –≤ –Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä + –æ–±—Ä—ñ–∑–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏
  const s = (typeof v === 'string') ? v.trim().toLowerCase() : v;

  const YES = new Set([
    'approved','approve','ok','okay','allowed','accept','accepted','yes','y','done','success','passed'
  ]);
  const NO = new Set([
    'rejected','reject','denied','deny','declined','no','not_approved','disallow','blocked','failed'
  ]);

  if (s === true || s === 1 || YES.has(s)) return '–ü–æ–≥–æ–¥–∂–µ–Ω–æ';
  if (s === false || s === 0 || NO.has(s))  return '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
  if (s === 'proposal') return '–Ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è';
  if (typeof s === 'string' && [
    'pending','in_review','inreview','review','waiting','wait','on_approval','submitted'
  ].includes(s)) return '–û—á—ñ–∫—É—î';
  return '';
}

function computeApprovalStatus(d){
  if (!d || typeof d !== 'object') return null;

  // 0) –ü–ï–†–®–ê –ü–†–Ü–û–†–ò–¢–ï–¢–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: —è–∫—â–æ —î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî –≤–æ–Ω–∞ –≤–∞–∂–ª–∏–≤—ñ—à–∞ –∑–∞ —Å—Ç–∞—Ç—É—Å
  if (d.proposal && typeof d.proposal === 'object') {
    const proposalKeys = Object.keys(d.proposal).filter(k => !k.startsWith('_'));
    if (proposalKeys.length > 0) {
      return 'proposal'; // –Ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —ó—ó –ù–ï–ó–ê–õ–ï–ñ–ù–û –≤—ñ–¥ approval.status
    }
  }

  // 1) –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ—Å—Ç–∞—Ç–æ—á–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ d.approval
  if (typeof d.approval === 'string') return d.approval;
  if (d.approval && typeof d.approval === 'object'){
    const A = d.approval;
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–∏—à–µ –§–Ü–ù–ê–õ–¨–ù–Ü —Å—Ç–∞—Ç—É—Å–∏ (approved/rejected), –∞–ª–µ –ù–ï pending
    if (A.status && A.status !== 'pending') return A.status;
    if (A.result   !== undefined && A.result   !== null) return A.result;
    if (A.decision !== undefined && A.decision !== null) return A.decision;
    if (A.approved !== undefined && A.approved !== null) return A.approved; // true/false
    if (A.approvedAt || (A.updatedAt && (A.approvedBy || A.approver))) return true;
  }

  // 2) –í—ñ–¥–æ–º—ñ –ø–æ–ª—è –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ
  if (d.approvalStatus !== undefined && d.approvalStatus !== null) return d.approvalStatus;
  if (d.approved       !== undefined && d.approved       !== null) return d.approved;

  // 3) –Ø–∫—â–æ —î approval.status === 'pending', –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –π–æ–≥–æ
  if (d.approval?.status === 'pending') return 'pending';

  // 4) –í–µ—Ä—Ö–Ω—å–æ—Ä—ñ–≤–Ω–µ–≤–µ d.status –±–µ—Ä–µ–º–æ –õ–ò–®–ï —è–∫—â–æ –≤–æ–Ω–æ –≤–∏–≥–ª—è–¥–∞—î —è–∫ —Å—Ç–∞—Ç—É—Å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
  if (d.status !== undefined && d.status !== null){
    const label = toStatusLabelRaw(d.status);
    if (label) return d.status;        // –ø—Ä–∏–π–º–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –≤–∞–ª—ñ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è ("approved"/"rejected"/—Ç–æ—â–æ)
    // —è–∫—â–æ label –ø–æ—Ä–æ–∂–Ω—ñ–π ‚Äî —ñ–≥–Ω–æ—Ä—É—î–º–æ (—Ü–µ –º–æ–∂–µ –±—É—Ç–∏ "–û—Å–Ω–æ–≤–Ω–∏–π" –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫)
  }

  return null;
}

/* ---------- –ü–æ–±—É–¥–æ–≤–∞ –∑–∞–ø–∏—Ç—É ---------- */
function buildBaseQuery(){
  if (!db || !currentUser) throw new Error('–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏');
  let q = db.collection('routes');

  // –≤–∏–±—ñ—Ä –∑ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –ø–æ–ª—è
  const hubSel = (document.getElementById('hubFilter')?.value || '').trim();

  // –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–∞ —Ä–æ–ª–ª—é
  const allNow  = !!(window.__userAllHubs ?? allowAllHubs);
  const hubsAllowed = (Array.isArray(window.__userHubs) ? window.__userHubs : (allowedHubs || [])).filter(Boolean);

  // üîë —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î —Ä–æ–ª—å –ª–æ–≥—ñ—Å—Ç–∞ (–æ—Å–Ω–æ–≤–Ω—É –∞–±–æ –¥–æ–¥–∞—Ç–∫–æ–≤—É) —ñ –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –≤—Å—ñ—Ö —Ö–∞–±—ñ–≤
  if (userHasRole('logist') && !allNow) {
    if (!hubsAllowed.length) throw new Error('–í–∞—à—ñ–π —Ä–æ–ª—ñ –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –•–ê–ë—É. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');

    if (hubSel) {
      // —è–∫—â–æ –ª–æ–≥—ñ—Å—Ç –≤–∏–±—Ä–∞–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –•–ê–ë ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –≤—ñ–Ω –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π
      if (hubsAllowed.includes(hubSel)) {
        q = q.where('hub','==', hubSel);
      } else {
        // –∑—Ä–æ–±–∏–º–æ –ø–æ—Ä–æ–∂–Ω—é –≤–∏–±—ñ—Ä–∫—É (–±–µ–∑ —Å—Ç—Ä–∞—à–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏)
        q = q.where('hub','==','__forbidden__');
      }
    } else {
      // –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É ‚Äî –≤—Å—ñ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ (–¥–æ 10 –¥–ª—è 'in')
      if (hubsAllowed.length === 1) q = q.where('hub','==', hubsAllowed[0]);
      else                          q = q.where('hub','in', hubsAllowed.slice(0,10));
      if (hubsAllowed.length > 10) console.warn('–í–∏–±—Ä–∞–Ω–æ >10 —Ö–∞–±—ñ–≤ ‚Äî —É –∑–∞–ø–∏—Ç –ø—ñ–¥–µ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ 10.');
    }
  } else {
    // admin/user/security –∞–±–æ –ª–æ–≥—ñ—Å—Ç –∑—ñ ¬´–≤—Å—ñ —Ö–∞–±–∏¬ª
    if (hubSel) q = q.where('hub','==', hubSel);
  }

  // —ñ–Ω—à—ñ –≤–µ—Ä—Ö–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ (—è–∫ –±—É–ª–æ)
  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value;
  const df       = document.getElementById('dateFrom')?.value;
  const dt       = document.getElementById('dateTo')?.value;
  const logistId = getLogistIdByInput('logistFilter');

  // üß™ –§—ñ–ª—å—Ç—Ä —Ç–µ—Å—Ç–æ–≤–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
  const testMode = document.getElementById('testModeFilter')?.checked || false;
  if (testMode) {
    q = q.where('isTest','==', true);
  }

  if (fromCode) q = q.where('fromCode','==',fromCode);
  if (toCode)   q = q.where('toCode','==',toCode);
  if (type)     q = q.where('routeType','==',type);
  if (logistId) q = q.where('logisticId','==',logistId);

  q = q.orderBy('updatedAt','desc');
  if (df) q = q.where('updatedAt','>=', dayStartISO(df));
  if (dt) q = q.where('updatedAt','<=', dayEndISO(dt));

  return q;
}

function parseSnap(snap){
  const rows=[];
  const isTestMode = window.__userTestMode === true;
  
  snap.forEach(doc=>{
    const d=doc.data()||{};
    
    // üß™ TEST MODE: —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –º–∞—Ä—à—Ä—É—Ç–∏ (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ testMode –±–∞—á–∏—Ç—å –ª–∏—à–µ —Ç–µ—Å—Ç–æ–≤—ñ –º–∞—Ä—à—Ä—É—Ç–∏)
    if (isTestMode) {
      // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å–∞–º –º–∞—Ä—à—Ä—É—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ —Ç–µ—Å—Ç–æ–≤–∏–π
      const isRouteTest = d.isTest === true;
      
      // –Ø–∫—â–æ –º–∞—Ä—à—Ä—É—Ç —è–≤–Ω–æ –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ —Ç–µ—Å—Ç–æ–≤–∏–π - –ø–æ–∫–∞–∑—É—î–º–æ –π–æ–≥–æ
      if (isRouteTest) {
        // –ú–∞—Ä—à—Ä—É—Ç —Ç–µ—Å—Ç–æ–≤–∏–π - –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ–±—Ä–æ–±–∫—É
      } else {
        // –Ø–∫—â–æ –º–∞—Ä—à—Ä—É—Ç –ù–ï –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ —Ç–µ—Å—Ç–æ–≤–∏–π - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–æ—á–∫–∏
        const fromCode = d.fromCode || '';
        const toCode = d.toCode || '';
        const fromName = d.fromName || d.fromLabel || '';
        const toName = d.toName || d.toLabel || '';
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏ (–≤—ñ–¥/–¥–æ) —î —Ç–µ—Å—Ç–æ–≤–∏–º–∏
        const fromEntry = dirByCode[fromCode];
        const toEntry = dirByCode[toCode];
        
        const isFromTest = fromEntry 
          ? (fromEntry.isTest === true || /^(—Ç–µ—Å—Ç|test)/i.test(fromEntry.name || '') || /^(—Ç–µ—Å—Ç|test)/i.test(fromCode))
          : /^(—Ç–µ—Å—Ç|test)/i.test(fromName) || /^(—Ç–µ—Å—Ç|test)/i.test(fromCode);
        
        const isToTest = toEntry
          ? (toEntry.isTest === true || /^(—Ç–µ—Å—Ç|test)/i.test(toEntry.name || '') || /^(—Ç–µ—Å—Ç|test)/i.test(toCode))
          : /^(—Ç–µ—Å—Ç|test)/i.test(toName) || /^(—Ç–µ—Å—Ç|test)/i.test(toCode);
        
        // –ú–∞—Ä—à—Ä—É—Ç –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –ª–∏—à–µ —è–∫—â–æ –û–ë–ò –∫—ñ–Ω—Ü—ñ —Ç–µ—Å—Ç–æ–≤—ñ –ê–ë–û –º–∞—Ä—à—Ä—É—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ —Ç–µ—Å—Ç–æ–≤–∏–π
        if (!isFromTest || !isToTest) return;
      }
    }
    
    const viaArr = extractViaList(d);

    const statusValue = computeApprovalStatus(d);
    const statusLabel = toStatusLabelRaw(statusValue);

    const unitFromRaw = (d.unitFrom || d.fromUnit || d.unitFrom || d.fromUnitName || d.unitFromName || extractUnitFromLabel(d.fromLabel) || unitByCode(d.fromCode) || '').trim();
    const unitToRaw   = (d.unitTo   || d.toUnit   || d.unitTo   || d.toUnitName   || d.unitToName   || extractUnitFromLabel(d.toLabel)   || unitByCode(d.toCode)   || '').trim();
    const purposeRaw  = String(d.purpose || d.routePurpose || '').trim();
    const pNorm = purposeRaw.toLowerCase().replace(/[\s.]/g,'');
    const unitByPurpose = (pNorm.includes('–∑–µ—Ä–Ω–æ'))
      ? unitFromRaw
      : (pNorm === '–æ–¥' || pNorm.startsWith('–æ–¥'))
        ? unitToRaw
        : (unitFromRaw || unitToRaw);


    const rejectComment =
      (d?.approval && 'comment' in d.approval ? (d.approval.comment || '') : '') ||
      (typeof d.comment === 'string' ? d.comment : '');

    // –ö–æ—Ä–æ—Ç–∫–∞ —Ñ–æ—Ä–º–∞ –Ω–∞–∑–≤–∏: –±–µ—Ä–µ–º–æ —á–∞—Å—Ç–∏–Ω—É –¥–æ –ø–µ—Ä—à–æ—ó ¬´‚Ä¢¬ª, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω—å —Ç–∏–ø—É "‚Ä¶ ‚Ä¢ –ï–ª–µ–≤–∞—Ç–æ—Ä ‚Ä¢ –ï–ª–µ–≤–∞—Ç–æ—Ä"
    const shortByLabel = (lbl) => {
      const s = String(lbl||'').trim();
      if (!s) return '';
      const i = s.indexOf('‚Ä¢');
      return i>0 ? s.slice(0, i).trim() : s;
    };

    rows.push({
      id: doc.id,
      routeKey: d.routeKey || '',
	  hub: d.hub || '',
      isTest: d.isTest === true,
      fromCode: d.fromCode||'',
      toCode: d.toCode||'',
      // –ü–æ–∫–∞–∑ –Ω–∞–∑–≤ ¬´–í—ñ–¥/–î–æ¬ª: —Å–ø–µ—Ä—à—É –±–µ—Ä–µ–º–æ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –º–∞—Ä—à—Ä—É—Ç—É (fromLabel/toLabel),
      // –∞ –≤–∂–µ –ø–æ—Ç—ñ–º —Ñ–æ–ª–±–µ–∫–æ–º –∑ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ –∑–∞ –∫–æ–¥–æ–º. –¢–∞–∫ –ª–æ–≥—ñ—Å—Ç –ø–æ–±–∞—á–∏—Ç—å –Ω–∞–∑–≤–∏ –Ω–∞–≤—ñ—Ç—å –±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞.
  fromName: (d.fromName || shortByLabel(d.fromLabel) || nameByCode(d.fromCode) || ''),
  toName:   (d.toName   || shortByLabel(d.toLabel)   || nameByCode(d.toCode)   || ''),
  // –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª: —Å–ø–µ—Ä—à—É –±–µ—Ä–µ–º–æ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—è–∫—â–æ —î), –ø–æ—Ç—ñ–º –≤–∏—Ç—è–≥—É—î–º–æ –∑ Label, –¥–∞–ª—ñ ‚Äî –∑ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞
  fromUnit: unitByPurpose,
  toUnit:   unitToRaw,
      viaNames: viaArr.join(' ‚Ä¢ '),
      distance_km: (typeof d.distance_km==='number')? d.distance_km : NaN,
      type: d.routeType||'',
      purpose: (d.purpose || d.routePurpose || ''),
      logisticName: d.logisticName || '',
      logisticId: d.logisticId || '',
      statusRaw: statusValue, statusLabel, rejectComment,
      createdAtRaw: d.createdAt || null,
      createdAt: formatDate(d.createdAt),
      updatedAtRaw: d.updatedAt || null,
	  updatedAt: formatDate(d.updatedAt),
      decisionAtRaw: (d.approval?.decisionAt || null),
      decisionAt: formatDate(d.approval?.decisionAt),
	  raw: d,
      isActive: (d.isActive === false) ? false : true,
      hasProposal: !!d.proposal
    });
  });
  const lastDoc = snap.docs[snap.docs.length-1] || null;
  
  // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è testMode
  if (isTestMode) {
    console.log(`[parseSnap] TEST MODE: –ø–æ–∫–∞–∑–∞–Ω–æ ${rows.length} –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –∑ ${snap.size} –≤—Å—å–æ–≥–æ`);
  }
  
  return { rows, lastDoc };
}

async function loadFirstPage(forceServer=false){
  FORCE_SERVER = !!forceServer;
  _baseQuery = buildBaseQuery();

  stopLive();                 // ‚Üê –¥–æ–¥–∞–Ω–æ: –∑—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –ø—ñ–¥–ø–∏—Å–∫—É
  _cursor = null; _hasMore = false; allRows = [];

  let snap = null;
  try { snap = await _baseQuery.limit(PAGE_SIZE).get({source: FORCE_SERVER ? 'server' : 'default'}); }
  catch(e){
    console.warn('loadFirstPage fallback:', e?.message||e);
    try { snap = await _baseQuery.limit(PAGE_SIZE).get({source:'cache'}); } catch(_){}
  }
  if (!snap) return [];
  const { rows, lastDoc } = parseSnap(snap);
  allRows = rows;
  _cursor = lastDoc;
  _hasMore = !!lastDoc && snap.size === PAGE_SIZE;

  startLive(PAGE_SIZE);       // ‚Üê –¥–æ–¥–∞–Ω–æ: –≤—ñ–¥—Ç–µ–ø–µ—Ä –≤—Å—ñ –∑–º—ñ–Ω–∏ –ª–µ—Ç—è—Ç—å —É —Ç–∞–±–ª–∏—Ü—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
  return rows;
}

async function loadNextPage(){
  if (_liveEnabled){
    _liveLimit += PAGE_SIZE;   // –∑–±—ñ–ª—å—à—É—î–º–æ –≤—ñ–∫–Ω–æ –ø—ñ–¥–ø–∏—Å–∫–∏
    startLive(_liveLimit);     // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ —Å–ª—É—Ö–∞—á –∑ –±—ñ–ª—å—à–∏–º –ª—ñ–º—ñ—Ç–æ–º
    return [];
  }

  // ‚Üì —Å—Ç–∞—Ä–∏–π —Ä–µ–∂–∏–º (—è–∫—â–æ live –≤–∏–º–∫–Ω–µ–Ω–∏–π ‚Äî –ª–∏—à–∞—î–º–æ —è–∫ —Ñ–æ–ª–±–µ–∫)
  if (!_baseQuery || !_cursor) return [];
  let snap = null;
  try { snap = await _baseQuery.startAfter(_cursor).limit(PAGE_SIZE).get({source: FORCE_SERVER ? 'server' : 'default'}); }
  catch(e){
    console.warn('loadNextPage fallback:', e?.message||e);
    try { snap = await _baseQuery.startAfter(_cursor).limit(PAGE_SIZE).get({source:'cache'}); } catch(_){}
  }
  if (!snap) return [];
  const { rows, lastDoc } = parseSnap(snap);
  _cursor = lastDoc;
  _hasMore = !!lastDoc && snap.size === PAGE_SIZE;
  allRows = allRows.concat(rows);
  return rows;
}
/* ===== –°–ø–∏—Å–æ–∫ –•–ê–ë—ñ–≤ –¥–ª—è –≤–µ—Ä—Ö–Ω—å–æ–≥–æ input+datalist ===== */
function fillHubsList(){
  const input = document.getElementById('hubFilter');
  const list  = document.getElementById('hubsList');
  if (!input || !list) return;

  const prev = input.value;          // –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  const set  = new Set();

  // 1) –∑ —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  const hubsByRole = Array.isArray(window.__userHubs) ? window.__userHubs : (allowedHubs || []);
  hubsByRole.forEach(h => h && set.add(String(h)));

  // 2) –∑ —É–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤
  (allRows || []).forEach(r => { if (r.hub) set.add(String(r.hub)); });

  const hubs = Array.from(set).sort((a,b) => a.localeCompare(b,'uk'));

  // –Ω–∞–ø–æ–≤–Ω—é—î–º–æ datalist (–±–µ–∑ "‚Äî –≤—Å—ñ ‚Äî", –±–æ –¥–ª—è datalist —Ü–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
  list.innerHTML = hubs.map(h => `<option value="${h}"></option>`).join('');

  // —è–∫—â–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è —â–µ —î —É —Å–ø–∏—Å–∫—É ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ
  if (prev && (prev === '' || hubs.includes(prev))) input.value = prev;
}

/* ---------- –§—ñ–ª—å—Ç—Ä–∏ (–≤–µ—Ä—Ö–Ω—ñ) ---------- */
function applyTopFilters(rows){
  const unit = document.getElementById('unitFilter')?.value.trim() || '';
  const dmin = parseFloat(document.getElementById('distMin')?.value);
  const dmax = parseFloat(document.getElementById('distMax')?.value);
  const logistText = (document.getElementById('logistFilter')?.value || '').trim();
  const logistId = getLogistIdByInput('logistFilter');

  return rows.filter(r=>{
    if (unit && !(r.fromUnit === unit || r.toUnit === unit)) return false;
    const dist = r.distance_km;
    if (!Number.isFinite(dist)) return false;
    if (!Number.isNaN(dmin) && isFinite(dmin) && dist < dmin) return false;
    if (!Number.isNaN(dmax) && isFinite(dmax) && dist > dmax) return false;
    if (logistText && !logistId) {
      const n = _norm(logistText);
      if (!_norm(r.logisticName).includes(n)) return false;
    }
    return true;
  });
}

/* ---------- –§—ñ–ª—å—Ç—Ä–∏ (—Ä—è–¥–æ–∫ —É —à–∞–ø—Ü—ñ —Ç–∞–±–ª–∏—Ü—ñ) ---------- */
function getTableFilterState(){
  const typeEl = document.getElementById('f_type');
  const statusEl = document.getElementById('f_status');
  const typeMulti = (()=>{ try{ return JSON.parse(typeEl?.dataset.multi||''); }catch{ return null; } })() || [];
  const statusMulti = (()=>{ try{ return JSON.parse(statusEl?.dataset.multi||''); }catch{ return null; } })() || [];
  const typeArr = (typeMulti && typeMulti.length) ? typeMulti : ((typeEl && typeEl.value) ? [typeEl.value] : []);
  const statusArr = (statusMulti && statusMulti.length) ? statusMulti : ((statusEl && statusEl.value) ? [statusEl.value] : []);
  return {
    hub: document.getElementById('f_hub').value.trim(),
    fromCode:  document.getElementById('f_fromCode').value.trim(),
    toCode:    document.getElementById('f_toCode').value.trim(),
    fromName:  document.getElementById('f_fromName').value.trim(),
    unitFrom:  document.getElementById('f_unitFrom').value.trim(),
    toName:    document.getElementById('f_toName').value.trim(),
    via:       document.getElementById('f_via').value.trim(),
    distMin:   toNum(document.getElementById('f_distMin').value),
    distMax:   toNum(document.getElementById('f_distMax').value),
    type:      typeArr,
    purpose:   document.getElementById('f_purpose').value.trim(),
    logist:    document.getElementById('f_logist').value.trim(),
    status:    statusArr,
    comment:   document.getElementById('f_comment').value.trim(),
    createdFrom: document.getElementById('f_createdFrom')?.value || '',
    createdTo:   document.getElementById('f_createdTo')?.value || '',
    changedFrom: document.getElementById('f_changedFrom')?.value || '',
    changedTo:   document.getElementById('f_changedTo')?.value || '',
    decidedFrom: document.getElementById('f_decidedFrom')?.value || '',
    decidedTo:   document.getElementById('f_decidedTo')?.value || '',
    routeKey:  document.getElementById('f_routeKey').value.trim(),
    id:        document.getElementById('f_id').value.trim(),
  };
}

// ‚Äî‚Äî‚Äî –î–æ–ø–æ–º—ñ–∂–Ω—ñ –¥–ª—è –º—É–ª—å—Ç–∏-—Ñ—ñ–ª—å—Ç—Ä—ñ–≤ ‚Äî‚Äî‚Äî
const EF_EMPTY_TOKEN = '__EMPTY__';
const EF_EMPTY_LABEL = '(–ø–æ—Ä–æ–∂–Ω—å–æ)';
function isEmptyCell(v){
  const raw = String(v ?? '').trim();
  if (!raw) return true;
  return raw === '-' || raw === '‚Äî' || raw === '‚Äì';
}
function splitMulti(s){ return String(s||'').split(/[,;|\n]+/).map(v=>v.trim()).filter(Boolean); }
function matchTextNeedles(hay, needles){
  const raw = String(hay ?? '');
  const H = _norm(raw);
  if (!needles || !needles.length) return true;
  const hasEmpty = needles.includes(EF_EMPTY_TOKEN);
  const others = needles.filter(n => n && n !== EF_EMPTY_TOKEN);
  if (hasEmpty && ( !H || isEmptyCell(raw) )) return true; // —è–≤–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ (–≤—Ä–∞—Ö–æ–≤—É—î–º–æ -, ‚Äì, ‚Äî)
  return others.some(n => H.includes(_norm(n)));
}

function applyTableFilters(rows, fOverride){
  const f = fOverride || getTableFilterState();
  // –§—ñ–ª—å—Ç—Ä–∏ –¥–∞—Ç –¥–ª—è —Ç—Ä—å–æ—Ö –∫–æ–ª–æ–Ω–æ–∫
  const createdFrom = f.createdFrom ? new Date(dayStartISO(f.createdFrom)) : null;
  const createdTo   = f.createdTo   ? new Date(dayEndISO(f.createdTo))     : null;
  const changedFrom = f.changedFrom ? new Date(dayStartISO(f.changedFrom)) : null;
  const changedTo   = f.changedTo   ? new Date(dayEndISO(f.changedTo))     : null;
  const decidedFrom = f.decidedFrom ? new Date(dayStartISO(f.decidedFrom)) : null;
  const decidedTo   = f.decidedTo   ? new Date(dayEndISO(f.decidedTo))     : null;

  // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å —ñ–∑ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
  const hubNeedles      = splitMulti(f.hub);
  const fromCodeNeedles = splitMulti(f.fromCode);
  const toCodeNeedles   = splitMulti(f.toCode);
  const fromNameNeedles = splitMulti(f.fromName);
  const unitNeedles     = splitMulti(f.unitFrom);
  const toNameNeedles   = splitMulti(f.toName);
  const viaNeedles      = splitMulti(f.via);
  const purposeNeedles  = splitMulti(f.purpose);
  const logistNeedles   = splitMulti(f.logist);
  const commentNeedles  = splitMulti(f.comment);
  const keyNeedles      = splitMulti(f.routeKey);
  const idNeedles       = splitMulti(f.id);

  const typeSet   = Array.isArray(f.type)   && f.type.length   ? new Set(f.type)   : null;
  const statusSet = Array.isArray(f.status) && f.status.length ? new Set(f.status) : null;

  return rows.filter(r=>{
    if (!matchTextNeedles(r.hub,        hubNeedles)) return false;
    if (!matchTextNeedles(r.fromCode,   fromCodeNeedles)) return false;
    if (!matchTextNeedles(r.toCode,     toCodeNeedles)) return false;
    if (!matchTextNeedles(r.fromName,   fromNameNeedles)) return false;
    if (!matchTextNeedles(r.fromUnit,   unitNeedles)) return false;
    if (!matchTextNeedles(r.toName,     toNameNeedles)) return false;
    if (!matchTextNeedles(r.viaNames,   viaNeedles)) return false;
  if (!matchTextNeedles(r.purpose,    purposeNeedles)) return false;

    const dist = r.distance_km;
    if (Number.isFinite(f.distMin) && dist < f.distMin) return false;
    if (Number.isFinite(f.distMax) && dist > f.distMax) return false;

    if (typeSet){
      const v = r.type || '';
      const ok = isEmptyCell(v) ? typeSet.has(EF_EMPTY_TOKEN) : typeSet.has(v);
      if (!ok) return false;
    }
  if (logistNeedles.length && !matchTextNeedles(r.logisticName, logistNeedles)) return false;
    if (statusSet){
      const v = r.statusLabel || '';
      const ok = isEmptyCell(v) ? statusSet.has(EF_EMPTY_TOKEN) : statusSet.has(v);
      if (!ok) return false;
    }
  if (commentNeedles.length && !matchTextNeedles(r.rejectComment, commentNeedles)) return false;

    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
    if ((createdFrom || createdTo) && r.createdAtRaw){
      const d = new Date(r.createdAtRaw);
      if (createdFrom && d < createdFrom) return false;
      if (createdTo && d > createdTo) return false;
    }

    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ –∑–º—ñ–Ω–∏
    if ((changedFrom || changedTo) && r.updatedAtRaw){
      const d = new Date(r.updatedAtRaw);
      if (changedFrom && d < changedFrom) return false;
      if (changedTo && d > changedTo) return false;
    }

    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è
    if ((decidedFrom || decidedTo) && r.decisionAtRaw){
      const d = new Date(r.decisionAtRaw);
      if (decidedFrom && d < decidedFrom) return false;
      if (decidedTo && d > decidedTo) return false;
    }

  if (keyNeedles.length && !matchTextNeedles(r.routeKey, keyNeedles)) return false;
  if (idNeedles.length && !matchTextNeedles(r.id, idNeedles)) return false;

    return true;
  });
}

/* ---------- –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–∫–∞–∑–æ–∫ —É —Ñ—ñ–ª—å—Ç—Ä–∞—Ö —à–∞–ø–∫–∏ (–ª–∏—à–µ –∑—ñ –∑–Ω–∞—á–µ–Ω—å —É –ø–æ—Ç–æ—á–Ω—ñ–π —Ç–∞–±–ª–∏—Ü—ñ) ---------- */
function uniqSorted(arr){
  try{
    return Array.from(new Set((arr || []).map(v => String(v || '').trim()).filter(v => v))).sort((a,b)=>a.localeCompare(b,'uk'));
  }catch{
    return [];
  }
}

function setDatalistOptions(listId, values){
  const list = document.getElementById(listId);
  if (!list) return;
  const opts = (values || []).map(v => `<option value="${v}"></option>`).join('');
  list.innerHTML = opts;
}

function rebuildSelectOptions(selectId, values){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const uniq = uniqSorted(values || []);
  const isMulti = !!sel.multiple;
  const prevSet = isMulti ? new Set(Array.from(sel.selectedOptions).map(o=>o.value)) : null;
  const prevVal = isMulti ? null : sel.value;

  sel.innerHTML = isMulti
    ? uniq.map(v=>`<option>${v}</option>`).join('')
    : [''].concat(uniq).map(v => v === '' ? '<option value=""></option>' : `<option>${v}</option>`).join('');

  if (isMulti){
    Array.from(sel.options).forEach(o => { o.selected = prevSet ? prevSet.has(o.value) : false; });
  } else {
    if (uniq.includes(prevVal)) sel.value = prevVal; else sel.value = '';
  }
}

function updateColumnFilterLists(rows){
  const hubs   = uniqSorted(rows.map(r => r.hub));
  const fCodes = uniqSorted(rows.map(r => r.fromCode));
  const tCodes = uniqSorted(rows.map(r => r.toCode));
  const fNames = uniqSorted(rows.map(r => r.fromName));
  const fUnits = uniqSorted(rows.map(r => r.fromUnit));
  const tNames = uniqSorted(rows.map(r => r.toName));
  const logs   = uniqSorted(rows.map(r => r.logisticName));
  const stats  = uniqSorted(rows.map(r => r.statusLabel));
  const purposes = uniqSorted(rows.map(r => r.purpose));
  // –†–æ–∑–±–∏–≤–∞—î–º–æ –ø—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏ –Ω–∞ –æ–∫—Ä–µ–º—ñ –Ω–∞–∑–≤–∏
  const viaRaw = rows.map(r => r.viaNames || '').filter(Boolean);
  const viaParts = uniqSorted(viaRaw.flatMap(s => String(s).split(',').map(x => x.trim()).filter(Boolean)));
  const comments = uniqSorted(rows.map(r => r.rejectComment));
  const routeKeys = uniqSorted(rows.map(r => r.routeKey));
  const ids = uniqSorted(rows.map(r => r.id));
  const types = uniqSorted(rows.map(r => r.type));

  setDatalistOptions('fHubsList', hubs);
  setDatalistOptions('fFromCodesList', fCodes);
  setDatalistOptions('fToCodesList', tCodes);
  setDatalistOptions('fFromNamesList', fNames);
  setDatalistOptions('fUnitsList', fUnits);
  setDatalistOptions('fToNamesList', tNames);
  setDatalistOptions('fLogistsList', logs);
  setDatalistOptions('fPurposeList', purposes);
  setDatalistOptions('fViaList', viaParts);
  setDatalistOptions('fCommentsList', comments);
  setDatalistOptions('fRouteKeysList', routeKeys);
  setDatalistOptions('fIdsList', ids);

  // –û–±–º–µ–∂–∏—Ç–∏ –æ–ø—Ü—ñ—ó —Å—Ç–∞—Ç—É—Å—É –ª–∏—à–µ —Ç–∏–º–∏, —â–æ –ø—Ä–∏—Å—É—Ç–Ω—ñ –≤ —Ç–∞–±–ª–∏—Ü—ñ (–ø–ª—é—Å –ø–æ—Ä–æ–∂–Ω—ñ–π)
  if (stats.length){ rebuildSelectOptions('f_status', stats); }
  // –¢–µ —Å–∞–º–µ –¥–ª—è —Ç–∏–ø—ñ–≤ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
  if (types.length){ rebuildSelectOptions('f_type', types); }
}

/* ---------- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è ---------- */
function compareRows(a,b,key){
  const dir = sortState.dir;
  const getStr = s => String(s||'').toLocaleLowerCase('uk');
  switch(key){
    case 'distance_km': {
      const av = Number.isFinite(a.distance_km) ? a.distance_km : -Infinity;
      const bv = Number.isFinite(b.distance_km) ? b.distance_km : -Infinity;
      return (av - bv) * dir;
    }
    case 'updatedAtRaw': {
      const av = a.updatedAtRaw ? new Date(a.updatedAtRaw).getTime() : 0;
      const bv = b.updatedAtRaw ? new Date(b.updatedAtRaw).getTime() : 0;
      return (av - bv) * dir;
    }
    default: {
      const av = getStr(a[key]);
      const bv = getStr(b[key]);
      const r = av.localeCompare(bv,'uk');
      return r * dir;
    }
  }
}

function sortRows(rows){
  if (!sortState.key) return rows;
  const arr = rows.slice();
  arr.sort((a,b)=>{
    const r = compareRows(a,b,sortState.key);
    if (r !== 0) return r;
    const av = a.updatedAtRaw ? new Date(a.updatedAtRaw).getTime() : 0;
    const bv = b.updatedAtRaw ? new Date(b.updatedAtRaw).getTime() : 0;
    return (bv - av);
  });
  return arr;
}

function updateSortIcons(){
  document.querySelectorAll('#resTable thead th.sortable').forEach(th=>{
    const k = th.getAttribute('data-sort');
    const s = th.querySelector('.s');
    th.classList.toggle('active', sortState.key === k);
    if (!s) return;
    if (sortState.key !== k){ s.textContent = '‚Üï'; return; }
    s.textContent = sortState.dir === 1 ? '‚ñ≤' : '‚ñº';
  });
}

/* ---------- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---------- */
function updateStats(rows){
  const statsBox = document.getElementById('statsInfo');
  if (!rows.length){ statsBox.style.display='none'; return; }
  const nums = rows.map(r=>r.distance_km).filter(Number.isFinite);
  if (!nums.length){ statsBox.style.display='none'; return; }
  const max = Math.max(...nums), min = Math.min(...nums), avg = nums.reduce((a,b)=>a+b,0)/nums.length;
  document.getElementById('statMax').textContent = `–ù–∞–π–±—ñ–ª—å—à–∞: ${max.toFixed(3)}`;
  document.getElementById('statMin').textContent = `–ù–∞–π–º–µ–Ω—à–∞: ${min.toFixed(3)}`;
  document.getElementById('statAvg').textContent = `–°–µ—Ä–µ–¥–Ω—è: ${avg.toFixed(3)}`;
  statsBox.style.display='';
}

/* ---------- –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä ---------- */
async function buildNavigatePayloadById(routeId, prettyName){
  const ref = db.collection('routes').doc(routeId);
  const doc = await ref.get();
  if (!doc.exists) throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  const d = doc.data() || {};

  let points =
      normalizePoints(d.points) ||
      normalizePoints(d.coordinates) ||
      normalizePoints(d.route) ||
      normalizePoints(d.geojson) ||
      normalizePoints(d.geometry);

  if (!points) {
    const parts = [];
    if (d.start) { const p = toLonLat(d.start); if (p) parts.push(p); }
    if (Array.isArray(d.midpoints)) for (const m of d.midpoints){ const p=toLonLat(m); if (p) parts.push(p); }
    if (d.end) { const p = toLonLat(d.end); if (p) parts.push(p); }
    if (parts.length >= 2) points = parts;
  }
  if (!points || points.length < 2) throw new Error('–£ –º–∞—Ä—à—Ä—É—Ç—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –º–∞—Å–∏–≤ —Ç–æ—á–æ–∫');

  const manualSegments = normalizeSegments(d);
  return { name: prettyName || '–ú–∞—Ä—à—Ä—É—Ç', points: roundCoords(points), manualSegments: (manualSegments || []).map(roundCoords) };
}

function buildNavigateURLFromPayload(payloadObj){
  const base = `${location.origin}${NAVIGATE_PAGE}`;
  const q = new URLSearchParams();
  // –î–æ–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É, —â–æ–± navigate.html –Ω–µ –≤–∏–º–∞–≥–∞–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  q.set('public', '1');
  try { const json = JSON.stringify(payloadObj); const srcz = LZString.compressToEncodedURIComponent(json); q.set('srcz', srcz); } catch(e){ console.warn('Compression failed:', e); }
  try { q.set('src', b64encodeUtf8(payloadObj)); } catch(e){}
  return `${base}?${q.toString()}`;
}

function isMobileUA(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || ''); }
async function shareURL(url, title){
  if (isMobileUA() && navigator.share){ try { await navigator.share({ title: title || '–ú–∞—Ä—à—Ä—É—Ç', url }); return; } catch{} }
  try { await navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!'); }
  catch { prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤—Ä—É—á–Ω—É:', url); }
}

async function exportJsonFromRows(rows){
  // rows ‚Äî —Ü–µ —Ä—è–¥–∫–∏ —Ç–∞–±–ª–∏—Ü—ñ –∑ –ø–æ–ª–µ–º raw (–ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
  const data = rows.map(r => {
    const full = r.raw ? r.raw : {};        // –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
    const normalized = (full);
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å id —É –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Å—ñ
    return Object.assign({ id: r.id }, normalized);
  });

  const ts = new Date(); const pad = n=>String(n).padStart(2,'0');
  const fname = `routes_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
  downloadJson(data, fname);
}
/* ==== –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–¥–∏–º—ñ—Å—Ç—é –∫–æ–ª–æ–Ω–æ–∫ (—á–µ–∫–±–æ–∫—Å–∏ –ª—ñ–≤–æ—Ä—É—á) ==== */
const VCOL_KEY = 'export.visibleColumns.v1'; // –∫–ª—é—á –¥–ª—è localStorage  ‚Üê –î–û–î–ê–¢–ò
const COLS_ORDER = [
  'hub','unit','fromCode','toCode','fromName','toName','via','distance','type','purpose',
  'logist','status','testMode','created','changed','decided','comment','routeKey','id','map','review','navigator','json',
  'delete' // ‚¨Ö –¥–æ–¥–∞–Ω–æ
];
const COL_LABEL = {
  hub:'–•–ê–ë', fromCode:'–ö–æ–¥ –í—ñ–¥', toCode:'–ö–æ–¥ –î–æ', fromName:'–í—ñ–¥', unit:'–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª', toName:'–î–æ',
  via:'–ü—Ä–æ–º—ñ–∂–Ω—ñ –ø—É–Ω–∫—Ç–∏', distance:'–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º', type:'–¢–∏–ø', purpose:'–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è', logist:'–õ–æ–≥—ñ—Å—Ç',
  status:'–°—Ç–∞—Ç—É—Å –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è', testMode:'–¢–µ—Å—Ç', created:'–î–∞—Ç–∞ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è', changed:'–î–∞—Ç–∞ –ó–º—ñ–Ω–∏', decided:'–î–∞—Ç–∞ –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è',
  comment:'–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è',
  routeKey:'–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç—É', id:'ID', map:'–ö–∞—Ä—Ç–∞', navigator:'–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä', json:'JSON',
  review:'–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è', delete:'–í–∏–¥–∞–ª–∏—Ç–∏' // ‚¨Ö –¥–æ–¥–∞–Ω–æ
};
const COL_INDEX = Object.fromEntries(COLS_ORDER.map((k,i)=>[k,i+1]));

// –ú–æ–∂–µ—à –∑–∞–±—Ä–∞—Ç–∏ 'delete' —ñ–∑ –¥–µ—Ñ–æ–ª—Ç–Ω–∏—Ö, —è–∫—â–æ –Ω–µ —Ç—Ä–µ–±–∞ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –æ–¥—Ä–∞–∑—É
const DEFAULT_VISIBLE = new Set([
  'hub','fromName','unit','toName','via','distance','type','purpose','status','created','changed','decided','map','review','delete'
]);

const EXCEL_EXCLUDE = new Set(['map','navigator','json','review','delete']); // ‚¨Ö –¥–æ–¥–∞–Ω–æ

// –≤–∞–≥–∏ –¥–ª—è –∞–≤—Ç–æ-—Ä–æ–∑—Ç—è–≥—É–≤–∞–Ω–Ω—è
const COL_WEIGHTS = {
  via: 2.2, comment: 2.0, fromName: 1.3, unit: 1.1, toName: 1.3,
  hub: 1, fromCode: 1, toCode: 1, distance: 1, type: 1, purpose: 1,
  logist: 1, status: 1, created: 1.2, changed: 1.2, decided: 1.2, routeKey: 1, id: 1,
  map: 1, navigator: 1, json: 1, review: 1, delete: 1
};

// –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ —à–∏—Ä–∏–Ω–∏
const COL_MIN_PX = {
  via: 280, comment: 240, fromName: 160, unit: 140, toName: 160,
  hub: 110, fromCode: 110, toCode: 110, distance: 120, type: 120,
  logist: 140, status: 140, created: 160, changed: 160, decided: 160, routeKey: 160, id: 160,
  map: 120, navigator: 120, json: 120, review: 120, delete: 120
};

/// –Ø–∫—â–æ –≤–∏–¥–∏–º–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –º–∞–ª–æ —ñ –≤–æ–Ω–∏ –≤–ª–∞–∑—è—Ç—å —É –≤—ñ–∫–Ω–æ ‚Äî —Ä–æ–∑—Ç—è–≥—É—î–º–æ –≤—ñ–¥—Å–æ—Ç–∫–∞–º–∏.
// –Ø–∫—â–æ —É –∫–æ–ª–æ–Ω–æ–∫ –≤–∂–µ –∑–∞–¥–∞–Ω—ñ —Ä—É—á–Ω—ñ —à–∏—Ä–∏–Ω–∏ (–ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è/–∞–≤—Ç–æ—à–∏—Ä–∏–Ω–∞) ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ —á—ñ–ø–∞—î–º–æ.
function fitTableToViewport() {
  const card  = document.querySelector('.results-card');
  const wrap  = card?.querySelector('.table-wrap');
  const table = document.getElementById('resTable');
  if (!wrap || !table) return;

  const cols = table.querySelectorAll('colgroup col');
  const visibleKeys = COLS_ORDER.filter(k => visibleCols.has(k));

  // —è–∫—â–æ —î —Ö–æ—á –æ–¥–Ω–∞ –∑–∞–¥–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ ‚Äî –ø–æ–≤–∞–∂–∞—î–º–æ —ó—ó —ñ –Ω–µ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î–º–æ
  const hasManual = Array.from(cols).some(c => c.style.width);
  if (hasManual){
    table.style.tableLayout = 'fixed';
    syncXWidth();
    return;
  }

  // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –≤–∏–¥–∏–º–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
  const needed = visibleKeys.reduce((s, k) => s + (COL_MIN_PX[k] || 140), 0) + 24;
  const avail  = wrap.clientWidth;

  // –æ—á–∏—â–∞—î–º–æ –ª–∏—à–µ —è–∫—â–æ –Ω–µ–º–∞—î —Ä—É—á–Ω–∏—Ö —à–∏—Ä–∏–Ω
  cols.forEach(c => (c.style.width = ''));

  if (needed <= avail) {
    // –í–º—ñ—â–∞—î—Ç—å—Å—è ‚Äî —Ä–æ–∑—Ç—è–≥—É—î–º–æ –≤—ñ–¥—Å–æ—Ç–∫–∞–º–∏ –∑ –≤–∞–≥–∞–º–∏
    table.style.tableLayout = 'fixed';
    const totalWeight = visibleKeys.reduce((s, k) => s + (COL_WEIGHTS[k] || 1), 0);
    visibleKeys.forEach(k => {
      const idx = COL_INDEX[k] - 1;
      if (!cols[idx]) return;
      const pct = ((COL_WEIGHTS[k] || 1) / totalWeight) * 100;
      cols[idx].style.width = pct.toFixed(4) + '%';
    });
  } else {
    // –ù–µ –≤–º—ñ—â–∞—î—Ç—å—Å—è ‚Äî ¬´–ø—Ä–∏—Ä–æ–¥–Ω–∞¬ª —à–∏—Ä–∏–Ω–∞ + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª
    table.style.tableLayout = 'auto';
  }

  syncXWidth();
}

let visibleCols = new Set();
function loadVisibleCols(){
  try{
    const raw = localStorage.getItem(VCOL_KEY);
    if (raw != null) {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) {
        const ok = arr.filter(k => COLS_ORDER.includes(k));
        // —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–≤—ñ–¥–æ–º–æ –∑–±–µ—Ä—ñ–≥ –ø–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫ ‚Äî –ª–∏—à–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–º
        if (arr.length === 0) { visibleCols = new Set(); return; }
        // —è–∫—â–æ –≤ –º–∞—Å–∏–≤—ñ –±—É–ª–∏ –≤–∞–ª—ñ–¥–Ω—ñ –∫–ª—é—á—ñ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—Ö
        if (ok.length > 0) { visibleCols = new Set(ok); return; }
        // —è–∫—â–æ –≤ –º–∞—Å–∏–≤—ñ –±—É–ª–∏ –ª–∏—à–µ –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ –∫–ª—é—á—ñ ‚Äî –≤–ø–∞–¥–µ–º–æ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ñ
      }
    }
  }catch{}
  visibleCols = new Set(DEFAULT_VISIBLE);
}
function saveVisibleCols(){
  try{ localStorage.setItem(VCOL_KEY, JSON.stringify([...visibleCols])); }catch{}
}
function setColVisible(key, show){
  const idx = COL_INDEX[key];
  if (!idx) return;

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ñ—ñ–ª—å—Ç—Ä–∏ + —Ç—ñ–ª–æ
  const sel = `#resTable thead tr > *:nth-child(${idx}), #resTable tbody tr > *:nth-child(${idx})`;
  document.querySelectorAll(sel).forEach(el => { el.style.display = show ? '' : 'none'; });

  // –í–ê–ñ–õ–ò–í–û: —Å–∞–º <col>, —â–æ–± –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ –≤–ø–ª–∏–≤–∞–ª–∞ –Ω–∞ —Ä–æ–∑–∫–ª–∞–¥–∫—É
  const colEl = document.querySelector(`#resTable colgroup col:nth-child(${idx})`);
  if (colEl) colEl.style.display = show ? '' : 'none';
}

function applyColumnVisibility(){
  COLS_ORDER.forEach(k => setColVisible(k, visibleCols.has(k)));
  fitTableToViewport();       // ‚Üê –∫–ª—é—á–æ–≤–∏–π –≤–∏–∫–ª–∏–∫
  enableResizableColumns();  // ‚Üê –î–û–î–ê–í
}

function buildColumnPickerUI(){
  loadVisibleCols();
  const box = document.getElementById('columnPicker');
  if (!box) return;
  box.innerHTML = `
    <h3>–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ</h3>
    <div class="list">
      ${COLS_ORDER.map(k=>`
        <label><input type="checkbox" data-colkey="${k}" ${visibleCols.has(k)?'checked':''}> ${COL_LABEL[k]}</label>
      `).join('')}
    </div>
    <div class="btns">
      <button type="button" class="btn sm" id="colsDefault">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</button>
      <button type="button" class="btn sm" id="colsAll">–£—Å—ñ</button>
      <button type="button" class="btn sm" id="colsNone">–ñ–æ–¥–Ω—ñ</button>
    </div>
  `;
  box.onchange = (e)=>{
    const cb = e.target.closest('input[type="checkbox"][data-colkey]'); if (!cb) return;
    const key = cb.getAttribute('data-colkey');
    if (cb.checked) visibleCols.add(key); else visibleCols.delete(key);
    saveVisibleCols(); applyColumnVisibility();
  };
  box.querySelector('#colsDefault')?.addEventListener('click', ()=>{
    visibleCols = new Set(DEFAULT_VISIBLE); saveVisibleCols(); buildColumnPickerUI(); applyColumnVisibility();
  });
  box.querySelector('#colsAll')?.addEventListener('click', ()=>{
    visibleCols = new Set(COLS_ORDER); saveVisibleCols(); buildColumnPickerUI(); applyColumnVisibility();
  });
  box.querySelector('#colsNone')?.addEventListener('click', ()=>{
    visibleCols = new Set(); saveVisibleCols(); buildColumnPickerUI(); applyColumnVisibility();
  });
}

/* ---------- –¢–∞–±–ª–∏—Ü—è ---------- */
function renderTable(rows){
  // üîë —Ö—Ç–æ –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –ª—ñ–Ω–∫ –Ω–∞ review / –≤–∏–¥–∞–ª–µ–Ω–Ω—è
  const canReview = userHasRole('admin') || userHasRole('security');
  const canDelete = userHasRole('admin');

  const tb = document.querySelector('#resTable tbody');
  tb.innerHTML = rows.map(r=>`<tr data-id="${r.id}" class="${r.isActive ? '' : 'is-inactive'}${r.isTest ? ' is-test' : ''}">
    <td>${r.hub || ''}</td>
    <td>${r.fromUnit || ''}</td>
    <td class="cell-code" title="${r.fromCode}">${r.fromCode}</td>
    <td class="cell-code" title="${r.toCode}">${r.toCode}</td>
    <td>${r.fromName}</td>
    <td>${r.toName}</td>
    <td class="cell-via">${r.viaNames || ''}</td>
    <td>${Number.isFinite(r.distance_km) ? r.distance_km.toFixed(3) : ''}</td>
    <td>${r.type}</td>
    <td>${r.purpose || ''}</td>
    <td>${r.logisticName || ''}</td>
  <td>${r.statusLabel || ''}${r.isActive ? ' üü©' : ' üü•'}</td>
    <td>${r.isTest ? 'üß™ –¢–µ—Å—Ç' : ''}</td>
    <td>${r.createdAt || ''}</td>
    <td>${r.updatedAt || ''}</td>
    <td>${r.decisionAt || ''}</td>
    <td class="cell-comment">${r.rejectComment ? r.rejectComment : ''}${r.hasProposal ? ` <span class="proposal-flag" title="–Ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –∑–º—ñ–Ω">–Ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è</span>` : ''}</td>
    <td class="cell-key" title="${r.routeKey || ''}">
      ${r.routeKey || ''}
      ${r.routeKey ? `<button class="copy-btn copy-key" data-val="${r.routeKey}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥">üìã</button>` : ''}
    </td>
    <td class="cell-id" title="${r.id}">
      ${r.id}
      <button class="copy-btn copy-id" data-val="${r.id}" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ ID">üìã</button>
    </td>
    <td><a href="${MAP_URL}?rid=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a></td>
    <td>${
      (r.statusLabel === '–ü–æ–≥–æ–¥–∂–µ–Ω–æ')
        ? '‚Äî'
        : (canReview
            ? `<a href="${REVIEW_PAGE}?rid=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">–ü–æ–≥–æ–¥–∏—Ç–∏</a>`
            : '‚Äî')
    }</td>
    <td class="cell-nav"><button class="btn sm nav-btn" data-id="${r.id}" data-name="${(r.fromName||'') + ' ‚Üí ' + (r.toName||'')}">üß≠ –ù–∞–≤—ñ–≥–∞—Ç–æ—Ä</button></td>
    <td><button class="btn sm json-one" data-id="${r.id}">JSON</button></td>
    <td class="cell-delete">${
      canDelete
        ? `<button class="btn sm danger del-one" data-id="${r.id}" data-name="${(r.fromName||'') + ' ‚Üí ' + (r.toName||'')}">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>`
        : '‚Äî'
    }</td>
  </tr>`).join('');

  document.getElementById('countInfo').textContent = `–ó–∞–ø–∏—Å—ñ–≤ (–ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—É): ${rows.length}`;
  updateStats(rows);

  // keep selection highlight if current row is still visible
  if (_selectedId){
    const tr = tb.querySelector(`tr[data-id="${CSS.escape(_selectedId)}"]`);
    if (tr) tr.classList.add('is-selected');
  }
}

/* ---------- –ï–∫—Å–ø–æ—Ä—Ç —É Excel ---------- */
function exportToExcel(rows, versionDate=null){
  const keys = COLS_ORDER.filter(k => visibleCols.has(k) && !EXCEL_EXCLUDE.has(k));
  if (!keys.length){ alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.'); return; }
  const header = keys.map(k => COL_LABEL[k]);

  const body = rows.map(r => keys.map(k => {
    switch(k){
      case 'hub':        return r.hub || '';
      case 'fromCode':   return r.fromCode || '';
      case 'toCode':     return r.toCode || '';
      case 'fromName':   return r.fromName || '';
      case 'unit':       return r.fromUnit || '';
      case 'toName':     return r.toName || '';
      case 'via':        return r.viaNames || '';
      case 'distance':   return Number.isFinite(r.distance_km) ? Number(r.distance_km.toFixed(3)) : '';
      case 'type':       return r.type || '';
      case 'purpose':    return r.purpose || '';
      case 'logist':     return r.logisticName || '';
      case 'status':     return r.statusLabel || '';
      case 'testMode':   return r.isTest ? '–¢–∞–∫' : '';
      case 'created':    return r.createdAt || '';
      case 'changed':    return r.updatedAt || '';
      case 'decided':    return r.decisionAt || '';
      case 'comment':    return r.rejectComment || '';
      case 'routeKey':   return r.routeKey || '';
      case 'id':         return r.id || '';
      case 'map': {
        const mapUrl = `${location.origin}${MAP_URL}?rid=${encodeURIComponent(r.id)}`;
        return { t:'s', v:'üó∫Ô∏è –í—ñ–¥–∫—Ä–∏—Ç–∏', l:{ Target: mapUrl, Tooltip: '–í—ñ–¥–∫—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç—ñ' } };
      }
      default:           return '';
    }
  }));

  const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
  ws['!cols'] = header.map(() => ({ wch: 18 }));
  ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{c:0,r:0}, e:{c:header.length-1,r:body.length} }) };

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä—à—Ä—É—Ç–∏');
  
  const filename = versionDate 
    ? `routes_export_${versionDate}.xlsx` 
    : 'routes_export.xlsx';
  XLSX.writeFile(wb, filename);
}

/* ---------- UI –¥–æ–ø–æ–º—ñ–∂–Ω–µ ---------- */
function updatePagerUI(){
  const moreBox = document.getElementById('moreBox');
  moreBox.style.display = allRows.length ? '' : 'none';
  btnMore.style.display = _hasMore ? '' : 'none';
  btnAll.style.display  = _hasMore ? '' : 'none';
}

/* ---------- –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É (—Ñ–æ—Ä—Å —ñ–∑ —Å–µ—Ä–≤–µ—Ä–∞) ---------- */
async function refreshAll(){
  try{
    setBusy(true);
    try{ localStorage.removeItem(DIR_CACHE_KEY); }catch{}
    try{ localStorage.removeItem(LOGISTS_CACHE_KEY); }catch{}
    await Promise.all([loadDirectory(true), loadLogists(true)]);
    await loadFirstPage(true);
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
}

/* ---------- –ü–æ–º–∏–ª–∫–∏ Firestore ---------- */
function handleFirestoreError(e){
  console.error('Firestore error:', e);
  const msg = e?.message || '';
  if (e?.code === 'failed-precondition' && msg.includes('create it here')) {
    const m = msg.match(/https:\/\/console\.firebase\.google\.com\/[^\s"]+/);
    if (m && m[0]) { const url = m[0]; try { window.open(url, '_blank'); } catch(_) {} alert('–î–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å —É Firestore.\n–Ø –≤—ñ–¥–∫—Ä–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.\n\n–ü–æ—Å–∏–ª–∞–Ω–Ω—è:\n' + url); return; }
  }
  alert(msg || e);
}

/* ---------- –†–µ–Ω–¥–µ—Ä ---------- */
function reRender(){
  let rows = applyTopFilters(allRows);
  rows = applyTableFilters(rows);
  // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥–∫–∞–∑–∫–∏ —É —à–∞–ø—Ü—ñ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º –Ω–∞–±–æ—Ä–æ–º —Ä—è–¥–∫—ñ–≤
  updateColumnFilterLists(rows);
  rows = sortRows(rows);
  renderTable(rows);
  applyColumnVisibility();
  updatePagerUI();
  updateSortIcons();
  syncXWidth();           // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ
  fillHubsList();         // ‚Üê –î–û–î–ê–ô –¶–ï: –æ–Ω–æ–≤–ª—é—î–º–æ datalist –∑ —Ö–∞–±–∞–º–∏
}

/* ---------- –ü–æ–¥—ñ—ó ---------- */
btnPreview.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    await loadFirstPage(true);   // ‚Üê –±—É–ª–æ false
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnMore.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    await loadNextPage();
    reRender();
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnAll.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    const MAX_ROWS = 50000; // –≤–∞—à –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫

    if (_liveEnabled){
      _liveLimit = MAX_ROWS;   // —Å–ª—É—Ö–∞—î–º–æ –º–∞–∫—Å–∏–º—É–º
      startLive(_liveLimit);
      // reRender() –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –∑ onSnapshot ‚Üí –Ω—ñ—á–æ–≥–æ –±—ñ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±–∞
    } else {
      while(_hasMore && allRows.length < MAX_ROWS){ await loadNextPage(); }
      reRender();
      if (_hasMore) alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${MAX_ROWS.toLocaleString()} —Ä—è–¥–∫—ñ–≤. –ó–≤—É–∑—å—Ç–µ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –µ–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ —á–∞—Å—Ç–∏–Ω–∞–º–∏.`);
    }
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnExport.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    if (_hasMore){
      const agree = confirm(`–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –í–°–Ü —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –µ–∫—Å–ø–æ—Ä—Ç–æ–º? –ó–∞—Ä–∞–∑ —É –ø–∞–º'—è—Ç—ñ ${allRows.length}+ —Ä—è–¥–∫—ñ–≤.`);
      if (agree){
        const MAX_ROWS = 50000;
        while(_hasMore && allRows.length < MAX_ROWS){ await loadNextPage(); }
        if (_hasMore) alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç ${MAX_ROWS.toLocaleString()} —Ä—è–¥–∫—ñ–≤. –ï–∫—Å–ø–æ—Ä—Ç –ø–æ –ø–µ—Ä—à–∏—Ö ${MAX_ROWS.toLocaleString()}.`);
      }
    }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    
    exportToExcel(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnRefresh.addEventListener('click', refreshAll);

/* Toggle map panel */
btnToggleMap.addEventListener('click', async ()=>{
  const toOpen = !_mapPanelOpen;
  if (toOpen){
    openMapPanel(true);
    await ensureMap().catch(e=>console.warn(e));
    try{ _map && _map.resize(); }catch(_){ }
    // If nothing selected yet, try select first visible row
    if (!_selectedId){
      const first = document.querySelector('#resTable tbody tr');
      if (first){
        const id = first.getAttribute('data-id');
        const row = allRows.find(r => r.id === id);
        if (row){ selectRowVisual(id); await drawRouteOnMap(row); }
      }
    }
    // sync style selector to current style
    try{
      const sel = document.getElementById('mapStyleDockExport');
      if (sel && _map?.getStyle()?.sprite){ /* no-op; keep default */ }
    }catch(_){ }
  } else {
    openMapPanel(false);
  }
});

document.querySelector('#resTable thead').addEventListener('click', (ev)=>{
  const th = ev.target.closest('th.sortable');
  if (!th) return;
  const key = th.getAttribute('data-sort');
  if (sortState.key === key) sortState.dir *= -1;
  else { sortState.key = key; sortState.dir = 1; }
  reRender();
});

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const onFilterChange = debounce(()=> reRender(), 200);
document.querySelector('#resTable thead').addEventListener('input', onFilterChange);
document.querySelector('#resTable thead').addEventListener('change', onFilterChange);
btnClearFilters.addEventListener('click', ()=>{
  document.querySelectorAll('#resTable thead .filters input, #resTable thead .filters select')
    .forEach(el=>{
      if (el.id === 'f_type' || el.id === 'f_status'){ el.removeAttribute('data-multi'); el.value=''; }
      else el.value='';
    });
  reRender();
});
// –í–µ—Ä—Ö–Ω—ñ ¬´–ª–æ–∫–∞–ª—å–Ω—ñ¬ª —Ñ—ñ–ª—å—Ç—Ä–∏ (—â–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ) ‚Äî –ª–∏—à–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—é—Ç—å —Ç–∞–±–ª–∏—Ü—é, –±–µ–∑ –∑–∞–ø–∏—Ç—ñ–≤
const onTopLocalFilterChange = debounce(() => reRender(), 200);
['unitFilter','distMin','distMax','logistFilter'].forEach((id) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', onTopLocalFilterChange);
});

// –ß–µ–∫–±–æ–∫—Å —Ç–µ—Å—Ç–æ–≤–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ - –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞
document.getElementById('testModeFilter')?.addEventListener('change', async () => {
  await refreshAll();
});

/* ===== Excel-like filter dropdowns ===== */
(function initExcelFilters(){
  const headerRow = document.querySelector('#resTable thead tr');
  if (!headerRow) return;
  // Add buttons into header cells with data-colkey
  headerRow.querySelectorAll('th[data-colkey]').forEach(th=>{
    const key = th.getAttribute('data-colkey');
    if (!key) return;
    // Avoid adding button into non-data columns (map/review/navigator/json/delete)
    if (['map','review','navigator','json','delete'].includes(key)) return;
    let btn = th.querySelector('.excel-filter-btn');
    if (btn) return;
    btn = document.createElement('button');
    btn.type = 'button'; btn.className = 'excel-filter-btn'; btn.textContent = '‚ñæ'; btn.title = '–§—ñ–ª—å—Ç—Ä';
    btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); openExcelFilter(key, btn); });
    th.appendChild(btn);
  });

  // Create singleton panel
  let panel = document.getElementById('excelFilterPanel');
  if (!panel){
    panel = document.createElement('div'); panel.id = 'excelFilterPanel'; panel.className = 'excel-filter-panel'; document.body.appendChild(panel);
  }
  document.addEventListener('click', (ev)=>{
    const p = document.getElementById('excelFilterPanel');
    if (!p || p.style.display!=='block') return;
    if (!ev.composedPath().includes(p)) closeExcelFilter();
  });
  document.addEventListener('keydown', (ev)=>{ if (ev.key==='Escape') closeExcelFilter(); });
  updateFilterButtonsActive();
})();

function getFilterElementsByKey(key){
  switch(key){
    case 'hub':       return { type:'text', el: document.getElementById('f_hub') };
    case 'unit':      return { type:'text', el: document.getElementById('f_unitFrom') };
    case 'fromCode':  return { type:'text', el: document.getElementById('f_fromCode') };
    case 'toCode':    return { type:'text', el: document.getElementById('f_toCode') };
    case 'fromName':  return { type:'text', el: document.getElementById('f_fromName') };
    case 'toName':    return { type:'text', el: document.getElementById('f_toName') };
    case 'via':       return { type:'text', el: document.getElementById('f_via') };
    case 'distance':  return { type:'range', min: document.getElementById('f_distMin'), max: document.getElementById('f_distMax') };
    case 'type':      return { type:'multi', el: document.getElementById('f_type') };
    case 'logist':    return { type:'text', el: document.getElementById('f_logist') };
    case 'status':    return { type:'multi', el: document.getElementById('f_status') };
    case 'created':   return { type:'date', from: document.getElementById('f_createdFrom'), to: document.getElementById('f_createdTo') };
    case 'changed':   return { type:'date', from: document.getElementById('f_changedFrom'), to: document.getElementById('f_changedTo') };
    case 'decided':   return { type:'date', from: document.getElementById('f_decidedFrom'), to: document.getElementById('f_decidedTo') };
    case 'comment':   return { type:'text', el: document.getElementById('f_comment') };
    case 'routeKey':  return { type:'text', el: document.getElementById('f_routeKey') };
    case 'id':        return { type:'text', el: document.getElementById('f_id') };
    default:          return null;
  }
}

function rowsForExcelDropdown(colKey){
  // Use all rows filtered by current state except the target column
  const f = getTableFilterState();
  const f2 = JSON.parse(JSON.stringify(f));
  const clear = (k)=>{ switch(k){
    case 'hub': f2.hub=''; break;
    case 'unit': f2.unitFrom=''; break;
    case 'fromCode': f2.fromCode=''; break;
    case 'toCode': f2.toCode=''; break;
    case 'fromName': f2.fromName=''; break;
    case 'toName': f2.toName=''; break;
    case 'via': f2.via=''; break;
    case 'distance': f2.distMin=NaN; f2.distMax=NaN; break;
    case 'type': f2.type=[]; break;
    case 'logist': f2.logist=''; break;
    case 'status': f2.status=[]; break;
    case 'comment': f2.comment=''; break;
    case 'created': f2.createdFrom=''; f2.createdTo=''; break;
    case 'changed': f2.changedFrom=''; f2.changedTo=''; break;
    case 'decided': f2.decidedFrom=''; f2.decidedTo=''; break;
    case 'routeKey': f2.routeKey=''; break;
    case 'id': f2.id=''; break;
  }};
  clear(colKey);
  try{ return applyTableFilters(allRows||[], f2); }catch(_){ return allRows||[]; }
}

function computeValuesForColumn(colKey, rows){
  const pick = (arr, key)=> (arr||[]).map(r=> r[key]).filter(v=> !!String(v||'').trim());
  switch(colKey){
    case 'hub': { const list = uniqSorted(pick(rows,'hub')); if ((rows||[]).some(r=> !_norm(r.hub))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'unit': { const list = uniqSorted(pick(rows,'fromUnit')); if ((rows||[]).some(r=> !_norm(r.fromUnit))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'fromCode': { const list = uniqSorted(pick(rows,'fromCode')); if ((rows||[]).some(r=> !_norm(r.fromCode))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'toCode': { const list = uniqSorted(pick(rows,'toCode')); if ((rows||[]).some(r=> !_norm(r.toCode))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'fromName': { const list = uniqSorted(pick(rows,'fromName')); if ((rows||[]).some(r=> !_norm(r.fromName))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'toName': { const list = uniqSorted(pick(rows,'toName')); if ((rows||[]).some(r=> !_norm(r.toName))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'via': {
      const list = [];
      (rows||[]).forEach(r=>{ String(r.viaNames||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(v=> list.push(v)); });
      const out = uniqSorted(list);
      if ((rows||[]).some(r=> !_norm(r.viaNames))) out.unshift(EF_EMPTY_TOKEN);
      return out;
    }
    case 'type': { const list = uniqSorted(pick(rows,'type')); if ((rows||[]).some(r=> !_norm(r.type))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'logist': { const list = uniqSorted(pick(rows,'logisticName')); if ((rows||[]).some(r=> !_norm(r.logisticName))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'status': { const list = uniqSorted(pick(rows,'statusLabel')); if ((rows||[]).some(r=> !_norm(r.statusLabel))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'comment': { const list = uniqSorted(pick(rows,'rejectComment')); if ((rows||[]).some(r=> !_norm(r.rejectComment))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'routeKey': { const list = uniqSorted(pick(rows,'routeKey')); if ((rows||[]).some(r=> !_norm(r.routeKey))) list.unshift(EF_EMPTY_TOKEN); return list; }
    case 'id': { const list = uniqSorted(pick(rows,'id')); if ((rows||[]).some(r=> !_norm(r.id))) list.unshift(EF_EMPTY_TOKEN); return list; }
    default: return [];
  }
}

function openExcelFilter(colKey, anchor){
  const cfg = getFilterElementsByKey(colKey); if (!cfg) return;
  const panel = document.getElementById('excelFilterPanel'); if (!panel) return;
  const rect = anchor.getBoundingClientRect();
  panel.style.left = Math.min(rect.left, window.innerWidth-360-8) + 'px';
  panel.style.top  = (rect.bottom + window.scrollY + 4) + 'px';

  // Build UI
  let html = '';
  if (cfg.type === 'range'){
    const curMin = cfg.min?.value||''; const curMax = cfg.max?.value||'';
    html += `<div class="head"><strong>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º</strong></div>`;
    html += `<div class="list">`+
            `<input type="number" id="ef_min" placeholder="–º—ñ–Ω." value="${curMin}">`+
            `<input type="number" id="ef_max" placeholder="–º–∞–∫—Å." value="${curMax}">`+
            `</div>`;
  } else if (cfg.type === 'date'){
    const curF = cfg.from?.value||''; const curT = cfg.to?.value||'';
    html += `<div class="head"><strong>–û–Ω–æ–≤–ª–µ–Ω–æ: –∑/–ø–æ</strong></div>`;
    html += `<div class="list">`+
            `<input type="date" id="ef_df" value="${curF}">`+
            `<input type="date" id="ef_dt" value="${curT}">`+
            `</div>`;
  } else if (cfg.type === 'multi'){
    const rows = rowsForExcelDropdown(colKey);
    const vals = computeValuesForColumn(colKey, rows);
    const selected = new Set(Array.from(cfg.el?.selectedOptions||[]).map(o=>o.value));
    html += `<div class="head"><input type="text" id="ef_q" placeholder="–ü–æ—à—É–∫..."><label><input type="checkbox" id="ef_all" checked> –í–∏–±—Ä–∞—Ç–∏ –≤—Å–µ</label></div>`;
    html += `<div class="list" id="ef_list">` + vals.map(v=>{
      const ch = selected.size? (selected.has(v)?'checked':'') : 'checked';
      const label = (v===EF_EMPTY_TOKEN) ? EF_EMPTY_LABEL : v;
      return `<label><input type="checkbox" value="${v.replace(/"/g,'&quot;')}" ${ch}> ${label}</label>`;
    }).join('') + `</div>`;
  } else { // text based -> checkbox list from unique values
    const rows = rowsForExcelDropdown(colKey);
    const vals = computeValuesForColumn(colKey, rows);
    const current = splitMulti(cfg.el?.value||''); const selected = new Set(current);
    html += `<div class="head"><input type="text" id="ef_q" placeholder="–ü–æ—à—É–∫..."><label><input type="checkbox" id="ef_all" ${selected.size?'' :'checked'}> –í–∏–±—Ä–∞—Ç–∏ –≤—Å–µ</label></div>`;
    html += `<div class="list" id="ef_list">` + vals.map(v=>{
      const ch = selected.size? (selected.has(v)?'checked':'') : 'checked';
      const label = (v===EF_EMPTY_TOKEN) ? EF_EMPTY_LABEL : v;
      return `<label><input type="checkbox" value="${v.replace(/"/g,'&quot;')}" ${ch}> ${label}</label>`;
    }).join('') + `</div>`;
  }
  html += `<div class="actions"><button class="btn" id="ef_clear">–û—á–∏—Å—Ç–∏—Ç–∏</button><button class="btn" id="ef_cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn primary" id="ef_apply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button></div>`;
  panel.innerHTML = html;
  panel.style.display = 'block';

  // Live search
  const q = document.getElementById('ef_q'); const list = document.getElementById('ef_list'); const all = document.getElementById('ef_all');
  if (q && list){
    q.addEventListener('input', ()=>{
      const s = _norm(q.value);
      Array.from(list.querySelectorAll('label')).forEach(l=>{ const t=_norm(l.textContent||''); l.style.display = t.includes(s) ? '' : 'none'; });
    });
  }
  if (all && list){
    all.addEventListener('change', ()=>{ Array.from(list.querySelectorAll('input[type="checkbox"]')).forEach(c=>{ if (c.parentElement.style.display!=='none') c.checked = all.checked; }); });
  }

  // Actions
  document.getElementById('ef_cancel')?.addEventListener('click', ()=> closeExcelFilter());
  document.getElementById('ef_clear')?.addEventListener('click', ()=>{
    if (cfg.type==='range'){ if (cfg.min) cfg.min.value=''; if (cfg.max) cfg.max.value=''; }
    else if (cfg.type==='date'){ if (cfg.from) cfg.from.value=''; if (cfg.to) cfg.to.value=''; }
    else if (cfg.type==='multi'){ if (cfg.el){ cfg.el.dataset.multi=''; cfg.el.value=''; } }
    else if (cfg.el){ cfg.el.value=''; }
    closeExcelFilter(); reRender(); updateFilterButtonsActive();
  });
  document.getElementById('ef_apply')?.addEventListener('click', ()=>{
    if (cfg.type==='range'){
      if (cfg.min) cfg.min.value = document.getElementById('ef_min').value;
      if (cfg.max) cfg.max.value = document.getElementById('ef_max').value;
    } else if (cfg.type==='date'){
      if (cfg.from) cfg.from.value = document.getElementById('ef_df').value;
      if (cfg.to) cfg.to.value = document.getElementById('ef_dt').value;
    } else if (cfg.type==='multi'){
      const chosen = Array.from(panel.querySelectorAll('#ef_list input[type="checkbox"]')).filter(c=>c.checked).map(c=>c.value);
      if (cfg.el){ cfg.el.dataset.multi = JSON.stringify(chosen); cfg.el.value=''; }
    } else if (cfg.el){
      const chosen = Array.from(panel.querySelectorAll('#ef_list input[type="checkbox"]')).filter(c=>c.checked).map(c=>c.value);
      // –Ø–∫—â–æ –≤—Å—ñ –æ–±—Ä–∞–Ω—ñ ‚Äî –æ—á–∏—â–∞—î–º–æ (–µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç –¥–æ "—É—Å—ñ")
      cfg.el.value = chosen.length ? chosen.join(', ') : '';
    }
    closeExcelFilter(); reRender(); updateFilterButtonsActive();
  });
}

function closeExcelFilter(){ const p = document.getElementById('excelFilterPanel'); if (p){ p.style.display='none'; p.innerHTML=''; } }

function updateFilterButtonsActive(){
  const state = getTableFilterState();
  const isActive = {
    hub: !!state.hub, unit: !!state.unitFrom, fromCode: !!state.fromCode, toCode: !!state.toCode,
    fromName: !!state.fromName, toName: !!state.toName, via: !!state.via,
    distance: Number.isFinite(state.distMin)||Number.isFinite(state.distMax),
    type: Array.isArray(state.type)&&state.type.length>0, logist: !!state.logist,
    status: Array.isArray(state.status)&&state.status.length>0, comment: !!state.comment,
    updated: !!state.df || !!state.dt, routeKey: !!state.routeKey, id: !!state.id
  };
  document.querySelectorAll('#resTable thead th[data-colkey]').forEach(th=>{
    const key = th.getAttribute('data-colkey'); const btn = th.querySelector('.excel-filter-btn'); if (!btn) return;
    btn.classList.toggle('active', !!isActive[key]);
  });
}

/* –î–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤: –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è + –ö–æ–ø—ñ—é–≤–∞—Ç–∏ ID/–ö–æ–¥ */
document.querySelector('#resTable tbody').addEventListener('click', async (ev)=>{
  const navBtn = ev.target.closest('.nav-btn');
  if (navBtn){
    const id = navBtn.getAttribute('data-id');
    const prettyName = navBtn.getAttribute('data-name') || '–ú–∞—Ä—à—Ä—É—Ç';
    try{
      setBusy(true);
      const payload = await buildNavigatePayloadById(id, prettyName);
      const url = buildNavigateURLFromPayload(payload);
      await shareURL(url, prettyName);
    }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ç–æ—Ä–∞: ' + (e?.message || e)); }
    finally{ setBusy(false); }
    return;
  }

const jsonOne = ev.target.closest('.json-one');
if (jsonOne){
  const id = jsonOne.getAttribute('data-id');
  try{
    setBusy(true);
    // –∑–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–æ–∫ —É –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö
    const row = allRows.find(x => x.id === id);
    if (row && row.raw){
      downloadJson(Object.assign({ id }, normalizeForJson(row.raw)), `route_${id}.json`);
    } else {
      // —Ñ–æ–ª–±–µ–∫: –¥–æ—á–∏—Ç–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É
      const doc = await db.collection('routes').doc(id).get({ source:'server' });
      const raw = doc.exists ? doc.data() : {};
      downloadJson(Object.assign({ id }, normalizeForJson(raw)), `route_${id}.json`);
    }
  }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ' + (e?.message || e)); }
  finally{ setBusy(false); }
  return;
}
  // –ù–û–í–ï: –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É (–ª–∏—à–µ admin)
  const delBtn = ev.target.closest('.del-one');
  if (delBtn){
    const id   = delBtn.getAttribute('data-id');
    const name = delBtn.getAttribute('data-name') || '–º–∞—Ä—à—Ä—É—Ç';
    // üîë –≤–∏–¥–∞–ª—è—Ç–∏ –º–æ–∂–µ –ª–∏—à–µ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä
    if (!userHasRole('admin')){ alert('–í–∏–¥–∞–ª—è—Ç–∏ –º–æ–∂–µ –ª–∏—à–µ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä.'); return; }

    const ok = confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ ¬´${name}¬ª (ID: ${id}) –∑ –±–∞–∑–∏?\n–¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.`);
    if (!ok) return;

    try{
      setBusy(true);
      await db.collection('routes').doc(id).delete();
      // –ø—Ä–∏–±–µ—Ä–µ–º–æ –∑—ñ —Å—Ç–∞–Ω—É —ñ –ø–µ—Ä–µ–º–∞–ª—é—î–º–æ
      allRows = allRows.filter(x => x.id !== id);
      reRender();
      alert('–ú–∞—Ä—à—Ä—É—Ç –≤–∏–¥–∞–ª–µ–Ω–æ.');
    }catch(e){
      if (e?.code === 'permission-denied'){
        alert('–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
      }else{
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: ' + (e?.message || e));
      }
      console.error('delete error:', e);
    }finally{
      setBusy(false);
    }
    return;
  }

  const copyBtn = ev.target.closest('.copy-btn');
  if (copyBtn){
    const val = copyBtn.getAttribute('data-val') || '';
    try{
      await navigator.clipboard.writeText(val);
      copyBtn.textContent = '‚úÖ';
      setTimeout(()=>{ copyBtn.textContent = 'üìã'; }, 1000);
    }catch{ prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Ä—É—á–Ω—É:', val); }
  }

  // Row selection to preview on map (ignore clicks on interactive controls)
  const interactive = ev.target.closest('a,button,.copy-btn,input,select,textarea,label');
  if (interactive) return;
  const tr = ev.target.closest('tr[data-id]');
  if (!tr) return;
  const id = tr.getAttribute('data-id');
  const row = allRows.find(x => x.id === id);
  if (!row) return;
  try{
    selectRowVisual(id);
    openMapPanel(true);
    await ensureMap();
    await drawRouteOnMap(row);
  }catch(e){ console.warn('Map preview error:', e); }
});

/* ---------- –†–æ–∑—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –∞–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ ---------- */
const WIDTHS_KEY = 'export.tableWidths.v1';

function freezeTableWidths(){
  const table = document.getElementById('resTable');
  if (!table || !table.tHead || !table.tHead.rows.length) return;

  const headerRow = table.tHead.rows[0];
  const cols = Array.from(table.querySelector('colgroup').children);

  // –í–º–∏–∫–∞—î–º–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π –ª–µ–π–∞—É—Ç ‚Äî –≤—ñ–Ω —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π –ø—ñ–¥ —á–∞—Å drag
  table.style.tableLayout = 'fixed';

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ —Ñ–∞–∫—Ç–∏—á–Ω—ñ —à–∏—Ä–∏–Ω–∏ —É px
  for (let i = 0; i < cols.length; i++){
    const th = headerRow.cells[i];
    const col = cols[i];
    if (!th || !col) continue;
    const w = Math.round(th.getBoundingClientRect().width);
    if (w > 0) col.style.width = w + 'px';
  }
}

function enableResizableColumns() {
  const table = document.getElementById('resTable');
  if (!table || !table.tHead || !table.tHead.rows.length) return;

  const headerRow = table.tHead.rows[0];
  const cols = Array.from(table.querySelector('colgroup').children);

  // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ä—ñ —Ä—É—á–∫–∏ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –ø–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è)
  headerRow.querySelectorAll('.col-resizer').forEach(el => el.remove());

  // –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ, –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω—ñ –¥–æ data-colkey
  Array.from(headerRow.cells).forEach((th) => {
    const key = th.dataset.colkey;
    if (!key || !COL_INDEX[key]) return;

    const colIdx = COL_INDEX[key] - 1;    // 0-based —É <colgroup>
    const colEl = cols[colIdx];
    if (!colEl) return;

    const h = document.createElement('span');
    h.className = 'col-resizer';
    th.style.position = 'relative';
    th.appendChild(h);

    let startX = 0, startW = 0;

    const onMove = (e) => {
      const dx = e.clientX - startX;
      const w = Math.max(60, Math.min(900, startW + dx));
      colEl.style.width = w + 'px';
      table.classList.add('resizing');
    };

    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      table.classList.remove('resizing');
      saveColumnWidths();
    };

    h.addEventListener('mousedown', (e) => {
  e.preventDefault();

  // 1) –∑–∞–º–æ—Ä–æ–∑–∏–ª–∏ –ø–æ—Ç–æ—á–Ω—ñ —à–∏—Ä–∏–Ω–∏ ‚Äî —â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ —Å—Ç—Ä–∏–±–∞–ª–æ
  freezeTableWidths();

  // 2) —Å—Ç–∞—Ä—Ç–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—ñ—Å–ª—è ¬´–∑–∞–º–æ—Ä–æ–∑–∫–∏¬ª
  startX = e.clientX;
  startW = parseFloat(colEl.style.width) || th.getBoundingClientRect().width;

  // 3) –ª–µ–≥–∫–∏–π –≤—ñ–∑—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –ø—ñ–¥ —á–∞—Å drag (—ñ —Å–∏–Ω—Ö—Ä–æ–Ω —Å–∫—Ä–æ–ª–µ—Ä–∞)
  document.getElementById('resTable').classList.add('resizing');

  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
});

    // –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ ‚Äî –∞–≤—Ç–æ–ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ —à–∏—Ä–∏–Ω—É —Å–∞–º–µ —Ü—ñ—î—ó –∫–æ–ª–æ–Ω–∫–∏
    h.addEventListener('dblclick', () => {
      const w = measureColumnWidth(colIdx);
      colEl.style.width = w + 'px';
      saveColumnWidths();
    });
  });
}

function getTableFont(){
  const table = document.getElementById('resTable');
  const cs = getComputedStyle(table);
  return cs.font || `${cs.fontStyle||'normal'} ${cs.fontWeight||'400'} ${cs.fontSize||'13px'} ${cs.fontFamily||'system-ui'}`;
}

function measureColumnWidth(index){
  const table = document.getElementById('resTable');
  const sampleLimit = 200; // –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—ó –æ—Ü—ñ–Ω–∫–∏
  const ctx = document.createElement('canvas').getContext('2d');
  ctx.font = getTableFont();

  const pad = 24; // –ø–∞–¥—ñ–Ω–≥/—ñ–∫–æ–Ω–∫–∏
  let max = 80;

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const headText = (table.tHead.rows[0].cells[index].innerText || '').trim();
  max = Math.max(max, ctx.measureText(headText).width + pad);

  // —Ñ—ñ–ª—å—Ç—Ä —É —à–∞–ø—Ü—ñ (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä / –Ω–∞–∑–≤–∞ –æ–ø—Ü—ñ—ó)
  const fcell = table.tHead.rows[1].cells[index];
  if (fcell){
    const input = fcell.querySelector('input,select');
    if (input){
      const txt = (input.value || input.placeholder || '').trim();
      if (txt) max = Math.max(max, ctx.measureText(txt).width + pad);
    }
  }

  // –∫–æ–º—ñ—Ä–∫–∏ —Ç—ñ–ª–∞
  const rows = Array.from(table.tBodies[0].rows).slice(0, sampleLimit);
  for (const tr of rows){
    const txt = (tr.cells[index]?.innerText || '').trim();
    if (txt){
      max = Math.max(max, ctx.measureText(txt).width + pad);
    }
  }

  return Math.min(Math.max(Math.ceil(max), 60), 900);
}

function autosizeColumns(){
  const table = document.getElementById('resTable');
  const cols = Array.from(table.querySelector('colgroup').children);
  for (let i=0;i<cols.length;i++){
    const w = measureColumnWidth(i);
    cols[i].style.width = w + 'px';
  }
  saveColumnWidths();
  syncXWidth();
}

function saveColumnWidths(){
  try{
    const cols = document.querySelectorAll('#resTable colgroup col');
    const arr = Array.from(cols).map(c => (c.style.width || c.getBoundingClientRect().width + 'px'));
    localStorage.setItem(WIDTHS_KEY, JSON.stringify(arr));
  }catch{}
}

function restoreColumnWidths(){
  try{
    const raw = localStorage.getItem(WIDTHS_KEY);
    if (!raw) return;
    const arr = JSON.parse(raw);
    const cols = document.querySelectorAll('#resTable colgroup col');
    arr.forEach((w, i)=>{ if (cols[i]) cols[i].style.width = w; });
  }catch{}
}

btnAutosize.addEventListener('click', autosizeColumns);

/* ---------- –°—Ç–∞—Ä—Ç ---------- */
(async ()=>{
  if (!db) return;
  statusEl.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å';
  if (auth?.currentUser) { await Promise.all([loadDirectory(), loadLogists(true)]); }
  // –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–æ–∫: –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∏—Ä–∏–Ω–∏ —ñ —É–≤—ñ–º–∫–Ω—É—Ç–∏ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
  restoreColumnWidths();
  enableResizableColumns();
  buildColumnPickerUI();
  fitTableToViewport();      // ‚Üê –¥–æ–¥–∞–ª–∏
  bindXSync();            // ‚Üê –¥–æ–¥–∞–ª–∏
  fillHubsList();
  // Restore map height if saved
  try{ const h = parseInt(localStorage.getItem(MAP_H_KEY)); if (h && h > 0) setMapHeight(h); }catch(_){ }
})();

btnExportJson.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    await exportJsonZipFromRows(rows);        // <-- –∑–∞–º—ñ—Å—Ç—å exportJsonFromRows
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

btnExportJsonAll.addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    while(_hasMore){ await loadNextPage(); }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    await exportJsonZipFromRows(rows);        // <-- –∑–∞–º—ñ—Å—Ç—å exportJsonFromRows
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

// –ù–æ–≤—ñ –∫–Ω–æ–ø–∫–∏: KML (–≤–∏–¥–∏–º—ñ/—É—Å—ñ)
document.getElementById('btnExportKml').addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    await exportKmlZipFromRows(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

document.getElementById('btnExportKmlAll').addEventListener('click', async ()=>{
  try{
    setBusy(true);
    if (!allRows.length){ await loadFirstPage(false); }
    while(_hasMore){ await loadNextPage(); }
    let rows = applyTopFilters(allRows);
    rows = applyTableFilters(rows);
    rows = sortRows(rows);
    await exportKmlZipFromRows(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

// Basemap style switcher for export map
document.getElementById('mapStyleDockExport')?.addEventListener('change', async (e)=>{
  try{
    await ensureMap();
    const style = e.target.value;
    _map.setStyle(style);
  }catch(_){ }
});

// Map panel resize drag
if (mapResizeHandle){
  let startY = 0, startH = 0, dragging = false, raf = 0;
  const onMove = (e)=>{
    if (!dragging) return;
    const dy = startY - e.clientY; // up = bigger
    const newH = startH + dy;
    if (raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=> setMapHeight(newH));
  };
  const onUp = ()=>{
    dragging = false;
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
  };
  mapResizeHandle.addEventListener('mousedown', (e)=>{
    e.preventDefault();
    const panel = document.getElementById('mapPanel');
    startY = e.clientY;
    startH = panel.getBoundingClientRect().height;
    dragging = true;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}
/* ==== –¢–æ–≥–ª ¬´–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ¬ª —è–∫ —Å–µ–∫—Ü—ñ—ó (–ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏) ==== */
const COLPICKER = document.getElementById('columnPicker');
const COLPICKER_STATE_KEY = 'export.colpickerHidden.v1';

function positionColpicker(){
  const btn = document.getElementById('btnToggleSidebar');
  if (!COLPICKER || !btn) return;
  const r = btn.getBoundingClientRect();
  const top = Math.round(r.bottom + 8);
  const right = Math.max(12, Math.round(window.innerWidth - r.right));
  COLPICKER.style.top = `${top}px`;
  COLPICKER.style.right = `${right}px`;
}
function applyColpickerState(){
  const hidden = localStorage.getItem(COLPICKER_STATE_KEY) === '1';
  COLPICKER.classList.toggle('is-hidden', hidden);
  if (!hidden) positionColpicker();
}
applyColpickerState();

document.getElementById('btnToggleSidebar')?.addEventListener('click', () => {
  const hidden = COLPICKER.classList.toggle('is-hidden');
  if (!hidden) positionColpicker();
  localStorage.setItem(COLPICKER_STATE_KEY, hidden ? '1' : '0');
});

// –ó–∞–∫—Ä–∏–≤–∞—Ç–∏ –ø–æ–ø–æ–≤–µ—Ä –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.addEventListener('click', (e)=>{
  const btn = document.getElementById('btnToggleSidebar');
  if (!COLPICKER || !btn) return;
  if (COLPICKER.classList.contains('is-hidden')) return;
  if (COLPICKER.contains(e.target) || btn.contains(e.target)) return;
  COLPICKER.classList.add('is-hidden');
  localStorage.setItem(COLPICKER_STATE_KEY, '1');
});
window.addEventListener('resize', ()=>{ if (COLPICKER && !COLPICKER.classList.contains('is-hidden')) positionColpicker(); });

/* ==== –¢–æ–≥–ª ¬´–§—ñ–ª—å—Ç—Ä–∏¬ª —è–∫ —Å–µ–∫—Ü—ñ—ó (–ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏) ==== */
const FILTERS = document.querySelector('.filters-card');
const FILTERS_STATE_KEY = 'export.filtersHidden.v1';

function applyFiltersState(){
  const hidden = localStorage.getItem(FILTERS_STATE_KEY) === '1';
  FILTERS.classList.toggle('is-hidden', hidden);
}
applyFiltersState();

document.getElementById('btnToggleFilters')?.addEventListener('click', () => {
  const hidden = FILTERS.classList.toggle('is-hidden');
  localStorage.setItem(FILTERS_STATE_KEY, hidden ? '1' : '0');
});
// (6) –ß–∏—Å—Ç–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è live-–ø—ñ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ/–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
window.addEventListener('beforeunload', () => {
  try { stopLive(); } catch (_) {}
});

</script>
</body>
</html>