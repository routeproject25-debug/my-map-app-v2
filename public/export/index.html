<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root { --w: 1080px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; }
    .wrap { max-width:var(--w); margin:24px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; }
    h1 { margin:0 0 12px; font-size:20px; }

    .row { display:grid; gap:12px; }
    .row.cols-2 { grid-template-columns: 1fr 1fr; }
    .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .row.dates { grid-template-columns: minmax(180px,1fr) minmax(180px,1fr); gap:10px; }
    @media (max-width: 640px) {
      .row.cols-2, .row.cols-3, .row.dates { grid-template-columns: 1fr; }
    }

    label { display:block; font-size:13px; color:#555; margin:4px 0; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width:100%; padding:8px 10px; border:1px solid #d5d9e0; border-radius:8px; background:#fff; font-size:14px;
    }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#667085; font-size:12.5px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; text-align:left; }
    th { background:#f1f5f9; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#111827; }
    .stats .chip { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; }
  </style>
</head>
<body>
<!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É-->
<header style="background:#2563eb;color:#fff;padding:10px;display:flex;gap:16px;">
  <a href="/" style="color:#fff;text-decoration:none;">üè† –ö–∞—Ä—Ç–∞</a>
  <a href="/export/" style="color:#fff;text-decoration:none;">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
  <a href="/import/" style="color:#fff;text-decoration:none;">üì• –Ü–º–ø–æ—Ä—Ç</a>
</header>

  <div class="wrap">
    <div class="topbar">
      <h1>–ï–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (Firestore ‚Üí Excel)</h1>
      <div class="bar">
        <a class="btn" href="index.html">‚Üê –î–æ –∫–∞—Ä—Ç–∏</a>
        <span id="status" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <!-- 1 —Ä—è–¥: –í—ñ–¥/–î–æ -->
      <div class="row cols-2">
        <div>
          <label>–§—ñ–ª—å—Ç—Ä: –í—ñ–¥</label>
          <input id="fromName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
        </div>
        <div>
          <label>–§—ñ–ª—å—Ç—Ä: –î–æ</label>
          <input id="toName" type="text" placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏..." list="directoryList" autocomplete="off">
        </div>
      </div>

      <!-- 2 —Ä—è–¥: –¢–∏–ø + –î–∞—Ç–∏ -->
      <div class="row cols-2" style="margin-top:12px;">
        <div>
          <label>–¢–∏–ø</label>
          <select id="routeType">
            <option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option>
            <option value="–û—Å–Ω–æ–≤–Ω–∏–π">–û—Å–Ω–æ–≤–Ω–∏–π</option>
            <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π1</option>
            <option value="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π2</option>
          </select>
        </div>
        <div>
          <label>–û–Ω–æ–≤–ª–µ–Ω–æ: –∑ ‚Üí –ø–æ</label>
          <div class="row dates">
            <input id="dateFrom" type="date">
            <input id="dateTo" type="date">
          </div>
        </div>
      </div>

      <!-- 3 —Ä—è–¥: –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª + –í—ñ–¥—Å—Ç–∞–Ω—å -->
      <div class="row cols-3" style="margin-top:12px;">
        <div>
          <label>–í–∏—Ä–æ–±–Ω–∏—á–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (—É –í—ñ–¥ –∞–±–æ –î–æ)</label>
          <select id="unitFilter">
            <option value="">‚Äî –±—É–¥—å-—è–∫–∏–π ‚Äî</option>
          </select>
        </div>
        <div>
          <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –≤—ñ–¥</label>
          <input id="distMin" type="number" step="0.001" placeholder="–º—ñ–Ω.">
        </div>
        <div>
          <label>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º ‚Äî –¥–æ</label>
          <input id="distMax" type="number" step="0.001" placeholder="–º–∞–∫—Å.">
        </div>
      </div>

      <div class="bar" style="margin-top:12px;">
        <button id="btnPreview" class="btn">üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
        <button id="btnExport" class="btn primary">üì• –ï–∫—Å–ø–æ—Ä—Ç —É Excel</button>
        <span class="muted">–ü–æ—Ä–æ–∂–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ = –Ω–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏. –Ø–∫—â–æ Firestore –ø–æ–ø—Ä–æ—Å–∏—Ç—å —ñ–Ω–¥–µ–∫—Å ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å, –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —ñ–∑ –∫–æ–Ω—Å–æ–ª—ñ.</span>
      </div>
      <datalist id="directoryList"></datalist>
    </div>

    <div class="card">
      <div class="bar" style="justify-content:space-between; margin-bottom:8px;">
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</strong>
        <span class="muted" id="countInfo">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª</span>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats" id="statsInfo" style="display:none; margin-bottom:8px;">
        <div class="chip" id="statMax">–ù–∞–π–±—ñ–ª—å—à–∞: ‚Äî</div>
        <div class="chip" id="statMin">–ù–∞–π–º–µ–Ω—à–∞: ‚Äî</div>
        <div class="chip" id="statAvg">–°–µ—Ä–µ–¥–Ω—è: ‚Äî</div>
      </div>

      <div style="overflow:auto;">
        <table id="resTable">
          <thead>
            <tr>
              <th>–ö–æ–¥ –í—ñ–¥</th><th>–ö–æ–¥ –î–æ</th>
              <th>–í—ñ–¥</th><th>–î–æ</th>
              <th>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º</th><th>–¢–∏–ø</th>
              <th>–û–Ω–æ–≤–ª–µ–Ω–æ</th><th>ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* --- –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä, —â–æ–±–∏ –æ–¥—Ä–∞–∑—É –±–∞—á–∏—Ç–∏ –ø–∞–¥—ñ–Ω–Ω—è --- */
window.addEventListener('error', (e) => {
  console.error('Global error:', e.message, 'at', e.filename, e.lineno);
  try { document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞'; } catch(_) {}
});

/* ---------- Firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
  authDomain: "my-map-app-58312.firebaseapp.com",
  projectId: "my-map-app-58312",
  storageBucket: "my-map-app-58312.firebasestorage.app",
  messagingSenderId: "53260611353",
  appId: "1:53260611353:web:f25e120996ad8305405f88",
  measurementId: "G-9LRX1FLTKL"
};

const statusEl = document.getElementById('status');
let db = null;

try{
  const app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  statusEl.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';

  // –æ—Ñ–ª–∞–π–Ω–æ–≤–∏–π –∫–µ—à ‚Äî –Ω–µ –±–ª–æ–∫—É—î —Å—Ç–∞—Ä—Ç, —è–∫—â–æ –Ω–µ –≤–¥–∞—Å—Ç—å—Å—è
  db.enablePersistence({ synchronizeTabs: true }).catch((e) => {
    console.warn('Persistence off:', e.code || e.message);
  });
} catch(e){
  console.error('Init error:', e);
  statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
}

/* ---------- –î–æ–≤—ñ–¥–Ω–∏–∫ (–∫–æ–¥–∏ ‚Üí –Ω–∞–∑–≤–∏/–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–∏) ---------- */
const dirByCode = {};     // {code:{name,company,unit}}
const codeByName = {};    // {name:code}
const unitsSet = new Set();

const DIR_CACHE_KEY = 'export.directoryCache.v1';
const DIR_CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12 –≥–æ–¥

function fillDirectoryUI(rows){
  const list = document.getElementById('directoryList');
  const unitSelect = document.getElementById('unitFilter');

  list.innerHTML = '';
  unitSelect.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
  unitsSet.clear();
  Object.keys(dirByCode).forEach(k=>delete dirByCode[k]);
  Object.keys(codeByName).forEach(k=>delete codeByName[k]);

  for (const r of rows){
    const { code, name, company, unit } = r;
    dirByCode[code] = { name, company, unit };
    if(!(name in codeByName)) codeByName[name]=code;
    if (unit) unitsSet.add(unit);

    const opt = document.createElement('option');
    opt.value = name;
    opt.label = [name, unit, company].filter(Boolean).join(' ‚Ä¢ ');
    list.appendChild(opt);
  }

  Array.from(unitsSet).sort((a,b)=>a.localeCompare(b,'uk')).forEach(u=>{
    const o=document.createElement('option'); o.value=u; o.textContent=u; unitSelect.appendChild(o);
  });
}

async function loadDirectory(){
  // 1) localStorage —Å–ø–µ—Ä—à—É
  try{
    const raw = localStorage.getItem(DIR_CACHE_KEY);
    if (raw){
      const { ts, rows } = JSON.parse(raw);
      if (Array.isArray(rows) && Date.now() - ts < DIR_CACHE_TTL_MS){
        fillDirectoryUI(rows);
        console.log('üìí Directory from localStorage cache:', rows.length);
        return;
      }
    }
  }catch{}

  // 2) Firestore cache-first
  let snap = null;
  try { snap = await db.collection('directory').get({ source: 'cache' }); } catch {}
  if (!snap || snap.empty) { snap = await db.collection('directory').get(); }

  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    rows.push({
      code: doc.id,
      name: d.name || doc.id,
      company: d.company || '',
      unit: d.unit || ''
    });
  });

  fillDirectoryUI(rows);

  // 3) –æ–Ω–æ–≤–∏—Ç–∏ localStorage
  try{ localStorage.setItem(DIR_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); }catch{}

  console.log('üìí Directory loaded from Firestore:', rows.length);
}

/* ---------- –•–µ–ª–ø–µ—Ä–∏ ---------- */
function getCodeByNameInput(id){
  const name = (document.getElementById(id).value||'').trim();
  return codeByName[name] || '';
}
function nameByCode(code){ return (dirByCode[code]?.name)||''; }
function unitByCode(code){ return (dirByCode[code]?.unit)||''; }

function dayStartISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString(); }
function dayEndISO(d){ const x=new Date(d); x.setHours(23,59,59,999); return x.toISOString(); }

function formatDate(dt) {
  if (!dt) return '';
  const d = new Date(dt);
  if (isNaN(d)) return '';
  const pad = n => String(n).padStart(2, '0');
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* --- –º–µ–º–æ —Å—Ç–∞–Ω –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–∏–±—ñ—Ä–∫–∏ --- */
let lastQueryKey = '';
let lastAllRows = null;

// –ø—ñ–¥–ø–∏—Å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–æ–¥–Ω–∞ –≤–µ—Ä—Å—ñ—è!)
function getFiltersSignature(){
  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value || '';
  const df       = document.getElementById('dateFrom')?.value || '';
  const dt       = document.getElementById('dateTo')?.value || '';
  const unit     = document.getElementById('unitFilter')?.value || '';
  const dmin     = document.getElementById('distMin')?.value || '';
  const dmax     = document.getElementById('distMax')?.value || '';
  return JSON.stringify({ fromCode, toCode, type, df, dt, unit, dmin, dmax });
}

/* ---------- –í–∏–±—ñ—Ä–∫–∞ –∑ Firestore ---------- */
const ROUTES_LIMIT = 1000; // –ø—ñ–¥–ª–∞—à—Ç—É–π –∑–∞ –ø–æ—Ç—Ä–µ–±–∏

async function queryRoutes(){
  let q = db.collection('routes');
  const fromCode = getCodeByNameInput('fromName');
  const toCode   = getCodeByNameInput('toName');
  const type     = document.getElementById('routeType')?.value;
  const df       = document.getElementById('dateFrom')?.value;
  const dt       = document.getElementById('dateTo')?.value;

  if (fromCode) q = q.where('fromCode','==',fromCode);
  if (toCode)   q = q.where('toCode','==',toCode);
  if (type)     q = q.where('routeType','==',type);

  q = q.orderBy('updatedAt','desc');
  if (df) q = q.where('updatedAt','>=', dayStartISO(df));
  if (dt) q = q.where('updatedAt','<=', dayEndISO(dt));

  // cache-first
  let snap = null;
  try { snap = await q.limit(ROUTES_LIMIT).get({ source: 'cache' }); } catch {}
  if (!snap || snap.empty) { snap = await q.limit(ROUTES_LIMIT).get(); }

  const rows=[];
  snap.forEach(doc=>{
    const d=doc.data()||{};
    rows.push({
      id: doc.id,
      fromCode: d.fromCode||'',
      toCode: d.toCode||'',
      fromName: nameByCode(d.fromCode)||'',
      toName: nameByCode(d.toCode)||'',
      fromUnit: unitByCode(d.fromCode)||'',
      toUnit: unitByCode(d.toCode)||'',
      distance_km: (typeof d.distance_km==='number')? d.distance_km : NaN,
      type: d.routeType||'',
      updatedAtRaw: d.updatedAt || null,
      updatedAt: formatDate(d.updatedAt)
    });
  });
  return rows;
}

/* --- –Ω–µ –∑—á–∏—Ç—É—î–º–æ –ë–î –¥–≤—ñ—á—ñ –ø—Ä–∏ —Ç–∏—Ö —Å–∞–º–∏—Ö —Ñ—ñ–ª—å—Ç—Ä–∞—Ö --- */
async function getFilteredRows(){
  const key = getFiltersSignature();
  if (lastAllRows && key === lastQueryKey){
    return applyClientFilters(lastAllRows);
  }
  const all = await queryRoutes();
  lastQueryKey = key;
  lastAllRows = all;
  return applyClientFilters(all);
}

/* ---------- –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ ---------- */
function applyClientFilters(rows){
  const unit = document.getElementById('unitFilter')?.value.trim() || '';
  const dmin = parseFloat(document.getElementById('distMin')?.value);
  const dmax = parseFloat(document.getElementById('distMax')?.value);

  return rows.filter(r=>{
    if (unit && !(r.fromUnit === unit || r.toUnit === unit)) return false;

    const dist = r.distance_km;
    if (!Number.isFinite(dist)) return false;
    if (!Number.isNaN(dmin) && isFinite(dmin) && dist < dmin) return false;
    if (!Number.isNaN(dmax) && isFinite(dmax) && dist > dmax) return false;

    return true;
  });
}

/* ---------- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---------- */
function updateStats(rows){
  const statsBox = document.getElementById('statsInfo');
  if (!rows.length){ statsBox.style.display='none'; return; }

  const nums = rows.map(r=>r.distance_km).filter(Number.isFinite);
  if (!nums.length){ statsBox.style.display='none'; return; }

  const max = Math.max(...nums);
  const min = Math.min(...nums);
  const avg = nums.reduce((a,b)=>a+b,0)/nums.length;

  document.getElementById('statMax').textContent = `–ù–∞–π–±—ñ–ª—å—à–∞: ${max.toFixed(3)}`;
  document.getElementById('statMin').textContent = `–ù–∞–π–º–µ–Ω—à–∞: ${min.toFixed(3)}`;
  document.getElementById('statAvg').textContent = `–°–µ—Ä–µ–¥–Ω—è: ${avg.toFixed(3)}`;
  statsBox.style.display='';
}

/* ---------- –¢–∞–±–ª–∏—Ü—è ---------- */
function renderTable(rows){
  const tb = document.querySelector('#resTable tbody');
  tb.innerHTML = rows.map(r=>`<tr>
    <td>${r.fromCode}</td>
    <td>${r.toCode}</td>
    <td>${r.fromName}</td>
    <td>${r.toName}</td>
    <td>${Number.isFinite(r.distance_km) ? r.distance_km.toFixed(3) : ''}</td>
    <td>${r.type}</td>
    <td>${r.updatedAt}</td>
    <td>${r.id}</td>
  </tr>`).join('');
  document.getElementById('countInfo').textContent = `–ó–∞–ø–∏—Å—ñ–≤ (–ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—É): ${rows.length}`;
  updateStats(rows);
}

/* ---------- –ï–∫—Å–ø–æ—Ä—Ç —É Excel ---------- */
function exportToExcel(rows){
  const data = [
    ['–ö–æ–¥ –í—ñ–¥','–ö–æ–¥ –î–æ','–í—ñ–¥','–î–æ','–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º','–¢–∏–ø','–û–Ω–æ–≤–ª–µ–Ω–æ','ID'],
    ...rows.map(r => [
      r.fromCode,
      r.toCode,
      r.fromName,
      r.toName,
      Number.isFinite(r.distance_km) ? Number(r.distance_km.toFixed(3)) : '',
      r.type,
      r.updatedAt,
      r.id
    ])
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [12,12,28,28,12,16,22,36].map(w => ({ wch: w }));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä—à—Ä—É—Ç–∏');
  XLSX.writeFile(wb, 'routes_export.xlsx');
}

/* ---------- –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ Firestore (—ñ–Ω–¥–µ–∫—Å) ---------- */
function handleFirestoreError(e){
  console.error('Firestore error:', e);
  const msg = e?.message || '';
  if (e?.code === 'failed-precondition' && msg.includes('create it here')) {
    const m = msg.match(/https:\/\/console\.firebase\.google\.com\/[^\s"]+/);
    if (m && m[0]) {
      const url = m[0];
      try { window.open(url, '_blank'); } catch(_) {}
      alert('–î–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å —É Firestore.\n–Ø –≤—ñ–¥–∫—Ä–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.\n\n–ü–æ—Å–∏–ª–∞–Ω–Ω—è:\n' + url);
      return;
    }
  }
  alert(msg || e);
}

/* ---------- –ü–æ–¥—ñ—ó ---------- */
document.getElementById('btnPreview').addEventListener('click', async ()=>{
  try{
    setBusy(true);
    const rows = await getFilteredRows();
    renderTable(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

document.getElementById('btnExport').addEventListener('click', async ()=>{
  try{
    setBusy(true);
    const rows = await getFilteredRows();
    exportToExcel(rows);
  }catch(e){ handleFirestoreError(e); }
  finally{ setBusy(false); }
});

function setBusy(b){
  document.getElementById('btnPreview').disabled=b;
  document.getElementById('btnExport').disabled=b;
  statusEl.textContent = b ? '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è‚Ä¶' : '–ì–æ—Ç–æ–≤–æ';
}

/* ---------- –°—Ç–∞—Ä—Ç ---------- */
(async ()=>{
  if (!db) return;
  try{
    await loadDirectory();
  } finally {
    if (statusEl.textContent === '–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶' || statusEl.textContent === '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ') {
      statusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
    }
  }
})();
</script>
</body>
</html>
