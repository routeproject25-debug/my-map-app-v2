<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>‚úÖ –ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<!-- App config -->
<script src="/config/config.js"></script>
  <style>
    :root { --line:#e5e7eb; --card:#fff; --muted:#6b7280; --nav-real:56px; }
    html, body { height:100%; }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:#f8fafc;
    }
    /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ DOM –¥–æ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è guard-–∞ */
    html{ visibility:hidden }

    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; background:#0ea5e9; color:#fff
    }
    header a{ color:#fff; text-decoration:none }

    /* === Fullscreen review layout === */
    #reviewWrap{
      position:absolute; inset:var(--nav-real) 0 0 0;  /* –∑–∞–π–º–∞—î –≤–µ—Å—å –µ–∫—Ä–∞–Ω –ø—ñ–¥ —Ö–µ–¥–µ—Ä–æ–º */
      padding:8px;
    }
    .review-card{
      height:100%; width:100%;
      display:grid; grid-template-rows:auto 1fr auto;
      background:var(--card); border:1px solid var(--line);
      border-radius:12px; box-shadow:0 1px 10px rgba(0,0,0,.08);
    }

    .pad{ padding:12px }
    .title{ font-weight:800; font-size:20px; margin:0 0 6px }
    .muted{ color:var(--muted); font-size:13px }
    .chip{
      display:inline-block; border:1px solid var(--line); border-radius:999px;
      padding:4px 10px; background:#f3f4f6; font-size:12.5px
    }
    .btn{
      cursor:pointer; border:1px solid var(--line); background:#fff; border-radius:10px;
      padding:9px 12px; font-size:14px
    }
    .btn.good{ background:#e6f4ea; border-color:#22c55e }
    .btn.bad{ background:#fee2e2; border-color:#ef4444 }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap }

    label{ display:block; font-size:13px; margin:6px 0 4px }
    textarea{
      width:100%; min-height:90px; border:1px solid var(--line); border-radius:10px;
      padding:8px; resize:vertical
    }

    /* –∫–∞—Ä—Ç–∞ ‚Äî –∑–∞–π–º–∞—î –≤—Å—é —Å–µ—Ä–µ–¥–Ω—é ‚Äú—Ä—è–¥–∫—É‚Äù –∫–∞—Ä—Ç–∫–∏ */
    #map{ width:100%; height:100%; border-top:1px dashed var(--line); border-bottom:1px dashed var(--line); }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media(max-width:900px){ .row{ grid-template-columns:1fr } }
  </style>

  <!-- === AUTH GUARD —É <head>: —ñ–Ω—ñ—Ç Firebase, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ, –ø–æ–∫–∞–∑ DOM === -->
<script>
  (async function(){
    const CFG = window.APP_CONFIG?.firebase;
	if (!CFG) {
   console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js');
   document.documentElement.style.visibility = 'visible';
   return;
	}
	try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e){}

    const db   = firebase.firestore();
    const auth = firebase.auth();

    /* ‚úÖ –§–Ü–ö–°: –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö –¥–æ –ª–æ–≥—ñ–Ω–∫–∏ */
    const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);

    auth.onAuthStateChanged(async (u) => {
      if (!u) { location.replace(loginURL); return; }

      // —á–∏—Ç–∞—î–º–æ —Ä–æ–ª—å —ñ–∑ users/{uid}, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ ‚Äî fallback –¥–æ roles/{uid}
      let role = 'pending';
      try{
        const us = await db.collection('users').doc(u.uid).get();
        role = us.exists ? (us.data().role || 'pending') : 'pending';
        if (String(role).trim().toLowerCase() === 'pending') {
          const rs = await db.collection('roles').doc(u.uid).get();
          if (rs.exists && rs.data()?.role) role = String(rs.data().role);
        }
      }catch(_){}

      window.__userRole = String(role).trim().toLowerCase();

      if (String(role).trim().toLowerCase() === 'pending') {
        alert('–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
        location.replace(loginURL); return;
      }

      /* ‚úÖ –î–û–ó–í–Ü–õ –õ–ò–®–ï –î–õ–Ø security | admin */
      if (!['security','admin'].includes(String(role).trim().toLowerCase())) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è.');
        location.replace(loginURL); return;
      }

      // –ø–æ–∫–∞–∑—É—î–º–æ DOM
      document.documentElement.style.visibility = 'visible';
    });
  })();
  </script>
</head>
<body>
<header>
  <a href="/index.html">üè† –ú–∞—Ä—à—Ä—É—Ç–∏</a>
  <div style="flex:1"></div>
  <span id="hello" class="muted">–ù–µ —É–≤—ñ–π—à–ª–∏</span>
</header>

<!-- fullscreen –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div id="reviewWrap">
  <div class="review-card">
    <div class="pad">
      <div class="title">–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</div>
      <div id="statusLine" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>

      <div class="btnRow" id="secButtons" style="margin-top:8px; display:none;">
        <button id="approveBtn" class="btn good">‚úÖ –ü–æ–≥–æ–¥–∏—Ç–∏</button>
        <button id="rejectBtn"  class="btn bad">‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
        <a id="openEditor" class="btn" target="_blank">üó∫ –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ</a>
      </div>

      <div id="rejectWrap" style="display:none; margin-top:10px;">
        <label>–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)</label>
        <textarea id="rejectComment" placeholder="–û–ø–∏—à—ñ—Ç—å, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏"></textarea>
        <div class="btnRow" style="margin-top:6px;">
          <button id="sendReject" class="btn bad">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä–µ–º</button>
          <button id="cancelReject" class="btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <div class="pad">
      <div class="row">
        <div>
          <div class="chip" id="chipStatus">–°—Ç–∞—Ç—É—Å: ‚Äî</div>
          <div class="chip" id="chipDistanceDb">–ë–î: ‚Äî</div>
          <div class="chip" id="chipDistanceLive">–ü–æ –¥–æ—Ä–æ–≥–∞—Ö: ‚Äî</div>
          <div class="chip" id="chipRevision">–ü–æ–¥–∞—á–∞ ‚Ññ ‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="muted">–ú–∞—Ä—à—Ä—É—Ç: <b id="routeName">‚Äî</b></div>
          <div class="muted">–í—ñ–¥: <b id="fromLabel">‚Äî</b> ‚Üí –î–æ: <b id="toLabel">‚Äî</b></div>
        </div>
      </div>
      <div id="decisionInfo" class="muted" style="margin-top:8px;"></div>
      <div id="rejectInfo" class="muted" style="margin-top:6px;color:#b91c1c;"></div>
    </div>
  </div>
</div>

<script>
  // === Firebase (–≤–∂–µ —ñ–Ω—ñ—Ç —É head-guard) ===
  const db   = firebase.firestore();
  const auth = firebase.auth();
  async function getNormalizedRole(){
  if (window.__userRole) return String(window.__userRole).trim().toLowerCase();
  try{
    const u = auth.currentUser;
    if (!u) return 'user';
    const us = await db.collection('users').doc(u.uid).get();
    const r = us.exists ? (us.data().role || 'pending') : 'pending';
    return String(r).trim().toLowerCase();
  }catch{ return 'user'; }
}

  // --- –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ---
  function toLonLat(p){
    if (Array.isArray(p) && p.length>=2){
      const a=Number(p[0]), b=Number(p[1]);
      return (Math.abs(a)<=90 && Math.abs(b)<=180) ? [b,a] : [a,b]; // –∞–≤—Ç–æ-–æ–±–º—ñ–Ω lat/lng
    }
    if (p && typeof p==='object'){
      const lat=Number(p.lat ?? p.latitude), lng=Number(p.lng ?? p.lon ?? p.longitude);
      if (Number.isFinite(lat) && Number.isFinite(lng)) return [lng,lat];
    }
    if (typeof p==='string'){
      const m=p.split(/[;, ]/).map(Number).filter(v=>!Number.isNaN(v));
      if (m.length>=2) return toLonLat(m);
    }
    return null;
  }
  function normalizePoints(raw){
    if (!raw) return null;
    // GeoJSON Feature/Geometry
    if (raw.type==='Feature' && raw.geometry?.type==='LineString') return normalizePoints(raw.geometry.coordinates);
    if (raw.type==='LineString' && Array.isArray(raw.coordinates))   return normalizePoints(raw.coordinates);
    if (raw.type==='FeatureCollection' && Array.isArray(raw.features)){
      const f=raw.features.find(f=>f.geometry?.type==='LineString'); if (f) return normalizePoints(f.geometry.coordinates);
    }
    // –º–∞—Å–∏–≤ —Ç–æ—á–æ–∫
    if (Array.isArray(raw)){
      const out=[]; for (const it of raw){ const pt=toLonLat(it); if (pt) out.push(pt); }
      return out.length>=2 ? out : null;
    }
    return null;
  }

  // === Query params ===
  const qs  = new URLSearchParams(location.search);
  const rid = qs.get('rid');

  // === Mapbox init ===
  mapboxgl.accessToken = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center:[28.468,49.234],
    zoom:11
  });

  /* ---------- layout helper: –∫–∞—Ä—Ç–∞ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω –ø—ñ–¥ —Ö–µ–¥–µ—Ä–æ–º ---------- */
  const topbarEl = document.querySelector('header');
  function updateLayoutHeights(){
    const h = (topbarEl?.offsetHeight || 56);
    document.documentElement.style.setProperty('--nav-real', h + 'px');
    try{ map.resize(); }catch{}
  }
  window.addEventListener('resize', updateLayoutHeights);
  map.on('load', updateLayoutHeights);

  /* ---------- helpers ---------- */
  function fromObjPoints(arr){ return (arr||[]).map(p => Array.isArray(p) ? p : [p.lng, p.lat]); }
  function chip(id,t){ document.getElementById(id).textContent = t; }
  function fmtStatus(s){ return ({draft:'–ß–µ—Ä–Ω–µ—Ç–∫–∞',pending:'–û—á—ñ–∫—É—î',approved:'–ü–æ–≥–æ–¥–∂–µ–Ω–æ',rejected:'–í—ñ–¥—Ö–∏–ª–µ–Ω–æ'})[s] || s || '‚Äî'; }

  // —Å–ø–ª—ñ—Ç –Ω–∞ —à–º–∞—Ç–∫–∏ (Mapbox Directions ‚â§25 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç/–∑–∞–ø–∏—Ç; –±–µ—Ä–µ–º–æ 20 –∑ –ø–µ—Ä–µ–∫—Ä–∏—Ç—Ç—è–º)
  function splitIntoChunks(arr, chunkSize){
    const out=[]; for(let i=0;i<arr.length-1;i+=chunkSize-1){
      const chunk=arr.slice(i,i+chunkSize); if(chunk.length>=2) out.push(chunk);
    } return out;
  }

  let routeLayers = [];
  function clearRouteLayers(){
    routeLayers.forEach(id=>{
      try{ if(map.getLayer(id)) map.removeLayer(id); }catch{}
      try{ if(map.getSource(id)) map.removeSource(id); }catch{}
    });
    routeLayers = [];
  }

  // snapped-to-road —Ä–µ–Ω–¥–µ—Ä—ñ–Ω–≥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É
  async function drawSnappedRoute(points){
    clearRouteLayers();
    if(!Array.isArray(points) || points.length<2){
      chip('chipDistanceLive','–ü–æ –¥–æ—Ä–æ–≥–∞—Ö: ‚Äî');
      return;
    }

    const chunks = splitIntoChunks(points, 20);
    let totalMeters = 0;

    // bounds
    let bMinLng=+Infinity, bMinLat=+Infinity, bMaxLng=-Infinity, bMaxLat=-Infinity;
    const grow = ([lng,lat])=>{
      if(lng<bMinLng) bMinLng=lng; if(lat<bMinLat) bMinLat=lat;
      if(lng>bMaxLng) bMaxLng=lng; if(lat>bMaxLat) bMaxLat=lat;
    };

    for(let i=0;i<chunks.length;i++){
      const coordsStr = chunks[i].map(p=>p.join(',')).join(';');
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?geometries=geojson&overview=full&continue_straight=true&access_token=${mapboxgl.accessToken}`;
      try{
        const res = await fetch(url);
        if (!res.ok) throw new Error('Directions HTTP ' + res.status);
        const data = await res.json();
         const route = data?.routes?.[0];
         if(!route) continue;

        totalMeters += (route.distance||0);
        const geom = route.geometry;

        const srcId = `rev-route-${i}`;
        map.addSource(srcId, { type:'geojson', data:{ type:'Feature', geometry:geom }});
        map.addLayer({
          id: srcId, type:'line', source:srcId,
          layout:{ 'line-cap':'round','line-join':'round' },
          paint:{ 'line-color': `hsl(${(i*60)%360},100%,50%)`, 'line-width': 5 }
        });
        routeLayers.push(srcId);

        (geom.coordinates||[]).forEach(grow);
      }catch(e){ console.warn('Directions error', e); }
    }

    if(isFinite(bMinLng)){
      map.fitBounds([[bMinLng,bMinLat],[bMaxLng,bMaxLat]], { padding: 40, maxZoom: 14 });
    }

    const km = (totalMeters/1000);
    chip('chipDistanceLive', isFinite(km) ? `–ü–æ –¥–æ—Ä–æ–≥–∞—Ö: ${km.toFixed(2)} –∫–º` : '–ü–æ –¥–æ—Ä–æ–≥–∞—Ö: ‚Äî');
  }

  // dashed rulers
  function drawRulers(d){
    ['ruler-start','ruler-end','ruler-start-src','ruler-end-src'].forEach(id=>{
      try{ if(map.getLayer(id)) map.removeLayer(id); }catch{}
      try{ if(map.getSource(id)) map.removeSource(id); }catch{}
    });

    const rs = fromObjPoints(d.startRuler||[]);
    if (rs.length >= 2){
      map.addSource('ruler-start-src',{type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates: rs } }});
      map.addLayer({ id:'ruler-start', type:'line', source:'ruler-start-src',
        paint:{ 'line-color':'#0ea5e9','line-width':3,'line-dasharray':[1,2]}});
    }
    const re = fromObjPoints(d.endRuler||[]);
    if (re.length >= 2){
      map.addSource('ruler-end-src',{type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates: re } }});
      map.addLayer({ id:'ruler-end', type:'line', source:'ruler-end-src',
        paint:{ 'line-color':'#22c55e','line-width':3,'line-dasharray':[1,2]}});
    }
  }
// ---- –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è ¬´–¥–æ–º–∞–ª—å–æ–≤–∞–Ω–∏—Ö¬ª —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ –∑ —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ ----
function normalizeSegments(source){
  const segments = [];
  function toLonLat(p){
    if (Array.isArray(p) && p.length>=2){
      const a=Number(p[0]), b=Number(p[1]);
      return (Math.abs(a)<=90 && Math.abs(b)<=180) ? [b,a] : [a,b];
    }
    if (p && typeof p==='object'){
      const lat=Number(p.lat ?? p.latitude), lng=Number(p.lng ?? p.lon ?? p.longitude);
      if (Number.isFinite(lat) && Number.isFinite(lng)) return [lng,lat];
    }
    if (typeof p==='string'){
      const m=p.split(/[;, ]+/).map(Number).filter(v=>!Number.isNaN(v));
      if (m.length>=2) return toLonLat(m);
    }
    return null;
  }
  function pushLine(arr){
    if (!Array.isArray(arr)) return;
    const pts = arr.map(toLonLat).filter(Boolean);
    if (pts.length>=2) segments.push(pts);
  }
  function scan(val){
    if (!val) return;
    if (val.type==='FeatureCollection' && Array.isArray(val.features)){
      val.features.forEach(f=>{
        const g=f.geometry;
        if (g?.type==='LineString') pushLine(g.coordinates);
        if (g?.type==='MultiLineString') (g.coordinates||[]).forEach(pushLine);
      });
      return;
    }
    if (val.type==='Feature' && val.geometry) return scan(val.geometry);
    if (val.type==='LineString' && Array.isArray(val.coordinates)) return pushLine(val.coordinates);
    if (val.type==='MultiLineString' && Array.isArray(val.coordinates)) return (val.coordinates||[]).forEach(pushLine);
    if (Array.isArray(val)){
      if (val.length && Array.isArray(val[0])) return pushLine(val);         // [[lng,lat],...]
      if (val.length && typeof val[0]==='object'){
        const pts = val.map(toLonLat).filter(Boolean);
        if (pts.length>=2) return segments.push(pts);
        val.forEach(scan); return;
      }
    }
    if (typeof val==='object'){
      for (const [k,v] of Object.entries(val)){
        if (/(ruler|manual|line|path|segment|polyline|draw)/i.test(k)) scan(v);
      }
    }
  }
  scan(source);
  return segments;
}

// ---- –≤—ñ–¥–º–∞–ª—å–æ–≤–∫–∞ —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ –Ω–∞ –º–∞–ø—ñ (–ø—É–Ω–∫—Ç–∏—Ä, –ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π) ----
let manualLayers = [];
function clearManualSegments(){
  manualLayers.forEach(id=>{
    try{ if (map.getLayer(id)) map.removeLayer(id); }catch{}
    try{ if (map.getSource(id)) map.removeSource(id); }catch{}
  });
  manualLayers = [];
}

function drawManualSegments(d){
  clearManualSegments();
  const segs = normalizeSegments(d);
  if (!segs.length) return;
  segs.forEach((coords, idx)=>{
    const id = `manual-seg-${idx}`;
    map.addSource(id, { type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates: coords } } });
    map.addLayer({
      id, type:'line', source:id,
      layout:{ 'line-cap':'round','line-join':'round' },
      paint:{ 'line-color':'#f59e0b', 'line-width':3, 'line-dasharray':[2,2] }
    });
    manualLayers.push(id);
  });
}
  // –º–∞—Ä–∫–µ—Ä–∏ –ø–æ—á–∞—Ç–∫—É/–∫—ñ–Ω—Ü—è
  let startMarker=null, endMarker=null;
  function setSEMarkers(points){
    try{ startMarker?.remove(); endMarker?.remove(); }catch{}
    if(!points?.length) return;
    startMarker = new mapboxgl.Marker({color:'#16a34a'}).setLngLat(points[0]).addTo(map);
    endMarker   = new mapboxgl.Marker({color:'#ef4444'}).setLngLat(points[points.length-1]).addTo(map);
  }

  async function loadRouteAndRender(){
    if (!rid){ document.getElementById('statusLine').textContent = '–ù–µ –ø–µ—Ä–µ–¥–∞–Ω–æ rid.'; return; }
        // –∫—Ä–∞—â–µ —Ç—è–≥–Ω—É—Ç–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (—â–æ–± –Ω–µ –∑–ª–æ–≤–∏—Ç–∏ –∫–µ—à)
    let snap = null;
    try { snap = await db.collection('routes').doc(rid).get({ source:'server' }); }
    catch { snap = await db.collection('routes').doc(rid).get(); }
     if (!snap.exists){ document.getElementById('statusLine').textContent = '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.'; return; }
     const d = snap.data() || {};
    window.__lastStatus = (d.approval?.status)||'';

    document.getElementById('routeName').textContent = d.name || rid;
    document.getElementById('fromLabel').textContent = d.fromLabel || '‚Äî';
    document.getElementById('toLabel').textContent   = d.toLabel   || '‚Äî';

    // ‚ûú –¥–≤—ñ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó
    chip('chipDistanceDb',   (typeof d.distance_km==='number') ? `–ë–î: ${d.distance_km.toFixed(2)} –∫–º` : '–ë–î: ‚Äî');
    chip('chipDistanceLive', '–ü–æ –¥–æ—Ä–æ–≥–∞—Ö: ‚Ä¶');

    chip('chipRevision', '–ü–æ–¥–∞—á–∞ ‚Ññ ' + ((d.approval?.revision) ?? '‚Äî'));
    chip('chipStatus',   '–°—Ç–∞—Ç—É—Å: ' + fmtStatus(d.approval?.status));
	    // —è–∫—â–æ –≤–∂–µ —î —Ä—ñ—à–µ–Ω–Ω—è ‚Äî –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ –¥—ñ—ó
    const decided = ['approved','rejected'].includes(String(d.approval?.status||'').toLowerCase());
    const role = await getNormalizedRole();
    const canDecide = (role==='security' || role==='admin') && !decided;
    document.getElementById('secButtons').style.display = canDecide ? 'flex' : 'none';

    const subInfo = d.approval?.submittedAt ? `–ü–æ–¥–∞–Ω–æ: ${d.approval.submittedAt} (${d.approval.submittedByEmail||d.approval.submittedByUid||''})` : '';
    const decInfo = d.approval?.decisionAt ? ` ¬∑ –†—ñ—à–µ–Ω–Ω—è: ${d.approval.decisionAt} (${d.approval.decidedByEmail||d.approval.decidedByUid||''})` : '';
    document.getElementById('decisionInfo').textContent = subInfo + decInfo;

    document.getElementById('rejectInfo').textContent =
      (d.approval?.status==='rejected' && d.approval?.comment) ? ('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: ' + d.approval.comment) : '';

    document.getElementById('openEditor').href = '/index.html?rid=' + encodeURIComponent(rid);
    document.getElementById('statusLine').textContent = '–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.';

    // --- snapped –º–∞—Ä—à—Ä—É—Ç + dashed rulers ---
        // ‚öôÔ∏è fallback –ø–æ –ø–æ–ª—è—Ö —ñ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
    const pts =
      normalizePoints(d.points) ||
      normalizePoints(d.coordinates) ||
      normalizePoints(d.route) ||
      normalizePoints(d.geojson) ||
      normalizePoints(d.geometry) ||
      fromObjPoints(d.points||[]) || [];
    await drawSnappedRoute(pts);
    setSEMarkers(pts);
    drawRulers(d);
	drawManualSegments(d);
  }

  // Approve / Reject actions (–ø–µ—Ä–µ—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –±–æ—Ü—ñ –∫–ª—ñ—î–Ω—Ç–∞ –ø–æ —Ä–æ–ª—è—Ö)
  async function applyDecision(kind, comment){
    const role = String(window.__userRole || 'user').trim().toLowerCase();
	const allowed = (role === 'security' || role === 'admin');
    if (!allowed){
      alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó.');
      return;
    }
    const decided = ['approved','rejected'].includes(String(window.__lastStatus||'').toLowerCase());
    if (decided){ alert('–†—ñ—à–µ–Ω–Ω—è –≤–∂–µ –ø—Ä–∏–π–Ω—è—Ç–æ. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É.'); return; }

    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn  = document.getElementById('rejectBtn');
    approveBtn.disabled = true; rejectBtn.disabled = true;
    const user = auth.currentUser;
    const ref = db.collection('routes').doc(rid);
    const payload = {
      approval: {
        status: kind,
        decisionAt: new Date().toISOString(),
        decidedByUid: user?.uid || null,
        decidedByEmail: user?.email || null,
        comment: kind === 'approved' ? null : (comment || '')
      },
      updatedAt: new Date().toISOString()
    };
    try{
      await ref.set(payload, { merge:true });
    }catch(e){
      // –Ø–∫—â–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π fallback
      const code = (e && e.code) || (e && e.message) || '';
      if (String(code).includes('permission') || String(code).includes('denied')){
        try{
          const token = await auth.currentUser.getIdToken();
          const body = { id: rid, decision: kind, comment: (comment || '') };
          const r = await fetch('/api/routes/approve', {
            method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(body)
          });
          if (!r.ok){
            const txt = await r.text().catch(()=> '');
            throw new Error('Server approve failed: ' + txt);
          }
        }catch(err){
          console.error('Approve fallback error', err);
          alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è: ' + (err?.message || err));
          approveBtn.disabled = false; rejectBtn.disabled = false;
          return;
        }
      } else {
        console.error('Approve error', e);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + (e?.message || e));
        approveBtn.disabled = false; rejectBtn.disabled = false;
        return;
      }
    }

    // –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI: —Å—Ö–æ–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏, –æ–Ω–æ–≤–∏—Ç–∏ —á—ñ–ø —Å—Ç–∞—Ç—É—Å—É, —â–æ–± –Ω–µ –±—É–ª–æ –≤—ñ–¥—á—É—Ç—Ç—è, —â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–∏–ª–æ—Å—å
    try{
      window.__lastStatus = kind;
      document.getElementById('secButtons').style.display = 'none';
      document.getElementById('chipStatus').textContent = '–°—Ç–∞—Ç—É—Å: ' + (kind==='approved' ? '–ü–æ–≥–æ–¥–∂–µ–Ω–æ' : '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ');
    }catch(_){ }

    // –ü—ñ—Å–ª—è –∑–∞–ø–∏—Å—É –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–æ–∫—É–º–µ–Ω—Ç —ñ–∑ —Å–µ—Ä–≤–µ—Ä–∞ –∑ –Ω–µ–≤–µ–ª–∏–∫–∏–º –ø–æ–≤—Ç–æ—Ä–æ–º (—â–æ–± –¥–æ—á–µ–∫–∞—Ç–∏—Å—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ)
    const tryReload = async (tries=3)=>{
      for (let i=0;i<tries;i++){
        await loadRouteAndRender();
        if (String(window.__lastStatus||'').toLowerCase() === String(kind)) return true;
        await new Promise(r=>setTimeout(r, 300));
      }
      return false;
    };
    await tryReload(4);

    alert(kind === 'approved' ? '–ü–æ–≥–æ–¥–∂–µ–Ω–æ ‚úÖ' : '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ ‚ùå');
    document.getElementById('rejectWrap').style.display = 'none';
    document.getElementById('rejectComment').value = '';
    approveBtn.disabled = false; rejectBtn.disabled = false;
  }

  // === –ù–∏–∂–Ω—ñ–π onAuthStateChanged: UI —Ç–∞ –¥–∞–Ω—ñ, —Ä–æ–ª—å —É–∂–µ –≤ window.__userRole ===
  auth.onAuthStateChanged(async (u)=>{
    const hello = document.getElementById('hello');
    if (!u){
      hello.textContent = '–ù–µ —É–≤—ñ–π—à–ª–∏';
      location.replace('/login.html?next=' + encodeURIComponent(location.pathname + location.search));
      return;
    }
    hello.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + (u.email||u.uid);

    const role = await getNormalizedRole();
	const sec = (role === 'security' || role === 'admin');
	document.getElementById('secButtons').style.display = sec ? 'flex' : 'none';

    // bind buttons
    document.getElementById('approveBtn').onclick = ()=>applyDecision('approved', null);
    document.getElementById('rejectBtn').onclick  = ()=>{
      document.getElementById('rejectWrap').style.display = 'block';
      document.getElementById('rejectComment').focus();
    };
    document.getElementById('sendReject').onclick = ()=>{
      const txt = (document.getElementById('rejectComment').value||'').trim();
      if (!txt){ alert('–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è.'); return; }
      applyDecision('rejected', txt);
    };
    document.getElementById('cancelReject').onclick = ()=>{
      document.getElementById('rejectWrap').style.display = 'none';
    };

    updateLayoutHeights();
    await loadRouteAndRender();
  });
</script>
<script>
  window.addEventListener('error', ()=>{ document.documentElement.style.visibility='visible'; });
  window.addEventListener('unhandledrejection', ()=>{ document.documentElement.style.visibility='visible'; });
</script>
</body>
</html>
