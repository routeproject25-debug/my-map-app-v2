<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–Ü–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (JSON/ZIP ‚Üí Firestore)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- App config -->
  <script src="/config/config.js"></script>
  <!-- ZIP reader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root { --w: 1080px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7f9; color:#111; }
    header, .wrap { max-width:var(--w); margin:16px auto; padding:0 14px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.06); padding:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { color:#667085; font-size:12.5px; }
    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .drop { border:2px dashed #cbd5e1; border-radius:12px; padding:18px; text-align:center; background:#fafbff; }
    .drop.drag { background:#eef6ff; border-color:#2563eb; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; text-align:left; vertical-align:top; }
    th { background:#f1f5f9; }
    .ok { color:#2e7d32; }
    .err { color:#c62828; }
    .warn { color:#b45309; }
    .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .guard { visibility:hidden; }
    .gen { background:#fff8e1; } /* –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –∫–ª—é—á—ñ */
  </style>

  <!-- AUTH GUARD: —Ç—ñ–ª—å–∫–∏ admin -->
  <script>
  (function(){
    document.documentElement.classList.add('guard');
    const CFG = window.APP_CONFIG?.firebase;
    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e){}
    const auth = firebase.auth(), db = firebase.firestore();
    const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);

    auth.onAuthStateChanged(async (u)=>{
      if(!u){ location.replace(loginURL); return; }
      try{
        const snap = await db.collection('users').doc(u.uid).get({source:'server'});
        const role = snap.exists ? (snap.data().role || 'pending') : 'pending';
        if(role !== 'admin'){ alert('–î–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–ª—è admin'); location.replace('/'); return; }
        document.documentElement.classList.remove('guard');
        document.getElementById('authInfo').textContent = u.email || u.uid;
      }catch(e){ console.error(e); location.replace(loginURL); }
    });
  })();
  </script>
</head>
<body>
<header class="row">
  <div class="row" style="gap:12px;">
    <a href="/" class="btn">üè† –ö–∞—Ä—Ç–∞</a>
    <a href="/export/" class="btn">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
    <span class="pill">–Ü–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç—ñ–≤</span>
  </div>
  <div class="right">
    <span id="authInfo" class="muted">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</span>
    <button id="btnLogout" class="btn">–í–∏–π—Ç–∏</button>
    <span id="state" class="pill">–ì–æ—Ç–æ–≤–æ</span>
  </div>
</header>

<div class="wrap">
  <div class="card" style="margin-bottom:12px;">
    <div class="row">
      <input id="fileInput" type="file" multiple accept=".json,.zip" />
      <button id="btnPickZip" class="btn">–û–±—Ä–∞—Ç–∏ ZIP</button>
      <button id="btnClear" class="btn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      <div class="right muted">–ú–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ —Ñ–∞–π–ª–∏ –∞–±–æ ZIP —É –∑–æ–Ω—É –Ω–∏–∂—á–µ.</div>
    </div>
    <div id="drop" class="drop" style="margin-top:10px;">
      –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å—é–¥–∏ .json —Ñ–∞–π–ª–∏ –∞–±–æ ZIP –∑ –ø–∞–ø–∫–æ—é <b>routes/</b>
    </div>
    <div class="row" style="margin-top:10px;">
      <label><input type="checkbox" id="optMerge" checked> –ó–∞–ø–∏—Å—É–≤–∞—Ç–∏ –∑ <b>merge</b> (–Ω–µ —Å—Ç–∏—Ä–∞—î –Ω–∞—è–≤–Ω—ñ –ø–æ–ª—è)</label>
      <label><input type="checkbox" id="optOverwriteKeys"> –î–æ–∑–≤–æ–ª–∏—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å —É <b>routeKeys</b> –ø—Ä–∏ –∫–æ–ª—ñ–∑—ñ—ó</label>
      <label><input type="checkbox" id="optAlwaysOverwriteKeys"> <b>–ó–∞–≤–∂–¥–∏</b> –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ <b>routeKeys</b></label>
      <label><input type="checkbox" id="optPrefixFromCodes"> –ü—Ä–µ—Ñ—ñ–∫—Å –∫–ª—é—á–∞ –±—Ä–∞—Ç–∏ <b>–ª–∏—à–µ –∑ –∫–æ–¥—ñ–≤</b> (fromCode/toCode)</label>
      <label><input type="checkbox" id="optDryRun"> –¢–µ—Å—Ç–æ–≤–∏–π –ø—Ä–æ–≥—ñ–Ω (–±–µ–∑ –∑–∞–ø–∏—Å—É)</label>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:8px;">
      <div>
        <b>–ü—Ä–µ–≤‚Äô—é</b>
        <span id="stats" class="muted"></span>
      </div>
      <div class="right">
        <button id="btnImport" class="btn primary" disabled>–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤ Firestore</button>
      </div>
    </div>
    <div style="overflow:auto; max-height:60vh;">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:160px;">id</th>
            <th>fromCode</th>
            <th>toCode</th>
            <th>distance_km</th>
            <th>routeKey</th>
            <th>status</th>
            <th>upload</th>
            <th>note</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="problems" class="muted" style="margin-top:8px;"></div>
  </div>
</div>

<script>
const stateEl = document.getElementById('state');
const btnLogout = document.getElementById('btnLogout');
btnLogout.onclick = async () => { try{ await firebase.auth().signOut(); }catch{} };

let db = null, auth = null;
try { db = firebase.firestore(); auth = firebase.auth(); } catch(e){}

const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const btnPickZip = document.getElementById('btnPickZip');
const btnClear = document.getElementById('btnClear');
const btnImport = document.getElementById('btnImport');
const optMerge = document.getElementById('optMerge');
const optOverwriteKeys = document.getElementById('optOverwriteKeys');
const optAlwaysOverwriteKeys = document.getElementById('optAlwaysOverwriteKeys');
const optPrefixFromCodes = document.getElementById('optPrefixFromCodes');
const optDryRun = document.getElementById('optDryRun');
const statsEl = document.getElementById('stats');
const problemsEl = document.getElementById('problems');
const tbody = document.querySelector('#tbl tbody');

let parsed = [];        // [{id, data, routeKey?, fileName, _ok, _err, _warn, _genKey?, _upload?, _uploadNote?}]
let conflicts = [];     // routeKey –∫–æ–ª—ñ–∑—ñ—ó

// ---------- helpers ----------
const pad = n => String(n).padStart(2,'0');
const nowIso = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}Z`;
};
function setState(s){ stateEl.textContent = s; }
function clearAll(){
  parsed = []; conflicts = [];
  tbody.innerHTML = ''; statsEl.textContent = ''; problemsEl.textContent = '';
  btnImport.disabled = true;
}
// –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫—ñ–≤ –¥–ª—è title/HTML
function esc(v){
  return String(v || '').replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]
  ));
}
// —â–æ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –≤ –∫–æ–ª–æ–Ω—Ü—ñ "upload"
function uploadCell(r){
  if (r._upload === 'writing') return '<span class="muted">‚è≥</span>';
  if (r._upload === 'done')    return '<span class="ok">‚úì</span>';
  if (r._upload === 'error')   return `<span class="err" title="${esc(r._uploadNote||'')}">ERR</span>`;
  return '‚Äî';
}

function rowHTML(r){
  const ok = r._ok === true;
  const st = ok ? '<span class="ok">OK</span>' : '<span class="err">ERR</span>';
  const note = r._err || r._uploadNote || (r._warn||'');
  const rkClass = r._genKey ? 'class="gen"' : '';
  const noteClass = r._err || r._upload === 'error' ? 'err' : (r._warn ? 'warn' : '');
  return `<tr>
    <td>${r.id||''}</td>
    <td>${r.data?.fromCode||''}</td>
    <td>${r.data?.toCode||''}</td>
    <td>${typeof r.data?.distance_km==='number' ? r.data.distance_km : ''}</td>
    <td ${rkClass}>${r.routeKey||''}</td>
    <td>${st}</td>
    <td>${uploadCell(r)}</td>
    <td class="${noteClass}">${note||''}</td>
  </tr>`;
}

function refreshTable(){
  tbody.innerHTML = parsed.map(rowHTML).join('');
  const total = parsed.length;
  const ok = parsed.filter(r=>r._ok).length;
  const bad = parsed.filter(r=>r._err).length;
  const needKey = parsed.filter(r=>!r._err && !r.routeKey).length;
  statsEl.textContent = ` ‚Ä¢ —Ñ–∞–π–ª—ñ–≤: ${total} ‚Ä¢ –≤–∞–ª—ñ–¥–Ω—ñ: ${ok} ‚Ä¢ –ø–æ–º–∏–ª–∫–∏: ${bad} ‚Ä¢ –±–µ–∑ routeKey: ${needKey}`;
  btnImport.disabled = ok === 0;
}
function setUploadState(rec, state, note){
  rec._upload = state;                 // 'idle' | 'writing' | 'done' | 'error'
  rec._uploadNote = note || '';
}
function markSlice(slice, state, note){
  slice.forEach(r => setUploadState(r, state, note));
  refreshTable();
}

function normalizeRouteObj(obj){
  const d = {...obj};
  Object.keys(d).forEach(k => { if (d[k] === undefined) delete d[k]; });
  return d;
}

// === directory cache –¥–ª—è –ø—Ä–µ—Ñ—ñ–∫—Å—ñ–≤ –ø–æ fromCode/toCode ===
const dirNamesByCode = new Map();
async function loadDirectoryByCodes(codes){
  const list = Array.from(new Set((codes||[]).filter(Boolean)));
  for (let i=0;i<list.length;i+=10){
    const chunk = list.slice(i, i+10);
    try{
      const snap = await db.collection('directory')
        .where(firebase.firestore.FieldPath.documentId(), 'in', chunk)
        .get({ source:'server' });
      snap.forEach(doc=>{
        const d = doc.data() || {};
        dirNamesByCode.set(doc.id, d.name || doc.id);
      });
    }catch(e){}
    chunk.forEach(id => { if (!dirNamesByCode.has(id)) dirNamesByCode.set(id, id); });
  }
}

// –ø–µ—Ä—à–∞ –ª—ñ—Ç–µ—Ä–∞ (—É–∫—Ä/–ª–∞—Ç), fallback ‚Äî –ø–µ—Ä—à–∏–π —Å–∏–º–≤–æ–ª
function firstLetterUA(s){
  const t = String(s||'').trim();
  for (const ch of t){
    if (/[A-Za-z–ê-–Ø–∞-—è“ê“ë–Ñ—î–Ü—ñ–á—ó]/.test(ch)) return ch.toUpperCase();
  }
  return t ? t[0].toUpperCase() : 'X';
}

// prefix "–õ–õ": –∞–±–æ –∑ –Ω–∞–∑–≤ (fromName/toName/–¥–æ–≤—ñ–¥–Ω–∏–∫), –∞–±–æ —Ç—ñ–ª—å–∫–∏ –∑ –∫–æ–¥—ñ–≤ (when preferCodesOnly=true)
function computePrefixFor(rec, preferCodesOnly){
  const d = rec.data || {};
  if (preferCodesOnly){
    const A = firstLetterUA(d.fromCode || '');
    const B = firstLetterUA(d.toCode || '');
    return `${A}${B}`;
  }
  let fromName = d.fromName || d.fromLabel || d.fromTitle || null;
  let toName   = d.toName   || d.toLabel   || d.toTitle   || null;
  if ((!fromName || !toName) && (d.fromCode || d.toCode)){
    if (d.fromCode && dirNamesByCode.has(d.fromCode)) fromName = fromName || dirNamesByCode.get(d.fromCode);
    if (d.toCode   && dirNamesByCode.has(d.toCode))   toName   = toName   || dirNamesByCode.get(d.toCode);
  }
  const A = firstLetterUA(fromName || d.fromCode || '');
  const B = firstLetterUA(toName   || d.toCode   || '');
  return `${A}${B}`;
}

// 10 –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö —Ü–∏—Ñ—Ä (crypto)
function randomDigits(len=10){
  const buf = new Uint8Array(len);
  (crypto || window.crypto).getRandomValues(buf);
  let s=''; for (let i=0;i<len;i++) s += (buf[i] % 10);
  return s;
}

// ---------- read JSON / ZIP ----------
async function handleFiles(fileList){
  setState('–ü–∞—Ä—Å–∏–Ω–≥‚Ä¶');
  const files = Array.from(fileList || []);
  if(!files.length){ setState('–ì–æ—Ç–æ–≤–æ'); return; }

  clearAll();

  for (const f of files){
    if (f.name.toLowerCase().endsWith('.zip')){
      const zip = await JSZip.loadAsync(f);
      const entries = Object.values(zip.files).filter(e => !e.dir && e.name.toLowerCase().endsWith('.json'));
      for (const e of entries){
        if (/\/?index\.json$/i.test(e.name)) continue;
        try{
          const txt = await e.async('string');
          const obj = JSON.parse(txt);
          acceptObject(obj, e.name);
        }catch(err){
          parsed.push({ id:null, data:null, routeKey:null, fileName:e.name, _ok:false, _err:'bad json in zip' });
        }
      }
    } else if (f.name.toLowerCase().endsWith('.json')){
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if (Array.isArray(obj)){
          obj.forEach((o,i)=> acceptObject(o, `${f.name}#${i+1}`));
        }else{
          acceptObject(obj, f.name);
        }
      }catch(err){
        parsed.push({ id:null, data:null, routeKey:null, fileName:f.name, _ok:false, _err:'bad json' });
      }
    }
  }

  // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ routeKey –¥—É–±–ª—ñ–≤ —É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö
  const seenKeys = new Map();
  for (const r of parsed){
    if (!r._ok || !r.routeKey) continue;
    const who = seenKeys.get(r.routeKey);
    if (who && who !== r.id){
      r._warn = `routeKey –¥—É–±–ª—é—î—Ç—å—Å—è —É —Ñ–∞–π–ª—ñ (–≤–∂–µ —î –¥–ª—è ${who})`;
    } else {
      seenKeys.set(r.routeKey, r.id);
    }
  }

  refreshTable();
  setState('–ì–æ—Ç–æ–≤–æ. –ì–æ—Ç–æ–≤–æ –¥–æ —ñ–º–ø–æ—Ä—Ç—É.');
}

function acceptObject(obj, fileName){
  const id = obj?.id || obj?.routeId || null;
  if (!id){
    parsed.push({ id:null, data:null, routeKey:null, fileName, _ok:false, _err:'–Ω–µ–º–∞—î –ø–æ–ª—è id' });
    return;
  }
  const data = normalizeRouteObj(obj);
  const routeKey = data.routeKey || data.key || null;

  const rec = { id, data, routeKey, fileName, _ok:true };
  parsed.push(rec);
}

// ---------- preflight –∑ Firestore ----------
async function preflight(){
  setState('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–ª—é—á—ñ–≤ —É Firestore‚Ä¶');
  problemsEl.textContent = '';
  conflicts = [];

  const toCheck = Array.from(new Set(parsed.map(r=>r.routeKey).filter(Boolean)));
  const CHUNK = 200;
  for (let i=0;i<toCheck.length;i+=CHUNK){
    const chunk = toCheck.slice(i, i+CHUNK);
    await Promise.all(chunk.map(async (rk) => {
      try{
        const ds = await db.collection('routeKeys').doc(rk).get();
        if (ds.exists){
          const existing = ds.data()?.routeId || null;
          const rIn = parsed.find(x => x.routeKey === rk);
          if (existing && rIn && existing !== rIn.id){
            conflicts.push({ routeKey: rk, firestoreRouteId: existing, incomingRouteId: rIn.id });
          }
        }
      }catch{}
    }));
  }

  if (conflicts.length){
    problemsEl.innerHTML = `<div class="warn"><b>–ó–Ω–∞–π–¥–µ–Ω—ñ –∫–æ–ª—ñ–∑—ñ—ó routeKey:</b><br>${conflicts.map(c=>`‚Ä¢ ${c.routeKey}: –≤ Firestore ‚Üí ${c.firestoreRouteId}, —É —Ñ–∞–π–ª—ñ ‚Üí ${c.incomingRouteId}`).join('<br>')}</div>`;
  } else {
    problemsEl.textContent = '';
  }
}

// ---------- –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è routeKey —É —Ñ–æ—Ä–º–∞—Ç—ñ "–õ–õ-##########" ----------
async function assignMissingRouteKeys(){
  const need = parsed.filter(r=>r._ok && !r.routeKey);
  if (!need.length) return;

  // —è–∫—â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ –±—Ä–∞—Ç–∏ –ø—Ä–µ—Ñ—ñ–∫—Å –∑ –Ω–∞–∑–≤ ‚Äî –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–≤—ñ–¥–Ω–∏–∫ –∑–∞ –∫–æ–¥–∞–º–∏
  if (!optPrefixFromCodes.checked){
    const codes = [];
    need.forEach(r => {
      const d = r.data || {};
      if (d.fromCode) codes.push(d.fromCode);
      if (d.toCode)   codes.push(d.toCode);
    });
    if (codes.length) await loadDirectoryByCodes(codes);
  }

  // —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å —É –º–µ–∂–∞—Ö –ø–∞—Ä—Ç—ñ—ó
  const inBatch = new Set(parsed.map(r=>r.routeKey).filter(Boolean));

  for (const r of need){
    const prefix = computePrefixFor(r, optPrefixFromCodes.checked); // ¬´–ë–ì¬ª —Ç–æ—â–æ
    let attempts = 0;
    while (attempts < 20){
      attempts++;
      const candidate = `${prefix}-${randomDigits(10)}`;
      if (inBatch.has(candidate)) continue;

      // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É Firestore –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
      try{
        const ds = await db.collection('routeKeys').doc(candidate).get({ source:'server' });
        if (ds.exists) continue;
      }catch(_){}

      r.routeKey = candidate;
      r.data.routeKey = candidate;
      r._genKey = true;
      inBatch.add(candidate);
      break;
    }
    if (!r.routeKey){ r._ok = false; r._err = '–Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π routeKey'; }
  }
  refreshTable();
}

/* ==== –ù–æ–≤–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –Ω–∞—Ä—ñ–∑–∞–Ω–Ω—è –±–∞—Ç—á—ñ–≤ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –æ–ø–µ—Ä–∞—Ü—ñ–π ==== */
const MAX_OPS_PER_BATCH = 450;                     // –∑–∞–ø–∞—Å –¥–æ 500
const opsFor = (r) => 1 + (r.routeKey ? 1 : 0);   // routes + (routeKeys)

function splitByOps(records){
  const out = [];
  let cur = [], ops = 0;
  for (const r of records){
    const need = opsFor(r);
    if (ops + need > MAX_OPS_PER_BATCH && cur.length){
      out.push(cur); cur = []; ops = 0;
    }
    cur.push(r); ops += need;
  }
  if (cur.length) out.push(cur);
  return out;
}

// –§–æ–ª–±–µ–∫: —è–∫—â–æ –ø–∞–∫–µ—Ç–Ω–∏–π commit –≤–ø–∞–≤ ‚Äî –ø–∏—à–µ–º–æ –ø–æ –æ–¥–Ω–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É (–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤)
async function commitSliceSafely(slice, uid, mergeFlag){
  for (const r of slice){
    setUploadState(r, 'writing');
    refreshTable();

    const b = db.batch();

    const routeRef = db.collection('routes').doc(r.id);
    const data = { ...r.data };
    if (!data.updatedAt) data.updatedAt = nowIso();
    data.importedAt = nowIso();
    if (uid) data.importedBy = uid;

    mergeFlag ? b.set(routeRef, data, { merge:true }) : b.set(routeRef, data);

    if (r.routeKey){
      const rkRef = db.collection('routeKeys').doc(r.routeKey);
      b.set(rkRef, {
        routeId: r.id,
        updatedAt: nowIso(),
        updatedBy: uid || null,
        active: true
      }, { merge:true });
    }

    try{
      await b.commit();
      setUploadState(r, 'done');          // ‚úÖ
    }catch(e){
      setUploadState(r, 'error', String(e && e.message || e));  // ‚ùå
    }

    refreshTable();
    // –¥–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å UI –æ–Ω–æ–≤–∏—Ç–∏—Å—è
    await new Promise(requestAnimationFrame);
  }
}

/* ---------- commit —É –±–∞—Ç—á–∞—Ö ---------- */
async function commitImport(){
  const user = auth.currentUser;
  const uid = user ? user.uid : null;

  // –ø—ñ–¥—Å—Ç—Ä–∞—Ö—É—î–º–æ—Å—è –≤—ñ–¥ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—É
  try { await firebase.firestore().enableNetwork(); } catch {}

  await preflight();

  // —è–∫—â–æ ¬´–∑–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏¬ª –≤–∏–º–∫–Ω–µ–Ω–∏–π ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞—Ö
  if (!optAlwaysOverwriteKeys.checked && conflicts.length && !optOverwriteKeys.checked){
    alert('–Ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ routeKey. –£–≤—ñ–º–∫–Ω—ñ—Ç—å ¬´–î–æ–∑–≤–æ–ª–∏—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å —É routeKeys¬ª –∞–±–æ –≤–∏–ø—Ä–∞–≤—Ç–µ —Ñ–∞–π–ª–∏.\n(–ê–±–æ —É–≤—ñ–º–∫–Ω—ñ—Ç—å ¬´–ó–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ routeKeys¬ª –¥–ª—è —Ñ–æ—Ä—Å-–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É.)');
    return;
  }

  // –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ —É —Ñ–æ—Ä–º–∞—Ç—ñ "–õ–õ-##########" –¥–ª—è –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö
  await assignMissingRouteKeys();

  if (optDryRun.checked){
    setState('Dry-run –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–±–µ–∑ –∑–∞–ø–∏—Å—É)');
    alert('Dry-run: –∫–ª—é—á—ñ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ç–∞ –ø–æ–∫–∞–∑–∞–Ω—ñ —É –ø—Ä–µ–≤‚Äô—é. –ó–Ω—ñ–º—ñ—Ç—å –≥–∞–ª–æ—á–∫—É, —â–æ–± –∑–∞–ø–∏—Å–∞—Ç–∏.');
    return;
  }

  const todo = parsed.filter(r=>r._ok);
  const batches = splitByOps(todo);
  let done = 0;

  for (let bi = 0; bi < batches.length; bi++){
    const slice = batches[bi];
    const batch = db.batch();

    // –ø–æ–∫–∞–∑—É—î–º–æ, —â–æ —Ü–µ–π —à–º–∞—Ç –ø–∏—à–µ—Ç—å—Å—è
    markSlice(slice, 'writing');

    for (const r of slice){
      const data = { ...r.data };
      if (!data.updatedAt) data.updatedAt = nowIso();
      data.importedAt = nowIso();
      if (uid) data.importedBy = uid;

      const routeRef = db.collection('routes').doc(r.id);
      optMerge.checked ? batch.set(routeRef, data, { merge:true }) : batch.set(routeRef, data);

      if (r.routeKey){
        const rkRef = db.collection('routeKeys').doc(r.routeKey);
        const rkData = { routeId: r.id, updatedAt: nowIso(), updatedBy: uid || null, active: true };
        batch.set(rkRef, rkData, { merge:true });
      }
    }

    setState(`–ó–∞–ø–∏—Å: ${done}/${todo.length}‚Ä¶ (–ø–∞–∫–µ—Ç ${bi+1}/${batches.length})`);
    try{
      await batch.commit();
      markSlice(slice, 'done');        // ‚úÖ —É—Å—ñ–º —É –±–∞—Ç—á—ñ ‚Äî done
    }catch(e){
      console.warn('batch.commit –ø–æ–º–∏–ª–∫–∞, –ø–∏—à—É –ø–æ –æ–¥–Ω–æ–º—É:', e);
      // —Ç—É—Ç –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ –æ—Ç—Ä–∏–º–∞—î –≤–ª–∞—Å–Ω–∏–π —Å—Ç–∞—Ç—É—Å
      await commitSliceSafely(slice, uid, optMerge.checked);
    }

    done += slice.length;
    setState(`–ó–∞–ø–∏—Å: ${done}/${todo.length}‚Ä¶ (–ø–∞–∫–µ—Ç ${bi+1}/${batches.length})`);
    // –¥–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—Ä–æ–º–∞–ª—é–≤–∞—Ç–∏—Å—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—É
    await new Promise(requestAnimationFrame);
  }

  setState('–ì–æ—Ç–æ–≤–æ');
  alert(`–Ü–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${done} –º–∞—Ä—à—Ä—É—Ç—ñ–≤`);
}

// ---------- drag & drop / file pick ----------
function setupDnD(){
  drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
  drop.addEventListener('drop', (e)=>{
    e.preventDefault(); drop.classList.remove('drag');
    handleFiles(e.dataTransfer.files);
  });
}
setupDnD();

fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
btnPickZip.onclick = ()=> {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.zip'; inp.multiple = true;
  inp.onchange = (e)=> handleFiles(e.target.files);
  inp.click();
};
btnClear.onclick = clearAll;
btnImport.onclick = ()=> commitImport();

</script>
</body>
</html>
