<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–Ü–º–ø–æ—Ä—Ç –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ –≤ Firestore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#1f2328; --muted:#6b7280;
      --line:#e5e7eb; --ok:#0a7a0a; --err:#b00020; --brand:#0ea5e9; --brand-2:#0369a1;
      --radius:12px; --shadow:0 1px 3px rgba(16,24,40,.06),0 1px 2px rgba(16,24,40,.04);
    }
    /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ DOM –¥–æ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è guard-–∞ */
    html{ visibility:hidden }

    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:960px; margin:24px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 12px}
    .sub{color:var(--muted); font-size:14px; margin-bottom:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:12px 0}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{font-weight:600; font-size:14px}
    select,input[type=number],input[type=file]{padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; outline:none; min-height:40px}
    textarea{width:100%; min-height:200px; padding:10px; border:1px solid var(--line); border-radius:10px; resize:vertical; background:#fff; outline:none}
    .muted{color:var(--muted); font-size:13px}
    .btn{padding:10px 14px; border-radius:10px; border:1px solid transparent; cursor:pointer; font-weight:600; min-height:40px}
    .btn.primary{background:var(--brand); color:#fff}
    .btn.primary:hover{background:var(--brand-2)}
    .btn.ghost{background:#fff; border-color:#line}
    .btn.ghost:hover{border-color:#cbd5e1}
    .btn.warn{background:#fff; border-color:#f59e0b; color:#b45309}
    .grid{display:grid; gap:12px}
    @media(min-width:720px){ .grid.two{grid-template-columns:1fr 1fr} }
    .counter{margin-top:8px; font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    pre#log{
      background:#0b1020; color:#e2e8f0; padding:12px; border-radius:10px;
      max-height:60vh; min-height:240px; overflow:auto; resize:vertical; margin-top:8px;
      white-space:pre-wrap;              /* ‚¨ÖÔ∏è –ø–µ—Ä–µ–Ω–æ—Å –¥–æ–≤–≥–∏—Ö —Ä—è–¥–∫—ñ–≤ */
      word-break:break-word;
    }
    code{background:#f1f5f9; padding:2px 6px; border-radius:6px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:#eef6ff; border:1px solid #dbeafe; color:#1e3a8a; border-radius:999px; font-size:12px}
    .progress-wrap{display:flex; align-items:center; gap:10px; margin-top:8px}
    progress{width:260px; height:14px}

    /* top header with auth */
    header.top { background:#2563eb;color:#fff;padding:10px;display:flex;gap:16px;align-items:center;justify-content:space-between; }
    header.top a { color:#fff;text-decoration:none; }
    .authbar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .authbar .btn { height:30px; padding:4px 10px; }
    .role-badge { background:rgba(255,255,255,.2); padding:2px 8px; border-radius:999px; font-size:12px; }
  </style>

  <!-- === AUTH GUARD —É <head> === -->
  <script>
    (async function(){
      const firebaseConfig = {
        apiKey: "AIzaSyAREP_iNSUZqNFH5RB5PE084b3wNyxaJ6c",
  authDomain: "route-project-ba7c6.firebaseapp.com",
  projectId: "route-project-ba7c6",
  storageBucket: "route-project-ba7c6.firebasestorage.app",
  messagingSenderId: "953368824279",
  appId: "1:953368824279:web:68d28c2fd40292c13ee392",
  measurementId: "G-B6B2JK7BXE"
      };
      try{ firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig); }catch(e){}

      const db   = firebase.firestore();
      const auth = firebase.auth();
      const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
      const ALLOWED = new Set(['admin','logist']);

      auth.onAuthStateChanged(async (u) => {
        if (!u) { location.replace(loginURL); return; }

        // —á–∏—Ç–∞—î–º–æ —Ä–æ–ª—å –∑ users/{uid}.role, fallback roles/{uid}.role
        let role = 'pending';
        try{
          const us = await db.collection('users').doc(u.uid).get();
          role = us.exists ? (us.data().role || 'pending') : 'pending';
          if (role === 'pending') {
            const rs = await db.collection('roles').doc(u.uid).get();
            if (rs.exists && rs.data()?.role) role = String(rs.data().role);
          }
        }catch(e){ role = 'pending'; }

        role = String(role).trim().toLowerCase();   // ‚úÖ –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ
		window.__userRole = role;

        if (!ALLOWED.has(role)) {
          alert(role === 'pending'
            ? '–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
            : '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –Ü–º–ø–æ—Ä—Ç—É (–ø–æ—Ç—Ä—ñ–±–Ω–æ: admin –∞–±–æ logist).');
          location.replace(loginURL);
          return;
        }

        // –¥–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ DOM
        document.documentElement.style.visibility = 'visible';
      });
    })();
  </script>
</head>
<body>
  <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è + –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
  <header class="top">
    <nav style="display:flex;gap:16px;align-items:center;">
      <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
      <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
      <a href="/import/">üì• –Ü–º–ø–æ—Ä—Ç</a>
    </nav>
    <div class="authbar">
      <span id="authInfo">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</span>
      <span id="authRole" class="role-badge" style="display:none;"></span>
      <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
      <span id="statusTop" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
    </div>
  </header>

  <div class="wrap">
    <h1>–Ü–º–ø–æ—Ä—Ç –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ ‚Üí Firestore <span class="pill"><b>collection:</b> <code>directory</code></span></h1>
    <div class="sub">–ü—Ä–∞—Ü—é—î –∑ CSV/TSV, –∫–æ–ø—ñ–ø–∞—Å—Ç–æ—é –∑ Excel —Ç–∞ –ø—Ä–æ—Å—Ç–∏–º–∏ –¥–≤–æ–∫–æ–ª–æ–Ω–∫–æ–≤–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏. –Ñ ‚Äú—Å—É—Ö–∏–π –∑–∞–ø—É—Å–∫‚Äù.</div>

    <div class="card">
      <b>–§–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö</b>
      <ul class="muted">
        <li>CSV —ñ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏: <i>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ, –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª, –ù–∞–∑–≤–∞, –ö–û–î</i></li>
        <li>–ö–æ–ø—ñ–ø–∞—Å—Ç–∞ –∑ Excel (—Ç–∞–±–∞–º–∏)</li>
        <li>–ü—Ä–æ—Å—Ç–∏–π CSV/TSV –∑ –¥–≤–æ–º–∞ –∫–æ–ª–æ–Ω–∫–∞–º–∏: <i>–ù–∞–∑–≤–∞, –ö–û–î</i></li>
      </ul>
      <div class="muted">–Ü–º–ø–æ—Ä—Ç–µ—Ä —à—É–∫–∞—î –∫–æ–ª–æ–Ω–∫–∏ ‚Äú–ù–∞–∑–≤–∞‚Äù, ‚Äú–ö–û–î‚Äù, ‚Äú–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ‚Äù, ‚Äú–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª‚Äù. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ ‚Äî –∑–∞–¥–∞–π —ñ–Ω–¥–µ–∫—Å–∏ –≤—Ä—É—á–Ω—É.</div>
    </div>

    <div class="grid two">
      <div class="card">
        <label>1) –ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)</label>
        <input type="file" id="file" accept=".csv,.tsv,.txt" />
        <div class="muted">–ê–±–æ –≤—Å—Ç–∞–≤ –¥–∞–Ω—ñ –Ω–∏–∂—á–µ</div>
        <div style="margin-top:8px">
          <button class="btn ghost" id="demoBtn">–í—Å—Ç–∞–≤–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label>–†–æ–∑–¥—ñ–ª—é–≤–∞—á</label><br/>
            <select id="sep">
              <option value="auto">–ê–≤—Ç–æ</option>
              <option value=",">–ö–æ–º–∞ (,)</option>
              <option value=";">–ö—Ä–∞–ø–∫–∞ –∑ –∫–æ–º–æ—é (;)</option>
              <option value="\t">–¢–∞–±</option>
            </select>
          </div>
          <div>
            <label>–ö–æ–¥—É–≤–∞–Ω–Ω—è</label><br/>
            <select id="enc">
              <option value="utf-8">UTF-8</option>
              <option value="windows-1251">Windows-1251</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>2) –í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç (CSV/TSV/Excel):</label>
      <textarea id="raw" placeholder="–í—Å—Ç–∞–≤ —Å—é–¥–∏ –¥–∞–Ω—ñ‚Ä¶"></textarea>
    </div>

    <div class="card">
      <label>3) –ú–∞–ø—ñ–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ (—è–∫—â–æ –∞–≤—Ç–æ-–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–µ —Å–ø—Ä–∞—Ü—é—î):</label>
      <div class="row" style="margin-top:6px">
        <span>‚Äú–ù–∞–∑–≤–∞‚Äù:</span><input id="nameCol" type="number" min="0" style="width:90px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span>‚Äú–ö–û–î‚Äù:</span><input id="codeCol" type="number" min="0" style="width:90px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span>‚Äú–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ‚Äù:</span><input id="companyCol" type="number" min="0" style="width:110px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span>‚Äú–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª‚Äù:</span><input id="unitCol" type="number" min="0" style="width:100px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span class="muted">(—Ä–∞—Ö—É–Ω–æ–∫ –∑ 0; –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äì –æ–∫—Ä–µ–º–æ)</span>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input type="checkbox" id="hasHeader" checked /> –ü–µ—Ä—à–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏</label>
        <label><input type="checkbox" id="dryRun" checked /> ‚Äú–°—É—Ö–∏–π‚Äù –∑–∞–ø—É—Å–∫ (–±–µ–∑ –∑–∞–ø–∏—Å—É)</label>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn ghost" id="parseBtn">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–∞–Ω—ñ</button>
      <button class="btn primary" id="importBtn" disabled>–Ü–º–ø–æ—Ä—Ç —É Firestore</button>
      <button class="btn warn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è</button>
    </div>

    <div class="progress-wrap">
      <progress id="prog" value="0" max="100"></progress>
      <span id="progLabel" class="muted">–ì–æ—Ç–æ–≤–æ</span>
    </div>

    <div id="status" class="counter"></div>
    <pre id="log"></pre>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  'use strict';

  const $ = (id) => document.getElementById(id);
  function log(msg, type=''){
    const el = $('log');
    el.textContent += (type ? '['+type+'] ' : '') + msg + '\n';
    el.scrollTop = el.scrollHeight;
  }
  function setStatus(html){ $('status').innerHTML = html; }
  function setProg(pct, label){
    $('prog').value = Math.max(0, Math.min(100, Math.round(pct)));
    $('progLabel').textContent = label || '';
  }

  // ----- AUTH / FIREBASE -----
  const statusTop = $('statusTop');
  const authInfo = $('authInfo');
  const authRoleBadge = $('authRole');
  const btnLogout = $('btnLogout');
  const importBtn = $('importBtn');

  let db = null, auth = null, currentUser = null, currentRole = 'pending';
const WRITE_ROLES = new Set(['admin','logist']);
const NORM = r => String(r || 'pending').trim().toLowerCase();

async function resolveUserRole(uid){
  // —á–∏—Ç–∞—î–º–æ users/{uid} –∑—ñ —Å–µ—Ä–≤–µ—Ä–∞ –∑ fallback –Ω–∞ roles/{uid}
  try{
    const us = await db.collection('users').doc(uid).get({ source: 'server' });
    if (us.exists && us.data()?.role) return NORM(us.data().role);
  }catch{}
  try{
    const rs = await db.collection('roles').doc(uid).get({ source: 'server' });
    if (rs.exists && rs.data()?.role) return NORM(rs.data().role);
  }catch{}
  return 'pending';
}

  // Firebase –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —É head-guard
  try{
    db = firebase.firestore();
    auth = firebase.auth();
    statusTop.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
    db.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
  }catch(e){
    console.error(e);
    statusTop.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
  }

  function updateImportButton(){
    const dry = $('dryRun').checked;
    if (dry) {
      importBtn.disabled = false;
      importBtn.title = 'Dry-run (–±–µ–∑ –∑–∞–ø–∏—Å—É)';
    } else {
      const canWrite = currentUser && WRITE_ROLES.has(currentRole);
      importBtn.disabled = !canWrite;
      importBtn.title = canWrite ? '' : '–ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin –∞–±–æ logist';
    }
  }
  $('dryRun').addEventListener('change', updateImportButton);

  btnLogout.addEventListener('click', async () => {
    try{ await auth.signOut(); }catch(e){ console.warn(e); }
  });

  let roleUnsub = null;

auth?.onAuthStateChanged(async (u) => {
  currentUser = u || null;
  if (!u){
    const next = encodeURIComponent(location.pathname + location.search);
    location.replace(`/login.html?next=${next}`);
    return;
  }

  // 1) —à–≤–∏–¥–∫–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –∑ head-guard (—è–∫—â–æ –≤–∂–µ —î)
  let role = window.__userRole ? NORM(window.__userRole) : null;
  // 2) –Ω–∞–¥—ñ–π–Ω–æ –¥–æ—á–∏—Ç—É—î–º–æ –∑ Firestore (—É—Å—É–≤–∞—î –≥–æ–Ω–∫—É)
  if (!role || role === 'pending') role = await resolveUserRole(u.uid);

  currentRole = role;
  window.__userRole = role; // —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –¥–ª—è —ñ–Ω—à–∏—Ö —Å–∫—Ä–∏–ø—Ç—ñ–≤

  authInfo.textContent = `–£–≤—ñ–π—à–ª–∏ —è–∫ ${u.email || u.uid}`;
  btnLogout.style.display = '';
  authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`;
  authRoleBadge.style.display = '';
  statusTop.textContent = '–ì–æ—Ç–æ–≤–æ';
  updateImportButton();

  // 3) live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ
  roleUnsub?.();
  roleUnsub = db.collection('users').doc(u.uid)
    .onSnapshot({ includeMetadataChanges:true }, async (doc) => {
      let r = doc.exists ? NORM(doc.data().role) : 'pending';
      if (r === 'pending') {
        // fallback –Ω–∞ roles, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        try{
          const rs = await db.collection('roles').doc(u.uid).get({ source:'server' });
          if (rs.exists && rs.data()?.role) r = NORM(rs.data().role);
        }catch{}
      }
      currentRole = r;
      window.__userRole = r;
      authRoleBadge.textContent = `–†–æ–ª—å: ${r}`;
      updateImportButton();
    });
});

  // –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞—á –ø–æ–º–∏–ª–æ–∫ ‚Üí —É –ª–æ–≥
  window.addEventListener('error', (e) => {
    log(`${e.message} @ ${e.filename||''}:${e.lineno||''}`, 'err');
  });

  const PREVIEW_ROWS = 5;
  const SAFE_BATCH = 450; // –Ω–∏–∂—á–µ 500 ‚Äî –ª—ñ–º—ñ—Ç –¥–ª—è writeBatch

  function initFirebaseWrite(){
    if (!db) { alert('Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.'); return null; }
    if (!currentUser) { alert('–°–ø–µ—Ä—à—É —É–≤—ñ–π–¥–∏.'); return null; }
    if (!WRITE_ROLES.has(currentRole)) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin –∞–±–æ logist.'); return null; }
    return db;
  }

  // –î–µ–º–æ
  $('demoBtn')?.addEventListener('click', () => {
    $('raw').value =
`–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ\t–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª\t–ù–∞–∑–≤–∞\t–ö–û–î
–ê–¢–ü\t–î—ñ–ª—å–Ω–∏—Ü—è 1\t–ï–ª–µ–≤–∞—Ç–æ—Ä –ê\tELV01
–ê–¢–ü\t–î—ñ–ª—å–Ω–∏—Ü—è 2\t–ï–ª–µ–≤–∞—Ç–æ—Ä –ë\tELV02
–¢–∞—Ä–Ω–∏–π\t–ó–º—ñ–Ω–∞ 3\t–ü–æ–ª–µ-1\tFLD11`;
    setStatus('<span class="muted">–î–µ–º–æ-–¥–∞–Ω—ñ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ</span>');
    $('raw').focus();
  });

  // –ß–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É –∑ –∫–æ–¥—É–≤–∞–Ω–Ω—è–º
  $('file').addEventListener('change', async (e) => {
    try{
      const file = e.target.files[0];
      if (!file) return;
      const enc = $('enc').value || 'utf-8';
      const buf = await file.arrayBuffer();
      let text;
      try { text = new TextDecoder(enc).decode(buf); }
      catch { text = new TextDecoder('utf-8').decode(buf); }
      $('raw').value = text;
      setStatus(`<span class="muted">–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${file.name} (${enc})</span>`);
    }catch(err){
      log('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É: ' + (err?.message||err), 'err');
    }
  });

  // –ü–∞—Ä—Å–∏–Ω–≥
  function detectSep(text){
    const s = $('sep').value;
    if (s !== 'auto') return s === '\\t' ? '\t' : s;
    const firstLine = text.split(/\r?\n/).find(l => l.trim().length);
    if (!firstLine) return ',';
    const counts = { ',': (firstLine.match(/,/g)||[]).length,
                     ';': (firstLine.match(/;/g)||[]).length,
                     '\t': (firstLine.match(/\t/g)||[]).length };
    return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ',';
  }
  function parseTable(text){
    const sep = detectSep(text);
    const rows = text.split(/\r?\n/).filter(r=>r.trim().length);
    const table = rows.map(r => r.split(sep));
    return { sep, rows, table };
  }

  function guessColumns(headerRow){
    const h = headerRow.map(x => (x||'').toString().trim().toLowerCase());
    const nameIdx = h.findIndex(x => ['–Ω–∞–∑–≤–∞','name'].includes(x));
    const codeIdx = h.findIndex(x => ['–∫–æ–¥','–∫–æ–¥ —Ü–±','–∫–æ–¥ —Ü–±','code'].includes(x));
    const companyIdx = h.findIndex(x => ['–ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ','pidpryiemstvo','company'].includes(x));
    const unitIdx = h.findIndex(x => ['–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª','pidrozdil','unit','division'].includes(x));
    return { nameIdx: nameIdx>=0?nameIdx:null, codeIdx: codeIdx>=0?codeIdx:null,
             companyIdx: companyIdx>=0?companyIdx:null, unitIdx: unitIdx>=0?unitIdx:null };
  }

  function sanitizeId(s){
    return (s||'').toString().trim().replace(/[\/\\#?[\]]/g, '_').slice(0, 500);
  }

  // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ entries
  function prepareEntries(){
    const raw = $('raw').value;
    if (!raw.trim()){ alert('–ü–æ—Ä–æ–∂–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É'); return null; }
    const parsed = parseTable(raw);
    const hasHeader = $('hasHeader').checked;

    let rows = parsed.table, startIdx = 0;
    let nameIdx = $('nameCol').value ? parseInt($('nameCol').value,10) : null;
    let codeIdx = $('codeCol').value ? parseInt($('codeCol').value,10) : null;
    let companyIdx = $('companyCol').value ? parseInt($('companyCol').value,10) : null;
    let unitIdx = $('unitCol').value ? parseInt($('unitCol').value,10) : null;

    if (hasHeader && rows.length){
      const g = guessColumns(rows[0]);
      if (nameIdx === null) nameIdx = g.nameIdx;
      if (codeIdx === null) codeIdx = g.codeIdx;
      if (companyIdx === null) companyIdx = g.companyIdx;
      if (unitIdx === null) unitIdx = g.unitIdx;
      startIdx = 1;
      setStatus(`<span class="muted">–í–∏—è–≤–ª–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á: <b>${parsed.sep === '\t' ? 'TAB' : parsed.sep}</b>. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ.</span>`);
    }

    if (nameIdx === null || codeIdx === null){
      const cols = rows[0]?.length || 2;
      if (codeIdx === null) codeIdx = cols - 1;
      if (nameIdx === null) nameIdx = 0;
      setStatus(`<span class="muted">–í–∏—è–≤–ª–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á: <b>${parsed.sep === '\t' ? 'TAB' : parsed.sep}</b>. –ú–∞–ø—ñ–Ω–≥ –ø—ñ–¥—ñ–±—Ä–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.</span>`);
    }

    const entries = [];
    let skippedEmptyName = 0, skippedEmptyCode = 0, skippedBlankRow = 0;

    for (let i = startIdx; i < rows.length; i++){
      const r = rows[i];
      if (!r || !r.length || r.every(c => (c||'').toString().trim()==='')) { skippedBlankRow++; continue; }
      const name = (r[nameIdx]||'').toString().trim();
      const code = (r[codeIdx]||'').toString().trim();
      const company = companyIdx!=null ? (r[companyIdx]||'').toString().trim() : '';
      const unit = unitIdx!=null ? (r[unitIdx]||'').toString().trim() : '';
      if (!name && !code) { skippedBlankRow++; continue; }
      if (!name) { skippedEmptyName++; continue; }
      if (!code) { skippedEmptyCode++; continue; }
      entries.push({ id: sanitizeId(code), data: { name, ...(company?{company}:{}), ...(unit?{unit}:{}) } });
    }

    // –î–µ–¥—É–ø –∑–∞ id
    const map = new Map();
    for (const e of entries) map.set(e.id, e);
    const deduped = Array.from(map.values());

    log(`–ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: ${entries.length}. –ü—ñ—Å–ª—è –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó: ${deduped.length}`, 'ok');
    log(`–ü—Ä–æ–ø—É—â–µ–Ω–æ ‚Üí blank:${skippedBlankRow} | emptyName:${skippedEmptyName} | emptyCode:${skippedEmptyCode}`, 'ok');

    return deduped;
  }

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
  $('parseBtn').addEventListener('click', () => {
    const entries = prepareEntries();
    if (!entries) return;
    setStatus(`<b>–ì–æ—Ç–æ–≤–æ –¥–æ —ñ–º–ø–æ—Ä—Ç—É:</b> ${entries.length}`);
    log('–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–µ—Ä—à–∏—Ö 5:', 'ok');
    entries.slice(0,5).forEach(e => log(`id="${e.id}"  data=${JSON.stringify(e.data)}`));
  });

  // –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –≤–∞–∂–ª–∏–≤–∏—Ö –ø–æ–ª—ñ–≤
  function normData(d){ return { name: d?.name || '', company: d?.company || '', unit: d?.unit || '' }; }
  function equalData(a,b){
    const x = JSON.stringify(normData(a));
    const y = JSON.stringify(normData(b));
    return x === y;
  }

  // –Ü–º–ø–æ—Ä—Ç
  $('importBtn').addEventListener('click', async () => {
    const entries = prepareEntries();
    if (!entries) return;

    const dry = $('dryRun').checked;
    if (!dry){
      if (!initFirebaseWrite()) return;
    }

    $('importBtn').disabled = true;
    $('parseBtn').disabled = true;
    $('clearBtn').disabled = true;

    const total = entries.length;
    const SAFE_BATCH = 450;
    const totalBatches = Math.ceil(total / SAFE_BATCH);
    let ok = 0, fail = 0;
    let newCount = 0, updatedCount = 0, unchangedCount = 0;

    const startedAt = Date.now();
    setProg(0, '–ü–æ—á–∞—Ç–æ–∫‚Ä¶');

    try{
      for (let b = 0; b < totalBatches; b++){
        const slice = entries.slice(b*SAFE_BATCH, (b+1)*SAFE_BATCH);

        // —á–∏—Ç–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –≤–µ—Ä—Å—ñ—ó (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ)
        const refs = slice.map(({id}) => db.collection('directory').doc(id));
        const snaps = await Promise.all(refs.map(r => r.get()));

        let writes = 0;
        const batch = !dry ? db.batch() : null;

        for (let i = 0; i < slice.length; i++){
          const { id, data } = slice[i];
          const snap = snaps[i];
          if (!snap.exists){
            newCount++;
            if (!dry){ batch.set(refs[i], data, { merge: true }); writes++; }
          } else {
            const old = snap.data() || {};
            if (!equalData(old, data)){
              updatedCount++;
              if (!dry){ batch.set(refs[i], data, { merge: true }); writes++; }
            } else {
              unchangedCount++;
            }
          }
        }

        if (!dry && writes > 0){
          await batch.commit();
        }

        ok += slice.length;

        const pct = ((b+1)/totalBatches)*100;
        const elapsed = (Date.now() - startedAt)/1000;
        const speed = ok / Math.max(elapsed, 0.001);
        const remain = total - ok;
        const eta = remain / Math.max(speed, 0.001);

        setProg(pct, `–í–∏–∫–æ–Ω–∞–Ω–æ ${Math.round(pct)}% ‚Ä¢ ${ok}/${total} ‚Ä¢ ETA ~ ${Math.ceil(eta)}—Å`);
        if ((b % 5) === 0 || b === totalBatches-1){
          log(`–ë–∞—Ç—á ${b+1}/${totalBatches} –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –û–±—Ä–æ–±–ª–µ–Ω–æ: ${ok}. –ù–æ–≤–∏—Ö: ${newCount}, –û–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount}, –ë–µ–∑ –∑–º—ñ–Ω: ${unchangedCount}`, 'ok');
        }
      }

      setStatus(`
        <span class="ok"><b>–ì–æ—Ç–æ–≤–æ.</b> –û–±—Ä–æ–±–ª–µ–Ω–æ: ${ok}</span>${fail ? `, <span class="err">–ü–æ–º–∏–ª–æ–∫: ${fail}</span>` : ''}
        <br><span class="muted">–î–æ–¥–∞–Ω–æ –Ω–æ–≤–∏—Ö: <b>${newCount}</b> ‚Ä¢ –û–Ω–æ–≤–ª–µ–Ω–æ: <b>${updatedCount}</b> ‚Ä¢ –ë–µ–∑ –∑–º—ñ–Ω: <b>${unchangedCount}</b>${dry ? ' (dry-run, –±–µ–∑ –∑–∞–ø–∏—Å—É)' : ''}</span>
      `);
      log(`–ü—ñ–¥—Å—É–º–æ–∫ ‚Üí –ù–æ–≤–∏—Ö: ${newCount} | –û–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount} | –ë–µ–∑ –∑–º—ñ–Ω: ${unchangedCount}${dry ? ' (dry-run)' : ''}`, 'ok');
      setProg(100, '–ì–æ—Ç–æ–≤–æ');
    }catch(e){
      fail = total - ok;
      log(`–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ${e.message || e}`, 'err');
      alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —ñ–º–ø–æ—Ä—Ç—É. –î–µ—Ç–∞–ª—ñ —É –ª–æ–≥–∞—Ö.');
      setProg(0, '–ü–æ–º–∏–ª–∫–∞');
    }finally{
      $('importBtn').disabled = false;
      $('parseBtn').disabled = false;
      $('clearBtn').disabled = false;
      updateImportButton();
    }
  });

  // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è
  $('clearBtn').addEventListener('click', () => {
    $('file').value = '';
    $('raw').value = '';
    $('sep').value = 'auto';
    $('enc').value = 'utf-8';
    ['nameCol','codeCol','companyCol','unitCol'].forEach(id => { $(id).value = ''; });
    $('hasHeader').checked = true;
    $('dryRun').checked = true;
    $('status').innerHTML = '';
    $('log').textContent = '';
    setProg(0, '–ì–æ—Ç–æ–≤–æ');
    $('raw').focus();
    updateImportButton();
  });

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞ –ø—ñ–¥–∫–∞–∑–∫–∞
  statusTop.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å';
  updateImportButton();
});
</script>
<script>
  window.addEventListener('error',            ()=>{ document.documentElement.style.visibility = 'visible'; });
  window.addEventListener('unhandledrejection',()=>{ document.documentElement.style.visibility = 'visible'; });
</script>

</body>
</html>
