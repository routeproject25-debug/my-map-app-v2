<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–Ü–º–ø–æ—Ä—Ç –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ –≤ Firestore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- App config (–¥–æ–¥–∞—Ç–∏ —Ü–µ–π —Ä—è–¥–æ–∫!) -->
<script src="/config/config.js"></script>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#1f2328; --muted:#6b7280;
      --line:#e5e7eb; --ok:#0a7a0a; --err:#b00020; --brand:#0ea5e9; --brand-2:#0369a1;
      --radius:12px; --shadow:0 1px 3px rgba(16,24,40,.06),0 1px 2px rgba(16,24,40,.04);
    }
    /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ DOM –¥–æ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è guard-–∞ */
    html{ visibility:hidden }

    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:960px; margin:24px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 12px}
    .sub{color:var(--muted); font-size:14px; margin-bottom:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:12px 0}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{font-weight:600; font-size:14px}
    select,input[type=number],input[type=file]{padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; outline:none; min-height:40px}
    textarea{width:100%; min-height:200px; padding:10px; border:1px solid var(--line); border-radius:10px; resize:vertical; background:#fff; outline:none}
    .muted{color:var(--muted); font-size:13px}
    .btn{padding:10px 14px; border-radius:10px; border:1px solid transparent; cursor:pointer; font-weight:600; min-height:40px}
    .btn.primary{background:var(--brand); color:#fff}
    .btn.primary:hover{background:var(--brand-2)}
    .btn.ghost{background:#fff; border-color:var(--line)}
    .btn.ghost:hover{border-color:#cbd5e1}
    .btn.warn{background:#fff; border-color:#f59e0b; color:#b45309}
    .grid{display:grid; gap:12px}
    @media(min-width:720px){ .grid.two{grid-template-columns:1fr 1fr} }
    .counter{margin-top:8px; font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    pre#log{
      background:#0b1020; color:#e2e8f0; padding:12px; border-radius:10px;
      max-height:60vh; min-height:240px; overflow:auto; resize:vertical; margin-top:8px;
      white-space:pre-wrap;              /* ‚¨ÖÔ∏è –ø–µ—Ä–µ–Ω–æ—Å –¥–æ–≤–≥–∏—Ö —Ä—è–¥–∫—ñ–≤ */
      word-break:break-word;
    }
    code{background:#f1f5f9; padding:2px 6px; border-radius:6px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:#eef6ff; border:1px solid #dbeafe; color:#1e3a8a; border-radius:999px; font-size:12px}
    .progress-wrap{display:flex; align-items:center; gap:10px; margin-top:8px}
    progress{width:260px; height:14px}

    /* top header with auth */
    header.top { background:#2563eb;color:#fff;padding:10px;display:flex;gap:16px;align-items:center;justify-content:space-between; }
    header.top a { color:#fff;text-decoration:none; }
    .authbar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .authbar .btn { height:30px; padding:4px 10px; }
    .role-badge { background:rgba(255,255,255,.2); padding:2px 8px; border-radius:999px; font-size:12px; }

    /* Summary modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.54); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); width:min(1000px, 96vw); max-height:86vh; display:flex; flex-direction:column; }
    .modal header{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--line); }
    .modal header h3{ margin:0; font-size:16px; }
    .modal .content{ padding:10px 14px; overflow:auto; }
    .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--line); margin-bottom:8px; }
    .tab{ padding:6px 10px; border:1px solid var(--line); border-bottom:none; border-top-left-radius:8px; border-top-right-radius:8px; background:#f8fafc; cursor:pointer; font-size:13px; }
    .tab.active{ background:#fff; }
    table.summary{ width:100%; border-collapse:collapse; font-size:13px; }
    table.summary th, table.summary td{ border-bottom:1px solid #eef2f7; padding:6px 8px; text-align:left; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .b-new{ background:#ecfdf5; color:#065f46; }
    .b-upd{ background:#fff7ed; color:#9a3412; }
    .b-same{ background:#f1f5f9; color:#334155; }
    .modal .toolbar{ justify-content:space-between; }
  </style>

  <!-- === AUTH GUARD —É <head> === -->
  <script>
  (function () {
    const CFG = window.APP_CONFIG?.firebase;
    if (!CFG) {
      console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js');
      document.documentElement.style.visibility = 'visible'; // –Ω–µ —Ö–æ–≤–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É
      return;
    }
    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e){}

    const db   = firebase.firestore();
    const auth = firebase.auth();
    const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
  const ALLOWED = new Set(['admin']);

    // –∑–∞–ø–∞—Å–Ω–∏–π —Ç–∞–π–º–µ—Ä, —â–æ–± —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ—é
    const safety = setTimeout(() => { document.documentElement.style.visibility = 'visible'; }, 3000);

    async function fetchRole(uid){
      // 1) server ‚Üí 2) default (server –∞–±–æ cache) ‚Üí 3) cache
      const tryGet = async (source) => {
        try { const snap = await db.collection('users').doc(uid).get({ source }); 
              if (snap.exists && snap.data()?.role) return String(snap.data().role); } catch {}
        try { const snap = await db.collection('roles').doc(uid).get({ source }); 
              if (snap.exists && snap.data()?.role) return String(snap.data().role); } catch {}
        return null;
      };
      return (await tryGet('server')) || (await tryGet('default')) || (await tryGet('cache')) || 'pending';
    }

    auth.onAuthStateChanged(async (u) => {
      if (!u) { location.replace(loginURL); return; }

      // –ü–æ–∫–∞–∑—É—î–º–æ UI –Ω–µ–≥–∞–π–Ω–æ ‚Äî –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ä–æ–ª—å —â–µ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞
      document.documentElement.style.visibility = 'visible';
      clearTimeout(safety);

      let role = 'pending';
      try { role = (await fetchRole(u.uid)) || 'pending'; } catch (e) { console.warn('role fetch error:', e); }
      role = role.trim().toLowerCase();
      window.__userRole = role;

      if (!ALLOWED.has(role)) {
        alert(role === 'pending'
          ? '–í–∞—à –∞–∫–∞—É–Ω—Ç –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
          : '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤: –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –Ü–º–ø–æ—Ä—Ç—É.');
        location.replace(loginURL);
      }
    });
  })();
</script>
</head>
<body>
  <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è + –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
  <header class="top">
    <nav style="display:flex;gap:16px;align-items:center;">
      <a href="/">üè† –ö–∞—Ä—Ç–∞</a>
      <a href="/export/">üì§ –ï–∫—Å–ø–æ—Ä—Ç</a>
      <!-- –Ü–º–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —É –∑–∞–≥–∞–ª—å–Ω–æ–º—É –º–µ–Ω—é: –ø–µ—Ä–µ—Ö–æ–¥—å—Ç–µ —á–µ—Ä–µ–∑ "–ê–¥–º—ñ–Ω —Å—Ç–æ—Ä—ñ–Ω–∫–∏" –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π -->
    </nav>
    <div class="authbar">
      <span id="authInfo">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</span>
      <span id="authRole" class="role-badge" style="display:none;"></span>
      <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
      <span id="statusTop" class="pill">–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è‚Ä¶</span>
    </div>
  </header>

  <div class="wrap">
    <h1>–Ü–º–ø–æ—Ä—Ç –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ ‚Üí Firestore <span class="pill"><b>collection:</b> <code>directory</code></span></h1>
    <div class="sub">–ü—Ä–∞—Ü—é—î –∑ CSV/TSV, –∫–æ–ø—ñ–ø–∞—Å—Ç–æ—é –∑ Excel —Ç–∞ –ø—Ä–æ—Å—Ç–∏–º–∏ –¥–≤–æ–∫–æ–ª–æ–Ω–∫–æ–≤–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏. –Ñ ‚Äú—Å—É—Ö–∏–π –∑–∞–ø—É—Å–∫‚Äù.</div>

    <div class="card">
      <b>–§–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö</b>
      <ul class="muted">
        <li>CSV —ñ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏: <i>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ, –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª, –ù–∞–∑–≤–∞, –ö–û–î</i></li>
        <li>–ö–æ–ø—ñ–ø–∞—Å—Ç–∞ –∑ Excel (—Ç–∞–±–∞–º–∏)</li>
        <li>–ü—Ä–æ—Å—Ç–∏–π CSV/TSV –∑ –¥–≤–æ–º–∞ –∫–æ–ª–æ–Ω–∫–∞–º–∏: <i>–ù–∞–∑–≤–∞, –ö–û–î</i></li>
      </ul>
      <div class="muted">–Ü–º–ø–æ—Ä—Ç–µ—Ä —à—É–∫–∞—î –∫–æ–ª–æ–Ω–∫–∏ ‚Äú–ù–∞–∑–≤–∞‚Äù, ‚Äú–ö–û–î‚Äù, ‚Äú–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ‚Äù, ‚Äú–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª‚Äù. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ ‚Äî –∑–∞–¥–∞–π —ñ–Ω–¥–µ–∫—Å–∏ –≤—Ä—É—á–Ω—É.</div>
    </div>

    <div class="grid two">
      <div class="card">
        <label>1) –ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)</label>
        <input type="file" id="file" accept=".csv,.tsv,.txt" />
        <div class="muted">–ê–±–æ –≤—Å—Ç–∞–≤ –¥–∞–Ω—ñ –Ω–∏–∂—á–µ</div>
        <div style="margin-top:8px">
          <button class="btn ghost" id="demoBtn">–í—Å—Ç–∞–≤–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label>–†–æ–∑–¥—ñ–ª—é–≤–∞—á</label><br/>
            <select id="sep">
              <option value="auto">–ê–≤—Ç–æ</option>
              <option value=",">–ö–æ–º–∞ (,)</option>
              <option value=";">–ö—Ä–∞–ø–∫–∞ –∑ –∫–æ–º–æ—é (;)</option>
              <option value="\t">–¢–∞–±</option>
            </select>
          </div>
          <div>
            <label>–ö–æ–¥—É–≤–∞–Ω–Ω—è</label><br/>
            <select id="enc">
              <option value="utf-8">UTF-8</option>
              <option value="windows-1251">Windows-1251</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>2) –í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç (CSV/TSV/Excel):</label>
      <textarea id="raw" placeholder="–í—Å—Ç–∞–≤ —Å—é–¥–∏ –¥–∞–Ω—ñ‚Ä¶"></textarea>
    </div>

    <div class="card">
      <label>3) –ú–∞–ø—ñ–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ (—è–∫—â–æ –∞–≤—Ç–æ-–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–µ —Å–ø—Ä–∞—Ü—é—î):</label>
      <div class="row" style="margin-top:6px">
        <span>‚Äú–ù–∞–∑–≤–∞‚Äù:</span><input id="nameCol" type="number" min="0" style="width:90px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span>‚Äú–ö–û–î‚Äù:</span><input id="codeCol" type="number" min="0" style="width:90px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span>‚Äú–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ‚Äù:</span><input id="companyCol" type="number" min="0" style="width:110px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span>‚Äú–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª‚Äù:</span><input id="unitCol" type="number" min="0" style="width:100px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
		<span>‚Äú–•–ê–ë‚Äù:</span><input id="hubCol"  type="number" min="0" style="width:100px" placeholder="—ñ–Ω–¥–µ–∫—Å" />
        <span class="muted">(—Ä–∞—Ö—É–Ω–æ–∫ –∑ 0; –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äì –æ–∫—Ä–µ–º–æ)</span>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input type="checkbox" id="hasHeader" checked /> –ü–µ—Ä—à–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏</label>
        <label><input type="checkbox" id="dryRun" checked /> ‚Äú–°—É—Ö–∏–π‚Äù –∑–∞–ø—É—Å–∫ (–±–µ–∑ –∑–∞–ø–∏—Å—É)</label>
        <label><input type="checkbox" id="mergeDup" /> –ó–ª–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –∑–∞ –Ω–∞–∑–≤–æ—é (–≤–∏–¥–∞–ª–∏—Ç–∏ legacy)</label>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn ghost" id="parseBtn">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–∞–Ω—ñ</button>
      <button class="btn primary" id="importBtn" disabled>–Ü–º–ø–æ—Ä—Ç —É Firestore</button>
      <button class="btn warn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è</button>
    </div>

    <div class="progress-wrap">
      <progress id="prog" value="0" max="100"></progress>
      <span id="progLabel" class="muted">–ì–æ—Ç–æ–≤–æ</span>
    </div>

    <div id="status" class="counter"></div>
    <pre id="log"></pre>
  </div>

  <!-- ===== –û–¥–∏–Ω –∑–∞–ø–∏—Å —É –¥–æ–≤—ñ–¥–Ω–∏–∫ (—Ä—É—á–Ω–∏–π —Ä–µ–∂–∏–º) ===== -->
  <div class="wrap">
    <div class="card">
      <b>–î–æ–¥–∞—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –æ–¥–∏–Ω–æ—á–Ω–∏–π –∑–∞–ø–∏—Å —É –¥–æ–≤—ñ–¥–Ω–∏–∫</b>
      <div class="sub">–ö–ª—é—á —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ: –ù–∞–∑–≤–∞ + –ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ + –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª + –•–ê–ë. –Ø–∫—â–æ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –ª–∏—à–µ –ö–û–î ‚Äî –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è; —è–∫—â–æ –≤—Å–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è.</div>
      <div class="grid two">
        <div>
          <label>–ù–∞–∑–≤–∞</label>
          <input id="singleName" placeholder="–ù–∞–ø—Ä.: –ï–ª–µ–≤–∞—Ç–æ—Ä –ê" style="width:100%" />
        </div>
        <div>
          <label>–ö–û–î (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</label>
          <input id="singleCode" placeholder="–ù–∞–ø—Ä.: ELV01" style="width:100%" />
        </div>
        <div>
          <label>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ</label>
          <input id="singleCompany" placeholder="–ö–æ–º–ø–∞–Ω—ñ—è" style="width:100%" />
        </div>
        <div>
          <label>–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª</label>
          <input id="singleUnit" placeholder="–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª" style="width:100%" />
        </div>
        <div>
          <label>–•–ê–ë</label>
          <input id="singleHub" placeholder="–ù–∞–ø—Ä.: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π" style="width:100%" />
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="btnAddSingle" class="btn primary">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å</button>
        <span id="singleStatus" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- Modal: –ü—ñ–¥—Å—É–º–æ–∫ —ñ–º–ø–æ—Ä—Ç—É -->
  <div id="summaryBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <div class="modal">
      <header>
        <h3 id="summaryTitle">–ü—ñ–¥—Å—É–º–æ–∫ —ñ–º–ø–æ—Ä—Ç—É</h3>
        <div class="toolbar">
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="btnSummaryCSV" class="btn ghost">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
            <button id="btnSummaryJSON" class="btn ghost">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button>
          </div>
          <button id="btnSummaryClose" class="btn">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </header>
      <div class="content">
        <div class="tabs">
          <div class="tab active" data-tab="overview">–ü—ñ–¥—Å—É–º–æ–∫</div>
          <div class="tab" data-tab="new">–°—Ç–≤–æ—Ä–µ–Ω—ñ</div>
          <div class="tab" data-tab="updated">–û–Ω–æ–≤–ª–µ–Ω—ñ</div>
          <div class="tab" data-tab="unchanged">–ë–µ–∑ –∑–º—ñ–Ω</div>
          <div class="tab" data-tab="other">–Ü–Ω—à–µ</div>
        </div>
        <div id="tab-overview"></div>
        <div id="tab-new" style="display:none"></div>
        <div id="tab-updated" style="display:none"></div>
        <div id="tab-unchanged" style="display:none"></div>
        <div id="tab-other" style="display:none"></div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  'use strict';

  const $ = (id) => document.getElementById(id);
  function log(msg, type=''){
    const el = $('log');
    el.textContent += (type ? '['+type+'] ' : '') + msg + '\n';
    el.scrollTop = el.scrollHeight;
  }
  function setStatus(html){ $('status').innerHTML = html; }
  function setProg(pct, label){
    $('prog').value = Math.max(0, Math.min(100, Math.round(pct)));
    $('progLabel').textContent = label || '';
  }

  // ===== Summary helpers =====
  const SUMMARY_LIMIT = 200; // –ø–æ–∫–∞–∑—É—î–º–æ —É —Ç–∞–±–ª–∏—Ü—ñ –º–∞–∫—Å–∏–º—É–º N –∑–∞–ø–∏—Å—ñ–≤ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
  const LastSummary = { data:null }; // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è/–µ–∫—Å–ø–æ—Ä—Ç—É

  function toCSV(rows){
    if (!rows || !rows.length) return '';
    const headers = Object.keys(rows[0]);
    const escape = (v) => {
      const s = (v==null?'' : String(v));
      return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
    };
    const lines = [headers.join(',')];
    for (const r of rows){ lines.push(headers.map(h => escape(r[h])).join(',')); }
    return lines.join('\n');
  }

  function renderTable(rows, title){
    if (!rows || !rows.length) return `<div class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>`;
    const shown = rows.slice(0, SUMMARY_LIMIT);
    const more = rows.length - shown.length;
    const headers = Object.keys(shown[0]);
    const th = headers.map(h=>`<th>${h}</th>`).join('');
    const tr = shown.map(r=>`<tr>${headers.map(h=>`<td>${(r[h]==null?'':String(r[h]))}</td>`).join('')}</tr>`).join('');
    const note = more>0? `<div class="muted" style="margin-top:6px">–ü–æ–∫–∞–∑–∞–Ω–æ ${shown.length} –∑ ${rows.length}. –î–ª—è –ø–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É ‚Äî –µ–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ CSV/JSON.</div>` : '';
    return `
      <div class="muted" style="margin-bottom:6px">${title||''}</div>
      <table class="summary"><thead><tr>${th}</tr></thead><tbody>${tr}</tbody></table>
      ${note}
    `;
  }

  function showImportSummary(summary){
    LastSummary.data = summary;
    const bd = $('summaryBackdrop');
    const tabs = Array.from(document.querySelectorAll('.tabs .tab'));
    function activate(name){
      tabs.forEach(t=>{ t.classList.toggle('active', t.dataset.tab===name); });
      ['overview','new','updated','unchanged','other'].forEach(id=>{
        const el = $('tab-'+id);
        if (el) el.style.display = (id===name)? '' : 'none';
      });
    }
    // Overview content
    const o = summary;
    const overviewHTML = `
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <span class="badge b-new">–°—Ç–≤–æ—Ä–µ–Ω–æ: ${o.new.length}</span>
        <span class="badge b-upd">–û–Ω–æ–≤–ª–µ–Ω–æ: ${o.updated.length}</span>
        <span class="badge b-same">–ë–µ–∑ –∑–º—ñ–Ω: ${o.unchanged.length}</span>
        ${o.deleted?.length? `<span class="badge">–í–∏–¥–∞–ª–µ–Ω–æ legacy: ${o.deleted.length}</span>`:''}
      </div>
      <div class="muted" style="margin-top:8px">Dry-run: ${o.dry? '—Ç–∞–∫' : '–Ω—ñ'}</div>
    `;
    $('tab-overview').innerHTML = overviewHTML;
    $('tab-new').innerHTML = renderTable(o.new, '–°—Ç–≤–æ—Ä–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏');
    $('tab-updated').innerHTML = renderTable(o.updated, '–û–Ω–æ–≤–ª–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏');
    $('tab-unchanged').innerHTML = renderTable(o.unchanged, '–ë–µ–∑ –∑–º—ñ–Ω');
    $('tab-other').innerHTML = renderTable(o.other||[], '–Ü–Ω—à–µ');

    activate('overview');
    bd.style.display = 'flex';
  }

  function exportSummaryCSV(){
    const s = LastSummary.data; if (!s) return;
    const rows = [
      ...s.new.map(x=>({action:'new',...x})),
      ...s.updated.map(x=>({action:'updated',...x})),
      ...s.unchanged.map(x=>({action:'unchanged',...x})),
      ...(s.deleted||[]).map(x=>({action:'deleted-legacy',...x})),
      ...(s.other||[]).map(x=>({action:'other',...x}))
    ];
    const csv = toCSV(rows);
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `directory-import-summary-${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function copySummaryJSON(){
    const s = LastSummary.data; if (!s) return;
    const txt = JSON.stringify(s, null, 2);
    navigator.clipboard?.writeText(txt).then(()=>{
      setStatus('<span class="ok">JSON —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É</span>');
    }).catch(()=>{
      // fallback
      const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      setStatus('<span class="ok">JSON —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ (fallback)</span>');
    });
  }

  // ----- AUTH / FIREBASE -----
  const statusTop = $('statusTop');
  const authInfo = $('authInfo');
  const authRoleBadge = $('authRole');
  const btnLogout = $('btnLogout');
  const importBtn = $('importBtn');

  let db = null, auth = null, currentUser = null, currentRole = 'pending';
const WRITE_ROLES = new Set(['admin']);
const NORM = r => String(r || 'pending').trim().toLowerCase();

async function resolveUserRole(uid){
  // —á–∏—Ç–∞—î–º–æ users/{uid} –∑—ñ —Å–µ—Ä–≤–µ—Ä–∞ –∑ fallback –Ω–∞ roles/{uid}
  try{
    const us = await db.collection('users').doc(uid).get({ source: 'server' });
    if (us.exists && us.data()?.role) return NORM(us.data().role);
  }catch{}
  try{
    const rs = await db.collection('roles').doc(uid).get({ source: 'server' });
    if (rs.exists && rs.data()?.role) return NORM(rs.data().role);
  }catch{}
  return 'pending';
}

  // Firebase –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —É head-guard
  try{
    db = firebase.firestore();
    auth = firebase.auth();
    statusTop.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
    db.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
  }catch(e){
    console.error(e);
    statusTop.textContent = '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó';
  }

  function updateImportButton(){
    const dry = $('dryRun').checked;
    if (dry) {
      importBtn.disabled = false;
      importBtn.title = 'Dry-run (–±–µ–∑ –∑–∞–ø–∏—Å—É)';
    } else {
  const canWrite = currentUser && WRITE_ROLES.has(currentRole);
  importBtn.disabled = !canWrite;
  importBtn.title = canWrite ? '' : '–ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin';
    }
  }
  $('dryRun').addEventListener('change', updateImportButton);
  $('mergeDup').addEventListener('change', updateImportButton);

  btnLogout.addEventListener('click', async () => {
    try{ await auth.signOut(); }catch(e){ console.warn(e); }
  });

  let roleUnsub = null;

auth?.onAuthStateChanged(async (u) => {
  currentUser = u || null;
  if (!u){
    const next = encodeURIComponent(location.pathname + location.search);
    location.replace(`/login.html?next=${next}`);
    return;
  }

  // 1) —à–≤–∏–¥–∫–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –∑ head-guard (—è–∫—â–æ –≤–∂–µ —î)
  let role = window.__userRole ? NORM(window.__userRole) : null;
  // 2) –Ω–∞–¥—ñ–π–Ω–æ –¥–æ—á–∏—Ç—É—î–º–æ –∑ Firestore (—É—Å—É–≤–∞—î –≥–æ–Ω–∫—É)
  if (!role || role === 'pending') role = await resolveUserRole(u.uid);

  currentRole = role;
  window.__userRole = role; // —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –¥–ª—è —ñ–Ω—à–∏—Ö —Å–∫—Ä–∏–ø—Ç—ñ–≤

  authInfo.textContent = `–£–≤—ñ–π—à–ª–∏ —è–∫ ${u.email || u.uid}`;
  btnLogout.style.display = '';
  authRoleBadge.textContent = `–†–æ–ª—å: ${currentRole}`;
  authRoleBadge.style.display = '';
  statusTop.textContent = '–ì–æ—Ç–æ–≤–æ';
  updateImportButton();

  // 3) live-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ
  roleUnsub?.();
  roleUnsub = db.collection('users').doc(u.uid)
    .onSnapshot({ includeMetadataChanges:true }, async (doc) => {
      let r = doc.exists ? NORM(doc.data().role) : 'pending';
      if (r === 'pending') {
        // fallback –Ω–∞ roles, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        try{
          const rs = await db.collection('roles').doc(u.uid).get({ source:'server' });
          if (rs.exists && rs.data()?.role) r = NORM(rs.data().role);
        }catch{}
      }
      currentRole = r;
      window.__userRole = r;
      authRoleBadge.textContent = `–†–æ–ª—å: ${r}`;
      updateImportButton();
    });
});

  // –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞—á –ø–æ–º–∏–ª–æ–∫ ‚Üí —É –ª–æ–≥
  window.addEventListener('error', (e) => {
    log(`${e.message} @ ${e.filename||''}:${e.lineno||''}`, 'err');
  });

  const PREVIEW_ROWS = 5;
  const SAFE_BATCH = 450; // –Ω–∏–∂—á–µ 500 ‚Äî –ª—ñ–º—ñ—Ç –¥–ª—è writeBatch

  function initFirebaseWrite(){
    if (!db) { alert('Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.'); return null; }
    if (!currentUser) { alert('–°–ø–µ—Ä—à—É —É–≤—ñ–π–¥–∏.'); return null; }
  if (!WRITE_ROLES.has(currentRole)) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin.'); return null; }
    return db;
  }

  // –î–µ–º–æ
  $('demoBtn')?.addEventListener('click', () => {
    $('raw').value =
`–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ\t–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª\t–ù–∞–∑–≤–∞\t–ö–û–î
–ê–¢–ü\t–î—ñ–ª—å–Ω–∏—Ü—è 1\t–ï–ª–µ–≤–∞—Ç–æ—Ä –ê\tELV01
–ê–¢–ü\t–î—ñ–ª—å–Ω–∏—Ü—è 2\t–ï–ª–µ–≤–∞—Ç–æ—Ä –ë\tELV02
–¢–∞—Ä–Ω–∏–π\t–ó–º—ñ–Ω–∞ 3\t–ü–æ–ª–µ-1\tFLD11`;
    setStatus('<span class="muted">–î–µ–º–æ-–¥–∞–Ω—ñ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ</span>');
    $('raw').focus();
  });

  // –ß–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É –∑ –∫–æ–¥—É–≤–∞–Ω–Ω—è–º
  $('file').addEventListener('change', async (e) => {
    try{
      const file = e.target.files[0];
      if (!file) return;
      const enc = $('enc').value || 'utf-8';
      const buf = await file.arrayBuffer();
      let text;
      try { text = new TextDecoder(enc).decode(buf); }
      catch { text = new TextDecoder('utf-8').decode(buf); }
      $('raw').value = text;
      setStatus(`<span class="muted">–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${file.name} (${enc})</span>`);
    }catch(err){
      log('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É: ' + (err?.message||err), 'err');
    }
  });

  // –ü–∞—Ä—Å–∏–Ω–≥
  function detectSep(text){
    const s = $('sep').value;
    if (s !== 'auto') return s === '\\t' ? '\t' : s;
    const firstLine = text.split(/\r?\n/).find(l => l.trim().length);
    if (!firstLine) return ',';
    const counts = { ',': (firstLine.match(/,/g)||[]).length,
                     ';': (firstLine.match(/;/g)||[]).length,
                     '\t': (firstLine.match(/\t/g)||[]).length };
    return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ',';
  }
  function parseTable(text){
    const sep = detectSep(text);
    const rows = text.split(/\r?\n/).filter(r=>r.trim().length);
    const table = rows.map(r => r.split(sep));
    return { sep, rows, table };
  }

  function guessColumns(headerRow){
    const h = headerRow.map(x => (x||'').toString().trim().toLowerCase());
    const nameIdx = h.findIndex(x => ['–Ω–∞–∑–≤–∞','name'].includes(x));
    const codeIdx = h.findIndex(x => ['–∫–æ–¥','–∫–æ–¥ —Ü–±','–∫–æ–¥ —Ü–±','code'].includes(x));
    const companyIdx = h.findIndex(x => ['–ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ','pidpryiemstvo','company'].includes(x));
    const unitIdx = h.findIndex(x => ['–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª','pidrozdil','unit','division'].includes(x));
    const hubIdx = h.findIndex(x => ['—Ö–∞–±','hub'].includes(x));
	return {
	nameIdx: nameIdx>=0?nameIdx:null,
	codeIdx: codeIdx>=0?codeIdx:null,
	companyIdx: companyIdx>=0?companyIdx:null,
	unitIdx: unitIdx>=0?unitIdx:null,
	hubIdx: hubIdx>=0?hubIdx:null
	};
  }

  function sanitizeId(s){
    return (s||'').toString().trim().replace(/[\/\\#?[\]]/g, '_').slice(0, 500);
  }

  // ‚Üì‚Üì‚Üì –¥–æ–¥–∞—Ç–∏ –≤–∏—â–µ –∑–∞ prepareEntries
function toUkLower(s){
  const t = (s ?? '').toString().trim();
  try { return t.toLocaleLowerCase('uk-UA'); } catch { return t.toLowerCase(); }
}
// —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —Ç—Ä–∏“ë—Ä–∞–º–∏ (–¥–ª—è –ø–æ—à—É–∫—É "–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ" —Ä—è–¥–∫–∞)
function makeNGrams(s, n = 3){
  const src = toUkLower(s)
    .replace(/\s+/g, ' ')
    .replace(/[^\p{L}\p{N}\s]/gu, ''); // –ª–∏—à–µ –ª—ñ—Ç–µ—Ä–∏/—Ü–∏—Ñ—Ä–∏/–ø—Ä–æ–±—ñ–ª–∏
  const grams = new Set();
  for (let i = 0; i <= src.length - n; i++){
    grams.add(src.slice(i, i + n));
  }
  return Array.from(grams);
}

  // –°—Ç–∞–±—ñ–ª—å–Ω–∏–π –∫–ª—é—á –∑–∞ –ù–ê–ó–í–û–Æ (–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—é)
  function makeNameId(name){
    const base = toUkLower(name).replace(/\s+/g, ' ').trim();
    return sanitizeId(base);
  }

  // –ù–æ–≤–∏–π —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è directory: –ù–∞–∑–≤–∞ + –ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ + –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª + –•–ê–ë
  function makeDirectoryId(name, company, unit, hub){
    const norm = (v) => {
      const t = toUkLower(v||'').replace(/\s+/g,' ').trim();
      return t || '‚àÖ'; // –ø–æ–∑–Ω–∞—á–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ —â–æ–± –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏ –≤—ñ–¥ —Ä–µ–∞–ª—å–Ω–æ –ø—É—Å—Ç–∏—Ö
    };
    const parts = [norm(name), norm(company), norm(unit), norm(hub)];
    return sanitizeId(parts.join('__'));
  }

  // === –†—É—á–Ω–∏–π –æ–¥–∏–Ω–æ—á–Ω–∏–π –∑–∞–ø–∏—Å ===
  async function addSingleDirectoryEntry(){
    try{
      if (!db) { alert('Firestore –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'); return; }
      if (!currentUser) { alert('–°–ø–µ—Ä—à—É —É–≤—ñ–π–¥—ñ—Ç—å'); return; }
  if (!WRITE_ROLES.has(currentRole)) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ (–ø–æ—Ç—Ä—ñ–±–Ω–æ: admin)'); return; }
      const name    = $('singleName').value.trim();
      const codeIn  = $('singleCode').value.trim();
      const company = $('singleCompany').value.trim();
      const unit    = $('singleUnit').value.trim();
      const hub     = $('singleHub').value.trim();
      if (!name){ alert('–ü–æ–ª–µ "–ù–∞–∑–≤–∞" –æ–±–æ–≤ º—è–∑–∫–æ–≤–µ'); return; }
      const legacyNameId = makeNameId(name); // —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç (—Ç—ñ–ª—å–∫–∏ –Ω–∞–∑–≤–∞)
      const compositeId = makeDirectoryId(name, company, unit, hub); // –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç
      const ref = db.collection('directory').doc(compositeId);
      let snap = await ref.get();

      // –Ø–∫—â–æ –Ω–æ–≤–æ–≥–æ —â–µ –Ω–µ–º–∞—î ‚Äì –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —á–∏ —ñ—Å–Ω—É—î legacy-–¥–æ–∫ —ñ–∑ —Ç–∏–º —Å–∞–º–∏–º –Ω–∞–±–æ—Ä–æ–º –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
      let legacySnap = null;
      if (!snap.exists){
        const legacyRef = db.collection('directory').doc(legacyNameId);
        const ls = await legacyRef.get();
        if (ls.exists){
          const ldata = ls.data()||{};
            if ((ldata.company||'') === company && (ldata.unit||'') === unit && (ldata.hub||'') === hub) {
              // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ legacy —è–∫ —Ü—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–Ω–µ –º—ñ–≥—Ä—É—î–º–æ —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é—é—á–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π —Ç—É—Ç)
              snap = ls; // –¥—ñ—î–º–æ —è–∫ –Ω—ñ–±–∏ —Ü–µ –Ω–∞—à doc
            } else {
              legacySnap = ls; // –∑–∞–ª–∏—à–∞—î–º–æ —è–∫ –æ–∫—Ä–µ–º–∏–π (—ñ–Ω—à–∞ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è ‚Üí –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π)
            }
        }
      }

      const newData = {
        name,
        nameLower: toUkLower(name),
        nameNgrams: makeNGrams(name),
        ...(company && { company }),
        ...(unit && { unit }),
        ...(hub && { hub }),
        ...(codeIn && { code: codeIn })
      };

      const statusEl = $('singleStatus');
      function setMsg(html){ statusEl.innerHTML = html; }

      if (!snap.exists){
        // –∂–æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –∑ —Ç–∞–∫–æ—é –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—î—é ‚Äì —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —ñ—Å–Ω—É—é—Ç—å —ñ–Ω—à—ñ –∑ —Ç—ñ—î—é –∂ –Ω–∞–∑–≤–æ—é)
        await ref.set(newData, { merge:true });
        setMsg(`<span class='ok'>–°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å (–Ω–æ–≤–µ –ø–æ—î–¥–Ω–∞–Ω–Ω—è –∞—Ç—Ä–∏–±—É—Ç—ñ–≤)</span>`);
        log(`(single) NEW COMBO name="${name}" id=${compositeId} data=${JSON.stringify(newData)}`,'ok');
        showImportSummary({ new: [{ id: compositeId, name, code: newData.code||'', company: company||'', unit: unit||'', hub: hub||'' }], updated: [], unchanged: [], deleted: [], other: [], dry: false });
        return;
      }

      const old = snap.data() || {};
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ –∑–∞ —á–æ—Ç–∏—Ä–º–∞ –ø–æ–ª—è–º–∏ (company, unit, hub, name)
  const sameKey = (toUkLower(old.name||'') === toUkLower(name)) &&
          ((old.company||'') === company) &&
          ((old.unit||'') === unit) &&
          ((old.hub||'') === hub);

      if (sameKey){
        const oldCode = old.code || '';
        // —è–∫—â–æ –∫–æ–¥ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è —ñ –≤–≤–µ–¥–µ–Ω–æ –Ω–æ–≤–∏–π ‚Üí –æ–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –∫–æ–¥
        if (codeIn && codeIn !== oldCode){
          await ref.set({ code: codeIn }, { merge:true });
          setMsg(`<span class='ok'>–û–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–¥ –¥–ª—è ¬´${name}¬ª: ${oldCode||'‚Äî'} ‚Üí ${codeIn}</span>`);
          log(`(single) UPDATE CODE name="${name}" ${oldCode||'‚Äî'} ‚Üí ${codeIn}`,'warn');
          showImportSummary({ new: [], updated: [{ id: ref.id, name, codeOld: oldCode||'', codeNew: codeIn||'', company: company||'', unit: unit||'', hub: hub||'', changed: 'code' }], unchanged: [], deleted: [], other: [], dry: false });
        } else {
          setMsg(`<span class='muted'>–ë–µ–∑ –∑–º—ñ–Ω ‚Äî –∑–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î</span>`);
          log(`(single) SKIP (no change) name="${name}"`,'ok');
          showImportSummary({ new: [], updated: [], unchanged: [{ id: ref.id, name, code: oldCode||'', company: company||'', unit: unit||'', hub: hub||'' }], deleted: [], other: [], dry: false });
        }
        return;
      }

      // –¢—É—Ç –º–∏ –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ —ñ–Ω—à–∏–π –Ω–∞–±—ñ—Ä –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ —Ç–∏–º —Å–∞–º–∏–º id ‚Äì –∑–∞ –Ω–æ–≤–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Ü–µ –º–∞—î –±—É—Ç–∏ –æ–∫—Ä–µ–º–∏–π –¥–æ–∫—É–º–µ–Ω—Ç.
      // –ê–ª–µ —è–∫—â–æ –º–∏ —Å—é–¥–∏ –ø–æ—Ç—Ä–∞–ø–∏–ª–∏, snap —É–∂–µ —ñ—Å–Ω—É—î (sameKey=false) —ñ —Ü–µ –æ–∑–Ω–∞—á–∞—î: –Ω–∞–∑–≤–∞ —Ç–∞ id (composite) –Ω–µ —É–∑–≥–æ–¥–∂–µ–Ω—ñ.
      // –ù–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ —Ü—å–æ–≥–æ –ù–ï –º–∞—î —Å—Ç–∞—Ç–∏—Å—å (–±–æ composite –≤–∫–ª—é—á–∞—î –∞—Ç—Ä–∏–±—É—Ç–∏). –Ø–∫—â–æ —Ç—Ä–∞–ø–∏—Ç—å—Å—è ‚Äì –ª–æ–≥ —ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑ –∑–º—ñ–Ω–∏ –∫–ª—é—á–∞.
      if (!codeIn && old.code){ newData.code = old.code; }
      await ref.set(newData, { merge:true });
      setMsg(`<span class='ok'>–û–Ω–æ–≤–ª–µ–Ω–æ (–≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ —ñ—Å–Ω—É—é—á–∏–º –∑–∞–ø–∏—Å–æ–º)</span>`);
      log(`(single) ALIGN UPDATE name="${name}" id=${compositeId} data=${JSON.stringify(newData)}`,'warn');
      showImportSummary({ new: [], updated: [{ id: ref.id, name, codeOld: old.code||'', codeNew: newData.code||'', company: company||'', unit: unit||'', hub: hub||'', changed: 'attrs|code?' }], unchanged: [], deleted: [], other: [], dry: false });
    }catch(e){
      $('singleStatus').innerHTML = `<span class='err'>–ü–æ–º–∏–ª–∫–∞: ${e.message||e}</span>`;
      log(`(single) ERROR: ${e.message||e}`,'err');
    }
  }

  // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ entries
  function prepareEntries(){
    const raw = $('raw').value;
    if (!raw.trim()){ alert('–ü–æ—Ä–æ–∂–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É'); return null; }
    const parsed = parseTable(raw);
    const hasHeader = $('hasHeader').checked;

    let rows = parsed.table, startIdx = 0;
    let nameIdx = $('nameCol').value ? parseInt($('nameCol').value,10) : null;
	let codeIdx = $('codeCol').value ? parseInt($('codeCol').value,10) : null;
	let companyIdx = $('companyCol').value ? parseInt($('companyCol').value,10) : null;
	let unitIdx = $('unitCol').value ? parseInt($('unitCol').value,10) : null;
	let hubIdx = $('hubCol').value ? parseInt($('hubCol').value,10) : null;

    if (hasHeader && rows.length){
      const g = guessColumns(rows[0]);
      if (nameIdx === null) nameIdx = g.nameIdx;
      if (codeIdx === null) codeIdx = g.codeIdx;
      if (companyIdx === null) companyIdx = g.companyIdx;
      if (unitIdx === null) unitIdx = g.unitIdx;
	  if (hubIdx === null) hubIdx = g.hubIdx;
      startIdx = 1;
      setStatus(`<span class="muted">–í–∏—è–≤–ª–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á: <b>${parsed.sep === '\t' ? 'TAB' : parsed.sep}</b>. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ.</span>`);
    }

    if (nameIdx === null || codeIdx === null){
      const cols = rows[0]?.length || 2;
      if (codeIdx === null) codeIdx = cols - 1;
      if (nameIdx === null) nameIdx = 0;
      setStatus(`<span class="muted">–í–∏—è–≤–ª–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á: <b>${parsed.sep === '\t' ? 'TAB' : parsed.sep}</b>. –ú–∞–ø—ñ–Ω–≥ –ø—ñ–¥—ñ–±—Ä–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.</span>`);
    }

    const entries = [];
    let skippedEmptyName = 0, skippedEmptyCode = 0, skippedBlankRow = 0;

    // –ù–∞–∑–≤–∞ ‚Üí –º–Ω–æ–∂–∏–Ω–∞ –∫–æ–¥—ñ–≤ –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
    const nameToCodes = new Map();
    const nameToSample = new Map();

    for (let i = startIdx; i < rows.length; i++) {
      const r = rows[i];
      if (!r || !r.length || r.every(c => (c || '').toString().trim() === '')) { skippedBlankRow++; continue; }

      const name    = (r[nameIdx]   || '').toString().trim();
      const code    = (r[codeIdx]   || '').toString().trim();
      const company = companyIdx != null ? (r[companyIdx] || '').toString().trim() : '';
      const unit    = unitIdx    != null ? (r[unitIdx]    || '').toString().trim() : '';
      const hub     = hubIdx     != null ? (r[hubIdx]     || '').toString().trim() : '';

      if (!name && !code) { skippedBlankRow++; continue; }
      if (!name) { skippedEmptyName++; continue; }
      if (!code) { skippedEmptyCode++; continue; }

  const idByName = makeNameId(name); // –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å –ø–æ –∫–æ–¥–∞—Ö
  const id = makeDirectoryId(name, company, unit, hub); // –Ω–æ–≤–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á

      if (!nameToCodes.has(idByName)) nameToCodes.set(idByName, new Set());
      nameToCodes.get(idByName).add(code);
      if (!nameToSample.has(idByName)) nameToSample.set(idByName, name);

      entries.push({
        id,
        legacyId: idByName,
        data: {
          name,
          code,
          ...(company && { company }),
          ...(unit    && { unit }),
          ...(hub     && { hub }),
          nameLower: toUkLower(name),
          nameNgrams: makeNGrams(name)
        }
      });
    }

    // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –æ–¥–Ω–∞–∫–æ–≤—ñ –Ω–∞–∑–≤–∏ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –∫–æ–¥–∞–º–∏
    const dupWarnings = [];
    for (const [id, set] of nameToCodes.entries()){
      const arr = Array.from(set);
      if (arr.length > 1) dupWarnings.push({ nameId:id, name:nameToSample.get(id)||id, codes:arr });
    }
    window.DUP_WARNINGS = dupWarnings;
    if (dupWarnings.length){
      log(`–ó–Ω–∞–π–¥–µ–Ω–æ ${dupWarnings.length} –≥—Ä—É–ø(–∏) –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é —Ç–∞ —Ä—ñ–∑–Ω–∏–º–∏ –∫–æ–¥–∞–º–∏ ‚Äî –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—è–¥–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ—ó –Ω–∞–∑–≤–∏.`, 'warn');
      dupWarnings.slice(0,10).forEach(w => log(`  ‚Ä¢ "${w.name}" ‚Üí –∫–æ–¥–∏: ${w.codes.join(', ')}`, 'warn'));
      if (dupWarnings.length>10) log(`  ‚Ä¶ —â–µ ${dupWarnings.length-10} –≥—Ä—É–ø(–∏)`, 'warn');
    }

  // –î–µ–¥—É–ø —Ç–µ–ø–µ—Ä –∑–∞ –ø–æ–≤–Ω–∏–º composite id (–ø–æ–≤—Ç–æ—Ä–Ω—ñ —Ä—è–¥–∫–∏ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—î—é)
  const map = new Map();
  for (const e of entries) map.set(e.id, e);
  const deduped = Array.from(map.values());

  log(`–ó–Ω–∞–π–¥–µ–Ω–æ —Ä—è–¥–∫—ñ–≤: ${entries.length}. –ü—ñ—Å–ª—è –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó (–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è): ${deduped.length}`, 'ok');
    log(`–ü—Ä–æ–ø—É—â–µ–Ω–æ ‚Üí blank:${skippedBlankRow} | emptyName:${skippedEmptyName} | emptyCode:${skippedEmptyCode}`, 'ok');

    return deduped;
  }

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
  $('parseBtn').addEventListener('click', () => {
    const entries = prepareEntries();
    if (!entries) return;
    setStatus(`<b>–ì–æ—Ç–æ–≤–æ –¥–æ —ñ–º–ø–æ—Ä—Ç—É:</b> ${entries.length}`);
    log('–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–µ—Ä—à–∏—Ö 5:', 'ok');
    entries.slice(0,5).forEach(e => log(`id="${e.id}"  data=${JSON.stringify(e.data)}`));
  });

  // –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –≤–∞–∂–ª–∏–≤–∏—Ö –ø–æ–ª—ñ–≤
// –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –≤–∞–∂–ª–∏–≤–∏—Ö –ø–æ–ª—ñ–≤
function normData(d){
  const name = (d?.name ?? '').toString();
  return {
    name,
    code:    d?.code ?? '',
    company: d?.company ?? '',
    unit:    d?.unit ?? '',
    hub:     d?.hub ?? '',
    nameLower: toUkLower(d?.nameLower ?? name)
  };
}

function equalData(a, b){
  return JSON.stringify(normData(a)) === JSON.stringify(normData(b));
}

  // –Ü–º–ø–æ—Ä—Ç
  $('importBtn').addEventListener('click', async () => {
    const entries = prepareEntries();
    if (!entries) return;

    if (Array.isArray(window.DUP_WARNINGS) && window.DUP_WARNINGS.length){
      const proceed = confirm(
        `–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: –∑–Ω–∞–π–¥–µ–Ω–æ ${window.DUP_WARNINGS.length} –≥—Ä—É–ø(–∏) –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é —Ç–∞ —Ä—ñ–∑–Ω–∏–º–∏ –∫–æ–¥–∞–º–∏.\n`+
        `–ö–ª—é—á–µ–º —ñ–º–ø–æ—Ä—Ç—É —î –ù–ê–ó–í–ê ‚Äî –¥–ª—è –∫–æ–∂–Ω–æ—ó –Ω–∞–∑–≤–∏ –∑–∞–ª–∏—à–∏—Ç—å—Å—è –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—è–¥–æ–∫ –∑ —Ñ–∞–π–ª—É.\n`+
        `–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —ñ–º–ø–æ—Ä—Ç?`
      );
      if (!proceed) return;
    }

    const dry = $('dryRun').checked;
    const mergeDup = $('mergeDup').checked;
    if (!dry){
      if (!initFirebaseWrite()) return;
    }

    $('importBtn').disabled = true;
    $('parseBtn').disabled = true;
    $('clearBtn').disabled = true;

  const total = entries.length;
  // Recap containers
  const recapNew = [];
  const recapUpdated = [];
  const recapUnchanged = [];
  const recapDeleted = [];
  const recapOther = [];
    const SAFE_BATCH = 450;
    const totalBatches = Math.ceil(total / SAFE_BATCH);
    let ok = 0, fail = 0;
    let newCount = 0, updatedCount = 0, unchangedCount = 0;

    const startedAt = Date.now();
    setProg(0, '–ü–æ—á–∞—Ç–æ–∫‚Ä¶');

    try{
      for (let b = 0; b < totalBatches; b++){
        const slice = entries.slice(b*SAFE_BATCH, (b+1)*SAFE_BATCH);

  // 1) —á–∏—Ç–∞—î–º–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –∑–∞ –Ω–æ–≤–æ—é —Å—Ö–µ–º–æ—é (id = nameId)
  const refsByComposite = slice.map(({id}) => db.collection('directory').doc(id));
  const snapsByComposite = await Promise.all(refsByComposite.map(r => r.get()));

        // 2) –¥–æ–¥–∞—Ç–∫–æ–≤–æ —à—É–∫–∞—î–º–æ –Ω–∞—è–≤–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –∑ —Ç–∞–∫–æ—é –∂ –Ω–∞–∑–≤–æ—é (legacy id=–∫–æ–¥)
        // Firestore –¥–æ–∑–≤–æ–ª—è—î where('field','in',[...]) –º–∞–∫—Å–∏–º—É–º –Ω–∞ 10 –∑–Ω–∞—á–µ–Ω—å ‚Üí —á–∞–Ω–∫—É—î–º–æ
        const nameLowerList = Array.from(new Set(slice.map(s => s.data.nameLower)));
        const byNameLower = new Map(); // nameLower -> Array<DocSnapshot>
        for (let i = 0; i < nameLowerList.length; i += 10){
          const chunk = nameLowerList.slice(i, i+10);
          try{
            const q = await db.collection('directory').where('nameLower','in',chunk).get();
            q.forEach(doc => {
              const nl = (doc.data()?.nameLower) || '';
              if (!byNameLower.has(nl)) byNameLower.set(nl, []);
              byNameLower.get(nl).push(doc);
            });
          }catch(e){
            // —è–∫—â–æ —ñ–Ω–¥–µ–∫—Å—ñ–≤ –Ω–µ–º–∞ –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —á–∞–Ω–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
          }
        }

        let writes = 0;
        let deletedThisBatch = 0;
        const batch = !dry ? db.batch() : null;

        for (let i = 0; i < slice.length; i++){
          const { id, data, legacyId } = slice[i];
          const snapByComposite = snapsByComposite[i];

          // –ü—ñ–¥–±–∏—Ä–∞—î–º–æ —Ü—ñ–ª—å–æ–≤–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è/–º—ñ–≥—Ä–∞—Ü—ñ—ó:
          //  - —è–∫—â–æ mergeDup = true ‚Üí –∫–∞–Ω–æ–Ω—ñ—á–Ω–∏–π id = nameId; —É—Å—ñ —ñ–Ω—à—ñ –∑ —Ç–∞–∫–æ—é nameLower –≤–≤–∞–∂–∞—é—Ç—å—Å—è legacy —ñ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ
          //  - —è–∫—â–æ mergeDup = false ‚Üí —è–∫ —Ä–∞–Ω—ñ—à–µ: –æ–Ω–æ–≤–ª—é—î–º–æ —ñ—Å–Ω—É—é—á–∏–π (id=nameId –∞–±–æ –±—É–¥—å-—è–∫–∏–π –∑ —Ç–∞–∫–æ—é nameLower), –±–µ–∑ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
          const candidates = byNameLower.get(data.nameLower) || [];
          let targetSnap = null, targetRef = null, targetId = id;

          if (mergeDup){
            // –ö–∞–Ω–æ–Ω—ñ—á–Ω–∏–π ‚Äî composite id
            targetRef = refsByComposite[i];
            targetSnap = snapByComposite;

            // –Ü–Ω—à—ñ –∑ —Ç—ñ—î—é –∂ nameLower, –∞–ª–µ –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —ó—Ö company/unit/hub –∑–±—ñ–≥–∞—é—Ç—å—Å—è ‚Üí legacy –¥—É–±–ª—ñ–∫–∞—Ç–∏ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
            const others = candidates.filter(d => d.id !== id).filter(d => {
              const od = d.data()||{};
              return (od.company||'') === (data.company||'') && (od.unit||'') === (data.unit||'') && (od.hub||'') === (data.hub||'');
            });

            if (!snapByComposite.exists && candidates.length){
              const primary = others[0];
              if (primary){
                const old = primary.data() || {};
                const extras = {};
                if (old.company && !data.company) extras.company = old.company;
                if (old.unit    && !data.unit)    extras.unit    = old.unit;
                if (old.hub     && !data.hub)     extras.hub     = old.hub;
                Object.assign(data, extras);
                log(`‚Üª –ú—ñ–≥—Ä–∞—Ü—ñ—è (–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è) ¬´${data.name}¬ª: legacy id=${primary.id} ‚Üí id=${id}`, 'warn');
              }
            }

            if (others.length){
              for (const d of others){
                (dry ? recapDeleted : recapDeleted).push({ id:d.id, name:data.name, company:data.company||'', unit:data.unit||'', hub:data.hub||'', reason:'legacy-duplicate' });
                if (!dry){ batch.delete(db.collection('directory').doc(d.id)); writes++; deletedThisBatch++; }
              }
              if (dry){
                log(`(dry-run) –ë—É–ª–æ –± –≤–∏–¥–∞–ª–µ–Ω–æ legacy –¥—É–±–ª—ñ–∫–∞—Ç–∏ (–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è) –¥–ª—è ¬´${data.name}¬ª: ${others.map(o=>o.id).join(', ')}`,'warn');
              }
            }
          } else {
            // –ë–µ–∑–ø–µ—á–Ω–∏–π —Ä–µ–∂–∏–º ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ –ª–∏—à–µ —è–∫—â–æ composite —ñ—Å–Ω—É—î; —ñ–Ω–∞–∫—à–µ —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π, –Ω–µ —á—ñ–ø–∞—é—á–∏ —ñ–Ω—à—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó —Ü—ñ—î—ó –∂ –Ω–∞–∑–≤–∏
            if (snapByComposite.exists){
              targetSnap = snapByComposite; targetRef = refsByComposite[i]; targetId = id;
            } else {
              // —à—É–∫–∞—î–º–æ —á–∏ —î legacy-–¥–æ–∫ –¢–Ü–Ñ–á –ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó ‚Üí —Ç–æ–¥—ñ –æ–Ω–æ–≤–∏–º–æ –π–æ–≥–æ, —ñ–Ω–∞–∫—à–µ —Å—Ç–≤–æ—Ä–∏–º–æ –Ω–æ–≤–∏–π
              const sameComboLegacy = candidates.find(d => {
                const od = d.data()||{};
                return (od.company||'') === (data.company||'') && (od.unit||'') === (data.unit||'') && (od.hub||'') === (data.hub||'');
              });
              if (sameComboLegacy){
                targetSnap = sameComboLegacy; targetId = sameComboLegacy.id; targetRef = db.collection('directory').doc(targetId);
              } else {
                targetSnap = snapByComposite; targetRef = refsByComposite[i]; targetId = id;
              }
            }
          }

          if (!targetSnap.exists){
            newCount++;
            recapNew.push({ id:targetId, name:data.name, code:data.code||'', company:data.company||'', unit:data.unit||'', hub:data.hub||'' });
            if (!dry){ batch.set(targetRef, data, { merge: true }); writes++; }
          } else {
            const old = targetSnap.data() || {};
            if (!equalData(old, data)){
              if ((old.code || '') !== (data.code || '')){
                log(`‚Üª –ö–æ–¥ –∑–º—ñ–Ω–µ–Ω–æ –¥–ª—è ¬´${data.name}¬ª: ${old.code || '‚Äî'} ‚Üí ${data.code || '‚Äî'}`,'warn');
              }
              updatedCount++;
              const changed = [];
              if ((old.code||'') !== (data.code||'')) changed.push('code');
              if ((old.company||'') !== (data.company||'')) changed.push('company');
              if ((old.unit||'') !== (data.unit||'')) changed.push('unit');
              if ((old.hub||'') !== (data.hub||'')) changed.push('hub');
              recapUpdated.push({ id:targetId, name:data.name, codeOld:old.code||'', codeNew:data.code||'', company:data.company||'', unit:data.unit||'', hub:data.hub||'', changed:changed.join('|') });
              if (!dry){ batch.set(targetRef, data, { merge: true }); writes++; }
            } else {
              unchangedCount++;
              recapUnchanged.push({ id:targetId, name:data.name, code:data.code||'', company:data.company||'', unit:data.unit||'', hub:data.hub||'' });
            }
          }
        }

        if (!dry && writes > 0){
          await batch.commit();
        }

        ok += slice.length;

        const pct = ((b+1)/totalBatches)*100;
        const elapsed = (Date.now() - startedAt)/1000;
        const speed = ok / Math.max(elapsed, 0.001);
        const remain = total - ok;
        const eta = remain / Math.max(speed, 0.001);

        setProg(pct, `–í–∏–∫–æ–Ω–∞–Ω–æ ${Math.round(pct)}% ‚Ä¢ ${ok}/${total} ‚Ä¢ ETA ~ ${Math.ceil(eta)}—Å`);
        if ((b % 5) === 0 || b === totalBatches-1){
          const dl = deletedThisBatch ? `, –í–∏–¥–∞–ª–µ–Ω–æ legacy: ${deletedThisBatch}` : '';
          log(`–ë–∞—Ç—á ${b+1}/${totalBatches} –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –û–±—Ä–æ–±–ª–µ–Ω–æ: ${ok}. –ù–æ–≤–∏—Ö: ${newCount}, –û–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount}, –ë–µ–∑ –∑–º—ñ–Ω: ${unchangedCount}${dl}`, 'ok');
        }
      }

      setStatus(`
        <span class="ok"><b>–ì–æ—Ç–æ–≤–æ.</b> –û–±—Ä–æ–±–ª–µ–Ω–æ: ${ok}</span>${fail ? `, <span class="err">–ü–æ–º–∏–ª–æ–∫: ${fail}</span>` : ''}
        <br><span class="muted">–î–æ–¥–∞–Ω–æ –Ω–æ–≤–∏—Ö: <b>${newCount}</b> ‚Ä¢ –û–Ω–æ–≤–ª–µ–Ω–æ: <b>${updatedCount}</b> ‚Ä¢ –ë–µ–∑ –∑–º—ñ–Ω: <b>${unchangedCount}</b>${dry ? ' (dry-run, –±–µ–∑ –∑–∞–ø–∏—Å—É)' : ''}</span>
      `);
      log(`–ü—ñ–¥—Å—É–º–æ–∫ ‚Üí –ù–æ–≤–∏—Ö: ${newCount} | –û–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount} | –ë–µ–∑ –∑–º—ñ–Ω: ${unchangedCount}${dry ? ' (dry-run)' : ''}`, 'ok');
      setProg(100, '–ì–æ—Ç–æ–≤–æ');

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –¥–µ—Ç–∞–ª—è–º–∏
      showImportSummary({
        new: recapNew,
        updated: recapUpdated,
        unchanged: recapUnchanged,
        deleted: recapDeleted,
        other: recapOther,
        dry
      });
    }catch(e){
      fail = total - ok;
      log(`–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ${e.message || e}`, 'err');
      alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —ñ–º–ø–æ—Ä—Ç—É. –î–µ—Ç–∞–ª—ñ —É –ª–æ–≥–∞—Ö.');
      setProg(0, '–ü–æ–º–∏–ª–∫–∞');
    }finally{
      $('importBtn').disabled = false;
      $('parseBtn').disabled = false;
      $('clearBtn').disabled = false;
      updateImportButton();
    }
  });

  // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è
  $('clearBtn').addEventListener('click', () => {
    $('file').value = '';
    $('raw').value = '';
    $('sep').value = 'auto';
    $('enc').value = 'utf-8';
    ['nameCol','codeCol','companyCol','unitCol','hubCol'].forEach(id => { $(id).value = ''; });
    $('hasHeader').checked = true;
    $('dryRun').checked = true;
    $('status').innerHTML = '';
    $('log').textContent = '';
    setProg(0, '–ì–æ—Ç–æ–≤–æ');
    $('raw').focus();
    updateImportButton();
  });

  // Summary modal wiring
  $('btnSummaryClose').addEventListener('click', ()=>{ $('summaryBackdrop').style.display='none'; });
  $('btnSummaryCSV').addEventListener('click', exportSummaryCSV);
  $('btnSummaryJSON').addEventListener('click', copySummaryJSON);
  document.querySelectorAll('.tabs .tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      const name = tab.dataset.tab; if (!name) return;
      document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.toggle('active', t===tab));
      ['overview','new','updated','unchanged','other'].forEach(id=>{
        const el = $('tab-'+id); if (el) el.style.display = (id===name)? '' : 'none';
      });
    });
  });

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞ –ø—ñ–¥–∫–∞–∑–∫–∞
  statusTop.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å';
  updateImportButton();

  // –ü–æ–¥—ñ—è –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É
  $('btnAddSingle')?.addEventListener('click', (e) => {
    e.preventDefault();
    addSingleDirectoryEntry();
  });
});
</script>
<script>
  window.addEventListener('error',            ()=>{ document.documentElement.style.visibility = 'visible'; });
  window.addEventListener('unhandledrejection',()=>{ document.documentElement.style.visibility = 'visible'; });
</script>

</body>
</html>
