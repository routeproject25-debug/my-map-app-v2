<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>üë®‚Äçüíª –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- –ö–æ–Ω—Ñ—ñ–≥ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É -->
  <script src="/config/config.js"></script>

  <style>
    /* –•–æ–≤–∞—î–º–æ DOM, –¥–æ–∫–∏ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Ä–æ–ª—å */
    html { visibility: hidden; }

    body { font-family: Arial, sans-serif; padding:20px; margin:0; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .muted { color:#6b7280; font-size:13px; }
    .btn { cursor:pointer; border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:6px 10px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .user-row { margin-bottom: 10px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .user-row b { font-size:15px; }
    .user-meta { color:#6b7280; font-size:12px; margin-left:6px; }
    .row-actions { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select { margin-left:10px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; }
    #user-list { margin-top:12px; }
    #status { margin: 6px 0 10px; }

    .hubs-wrap label{
      display:inline-flex; align-items:center; gap:6px;
      margin:2px 12px 8px 0;
      user-select:none;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h2 style="margin:0">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å: –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h2>
      <div class="muted" id="hello">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</div>
    </div>
    <div>
      <a href="/index.html" class="btn" id="backToMap" title="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É (–∫–∞—Ä—Ç—É)">üè† –ù–∞ –∫–∞—Ä—Ç—É</a>
      <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
    </div>
  </header>

  <p id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
  <div id="user-list"></div>

  <script>
/* ================= Firebase init ================= */
const CFG = window.APP_CONFIG?.firebase;
if (!CFG) {
  document.getElementById('status').textContent =
    '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ APP_CONFIG.firebase. –ü–µ—Ä–µ–≤—ñ—Ä /config/config.js —Ç–∞ —à–ª—è—Ö —É <script src="/config/config.js">';
  console.error('APP_CONFIG.firebase is missing');
  document.documentElement.style.visibility = 'visible';
} else {
  try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) { console.error(e); }
}
const db   = firebase.firestore();
const auth = firebase.auth();

/* ================= DOM –ø–æ—Å–∏–ª–∞–Ω–Ω—è ================= */
const loginURL  = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
const helloEl   = document.getElementById('hello');
const statusEl  = document.getElementById('status');
const listEl    = document.getElementById('user-list');
const btnLogout = document.getElementById('btnLogout');

/* ====== –î–û–í–Ü–î–ù–ò–ö –•–ê–ë–Ü–í (—Ä–µ–¥–∞–≥—É–π –∑–∞ –ø–æ—Ç—Ä–µ–±–∏) ====== */
const HUBS = ['–í—ñ–Ω–Ω–∏—Ü—å–∫–∏–π','–ó–∞—Ö—ñ–¥–Ω–∏–π','–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π','–£—Ä–æ–∂–∞–π–Ω–∞ –∫—Ä–∞—ó–Ω–∞','–ú–•–ü'];

let currentUser = null;
let unsubscribeUsers = null;

btnLogout.addEventListener('click', async () => {
  try { await auth.signOut(); } catch(e) { console.warn(e); }
});

/* ===== –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ä–æ–ª—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ===== */
async function resolveUserRole(uid){
  try {
    const udoc = await db.collection('users').doc(uid).get({ source: 'server' });
    if (udoc.exists && udoc.data()?.role) return String(udoc.data().role);
  } catch(e){ console.warn('users role read (server) failed', e); }

  try {
    const udoc2 = await db.collection('users').doc(uid).get();
    if (udoc2.exists && udoc2.data()?.role) return String(udoc2.data().role);
  } catch(e){ console.warn('users role read (cache) failed', e); }

  try {
    const rdoc = await db.collection('roles').doc(uid).get({ source: 'server' });
    if (rdoc.exists && rdoc.data()?.role) return String(rdoc.data().role);
  } catch(e){ console.warn('roles fallback read failed', e); }

  return 'pending';
}

/* ================= Guard + –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ================= */
auth.onAuthStateChanged(async (u) => {
  currentUser = u || null;

  if (!u) {
    statusEl.textContent = '–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏.';
    location.replace(loginURL);
    return;
  }

  helloEl.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + (u.email || u.uid);
  btnLogout.style.display = '';

  let role = 'pending';
  try { role = (await resolveUserRole(u.uid)).trim().toLowerCase(); } catch(e){ console.error(e); }
  if (role !== 'admin') {
    statusEl.textContent = '‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ (–ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin)';
    document.documentElement.style.visibility = 'visible';
    setTimeout(()=>location.replace('/'), 1200);
    return;
  }

  statusEl.textContent = '‚úÖ –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ –∞–¥–º—ñ–Ω';
  document.documentElement.style.visibility = 'visible';
  loadUsers();
});

/* ================= –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞ (–∑ —Ä–æ–ª–ª—é —Ç–∞ —Ö–∞–±–∞–º–∏) ================= */
function userRowHTML(id, user){
  const name    = user.displayName || user.email || id;
  const email   = user.email ? ` ‚Ä¢ ${user.email}` : '';
  const role    = (user.role || 'pending').toLowerCase();
  const created = user.createdAt || user.created_at || '';

  const allowedHubs = Array.isArray(user.allowedHubs)
    ? user.allowedHubs
    : ((role === 'admin' || role === 'security') ? ['*'] : []);

  const seeAll = allowedHubs.includes('*') || role === 'admin' || role === 'security';

  const hubsHTML = `
    <label>
      <input type="checkbox" class="hub-all" ${seeAll ? 'checked' : ''}>
      <b>–í—Å—ñ —Ö–∞–±–∏</b>
    </label>
    ${HUBS.map(h => `
      <label>
        <input type="checkbox" class="hub-chk" data-hub="${escapeHtml(h)}"
               ${(seeAll || allowedHubs.includes(h)) ? 'checked' : ''} ${(seeAll ? 'disabled' : '')}>
        <span>${escapeHtml(h)}</span>
      </label>
    `).join('')}
  `;

  return `
    <div class="user-row" data-uid="${id}">
      <div>
        <b>${escapeHtml(name)}</b>
        <span class="user-meta">(${escapeHtml(role)})${email ? ' ‚Ä¢ ' + escapeHtml(email) : ''}${created ? ' ‚Ä¢ —Å—Ç–≤–æ—Ä–µ–Ω–æ: ' + escapeHtml(created) : ''}</span>
      </div>

      <div class="row-actions">
        <label>–†–æ–ª—å:
          <select data-id="${id}" data-prev="${role}" class="role-select">
            <option value="pending"  ${role==="pending" ?"selected":""}>–û—á—ñ–∫—É—î</option>
            <option value="user"     ${role==="user"    ?"selected":""}>User</option>
            <option value="logist"   ${role==="logist"  ?"selected":""}>Logist</option>
            <option value="security" ${role==="security"?"selected":""}>Security</option>
            <option value="admin"    ${role==="admin"   ?"selected":""}>Admin</option>
          </select>
        </label>

        <button class="btn save-hubs" data-id="${id}">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ö–∞–±—ñ–≤</button>
      </div>

      <div class="hubs-wrap" style="margin-top:6px;">
        <div class="muted" style="margin-bottom:4px;">–î–æ—Å—Ç—É–ø –¥–æ —Ö–∞–±—ñ–≤:</div>
        ${hubsHTML}
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ================= Live-–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É users ================= */
function loadUsers(){
  try { if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; } } catch {}
  unsubscribeUsers = db.collection('users')
    .orderBy('role')
    .onSnapshot((snap) => {
      listEl.innerHTML = '';
      snap.forEach((doc) => {
        const user = doc.data() || {};
        listEl.insertAdjacentHTML('beforeend', userRowHTML(doc.id, user));
      });
      bindRoleChangeHandlers();
      bindHubHandlers();            // ‚¨ÖÔ∏è –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ —Ö–∞–±—ñ–≤ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä—É
    }, (err) => {
      console.error('onSnapshot(users) error:', err);
      statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: ' + (err.message || err);
    });
}

/* ================= –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ —Ä–æ–ª–µ–π ================= */
function bindRoleChangeHandlers(){
  document.querySelectorAll('#user-list .user-row .role-select').forEach((sel) => {
    sel.addEventListener('change', async (e) => {
      const row      = e.target.closest('.user-row');
      const uid      = e.target.dataset.id;
      const newRole  = e.target.value;
      const prevRole = e.target.getAttribute('data-prev') || '';

      // –∑–∞—Ö–∏—Å—Ç: –Ω–µ –¥–µ–º–æ—Ç–∏–º–æ —Å–µ–±–µ
      if (currentUser && uid === currentUser.uid && newRole !== 'admin') {
        alert('–ù–µ –º–æ–∂–Ω–∞ –∑–Ω—ñ–º–∞—Ç–∏ –∑ —Å–µ–±–µ —Ä–æ–ª—å admin.');
        e.target.value = 'admin';
        return;
      }

      // –í—ñ–∑—É–∞–ª—å–Ω–æ –∑–∞–±–ª–æ–∫—É—î–º–æ/—Ä–æ–∑–±–ª–æ–∫—É—î–º–æ —á–µ–∫–±–æ–∫—Å–∏ —Ö–∞–±—ñ–≤ –ø—ñ–¥ –Ω–æ–≤—É —Ä–æ–ª—å
      applyRoleHubLock(row, newRole);

      e.target.disabled = true;
      statusEl.textContent = `–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${uid} ‚Üí ${newRole}‚Ä¶`;

      try {
        const batch = db.batch();
        const uref  = db.collection('users').doc(uid);

        // 1) –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–ª—å
        batch.set(uref, {
          role: newRole,
          roleUpdatedAt: new Date().toISOString(),
          roleUpdatedBy: currentUser ? currentUser.uid : null
        }, { merge: true });

        // 2) —è–∫—â–æ admin/security ‚Äî –æ–¥—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º–æ allowedHubs=['*']
        if (newRole === 'admin' || newRole === 'security') {
          batch.set(uref, { allowedHubs: ['*'] }, { merge: true });
        }

        // –∞—É–¥–∏—Ç
        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'role_change',
          targetUid: uid,
          newRole,
          prevRole,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });

        await batch.commit();

        e.target.setAttribute('data-prev', newRole);
        statusEl.textContent = `‚úÖ –†–æ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ: ${uid} ‚Üí ${newRole}`;
      } catch (err) {
        console.error(err);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–æ–ª—ñ: ' + (err.message || err));
        // –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –≤—ñ–∑—É–∞–ª—å–Ω–æ
        e.target.value = prevRole || 'pending';
        applyRoleHubLock(row, e.target.value);
        statusEl.textContent = '‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ä–æ–ª—å.';
      } finally {
        e.target.disabled = false;
      }
    });
  });
}

/* ================= –î–æ—Å—Ç—É–ø–∏ –¥–æ —Ö–∞–±—ñ–≤ ================= */
// –±–ª–æ–∫—É—î–º–æ/—Ä–æ–∑–±–ª–æ–∫—É—î–º–æ —á–µ–∫–±–æ–∫—Å–∏ —Ö–∞–±—ñ–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–æ–ª—ñ –∞–±–æ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ "–≤—Å—ñ —Ö–∞–±–∏"
function applyRoleHubLock(row, roleNow){
  const star     = row.querySelector('.hub-all');
  const hubBoxes = row.querySelectorAll('.hub-chk');

  const forceAll = (roleNow === 'admin' || roleNow === 'security');
  if (forceAll && star) star.checked = true;

  const all = (star?.checked) || forceAll;

  hubBoxes.forEach(chk => {
    chk.disabled = all;
    if (all) chk.checked = true; // –¥–ª—è —è—Å–Ω–æ—Å—Ç—ñ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
  });
}

// –∑–±—ñ—Ä allowedHubs —ñ–∑ —Ä—è–¥–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
function buildAllowedHubsFromRow(row){
  const role = row.querySelector('.role-select')?.value || 'pending';
  const star = row.querySelector('.hub-all')?.checked;

  if (role === 'admin' || role === 'security' || star) return ['*'];

  const hubs = Array.from(row.querySelectorAll('.hub-chk'))
    .filter(ch => ch.checked)
    .map(ch => ch.getAttribute('data-hub'));

  return hubs;
}

// –ø—Ä–∏–≤'—è–∑–∫–∞ –ª–æ–≥—ñ–∫–∏ –¥–æ —á–µ–∫–±–æ–∫—Å—ñ–≤/–∫–Ω–æ–ø–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
function bindHubHandlers(){
  document.querySelectorAll('#user-list .user-row').forEach(row => {
    const roleSel   = row.querySelector('.role-select');
    const star      = row.querySelector('.hub-all');
    const saveBtn   = row.querySelector('.save-hubs');

    // –ø–µ—Ä–≤–∏–Ω–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∑–∞ –ø–æ—Ç–æ—á–Ω–æ—é —Ä–æ–ª–ª—é
    applyRoleHubLock(row, roleSel.value);

    // –∫–ª—ñ–∫ –ø–æ "–≤—Å—ñ —Ö–∞–±–∏" ‚Äî –ª–∏—à–µ –±–ª–æ–∫—É—î/—Ä–æ–∑–±–ª–æ–∫—É—î
    star?.addEventListener('change', () => applyRoleHubLock(row, roleSel.value));

    // –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è allowedHubs
    saveBtn?.addEventListener('click', async () => {
      const uid  = row.dataset.uid;
      const hubs = buildAllowedHubsFromRow(row);

      try{
        saveBtn.disabled = true;
        saveBtn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶';

        const batch = db.batch();
        const uref  = db.collection('users').doc(uid);
        batch.set(uref, { allowedHubs: hubs }, { merge: true });

        // –Ω–µ–≤–µ–ª–∏–∫–∏–π –∞—É–¥–∏—Ç (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ, –∞–ª–µ –∫–æ—Ä–∏—Å–Ω–æ)
        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'hubs_change',
          targetUid: uid,
          allowedHubs: hubs,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });

        await batch.commit();

        saveBtn.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ';
        setTimeout(()=> saveBtn.textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ö–∞–±—ñ–≤', 1200);
      }catch(e){
        console.error(e);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –¥–æ—Å—Ç—É–ø–∏: ' + (e?.message || e));
        saveBtn.textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ö–∞–±—ñ–≤';
      }finally{
        saveBtn.disabled = false;
      }
    });
  });
}

/* ================= –ì–ª–æ–±–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ ================= */
window.addEventListener('error', (e) => {
  try {
    document.documentElement.style.visibility = 'visible';
    statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞: ' + (e.message || '');
  } catch {}
});
  </script>
</body>
</html>
