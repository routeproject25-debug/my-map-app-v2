<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>👨‍💻 Адмін-панель</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Конфіг застосунку -->
  <script src="/config/config.js"></script>

  <style>
    /* Ховаємо DOM, доки не перевіримо роль */
    html { visibility: hidden; }

    body { font-family: Arial, sans-serif; padding:20px; margin:0; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .muted { color:#6b7280; font-size:13px; }
    .btn { cursor:pointer; border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:6px 10px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .user-row { margin-bottom: 10px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .user-row b { font-size:15px; }
    .user-meta { color:#6b7280; font-size:12px; margin-left:6px; }
    .row-actions { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select { margin-left:10px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; }
    #user-list { margin-top:12px; }
    #status { margin: 6px 0 10px; }

    .hubs-wrap label{
      display:inline-flex; align-items:center; gap:6px;
      margin:2px 12px 8px 0;
      user-select:none;
    }
    /* ── Панель керування ─────────────────────────── */
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 12px}
.controls input,.controls select{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px}
.controls .badge{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px}
.sticky-top{position:sticky;top:0;background:#fff;z-index:10;padding:8px 0;border-bottom:1px solid #eee}

/* ── Розмітка списку ──────────────────────────── */
.section{margin-top:12px}
.section h3{margin:6px 0 8px;font-size:14px;color:#475569;position:sticky;top:46px;background:#fff;z-index:5;padding:4px 0}

/* ── Пагінація ─────────────────────────────────── */
.pagination{display:flex;align-items:center;gap:8px;margin:8px 0}

/* ── Компактний режим ─────────────────────────── */
body.compact .user-row{padding:8px 10px}
body.compact .user-row b{font-size:14px}
  </style>
</head>
<body>
  <header>
    <div class="controls sticky-top" id="toolbar">
  <input id="q" type="text" placeholder="Пошук: ім’я або email…" autocomplete="off" />
  <select id="filterRole">
    <option value="">Усі ролі</option>
    <option value="pending">Очікує</option>
    <option value="user">User</option>
    <option value="logist">Logist</option>
    <option value="security">Security</option>
    <option value="admin">Admin</option>
  </select>
  <select id="filterHub">
    <option value="">Усі хаби</option>
    <!-- опції підкинемо з JS з масиву HUBS -->
  </select>
  <label class="muted"><input type="checkbox" id="pendingOnly"> лише «Очікує»</label>
  <select id="sortBy">
    <option value="created_desc">Нові зверху</option>
    <option value="created_asc">Старі зверху</option>
    <option value="name_asc">Ім’я A→Я</option>
    <option value="name_desc">Ім’я Я→A</option>
    <option value="role_asc">Роль A→Я</option>
  </select>
  <button class="btn" id="btnCompact" title="Перемкнути компактний режим">🧱 Компактно</button>
  <span class="badge" id="countView">0</span>
</div>

<div class="pagination" id="pager" style="display:none;">
  <button class="btn" id="prevPage">←</button>
  <span id="pageInfo" class="muted"></span>
  <button class="btn" id="nextPage">→</button>
</div>
    <div>
      <h2 style="margin:0">Адмін-панель: керування користувачами</h2>
      <div class="muted" id="hello">Перевірка…</div>
    </div>
    <div>
      <a href="/index.html" class="btn" id="backToMap" title="Перейти на головну сторінку (карту)">🏠 На карту</a>
      <button id="btnLogout" class="btn" style="display:none;">Вийти</button>
    </div>
  </header>

  <p id="status">Завантаження...</p>
  <div id="user-list"></div>

  <script>
/* ================= Firebase init ================= */
const CFG = window.APP_CONFIG?.firebase;
if (!CFG) {
  document.getElementById('status').textContent =
    'Не знайдено APP_CONFIG.firebase. Перевір /config/config.js та шлях у <script src="/config/config.js">';
  console.error('APP_CONFIG.firebase is missing');
  document.documentElement.style.visibility = 'visible';
} else {
  try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) { console.error(e); }
}
const db   = firebase.firestore();
const auth = firebase.auth();

/* ================= DOM посилання ================= */
const loginURL  = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
const helloEl   = document.getElementById('hello');
const statusEl  = document.getElementById('status');
const listEl    = document.getElementById('user-list');
const btnLogout = document.getElementById('btnLogout');

/* ====== ДОВІДНИК ХАБІВ (редагуй за потреби) ====== */
const HUBS = ['Вінницький','Західний','Центральний','Урожайна країна','МХП'];

let currentUser = null;
let unsubscribeUsers = null;

btnLogout.addEventListener('click', async () => {
  try { await auth.signOut(); } catch(e) { console.warn(e); }
});

/* ===== Визначення ролі поточного користувача ===== */
async function resolveUserRole(uid){
  try {
    const udoc = await db.collection('users').doc(uid).get({ source: 'server' });
    if (udoc.exists && udoc.data()?.role) return String(udoc.data().role);
  } catch(e){ console.warn('users role read (server) failed', e); }

  try {
    const udoc2 = await db.collection('users').doc(uid).get();
    if (udoc2.exists && udoc2.data()?.role) return String(udoc2.data().role);
  } catch(e){ console.warn('users role read (cache) failed', e); }

  try {
    const rdoc = await db.collection('roles').doc(uid).get({ source: 'server' });
    if (rdoc.exists && rdoc.data()?.role) return String(rdoc.data().role);
  } catch(e){ console.warn('roles fallback read failed', e); }

  return 'pending';
}

/* ===== Контролі / стан списку ===== */
const PAGE_SIZE = 30;
const toolbar = {
  q: document.getElementById('q'),
  role: document.getElementById('filterRole'),
  hub: document.getElementById('filterHub'),
  onlyPending: document.getElementById('pendingOnly'),
  sortBy: document.getElementById('sortBy'),
  compact: document.getElementById('btnCompact'),
  count: document.getElementById('countView'),
};
const pager = {
  box: document.getElementById('pager'),
  prev: document.getElementById('prevPage'),
  next: document.getElementById('nextPage'),
  info: document.getElementById('pageInfo'),
};

let allUsers = [];    // сирі дані з Firestore
let page = 0;        // номер сторінки
const F = { q:'', role:'', hub:'', onlyPending:false, sort:'created_desc' };

/* заповнимо селект хабів */
(function fillHubSelect(){
  const sel = toolbar.hub;
  HUBS.forEach(h => {
    const o = document.createElement('option');
    o.value = h; o.textContent = h;
    sel.appendChild(o);
  });
})();

/* збереження компактного режиму */
(function restoreCompact(){
  const on = localStorage.getItem('admin.compact') === '1';
  document.body.classList.toggle('compact', on);
})();
toolbar.compact.addEventListener('click', () => {
  const on = !document.body.classList.contains('compact');
  document.body.classList.toggle('compact', on);
  localStorage.setItem('admin.compact', on ? '1' : '0');
});

/* дрібний помічник */
function toLower(s){ return String(s || '').toLowerCase(); }
function getCreatedMs(u){
  const t = u.createdAt || u.created_at || null;
  if (!t) return 0;
  if (t.seconds != null) return t.seconds*1000 + (t.nanoseconds||0)/1e6;
  const d = new Date(t); return isNaN(d) ? 0 : d.getTime();
}

/* фільтрація + сортування у пам'яті */
function applyFilters(){
  const q = toLower(F.q);
  const filtered = allUsers.filter(u => {
    if (F.role && toLower(u.role) !== F.role) return false;
    if (F.onlyPending && toLower(u.role) !== 'pending') return false;

    if (F.hub){
      const hubs = Array.isArray(u.allowedHubs) ? u.allowedHubs : [];
      const seeAll = hubs.includes('*') || ['admin','security'].includes(toLower(u.role));
      if (!seeAll && !hubs.includes(F.hub)) return false;
    }

    if (q){
      const hay = `${u.displayName||''} ${u.email||''}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  // сортування
  const arr = filtered.slice();
  const byName = (u) => toLower(u.displayName || u.email);
  switch(F.sort){
    case 'created_asc':  arr.sort((a,b)=> getCreatedMs(a) - getCreatedMs(b)); break;
    case 'name_asc':     arr.sort((a,b)=> byName(a).localeCompare(byName(b),'uk')); break;
    case 'name_desc':    arr.sort((a,b)=> byName(b).localeCompare(byName(a),'uk')); break;
    case 'role_asc':     arr.sort((a,b)=> toLower(a.role).localeCompare(toLower(b.role),'uk') || byName(a).localeCompare(byName(b),'uk')); break;
    default:             arr.sort((a,b)=> getCreatedMs(b) - getCreatedMs(a)); // created_desc
  }
  return arr;
}

/* рендер списку із групуванням за ролями + пагінація */
function renderUsers(){
  const data = applyFilters();
  toolbar.count.textContent = `${data.length} користувачів`;

  // пагінація
  const pages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
  page = Math.min(Math.max(0, page), pages-1);
  pager.box.style.display = data.length > PAGE_SIZE ? '' : 'none';
  pager.info.textContent = `${page+1} / ${pages}`;
  pager.prev.disabled = page <= 0;
  pager.next.disabled = page >= pages-1;

  const start = page * PAGE_SIZE;
  const slice = data.slice(start, start + PAGE_SIZE);

  // групування
  const rolesOrder = ['pending','user','logist','security','admin'];
  const byRole = new Map();
  slice.forEach(u => {
    const r = toLower(u.role || 'pending');
    if (!byRole.has(r)) byRole.set(r, []);
    byRole.get(r).push(u);
  });

  listEl.innerHTML = '';
  const addSection = (roleKey) => {
    const items = byRole.get(roleKey) || [];
    if (!items.length) return;
    const header = document.createElement('div');
    header.className = 'section';
    header.innerHTML = `<h3>${roleKey.toUpperCase()} (${items.length})</h3>`;
    listEl.appendChild(header);
    items.forEach(u => {
      listEl.insertAdjacentHTML('beforeend', userRowHTML(u.id, u));
    });
  };

  // малюємо секції у фіксованому порядку, потім інші (на випадок неочікуваних ролей)
  rolesOrder.forEach(addSection);
  Array.from(byRole.keys())
    .filter(k => !rolesOrder.includes(k))
    .sort()
    .forEach(addSection);

  // повертаємо інтерактивність існуючим кнопкам
  bindRoleChangeHandlers();
  bindHubHandlers();
}

/* події панелі */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const rerender = debounce(() => { page = 0; renderUsers(); }, 150);
toolbar.q.addEventListener('input',  e => { F.q = e.target.value; rerender(); });
toolbar.role.addEventListener('change', e => { F.role = e.target.value; rerender(); });
toolbar.hub.addEventListener('change',  e => { F.hub  = e.target.value; rerender(); });
toolbar.onlyPending.addEventListener('change', e => { F.onlyPending = e.target.checked; rerender(); });
toolbar.sortBy.addEventListener('change', e => { F.sort = e.target.value; rerender(); });
pager.prev.addEventListener('click', () => { page = Math.max(0, page-1); renderUsers(); });
pager.next.addEventListener('click', () => { page = page+1; renderUsers(); });

/* ================= Guard + завантаження ================= */
auth.onAuthStateChanged(async (u) => {
  currentUser = u || null;

  if (!u) {
    statusEl.textContent = 'Необхідно увійти.';
    location.replace(loginURL);
    return;
  }

  helloEl.textContent = 'Увійшли як ' + (u.email || u.uid);
  btnLogout.style.display = '';

  let role = 'pending';
  try { role = (await resolveUserRole(u.uid)).trim().toLowerCase(); } catch(e){ console.error(e); }
  if (role !== 'admin') {
    statusEl.textContent = '⛔ Доступ заборонено (потрібна роль admin)';
    document.documentElement.style.visibility = 'visible';
    setTimeout(()=>location.replace('/'), 1200);
    return;
  }

  statusEl.textContent = '✅ Ви увійшли як адмін';
  document.documentElement.style.visibility = 'visible';
  loadUsers();
});

/* ================= Рендер одного юзера (з роллю та хабами) ================= */
function userRowHTML(id, user){
  const name    = user.displayName || user.email || id;
  const email   = user.email ? ` • ${user.email}` : '';
  const role    = (user.role || 'pending').toLowerCase();
  const created = user.createdAt || user.created_at || '';

  const allowedHubs = Array.isArray(user.allowedHubs)
    ? user.allowedHubs
    : ((role === 'admin' || role === 'security') ? ['*'] : []);

  const seeAll = allowedHubs.includes('*') || role === 'admin' || role === 'security';

  const hubsHTML = `
    <label>
      <input type="checkbox" class="hub-all" ${seeAll ? 'checked' : ''}>
      <b>Всі хаби</b>
    </label>
    ${HUBS.map(h => `
      <label>
        <input type="checkbox" class="hub-chk" data-hub="${escapeHtml(h)}"
               ${(seeAll || allowedHubs.includes(h)) ? 'checked' : ''} ${(seeAll ? 'disabled' : '')}>
        <span>${escapeHtml(h)}</span>
      </label>
    `).join('')}
  `;

  return `
    <div class="user-row" data-uid="${id}">
      <div>
        <b>${escapeHtml(name)}</b>
        <span class="user-meta">(${escapeHtml(role)})${email ? ' • ' + escapeHtml(email) : ''}${created ? ' • створено: ' + escapeHtml(created) : ''}</span>
      </div>

      <div class="row-actions">
        <label>Роль:
          <select data-id="${id}" data-prev="${role}" class="role-select">
            <option value="pending"  ${role==="pending" ?"selected":""}>Очікує</option>
            <option value="user"     ${role==="user"    ?"selected":""}>User</option>
            <option value="logist"   ${role==="logist"  ?"selected":""}>Logist</option>
            <option value="security" ${role==="security"?"selected":""}>Security</option>
            <option value="admin"    ${role==="admin"   ?"selected":""}>Admin</option>
          </select>
        </label>

        <button class="btn save-hubs" data-id="${id}">💾 Зберегти доступ до хабів</button>
      </div>

      <div class="hubs-wrap" style="margin-top:6px;">
        <div class="muted" style="margin-bottom:4px;">Доступ до хабів:</div>
        ${hubsHTML}
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ================= Live-завантаження списку users ================= */
function loadUsers(){
  try { if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; } } catch {}
  unsubscribeUsers = db.collection('users')
    .orderBy('role')                // просто щоб був стабільний порядок у снапшоті
    .onSnapshot((snap) => {
      allUsers = [];
      snap.forEach(doc => allUsers.push({ id: doc.id, ...(doc.data() || {}) }));
      renderUsers();
    }, (err) => {
      console.error('onSnapshot(users) error:', err);
      statusEl.textContent = 'Помилка завантаження користувачів: ' + (err.message || err);
    });
}

/* ================= Обробка зміни ролей ================= */
function bindRoleChangeHandlers(){
  document.querySelectorAll('#user-list .user-row .role-select').forEach((sel) => {
    sel.addEventListener('change', async (e) => {
      const row      = e.target.closest('.user-row');
      const uid      = e.target.dataset.id;
      const newRole  = e.target.value;
      const prevRole = e.target.getAttribute('data-prev') || '';

      // захист: не демотимо себе
      if (currentUser && uid === currentUser.uid && newRole !== 'admin') {
        alert('Не можна знімати з себе роль admin.');
        e.target.value = 'admin';
        return;
      }

      // Візуально заблокуємо/розблокуємо чекбокси хабів під нову роль
      applyRoleHubLock(row, newRole);

      e.target.disabled = true;
      statusEl.textContent = `Оновлення ролі користувача ${uid} → ${newRole}…`;

      try {
        const batch = db.batch();
        const uref  = db.collection('users').doc(uid);

        // 1) оновлюємо роль
        batch.set(uref, {
          role: newRole,
          roleUpdatedAt: new Date().toISOString(),
          roleUpdatedBy: currentUser ? currentUser.uid : null
        }, { merge: true });

        // 2) якщо admin/security — одразу ставимо allowedHubs=['*']
        if (newRole === 'admin' || newRole === 'security') {
          batch.set(uref, { allowedHubs: ['*'] }, { merge: true });
        }

        // аудит
        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'role_change',
          targetUid: uid,
          newRole,
          prevRole,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });

        await batch.commit();

        e.target.setAttribute('data-prev', newRole);
        statusEl.textContent = `✅ Роль оновлено: ${uid} → ${newRole}`;
      } catch (err) {
        console.error(err);
        alert('Помилка збереження ролі: ' + (err.message || err));
        // відкотити візуально
        e.target.value = prevRole || 'pending';
        applyRoleHubLock(row, e.target.value);
        statusEl.textContent = '❌ Не вдалося оновити роль.';
      } finally {
        e.target.disabled = false;
      }
    });
  });
}

/* ================= Доступи до хабів ================= */
// блокуємо/розблокуємо чекбокси хабів залежно від ролі або перемикача "всі хаби"
function applyRoleHubLock(row, roleNow){
  const star     = row.querySelector('.hub-all');
  const hubBoxes = row.querySelectorAll('.hub-chk');

  const forceAll = (roleNow === 'admin' || roleNow === 'security');
  if (forceAll && star) star.checked = true;

  const all = (star?.checked) || forceAll;

  hubBoxes.forEach(chk => {
    chk.disabled = all;
    if (all) chk.checked = true; // для ясності інтерфейсу
  });
}

// збір allowedHubs із рядка користувача
function buildAllowedHubsFromRow(row){
  const role = row.querySelector('.role-select')?.value || 'pending';
  const star = row.querySelector('.hub-all')?.checked;

  if (role === 'admin' || role === 'security' || star) return ['*'];

  const hubs = Array.from(row.querySelectorAll('.hub-chk'))
    .filter(ch => ch.checked)
    .map(ch => ch.getAttribute('data-hub'));

  return hubs;
}

// прив'язка логіки до чекбоксів/кнопки збереження
function bindHubHandlers(){
  document.querySelectorAll('#user-list .user-row').forEach(row => {
    const roleSel   = row.querySelector('.role-select');
    const star      = row.querySelector('.hub-all');
    const saveBtn   = row.querySelector('.save-hubs');

    // первинне блокування за поточною роллю
    applyRoleHubLock(row, roleSel.value);

    // клік по "всі хаби" — лише блокує/розблокує
    star?.addEventListener('change', () => applyRoleHubLock(row, roleSel.value));

    // збереження allowedHubs
    saveBtn?.addEventListener('click', async () => {
      const uid  = row.dataset.uid;
      const hubs = buildAllowedHubsFromRow(row);

      try{
        saveBtn.disabled = true;
        saveBtn.textContent = 'Збереження…';

        const batch = db.batch();
        const uref  = db.collection('users').doc(uid);
        batch.set(uref, { allowedHubs: hubs }, { merge: true });

        // невеликий аудит (необов’язково, але корисно)
        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'hubs_change',
          targetUid: uid,
          allowedHubs: hubs,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });

        await batch.commit();

        saveBtn.textContent = '✅ Збережено';
        setTimeout(()=> saveBtn.textContent = '💾 Зберегти доступ до хабів', 1200);
      }catch(e){
        console.error(e);
        alert('Не вдалося зберегти доступи: ' + (e?.message || e));
        saveBtn.textContent = '💾 Зберегти доступ до хабів';
      }finally{
        saveBtn.disabled = false;
      }
    });
  });
}

/* ================= Глобальна помилка ================= */
window.addEventListener('error', (e) => {
  try {
    document.documentElement.style.visibility = 'visible';
    statusEl.textContent = 'Помилка скрипта: ' + (e.message || '');
  } catch {}
});
  </script>
</body>
</html>
