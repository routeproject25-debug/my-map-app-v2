<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>ğŸ‘¨â€ğŸ’» ĞĞ´Ğ¼Ñ–Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- ĞšĞ¾Ğ½Ñ„Ñ–Ğ³ Ğ·Ğ°ÑÑ‚Ğ¾ÑÑƒĞ½ĞºÑƒ -->
  <script src="/config/config.js"></script>

  <style>
    /* Ğ¥Ğ¾Ğ²Ğ°Ñ”Ğ¼Ğ¾ DOM, Ğ´Ğ¾ĞºĞ¸ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ğ¼Ğ¾ Ñ€Ğ¾Ğ»ÑŒ */
    html { visibility: hidden; }

    body { font-family: Arial, sans-serif; padding:20px; margin:0; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .muted { color:#6b7280; font-size:13px; }
    .btn { cursor:pointer; border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:6px 10px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .user-row { margin-bottom: 10px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .user-row b { font-size:15px; }
    .user-meta { color:#6b7280; font-size:12px; margin-left:6px; }
    .row-actions { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select { margin-left:10px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; }
    #user-list { margin-top:12px; }
    #status { margin: 6px 0 10px; }

    .hubs-wrap label{
      display:inline-flex; align-items:center; gap:6px;
      margin:2px 12px 8px 0;
      user-select:none;
    }
    .name-edit-wrap{
      display:flex; gap:8px; align-items:center; margin-top:6px;
    }
    .name-edit-wrap input{
      flex:1; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:14px;
    }
    .name-edit-wrap .btn{
      white-space:nowrap;
    }
    /* â”€â”€ ĞŸĞ°Ğ½ĞµĞ»ÑŒ ĞºĞµÑ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 12px}
.controls input,.controls select{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px}
.controls .badge{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px}
.sticky-top{position:sticky;top:0;background:#fff;z-index:10;padding:8px 0;border-bottom:1px solid #eee}

/* â”€â”€ Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ‚ĞºĞ° ÑĞ¿Ğ¸ÑĞºÑƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section{margin-top:12px}
.section h3{margin:6px 0 8px;font-size:14px;color:#475569;position:sticky;top:46px;background:#fff;z-index:5;padding:4px 0}

/* â”€â”€ ĞŸĞ°Ğ³Ñ–Ğ½Ğ°Ñ†Ñ–Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pagination{display:flex;align-items:center;gap:8px;margin:8px 0}

/* â”€â”€ ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body.compact .user-row{padding:8px 10px}
body.compact .user-row b{font-size:14px}

/* â”€â”€ ĞšĞ¾Ğ»Ğ°Ğ¿Ñ Ğ³Ñ€ÑƒĞ¿ Ğ·Ğ° Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section.collapsed .section-body{ display:none; }

.section h3.group-h{
  margin:6px 0 8px; font-size:14px; color:#475569;
  position:sticky; top:46px; background:#fff; z-index:5; padding:4px 0;
  cursor:pointer; user-select:none;
}
.section h3.group-h .arrow{
  display:inline-block; margin-right:6px; transition:transform .15s ease;
  transform: rotate(90deg);
}
.section.collapsed h3.group-h .arrow{ transform: rotate(0deg); }

/* (toast styles removed with block/unblock feature) */
  </style>
</head>
<body>
  <header>
    <div class="controls sticky-top" id="toolbar">
  <input id="q" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº: Ñ–Ğ¼â€™Ñ Ğ°Ğ±Ğ¾ emailâ€¦" autocomplete="off" />
  <select id="filterRole">
    <option value="">Ğ£ÑÑ– Ñ€Ğ¾Ğ»Ñ–</option>
    <option value="pending">ĞÑ‡Ñ–ĞºÑƒÑ”</option>
    <option value="user">User</option>
    <option value="logist">Logist</option>
    <option value="security">Security</option>
    <option value="admin">Admin</option>
  </select>
  <select id="filterHub">
    <option value="">Ğ£ÑÑ– Ñ…Ğ°Ğ±Ğ¸</option>
    <!-- Ğ¾Ğ¿Ñ†Ñ–Ñ— Ğ¿Ñ–Ğ´ĞºĞ¸Ğ½ĞµĞ¼Ğ¾ Ğ· JS Ğ· Ğ¼Ğ°ÑĞ¸Ğ²Ñƒ HUBS -->
  </select>
  <label class="muted"><input type="checkbox" id="pendingOnly"> Ğ»Ğ¸ÑˆĞµ Â«ĞÑ‡Ñ–ĞºÑƒÑ”Â»</label>
  <select id="sortBy">
    <option value="created_desc">ĞĞ¾Ğ²Ñ– Ğ·Ğ²ĞµÑ€Ñ…Ñƒ</option>
    <option value="created_asc">Ğ¡Ñ‚Ğ°Ñ€Ñ– Ğ·Ğ²ĞµÑ€Ñ…Ñƒ</option>
    <option value="name_asc">Ğ†Ğ¼â€™Ñ Aâ†’Ğ¯</option>
    <option value="name_desc">Ğ†Ğ¼â€™Ñ Ğ¯â†’A</option>
    <option value="role_asc">Ğ Ğ¾Ğ»ÑŒ Aâ†’Ğ¯</option>
  </select>
  <button class="btn" id="btnCompact" title="ĞŸĞµÑ€ĞµĞ¼ĞºĞ½ÑƒÑ‚Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼">ğŸ§± ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾</button>
  <span class="badge" id="countView">0</span>
</div>

<div class="pagination" id="pager" style="display:none;">
  <button class="btn" id="prevPage">â†</button>
  <span id="pageInfo" class="muted"></span>
  <button class="btn" id="nextPage">â†’</button>
</div>
    <div>
      <h2 style="margin:0">ĞĞ´Ğ¼Ñ–Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ: ĞºĞµÑ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°Ğ¼Ğ¸</h2>
      <div class="muted" id="hello">ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°â€¦</div>
    </div>
    <div>
      <a href="/admin/tilesets" class="btn" id="openTilesets" title="Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ tilesets">ğŸ§© Tilesets</a>
      <a href="/admin/stats.html" class="btn" id="openStats" title="Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ³Ñ€Ğ°Ñ„Ñ–ĞºĞ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸">ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</a>
      <a href="/index.html" class="btn" id="backToMap" title="ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ½Ğ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ñƒ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºÑƒ (ĞºĞ°Ñ€Ñ‚Ñƒ)">ğŸ  ĞĞ° ĞºĞ°Ñ€Ñ‚Ñƒ</a>
      <button id="btnLogout" class="btn" style="display:none;">Ğ’Ğ¸Ğ¹Ñ‚Ğ¸</button>
    </div>
  </header>

  <p id="status">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</p>
  <div id="user-list"></div>

  <script>
/* ================= Firebase init ================= */
const CFG = window.APP_CONFIG?.firebase;
if (!CFG) {
  document.getElementById('status').textContent =
    'ĞĞµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ APP_CONFIG.firebase. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ /config/config.js Ñ‚Ğ° ÑˆĞ»ÑÑ… Ñƒ <script src="/config/config.js">';
  console.error('APP_CONFIG.firebase is missing');
  document.documentElement.style.visibility = 'visible';
} else {
  try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) { console.error(e); }
}
const db   = firebase.firestore();
const auth = firebase.auth();

// (toast helper removed)

/* ================= DOM Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ ================= */
const loginURL  = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
const helloEl   = document.getElementById('hello');
const statusEl  = document.getElementById('status');
const listEl    = document.getElementById('user-list');
const btnLogout = document.getElementById('btnLogout');

/* ====== Ğ”ĞĞ’Ğ†Ğ”ĞĞ˜Ğš Ğ¥ĞĞ‘Ğ†Ğ’ (Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ¹ Ğ·Ğ° Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸) ====== */
const HUBS = ['Ğ’Ñ–Ğ½Ğ½Ğ¸Ñ†ÑŒĞºĞ¸Ğ¹','Ğ—Ğ°Ñ…Ñ–Ğ´Ğ½Ğ¸Ğ¹','Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹','Ğ£Ñ€Ğ¾Ğ¶Ğ°Ğ¹Ğ½Ğ° ĞºÑ€Ğ°Ñ—Ğ½Ğ°','ĞœĞ¥ĞŸ'];

let currentUser = null;
let unsubscribeUsers = null;

btnLogout.addEventListener('click', async () => {
  try { await auth.signOut(); } catch(e) { console.warn(e); }
});

/* ===== Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ñ€Ğ¾Ğ»Ñ– Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° ===== */
async function resolveUserRole(uid){
  try {
    const udoc = await db.collection('users').doc(uid).get({ source: 'server' });
    if (udoc.exists) {
      const d = udoc.data() || {};
      const role = d.role ? String(d.role) : 'pending';
      const displayName = (d.displayName && typeof d.displayName === 'string' && d.displayName.trim())
        ? d.displayName.trim()
        : '';
      return { role, displayName };
    }
  } catch(e){ console.warn('users role read (server) failed', e); }

  try {
    const udoc2 = await db.collection('users').doc(uid).get();
    if (udoc2.exists) {
      const d = udoc2.data() || {};
      const role = d.role ? String(d.role) : 'pending';
      const displayName = (d.displayName && typeof d.displayName === 'string' && d.displayName.trim())
        ? d.displayName.trim()
        : '';
      return { role, displayName };
    }
  } catch(e){ console.warn('users role read (cache) failed', e); }

  try {
    const rdoc = await db.collection('roles').doc(uid).get({ source: 'server' });
    if (rdoc.exists && rdoc.data()?.role) return String(rdoc.data().role);
  } catch(e){ console.warn('roles fallback read failed', e); }

  return 'pending';
}

/* ===== ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ– / ÑÑ‚Ğ°Ğ½ ÑĞ¿Ğ¸ÑĞºÑƒ ===== */
const PAGE_SIZE = 30;
const toolbar = {
  q: document.getElementById('q'),
  role: document.getElementById('filterRole'),
  hub: document.getElementById('filterHub'),
  onlyPending: document.getElementById('pendingOnly'),
  sortBy: document.getElementById('sortBy'),
  compact: document.getElementById('btnCompact'),
  count: document.getElementById('countView'),
};
const pager = {
  box: document.getElementById('pager'),
  prev: document.getElementById('prevPage'),
  next: document.getElementById('nextPage'),
  info: document.getElementById('pageInfo'),
};

let allUsers = [];    // ÑĞ¸Ñ€Ñ– Ğ´Ğ°Ğ½Ñ– Ğ· Firestore
let page = 0;        // Ğ½Ğ¾Ğ¼ĞµÑ€ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºĞ¸
const F = { q:'', role:'', hub:'', onlyPending:false, sort:'created_desc' };

/* Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¼Ğ¾ ÑĞµĞ»ĞµĞºÑ‚ Ñ…Ğ°Ğ±Ñ–Ğ² */
(function fillHubSelect(){
  const sel = toolbar.hub;
  HUBS.forEach(h => {
    const o = document.createElement('option');
    o.value = h; o.textContent = h;
    sel.appendChild(o);
  });
})();

/* Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ */
(function restoreCompact(){
  const on = localStorage.getItem('admin.compact') === '1';
  document.body.classList.toggle('compact', on);
})();
toolbar.compact.addEventListener('click', () => {
  const on = !document.body.classList.contains('compact');
  document.body.classList.toggle('compact', on);
  localStorage.setItem('admin.compact', on ? '1' : '0');
});

/* Ğ´Ñ€Ñ–Ğ±Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ¼Ñ–Ñ‡Ğ½Ğ¸Ğº */
function toLower(s){ return String(s || '').toLowerCase(); }
function getCreatedMs(u){
  const t = u.createdAt || u.created_at || null;
  if (!t) return 0;
  if (t.seconds != null) return t.seconds*1000 + (t.nanoseconds||0)/1e6;
  const d = new Date(t); return isNaN(d) ? 0 : d.getTime();
}
/* ===== ĞšĞ¾Ğ»Ğ°Ğ¿Ñ Ğ³Ñ€ÑƒĞ¿ (Ğ¿Ğ°Ğ¼'ÑÑ‚ÑŒ Ñƒ localStorage) ===== */
const COLLAPSE_KEY = 'admin.collapsedRoles.v1';
let _collapsed = (()=>{ try { return JSON.parse(localStorage.getItem(COLLAPSE_KEY)||'{}'); } catch { return {}; } })();
const isCollapsed = (roleKey) => _collapsed[roleKey] !== false; // Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚ = collapsed
const setCollapsed = (roleKey, val) => {
  _collapsed[roleKey] = !!val;
  try { localStorage.setItem(COLLAPSE_KEY, JSON.stringify(_collapsed)); } catch {}
};

/* ===== Ğ¢Ñ€ĞµĞºÑ–Ğ½Ğ³ Ğ·Ğ¼Ñ–Ğ½ Ñ…Ğ°Ğ±Ñ–Ğ² Ñƒ Ñ€ÑĞ´ĞºÑƒ ===== */
const normHubs = (arr) => {
  if (Array.isArray(arr) && arr.includes('*')) return ['*'];
  return (Array.isArray(arr) ? arr.slice() : []).map(String).sort();
};
function setHubsSnapshot(row, hubs){ row.dataset.hubsnap = JSON.stringify(normHubs(hubs)); }
function isHubsDirty(row){
  const cur = normHubs(buildAllowedHubsFromRow(row));
  const prev = (()=>{ try { return JSON.parse(row.dataset.hubsnap||'[]'); } catch { return []; } })();
  return JSON.stringify(cur) !== JSON.stringify(prev);
}
function updateSaveBtnState(row){
  const btn = row.querySelector('.save-hubs');
  if (btn) btn.disabled = !isHubsDirty(row);
}

/* Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ + ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñƒ Ğ¿Ğ°Ğ¼'ÑÑ‚Ñ– */
function applyFilters(){
  const q = toLower(F.q);
  const filtered = allUsers.filter(u => {
    if (F.role && toLower(u.role) !== F.role) return false;
    if (F.onlyPending && toLower(u.role) !== 'pending') return false;
    

    if (F.hub){
      const hubs = Array.isArray(u.allowedHubs) ? u.allowedHubs : [];
      const seeAll = hubs.includes('*') || ['admin','security'].includes(toLower(u.role));
      if (!seeAll && !hubs.includes(F.hub)) return false;
    }

    if (q){
      const hay = `${u.displayName||''} ${u.email||''}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  // ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  const arr = filtered.slice();
  const byName = (u) => toLower(u.displayName || u.email);
  switch(F.sort){
    case 'created_asc':  arr.sort((a,b)=> getCreatedMs(a) - getCreatedMs(b)); break;
    case 'name_asc':     arr.sort((a,b)=> byName(a).localeCompare(byName(b),'uk')); break;
    case 'name_desc':    arr.sort((a,b)=> byName(b).localeCompare(byName(a),'uk')); break;
    case 'role_asc':     arr.sort((a,b)=> toLower(a.role).localeCompare(toLower(b.role),'uk') || byName(a).localeCompare(byName(b),'uk')); break;
    default:             arr.sort((a,b)=> getCreatedMs(b) - getCreatedMs(a)); // created_desc
  }
  return arr;
}

/* Ñ€ĞµĞ½Ğ´ĞµÑ€ ÑĞ¿Ğ¸ÑĞºÑƒ Ñ–Ğ· Ğ³Ñ€ÑƒĞ¿ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ·Ğ° Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸ + Ğ¿Ğ°Ğ³Ñ–Ğ½Ğ°Ñ†Ñ–Ñ */
function renderUsers(){
  const data = applyFilters();
  toolbar.count.textContent = `${data.length} ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ²`;

  // Ğ¿Ğ°Ğ³Ñ–Ğ½Ğ°Ñ†Ñ–Ñ
  const pages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
  page = Math.min(Math.max(0, page), pages-1);
  pager.box.style.display = data.length > PAGE_SIZE ? '' : 'none';
  pager.info.textContent = `${page+1} / ${pages}`;
  pager.prev.disabled = page <= 0;
  pager.next.disabled = page >= pages-1;

  const start = page * PAGE_SIZE;
  const slice = data.slice(start, start + PAGE_SIZE);

  // Ğ³Ñ€ÑƒĞ¿ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ° Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ñ–Ğ¹ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½Ñ†Ñ–
  const rolesOrder = ['pending','user','logist','security','admin'];
  const byRole = new Map();
  slice.forEach(u => {
    const r = (u.role || 'pending').toLowerCase();
    if (!byRole.has(r)) byRole.set(r, []);
    byRole.get(r).push(u);
  });

  listEl.innerHTML = '';

  const addSection = (roleKey) => {
    const items = byRole.get(roleKey) || [];
    if (!items.length) return;

    const sec = document.createElement('section');
    sec.className = 'section';
    sec.dataset.role = roleKey;
    if (isCollapsed(roleKey)) sec.classList.add('collapsed');

    const h = document.createElement('h3');
    h.className = 'group-h';
    h.setAttribute('data-role', roleKey);
    h.setAttribute('tabindex', '0');
    h.innerHTML = `<span class="arrow">â–¸</span>${roleKey.toUpperCase()} (${items.length})`;
    sec.appendChild(h);

    const body = document.createElement('div');
    body.className = 'section-body';
    items.forEach(u => body.insertAdjacentHTML('beforeend', userRowHTML(u.id, u)));
    sec.appendChild(body);

    listEl.appendChild(sec);
  };

  rolesOrder.forEach(addSection);
  Array.from(byRole.keys())
    .filter(k => !rolesOrder.includes(k))
    .sort()
    .forEach(addSection);

  // Ğ´ĞµĞ»ĞµĞ³Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ»Ñ–Ğº/ĞºĞ»Ğ°Ğ²Ñ–Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ
  listEl.addEventListener('click', (e) => {
    const h = e.target.closest('h3.group-h'); if (!h) return;
    const sec = h.closest('.section'); const role = h.dataset.role;
    const nowCollapsed = !sec.classList.contains('collapsed') ? true : false;
    sec.classList.toggle('collapsed', nowCollapsed);
    setCollapsed(role, nowCollapsed);
  }, { once:false });

  listEl.addEventListener('keydown', (e) => {
    const h = e.target.closest('h3.group-h'); if (!h) return;
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); h.click(); }
  }, { once:false });

  // Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ñ–Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ–ÑÑ‚ÑŒ
  bindRoleChangeHandlers();
  bindNameChangeHandlers();
  bindHubHandlers();
  bindTestModeHandlers(); // ğŸ§ª Ğ¿ĞµÑ€ĞµĞ¼Ğ¸ĞºĞ°Ñ‡ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ
  bindAdditionalRolesHandlers(); // ğŸ”‘ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€Ğ¾Ğ»Ñ–
  bindDeleteHandlers();
}

/* Ğ¿Ğ¾Ğ´Ñ–Ñ— Ğ¿Ğ°Ğ½ĞµĞ»Ñ– */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const rerender = debounce(() => { page = 0; renderUsers(); }, 150);
toolbar.q.addEventListener('input',  e => { F.q = e.target.value; rerender(); });
toolbar.role.addEventListener('change', e => { F.role = e.target.value; rerender(); });
toolbar.hub.addEventListener('change',  e => { F.hub  = e.target.value; rerender(); });
toolbar.onlyPending.addEventListener('change', e => { F.onlyPending = e.target.checked; rerender(); });
toolbar.sortBy.addEventListener('change', e => { F.sort = e.target.value; rerender(); });
// (hideDisabled control removed)
pager.prev.addEventListener('click', () => { page = Math.max(0, page-1); renderUsers(); });
pager.next.addEventListener('click', () => { page = page+1; renderUsers(); });

/* ================= Guard + Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ================= */
auth.onAuthStateChanged(async (u) => {
  currentUser = u || null;

  if (!u) {
    statusEl.textContent = 'ĞĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ğ¾ ÑƒĞ²Ñ–Ğ¹Ñ‚Ğ¸.';
    location.replace(loginURL);
    return;
  }

  let role = 'pending';
  let displayNameFromFirestore = '';
  try {
    const result = await resolveUserRole(u.uid);
    role = String(result.role || 'pending').trim().toLowerCase();
    displayNameFromFirestore = result.displayName || '';
  } catch(e){ console.error(e); }
  
  {
    const dn = displayNameFromFirestore
      || (u && typeof u.displayName === 'string' && u.displayName.trim())
      || (`Ğ¥Ñ‚Ğ¾ÑÑŒ Ğ½Ğµ Ğ¼Ñ–ÑÑ†ĞµĞ²Ğ¸Ğ¹ Ñ– ${u.email || u.uid}`);
    helloEl.textContent = 'Ğ£Ğ²Ñ–Ğ¹ÑˆĞ»Ğ¸ ÑĞº ' + dn;
  }
  btnLogout.style.display = '';
  if (role !== 'admin') {
    statusEl.textContent = 'â›” Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ±Ğ¾Ñ€Ğ¾Ğ½ĞµĞ½Ğ¾ (Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ° Ñ€Ğ¾Ğ»ÑŒ admin)';
    document.documentElement.style.visibility = 'visible';
    setTimeout(()=>location.replace('/'), 1200);
    return;
  }

  statusEl.textContent = 'âœ… Ğ’Ğ¸ ÑƒĞ²Ñ–Ğ¹ÑˆĞ»Ğ¸ ÑĞº Ğ°Ğ´Ğ¼Ñ–Ğ½';
  document.documentElement.style.visibility = 'visible';
  loadUsers();
});

/* ================= Ğ ĞµĞ½Ğ´ĞµÑ€ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ·ĞµÑ€Ğ° (Ğ· Ñ€Ğ¾Ğ»Ğ»Ñ Ñ‚Ğ° Ñ…Ğ°Ğ±Ğ°Ğ¼Ğ¸) ================= */
function userRowHTML(id, user){
  const name    = user.displayName || user.email || id;
  const email   = user.email ? ` â€¢ ${user.email}` : '';
  const role    = (user.role || 'pending').toLowerCase();
  const created = user.createdAt || user.created_at || '';

  const allowedHubs = Array.isArray(user.allowedHubs)
    ? user.allowedHubs
    : ((role === 'admin' || role === 'security') ? ['*'] : []);

  const seeAll = allowedHubs.includes('*') || role === 'admin' || role === 'security';

  const hubsHTML = `
    <label>
      <input type="checkbox" class="hub-all" ${seeAll ? 'checked' : ''}>
      <b>Ğ’ÑÑ– Ñ…Ğ°Ğ±Ğ¸</b>
    </label>
    ${HUBS.map(h => `
      <label>
        <input type="checkbox" class="hub-chk" data-hub="${escapeHtml(h)}"
               ${(seeAll || allowedHubs.includes(h)) ? 'checked' : ''} ${(seeAll ? 'disabled' : '')}>
        <span>${escapeHtml(h)}</span>
      </label>
    `).join('')}
  `;

  return `
    <div class="user-row" data-uid="${id}">
      <div>
        <b>${escapeHtml(name)}</b>
        <span class="user-meta">(${escapeHtml(role)})${email ? ' â€¢ ' + escapeHtml(email) : ''}${created ? ' â€¢ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾: ' + escapeHtml(created) : ''}</span>
      </div>
      
      <div class="name-edit-wrap">
        <input type="text" class="name-input" data-id="${id}" placeholder="Ğ†Ğ¼'Ñ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°" value="${escapeHtml(user.displayName || '')}" data-original="${escapeHtml(user.displayName || '')}">
        <button class="btn save-name" data-id="${id}" disabled title="Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ñ–Ğ¼'Ñ">âœï¸ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ñ–Ğ¼'Ñ</button>
      </div>

      <div class="row-actions">
        <label>ĞÑĞ½Ğ¾Ğ²Ğ½Ğ° Ñ€Ğ¾Ğ»ÑŒ:
          <select data-id="${id}" data-prev="${role}" class="role-select">
            <option value="pending"  ${role==="pending" ?"selected":""}>ĞÑ‡Ñ–ĞºÑƒÑ”</option>
            <option value="user"     ${role==="user"    ?"selected":""}>User</option>
            <option value="logist"   ${role==="logist"  ?"selected":""}>Logist</option>
            <option value="security" ${role==="security"?"selected":""}>Security</option>
            <option value="admin"    ${role==="admin"   ?"selected":""}>Admin</option>
          </select>
        </label>

        <label style="display:flex; align-items:center; gap:6px; margin-left:12px;">
          <span style="font-size:13px; color:#64748b;">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€Ğ¾Ğ»Ñ–:</span>
          <label style="margin-left:8px;"><input type="checkbox" class="additional-role-chk" data-id="${id}" data-role="logist" ${(user.additionalRoles || []).includes('logist') ? 'checked' : ''}> Logist</label>
          <label style="margin-left:8px;"><input type="checkbox" class="additional-role-chk" data-id="${id}" data-role="security" ${(user.additionalRoles || []).includes('security') ? 'checked' : ''}> Security</label>
        </label>

        <label style="display:flex; align-items:center; gap:6px; margin-left:12px;" title="ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ±Ğ°Ñ‡Ğ¸Ñ‚Ğ¸Ğ¼Ğµ Ğ»Ğ¸ÑˆĞµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ– Ğ´Ğ°Ğ½Ñ– Ğ· Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ—">
          <input type="checkbox" class="testmode-toggle" data-id="${id}" ${user.testMode === true ? 'checked' : ''}>
          <span>ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ– Ğ´Ğ°Ğ½Ñ–</span>
        </label>

        <button class="btn save-hubs" data-id="${id}">ğŸ’¾ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´Ğ¾ Ñ…Ğ°Ğ±Ñ–Ğ²</button>
        <button class="btn btn-delete" data-id="${id}" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ· Ğ±Ğ°Ğ·Ğ¸ (Ñ‚Ğ° Ğ¾Ğ¿Ñ†Ñ–Ğ¹Ğ½Ğ¾ Ğ· Auth)">ğŸ—‘ Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸</button>
      </div>

      <div class="hubs-wrap" style="margin-top:6px;">
        <div class="muted" style="margin-bottom:4px;">Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´Ğ¾ Ñ…Ğ°Ğ±Ñ–Ğ²:</div>
        ${hubsHTML}
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ================= Live-Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ users ================= */
function loadUsers(){
  try { if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; } } catch {}
  unsubscribeUsers = db.collection('users')
    .orderBy('role')                // Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ‰Ğ¾Ğ± Ğ±ÑƒĞ² ÑÑ‚Ğ°Ğ±Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ñƒ ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚Ñ–
    .onSnapshot((snap) => {
      allUsers = [];
      snap.forEach(doc => allUsers.push({ id: doc.id, ...(doc.data() || {}) }));
      renderUsers();
    }, (err) => {
      console.error('onSnapshot(users) error:', err);
      statusEl.textContent = 'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ²: ' + (err.message || err);
    });
}

/* ================= ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñ€Ğ¾Ğ»ĞµĞ¹ ================= */
function bindRoleChangeHandlers(){
  document.querySelectorAll('#user-list .user-row .role-select').forEach((sel) => {
    sel.addEventListener('change', async (e) => {
      const row      = e.target.closest('.user-row');
      const uid      = e.target.dataset.id;
      const newRole  = e.target.value;
      const prevRole = e.target.getAttribute('data-prev') || '';

      // Ğ·Ğ°Ñ…Ğ¸ÑÑ‚: Ğ½Ğµ Ğ´ĞµĞ¼Ğ¾Ñ‚Ğ¸Ğ¼Ğ¾ ÑĞµĞ±Ğµ
      if (currentUser && uid === currentUser.uid && newRole !== 'admin') {
        alert('ĞĞµ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ·Ğ½Ñ–Ğ¼Ğ°Ñ‚Ğ¸ Ğ· ÑĞµĞ±Ğµ Ñ€Ğ¾Ğ»ÑŒ admin.');
        e.target.value = 'admin';
        return;
      }

      // Ğ’Ñ–Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ğ¼Ğ¾/Ñ€Ğ¾Ğ·Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ğ¼Ğ¾ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¸ Ñ…Ğ°Ğ±Ñ–Ğ² Ğ¿Ñ–Ğ´ Ğ½Ğ¾Ğ²Ñƒ Ñ€Ğ¾Ğ»ÑŒ
      applyRoleHubLock(row, newRole);

      e.target.disabled = true;
      statusEl.textContent = `ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ€Ğ¾Ğ»Ñ– ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° ${uid} â†’ ${newRole}â€¦`;

      try {
        const batch = db.batch();
        const uref  = db.collection('users').doc(uid);

        // 1) Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ€Ğ¾Ğ»ÑŒ
        batch.set(uref, {
          role: newRole,
          roleUpdatedAt: new Date().toISOString(),
          roleUpdatedBy: currentUser ? currentUser.uid : null
        }, { merge: true });

        // 2) ÑĞºÑ‰Ğ¾ admin/security â€” Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼Ğ¾ allowedHubs=['*']
        if (newRole === 'admin' || newRole === 'security') {
          batch.set(uref, { allowedHubs: ['*'] }, { merge: true });
        }

        // Ğ°ÑƒĞ´Ğ¸Ñ‚
        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'role_change',
          targetUid: uid,
          newRole,
          prevRole,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });

        await batch.commit();

        e.target.setAttribute('data-prev', newRole);
        statusEl.textContent = `âœ… Ğ Ğ¾Ğ»ÑŒ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${uid} â†’ ${newRole}`;
        // Ğ¿Ñ–ÑĞ»Ñ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾Ñ— Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñ€Ğ¾Ğ»Ñ– â€” ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ğ½ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ñ…Ğ°Ğ±Ğ¸"
        setHubsSnapshot(row, buildAllowedHubsFromRow(row));
        updateSaveBtnState(row);
      } catch (err) {
        console.error(err);
        alert('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñ€Ğ¾Ğ»Ñ–: ' + (err.message || err));
        // Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸ Ğ²Ñ–Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾
        e.target.value = prevRole || 'pending';
        applyRoleHubLock(row, e.target.value);
        statusEl.textContent = 'âŒ ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ñ€Ğ¾Ğ»ÑŒ.';
      } finally {
        e.target.disabled = false;
      }
    });
  });
}

/* ================= ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ¼Ñ–Ğ½Ğ¸ displayName ================= */
function bindNameChangeHandlers(){
  document.querySelectorAll('#user-list .user-row .name-input').forEach((input) => {
    const btn = input.parentElement.querySelector('.save-name');
    
    // Ğ’Ñ–Ğ´ÑĞ»Ñ–Ğ´ĞºĞ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ² Ñ–Ğ½Ğ¿ÑƒÑ‚Ñ–
    input.addEventListener('input', () => {
      const original = input.getAttribute('data-original') || '';
      const current = input.value.trim();
      btn.disabled = (current === original);
    });
    
    // Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ displayName
    btn?.addEventListener('click', async () => {
      const uid = input.dataset.id;
      const newName = input.value.trim();
      const original = input.getAttribute('data-original') || '';
      
      if (newName === original) return;
      
      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = 'Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñâ€¦';
      statusEl.textContent = `ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ–Ğ¼ĞµĞ½Ñ– ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° ${uid}â€¦`;
      
      try {
        const batch = db.batch();
        const uref = db.collection('users').doc(uid);
        
        batch.set(uref, {
          displayName: newName || null,
          displayNameUpdatedAt: new Date().toISOString(),
          displayNameUpdatedBy: currentUser ? currentUser.uid : null
        }, { merge: true });
        
        // Ğ°ÑƒĞ´Ğ¸Ñ‚
        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'displayName_change',
          targetUid: uid,
          newName,
          prevName: original,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });
        
        await batch.commit();
        
        input.setAttribute('data-original', newName);
        btn.disabled = true;
        btn.textContent = 'âœ… Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾';
        statusEl.textContent = `âœ… Ğ†Ğ¼'Ñ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${uid}`;
        
        setTimeout(() => btn.textContent = prevText, 900);
      } catch (err) {
        console.error(err);
        alert('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñ–Ğ¼ĞµĞ½Ñ–: ' + (err.message || err));
        btn.textContent = prevText;
        btn.disabled = false;
        statusEl.textContent = 'âŒ ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ñ–Ğ¼\'Ñ.';
      }
    });
  });
}

/* ================= Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ¸ Ğ´Ğ¾ Ñ…Ğ°Ğ±Ñ–Ğ² ================= */
// Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ğ¼Ğ¾/Ñ€Ğ¾Ğ·Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ğ¼Ğ¾ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¸ Ñ…Ğ°Ğ±Ñ–Ğ² Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ñ€Ğ¾Ğ»Ñ– Ğ°Ğ±Ğ¾ Ğ¿ĞµÑ€ĞµĞ¼Ğ¸ĞºĞ°Ñ‡Ğ° "Ğ²ÑÑ– Ñ…Ğ°Ğ±Ğ¸"
function applyRoleHubLock(row, roleNow){
  const star     = row.querySelector('.hub-all');
  const hubBoxes = row.querySelectorAll('.hub-chk');

  const forceAll = (roleNow === 'admin' || roleNow === 'security');
  if (forceAll && star) star.checked = true;

  const all = (star?.checked) || forceAll;

  hubBoxes.forEach(chk => {
    chk.disabled = all;
    if (all) chk.checked = true; // Ğ´Ğ»Ñ ÑÑĞ½Ğ¾ÑÑ‚Ñ– Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑƒ
  });
}

// Ğ·Ğ±Ñ–Ñ€ allowedHubs Ñ–Ğ· Ñ€ÑĞ´ĞºĞ° ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°
function buildAllowedHubsFromRow(row){
  const role = row.querySelector('.role-select')?.value || 'pending';
  const star = row.querySelector('.hub-all')?.checked;

  if (role === 'admin' || role === 'security' || star) return ['*'];

  const hubs = Array.from(row.querySelectorAll('.hub-chk'))
    .filter(ch => ch.checked)
    .map(ch => ch.getAttribute('data-hub'));

  return hubs;
}

// Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·ĞºĞ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ¸ Ğ´Ğ¾ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑÑ–Ğ²/ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
function bindHubHandlers(){
  document.querySelectorAll('#user-list .user-row').forEach(row => {
    const roleSel   = row.querySelector('.role-select');
    const star      = row.querySelector('.hub-all');
    const saveBtn   = row.querySelector('.save-hubs');

    // Ğ¿ĞµÑ€Ğ²Ğ¸Ğ½Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
    applyRoleHubLock(row, roleSel.value);
    setHubsSnapshot(row, buildAllowedHubsFromRow(row)); // Ğ·Ğ½ÑĞ»Ğ¸ "ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚"
    updateSaveBtnState(row);                             // ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ°

    // Ğ²Ñ–Ğ´ÑĞ»Ñ–Ğ´ĞºĞ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñƒ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ°Ñ…
    star?.addEventListener('change', () => {
      applyRoleHubLock(row, roleSel.value);
      updateSaveBtnState(row);
    });
    row.querySelectorAll('.hub-chk').forEach(ch =>
      ch.addEventListener('change', () => updateSaveBtnState(row))
    );

    // Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ allowedHubs
    saveBtn?.addEventListener('click', async () => {
      const uid  = row.dataset.uid;
      const hubs = buildAllowedHubsFromRow(row);

      try{
        saveBtn.disabled = true;
        saveBtn.textContent = 'Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñâ€¦';

        const batch = db.batch();
        const uref  = db.collection('users').doc(uid);
        batch.set(uref, { allowedHubs: hubs }, { merge: true });

        const auditRef = db.collection('audit').doc();
        batch.set(auditRef, {
          type: 'hubs_change',
          targetUid: uid,
          allowedHubs: hubs,
          by: currentUser ? currentUser.uid : null,
          at: new Date().toISOString()
        });

        await batch.commit();

        // Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ¸ "ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚" â€” ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ·Ğ½Ğ¾Ğ²Ñƒ Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ°
        setHubsSnapshot(row, hubs);
        updateSaveBtnState(row);

        saveBtn.textContent = 'âœ… Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾';
        setTimeout(()=> saveBtn.textContent = 'ğŸ’¾ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´Ğ¾ Ñ…Ğ°Ğ±Ñ–Ğ²', 900);
      }catch(e){
        console.error(e);
        alert('ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ¸: ' + (e?.message || e));
        saveBtn.textContent = 'ğŸ’¾ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´Ğ¾ Ñ…Ğ°Ğ±Ñ–Ğ²';
        updateSaveBtnState(row); // Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ĞµĞ¼Ğ¾ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
      }
    });
  });
}

/* (block/unblock logic removed) */

/* ================= ĞŸĞµÑ€ĞµĞ¼Ğ¸ĞºĞ°Ñ‡ testMode ================= */
function bindTestModeHandlers(){
  document.querySelectorAll('#user-list .user-row .testmode-toggle').forEach((chk) => {
    chk.addEventListener('change', async (e) => {
      const uid = e.target.dataset.id;
      const testMode = e.target.checked;
      
      e.target.disabled = true;
      statusEl.textContent = `ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ testMode Ğ´Ğ»Ñ ${uid}â€¦`;
      
      try {
        await db.collection('users').doc(uid).set({
          testMode: testMode,
          testModeUpdatedAt: new Date().toISOString(),
          testModeUpdatedBy: currentUser ? currentUser.uid : null
        }, { merge: true });
        
        statusEl.textContent = `âœ… TestMode Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${uid} â†’ ${testMode ? 'Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ– Ğ´Ğ°Ğ½Ñ–' : 'Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ–'}`;
      } catch (err) {
        console.error(err);
        alert('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ testMode: ' + (err.message || err));
        e.target.checked = !testMode; // Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸
        statusEl.textContent = 'âŒ ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ testMode.';
      } finally {
        e.target.disabled = false;
      }
    });
  });
}

/* ================= Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€Ğ¾Ğ»Ñ– ================= */
function bindAdditionalRolesHandlers(){
  document.querySelectorAll('#user-list .user-row .additional-role-chk').forEach((chk) => {
    chk.addEventListener('change', async (e) => {
      const uid = e.target.dataset.id;
      const role = e.target.dataset.role;
      const isChecked = e.target.checked;
      
      e.target.disabled = true;
      statusEl.textContent = `ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ñ… Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ»Ñ ${uid}â€¦`;
      
      try {
        // Ğ§Ğ¸Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ñ– Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€Ğ¾Ğ»Ñ–
        const docSnap = await db.collection('users').doc(uid).get();
        const currentData = docSnap.data() || {};
        let additionalRoles = Array.isArray(currentData.additionalRoles) ? [...currentData.additionalRoles] : [];
        
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ°Ğ±Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ñ€Ğ¾Ğ»ÑŒ
        if (isChecked) {
          if (!additionalRoles.includes(role)) {
            additionalRoles.push(role);
          }
        } else {
          additionalRoles = additionalRoles.filter(r => r !== role);
        }
        
        await db.collection('users').doc(uid).set({
          additionalRoles: additionalRoles,
          additionalRolesUpdatedAt: new Date().toISOString(),
          additionalRolesUpdatedBy: currentUser ? currentUser.uid : null
        }, { merge: true });
        
        statusEl.textContent = `âœ… Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€Ğ¾Ğ»Ñ– Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${uid} â†’ [${additionalRoles.join(', ')}]`;
      } catch (err) {
        console.error(err);
        alert('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ñ… Ñ€Ğ¾Ğ»ĞµĞ¹: ' + (err.message || err));
        e.target.checked = !isChecked; // Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸
        statusEl.textContent = 'âŒ ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€Ğ¾Ğ»Ñ–.';
      } finally {
        e.target.disabled = false;
      }
    });
  });
}

/* ================= Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ² (Ğ°Ğ´Ğ¼Ñ–Ğ½) ================= */
async function apiDeleteUser(uid, deleteAuth){
  const u = auth.currentUser; if (!u) throw new Error('not-authenticated');
  const token = await u.getIdToken();
  const r = await fetch('/api/users/delete', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ uid, deleteAuth: !!deleteAuth })
  });
  const ct = r.headers.get('content-type') || '';
  const body = ct.includes('application/json') ? (await r.json().catch(()=>({}))) : {};
  if (r.ok && body && body.ok) return body;
  const text = !r.ok ? `${r.status}` : 'invalid-response';
  throw new Error(text);
}

function bindDeleteHandlers(){
  document.querySelectorAll('#user-list .user-row .btn-delete').forEach(btn => {
    btn.addEventListener('click', async () => {
      const row = btn.closest('.user-row');
      const uid = row?.dataset?.uid;
      if (!uid) return;
      if (currentUser && uid === currentUser.uid){ alert('ĞĞµ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ²Ğ»Ğ°ÑĞ½Ğ¸Ğ¹ Ğ°ĞºĞ°ÑƒĞ½Ñ‚.'); return; }

      const really = confirm('Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ· Ğ±Ğ°Ğ·Ğ¸ (users, roles) Ñ‚Ğ° Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ñƒ? Ğ”Ñ–Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ° ÑĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸.');
      if (!really) return;
      const alsoAuth = confirm('Ğ¢Ğ°ĞºĞ¾Ğ¶ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ¾Ğ±Ğ»Ñ–ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸Ñ Ñƒ Firebase Auth (Ğ·Ğ°Ğ±Ğ¾Ñ€Ğ¾Ğ½Ğ¸Ñ‚Ğ¸ Ğ»Ğ¾Ğ³Ñ–Ğ½)? ĞĞš â€” Ñ‚Ğ°Ğº, Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸ â€” Ğ»Ğ¸ÑˆĞµ Ğ· Ğ±Ğ°Ğ·Ğ¸.');

      btn.disabled = true; const prevText = btn.textContent; btn.textContent = 'Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñâ€¦';
      try{
        try{
          await apiDeleteUser(uid, alsoAuth);
        }catch(e){
          // Fallback: Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ Ğ· Firestore (ÑĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑÑ‚ÑŒ)
          await Promise.allSettled([
            db.collection('users').doc(uid).delete(),
            db.collection('roles').doc(uid).delete(),
            db.collection('audit').add({ type:'user_delete', targetUid: uid, by: currentUser ? currentUser.uid : null, at: new Date().toISOString(), via:'client-fallback' })
          ]);
        }
        btn.textContent = 'âœ… Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ¾';
        setTimeout(()=>{ btn.textContent = prevText; btn.disabled = false; }, 800);
      }catch(err){
        console.error(err);
        alert('ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°: ' + (err.message || err));
        btn.textContent = prevText; btn.disabled = false;
      }
    });
  });
}

/* ================= Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° ================= */
window.addEventListener('error', (e) => {
  try {
    document.documentElement.style.visibility = 'visible';
    statusEl.textContent = 'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°: ' + (e.message || '');
  } catch {}
});
  </script>
</body>
</html>
