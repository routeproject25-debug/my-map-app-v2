<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>üë®‚Äçüíª –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    /* –•–æ–≤–∞—î–º–æ DOM, –¥–æ–∫–∏ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Ä–æ–ª—å */
    html { visibility: hidden; }

    body { font-family: Arial, sans-serif; padding:20px; margin:0; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .muted { color:#6b7280; font-size:13px; }
    .btn { cursor:pointer; border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:6px 10px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .user-row { margin-bottom: 10px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .user-row b { font-size:15px; }
    .user-meta { color:#6b7280; font-size:12px; margin-left:6px; }
    .row-actions { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select { margin-left:10px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; }
    #user-list { margin-top:12px; }
    #status { margin: 6px 0 10px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h2 style="margin:0">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å: –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h2>
      <div class="muted" id="hello">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</div>
    </div>
    <div>
      <button id="btnLogout" class="btn" style="display:none;">–í–∏–π—Ç–∏</button>
    </div>
  </header>

  <p id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
  <div id="user-list"></div>

  <script>
    // üîß Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDjDBZkmy-skuDEQF8-AkRma7yw6TugoQc",
      authDomain: "my-map-app-58312.firebaseapp.com",
      projectId: "my-map-app-58312",
      storageBucket: "my-map-app-58312.firebasestorage.app",
      messagingSenderId: "53260611353",
      appId: "1:53260611353:web:f25e120996ad8305405f88",
      measurementId: "G-9LRX1FLTKL"
    };

    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const db   = firebase.firestore();
    const auth = firebase.auth();

    const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname + location.search);
    const helloEl  = document.getElementById('hello');
    const statusEl = document.getElementById('status');
    const listEl   = document.getElementById('user-list');
    const btnLogout = document.getElementById('btnLogout');

    let currentUser = null;
    let unsubscribeUsers = null;

    btnLogout.addEventListener('click', async () => {
      try { await auth.signOut(); } catch(e) { console.warn(e); }
    });

    // –û—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–ª—å –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (users/{uid}.role, fallback roles/{uid}.role)
    async function resolveUserRole(uid){
      try {
        const udoc = await db.collection('users').doc(uid).get();
        if (udoc.exists && udoc.data()?.role) return String(udoc.data().role);
      } catch(e){ console.warn('users role read failed', e); }
      try {
        const rdoc = await db.collection('roles').doc(uid).get();
        if (rdoc.exists && rdoc.data()?.role) return String(rdoc.data().role);
      } catch(e){ console.warn('roles fallback read failed', e); }
      return 'pending';
    }

    // ===== Guard –Ω–∞ –≤—Ö—ñ–¥ + —Ä–æ–ª—å admin
    auth.onAuthStateChanged(async (u) => {
      currentUser = u || null;

      if (!u) {
        statusEl.textContent = '–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏.';
        // –ü—ñ—Å–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ä–æ–±–∏–º–æ —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥—ñ–Ω
        location.replace(loginURL);
        return;
      }

      helloEl.textContent = '–£–≤—ñ–π—à–ª–∏ —è–∫ ' + (u.email || u.uid);
      btnLogout.style.display = '';

      let role = 'pending';
	  try { role = (await resolveUserRole(u.uid)).trim().toLowerCase(); } catch(e){ console.error(e); }
	  if (role !== 'admin') {
	  statusEl.textContent = '‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ (–ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å admin)';
	  document.documentElement.style.visibility = 'visible';
	  setTimeout(()=>location.replace('/'), 1200);   // –º‚Äô—è–∫–∏–π —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
	  return;
	  }

      statusEl.textContent = '‚úÖ –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ –∞–¥–º—ñ–Ω';
      document.documentElement.style.visibility = 'visible';

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (live)
      loadUsers();
    });

    // ===== –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞
    function userRowHTML(id, user){
      const name = user.displayName || user.email || id;
      const email = user.email ? ` ‚Ä¢ ${user.email}` : '';
      const role = user.role || 'pending';
      const created = user.createdAt || user.created_at || '';

      return `
        <div class="user-row" data-uid="${id}">
          <div>
            <b>${escapeHtml(name)}</b>
            <span class="user-meta">(${escapeHtml(role)})${email ? ' ‚Ä¢ ' + escapeHtml(email) : ''}${created ? ' ‚Ä¢ —Å—Ç–≤–æ—Ä–µ–Ω–æ: ' + escapeHtml(created) : ''}</span>
          </div>
          <div class="row-actions">
            <label>–†–æ–ª—å:
              <select data-id="${id}" data-prev="${role}">
                <option value="pending" ${role==="pending"?"selected":""}>–û—á—ñ–∫—É—î</option>
                <option value="user" ${role==="user"?"selected":""}>User</option>
                <option value="logist" ${role==="logist"?"selected":""}>Logist</option>
                <option value="security" ${role==="security"?"selected":""}>Security</option>
                <option value="admin" ${role==="admin"?"selected":""}>Admin</option>
              </select>
            </label>
          </div>
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // ===== –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–æ–ª–µ–∫—Ü—ñ—é users
    function loadUsers(){
      try { if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; } } catch {}
      unsubscribeUsers = db.collection('users')
        .orderBy('role')  // –ø—Ä–æ—Å—Ç–µ –≤–ø–æ—Ä—è–¥–∫—É–≤–∞–Ω–Ω—è; –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –∑–º—ñ–Ω–∏
        .onSnapshot((snap) => {
          listEl.innerHTML = '';
          snap.forEach((doc) => {
            const user = doc.data() || {};
            listEl.insertAdjacentHTML('beforeend', userRowHTML(doc.id, user));
          });

          // –Ω–∞–≤—ñ—à—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏
          bindRoleChangeHandlers();
        }, (err) => {
          console.error('onSnapshot(users) error:', err);
          statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: ' + (err.message || err);
        });
    }

    // ===== –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ —Ä–æ–ª—ñ (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Å–∞–º–æ–¥–µ–º–æ—Ç—É–≤–∞–Ω–Ω—è, –∞—É–¥–∏—Ç)
    function bindRoleChangeHandlers(){
      document.querySelectorAll('#user-list select').forEach((sel) => {
        sel.addEventListener('change', async (e) => {
          const uid = e.target.dataset.id;
          const newRole = e.target.value;
          const prevRole = e.target.getAttribute('data-prev') || '';

          // –∑–∞—Ö–∏—Å—Ç: –Ω–µ –¥–æ–∑–≤–æ–ª—è—î–º–æ —Å–æ–±—ñ –∑–Ω—ñ–º–∞—Ç–∏ admin
          if (currentUser && uid === currentUser.uid && newRole !== 'admin') {
            alert('–ù–µ –º–æ–∂–Ω–∞ –∑–Ω—ñ–º–∞—Ç–∏ –∑ —Å–µ–±–µ —Ä–æ–ª—å admin.');
            e.target.value = 'admin';
            return;
          }

          e.target.disabled = true;
          statusEl.textContent = `–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${uid} ‚Üí ${newRole}‚Ä¶`;

          try {
            // –±–∞—Ç—á: –æ–Ω–æ–≤–∏—Ç–∏ users/{uid} —ñ –¥–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å –≤ audit
            const batch = db.batch();
            const uref = db.collection('users').doc(uid);
            batch.set(uref, {
              role: newRole,
              roleUpdatedAt: new Date().toISOString(),
              roleUpdatedBy: currentUser ? currentUser.uid : null
            }, { merge: true });

            const auditRef = db.collection('audit').doc();
            batch.set(auditRef, {
              type: 'role_change',
              targetUid: uid,
              newRole,
              prevRole,
              by: currentUser ? currentUser.uid : null,
              at: new Date().toISOString()
            });

            await batch.commit();

            // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
            e.target.setAttribute('data-prev', newRole);
            statusEl.textContent = `‚úÖ –†–æ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ: ${uid} ‚Üí ${newRole}`;
          } catch (err) {
            console.error(err);
            alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–æ–ª—ñ: ' + (err.message || err));
            // –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –≤—ñ–∑—É–∞–ª—å–Ω–æ
            e.target.value = prevRole || 'pending';
            statusEl.textContent = '‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ä–æ–ª—å.';
          } finally {
            e.target.disabled = false;
          }
        });
      });
    }

    // –ë–µ–∑–ø–µ–∫–∞: —è–∫—â–æ —Ä–∞–ø—Ç–æ–º —Å—Ç–∞–ª–∞—Å—è –≥–ª–æ–±–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –ø–æ–∫–∞–∂–µ–º–æ —ó—ó –∑–∞–º—ñ—Å—Ç—å –ø–æ—Ä–æ–∂–Ω—å–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    window.addEventListener('error', (e) => {
      try {
        document.documentElement.style.visibility = 'visible';
        statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞: ' + (e.message || '');
      } catch {}
    });
  </script>
</body>
</html>
