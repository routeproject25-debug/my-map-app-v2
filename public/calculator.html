<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- App config -->
  <script src="/config/config.js"></script>
  <!-- SheetJS –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9fafb; }
    .container { max-width: 1200px; margin: 0 auto; }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 24px; }
    
    .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h2 { margin: 0 0 16px; font-size: 18px; color: #374151; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 16px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 4px; }
    input, select { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #2563eb; }
    
    .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .result-box { background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-top: 20px; }
    .result-box h3 { margin: 0 0 12px; color: #1e40af; }
    .result-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #bfdbfe; }
    .result-item:last-child { border-bottom: none; }
    .result-label { font-weight: 600; color: #374151; }
    .result-value { font-size: 18px; font-weight: 700; color: #1e40af; }
    
    .pricing-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .pricing-table th { background: #f3f4f6; padding: 10px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 2px solid #d1d5db; }
    .pricing-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    .pricing-table tbody tr:hover { background: #f9fafb; }
    
    /* –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏ */
    th.sortable { cursor: pointer; user-select: none; position: relative; }
    th.sortable .s { font-size: 11px; opacity: 0.6; margin-left: 6px; }
    th.sortable.active .s { opacity: 1; }
    th.sortable.asc .s::before { content: '‚ñ≤'; }
    th.sortable.desc .s::before { content: '‚ñº'; }
    thead tr.filters th { background: #fafafa; padding: 6px; }
    thead tr.filters input { width: 100%; padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; background: #fff; }
    
    .upload-zone { border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover { border-color: #2563eb; background: #f0f9ff; }
    .upload-zone.drag-over { border-color: #2563eb; background: #dbeafe; }
    
    .muted { color: #6b7280; font-size: 13px; }
    .error { color: #dc2626; font-size: 13px; margin-top: 4px; }
    .success { color: #16a34a; font-size: 13px; margin-top: 4px; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; margin-bottom: -2px; }
    .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
    .tab:hover { color: #374151; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Modal styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { margin: 0 0 20px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb; }
    .modal-header h3 { margin: 0; font-size: 20px; color: #374151; }
    .modal-footer { margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end; }
    .modal-footer button { padding: 8px 16px; }
  </style>

  <!-- AUTH GUARD -->
  <script>
  (function () {
    document.documentElement.style.visibility = 'hidden';
    const CFG = window.APP_CONFIG?.firebase;
    if (!CFG) { console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'); document.documentElement.style.visibility = 'visible'; return; }
    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) { console.error(e); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname);

    auth.onAuthStateChanged(async (u) => {
      if (!u) { location.replace(loginURL); return; }
      
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ
      try {
        const snap = await db.collection('users').doc(u.uid).get({ source: 'server' });
        const role = snap.exists ? (snap.data()?.role || 'pending') : 'pending';
        const allowed = ['admin', 'logist', 'security'].includes(String(role).toLowerCase());
        
        if (!allowed) {
          alert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å: admin, logist –∞–±–æ security.');
          location.replace('/');
          return;
        }
        
        window.__userRole = role;
        document.documentElement.style.visibility = 'visible';
      } catch(e) {
        console.error(e);
        location.replace(loginURL);
      }
    });
  })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è</h1>
      <div>
        <a href="/index.html" class="btn btn-secondary">üè† –ù–∞ –∫–∞—Ä—Ç—É</a>
        <button id="btnLogout" class="btn btn-secondary">–í–∏–π—Ç–∏</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="calculator">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
      <div class="tab" data-tab="pricing">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑—Ü—ñ–Ω–∫–∞–º–∏</div>
    </div>

    <!-- Tab: Calculator -->
    <div class="tab-content active" data-content="calculator">
      <div class="card">
        <h2>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ</h2>
        
        <div class="form-row">
          <div>
            <label>–•–∞–±</label>
            <select id="calcHub">
              <option value="">–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±...</option>
            </select>
          </div>
          <div>
            <label>–†—ñ–∫ —Ä–æ–∑—Ü—ñ–Ω–∫–∏</label>
            <select id="calcYear">
              <option value="">–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫...</option>
            </select>
          </div>
          <div>
            <label>–ö—É–ª—å—Ç—É—Ä–∞</label>
            <select id="crop">
              <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—É–ª—å—Ç—É—Ä—É...</option>
              <option value="–°–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
              <option value="–ö—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
              <option value="–†—ñ–ø–∞–∫">–†—ñ–ø–∞–∫</option>
              <option value="–ü—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
              <option value="–°–æ—è">–°–æ—è</option>
              <option value="–û—Ä–≥–∞–Ω—ñ–∫–∞">–û—Ä–≥–∞–Ω—ñ–∫–∞</option>
            </select>
          </div>
          <div>
            <label>–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª</label>
            <select id="calcDivision">
              <option value="">–í—Å—ñ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–∏</option>
            </select>
            <p class="muted" style="margin: 4px 0 0;">–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ</p>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>–í–∞–≥–∞ –≤–∞–Ω—Ç–∞–∂—É, —Ç–æ–Ω–Ω</label>
            <input type="number" id="weight" value="27" step="0.1" placeholder="27">
            <p class="muted" style="margin: 4px 0 0;">–í–∞–≥–∞ –æ–¥–Ω—ñ—î—ó —Ö–æ–¥–∫–∏</p>
          </div>
          <div>
            <label>–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞, —Ç–æ–Ω–Ω</label>
            <input type="number" id="totalWeight" step="0.1" placeholder="–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ">
            <p class="muted" style="margin: 4px 0 0.">–î–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –æ–±'—î–º—É</p>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>–ü–æ—à—É–∫ "–í—ñ–¥" (–∫–æ–¥ –∞–±–æ –Ω–∞–∑–≤–∞)</label>
            <input type="text" id="searchFrom" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –±—ñ–æ–≥–∞, –ë–Ü–û–ì–ê3">
            <p class="muted" style="margin: 4px 0 0;">–ú–æ–∂–Ω–∞ –≤–≤–æ–¥–∏—Ç–∏ —á–∞—Å—Ç–∏–Ω—É –∫–æ–¥—É –∞–±–æ –Ω–∞–∑–≤–∏</p>
          </div>
          <div>
            <label>–ü–æ—à—É–∫ "–î–æ" (–∫–æ–¥ –∞–±–æ –Ω–∞–∑–≤–∞)</label>
            <input type="text" id="searchTo" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –±–∞–±–∏–Ω, —Å. –ë–∞–±–∏–Ω">
            <p class="muted" style="margin: 4px 0 0;">–ú–æ–∂–Ω–∞ –≤–≤–æ–¥–∏—Ç–∏ —á–∞—Å—Ç–∏–Ω—É –∫–æ–¥—É –∞–±–æ –Ω–∞–∑–≤–∏</p>
          </div>
        </div>

        <div style="margin-top: 16px;">
          <button id="btnSearch" class="btn btn-primary">üîç –ó–Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏</button>
          <button id="btnCalculateAll" class="btn btn-primary" style="display: none;">üí∞ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ</button>
          <button id="btnClear" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ -->
        <div id="routesContainer" style="display: none; margin-top: 20px;">
          <h3 style="margin: 0 0 12px; font-size: 16px; color: #374151;">–ó–Ω–∞–π–¥–µ–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏ (<span id="routeCount">0</span>)</h3>
          <div style="overflow-x: auto;">
            <table class="pricing-table" id="routesTable">
              <thead>
                <tr>
                  <th class="sortable" data-col="from">–í—ñ–¥ <span class="s">‚Üï</span></th>
                  <th class="sortable" data-col="to">–î–æ <span class="s">‚Üï</span></th>
                  <th class="sortable" data-col="distance">–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º <span class="s">‚Üï</span></th>
                  <th class="sortable" data-col="division">–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª <span class="s">‚Üï</span></th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–†–æ–∑—Ü—ñ–Ω–∫–∞</th>
                  <th class="sortable" data-col="priceNoVAT">–ë–µ–∑ –ü–î–í <span class="s">‚Üï</span></th>
                  <th class="sortable" data-col="priceWithVAT">–ó –ü–î–í <span class="s">‚Üï</span></th>
                </tr>
                <tr class="filters">
                  <th><input type="text" id="filterFrom" placeholder="–§—ñ–ª—å—Ç—Ä..."></th>
                  <th><input type="text" id="filterTo" placeholder="–§—ñ–ª—å—Ç—Ä..."></th>
                  <th><input type="text" id="filterDistance" placeholder="–í—ñ–¥-–î–æ –∫–º"></th>
                  <th><input type="text" id="filterDivision" placeholder="–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª..."></th>
                  <th>
                    <select id="filterStatus" style="width: 100%; padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                      <option value="">–í—Å—ñ</option>
                      <option value="approved">–ü–æ–≥–æ–¥–∂–µ–Ω–æ</option>
                      <option value="pending">–û—á—ñ–∫—É—î</option>
                      <option value="rejected">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</option>
                      <option value="draft">–ß–µ—Ä–Ω–µ—Ç–∫–∞</option>
                    </select>
                  </th>
                  <th><input type="text" id="filterPriceType" placeholder="–¢–∏–ø..."></th>
                  <th><input type="text" id="filterNoVAT" placeholder="–í—ñ–¥-–î–æ"></th>
                  <th><input type="text" id="filterWithVAT" placeholder="–í—ñ–¥-–î–æ"></th>
                </tr>
              </thead>
              <tbody id="routesTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- –ó–≤–µ–¥–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="summaryBox" class="result-box" style="display: none; margin-top: 20px;">
          <h3>üìä –ó–≤–µ–¥–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <div class="result-item">
            <span class="result-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç—ñ–≤:</span>
            <span id="sumCount" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–°–µ—Ä–µ–¥–Ω—è –≤—ñ–¥—Å—Ç–∞–Ω—å:</span>
            <span id="sumAvgDistance" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å:</span>
            <span id="sumTotalDistance" class="result-value">-</span>
          </div>
          <div class="result-item" style="border-top: 2px solid #3b82f6; margin-top: 8px; padding-top: 12px;">
            <span class="result-label">–°–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å –±–µ–∑ –ü–î–í:</span>
            <span id="sumAvgPriceNoVAT" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–°—É–º–∞ –±–µ–∑ –ü–î–í:</span>
            <span id="sumTotalPriceNoVAT" class="result-value">-</span>
          </div>
          <div class="result-item" style="border-top: 2px solid #3b82f6; margin-top: 8px; padding-top: 12px;">
            <span class="result-label">–°–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å –∑ –ü–î–í:</span>
            <span id="sumAvgPriceWithVAT" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–°—É–º–∞ –∑ –ü–î–í:</span>
            <span id="sumTotalPriceWithVAT" class="result-value">-</span>
          </div>
          <div id="totalWeightSection" style="display: none; border-top: 2px solid #3b82f6; margin-top: 8px; padding-top: 12px;">
            <div class="result-item">
              <span class="result-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞:</span>
              <span id="sumTotalWeightDisplay" class="result-value">-</span>
            </div>
            <div class="result-item">
              <span class="result-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ö–æ–¥–æ–∫:</span>
              <span id="sumTotalTrips" class="result-value">-</span>
            </div>
            <div class="result-item">
              <span class="result-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –±–µ–∑ –ü–î–í:</span>
              <span id="sumTotalCargoNoVAT" class="result-value">-</span>
            </div>
            <div class="result-item">
              <span class="result-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –∑ –ü–î–í:</span>
              <span id="sumTotalCargoWithVAT" class="result-value">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Pricing Management -->
    <div class="tab-content" data-content="pricing">
      <div class="card">
        <h2>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—Ü—ñ–Ω–æ–∫</h2>
        <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ Excel —Ñ–∞–π–ª –∑ —Ä–æ–∑—Ü—ñ–Ω–∫–∞–º–∏. –§–æ—Ä–º–∞—Ç: –•–ê–ë, –†—ñ–∫, –í–Ü–î, –î–û, –ë–µ–∑ –ü–î–í, –ó –ü–î–í, –¢–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏, –ö—É–ª—å—Ç—É—Ä–∞</p>
        
        <div id="uploadZone" class="upload-zone">
          <p style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">üìÅ –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å Excel —Ñ–∞–π–ª —Å—é–¥–∏</p>
          <p class="muted">–∞–±–æ –∫–ª–∞—Ü–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É</p>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>

        <div id="uploadStatus" style="margin-top: 16px;"></div>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">–ü–æ—Ç–æ—á–Ω—ñ —Ä–æ–∑—Ü—ñ–Ω–∫–∏</h2>
          <button class="btn btn-primary" onclick="openAddPricingModal()">‚ûï –î–æ–¥–∞—Ç–∏ —Ä–æ–∑—Ü—ñ–Ω–∫—É</button>
        </div>
        
        <div class="form-row">
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –•–∞–±</label>
            <select id="filterHub">
              <option value="">–í—Å—ñ —Ö–∞–±–∏</option>
            </select>
          </div>
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –†—ñ–∫</label>
            <select id="filterYear">
              <option value="">–í—Å—ñ —Ä–æ–∫–∏</option>
            </select>
          </div>
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –ö—É–ª—å—Ç—É—Ä–∞</label>
            <select id="filterCrop">
              <option value="">–í—Å—ñ –∫—É–ª—å—Ç—É—Ä–∏</option>
              <option value="–°–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
              <option value="–ö—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
              <option value="–†—ñ–ø–∞–∫">–†—ñ–ø–∞–∫</option>
              <option value="–ü—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
              <option value="–°–æ—è">–°–æ—è</option>
              <option value="–û—Ä–≥–∞–Ω—ñ–∫–∞">–û—Ä–≥–∞–Ω—ñ–∫–∞</option>
            </select>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="pricing-table">
            <thead>
              <tr>
                <th>–•–∞–±</th>
                <th>–†—ñ–∫</th>
                <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                <th>–í—ñ–¥, –∫–º</th>
                <th>–î–æ, –∫–º</th>
                <th>–ë–µ–∑ –ü–î–í</th>
                <th>–ó –ü–î–í</th>
                <th>–¢–∏–ø</th>
                <th>–î—ñ—ó</th>
              </tr>
            </thead>
            <tbody id="pricingTableBody">
              <tr><td colspan="9" style="text-align: center;" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Pricing Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó —Ä–æ–∑—Ü—ñ–Ω–∫–∏</h3>
      </div>
      <div class="form-row">
        <div>
          <label>–•–∞–±</label>
          <input type="text" id="addHub" placeholder="–í–∫–∞–∑–∞—Ç–∏ —Ö–∞–±">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–†—ñ–∫</label>
          <input type="number" id="addYear" placeholder="2025">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–ö—É–ª—å—Ç—É—Ä–∞</label>
          <select id="addCrop">
            <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—É–ª—å—Ç—É—Ä—É...</option>
            <option value="–°–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
            <option value="–ö—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
            <option value="–†—ñ–ø–∞–∫">–†—ñ–ø–∞–∫</option>
            <option value="–ü—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
            <option value="–°–æ—è">–°–æ—è</option>
            <option value="–û—Ä–≥–∞–Ω—ñ–∫–∞">–û—Ä–≥–∞–Ω—ñ–∫–∞</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–í—ñ–¥, –∫–º</label>
          <input type="number" id="addDistFrom" placeholder="0">
        </div>
        <div>
          <label>–î–æ, –∫–º</label>
          <input type="number" id="addDistTo" placeholder="50">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–ë–µ–∑ –ü–î–í</label>
          <input type="number" id="addPriceNoVAT" step="0.01" placeholder="100.00">
        </div>
        <div>
          <label>–ó –ü–î–í</label>
          <input type="number" id="addPriceWithVAT" step="0.01" placeholder="120.00">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–¢–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏</label>
          <select id="addPriceType">
            <option value="—Ç/–∫–º">—Ç/–∫–º</option>
            <option value="–∑–∞ —Ç–æ–Ω—É">–∑–∞ —Ç–æ–Ω—É</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddPricingModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn btn-primary" onclick="saveAddPricing()">–î–æ–¥–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Edit Pricing Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–æ–∑—Ü—ñ–Ω–∫–∏</h3>
      </div>
      <div class="form-row">
        <div>
          <label>–•–∞–±</label>
          <input type="text" id="editHub" readonly style="background: #f3f4f6; cursor: not-allowed;">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–†—ñ–∫</label>
          <input type="number" id="editYear" readonly style="background: #f3f4f6; cursor: not-allowed;">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–ö—É–ª—å—Ç—É—Ä–∞</label>
          <input type="text" id="editCrop" readonly style="background: #f3f4f6; cursor: not-allowed;">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–í—ñ–¥, –∫–º</label>
          <input type="number" id="editDistFrom" readonly style="background: #f3f4f6; cursor: not-allowed;">
        </div>
        <div>
          <label>–î–æ, –∫–º</label>
          <input type="number" id="editDistTo" readonly style="background: #f3f4f6; cursor: not-allowed;">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–ë–µ–∑ –ü–î–í</label>
          <input type="number" id="editPriceNoVAT" step="0.01">
        </div>
        <div>
          <label>–ó –ü–î–í</label>
          <input type="number" id="editPriceWithVAT" step="0.01">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>–¢–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏</label>
          <select id="editPriceType">
            <option value="—Ç/–∫–º">—Ç/–∫–º</option>
            <option value="–∑–∞ —Ç–æ–Ω—É">–∑–∞ —Ç–æ–Ω—É</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn btn-primary" onclick="saveEditPricing()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // Logout
    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await auth.signOut(); } catch(e) { console.warn(e); }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');
        
        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-content="${targetTab}"]`).classList.add('active');
      });
    });

    // ==================== CALCULATOR ====================
    
    // Load routes for search
    let allRoutes = [];
    async function loadRoutes() {
      try {
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –í–°–Ü –º–∞—Ä—à—Ä—É—Ç–∏ (—è–∫ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –µ–∫—Å–ø–æ—Ä—Ç—É), –Ω–µ —Ç—ñ–ª—å–∫–∏ approved
        const snapshot = await db.collection('routes').get();
        
        allRoutes = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          allRoutes.push({
            id: doc.id,
            fromCode: d.fromCode || '',
            toCode: d.toCode || '',
            fromName: d.fromName || d.fromLabel || '',
            toName: d.toName || d.toLabel || '',
            distance: d.distance_km || d.distance || 0,
            division: d.division || '-',
            approvalStatus: d.approval?.status || 'draft'
          });
        });
        console.log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${allRoutes.length} –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É`);
        if (allRoutes.length > 0) {
          console.log('–ü—Ä–∏–∫–ª–∞–¥ –º–∞—Ä—à—Ä—É—Ç—É:', allRoutes[0]);
        }
      } catch(e) {
        console.error('Load routes error:', e);
      }
    }

    // Search routes
    let foundRoutes = [];
    document.getElementById('btnSearch').addEventListener('click', () => {
      const searchFrom = document.getElementById('searchFrom').value.toLowerCase().trim();
      const searchTo = document.getElementById('searchTo').value.toLowerCase().trim();
      const selectedDivision = document.getElementById('calcDivision').value;
      
      console.log('–ü–æ—à—É–∫ –º–∞—Ä—à—Ä—É—Ç—ñ–≤:', { searchFrom, searchTo, selectedDivision, totalRoutes: allRoutes.length });
      
      if (!searchFrom && !searchTo) {
        alert('–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ—à—É–∫—É (–í—ñ–¥ –∞–±–æ –î–æ)');
        return;
      }
      
      if (allRoutes.length === 0) {
        alert('–ú–∞—Ä—à—Ä—É—Ç–∏ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.');
        return;
      }
      
      foundRoutes = allRoutes.filter(r => {
        const fromCodeLower = (r.fromCode || '').toLowerCase();
        const fromNameLower = (r.fromName || '').toLowerCase();
        const toCodeLower = (r.toCode || '').toLowerCase();
        const toNameLower = (r.toName || '').toLowerCase();
        
        const matchFrom = !searchFrom || 
          fromCodeLower.includes(searchFrom) || 
          fromNameLower.includes(searchFrom);
        const matchTo = !searchTo || 
          toCodeLower.includes(searchTo) || 
          toNameLower.includes(searchTo);
        const matchDivision = !selectedDivision || r.division === selectedDivision;
        
        const matches = matchFrom && matchTo && matchDivision;
        
        // –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä—à–∏—Ö 5 –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        if (foundRoutes.length < 5) {
          console.log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç—É:', {
            from: `${r.fromCode} - ${r.fromName}`,
            to: `${r.toCode} - ${r.toName}`,
            searchFrom,
            searchTo,
            matchFrom,
            matchTo,
            matches
          });
        }
        
        if (matches) {
          console.log('‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç:', r);
        }
        return matches;
      });
      
      console.log(`–ó–Ω–∞–π–¥–µ–Ω–æ ${foundRoutes.length} –º–∞—Ä—à—Ä—É—Ç—ñ–≤`);
      
      if (foundRoutes.length === 0) {
        alert(`–ú–∞—Ä—à—Ä—É—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.\n–ü–æ—à—É–∫: –≤—ñ–¥="${searchFrom}", –¥–æ="${searchTo}"\n–í—Å—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ —É –±–∞–∑—ñ: ${allRoutes.length}`);
        document.getElementById('routesContainer').style.display = 'none';
        document.getElementById('summaryBox').style.display = 'none';
        document.getElementById('btnCalculateAll').style.display = 'none';
        return;
      }
      
      document.getElementById('routeCount').textContent = foundRoutes.length;
      document.getElementById('routesContainer').style.display = 'block';
      document.getElementById('btnCalculateAll').style.display = 'inline-block';
      renderFoundRoutes();
    });

    let displayedRoutes = [];
    let currentSort = { col: null, dir: 'asc' };
    
    function renderFoundRoutes() {
      displayedRoutes = [...foundRoutes];
      applyFiltersAndSort();
    }
    
    function applyFiltersAndSort() {
      let filtered = [...displayedRoutes];
      
      // –§—ñ–ª—å—Ç—Ä–∏
      const filterFrom = document.getElementById('filterFrom')?.value.toLowerCase().trim() || '';
      const filterTo = document.getElementById('filterTo')?.value.toLowerCase().trim() || '';
      const filterDistance = document.getElementById('filterDistance')?.value.trim() || '';
      const filterDivision = document.getElementById('filterDivision')?.value.toLowerCase().trim() || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';
      const filterPriceType = document.getElementById('filterPriceType')?.value.toLowerCase().trim() || '';
      
      if (filterFrom) {
        filtered = filtered.filter(r => 
          (r.fromName || '').toLowerCase().includes(filterFrom) || 
          (r.fromCode || '').toLowerCase().includes(filterFrom)
        );
      }
      
      if (filterTo) {
        filtered = filtered.filter(r => 
          (r.toName || '').toLowerCase().includes(filterTo) || 
          (r.toCode || '').toLowerCase().includes(filterTo)
        );
      }
      
      if (filterDistance) {
        const [min, max] = filterDistance.split('-').map(s => parseFloat(s.trim()));
        if (!isNaN(min) && isNaN(max)) {
          filtered = filtered.filter(r => r.distance >= min);
        } else if (!isNaN(min) && !isNaN(max)) {
          filtered = filtered.filter(r => r.distance >= min && r.distance <= max);
        }
      }
      
      if (filterDivision) {
        filtered = filtered.filter(r => 
          (r.division || '').toLowerCase().includes(filterDivision)
        );
      }
      
      if (filterStatus) {
        filtered = filtered.filter(r => r.approvalStatus === filterStatus);
      }
      
      if (filterPriceType) {
        filtered = filtered.filter(r => 
          (r.priceType || '').toLowerCase().includes(filterPriceType)
        );
      }
      
      // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
      if (currentSort.col) {
        filtered.sort((a, b) => {
          let valA, valB;
          switch(currentSort.col) {
            case 'from':
              valA = (a.fromName || a.fromCode || '').toLowerCase();
              valB = (b.fromName || b.fromCode || '').toLowerCase();
              break;
            case 'to':
              valA = (a.toName || a.toCode || '').toLowerCase();
              valB = (b.toName || b.toCode || '').toLowerCase();
              break;
            case 'distance':
              valA = a.distance || 0;
              valB = b.distance || 0;
              break;
            case 'division':
              valA = (a.division || '').toLowerCase();
              valB = (b.division || '').toLowerCase();
              break;
            case 'priceNoVAT':
              valA = a.calc?.priceNoVAT || 0;
              valB = b.calc?.priceNoVAT || 0;
              break;
            case 'priceWithVAT':
              valA = a.calc?.priceWithVAT || 0;
              valB = b.calc?.priceWithVAT || 0;
              break;
            default:
              return 0;
          }
          
          if (typeof valA === 'string') {
            return currentSort.dir === 'asc' ? valA.localeCompare(valB, 'uk') : valB.localeCompare(valA, 'uk');
          } else {
            return currentSort.dir === 'asc' ? valA - valB : valB - valA;
          }
        });
      }
      
      // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
      const tbody = document.getElementById('routesTableBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">–ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑–∞ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏</td></tr>';
        return;
      }
      
      const statusColors = {
        approved: '#16a34a',
        pending: '#f59e0b',
        rejected: '#dc2626',
        draft: '#6b7280'
      };
      
      const statusLabels = {
        approved: '–ü–æ–≥–æ–¥–∂–µ–Ω–æ',
        pending: '–û—á—ñ–∫—É—î',
        rejected: '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ',
        draft: '–ß–µ—Ä–Ω–µ—Ç–∫–∞'
      };
      
      tbody.innerHTML = filtered.map(r => {
        const statusColor = statusColors[r.approvalStatus] || '#6b7280';
        const statusLabel = statusLabels[r.approvalStatus] || r.approvalStatus;
        
        if (r.calc) {
          return `
            <tr>
              <td>${r.fromName || r.fromCode}</td>
              <td>${r.toName || r.toCode}</td>
              <td>${r.distance.toFixed(2)}</td>
              <td>${r.division || '-'}</td>
              <td><span style="color: ${statusColor}; font-weight: 600;">${statusLabel}</span></td>
              <td>${r.priceType || '-'}</td>
              <td>${r.calc.priceNoVAT ? r.calc.priceNoVAT.toFixed(2) + ' –≥—Ä–Ω' : '-'}</td>
              <td>${r.calc.priceWithVAT ? r.calc.priceWithVAT.toFixed(2) + ' –≥—Ä–Ω' : '-'}</td>
            </tr>
          `;
        } else {
          return `
            <tr>
              <td>${r.fromName || r.fromCode}</td>
              <td>${r.toName || r.toCode}</td>
              <td>${r.distance.toFixed(2)}</td>
              <td>${r.division || '-'}</td>
              <td><span style="color: ${statusColor}; font-weight: 600;">${statusLabel}</span></td>
              <td colspan="3" style="text-align: center; color: #6b7280;">${r.calculated === false ? '–†–æ–∑—Ü—ñ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞' : '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ"'}</td>
            </tr>
          `;
        }
      }).join('');
    }

    // Calculate all routes
    document.getElementById('btnCalculateAll').addEventListener('click', async () => {
      const hub = document.getElementById('calcHub').value;
      const year = document.getElementById('calcYear').value;
      const crop = document.getElementById('crop').value;
      const weight = parseFloat(document.getElementById('weight').value) || 27;
      
      if (!hub || !year || !crop) {
        alert('–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±, —Ä—ñ–∫ —Ç–∞ –∫—É–ª—å—Ç—É—Ä—É');
        return;
      }
      
      const tbody = document.getElementById('routesTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫...</td></tr>';
      
      try {
        // –û–Ω–æ–≤–ª—é—î–º–æ foundRoutes –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤
        for (const route of foundRoutes) {
          const pricing = await findPricingForDistance(hub, year, crop, route.distance);
          if (pricing) {
            const calc = calculatePrice(pricing, route.distance, weight);
            route.calc = calc;
            route.pricing = pricing;
            route.priceType = pricing.priceType;
            route.calculated = true;
          } else {
            route.calc = null;
            route.pricing = null;
            route.priceType = null;
            route.calculated = false;
          }
        }
        
        displayedRoutes = [...foundRoutes];
        applyFiltersAndSort();
        
        // Calculate summary
        const validResults = foundRoutes.filter(r => r.calc);
        if (validResults.length > 0) {
          const totalDistance = validResults.reduce((sum, r) => sum + r.distance, 0);
          const avgDistance = totalDistance / validResults.length;
          
          const totalPriceNoVAT = validResults.reduce((sum, r) => sum + (r.calc.priceNoVAT || 0), 0);
          const avgPriceNoVAT = totalPriceNoVAT / validResults.length;
          
          const totalPriceWithVAT = validResults.reduce((sum, r) => sum + (r.calc.priceWithVAT || 0), 0);
          const avgPriceWithVAT = totalPriceWithVAT / validResults.length;
          
          document.getElementById('sumCount').textContent = validResults.length;
          document.getElementById('sumAvgDistance').textContent = avgDistance.toFixed(2) + ' –∫–º';
          document.getElementById('sumTotalDistance').textContent = totalDistance.toFixed(2) + ' –∫–º';
          document.getElementById('sumAvgPriceNoVAT').textContent = avgPriceNoVAT.toFixed(2) + ' –≥—Ä–Ω';
          document.getElementById('sumTotalPriceNoVAT').textContent = totalPriceNoVAT.toFixed(2) + ' –≥—Ä–Ω';
          document.getElementById('sumAvgPriceWithVAT').textContent = avgPriceWithVAT.toFixed(2) + ' –≥—Ä–Ω';
          document.getElementById('sumTotalPriceWithVAT').textContent = totalPriceWithVAT.toFixed(2) + ' –≥—Ä–Ω';
          
          // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–æ—ó –≤–∞–≥–∏
          const totalWeightInput = parseFloat(document.getElementById('totalWeight').value);
          if (totalWeightInput && totalWeightInput > 0) {
            const trips = Math.ceil(totalWeightInput / weight);
            
            // –°–µ—Ä–µ–¥–Ω—è —Ä–æ–∑—Ü—ñ–Ω–∫–∞ –¥–ª—è avgDistance
            const avgRateNoVAT = avgPriceNoVAT / (avgDistance * weight);
            const avgRateWithVAT = avgPriceWithVAT / (avgDistance * weight);
            
            const totalCargoNoVAT = avgDistance * avgRateNoVAT * totalWeightInput;
            const totalCargoWithVAT = avgDistance * avgRateWithVAT * totalWeightInput;
            
            document.getElementById('sumTotalWeightDisplay').textContent = totalWeightInput.toFixed(2) + ' —Ç';
            document.getElementById('sumTotalTrips').textContent = trips;
            document.getElementById('sumTotalCargoNoVAT').textContent = totalCargoNoVAT.toFixed(2) + ' –≥—Ä–Ω';
            document.getElementById('sumTotalCargoWithVAT').textContent = totalCargoWithVAT.toFixed(2) + ' –≥—Ä–Ω';
            document.getElementById('totalWeightSection').style.display = 'block';
          } else {
            document.getElementById('totalWeightSection').style.display = 'none';
          }
          
          document.getElementById('summaryBox').style.display = 'block';
        }
      } catch(e) {
        console.error(e);
        alert('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É: ' + (e.message || e));
      }
    });

    async function findPricingForDistance(hub, year, crop, distance) {
      const snapshot = await db.collection('pricing')
        .where('hub', '==', hub)
        .where('year', '==', parseInt(year))
        .where('crop', '==', crop)
        .get();
      
      let allPricingRanges = [];
      snapshot.forEach(doc => {
        const d = doc.data();
        allPricingRanges.push({ id: doc.id, ...d });
      });
      
      // –°–ø–æ—á–∞—Ç–∫—É —à—É–∫–∞—î–º–æ —Ç–æ—á–Ω–µ –ø–æ–ø–∞–¥–∞–Ω–Ω—è –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω
      let found = allPricingRanges.find(p => 
        distance >= p.distFrom && distance <= p.distTo
      );
      
      if (found) return found;
      
      // –Ø–∫—â–æ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–ø–∞–¥–∞–Ω–Ω—è –Ω–µ–º–∞—î, —à—É–∫–∞—î–º–æ –Ω–∞–π–±–ª–∏–∂—á–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω
      // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, 100.31 -> –±–ª–∏–∂—á–µ –¥–æ 100 (—Ä–æ–∑—Ü—ñ–Ω–∫–∞ 75-100), –Ω—ñ–∂ –¥–æ 101 (—Ä–æ–∑—Ü—ñ–Ω–∫–∞ 101-150)
      let closestRange = null;
      let minDistance = Infinity;
      
      allPricingRanges.forEach(p => {
        // –í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –Ω–∏–∂–Ω—å–æ—ó –º–µ–∂—ñ –¥—ñ–∞–ø–∞–∑–æ–Ω—É
        const distToFrom = Math.abs(distance - p.distFrom);
        // –í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –≤–µ—Ä—Ö–Ω—å–æ—ó –º–µ–∂—ñ –¥—ñ–∞–ø–∞–∑–æ–Ω—É
        const distToTo = Math.abs(distance - p.distTo);
        // –ë–µ—Ä–µ–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É
        const distToRange = Math.min(distToFrom, distToTo);
        
        if (distToRange < minDistance) {
          minDistance = distToRange;
          closestRange = p;
        }
      });
      
      if (closestRange) {
        console.log(`–í—ñ–¥—Å—Ç–∞–Ω—å ${distance} –∫–º –Ω–µ –ø–æ–ø–∞–¥–∞—î —Ç–æ—á–Ω–æ –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞–π–±–ª–∏–∂—á—É —Ä–æ–∑—Ü—ñ–Ω–∫—É: ${closestRange.distFrom}-${closestRange.distTo} –∫–º (–≤—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É: ${minDistance.toFixed(2)} –∫–º)`);
      }
      
      return closestRange;
    }

    function calculatePrice(pricing, distance, weight) {
      const type = pricing.priceType || '—Ç/–∫–º';
      let priceNoVAT = 0;
      let priceWithVAT = 0;
      
      if (type === '—Ç/–∫–º') {
        // –§–æ—Ä–º—É–ª–∞: –≤—ñ–¥—Å—Ç–∞–Ω—å * –≤–∞–≥–∞ * —Ä–æ–∑—Ü—ñ–Ω–∫–∞
        if (pricing.priceNoVAT) {
          priceNoVAT = distance * weight * pricing.priceNoVAT;
        }
        if (pricing.priceWithVAT) {
          priceWithVAT = distance * weight * pricing.priceWithVAT;
        }
      } else if (type === '–∑–∞ —Ç–æ–Ω—É') {
        // –§–æ—Ä–º—É–ª–∞: –≤–∞–≥–∞ * —Ä–æ–∑—Ü—ñ–Ω–∫–∞
        if (pricing.priceNoVAT) {
          priceNoVAT = weight * pricing.priceNoVAT;
        }
        if (pricing.priceWithVAT) {
          priceWithVAT = weight * pricing.priceWithVAT;
        }
      }
      
      return {
        type,
        priceNoVAT: priceNoVAT || null,
        priceWithVAT: priceWithVAT || null,
        rate: type === '—Ç/–∫–º' ? pricing.priceNoVAT || pricing.priceWithVAT : pricing.priceNoVAT || pricing.priceWithVAT
      };
    }

    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('searchFrom').value = '';
      document.getElementById('searchTo').value = '';
      document.getElementById('crop').value = '';
      document.getElementById('weight').value = '27';
      document.getElementById('routesContainer').style.display = 'none';
      document.getElementById('summaryBox').style.display = 'none';
      document.getElementById('btnCalculateAll').style.display = 'none';
      foundRoutes = [];
    });

    // ==================== PRICING MANAGEMENT ====================
    
    // Upload Excel
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    uploadZone.addEventListener('click', () => fileInput.click());
    
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    async function handleFile(file) {
      const status = document.getElementById('uploadStatus');
      status.innerHTML = '<p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';
      
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        
        if (rows.length === 0) {
          status.innerHTML = '<p class="error">‚ùå –§–∞–π–ª –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω–∏—Ö</p>';
          return;
        }
        
        await uploadPricing(rows);
        status.innerHTML = '<p class="success">‚úÖ –†–æ–∑—Ü—ñ–Ω–∫–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!</p>';
        await loadPricingTable();
      } catch(e) {
        console.error(e);
        status.innerHTML = '<p class="error">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (e.message || e) + '</p>';
      }
    }

    async function uploadPricing(rows) {
      const batch = db.batch();
      let count = 0;
      let errors = [];
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const hub = String(row['–•–ê–ë'] || row['—Ö–∞–±'] || row['–•–∞–±'] || '').trim();
        const rowYear = parseInt(row['–†—ñ–∫'] || row['—Ä—ñ–∫'] || 0);
        const distFrom = parseFloat(row['–í–Ü–î'] || row['–≤—ñ–¥'] || 0);
        const distTo = parseFloat(row['–î–û'] || row['–¥–æ'] || 0);
        const priceNoVAT = parseFloat(row['–ë–µ–∑ –ü–î–í'] || row['–±–µ–∑ –ø–¥–≤'] || 0) || null;
        const priceWithVAT = parseFloat(row['–ó –ü–î–í'] || row['–∑ –ø–¥–≤'] || 0) || null;
        const priceType = String(row['–¢–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏'] || row['—Ç–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏'] || '—Ç/–∫–º').trim();
        const crop = String(row['–ö—É–ª—å—Ç—É—Ä–∞'] || row['–∫—É–ª—å—Ç—É—Ä–∞'] || '').trim();
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (!hub) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –•–ê–ë`);
          continue;
        }
        if (!rowYear || rowYear < 2020 || rowYear > 2030) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –†—ñ–∫ (${rowYear})`);
          continue;
        }
        if (!crop) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –≤—ñ–¥—Å—É—Ç–Ω—è –ö—É–ª—å—Ç—É—Ä–∞`);
          continue;
        }
        if (distFrom === 0 || distTo === 0) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –≤—ñ–¥—Å—Ç–∞–Ω—ñ –Ω–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ 0`);
          continue;
        }
        
        // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID: hub_year_crop_distFrom_distTo
        const docId = `${hub.replace(/\s/g, '_')}_${rowYear}_${crop.replace(/\s/g, '_')}_${distFrom}_${distTo}`;
        const ref = db.collection('pricing').doc(docId);
        
        batch.set(ref, {
          hub,
          year: rowYear,
          crop,
          distFrom,
          distTo,
          priceNoVAT,
          priceWithVAT,
          priceType,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        count++;
      }
      
      if (errors.length > 0) {
        console.warn('–ü–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó:', errors);
        throw new Error(`–û–±—Ä–æ–±–ª–µ–Ω–æ ${count} —Ä—è–¥–∫—ñ–≤. –ü–æ–º–∏–ª–∫–∏: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`);
      }
      
      if (count === 0) {
        throw new Error('–ñ–æ–¥–Ω–æ–≥–æ –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
      }
      
      await batch.commit();
      console.log(`Uploaded ${count} pricing records`);
    }

    // Load pricing table
    let allPricing = [];
    async function loadPricingTable() {
      try {
        const snapshot = await db.collection('pricing').get();
        allPricing = [];
        
        snapshot.forEach(doc => {
          allPricing.push({ id: doc.id, ...doc.data() });
        });
        
        allPricing.sort((a, b) => {
          if (a.hub !== b.hub) return (a.hub || '').localeCompare(b.hub || '', 'uk');
          if (a.year !== b.year) return b.year - a.year;
          if (a.crop !== b.crop) return a.crop.localeCompare(b.crop, 'uk');
          return a.distFrom - b.distFrom;
        });
        
        renderPricingTable();
        populateYearFilters();
        populateHubSelector();
      } catch(e) {
        console.error(e);
      }
    }

    function renderPricingTable() {
      const tbody = document.getElementById('pricingTableBody');
      const hubFilter = document.getElementById('filterHub').value;
      const yearFilter = document.getElementById('filterYear').value;
      const cropFilter = document.getElementById('filterCrop').value;
      
      const filtered = allPricing.filter(p => {
        if (hubFilter && p.hub !== hubFilter) return false;
        if (yearFilter && p.year !== parseInt(yearFilter)) return false;
        if (cropFilter && p.crop !== cropFilter) return false;
        return true;
      });
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;" class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(p => `
        <tr>
          <td>${p.hub || '-'}</td>
          <td>${p.year}</td>
          <td>${p.crop}</td>
          <td>${p.distFrom}</td>
          <td>${p.distTo}</td>
          <td>${p.priceNoVAT ? p.priceNoVAT.toFixed(2) : '-'}</td>
          <td>${p.priceWithVAT ? p.priceWithVAT.toFixed(2) : '-'}</td>
          <td>${p.priceType}</td>
          <td style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="editPricing('${p.id}')" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>
            <button class="btn btn-secondary" onclick="deletePricing('${p.id}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóë</button>
          </td>
        </tr>
      `).join('');
    }

    window.deletePricing = async function(id) {
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ä–æ–∑—Ü—ñ–Ω–∫—É?')) return;
      try {
        await db.collection('pricing').doc(id).delete();
        loadPricingTable();
      } catch(e) {
        alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message);
      }
    };

    let editingPricingId = null;

    window.editPricing = function(id) {
      const pricing = allPricing.find(p => p.id === id);
      if (!pricing) {
        alert('–†–æ–∑—Ü—ñ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
        return;
      }

      editingPricingId = id;
      
      // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ–æ—Ä–º—É –¥–∞–Ω–∏–º–∏
      document.getElementById('editHub').value = pricing.hub || '';
      document.getElementById('editYear').value = pricing.year;
      document.getElementById('editCrop').value = pricing.crop;
      document.getElementById('editDistFrom').value = pricing.distFrom;
      document.getElementById('editDistTo').value = pricing.distTo;
      document.getElementById('editPriceNoVAT').value = pricing.priceNoVAT || '';
      document.getElementById('editPriceWithVAT').value = pricing.priceWithVAT || '';
      document.getElementById('editPriceType').value = pricing.priceType || '—Ç/–∫–º';
      
      // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
      document.getElementById('editModal').classList.add('active');
    };

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      editingPricingId = null;
    }

    window.saveEditPricing = async function() {
      if (!editingPricingId) return;

      const priceNoVAT = parseFloat(document.getElementById('editPriceNoVAT').value);
      const priceWithVAT = parseFloat(document.getElementById('editPriceWithVAT').value);
      const priceType = document.getElementById('editPriceType').value;

      // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
      if (!priceType || !['—Ç/–∫–º', '–∑–∞ —Ç–æ–Ω—É'].includes(priceType)) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ç–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏');
        return;
      }

      if (isNaN(priceNoVAT) && isNaN(priceWithVAT)) {
        alert('–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É —Ü—ñ–Ω—É (–±–µ–∑ –ü–î–í –∞–±–æ –∑ –ü–î–í)');
        return;
      }

      try {
        await db.collection('pricing').doc(editingPricingId).update({
          priceNoVAT: !isNaN(priceNoVAT) ? priceNoVAT : null,
          priceWithVAT: !isNaN(priceWithVAT) ? priceWithVAT : null,
          priceType: priceType,
          updatedAt: new Date().toISOString()
        });

        closeEditModal();
        loadPricingTable();
        alert('‚úÖ –†–æ–∑—Ü—ñ–Ω–∫–∞ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–∞!');
      } catch(e) {
        console.error(e);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
      }
    };

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–µ—é
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') {
        closeEditModal();
      }
    });

    // ==================== ADD PRICING ====================

    function openAddPricingModal() {
      // –û—á–∏—â—É—î–º–æ —Ñ–æ—Ä–º—É
      document.getElementById('addHub').value = '';
      document.getElementById('addYear').value = new Date().getFullYear();
      document.getElementById('addCrop').value = '';
      document.getElementById('addDistFrom').value = '';
      document.getElementById('addDistTo').value = '';
      document.getElementById('addPriceNoVAT').value = '';
      document.getElementById('addPriceWithVAT').value = '';
      document.getElementById('addPriceType').value = '—Ç/–∫–º';
      
      // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
      document.getElementById('addModal').classList.add('active');
    }

    function closeAddPricingModal() {
      document.getElementById('addModal').classList.remove('active');
    }

    window.saveAddPricing = async function() {
      const hub = document.getElementById('addHub').value.trim();
      const year = parseInt(document.getElementById('addYear').value);
      const crop = document.getElementById('addCrop').value.trim();
      const distFrom = parseFloat(document.getElementById('addDistFrom').value);
      const distTo = parseFloat(document.getElementById('addDistTo').value);
      const priceNoVAT = parseFloat(document.getElementById('addPriceNoVAT').value);
      const priceWithVAT = parseFloat(document.getElementById('addPriceWithVAT').value);
      const priceType = document.getElementById('addPriceType').value;

      // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
      if (!hub) {
        alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ö–∞–±—É');
        return;
      }

      if (!year || year < 2020 || year > 2030) {
        alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ä—ñ–∫ (2020-2030)');
        return;
      }

      if (!crop) {
        alert('–û–±–µ—Ä—ñ—Ç—å –∫—É–ª—å—Ç—É—Ä—É');
        return;
      }

      if (isNaN(distFrom) || isNaN(distTo) || distFrom < 0 || distTo < 0 || distFrom >= distTo) {
        alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ (–≤—ñ–¥ < –¥–æ, –æ–±–∏–¥–≤–∞ > 0)');
        return;
      }

      if (isNaN(priceNoVAT) && isNaN(priceWithVAT)) {
        alert('–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É —Ü—ñ–Ω—É (–±–µ–∑ –ü–î–í –∞–±–æ –∑ –ü–î–í)');
        return;
      }

      if (!priceType || !['—Ç/–∫–º', '–∑–∞ —Ç–æ–Ω—É'].includes(priceType)) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ç–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏');
        return;
      }

      try {
        // –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID
        const docId = `${hub.replace(/\s/g, '_')}_${year}_${crop.replace(/\s/g, '_')}_${distFrom}_${distTo}`;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ç–∞–∫–∞ —Ä–æ–∑—Ü—ñ–Ω–∫–∞ –≤–∂–µ —ñ—Å–Ω—É—î
        const existingDoc = await db.collection('pricing').doc(docId).get();
        if (existingDoc.exists) {
          alert('–†–æ–∑—Ü—ñ–Ω–∫–∞ –∑ —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∂–µ —ñ—Å–Ω—É—î');
          return;
        }

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–≤—É —Ä–æ–∑—Ü—ñ–Ω–∫—É
        await db.collection('pricing').doc(docId).set({
          hub,
          year,
          crop,
          distFrom,
          distTo,
          priceNoVAT: !isNaN(priceNoVAT) ? priceNoVAT : null,
          priceWithVAT: !isNaN(priceWithVAT) ? priceWithVAT : null,
          priceType,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });

        closeAddPricingModal();
        loadPricingTable();
        alert('‚úÖ –†–æ–∑—Ü—ñ–Ω–∫–∞ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞!');
      } catch(e) {
        console.error(e);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
      }
    };

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–µ—é
    document.getElementById('addModal').addEventListener('click', (e) => {
      if (e.target.id === 'addModal') {
        closeAddPricingModal();
      }
    });

    function populateYearFilters() {
      const years = [...new Set(allPricing.map(p => p.year))].sort((a, b) => b - a);
      const hubs = [...new Set(allPricing.map(p => p.hub).filter(Boolean))].sort();
      
      const calcYearSelect = document.getElementById('calcYear');
      const filterYearSelect = document.getElementById('filterYear');
      const filterHubSelect = document.getElementById('filterHub');
      
      calcYearSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫...</option>' + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
      
      filterYearSelect.innerHTML = '<option value="">–í—Å—ñ —Ä–æ–∫–∏</option>' + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
      
      filterHubSelect.innerHTML = '<option value="">–í—Å—ñ —Ö–∞–±–∏</option>' + 
        hubs.map(h => `<option value="${h}">${h}</option>`).join('');
    }

    document.getElementById('filterHub').addEventListener('change', renderPricingTable);
    document.getElementById('filterYear').addEventListener('change', renderPricingTable);
    document.getElementById('filterCrop').addEventListener('change', renderPricingTable);
    
    // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤ —Ç–∞–±–ª–∏—Ü—ñ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
    document.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th) return;
      
      const col = th.getAttribute('data-col');
      if (!col) return;
      
      // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–ø—Ä—è–º–æ–∫
      if (currentSort.col === col) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.col = col;
        currentSort.dir = 'asc';
      }
      
      // –û–Ω–æ–≤–ª—é—î–º–æ UI
      document.querySelectorAll('#routesTable th.sortable').forEach(h => {
        h.classList.remove('active', 'asc', 'desc');
      });
      th.classList.add('active', currentSort.dir);
      
      applyFiltersAndSort();
    });
    
    // –§—ñ–ª—å—Ç—Ä–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
    ['filterFrom', 'filterTo', 'filterDistance', 'filterDivision', 'filterPriceType', 'filterStatus'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', () => {
          if (displayedRoutes.length > 0) {
            applyFiltersAndSort();
          }
        });
      }
    });

    // Populate division selector
    function populateDivisionSelector() {
      const calcDivisionSelect = document.getElementById('calcDivision');
      const divisions = [...new Set(allRoutes.map(r => r.division).filter(d => d && d !== '-'))].sort();
      
      calcDivisionSelect.innerHTML = '<option value="">–í—Å—ñ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–∏</option>' + 
        divisions.map(d => `<option value="${d}">${d}</option>`).join('');
    }
    
    // ==================== INIT ====================
    let userAllowedHubs = [];
    
    async function loadUserHubs() {
      try {
        const user = auth.currentUser;
        if (!user) return;
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) return;
        
        const data = userDoc.data();
        const allowedHubs = data.allowedHubs || data.ALLOWED_HUBS || [];
        
        if (allowedHubs.includes('*')) {
          // Admin: –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ö–∞–±—ã –∏–∑ pricing
          userAllowedHubs = ['*'];
        } else {
          userAllowedHubs = allowedHubs;
        }
      } catch(e) {
        console.error('Load user hubs error:', e);
      }
    }
    
    function populateHubSelector() {
      const calcHubSelect = document.getElementById('calcHub');
      
      if (userAllowedHubs.includes('*')) {
        // Admin: show all hubs from pricing data
        const allHubs = [...new Set(allPricing.map(p => p.hub).filter(Boolean))].sort();
        calcHubSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±...</option>' + 
          allHubs.map(h => `<option value="${h}">${h}</option>`).join('');
      } else if (userAllowedHubs.length === 1) {
        // Single hub: auto-select and disable
        const hub = userAllowedHubs[0];
        calcHubSelect.innerHTML = `<option value="${hub}" selected>${hub}</option>`;
        calcHubSelect.disabled = true;
      } else if (userAllowedHubs.length > 1) {
        // Multiple hubs: show dropdown
        calcHubSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±...</option>' + 
          userAllowedHubs.map(h => `<option value="${h}">${h}</option>`).join('');
      } else {
        // No hubs: show empty
        calcHubSelect.innerHTML = '<option value="">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ö–∞–±—ñ–≤</option>';
        calcHubSelect.disabled = true;
      }
    }
    
    (async () => {
      await loadRoutes();
      populateDivisionSelector();
      await loadUserHubs();
      await loadPricingTable();
    })();
  </script>
</body>
</html>
