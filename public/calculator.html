<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- App config -->
  <script src="/config/config.js"></script>
  <!-- SheetJS –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9fafb; }
    .container { max-width: 1200px; margin: 0 auto; }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 24px; }
    
    .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h2 { margin: 0 0 16px; font-size: 18px; color: #374151; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 16px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 4px; }
    input, select { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #2563eb; }
    
    .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .result-box { background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-top: 20px; }
    .result-box h3 { margin: 0 0 12px; color: #1e40af; }
    .result-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #bfdbfe; }
    .result-item:last-child { border-bottom: none; }
    .result-label { font-weight: 600; color: #374151; }
    .result-value { font-size: 18px; font-weight: 700; color: #1e40af; }
    
    .pricing-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .pricing-table th { background: #f3f4f6; padding: 10px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 2px solid #d1d5db; }
    .pricing-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    .pricing-table tr:hover { background: #f9fafb; }
    
    .upload-zone { border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover { border-color: #2563eb; background: #f0f9ff; }
    .upload-zone.drag-over { border-color: #2563eb; background: #dbeafe; }
    
    .muted { color: #6b7280; font-size: 13px; }
    .error { color: #dc2626; font-size: 13px; margin-top: 4px; }
    .success { color: #16a34a; font-size: 13px; margin-top: 4px; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; margin-bottom: -2px; }
    .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
    .tab:hover { color: #374151; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>

  <!-- AUTH GUARD -->
  <script>
  (function () {
    document.documentElement.style.visibility = 'hidden';
    const CFG = window.APP_CONFIG?.firebase;
    if (!CFG) { console.error('APP_CONFIG.firebase –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'); document.documentElement.style.visibility = 'visible'; return; }
    try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(e) { console.error(e); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const loginURL = '/login.html?next=' + encodeURIComponent(location.pathname);

    auth.onAuthStateChanged(async (u) => {
      if (!u) { location.replace(loginURL); return; }
      
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ
      try {
        const snap = await db.collection('users').doc(u.uid).get({ source: 'server' });
        const role = snap.exists ? (snap.data()?.role || 'pending') : 'pending';
        const allowed = ['admin', 'logist', 'security'].includes(String(role).toLowerCase());
        
        if (!allowed) {
          alert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–ª—å: admin, logist –∞–±–æ security.');
          location.replace('/');
          return;
        }
        
        window.__userRole = role;
        document.documentElement.style.visibility = 'visible';
      } catch(e) {
        console.error(e);
        location.replace(loginURL);
      }
    });
  })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è</h1>
      <div>
        <a href="/index.html" class="btn btn-secondary">üè† –ù–∞ –∫–∞—Ä—Ç—É</a>
        <button id="btnLogout" class="btn btn-secondary">–í–∏–π—Ç–∏</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="calculator">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
      <div class="tab" data-tab="pricing">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑—Ü—ñ–Ω–∫–∞–º–∏</div>
    </div>

    <!-- Tab: Calculator -->
    <div class="tab-content active" data-content="calculator">
      <div class="card">
        <h2>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ</h2>
        
        <div class="form-row">
          <div>
            <label>–•–∞–±</label>
            <select id="calcHub">
              <option value="">–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±...</option>
            </select>
          </div>
          <div>
            <label>–†—ñ–∫ —Ä–æ–∑—Ü—ñ–Ω–∫–∏</label>
            <select id="calcYear">
              <option value="">–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫...</option>
            </select>
          </div>
          <div>
            <label>–ö—É–ª—å—Ç—É—Ä–∞</label>
            <select id="crop">
              <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—É–ª—å—Ç—É—Ä—É...</option>
              <option value="–°–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
              <option value="–ö—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
              <option value="–†—ñ–ø–∞–∫">–†—ñ–ø–∞–∫</option>
              <option value="–ü—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
              <option value="–°–æ—è">–°–æ—è</option>
              <option value="–û—Ä–≥–∞–Ω—ñ–∫–∞">–û—Ä–≥–∞–Ω—ñ–∫–∞</option>
            </select>
          </div>
          <div>
            <label>–í–∞–≥–∞ –≤–∞–Ω—Ç–∞–∂—É, —Ç–æ–Ω–Ω</label>
            <input type="number" id="weight" value="27" step="0.1" placeholder="27">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>–ü–æ—à—É–∫ "–í—ñ–¥" (–∫–æ–¥ –∞–±–æ –Ω–∞–∑–≤–∞)</label>
            <input type="text" id="searchFrom" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∞–±–æ –Ω–∞–∑–≤—É...">
          </div>
          <div>
            <label>–ü–æ—à—É–∫ "–î–æ" (–∫–æ–¥ –∞–±–æ –Ω–∞–∑–≤–∞)</label>
            <input type="text" id="searchTo" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∞–±–æ –Ω–∞–∑–≤—É...">
          </div>
        </div>

        <div style="margin-top: 16px;">
          <button id="btnSearch" class="btn btn-primary">üîç –ó–Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏</button>
          <button id="btnCalculateAll" class="btn btn-primary" style="display: none;">üí∞ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ</button>
          <button id="btnClear" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ -->
        <div id="routesContainer" style="display: none; margin-top: 20px;">
          <h3 style="margin: 0 0 12px; font-size: 16px; color: #374151;">–ó–Ω–∞–π–¥–µ–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏ (<span id="routeCount">0</span>)</h3>
          <div style="overflow-x: auto;">
            <table class="pricing-table">
              <thead>
                <tr>
                  <th>–í—ñ–¥</th>
                  <th>–î–æ</th>
                  <th>–í—ñ–¥—Å—Ç–∞–Ω—å, –∫–º</th>
                  <th>–†–æ–∑—Ü—ñ–Ω–∫–∞</th>
                  <th>–ë–µ–∑ –ü–î–í</th>
                  <th>–ó –ü–î–í</th>
                </tr>
              </thead>
              <tbody id="routesTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- –ó–≤–µ–¥–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="summaryBox" class="result-box" style="display: none; margin-top: 20px;">
          <h3>üìä –ó–≤–µ–¥–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <div class="result-item">
            <span class="result-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç—ñ–≤:</span>
            <span id="sumCount" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–°–µ—Ä–µ–¥–Ω—è –≤—ñ–¥—Å—Ç–∞–Ω—å:</span>
            <span id="sumAvgDistance" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å:</span>
            <span id="sumTotalDistance" class="result-value">-</span>
          </div>
          <div class="result-item" style="border-top: 2px solid #3b82f6; margin-top: 8px; padding-top: 12px;">
            <span class="result-label">–°–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å –±–µ–∑ –ü–î–í:</span>
            <span id="sumAvgPriceNoVAT" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–°—É–º–∞ –±–µ–∑ –ü–î–í:</span>
            <span id="sumTotalPriceNoVAT" class="result-value">-</span>
          </div>
          <div class="result-item" style="border-top: 2px solid #3b82f6; margin-top: 8px; padding-top: 12px;">
            <span class="result-label">–°–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å –∑ –ü–î–í:</span>
            <span id="sumAvgPriceWithVAT" class="result-value">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">–°—É–º–∞ –∑ –ü–î–í:</span>
            <span id="sumTotalPriceWithVAT" class="result-value">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Pricing Management -->
    <div class="tab-content" data-content="pricing">
      <div class="card">
        <h2>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—Ü—ñ–Ω–æ–∫</h2>
        <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ Excel —Ñ–∞–π–ª –∑ —Ä–æ–∑—Ü—ñ–Ω–∫–∞–º–∏. –§–æ—Ä–º–∞—Ç: –•–ê–ë, –†—ñ–∫, –í–Ü–î, –î–û, –ë–µ–∑ –ü–î–í, –ó –ü–î–í, –¢–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏, –ö—É–ª—å—Ç—É—Ä–∞</p>
        
        <div id="uploadZone" class="upload-zone">
          <p style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">üìÅ –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å Excel —Ñ–∞–π–ª —Å—é–¥–∏</p>
          <p class="muted">–∞–±–æ –∫–ª–∞—Ü–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É</p>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>

        <div id="uploadStatus" style="margin-top: 16px;"></div>
      </div>

      <div class="card">
        <h2>–ü–æ—Ç–æ—á–Ω—ñ —Ä–æ–∑—Ü—ñ–Ω–∫–∏</h2>
        
        <div class="form-row">
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –•–∞–±</label>
            <select id="filterHub">
              <option value="">–í—Å—ñ —Ö–∞–±–∏</option>
            </select>
          </div>
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –†—ñ–∫</label>
            <select id="filterYear">
              <option value="">–í—Å—ñ —Ä–æ–∫–∏</option>
            </select>
          </div>
          <div>
            <label>–§—ñ–ª—å—Ç—Ä: –ö—É–ª—å—Ç—É—Ä–∞</label>
            <select id="filterCrop">
              <option value="">–í—Å—ñ –∫—É–ª—å—Ç—É—Ä–∏</option>
              <option value="–°–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
              <option value="–ö—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
              <option value="–†—ñ–ø–∞–∫">–†—ñ–ø–∞–∫</option>
              <option value="–ü—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
              <option value="–°–æ—è">–°–æ—è</option>
              <option value="–û—Ä–≥–∞–Ω—ñ–∫–∞">–û—Ä–≥–∞–Ω—ñ–∫–∞</option>
            </select>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="pricing-table">
            <thead>
              <tr>
                <th>–•–∞–±</th>
                <th>–†—ñ–∫</th>
                <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                <th>–í—ñ–¥, –∫–º</th>
                <th>–î–æ, –∫–º</th>
                <th>–ë–µ–∑ –ü–î–í</th>
                <th>–ó –ü–î–í</th>
                <th>–¢–∏–ø</th>
                <th>–î—ñ—ó</th>
              </tr>
            </thead>
            <tbody id="pricingTableBody">
              <tr><td colspan="9" style="text-align: center;" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // Logout
    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await auth.signOut(); } catch(e) { console.warn(e); }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');
        
        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-content="${targetTab}"]`).classList.add('active');
      });
    });

    // ==================== CALCULATOR ====================
    
    // Load routes for search
    let allRoutes = [];
    async function loadRoutes() {
      try {
        const snapshot = await db.collection('routes')
          .where('approval.status', '==', 'approved')
          .get();
        
        allRoutes = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          allRoutes.push({
            id: doc.id,
            fromCode: d.fromCode || '',
            toCode: d.toCode || '',
            fromName: d.fromName || d.fromLabel || '',
            toName: d.toName || d.toLabel || '',
            distance: d.distance || 0
          });
        });
      } catch(e) {
        console.error('Load routes error:', e);
      }
    }

    // Search routes
    let foundRoutes = [];
    document.getElementById('btnSearch').addEventListener('click', () => {
      const searchFrom = document.getElementById('searchFrom').value.toLowerCase().trim();
      const searchTo = document.getElementById('searchTo').value.toLowerCase().trim();
      
      if (!searchFrom && !searchTo) {
        alert('–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ—à—É–∫—É (–í—ñ–¥ –∞–±–æ –î–æ)');
        return;
      }
      
      foundRoutes = allRoutes.filter(r => {
        const matchFrom = !searchFrom || 
          r.fromCode.toLowerCase().includes(searchFrom) || 
          r.fromName.toLowerCase().includes(searchFrom);
        const matchTo = !searchTo || 
          r.toCode.toLowerCase().includes(searchTo) || 
          r.toName.toLowerCase().includes(searchTo);
        return matchFrom && matchTo;
      });
      
      if (foundRoutes.length === 0) {
        alert('–ú–∞—Ä—à—Ä—É—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        document.getElementById('routesContainer').style.display = 'none';
        document.getElementById('summaryBox').style.display = 'none';
        document.getElementById('btnCalculateAll').style.display = 'none';
        return;
      }
      
      document.getElementById('routeCount').textContent = foundRoutes.length;
      document.getElementById('routesContainer').style.display = 'block';
      document.getElementById('btnCalculateAll').style.display = 'inline-block';
      renderFoundRoutes();
    });

    function renderFoundRoutes() {
      const tbody = document.getElementById('routesTableBody');
      tbody.innerHTML = foundRoutes.map(r => `
        <tr>
          <td>${r.fromName || r.fromCode}</td>
          <td>${r.toName || r.toCode}</td>
          <td>${r.distance.toFixed(2)}</td>
          <td colspan="3" style="text-align: center; color: #6b7280;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ"</td>
        </tr>
      `).join('');
    }

    // Calculate all routes
    document.getElementById('btnCalculateAll').addEventListener('click', async () => {
      const hub = document.getElementById('calcHub').value;
      const year = document.getElementById('calcYear').value;
      const crop = document.getElementById('crop').value;
      const weight = parseFloat(document.getElementById('weight').value) || 27;
      
      if (!hub || !year || !crop) {
        alert('–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±, —Ä—ñ–∫ —Ç–∞ –∫—É–ª—å—Ç—É—Ä—É');
        return;
      }
      
      const tbody = document.getElementById('routesTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫...</td></tr>';
      
      try {
        const results = [];
        for (const route of foundRoutes) {
          const pricing = await findPricingForDistance(hub, year, crop, route.distance);
          if (pricing) {
            const calc = calculatePrice(pricing, route.distance, weight);
            results.push({
              route,
              pricing,
              calc
            });
          } else {
            results.push({
              route,
              pricing: null,
              calc: null
            });
          }
        }
        
        // Render results
        tbody.innerHTML = results.map(r => {
          if (!r.calc) {
            return `
              <tr>
                <td>${r.route.fromName || r.route.fromCode}</td>
                <td>${r.route.toName || r.route.toCode}</td>
                <td>${r.route.distance.toFixed(2)}</td>
                <td colspan="3" style="text-align: center; color: #dc2626;">–†–æ–∑—Ü—ñ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞</td>
              </tr>
            `;
          }
          return `
            <tr>
              <td>${r.route.fromName || r.route.fromCode}</td>
              <td>${r.route.toName || r.route.toCode}</td>
              <td>${r.route.distance.toFixed(2)}</td>
              <td>${r.pricing.priceType}</td>
              <td>${r.calc.priceNoVAT ? r.calc.priceNoVAT.toFixed(2) + ' –≥—Ä–Ω' : '-'}</td>
              <td>${r.calc.priceWithVAT ? r.calc.priceWithVAT.toFixed(2) + ' –≥—Ä–Ω' : '-'}</td>
            </tr>
          `;
        }).join('');
        
        // Calculate summary
        const validResults = results.filter(r => r.calc);
        if (validResults.length > 0) {
          const totalDistance = validResults.reduce((sum, r) => sum + r.route.distance, 0);
          const avgDistance = totalDistance / validResults.length;
          
          const totalPriceNoVAT = validResults.reduce((sum, r) => sum + (r.calc.priceNoVAT || 0), 0);
          const avgPriceNoVAT = totalPriceNoVAT / validResults.length;
          
          const totalPriceWithVAT = validResults.reduce((sum, r) => sum + (r.calc.priceWithVAT || 0), 0);
          const avgPriceWithVAT = totalPriceWithVAT / validResults.length;
          
          document.getElementById('sumCount').textContent = validResults.length;
          document.getElementById('sumAvgDistance').textContent = avgDistance.toFixed(2) + ' –∫–º';
          document.getElementById('sumTotalDistance').textContent = totalDistance.toFixed(2) + ' –∫–º';
          document.getElementById('sumAvgPriceNoVAT').textContent = avgPriceNoVAT.toFixed(2) + ' –≥—Ä–Ω';
          document.getElementById('sumTotalPriceNoVAT').textContent = totalPriceNoVAT.toFixed(2) + ' –≥—Ä–Ω';
          document.getElementById('sumAvgPriceWithVAT').textContent = avgPriceWithVAT.toFixed(2) + ' –≥—Ä–Ω';
          document.getElementById('sumTotalPriceWithVAT').textContent = totalPriceWithVAT.toFixed(2) + ' –≥—Ä–Ω';
          
          document.getElementById('summaryBox').style.display = 'block';
        }
      } catch(e) {
        console.error(e);
        alert('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É: ' + (e.message || e));
      }
    });

    async function findPricingForDistance(hub, year, crop, distance) {
      const snapshot = await db.collection('pricing')
        .where('hub', '==', hub)
        .where('year', '==', parseInt(year))
        .where('crop', '==', crop)
        .get();
      
      let found = null;
      snapshot.forEach(doc => {
        const d = doc.data();
        if (distance >= d.distFrom && distance <= d.distTo) {
          found = { id: doc.id, ...d };
        }
      });
      
      return found;
    }

    function calculatePrice(pricing, distance, weight) {
      const type = pricing.priceType || '—Ç/–∫–º';
      let priceNoVAT = 0;
      let priceWithVAT = 0;
      
      if (type === '—Ç/–∫–º') {
        // –§–æ—Ä–º—É–ª–∞: –≤—ñ–¥—Å—Ç–∞–Ω—å * –≤–∞–≥–∞ * —Ä–æ–∑—Ü—ñ–Ω–∫–∞
        if (pricing.priceNoVAT) {
          priceNoVAT = distance * weight * pricing.priceNoVAT;
        }
        if (pricing.priceWithVAT) {
          priceWithVAT = distance * weight * pricing.priceWithVAT;
        }
      } else if (type === '–∑–∞ —Ç–æ–Ω—É') {
        // –§–æ—Ä–º—É–ª–∞: –≤–∞–≥–∞ * —Ä–æ–∑—Ü—ñ–Ω–∫–∞
        if (pricing.priceNoVAT) {
          priceNoVAT = weight * pricing.priceNoVAT;
        }
        if (pricing.priceWithVAT) {
          priceWithVAT = weight * pricing.priceWithVAT;
        }
      }
      
      return {
        type,
        priceNoVAT: priceNoVAT || null,
        priceWithVAT: priceWithVAT || null,
        rate: type === '—Ç/–∫–º' ? pricing.priceNoVAT || pricing.priceWithVAT : pricing.priceNoVAT || pricing.priceWithVAT
      };
    }

    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('searchFrom').value = '';
      document.getElementById('searchTo').value = '';
      document.getElementById('crop').value = '';
      document.getElementById('weight').value = '27';
      document.getElementById('routesContainer').style.display = 'none';
      document.getElementById('summaryBox').style.display = 'none';
      document.getElementById('btnCalculateAll').style.display = 'none';
      foundRoutes = [];
    });

    // ==================== PRICING MANAGEMENT ====================
    
    // Upload Excel
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    uploadZone.addEventListener('click', () => fileInput.click());
    
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    async function handleFile(file) {
      const status = document.getElementById('uploadStatus');
      status.innerHTML = '<p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';
      
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        
        if (rows.length === 0) {
          status.innerHTML = '<p class="error">‚ùå –§–∞–π–ª –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω–∏—Ö</p>';
          return;
        }
        
        await uploadPricing(rows);
        status.innerHTML = '<p class="success">‚úÖ –†–æ–∑—Ü—ñ–Ω–∫–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!</p>';
        await loadPricingTable();
      } catch(e) {
        console.error(e);
        status.innerHTML = '<p class="error">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (e.message || e) + '</p>';
      }
    }

    async function uploadPricing(rows) {
      const batch = db.batch();
      let count = 0;
      let errors = [];
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const hub = String(row['–•–ê–ë'] || row['—Ö–∞–±'] || row['–•–∞–±'] || '').trim();
        const rowYear = parseInt(row['–†—ñ–∫'] || row['—Ä—ñ–∫'] || 0);
        const distFrom = parseFloat(row['–í–Ü–î'] || row['–≤—ñ–¥'] || 0);
        const distTo = parseFloat(row['–î–û'] || row['–¥–æ'] || 0);
        const priceNoVAT = parseFloat(row['–ë–µ–∑ –ü–î–í'] || row['–±–µ–∑ –ø–¥–≤'] || 0) || null;
        const priceWithVAT = parseFloat(row['–ó –ü–î–í'] || row['–∑ –ø–¥–≤'] || 0) || null;
        const priceType = String(row['–¢–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏'] || row['—Ç–∏–ø —Ä–æ–∑—Ü—ñ–Ω–∫–∏'] || '—Ç/–∫–º').trim();
        const crop = String(row['–ö—É–ª—å—Ç—É—Ä–∞'] || row['–∫—É–ª—å—Ç—É—Ä–∞'] || '').trim();
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (!hub) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –•–ê–ë`);
          continue;
        }
        if (!rowYear || rowYear < 2020 || rowYear > 2030) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –†—ñ–∫ (${rowYear})`);
          continue;
        }
        if (!crop) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –≤—ñ–¥—Å—É—Ç–Ω—è –ö—É–ª—å—Ç—É—Ä–∞`);
          continue;
        }
        if (distFrom === 0 || distTo === 0) {
          errors.push(`–†—è–¥–æ–∫ ${i + 2}: –≤—ñ–¥—Å—Ç–∞–Ω—ñ –Ω–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ 0`);
          continue;
        }
        
        // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID: hub_year_crop_distFrom_distTo
        const docId = `${hub.replace(/\s/g, '_')}_${rowYear}_${crop.replace(/\s/g, '_')}_${distFrom}_${distTo}`;
        const ref = db.collection('pricing').doc(docId);
        
        batch.set(ref, {
          hub,
          year: rowYear,
          crop,
          distFrom,
          distTo,
          priceNoVAT,
          priceWithVAT,
          priceType,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        count++;
      }
      
      if (errors.length > 0) {
        console.warn('–ü–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó:', errors);
        throw new Error(`–û–±—Ä–æ–±–ª–µ–Ω–æ ${count} —Ä—è–¥–∫—ñ–≤. –ü–æ–º–∏–ª–∫–∏: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`);
      }
      
      if (count === 0) {
        throw new Error('–ñ–æ–¥–Ω–æ–≥–æ –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
      }
      
      await batch.commit();
      console.log(`Uploaded ${count} pricing records`);
    }

    // Load pricing table
    let allPricing = [];
    async function loadPricingTable() {
      try {
        const snapshot = await db.collection('pricing').get();
        allPricing = [];
        
        snapshot.forEach(doc => {
          allPricing.push({ id: doc.id, ...doc.data() });
        });
        
        allPricing.sort((a, b) => {
          if (a.hub !== b.hub) return (a.hub || '').localeCompare(b.hub || '', 'uk');
          if (a.year !== b.year) return b.year - a.year;
          if (a.crop !== b.crop) return a.crop.localeCompare(b.crop, 'uk');
          return a.distFrom - b.distFrom;
        });
        
        renderPricingTable();
        populateYearFilters();
        populateHubSelector();
      } catch(e) {
        console.error(e);
      }
    }

    function renderPricingTable() {
      const tbody = document.getElementById('pricingTableBody');
      const hubFilter = document.getElementById('filterHub').value;
      const yearFilter = document.getElementById('filterYear').value;
      const cropFilter = document.getElementById('filterCrop').value;
      
      const filtered = allPricing.filter(p => {
        if (hubFilter && p.hub !== hubFilter) return false;
        if (yearFilter && p.year !== parseInt(yearFilter)) return false;
        if (cropFilter && p.crop !== cropFilter) return false;
        return true;
      });
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;" class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(p => `
        <tr>
          <td>${p.hub || '-'}</td>
          <td>${p.year}</td>
          <td>${p.crop}</td>
          <td>${p.distFrom}</td>
          <td>${p.distTo}</td>
          <td>${p.priceNoVAT ? p.priceNoVAT.toFixed(2) : '-'}</td>
          <td>${p.priceWithVAT ? p.priceWithVAT.toFixed(2) : '-'}</td>
          <td>${p.priceType}</td>
          <td><button class="btn btn-secondary" onclick="deletePricing('${p.id}')">üóë</button></td>
        </tr>
      `).join('');
    }

    window.deletePricing = async function(id) {
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ä–æ–∑—Ü—ñ–Ω–∫—É?')) return;
      try {
        await db.collection('pricing').doc(id).delete();
        loadPricingTable();
      } catch(e) {
        alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message);
      }
    };

    function populateYearFilters() {
      const years = [...new Set(allPricing.map(p => p.year))].sort((a, b) => b - a);
      const hubs = [...new Set(allPricing.map(p => p.hub).filter(Boolean))].sort();
      
      const calcYearSelect = document.getElementById('calcYear');
      const filterYearSelect = document.getElementById('filterYear');
      const filterHubSelect = document.getElementById('filterHub');
      
      calcYearSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫...</option>' + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
      
      filterYearSelect.innerHTML = '<option value="">–í—Å—ñ —Ä–æ–∫–∏</option>' + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
      
      filterHubSelect.innerHTML = '<option value="">–í—Å—ñ —Ö–∞–±–∏</option>' + 
        hubs.map(h => `<option value="${h}">${h}</option>`).join('');
    }

    document.getElementById('filterHub').addEventListener('change', renderPricingTable);
    document.getElementById('filterYear').addEventListener('change', renderPricingTable);
    document.getElementById('filterCrop').addEventListener('change', renderPricingTable);

    // ==================== INIT ====================
    let userAllowedHubs = [];
    
    async function loadUserHubs() {
      try {
        const user = auth.currentUser;
        if (!user) return;
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) return;
        
        const data = userDoc.data();
        const allowedHubs = data.allowedHubs || data.ALLOWED_HUBS || [];
        
        if (allowedHubs.includes('*')) {
          // Admin: –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ö–∞–±—ã –∏–∑ pricing
          userAllowedHubs = ['*'];
        } else {
          userAllowedHubs = allowedHubs;
        }
      } catch(e) {
        console.error('Load user hubs error:', e);
      }
    }
    
    function populateHubSelector() {
      const calcHubSelect = document.getElementById('calcHub');
      
      if (userAllowedHubs.includes('*')) {
        // Admin: show all hubs from pricing data
        const allHubs = [...new Set(allPricing.map(p => p.hub).filter(Boolean))].sort();
        calcHubSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±...</option>' + 
          allHubs.map(h => `<option value="${h}">${h}</option>`).join('');
      } else if (userAllowedHubs.length === 1) {
        // Single hub: auto-select and disable
        const hub = userAllowedHubs[0];
        calcHubSelect.innerHTML = `<option value="${hub}" selected>${hub}</option>`;
        calcHubSelect.disabled = true;
      } else if (userAllowedHubs.length > 1) {
        // Multiple hubs: show dropdown
        calcHubSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ö–∞–±...</option>' + 
          userAllowedHubs.map(h => `<option value="${h}">${h}</option>`).join('');
      } else {
        // No hubs: show empty
        calcHubSelect.innerHTML = '<option value="">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ö–∞–±—ñ–≤</option>';
        calcHubSelect.disabled = true;
      }
    }
    
    (async () => {
      await loadRoutes();
      await loadUserHubs();
      await loadPricingTable();
    })();
  </script>
</body>
</html>
