<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üß≠ GeoJSON Builder (–ø—Ä–æ—Å—Ç–∏–π)</title>
  <!-- Firebase (–¥–ª—è guard —ñ —Ç–æ–∫–µ–Ω–∞) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="/config/config.js"></script>

  <!-- Mapbox GL CSS + fallbacks -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet" />
  <link href="https://unpkg.com/mapbox-gl@2.16.1/dist/mapbox-gl.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/mapbox-gl@2.16.1/dist/mapbox-gl.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.16.1/mapbox-gl.min.css" rel="stylesheet" />
  <!-- Mapbox Draw CSS + fallbacks -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl-draw/1.5.0/mapbox-gl-draw.min.css" rel="stylesheet" />
  <!-- MapLibre CSS fallback (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è Mapbox) -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    :root{ --w: 1160px; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7fb; color:#111; }
    header{ max-width:var(--w); margin:16px auto 8px; padding:0 12px; display:flex; justify-content:space-between; align-items:center; }
    h1{ margin:0; font-size:18px; }
    .muted{ color:#666; font-size:12px; }
    .card{ max-width:var(--w); margin:10px auto; padding:14px; background:#fff; border-radius:14px; box-shadow:0 6px 22px rgba(0,0,0,.06); }
    label{ font-size:12px; color:#334; display:block; margin-bottom:6px; }
    input[type=text], select{ width:100%; border:1px solid #d6dbe3; border-radius:10px; padding:8px 10px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    button{ height:36px; padding:0 14px; border-radius:10px; border:1px solid #d6dbe3; background:#0f62fe; color:#fff; cursor:pointer; font-weight:600; }
    button.ghost{ background:#fff; color:#0f62fe; }
    #guard{ position:fixed; inset:0; background:#fff; display:flex; align-items:center; justify-content:center; z-index:9999; }
    #guard.hide{ display:none; }
    .ok{ color:#2e7d32; font-weight:600; }
    .err{ color:#c62828; font-weight:600; }
    pre{ background:#0b1020; color:#e0e6ff; border-radius:12px; padding:12px; overflow:auto; max-height:50vh; }
    /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π CSS-—Ñ–æ–ª–±–µ–∫ –¥–ª—è Mapbox GL, —è–∫—â–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π CSS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è */
    #map{ position: relative; height:560px; border-radius:12px; overflow:hidden; background:#eef2ff }
    #map .mapboxgl-map{ position: relative; height:100%; }
    #map .mapboxgl-canvas{ position:absolute !important; top:0; left:0; width:100% !important; height:100% !important; }
    #map .mapboxgl-control-container{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    #map .mapboxgl-ctrl-top-left,
    #map .mapboxgl-ctrl-top-right,
    #map .mapboxgl-ctrl-bottom-left,
    #map .mapboxgl-ctrl-bottom-right{ position:absolute; z-index:2; pointer-events:auto; }
    #map .mapboxgl-ctrl-top-right{ top:0; right:0; }
  </style>
</head>
<body>
  <div id="guard"><div class="card" style="max-width:520px; text-align:center;"><h2 style="margin:0 0 6px;">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É‚Ä¶</h2><div class="muted">–°—Ç–æ—Ä—ñ–Ω–∫–∞ –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤</div></div></div>
  <header>
    <h1>üß≠ GeoJSON Builder <span class="muted">(–ø—Ä–æ—Å—Ç–∏–π)</span></h1>
    <div class="muted" id="userBox">‚Äî</div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label>–ú–∞–ª—é–≤–∞–Ω–Ω—è –≥–µ–æ–∑–æ–Ω –Ω–∞ –º–∞–ø—ñ</label>
        <div id="map"></div>
        <div class="actions" style="margin-top:8px; gap:6px;">
          <button id="btnDrawPoly" type="button" class="ghost">‚úèÔ∏è –ü–æ–ª—ñ–≥–æ–Ω</button>
          <button id="btnDelSel" type="button" class="ghost">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω–µ</button>
          <button id="btnClearAll" type="button" class="ghost">‚ôªÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
          <span class="muted" id="featInfo">‚Äî</span>
        </div>
      </div>
      <div>
        <div class="row3">
          <div><label>–ù–∞–∑–≤–∞ (Name)</label><input id="inName" type="text" placeholder="–ù–∞–ø—Ä.: –õ–µ—Ç–∏—á—ñ–≤ –∞–≥—Ä–æ –¢–û–í" /></div>
          <div><label>GUID</label><input id="inGuid" type="text" placeholder="–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ" /></div>
          <div><label>Code (–¶–ë)</label><input id="inCode" type="text" placeholder="–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ" /></div>
        </div>
        <div class="row3" style="margin-top:8px;">
          <div><label>Farm (–í–ü)</label><input id="inFarm" type="text" placeholder="–í–ü" /></div>
          <div><label>Client (–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ)</label><input id="inClient" type="text" placeholder="–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ" /></div>
          <div><label>–ù–∞–∑–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó (name)</label><input id="inCollectionName" type="text" placeholder="–ù–∞–ø—Ä.: –õ–µ—Ç –ê–≥—Ä–æ" /></div>
        </div>
        <div class="row3" style="margin-top:8px;">
          <div>
            <label>–†–µ–∂–∏–º</label>
            <select id="inMode">
              <option value="new">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ù–û–í–ò–ô —Ñ–∞–π–ª</option>
              <option value="append">–î–æ–¥–∞—Ç–∏ –≤ –Ü–°–ù–£–Æ–ß–ò–ô —Ñ–∞–π–ª</option>
            </select>
          </div>
          <div id="newBlock">
            <label>–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É</label>
            <input id="inOutName" type="text" value="geozones.geojson" />
          </div>
          <div id="appendBlock" style="display:none;">
            <label>–í–∏–±–µ—Ä—ñ—Ç—å —ñ—Å–Ω—É—é—á–∏–π —Ñ–∞–π–ª (.json/.geojson)</label>
            <input id="inFile" type="file" accept=".json,.geojson,application/json" />
          </div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button id="btnApplyProps" type="button" class="ghost">‚úÖ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ</button>
          <button id="btnBuild" type="button">–ó—ñ–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</button>
          <button id="btnDownload" type="button" class="ghost" disabled>–°–∫–∞—á–∞—Ç–∏</button>
          <a id="hiddenDl" style="display:none"></a>
        </div>
        <div id="msg" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <div class="muted">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª—É</div>
      <div><button class="ghost" id="btnCopy">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button></div>
    </div>
    <pre id="outPre">‚Äî</pre>
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <div class="muted">–°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–∏</div>
      <div class="muted" id="mapMsg"></div>
    </div>
    <div class="muted" style="margin-top:6px;">–ü–æ—Ä–∞–¥–∞: —è–∫—â–æ –ø–æ–ª—ñ–≥–æ–Ω –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äî –Ω–∞–±–ª–∏–∑—å—Ç–µ –∫–∞—Ä—Ç—É (–º–∞—Å—à—Ç–∞–± 15‚Äì17), –±–æ —É tilesets –¥—Ä—ñ–±–Ω—ñ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –∑‚Äô—è–≤–ª—è—é—Ç—å—Å—è –ª–∏—à–µ –Ω–∞ –≤–∏—Å–æ–∫–∏—Ö –∑—É–º–∞—Ö.</div>
  </div>

  <!-- Mapbox GL/Draw JS (lazy –∑ fallback) -->
  <script>
  // Firebase init + –ø—Ä–æ—Å—Ç–∏–π guard –Ω–∞ —Ä–æ–ª—å admin
  (function initFirebase(){ try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(window.APP_CONFIG?.firebase || {}); } catch(e){} })();
  const auth = firebase.auth();
  const userBox = document.getElementById('userBox');
  auth.onAuthStateChanged(async (user)=>{
    if (!user){ location.href = '/login.html?next=' + encodeURIComponent(location.pathname); return; }
    userBox.textContent = user.email || user.uid;
    // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ —É custom claims role==='admin', –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ, —ñ–Ω–∞–∫—à–µ —Ç–µ–∂ –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ (—Å–ø—Ä–æ—Å—Ç–∏–ª–∏ –Ω–∞ –ø—Ä–æ—Ö–∞–Ω–Ω—è "–∑ –Ω—É–ª—è")
    document.getElementById('guard').classList.add('hide');
    try { await ensureMap(); setTimeout(()=>{ try{ __map && __map.resize(); }catch(_){ } }, 0); } catch(_){ }
  });

  // UI refs
  const inName = document.getElementById('inName');
  const inGuid = document.getElementById('inGuid');
  const inCode = document.getElementById('inCode');
  const inFarm = document.getElementById('inFarm');
  const inClient = document.getElementById('inClient');
  const inCollectionName = document.getElementById('inCollectionName');
  const inMode = document.getElementById('inMode');
  const inOutName = document.getElementById('inOutName');
  const inFile = document.getElementById('inFile');
  const newBlock = document.getElementById('newBlock');
  const appendBlock = document.getElementById('appendBlock');
  const outPre = document.getElementById('outPre');
  const msg = document.getElementById('msg');
  const btnBuild = document.getElementById('btnBuild');
  const btnDownload = document.getElementById('btnDownload');
  const hiddenDl = document.getElementById('hiddenDl');
  const btnCopy = document.getElementById('btnCopy');
  const btnApplyProps = document.getElementById('btnApplyProps');
  const btnDrawPoly = document.getElementById('btnDrawPoly');
  const btnDelSel = document.getElementById('btnDelSel');
  const btnClearAll = document.getElementById('btnClearAll');
  const featInfo = document.getElementById('featInfo');

  inMode.onchange = ()=>{ const m=inMode.value; newBlock.style.display = (m==='new')?'':'none'; appendBlock.style.display = (m==='append')?'':'none'; };

  // Helpers: script loaders
  function loadScriptOnce(src){
    return new Promise((resolve, reject) => {
      const ok = () => resolve(true);
      // already loaded?
      if ((src.includes('mapbox-gl') && window.mapboxgl) || (src.includes('mapbox-gl-draw') && window.MapboxDraw) || (src.includes('maplibre-gl') && window.maplibregl)) return ok();
      const existing = document.querySelector(`script[src="${src}"]`);
      if (existing){ existing.addEventListener('load', ok); existing.addEventListener('error', ()=>reject(new Error('script load error'))); return; }
      const s = document.createElement('script'); s.src = src; s.async = true; s.onload = ok; s.onerror = ()=>reject(new Error('script load error'));
      document.head.appendChild(s);
    });
  }
  function loadScriptAny(sources){
    return new Promise(async (resolve, reject) => {
      for (let i=0; i<sources.length; i++){
        try{ await loadScriptOnce(sources[i]); return resolve(true); }catch(_){ }
      }
      reject(new Error('all script sources failed'));
    });
  }

  // Geometry helpers
  function isValidPosition(p){ return Array.isArray(p) && p.length>=2 && isFinite(p[0]) && isFinite(p[1]); }
  function ensureClosedRing(coords){
    try{ let ring = (coords||[]).filter(isValidPosition); if (!ring.length) return [];
      const a=ring[0], b=ring[ring.length-1]; if (a[0]!==b[0]||a[1]!==b[1]) ring = ring.concat([a]);
      return ring.length>=4 ? ring : []; }catch(_){ return []; }
  }
  function ringSignedArea(r){ try{ let s=0; for(let i=0;i<r.length-1;i++){ const [x1,y1]=r[i], [x2,y2]=r[i+1]; s+= (x2-x1)*(y2+y1);} return -s; }catch(_){ return 0; } }
  function orientRings(rings){ if(!Array.isArray(rings)||!rings.length) return []; const out=[]; rings.forEach((r,i)=>{ const ring=ensureClosedRing(r); if(!ring.length) return; const isCCW = ringSignedArea(ring)>0; const needCCW=(i===0); out.push( (needCCW&&!isCCW)||(!needCCW&&isCCW) ? [...ring].reverse() : ring ); }); return out; }
  function normalizeGeometry(g){ if(!g) return null; if(g.type==='Polygon'){ const rings=orientRings(g.coordinates||[]); if(!rings.length) return null; return {type:'Polygon', coordinates:rings}; } if(g.type==='MultiPolygon'){ const polys=(g.coordinates||[]).map(rr=>orientRings(rr||[])).filter(r=>r&&r.length); if(!polys.length) return null; return {type:'MultiPolygon', coordinates:polys}; } return null; }

  // Map
  let __map = null;
  function getMapLibreSatelliteStyle(){
    // –ü—Ä–æ—Å—Ç–∏–π —Å—Ç–∏–ª—å: —Å—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –ø—ñ–¥–∫–ª–∞–¥–∫–∞ Esri World Imagery (–±–µ–∑ –∫–ª—é—á–∞)
    return {
      version: 8,
      sources: {
        esri: {
          type: 'raster',
          tiles: [
            'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          ],
          tileSize: 256,
          attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community'
        }
      },
      layers: [
        { id: 'esri-base', type: 'raster', source: 'esri', minzoom: 0, maxzoom: 19 }
      ]
    };
  }
  async function ensureMap(){
    if (__map) return __map;
    const mapMsg = document.getElementById('mapMsg');
    try{
      const token = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
      // 1) –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Mapbox GL –∑ –∫—ñ–ª—å–∫–æ—Ö CDN
      if (!window.mapboxgl){
        await loadScriptAny([
          'https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js',
          'https://unpkg.com/mapbox-gl@2.16.1/dist/mapbox-gl.js',
          'https://cdn.jsdelivr.net/npm/mapbox-gl@2.16.1/dist/mapbox-gl.js',
          'https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.16.1/mapbox-gl.min.js'
        ]).catch(()=>{});
      }

      let GL = null; let usingMapbox = false;
      if (window.mapboxgl){ GL = window.mapboxgl; usingMapbox = true; }
      else {
        // 2) –§–æ–ª–±–µ–∫: MapLibre GL (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞). –°–ø—Ä–æ–±—É—î–º–æ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏, —è–∫—â–æ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è Mapbox
        await loadScriptAny([
          'https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js',
          'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js'
        ]).catch(()=>{});
        if (window.maplibregl){ GL = window.maplibregl; usingMapbox = false; }
      }

      if (!GL){ mapMsg.textContent='–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É: —É—Å—ñ CDN –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ'; return null; }

  if (usingMapbox){ try{ GL.accessToken = token; }catch(_){ } }
  const styleDef = usingMapbox ? 'mapbox://styles/mapbox/satellite-streets-v12' : getMapLibreSatelliteStyle();
  __map = new GL.Map({ container:'map', style: styleDef, center:[30.5,50.45], zoom:5 });
      try { __map.addControl(new GL.NavigationControl({ visualizePitch:true })); } catch(_) { }
      __map.on('load', async ()=>{
        try{
          if (!window.MapboxDraw){
            await loadScriptAny([
              'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js',
              'https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js',
              'https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js',
              'https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl-draw/1.5.0/mapbox-gl-draw.min.js'
            ]).catch(()=>{});
          }
          if (window.MapboxDraw && !__map.__draw){
            __map.__draw = new MapboxDraw({ displayControlsDefault:false });
            __map.addControl(__map.__draw);
            const upd = ()=>updateFeatInfo();
            __map.on('draw.create', upd); __map.on('draw.update', upd); __map.on('draw.delete', upd); __map.on('draw.selectionchange', upd);
            updateFeatInfo();
          }
          mapMsg.textContent = usingMapbox ? '‚úì –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞ (Mapbox Satellite)' : '‚úì –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞ (MapLibre ‚Ä¢ Esri Satellite)';
        }catch(_){ }
      });
    }catch(e){ mapMsg.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É: ' + (e?.message||e); }
    return __map;
  }

  function getDraw(){ try { return __map && __map.__draw; } catch(_) { return null; } }
  function getDrawnPolys(){ try{ const d=getDraw(); if(!d) return []; const all=d.getAll()?.features||[]; return all.filter(f=>f?.geometry && (f.geometry.type==='Polygon'||f.geometry.type==='MultiPolygon')); }catch(_){ return []; } }
  function updateFeatInfo(){ try{ const d=getDraw(); if(!d){ featInfo.textContent='‚Äî'; return; } const all=d.getAll()?.features||[]; const sel=d.getSelectedIds()?.length||0; featInfo.textContent=`–ù–∞–º–∞–ª—å–æ–≤–∞–Ω–æ: ${all.length} ‚Ä¢ –í–∏–¥—ñ–ª–µ–Ω–æ: ${sel}`; }catch(_){ featInfo.textContent='‚Äî'; } }

  // Buttons wiring
  (async function wire(){
    await ensureMap();
    const d = getDraw();
    if (btnDrawPoly) btnDrawPoly.onclick = ()=> d && d.changeMode('draw_polygon');
    if (btnDelSel) btnDelSel.onclick = ()=>{ try{ const ids=d?.getSelectedIds()||[]; if(ids.length) d.delete(ids); updateFeatInfo(); }catch(_){ } };
    if (btnClearAll) btnClearAll.onclick = ()=>{ try{ d?.deleteAll(); updateFeatInfo(); }catch(_){ } };
    if (btnApplyProps) btnApplyProps.onclick = ()=>{
      try{
        const ids = d?.getSelectedIds() || [];
        if (!ids.length){ msg.textContent='–ù–µ–º–∞—î –≤–∏–¥—ñ–ª–µ–Ω–∏—Ö —Ñ—ñ–≥—É—Ä'; msg.className='err'; return; }
        const pr = { Name: inName.value.trim(), GUID: inGuid.value.trim(), Code: inCode.value.trim(), Farm: inFarm.value.trim(), Client: inClient.value.trim() };
        for (const id of ids){ for (const [k,v] of Object.entries(pr)) d.setFeatureProperty(id, k, v); }
        msg.textContent='–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –¥–æ –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ'; msg.className='ok';
      }catch(e){ msg.textContent=e?.message||String(e); msg.className='err'; }
    };
  })();

  // Build + Download
  let __dlURL = null;
  function prepareDownload(text, filename){ try{ if(__dlURL){ URL.revokeObjectURL(__dlURL); __dlURL=null; } }catch(_){ } const blob = new Blob([text], {type:'application/json'}); __dlURL = URL.createObjectURL(blob); if(hiddenDl){ hiddenDl.href=__dlURL; hiddenDl.download = filename || 'geozones.geojson'; } btnDownload.onclick = ()=>{ try{ hiddenDl?.click(); }catch(_){ window.open(__dlURL,'_blank'); } }; }

  function buildFeatureFromDraw(f, propsBase){
    const geom = normalizeGeometry(f.geometry); if (!geom) return null;
    const pr = Object.assign({}, propsBase, (f.properties||{}));
    return { type:'Feature', properties: pr, geometry: geom };
  }

  function makeHeader(collectionName){
    return {
      type: 'FeatureCollection',
      name: collectionName || '',
      crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
      features: []
    };
  }

  btnBuild.onclick = async () => {
    try{
      msg.textContent='–ë—É–¥—É—é‚Ä¶'; msg.className='muted'; btnDownload.disabled=true; outPre.textContent='‚Äî';
      const drawn = getDrawnPolys(); if (!drawn.length) throw new Error('–ù–∞–º–∞–ª—é–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–∏–Ω –ø–æ–ª—ñ–≥–æ–Ω');
      const propsBase = {
        Name: inName.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
        GUID: inGuid.value.trim() || '',
        Code: inCode.value.trim() || '',
        Farm: inFarm.value.trim() || '',
        Client: inClient.value.trim() || ''
      };
      const features = [];
      let idx=1;
      for (const f of drawn){
        const feat = buildFeatureFromDraw(f, propsBase); if (!feat) continue;
        if (!feat.properties.Name || feat.properties.Name.trim()===''){ feat.properties.Name = `${propsBase.Name} ${idx++}`; }
        features.push(feat);
      }
      if (!features.length) throw new Error('–ù–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–∏—Ö –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤');

      let out = null;
      if (inMode.value==='append'){
        const file = inFile.files && inFile.files[0]; if (!file) throw new Error('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è');
        const text = await file.text(); let existing=null; try{ existing=JSON.parse(text); }catch(e){ existing=null; }
        const collName = (existing && typeof existing.name==='string') ? existing.name : (inCollectionName.value.trim() || '');
        out = makeHeader(collName);
        const prev = (existing && existing.type==='FeatureCollection' && Array.isArray(existing.features)) ? existing.features.filter(x=>x && x.type==='Feature') : [];
        out.features = prev.concat(features);
      } else {
        out = makeHeader(inCollectionName.value.trim());
        out.features = features;
      }

      const json = JSON.stringify(out, null, 2);
      outPre.textContent = json; btnDownload.disabled=false; msg.textContent='–ì–æ—Ç–æ–≤–æ'; msg.className='ok';
      prepareDownload(json, (inMode.value==='new' ? (inOutName.value.trim()||'geozones.geojson') : (inFile.files?.[0]?.name || 'geozones.geojson')));
      btnCopy.onclick = ()=>{ try{ navigator.clipboard.writeText(json); msg.textContent='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'; msg.className='ok'; }catch(e){ msg.textContent='–ù–µ –≤–¥–∞–ª–æ—Å—å —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏'; msg.className='err'; } };
    }catch(e){ msg.textContent = e?.message || String(e); msg.className='err'; }
  };

  // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∫–∞—Ä—Ç–∏
  (function bootstrap(){ setTimeout(()=>{ ensureMap(); }, 0); })();
  </script>
</body>
</html>
