<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoJSON Builder (–∞–¥–º—ñ–Ω)</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script src="/config/config.js"></script>
  <!-- Firebase (–¥–ª—è –ø—ñ–¥—Ç—è–∂–∫–∏ tilesets –∑ Firestore, —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–æ) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Turf.js –¥–ª—è —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤ –ø—ñ–¥–ø–∏—Å—ñ–≤ -->
  <script>
    (function(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js';
      document.head.appendChild(s);
    })();
  </script>
  <style>
    :root{ --w:1180px; }
    *{ box-sizing: border-box; }
    html{ background:#f6f7fb; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
    header{ max-width:var(--w); margin:16px auto 10px; padding:0 12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    header h1{ font-size:18px; margin:0; font-weight:700; }
    .muted{ color:#667; font-size:12px; }
    .wrap{ max-width:var(--w); margin:0 auto 16px; padding:0 12px; display:grid; grid-template-columns:320px 1fr; gap:12px; }
    .card{ background:#fff; border-radius:14px; box-shadow:0 6px 22px rgba(0,0,0,.06); padding:12px; }
    label{ font-size:12px; color:#334; display:block; margin:10px 0 6px; }
    input[type=text], input[type=file], select{ width:100%; height:36px; border:1px solid #d6dbe3; border-radius:10px; padding:0 10px; }
    textarea{ width:100%; min-height:120px; border:1px solid #d6dbe3; border-radius:10px; padding:8px 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button{ height:36px; padding:0 14px; border-radius:10px; border:1px solid #d6dbe3; background:#0f62fe; color:#fff; cursor:pointer; font-weight:600; }
    button.ghost{ background:#fff; color:#0f62fe; }
    button.warn{ background:#f59e0b; border-color:#f59e0b; }
    button.danger{ background:#ef4444; border-color:#ef4444; }
    #map{ height:78vh; min-height:520px; border-radius:14px; overflow:hidden; }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
    th, td{ padding:6px 8px; border-bottom:1px solid #eef1f6; text-align:left; white-space:nowrap; }
    thead th{ position:sticky; top:0; background:#fafbff; z-index:1; }
    .hint{ font-size:12px; color:#555; }
    /* –ù–∏–∂–Ω—ñ–π –ª—ñ–≤–∏–π –¥–æ–∫: —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–∏ + –ø–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤ */
    .style-dock{
      position:fixed; left:8px; bottom:8px; z-index:3500;
      display:flex; align-items:center; gap:6px;
      background:#fff; border:1px solid #d6dbe3; border-radius:12px; padding:6px 8px;
      box-shadow:0 2px 12px rgba(0,0,0,.12);
    }
    .style-dock select,
    .style-dock input[type="text"]{
      border:1px solid #d6dbe3; border-radius:10px;
      padding:6px 8px; font-size:13px; background:#fff; color:#111;
    }
    .style-dock input[type="text"]{ width:200px; }
    .style-dock .mapbox-brand{ font-size:11px; color:#6b7280; border-left:1px dashed #e5e7eb; padding-left:8px; }
  </style>
</head>
<body>
  <header>
    <h1>GeoJSON Builder <span class="muted">(–ø–æ–ª—ñ–≥–æ–Ω–∏ –¥–ª—è Tilesets)</span></h1>
    <div class="row">
      <button class="ghost" onclick="location.href='/index.html'">üè† –ù–∞ –∫–∞—Ä—Ç—É</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h3 style="margin:4px 0 8px;">–§–∞–π–ª</h3>
      <label>–ù–∞–∑–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó (FeatureCollection.name)</label>
      <input id="fcName" type="text" placeholder="–ù–∞–ø—Ä.: –õ–µ—Ç –ê–≥—Ä–æ" />
      <div class="row" style="margin-top:8px;">
        <button id="btnNew">‚ûï –ù–æ–≤–∏–π —Ñ–∞–π–ª</button>
        <input id="fileInput" type="file" accept=".json,.geojson" />
        <button id="btnLoad" class="ghost">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
      </div>
      <div class="hint" id="state">‚Äî</div>

      <h3 style="margin:12px 0 8px;">–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –≥–µ–æ–∑–æ–Ω–∏ (Feature.properties)</h3>
      <label>Name</label>
      <input id="pName" type="text" placeholder="–ù–∞–∑–≤–∞ –≥–µ–æ–∑–æ–Ω–∏" />
      <label>GUID (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
      <input id="pGUID" type="text" placeholder="–û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥" />
      <label>Code (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
      <input id="pCode" type="text" placeholder="–ö–æ–¥ –¶–ë" />
      <label>Farm (–í–ü)</label>
      <input id="pFarm" type="text" placeholder="–í–ü" />
      <label>Client (–ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ)</label>
      <input id="pClient" type="text" placeholder="–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ" />

      <div class="row" style="margin-top:10px;">
        <button id="btnUseDrawn">üß© –î–æ–¥–∞—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω —ñ–∑ –∫–∞—Ä—Ç–∏</button>
        <button id="btnClearDraw" class="ghost">–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω –Ω–∞ –∫–∞—Ä—Ç—ñ</button>
      </div>

      <div class="row" style="margin-top:8px;">
        <button id="btnDeleteFeature" class="danger">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –≥–µ–æ–∑–æ–Ω—É –∑ —Ñ–∞–π–ª—É</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnDownload" class="warn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç–∏ GeoJSON</button>
        <button id="btnCopy" class="ghost">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button>
      </div>

      <h3 style="margin:16px 0 8px;">–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h3>
      <label class="row" style="gap:8px; align-items:center;">
        <input id="chkShowLoaded" type="checkbox" checked /> –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π —Ñ–∞–π–ª –Ω–∞ –∫–∞—Ä—Ç—ñ
      </label>

      <h3 style="margin:16px 0 8px;">–ì–µ–æ–∑–æ–Ω–∏ –∑ Mapbox Tilesets</h3>
      <div class="row" style="margin-bottom:8px;">
        <button id="btnToggleTilesets" class="ghost">üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏</button>
        <button id="btnReloadTilesets" class="ghost" title="–ü—Ä–∏–º—É—Å–æ–≤–æ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥ (debug)">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
      </div>
      <div id="tilesetInfo" class="hint" style="min-height:18px"></div>
    </div>

    <div class="card" style="display:grid; grid-template-rows:auto 1fr; gap:10px;">
      <div class="row" style="justify-content:space-between;">
        <div class="hint">–ù–∞–º–∞–ª—é–π—Ç–µ –ø–æ–ª—ñ–≥–æ–Ω —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º Draw Polygon, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ ‚Äî —Ä–µ–¥–∞–≥—É–π—Ç–µ –≤–µ—Ä—à–∏–Ω–∏.</div>
        <div class="row"><button id="btnShowJson" class="ghost">–ü–æ–∫–∞–∑–∞—Ç–∏ JSON</button></div>
      </div>
      <div id="map"></div>
      <div id="jsonWrap" class="card" style="display:none; padding:8px;">
        <textarea id="jsonOut" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç–∏–ª—é —Ç–∞ –ø–æ—à—É–∫ –º—ñ—Å—Ü—å (—è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π) -->
  <div id="styleDock" class="style-dock" title="–°—Ç–∏–ª—å –∫–∞—Ä—Ç–∏ —Ç–∞ –ø–æ—à—É–∫">
    <select id="mapStyleDock">
      <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
      <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
      <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
    </select>
    <input id="placeSearch" type="text" list="placeList" placeholder="–ü–æ—à—É–∫‚Ä¶" autocomplete="off" />
    <datalist id="placeList"></datalist>
    <div class="mapbox-brand">mapbox</div>
  </div>

<script>
(function(){
  const MB_TOKEN = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
  if (!MB_TOKEN){ alert('Mapbox token –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É /config/config.js'); }
  mapboxgl.accessToken = MB_TOKEN;

  let currentStyle = 'mapbox://styles/mapbox/streets-v12';
  const map = new mapboxgl.Map({
    container: 'map',
    style: currentStyle,
    center: [30.5234, 50.4501], // Kyiv
    zoom: 6
  });

  const Draw = new MapboxDraw({
    displayControlsDefault: false,
    controls: { polygon: true, trash: true },
    defaultMode: 'draw_polygon'
  });
  map.addControl(Draw, 'top-left');
  map.addControl(new mapboxgl.NavigationControl(), 'top-left');

  let fc = null; // –ø–æ—Ç–æ—á–Ω–∏–π FeatureCollection
  let TILESETS = [];
  let geozonesVisible = false; // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ
  let __tilesetsUnsub = null;
  let __tilesetsHash = '';

  /* ===== –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –ø—ñ–¥–ø–∏—Å–∏ —Ç–æ–ø–æ–Ω—ñ–º—ñ–≤ —É —Å—Ç–∏–ª—ñ ===== */
  function applyUkrainianLabels(){
    try{
      const style = map.getStyle();
      if (!style || !style.layers) return;
      const ukTextExpr = [
        'coalesce', ['get','name_uk'], ['get','name:uk'], ['get','name_ua'], ['get','name:ua'], ['get','name_local'], ['get','name']
      ];
      (style.layers || []).forEach(l =>{
        if (l.type !== 'symbol') return;
        // –Ω–∞—à—ñ –≤–ª–∞—Å–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏ –Ω–µ —á—ñ–ø–∞—î–º–æ (—É —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Ü–µ "geozones-labels" —ñ–∑ —Ü–µ–Ω—Ç—Ä–æ—ó–¥—ñ–≤)
        if (l.id === 'geozones-labels') return;
        const has = map.getLayoutProperty(l.id, 'text-field');
        if (has !== undefined){ try{ map.setLayoutProperty(l.id, 'text-field', ukTextExpr); }catch(_){}}
      });
    }catch(_){ }
  }

  /* ===== –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∏–ª—é –±–∞–∑–æ–≤–æ—ó –∫–∞—Ä—Ç–∏ ===== */
  function setMapStyle(val){
    try{
      if (!val || val === currentStyle) return;
      currentStyle = val;
      map.setStyle(currentStyle);
      const sel = document.getElementById('mapStyleDock');
      if (sel && sel.value !== val) sel.value = val;
    }catch(_){ }
  }
  document.getElementById('mapStyleDock').addEventListener('change', function(){ setMapStyle(this.value); });

  function newFile(){
    const name = document.getElementById('fcName').value.trim() || '–ì–µ–æ–∑–æ–Ω–∏';
    fc = {
      type: 'FeatureCollection',
      name,
      crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
      features: []
    };
    setState(`–°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π —Ñ–∞–π–ª ¬´${name}¬ª`);
    updatePreview();
  }

  function setState(msg){ document.getElementById('state').textContent = msg; }

  function getDrawnPolygon(){
    const all = Draw.getAll();
    if (!all || !all.features || !all.features.length) return null;
    // —à—É–∫–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ–ª—ñ–≥–æ–Ω
    for (let i = all.features.length - 1; i >= 0; i--){
      const f = all.features[i];
      if (f && f.geometry && f.geometry.type === 'Polygon'){
        const coords = (f.geometry.coordinates && f.geometry.coordinates[0]) ? f.geometry.coordinates[0].slice() : [];
        if (coords.length >= 3){
          // –∑–∞–º–∫–Ω—É—Ç–∏ –∫—ñ–ª—å—Ü–µ, —è–∫—â–æ —Ç—Ä–µ–±–∞
          const first = coords[0];
          const last = coords[coords.length-1];
          if (!last || first[0] !== last[0] || first[1] !== last[1]) coords.push(first.slice());
          return coords;
        }
      }
    }
    return null;
  }

  function addPolygonFromDraw(){
    if (!fc){ alert('–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Ñ–∞–π–ª –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —ñ—Å–Ω—É—é—á–∏–π.'); return; }
    const ring = getDrawnPolygon();
    if (!ring){ alert('–ù–µ–º–∞—î –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Draw Polygon.'); return; }
    const props = {
      Name: document.getElementById('pName').value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
      GUID: document.getElementById('pGUID').value.trim(),
      Code: document.getElementById('pCode').value.trim(),
      Farm: document.getElementById('pFarm').value.trim(),
      Client: document.getElementById('pClient').value.trim()
    };
    const feat = { type:'Feature', properties: props, geometry:{ type:'Polygon', coordinates:[ ring ] } };
    fc.features.push(feat);
    setState(`–î–æ–¥–∞–Ω–æ –≥–µ–æ–∑–æ–Ω—É: ${props.Name} (–≤—Å—å–æ–≥–æ ${fc.features.length})`);
    updatePreview();
    updateLoadedOverlay();
  }

  function updatePreview(){
    const out = document.getElementById('jsonOut');
    if (!out) return;
    out.value = fc ? JSON.stringify(fc, null, 2) : '';
  }

  // ===== –ü–æ–∫–∞–∑ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ/—Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ —Ñ–∞–π–ª—É —è–∫ —à–∞—Ä—É =====
  function ensureLoadedOverlay(){
    if (!map.getSource('fc-source')){
      map.addSource('fc-source', { type:'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({ id:'fc-fill', type:'fill', source:'fc-source', paint:{ 'fill-color':'#22c55e', 'fill-opacity': 0.25 } });
      map.addLayer({ id:'fc-line', type:'line', source:'fc-source', paint:{ 'line-color':'#16a34a', 'line-width': 2 } });
    }
  }
  function updateLoadedOverlay(){
    if (!document.getElementById('chkShowLoaded').checked) return; // –Ω–µ –æ–Ω–æ–≤–ª—é—î–º–æ —è–∫—â–æ –≤–∏–º–∫–Ω–µ–Ω–æ
    const data = fc || { type:'FeatureCollection', features: [] };
    try{ map.getSource('fc-source')?.setData(data); }catch(_){ }
  }
  function setLoadedOverlayVisibility(show){
    ensureLoadedOverlay();
    const vis = show ? 'visible' : 'none';
    try{ map.setLayoutProperty('fc-fill','visibility', vis); }catch(_){}
    try{ map.setLayoutProperty('fc-line','visibility', vis); }catch(_){}
    if (show) updateLoadedOverlay();
  }

  function clearDraw(){ try{ Draw.deleteAll(); }catch(_){ } }

  function download(){
    if (!fc || !fc.features.length){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –î–æ–¥–∞–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–∏–Ω –ø–æ–ª—ñ–≥–æ–Ω.'); return; }
    const blob = new Blob([JSON.stringify(fc, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    const nm = (fc.name || 'geozones').replace(/[^a-zA-Z0-9_\-]+/g,'_');
    a.download = nm + '_' + new Date().toISOString().slice(0,10) + '.geojson';
    a.href = URL.createObjectURL(blob);
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 5000);
  }

  function copyJson(){
    if (!fc){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'); return; }
    const txt = JSON.stringify(fc, null, 2);
    navigator.clipboard.writeText(txt).then(()=> setState('JSON —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É'), ()=> alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏'));
  }

  function loadFromFile(file){
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const obj = JSON.parse(String(fr.result||'').trim());
        if (!obj || obj.type !== 'FeatureCollection' || !Array.isArray(obj.features)) throw new Error('–ù–µ FeatureCollection');
        fc = obj;
        document.getElementById('fcName').value = String(fc.name || '');
        setState(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: features=${fc.features.length}`);
        updatePreview();
      }catch(e){
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ GeoJSON: ' + (e?.message || e));
      }
    };
    fr.readAsText(file);
  }

  document.getElementById('btnNew').onclick = newFile;
  document.getElementById('btnUseDrawn').onclick = addPolygonFromDraw;
  document.getElementById('btnClearDraw').onclick = clearDraw;
  document.getElementById('btnDownload').onclick = download;
  document.getElementById('btnCopy').onclick = copyJson;
  document.getElementById('btnLoad').onclick = ()=>{
    const f = document.getElementById('fileInput').files[0];
    if (!f){ alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª .geojson –∞–±–æ .json'); return; }
    loadFromFile(f);
  };
  document.getElementById('btnShowJson').onclick = ()=>{
    const w = document.getElementById('jsonWrap');
    w.style.display = (w.style.display==='none' || !w.style.display) ? 'block' : 'none';
  };
  document.getElementById('chkShowLoaded').onchange = (e)=> setLoadedOverlayVisibility(e.target.checked);

  // ===== –í–∏–¥–∞–ª–µ–Ω–Ω—è –≥–µ–æ–∑–æ–Ω–∏ –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª—É =====
  function featureNameAt(i){
    try{
      const f = (fc && fc.features && fc.features[i]) || null;
      const p = (f && f.properties) || {};
      const name = p.Name || p.name || p['–ù–∞–∑–≤–∞'] || p['–ù–∞–∑–≤–∞ –ø–æ–ª—è'] || p.Code || p.code || `–ë–µ–∑ –Ω–∞–∑–≤–∏ #${i+1}`;
      return String(name);
    }catch(_){ return `–ë–µ–∑ –Ω–∞–∑–≤–∏ #${i+1}`; }
  }
  function listFeatureNames(){
    const out = [];
    if (!fc || !Array.isArray(fc.features)) return out;
    for (let i=0;i<fc.features.length;i++){
      out.push({ index:i, name: featureNameAt(i) });
    }
    return out;
  }
  function promptDeleteFeature(){
    if (!fc || !Array.isArray(fc.features) || fc.features.length === 0){
      alert('–ù–µ–º–∞—î —â–æ –≤–∏–¥–∞–ª—è—Ç–∏: —Ñ–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π.');
      return;
    }
    const list = listFeatureNames();
    const lines = list.map(r => `${r.index+1}) ${r.name}`).join('\n');
    const ans = prompt('–û–±–µ—Ä—ñ—Ç—å, —â–æ –≤–∏–¥–∞–ª–∏—Ç–∏ (–≤–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –∞–±–æ —á–∞—Å—Ç–∏–Ω—É –Ω–∞–∑–≤–∏):\n\n' + lines + '\n\n–ù–∞–ø—Ä.: 2 –∞–±–æ "–ë–∞–ª–∞–Ω–∏"');
    if (ans === null) return; // —Å–∫–∞—Å–æ–≤–∞–Ω–æ
    const q = String(ans).trim();
    if (!q) return;

    // 1) —è–∫—â–æ –≤–≤–µ–ª–∏ —á–∏—Å–ª–æ ‚Äî –ø—Ä—è–º–∞ —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—è
    let idx = NaN;
    if (/^\d+$/.test(q)){
      const num = parseInt(q, 10);
      if (num >= 1 && num <= list.length) idx = list[num-1].index;
    }

    // 2) —è–∫—â–æ –Ω–µ —á–∏—Å–ª–æ –∞–±–æ –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ ‚Äî –ø–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é (contains, –±–µ–∑ —Ä–µ–≥—ñ—Å—Ç—Ä—É)
    if (!Number.isInteger(idx)){
      const ql = q.toLowerCase();
      const matches = list.filter(r => r.name.toLowerCase().includes(ql));
      if (matches.length === 0){ alert('–ù–µ –∑–Ω–∞–π—à–æ–≤ –∂–æ–¥–Ω–æ—ó –≥–µ–æ–∑–æ–Ω–∏ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–º.'); return; }
      if (matches.length > 1){
        const msg = '–ó–Ω–∞–π–¥–µ–Ω–æ –∫—ñ–ª—å–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–∫—ñ–≤. –£—Ç–æ—á–Ω—ñ—Ç—å –Ω–æ–º–µ—Ä:\n\n' + matches.map(r => `${r.index+1}) ${r.name}`).join('\n');
        const pick = prompt(msg);
        if (pick === null) return;
        const n2 = parseInt(String(pick).trim(), 10);
        if (Number.isFinite(n2) && n2 >= 1 && n2 <= list.length){ idx = list[n2-1].index; }
        else { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –Ω–æ–º–µ—Ä.'); return; }
      } else {
        idx = matches[0].index;
      }
    }

    if (!Number.isInteger(idx) || idx < 0 || idx >= fc.features.length){
      alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è.');
      return;
    }

    const name = featureNameAt(idx);
    if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –≥–µ–æ–∑–æ–Ω—É: "${name}"?`)) return;
    try{
      fc.features.splice(idx, 1);
      setState(`–í–∏–¥–∞–ª–µ–Ω–æ: ${name}. –ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${fc.features.length}`);
      updatePreview();
      updateLoadedOverlay();
    }catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + (e?.message || e)); }
  }
  document.getElementById('btnDeleteFeature').onclick = promptDeleteFeature;

  // ===== Tilesets (—è–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ–π: –±–µ—Ä–µ–º–æ Firestore/JSON, –ø–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ) =====
  function getActiveTilesets(){
    // –ø–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ enabled (—è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π)
    return (Array.isArray(TILESETS) ? TILESETS : []).filter(t => t && t.enabled !== false);
  }
  function ensureTilesetLayers(ts){
    const srcId = 'ts-src-' + ts.key;
    if (!map.getSource(srcId)){
      map.addSource(srcId, { type:'vector', url: ts.url });
      const fillId = 'ts-fill-' + ts.key;
      const lineId = 'ts-line-' + ts.key;
      map.addLayer({ id: fillId, type:'fill', source: srcId, 'source-layer': ts.layer, paint:{ 'fill-color':'#0ea5e9', 'fill-opacity': 0.15 }, layout:{ visibility: geozonesVisible ? 'visible' : 'none' } });
      map.addLayer({ id: lineId, type:'line', source: srcId, 'source-layer': ts.layer, paint:{ 'line-color':'#0284c7', 'line-width': 1.5 }, layout:{ visibility: geozonesVisible ? 'visible' : 'none' } });
    }
  }
  // –¶–µ–Ω—Ç—Ä–æ—ó–¥–∏ + –ø—ñ–¥–ø–∏—Å–∏ –≥–µ–æ–∑–æ–Ω (–Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–¥—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∏—Ö fill-—à–∞—Ä—ñ–≤)
  function buildGeozoneCentroids(){
    try{
      if (!window.turf) return;
      const style = map.getStyle();
      if (!style || !Array.isArray(style.layers)) return;
      const fillLayerIds = style.layers.map(l=>l.id).filter(id => id && id.startsWith('ts-fill-'));
      if (!fillLayerIds.length) return;
      const feats = map.queryRenderedFeatures({ layers: fillLayerIds }) || [];
      const out = []; const seen = new Set();
      for (const f of feats){
        const p = f.properties || {};
        const label = p.Name || p.name || p.Code || p.code || '–ü–æ–ª–µ';
        const uniq = `${f.source||'ts'}:${p.id||p.fid||p.OBJECTID||p.OBJECTID_1||p.Code||p.Name||label}`;
        if (seen.has(uniq)) continue;
        let center = null;
        try{ center = turf.centerOfMass(f).geometry.coordinates; }
        catch(_){ try{ const b = turf.bbox(f); center = [(b[0]+b[2])/2,(b[1]+b[3])/2]; }catch(_){ } }
        if (!center) continue;
        out.push({ type:'Feature', geometry:{ type:'Point', coordinates:center }, properties:{ label } });
        seen.add(uniq);
      }
      const fc = { type:'FeatureCollection', features: out };
      if (map.getSource('geozones-centroids')){
        map.getSource('geozones-centroids').setData(fc);
      } else {
        map.addSource('geozones-centroids', { type:'geojson', data: fc });
        map.addLayer({
          id: 'geozones-labels',
          type: 'symbol',
          source: 'geozones-centroids',
          layout: {
            'text-field': ['get','label'],
            'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
            'text-size': 12,
            'text-anchor': 'center',
            'text-allow-overlap': false,
            'visibility': geozonesVisible ? 'visible' : 'none'
          },
          paint: {
            'text-color': '#1f2937',
            'text-halo-color': '#ffffff',
            'text-halo-width': 1.2
          }
        });
      }
    }catch(_){ }
  }
  const rebuildLabelsOnce = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),150); }; })(buildGeozoneCentroids);
  function setAllTilesetsVisibility(show){
    geozonesVisible = !!show;
    const vis = geozonesVisible ? 'visible' : 'none';
    try{
      const style = map.getStyle();
      if (style && Array.isArray(style.layers)){
        style.layers.forEach(l =>{
          const id = l.id || '';
          if (id.startsWith('ts-fill-') || id.startsWith('ts-line-')){
            try{ map.setLayoutProperty(id, 'visibility', vis); }catch(_){}
          }
        });
      }
      // –ü—ñ–¥–ø–∏—Å–∏
      if (map.getLayer('geozones-labels')){ try{ map.setLayoutProperty('geozones-labels','visibility', vis); }catch(_){ } }
    }catch(_){}
    try{
      const b = document.getElementById('btnToggleTilesets');
      if (b) b.textContent = geozonesVisible ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏';
    }catch(_){}
  }
  document.getElementById('btnToggleTilesets').onclick = ()=> setAllTilesetsVisibility(!geozonesVisible);

  // ‚Äî‚Äî‚Äî –ü–µ—Ä–µ–±—É–¥–æ–≤–∞ tilesets —à–∞—Ä—ñ–≤ –ø—ñ–¥ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥ ‚Äî‚Äî‚Äî
  function removeTilesetsCompletely(){
    try{
      // 1) –ü—Ä–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ —à–∞—Ä–∏ tilesets (–∑–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ –ø—Ä–µ—Ñ—ñ–∫—Å—É)
      const style = map.getStyle();
      const ids = [];
      if (style && Array.isArray(style.layers)){
        style.layers.forEach(l => {
          const id = l.id || '';
          if (id.startsWith('ts-fill-') || id.startsWith('ts-line-')) ids.push(id);
        });
      }
      // –∑–Ω—ñ–º–∞—Ç–∏ —à–∞—Ä–∏ —É –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–º—É –ø–æ—Ä—è–¥–∫—É
      ids.reverse().forEach(id => { try{ if (map.getLayer(id)) map.removeLayer(id); }catch(_){ } });

      // 2) –ü—Ä–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ –¥–∂–µ—Ä–µ–ª–∞ tilesets
      const srcs = map.getStyle()?.sources || {};
      Object.keys(srcs).forEach(sid => {
        if (sid.startsWith('ts-src-')){
          try{ if (map.getSource(sid)) map.removeSource(sid); }catch(_){ }
        }
      });
    }catch(_){ }
  }
  function rebuildTilesetsLayers(){
    removeTilesetsCompletely();
    const list = getActiveTilesets();
    list.forEach(ts => ensureTilesetLayers(ts));
    // –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –≤–∏–¥–∏–º—ñ—Å—Ç—å
    setAllTilesetsVisibility(geozonesVisible);
    // –ø–æ–±—É–¥—É–≤–∞—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∏
    buildGeozoneCentroids();
    map.off('moveend', rebuildLabelsOnce);
    map.on('moveend', rebuildLabelsOnce);
  }

  async function loadTilesetsConfig(){
    // –°–ø—Ä–æ–±–∞ Firestore (—ñ –ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–º—ñ–Ω–∏)
    let got = false;
    let sourceName = 'json';
    try{
      const CFG = window.APP_CONFIG && window.APP_CONFIG.firebase;
      if (CFG && window.firebase && typeof firebase.initializeApp === 'function'){
        try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(CFG); } catch(_){ }
        const db = firebase.firestore();
        // –ø–µ—Ä–≤–∏–Ω–Ω–µ —á–∏—Ç–∞–Ω–Ω—è
        const snap = await db.collection('config').doc('tilesets').get({ source:'server' });
        if (snap.exists){
          const d = snap.data();
          const arr = Array.isArray(d) ? d : (d && Array.isArray(d.tilesets) ? d.tilesets : []);
          if (Array.isArray(arr)){
            TILESETS = arr;
            got = true;
            __tilesetsHash = JSON.stringify(getActiveTilesets());
            sourceName = 'firestore';
          }
        }
        // –ø—ñ–¥–ø–∏—Å–∫–∞ realtime
        if (__tilesetsUnsub) { try{ __tilesetsUnsub(); }catch(_){ } __tilesetsUnsub = null; }
        __tilesetsUnsub = db.collection('config').doc('tilesets').onSnapshot(s => {
          try{
            const d = s.data();
            const arr = Array.isArray(d) ? d : (d && Array.isArray(d.tilesets) ? d.tilesets : []);
            if (Array.isArray(arr)){
              TILESETS = arr;
              const h = JSON.stringify(getActiveTilesets());
              if (h !== __tilesetsHash){ __tilesetsHash = h; rebuildTilesetsLayers(); }
              updateTilesetInfo('snapshot');
            }
          }catch(_){ }
        }, err => { console.warn('tilesets onSnapshot:', err?.message||err); });
      }
    }catch(e){ console.warn('tilesets (Firestore) –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π:', e?.message||e); }

    // –§–æ–ª–±–µ–∫ –Ω–∞ —Å—Ç–∞—Ç–∏—á–Ω–∏–π JSON
    if (!got){
      try{
        const res = await fetch('/config/tilesets.json?v=' + Date.now());
        const data = await res.json().catch(()=> null);
        TILESETS = Array.isArray(data) ? data : (data && Array.isArray(data.tilesets) ? data.tilesets : []);
        __tilesetsHash = JSON.stringify(getActiveTilesets());
        sourceName = 'json';
      }catch(e){ console.warn('tilesets.json –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π', e); TILESETS = []; __tilesetsHash = '[]'; }
    }
    updateTilesetInfo('load', sourceName);
  }

  function updateTilesetInfo(stage, sourceName){
    try{
      const box = document.getElementById('tilesetInfo');
      if (!box) return;
      const active = getActiveTilesets();
      const enabledKeys = active.map(t=>t.key).filter(Boolean);
      box.textContent = `(${stage}) –¥–∂–µ—Ä–µ–ª–æ: ${sourceName||'‚Äî'} | enabled: ${enabledKeys.length} | keys: ${enabledKeys.join(', ')}`;
    }catch(_){ }
  }
  document.getElementById('btnReloadTilesets').onclick = async ()=>{ await loadTilesetsConfig(); rebuildTilesetsLayers(); };

  // –ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∏–ª—é: –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —É–∫—Ä. –ø—ñ–¥–ø–∏—Å–∏ —Ç–∞ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –Ω–∞—à—ñ —à–∞—Ä–∏
  map.on('style.load', async ()=>{
    applyUkrainianLabels();
    ensureLoadedOverlay();
    setLoadedOverlayVisibility(document.getElementById('chkShowLoaded').checked);
    // –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ —Å—Ç–∏–ª—é –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —à–∞—Ä–∏ –∑–≥—ñ–¥–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
    rebuildTilesetsLayers();
  });

  // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (–ø–µ—Ä—à–∏–π —Å—Ç–∏–ª—å)
  map.on('load', async ()=>{
    applyUkrainianLabels();
    ensureLoadedOverlay();
    setLoadedOverlayVisibility(true);
    await loadTilesetsConfig();
    rebuildTilesetsLayers();
  });

  // –ê–≤—Ç–æ-—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ñ–∞–π–ª
  newFile();
  // –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç–∏ –π–æ–≥–æ —è–∫ —à–∞—Ä (–ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π)
  setTimeout(()=>{ try{ ensureLoadedOverlay(); setLoadedOverlayVisibility(true); }catch(_){ } }, 0);

  /* ===== –ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤ (–≥–µ–æ–∫–æ–¥–∏–Ω–≥) ===== */
  let __placeSearchTimer = null;
  let __placeResults = [];
  async function suggestPlaces(q){
    try{
      const token = mapboxgl.accessToken || '';
      if (!token) return [];
      const url = new URL('https://api.mapbox.com/geocoding/v5/mapbox.places/' + encodeURIComponent(q) + '.json');
      url.searchParams.set('access_token', token);
      url.searchParams.set('autocomplete', 'true');
      url.searchParams.set('language', 'uk');
      url.searchParams.set('limit', '7');
      url.searchParams.set('types', 'place,locality,neighborhood');
      url.searchParams.set('country', 'ua');
      try{ const c = map.getCenter(); url.searchParams.set('proximity', c.lng + ',' + c.lat); }catch(_){ }
      const res = await fetch(url.toString());
      const data = await res.json();
      const feats = Array.isArray(data?.features) ? data.features : [];
      return feats.map(f => ({ id:f.id, name:f.text_uk || f.text || '', full:f.place_name_uk || f.place_name || '', center:f.center }));
    }catch(_){ return []; }
  }
  function fillPlaceDatalist(rows){
    const list = document.getElementById('placeList');
    if (!list) return;
    list.innerHTML = '';
    rows.forEach(r => { const o = document.createElement('option'); o.value = r.full || r.name; list.appendChild(o); });
  }
  async function flyToPlaceFromInput(){
    const input = document.getElementById('placeSearch');
    const q = (input?.value || '').trim();
    if (!q) return;
    let target = __placeResults.find(r => (r.full || r.name) === q);
    const closePopup = () => { try{ input.blur(); fillPlaceDatalist([]); }catch(_){ } };
    const use = async () => {
      if (target && Array.isArray(target.center)){
        try{ map.flyTo({ center: target.center, zoom: Math.max(map.getZoom()||0, 11), essential:true }); }catch(_){ }
        closePopup();
        return true;
      }
      return false;
    };
    const ok = await use();
    if (!ok){
      const rows = await suggestPlaces(q);
      __placeResults = rows; if (rows.length && Array.isArray(rows[0].center)){
        try{ map.flyTo({ center: rows[0].center, zoom: Math.max(map.getZoom()||0, 11), essential:true }); }catch(_){ }
        closePopup();
      }
    }
  }
  const placeInput = document.getElementById('placeSearch');
  if (placeInput){
    placeInput.addEventListener('input', () => {
      const q = placeInput.value.trim();
      if (__placeSearchTimer) clearTimeout(__placeSearchTimer);
      if (q.length < 2){ fillPlaceDatalist([]); __placeResults = []; return; }
      __placeSearchTimer = setTimeout(async () => {
        const rows = await suggestPlaces(q);
        __placeResults = rows; fillPlaceDatalist(rows);
      }, 450);
    });
    placeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){ e.preventDefault(); flyToPlaceFromInput(); }
      if (e.key === 'Escape'){ fillPlaceDatalist([]); placeInput.blur(); }
    });
    placeInput.addEventListener('change', flyToPlaceFromInput);
  }
})();
</script>
</body>
</html>
