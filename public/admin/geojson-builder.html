<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üß≠ GeoJSON Builder (–∞–¥–º—ñ–Ω)</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="/config/config.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet" />
  <!-- CSS fallback (—è–∫—â–æ api.mapbox.com –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π) -->
  <link href="https://unpkg.com/mapbox-gl@2.16.1/dist/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <!-- Draw CSS fallback -->
  <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <style>
    :root{ --w: 1160px; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7fb; color:#111; }
    header{ max-width:var(--w); margin:18px auto 8px; padding:0 12px; display:flex; justify-content:space-between; align-items:center; }
    h1{ margin:0; font-size:18px; }
    .muted{ color:#666; font-size:12px; }
    .card{ max-width:var(--w); margin:10px auto; padding:14px; background:#fff; border-radius:14px; box-shadow:0 6px 22px rgba(0,0,0,.06); }
    label{ font-size:12px; color:#334; display:block; margin-bottom:6px; }
    input[type=text], textarea, select{ width:100%; border:1px solid #d6dbe3; border-radius:10px; padding:8px 10px; }
    textarea{ min-height:180px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    button{ height:36px; padding:0 14px; border-radius:10px; border:1px solid #d6dbe3; background:#0f62fe; color:#fff; cursor:pointer; font-weight:600; }
    button.ghost{ background:#fff; color:#0f62fe; }
    #guard{ position:fixed; inset:0; background:#fff; display:flex; align-items:center; justify-content:center; z-index:9999; }
    #guard.hide{ display:none; }
    .ok{ color:#2e7d32; font-weight:600; }
    .err{ color:#c62828; font-weight:600; }
    pre{ background:#0b1020; color:#e0e6ff; border-radius:12px; padding:12px; overflow:auto; max-height:50vh; }
    /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π CSS-—Ñ–æ–ª–±–µ–∫ –¥–ª—è Mapbox GL, —è–∫—â–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π CSS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è */
    #mapPreview{ position: relative; }
    #mapPreview .mapboxgl-map{ position: relative; height:100%; }
    #mapPreview .mapboxgl-canvas{ position:absolute !important; top:0; left:0; width:100% !important; height:100% !important; }
    #mapPreview .mapboxgl-control-container{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    #mapPreview .mapboxgl-ctrl-top-left, 
    #mapPreview .mapboxgl-ctrl-top-right, 
    #mapPreview .mapboxgl-ctrl-bottom-left, 
    #mapPreview .mapboxgl-ctrl-bottom-right{ position:absolute; z-index:2; pointer-events:auto; }
    #mapPreview .mapboxgl-ctrl-top-right{ top:0; right:0; }
  </style>
</head>
<body>
<div id="guard"><div class="card" style="max-width:520px; text-align:center;"><h2 style="margin:0 0 6px;">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É‚Ä¶</h2><div class="muted">–°—Ç–æ—Ä—ñ–Ω–∫–∞ –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤</div></div></div>
<header>
  <h1>üß≠ GeoJSON Builder <span class="muted">(–∞–¥–º—ñ–Ω)</span></h1>
  <div class="muted" id="userBox">‚Äî</div>
</header>

<div class="card">
  <div class="row">
    <div>
      <label>–ú–∞–ª—é–≤–∞–Ω–Ω—è –≥–µ–æ–∑–æ–Ω –Ω–∞ –º–∞–ø—ñ</label>
      <div id="mapPreview" style="height:560px; border-radius:12px; overflow:hidden; background:#eef2ff"></div>
      <div class="actions" style="margin-top:8px; gap:6px;">
        <button id="btnDrawPoly" type="button" class="ghost">‚úèÔ∏è –ü–æ–ª—ñ–≥–æ–Ω</button>
        <button id="btnDelSel" type="button" class="ghost">üóë –í–∏–¥–∞–ª–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω–µ</button>
        <button id="btnClearAll" type="button" class="ghost">‚ôªÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
        <span class="muted" id="featInfo">‚Äî</span>
      </div>
      <details style="margin-top:8px;">
        <summary class="muted">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –≤—Å—Ç–∞–≤–∏—Ç–∏ –≥–æ—Ç–æ–≤–∏–π GeoJSON (–Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</summary>
        <textarea id="inpGeo" placeholder='{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[lng,lat],...]]}}]}'></textarea>
      </details>
    </div>
    <div>
      <div class="row3">
        <div><label>–ù–∞–∑–≤–∞ (Name)</label><input id="inName" type="text" placeholder="–ù–∞–ø—Ä.: –ù–µ–º–∏—Ä—ñ–≤ –ñ–î —Å—Ç–∞–Ω—Ü—ñ—è" /></div>
        <div><label>GUID</label><input id="inGuid" type="text" placeholder="–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ" /></div>
        <div><label>Code (–¶–ë)</label><input id="inCode" type="text" placeholder="–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ" /></div>
      </div>
      <div class="row3" style="margin-top:8px;">
        <div><label>Farm (–í–ü)</label><input id="inFarm" type="text" placeholder="–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ" /></div>
        <div><label>Client (–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ)</label><input id="inClient" type="text" placeholder="–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ" /></div>
        <div>
          <label>–†–µ–∂–∏–º</label>
          <select id="inMode">
            <option value="new">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ù–û–í–ò–ô —Ñ–∞–π–ª</option>
            <option value="append">–î–æ–¥–∞—Ç–∏ –≤ –Ü–°–ù–£–Æ–ß–ò–ô —Ñ–∞–π–ª</option>
          </select>
        </div>
      </div>
      <div class="actions" style="margin-top:6px;">
        <button id="btnApplyProps" type="button" class="ghost">‚úÖ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ</button>
        <span class="muted">(–ø–æ–ª–µ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π Name/GUID/Code/Farm/Client –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö —Ñ—ñ–≥—É—Ä)</span>
      </div>
      <div style="margin-top:6px; display:flex; align-items:center; gap:10px;">
        <label style="display:flex; align-items:center; gap:8px; margin:0;">
          <input id="inBatch" type="checkbox"/>
          –ú–∞—Å–æ–≤–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è (–∑ FeatureCollection –∞–±–æ –∫—ñ–ª—å–∫–æ—Ö –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤)
        </label>
        <span class="muted">–Ø–∫—â–æ —É –≤—Ö—ñ–¥–Ω–æ–º—É GeoJSON –∫—ñ–ª—å–∫–∞ –æ–±'—î–∫—Ç—ñ–≤ ‚Äî –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ Feature. –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –∑ –≤—Ö–æ–¥—É –º–∞—é—Ç—å –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –ø–æ–ª—è–º–∏ –ø—Ä–∞–≤–æ—Ä—É—á.</span>
      </div>
      <div id="newBlock" style="margin-top:8px;">
        <label>–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É</label>
        <input id="inOutName" type="text" value="geozones.geojson" />
      </div>
      <div id="appendBlock" style="margin-top:8px; display:none;">
        <label>–í–∏–±–µ—Ä—ñ—Ç—å —ñ—Å–Ω—É—é—á–∏–π —Ñ–∞–π–ª (.json/.geojson)</label>
        <input id="inFile" type="file" accept=".json,.geojson,application/json" />
      </div>
      <div class="actions" style="margin-top:10px;">
        <button id="btnBuild" type="button">–ó—ñ–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</button>
        <button id="btnDownload" type="button" class="ghost" disabled>–°–∫–∞—á–∞—Ç–∏</button>
        <a id="hiddenDl" style="display:none"></a>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<div class="card">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
    <div class="muted">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª—É</div>
    <div><button class="ghost" id="btnCopy">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button></div>
  </div>
  <pre id="outPre">‚Äî</pre>
</div>

<div class="card">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
    <div class="muted">–°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–∏</div>
    <div class="muted" id="mapMsg"></div>
  </div>
  <div class="muted" style="margin-top:6px;">–ü–æ—Ä–∞–¥–∞: —è–∫—â–æ –ø–æ–ª—ñ–≥–æ–Ω –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äî –Ω–∞–±–ª–∏–∑—å—Ç–µ –∫–∞—Ä—Ç—É (–º–∞—Å—à—Ç–∞–± 15‚Äì17), –±–æ —É tilesets –¥—Ä—ñ–±–Ω—ñ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –∑‚Äô—è–≤–ª—è—é—Ç—å—Å—è –ª–∏—à–µ –Ω–∞ –≤–∏—Å–æ–∫–∏—Ö –∑—É–º–∞—Ö.</div>
</div>

<script>
  // Admin guard (reuse from viewer)
  (function initFirebase(){ try { firebase.apps?.length ? firebase.app() : firebase.initializeApp(window.APP_CONFIG?.firebase || {}); } catch(e){} })();
  const auth = firebase.auth(); const db = firebase.firestore();
  const userBox = document.getElementById('userBox');
  auth.onAuthStateChanged(async (user)=>{
    if (!user){ location.href = '/login.html?next=' + encodeURIComponent(location.pathname); return; }
    userBox.textContent = user.email || user.uid;
    const ok = await isAdmin(user); if (!ok){ showGuardError('403: –¥–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤'); return; }
    document.getElementById('guard').classList.add('hide');
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –∫–∞—Ä—Ç–∏ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ —Å–ø–ª–µ—à —Å—Ö–æ–≤–∞–Ω–æ
    try { await ensureMap(); setTimeout(()=>{ try{ __map && __map.resize(); }catch(_){ } }, 0); } catch(_){ }
  });
  async function isAdmin(user){
    try{ const t = await user.getIdTokenResult(true); const c=t.claims||{}; if (c.admin===true || c.role==='admin' || (c.roles && c.roles.admin===true)) return true; }catch(e){}
    try{ const d = await db.collection('users').doc(user.uid).get(); const v=d.data()||{}; if (v.role==='admin' || (v.roles && v.roles.admin===true)) return true; }catch(e){}
    return false;
  }
  function showGuardError(msg){ const g=document.getElementById('guard'); g.classList.remove('hide'); g.innerHTML = `<div class="card" style="max-width:520px; text-align:center;"><h2 style="margin:0 0 6px;">${msg}</h2><div class="muted">–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –≤–ª–∞—Å–Ω–∏–∫–∞ –ø—Ä–æ—î–∫—Ç—É –¥–ª—è –Ω–∞–¥–∞–Ω–Ω—è –ø—Ä–∞–≤.</div></div>`; }

  // UI refs
  const inpGeo = document.getElementById('inpGeo');
  const inName = document.getElementById('inName');
  const inGuid = document.getElementById('inGuid');
  const inCode = document.getElementById('inCode');
  const inFarm = document.getElementById('inFarm');
  const inClient = document.getElementById('inClient');
  const inMode = document.getElementById('inMode');
  const inOutName = document.getElementById('inOutName');
  const inFile = document.getElementById('inFile');
  const newBlock = document.getElementById('newBlock');
  const appendBlock = document.getElementById('appendBlock');
  const outPre = document.getElementById('outPre');
  const msg = document.getElementById('msg');
  const btnBuild = document.getElementById('btnBuild');
  const btnDownload = document.getElementById('btnDownload');
  const hiddenDl = document.getElementById('hiddenDl');
  const btnCopy = document.getElementById('btnCopy');
  const btnApplyProps = document.getElementById('btnApplyProps');
  const btnDrawPoly = document.getElementById('btnDrawPoly');
  const btnDelSel = document.getElementById('btnDelSel');
  const btnClearAll = document.getElementById('btnClearAll');
  const featInfo = document.getElementById('featInfo');

  inMode.onchange = ()=>{ const m=inMode.value; newBlock.style.display = (m==='new')?'':'none'; appendBlock.style.display = (m==='append')?'':'none'; };

  // ===== Geometry normalization helpers =====
  function isValidPosition(p){
    return Array.isArray(p) && p.length >= 2 && isFinite(p[0]) && isFinite(p[1]) && Math.abs(p[0]) <= 180 && Math.abs(p[1]) <= 90;
  }
  function ensureClosedRing(coords){
    try{
      if (!Array.isArray(coords) || coords.length===0) return [];
      // filter invalid points
      let ring = coords.filter(isValidPosition);
      if (ring.length === 0) return [];
      const first = ring[0]; const last = ring[ring.length-1];
      if (first[0] !== last[0] || first[1] !== last[1]) ring = ring.concat([first]);
      // valid linear ring must have at least 4 positions
      return (ring.length >= 4) ? ring : [];
    }catch(_){ return []; }
  }
  // Signed area (shoelace); >0 means counterclockwise (CCW) in lon/lat plane
  function ringSignedArea(ring){
    try{
      let sum = 0;
      for (let i=0, n=ring.length - 1; i<n; i++){
        const [x1,y1] = ring[i];
        const [x2,y2] = ring[i+1];
        sum += (x2 - x1) * (y2 + y1);
      }
      // alternative formulations exist; sign consistency is what matters
      // We'll treat negative as CW, positive as CCW
      return -sum; // flip so positive ~ CCW (common convention)
    }catch(_){ return 0; }
  }
  function orientRings(rings){
    if (!Array.isArray(rings) || !rings.length) return [];
    const out = [];
    rings.forEach((r, idx) => {
      const ring = ensureClosedRing(r);
      if (!ring.length) return;
      const area = ringSignedArea(ring);
      // RFC 7946 right-hand rule: outer ring CCW, inner holes CW
      const shouldBeCCW = (idx === 0);
      const isCCW = area > 0;
      out.push((shouldBeCCW && !isCCW) || (!shouldBeCCW && isCCW) ? [...ring].reverse() : ring);
    });
    return out;
  }

  function asPolygon(geom){
    if (!geom) return null;
    if (String(geom.type) === 'Polygon'){
      let rings = Array.isArray(geom.coordinates) ? geom.coordinates : [];
      if (!rings.length) return null;
      // close and orient all rings (outer + holes)
      rings = orientRings(rings);
      if (!rings.length) return null;
      return { type:'Polygon', coordinates: rings };
    }
    if (String(geom.type) === 'MultiPolygon'){
      const polys = [];
      const m = Array.isArray(geom.coordinates) ? geom.coordinates : [];
      m.forEach(rings => {
        if (Array.isArray(rings) && rings.length){
          const or = orientRings(rings);
          if (or.length) polys.push({ type:'Polygon', coordinates: or });
        }
      });
      return polys; // –º–∞—Å–∏–≤ –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤ (–∫–æ–∂–µ–Ω —ñ–∑ –¥—ñ—Ä–∫–∞–º–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ)
    }
    return null;
  }

  function extractPolygonsFromInput(obj, multiple){
    if (!obj || typeof obj !== 'object') throw new Error('–û—á—ñ–∫—É—î—Ç—å—Å—è JSON –æ–±‚Äô—î–∫—Ç');
    const out = [];
    const pushPoly = (p)=>{ if (Array.isArray(p)) p.forEach(pushPoly); else if (p) out.push(p); };
    if (obj.type==='FeatureCollection' && Array.isArray(obj.features)){
      obj.features.forEach(f=>{ const ap = asPolygon(f?.geometry); pushPoly(ap); });
    } else if (obj.type==='Feature' && obj.geometry){
      const ap = asPolygon(obj.geometry); pushPoly(ap);
    } else if (obj.geometry){
      const ap = asPolygon(obj.geometry); pushPoly(ap);
    } else if (obj.type==='Polygon' && obj.coordinates){
      const ap = asPolygon(obj); pushPoly(ap);
    } else if (Array.isArray(obj.coordinates)){ // { coordinates:[...] }
      const ap = asPolygon({ type:'Polygon', coordinates: obj.coordinates }); pushPoly(ap);
    } else if (Array.isArray(obj)){ // –º–∞—Å–∏–≤ —Ä—ñ–∑–Ω–∏—Ö –æ–±'—î–∫—Ç—ñ–≤
      obj.forEach(item => {
        if (item && typeof item==='object'){
          const ap = item.type ? asPolygon(item) : asPolygon({ type:'Polygon', coordinates:item });
          pushPoly(ap);
        }
      });
    }
    if (!out.length){
      if (multiple) throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ Polygon/MultiPolygon —É –≤–≤–µ–¥–µ–Ω–Ω—ñ');
      throw new Error('–ü–æ—Ç—Ä—ñ–±–µ–Ω Polygon');
    }
    return out;
  }

  function buildFeature(props, polygon){
    return { type:'Feature', properties: props, geometry: polygon };
  }

  function normalizeFC(fc){
    // –°—Ç—Ä–æ–≥–∏–π RFC 7946: –±–µ–∑ "crs" —Ç–∞ –∑–∞–π–≤–∏—Ö –ø–æ–ª—ñ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    const header = { type:'FeatureCollection', features: [] };
    try{
      if (fc && fc.type==='FeatureCollection' && Array.isArray(fc.features)){
        const feats = fc.features.filter(f=>f && f.type==='Feature' && f.geometry);
        header.features = feats;
      }
    }catch(_){ }
    return header;
  }

  let __dlURL = null;
  function prepareDownload(text, filename){
    try{ if (__dlURL) { URL.revokeObjectURL(__dlURL); __dlURL = null; } }catch(_){ }
    const blob = new Blob([text], { type:'application/json' });
    __dlURL = URL.createObjectURL(blob);
    const name = filename || 'geozones.geojson';
    if (hiddenDl){ hiddenDl.href = __dlURL; hiddenDl.download = name; }
    // –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∏–≥–µ—Ä–∏—Ç—å –∫–ª—ñ–∫ –ø–æ —è–∫–æ—Ä—é ‚Äî —Ü–µ –Ω–∞–π–º–µ–Ω—à –ø—Ä–æ–±–ª–µ–º–Ω–∏–π —à–ª—è—Ö —É –±—Ä–∞—É–∑–µ—Ä–∞—Ö
    btnDownload.onclick = () => { try{ hiddenDl?.click(); }catch(_){ window.open(__dlURL, '_blank'); } };
  }

  btnBuild.onclick = async () => {
    try{
      msg.textContent = '–ë—É–¥—É—é‚Ä¶'; msg.className='muted'; btnDownload.disabled = true; outPre.textContent='‚Äî';
      // 1) –±–µ—Ä–µ–º–æ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω—ñ —Ñ—ñ—á—ñ, —è–∫—â–æ –≤–æ–Ω–∏ —î
      const drawnFeats = getDrawnFeatures();

      let obj = null, polys = [];
      if (drawnFeats.length === 0){
        // 2) fallback ‚Äî –ø–∞—Ä—Å–∏–º–æ textarea, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—Å—Ç–∞–≤–∏–≤ JSON
        const raw = (inpGeo?.value || '').trim();
        if (!raw) throw new Error('–ù–∞–º–∞–ª—é–π—Ç–µ –≥–µ–æ–∑–æ–Ω—É –Ω–∞ –º–∞–ø—ñ –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ GeoJSON –≤–Ω–∏–∑—É');
        try{ obj = JSON.parse(raw); }catch(e){ throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π JSON: ' + e.message); }
        polys = extractPolygonsFromInput(obj, document.getElementById('inBatch')?.checked);
      }

      const propsBase = {
        Name: inName.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
        GUID: inGuid.value.trim() || '',
        Code: inCode.value.trim() || '',
        Farm: inFarm.value.trim() || '',
        Client: inClient.value.trim() || ''
      };

      let features = [];
      if (drawnFeats.length > 0){
        let idx = 1;
        drawnFeats.forEach(f => {
          const geom = normalizeGeometry(f.geometry);
          if (!geom) return;
          const pr = Object.assign({}, propsBase, (f.properties||{}));
          if (!pr.Name) pr.Name = `${propsBase.Name} ${idx++}`;
          features.push({ type:'Feature', properties: pr, geometry: geom });
        });
      } else if (obj && obj.type==='FeatureCollection' && Array.isArray(obj.features)){
        let idx = 1;
        obj.features.forEach((f)=>{
          const ap = asPolygon(f?.geometry); if (!ap) return;
          const apply = (p)=>{
            const pr = Object.assign({}, propsBase, (f.properties||{}));
            if (!pr.Name) pr.Name = `${propsBase.Name} ${idx++}`;
            features.push(buildFeature(pr, p));
          };
          Array.isArray(ap) ? ap.forEach(apply) : apply(ap);
        });
      } else {
        let idx = 1;
        polys.forEach(p=>{
          const pr = Object.assign({}, propsBase);
          if (!pr.Name) pr.Name = `${propsBase.Name} ${idx++}`;
          features.push(buildFeature(pr, p));
        });
      }

      let out = null;
      if (inMode.value === 'append'){
        const f = inFile.files && inFile.files[0]; if (!f) throw new Error('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è');
        const text = await f.text();
        let existing = null; try{ existing = JSON.parse(text); }catch(e){ existing = null; }
        const fc = normalizeFC(existing);
        fc.features = (fc.features || []).concat(features);
        out = fc;
      } else {
        out = normalizeFC(null); out.features = features;
      }
      const json = JSON.stringify(out, null, 2);
      outPre.textContent = json; btnDownload.disabled = false; msg.textContent = '–ì–æ—Ç–æ–≤–æ'; msg.className='ok';
      // —Ñ–æ–∫—É—Å –¥–æ –º–µ–∂ —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É
      try { fitToGeoJSONBounds(out); } catch(_){ }
      prepareDownload(json, (inMode.value==='new' ? (inOutName.value.trim()||'geozones.geojson') : (inFile.files?.[0]?.name || 'geozones.geojson')));
      btnCopy.onclick = ()=> { try{ navigator.clipboard.writeText(json); msg.textContent='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'; msg.className='ok'; }catch(e){ msg.textContent='–ù–µ –≤–¥–∞–ª–æ—Å—å —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏'; msg.className='err'; } };
    }catch(e){ msg.textContent = e.message || String(e); msg.className='err'; }
  };

  // ========== MAP PREVIEW (Mapbox GL JS) ==========
  let __map = null;
  function loadScriptOnce(src){
    return new Promise((resolve, reject) => {
      // –≤–∂–µ —î –≥–ª–æ–±–∞–ª
      if (window.mapboxgl) return resolve();
      // –≤–∂–µ –¥–æ–¥–∞–Ω–∏–π —Ç–µ–≥
      const existing = document.querySelector(`script[src="${src}"]`);
      if (existing){ existing.addEventListener('load', ()=>resolve()); existing.addEventListener('error', ()=>reject(new Error('script load error'))); return; }
      const s = document.createElement('script'); s.src = src; s.async = true; s.onload = ()=>resolve(); s.onerror = ()=>reject(new Error('script load error'));
      document.head.appendChild(s);
    });
  }
  function loadScriptAny(sources){
    return new Promise(async (resolve, reject) => {
      for (let i=0; i<sources.length; i++){
        try{ await loadScriptOnce(sources[i]); return resolve(true); }catch(_){ /* try next */ }
      }
      reject(new Error('all script sources failed'));
    });
  }
  async function ensureMap(){
    if (__map) return __map;
    const msgEl = document.getElementById('mapMsg');
    try{
      const token = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
      if (!token){ msgEl.textContent = '‚ö†Ô∏è –ù–µ–º–∞—î Mapbox —Ç–æ–∫–µ–Ω–∞ —É /config/config.js'; return null; }
      // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å mapboxgl –≥–ª–æ–±–∞–ª—É
      if (!window.mapboxgl){
        await loadScriptAny([
          'https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js',
          'https://unpkg.com/mapbox-gl@2.16.1/dist/mapbox-gl.js'
        ]);
      }
      if (!window.mapboxgl){ msgEl.textContent = 'Mapbox GL –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è'; return null; }

      mapboxgl.accessToken = token;
      __map = new mapboxgl.Map({
        container: 'mapPreview',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [30.5, 50.45],
        zoom: 5
      });
      __map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }));
      __map.on('load', async ()=>{
        try{
          if (!__map.getSource('preview')){
            __map.addSource('preview', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
          }
          const isPoly = ['any', ['==',['geometry-type'],'Polygon'], ['==',['geometry-type'],'MultiPolygon']];
          if (!__map.getLayer('preview-fill')){
            __map.addLayer({ id:'preview-fill', type:'fill', source:'preview', filter:isPoly, paint:{ 'fill-color':'#22c55e', 'fill-opacity':0.28 } });
          }
          if (!__map.getLayer('preview-outline')){
            __map.addLayer({ id:'preview-outline', type:'line', source:'preview', filter:isPoly, paint:{ 'line-color':'#16a34a', 'line-width':1.2 } });
          }
          // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –º–∞–ª—é–≤–∞–Ω–Ω—è
          try{
            if (!window.MapboxDraw){
              await loadScriptAny([
                'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js',
                'https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js'
              ]);
            }
            if (window.MapboxDraw && !__map.__draw){
              __map.__draw = new MapboxDraw({ displayControlsDefault:false });
              __map.addControl(__map.__draw);
              // –æ–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ –ø—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –∑–º—ñ–Ω—ñ
              const upd = ()=>updateFeatInfo();
              __map.on('draw.create', upd);
              __map.on('draw.update', upd);
              __map.on('draw.delete', upd);
              __map.on('draw.selectionchange', upd);
              updateFeatInfo();
            }
          }catch(_){ }
          try{ const mm = document.getElementById('mapMsg'); if (mm) mm.textContent = '‚úì –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞'; }catch(_){ }
        }catch(_){ }
      });
    }catch(e){ msgEl.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É: ' + (e?.message||e); }
    return __map;
  }
  function fitToGeoJSONBounds(fc){
    try{
      if (!fc || !fc.features || !fc.features.length) return;
      // –æ–±—á–∏—Å–ª–∏—Ç–∏ bbox –≤—Ä—É—á–Ω—É (–±–µ–∑ turf), –¥–ª—è –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤ –≤–∏—Å—Ç–∞—á–∏—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
      let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
      const scanPos = (p)=>{ const x=+p[0], y=+p[1]; if (!isFinite(x) || !isFinite(y)) return; if (x<minX) minX=x; if (y<minY) minY=y; if (x>maxX) maxX=x; if (y>maxY) maxY=y; };
      const scanGeom = (g)=>{
        if (!g) return;
        if (g.type==='Polygon'){
          (g.coordinates||[]).forEach(r => (r||[]).forEach(scanPos));
        } else if (g.type==='MultiPolygon'){
          (g.coordinates||[]).forEach(poly => (poly||[]).forEach(r => (r||[]).forEach(scanPos)));
        } else if (g.type==='Point'){
          scanPos(g.coordinates||[]);
        } else if (g.type==='MultiPoint' || g.type==='LineString'){
          (g.coordinates||[]).forEach(scanPos);
        } else if (g.type==='MultiLineString'){
          (g.coordinates||[]).forEach(ls => (ls||[]).forEach(scanPos));
        }
      };
      fc.features.forEach(f => scanGeom(f.geometry));
      if (isFinite(minX) && isFinite(minY) && isFinite(maxX) && isFinite(maxY) && __map){
        __map.fitBounds([[minX,minY],[maxX,maxY]], { padding: 30, maxZoom: 16, duration: 500 });
      }
    }catch(_){ }
  }
  async function showPreviewGeoJSON(fc){
    const m = await ensureMap(); if (!m) return;
    const setData = ()=>{
      try{
        const src = m.getSource('preview');
        if (src) src.setData(fc);
        fitToGeoJSONBounds(fc);
      }catch(_){ }
    };
    if (m.loaded()) setData(); else m.once('load', setData);
  }

  // —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫—Ä–∏–ø—Ç–∞ (–ø—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫)
  (function bootstrapMap(){ setTimeout(()=>{ ensureMap(); }, 0); })();

  // ===== Drawing helpers =====
  function getDraw(){ try { return __map && __map.__draw; } catch(_) { return null; } }
  function getDrawnFeatures(){
    try{
      const d = getDraw(); if (!d) return [];
      const all = d.getAll();
      return (all?.features || []).filter(f => f && f.geometry && (f.geometry.type==='Polygon' || f.geometry.type==='MultiPolygon'));
    }catch(_){ return []; }
  }
  function normalizeGeometry(g){
    if (!g) return null;
    if (g.type === 'Polygon'){
      const rings = orientRings(g.coordinates || []);
      if (!rings.length) return null;
      return { type:'Polygon', coordinates: rings };
    }
    if (g.type === 'MultiPolygon'){
      const polys = (g.coordinates || []).map(rings => orientRings(rings || [])).filter(r => r && r.length);
      if (!polys.length) return null;
      return { type:'MultiPolygon', coordinates: polys };
    }
    return null;
  }
  function updateFeatInfo(){
    try{
      const d = getDraw(); if (!d) { featInfo.textContent = '‚Äî'; return; }
      const total = (d.getAll()?.features || []).length;
      const sel = (d.getSelectedIds() || []).length;
      featInfo.textContent = `–ù–∞–º–∞–ª—å–æ–≤–∞–Ω–æ: ${total} ‚Ä¢ –í–∏–¥—ñ–ª–µ–Ω–æ: ${sel}`;
    }catch(_){ featInfo.textContent = '‚Äî'; }
  }

  // buttons actions
  (async function wireButtons(){
    await ensureMap();
    const d = getDraw();
    if (btnDrawPoly){ btnDrawPoly.onclick = ()=> d && d.changeMode('draw_polygon'); }
    if (btnDelSel){ btnDelSel.onclick = ()=> { try{ const ids = d?.getSelectedIds() || []; if (ids.length) d.delete(ids); updateFeatInfo(); }catch(_){ } }; }
    if (btnClearAll){ btnClearAll.onclick = ()=> { try{ d?.deleteAll(); updateFeatInfo(); }catch(_){ } }; }
    if (btnApplyProps){ btnApplyProps.onclick = ()=>{
      try{
        const d2 = getDraw(); if (!d2) return;
        const ids = d2.getSelectedIds() || [];
        if (!ids.length) { msg.textContent = '–ù–µ–º–∞—î –≤–∏–¥—ñ–ª–µ–Ω–∏—Ö —Ñ—ñ–≥—É—Ä'; msg.className='err'; return; }
        const pr = {
          Name: inName.value.trim(),
          GUID: inGuid.value.trim(),
          Code: inCode.value.trim(),
          Farm: inFarm.value.trim(),
          Client: inClient.value.trim()
        };
        for (const id of ids){
          for (const [k,v] of Object.entries(pr)) d2.setFeatureProperty(id, k, v);
        }
        msg.textContent = '–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –¥–æ –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ'; msg.className='ok';
      }catch(e){ msg.textContent = e?.message||String(e); msg.className='err'; }
    }; }
  })();
</script>
</body>
</html>
