<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoJSON Builder (–∞–¥–º—ñ–Ω)</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script src="/config/config.js"></script>
  <style>
    :root{ --w:1180px; }
    *{ box-sizing: border-box; }
    html{ background:#f6f7fb; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
    header{ max-width:var(--w); margin:16px auto 10px; padding:0 12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    header h1{ font-size:18px; margin:0; font-weight:700; }
    .muted{ color:#667; font-size:12px; }
    .wrap{ max-width:var(--w); margin:0 auto 16px; padding:0 12px; display:grid; grid-template-columns:320px 1fr; gap:12px; }
    .card{ background:#fff; border-radius:14px; box-shadow:0 6px 22px rgba(0,0,0,.06); padding:12px; }
    label{ font-size:12px; color:#334; display:block; margin:10px 0 6px; }
    input[type=text], input[type=file], select{ width:100%; height:36px; border:1px solid #d6dbe3; border-radius:10px; padding:0 10px; }
    textarea{ width:100%; min-height:120px; border:1px solid #d6dbe3; border-radius:10px; padding:8px 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button{ height:36px; padding:0 14px; border-radius:10px; border:1px solid #d6dbe3; background:#0f62fe; color:#fff; cursor:pointer; font-weight:600; }
    button.ghost{ background:#fff; color:#0f62fe; }
    button.warn{ background:#f59e0b; border-color:#f59e0b; }
    button.danger{ background:#ef4444; border-color:#ef4444; }
    #map{ height:78vh; min-height:520px; border-radius:14px; overflow:hidden; }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
    th, td{ padding:6px 8px; border-bottom:1px solid #eef1f6; text-align:left; white-space:nowrap; }
    thead th{ position:sticky; top:0; background:#fafbff; z-index:1; }
    .hint{ font-size:12px; color:#555; }
  </style>
</head>
<body>
  <header>
    <h1>GeoJSON Builder <span class="muted">(–ø–æ–ª—ñ–≥–æ–Ω–∏ –¥–ª—è Tilesets)</span></h1>
    <div class="row">
      <button class="ghost" onclick="location.href='/index.html'">üè† –ù–∞ –∫–∞—Ä—Ç—É</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h3 style="margin:4px 0 8px;">–§–∞–π–ª</h3>
      <label>–ù–∞–∑–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó (FeatureCollection.name)</label>
      <input id="fcName" type="text" placeholder="–ù–∞–ø—Ä.: –õ–µ—Ç –ê–≥—Ä–æ" />
      <div class="row" style="margin-top:8px;">
        <button id="btnNew">‚ûï –ù–æ–≤–∏–π —Ñ–∞–π–ª</button>
        <input id="fileInput" type="file" accept=".json,.geojson" />
        <button id="btnLoad" class="ghost">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
      </div>
      <div class="hint" id="state">‚Äî</div>

      <h3 style="margin:12px 0 8px;">–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –≥–µ–æ–∑–æ–Ω–∏ (Feature.properties)</h3>
      <label>Name</label>
      <input id="pName" type="text" placeholder="–ù–∞–∑–≤–∞ –≥–µ–æ–∑–æ–Ω–∏" />
      <label>GUID (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
      <input id="pGUID" type="text" placeholder="–û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥" />
      <label>Code (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
      <input id="pCode" type="text" placeholder="–ö–æ–¥ –¶–ë" />
      <label>Farm (–í–ü)</label>
      <input id="pFarm" type="text" placeholder="–í–ü" />
      <label>Client (–ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ)</label>
      <input id="pClient" type="text" placeholder="–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ" />

      <div class="row" style="margin-top:10px;">
        <button id="btnUseDrawn">üß© –î–æ–¥–∞—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω —ñ–∑ –∫–∞—Ä—Ç–∏</button>
        <button id="btnClearDraw" class="ghost">–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω –Ω–∞ –∫–∞—Ä—Ç—ñ</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnDownload" class="warn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç–∏ GeoJSON</button>
        <button id="btnCopy" class="ghost">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button>
      </div>

      <h3 style="margin:16px 0 8px;">–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h3>
      <label class="row" style="gap:8px; align-items:center;">
        <input id="chkShowLoaded" type="checkbox" checked /> –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π —Ñ–∞–π–ª –Ω–∞ –∫–∞—Ä—Ç—ñ
      </label>

      <h3 style="margin:16px 0 8px;">–ì–µ–æ–∑–æ–Ω–∏ –∑ Mapbox Tilesets</h3>
      <div class="row" style="margin-bottom:8px;">
        <button id="btnToggleTilesets" class="ghost">üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏</button>
      </div>
      <div id="tilesetList" class="hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó‚Ä¶</div>
    </div>

    <div class="card" style="display:grid; grid-template-rows:auto 1fr; gap:10px;">
      <div class="row" style="justify-content:space-between;">
        <div class="hint">–ù–∞–º–∞–ª—é–π—Ç–µ –ø–æ–ª—ñ–≥–æ–Ω —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º Draw Polygon, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ ‚Äî —Ä–µ–¥–∞–≥—É–π—Ç–µ –≤–µ—Ä—à–∏–Ω–∏.</div>
        <div class="row"><button id="btnShowJson" class="ghost">–ü–æ–∫–∞–∑–∞—Ç–∏ JSON</button></div>
      </div>
      <div id="map"></div>
      <div id="jsonWrap" class="card" style="display:none; padding:8px;">
        <textarea id="jsonOut" readonly></textarea>
      </div>
    </div>
  </div>

<script>
(function(){
  const MB_TOKEN = (window.APP_CONFIG && window.APP_CONFIG.mapboxToken) || '';
  if (!MB_TOKEN){ alert('Mapbox token –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É /config/config.js'); }
  mapboxgl.accessToken = MB_TOKEN;

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [30.5234, 50.4501], // Kyiv
    zoom: 6
  });

  const Draw = new MapboxDraw({
    displayControlsDefault: false,
    controls: { polygon: true, trash: true },
    defaultMode: 'draw_polygon'
  });
  map.addControl(Draw, 'top-left');
  map.addControl(new mapboxgl.NavigationControl(), 'top-left');

  let fc = null; // –ø–æ—Ç–æ—á–Ω–∏–π FeatureCollection
  let TILESETS = [];
  let geozonesVisible = true;

  function newFile(){
    const name = document.getElementById('fcName').value.trim() || '–ì–µ–æ–∑–æ–Ω–∏';
    fc = {
      type: 'FeatureCollection',
      name,
      crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
      features: []
    };
    setState(`–°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π —Ñ–∞–π–ª ¬´${name}¬ª`);
    updatePreview();
  }

  function setState(msg){ document.getElementById('state').textContent = msg; }

  function getDrawnPolygon(){
    const all = Draw.getAll();
    if (!all || !all.features || !all.features.length) return null;
    // —à—É–∫–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ–ª—ñ–≥–æ–Ω
    for (let i = all.features.length - 1; i >= 0; i--){
      const f = all.features[i];
      if (f && f.geometry && f.geometry.type === 'Polygon'){
        const coords = (f.geometry.coordinates && f.geometry.coordinates[0]) ? f.geometry.coordinates[0].slice() : [];
        if (coords.length >= 3){
          // –∑–∞–º–∫–Ω—É—Ç–∏ –∫—ñ–ª—å—Ü–µ, —è–∫—â–æ —Ç—Ä–µ–±–∞
          const first = coords[0];
          const last = coords[coords.length-1];
          if (!last || first[0] !== last[0] || first[1] !== last[1]) coords.push(first.slice());
          return coords;
        }
      }
    }
    return null;
  }

  function addPolygonFromDraw(){
    if (!fc){ alert('–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Ñ–∞–π–ª –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —ñ—Å–Ω—É—é—á–∏–π.'); return; }
    const ring = getDrawnPolygon();
    if (!ring){ alert('–ù–µ–º–∞—î –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Draw Polygon.'); return; }
    const props = {
      Name: document.getElementById('pName').value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
      GUID: document.getElementById('pGUID').value.trim(),
      Code: document.getElementById('pCode').value.trim(),
      Farm: document.getElementById('pFarm').value.trim(),
      Client: document.getElementById('pClient').value.trim()
    };
    const feat = { type:'Feature', properties: props, geometry:{ type:'Polygon', coordinates:[ ring ] } };
    fc.features.push(feat);
    setState(`–î–æ–¥–∞–Ω–æ –≥–µ–æ–∑–æ–Ω—É: ${props.Name} (–≤—Å—å–æ–≥–æ ${fc.features.length})`);
    updatePreview();
    updateLoadedOverlay();
  }

  function updatePreview(){
    const out = document.getElementById('jsonOut');
    if (!out) return;
    out.value = fc ? JSON.stringify(fc, null, 2) : '';
  }

  // ===== –ü–æ–∫–∞–∑ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ/—Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ —Ñ–∞–π–ª—É —è–∫ —à–∞—Ä—É =====
  function ensureLoadedOverlay(){
    if (!map.getSource('fc-source')){
      map.addSource('fc-source', { type:'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({ id:'fc-fill', type:'fill', source:'fc-source', paint:{ 'fill-color':'#22c55e', 'fill-opacity': 0.25 } });
      map.addLayer({ id:'fc-line', type:'line', source:'fc-source', paint:{ 'line-color':'#16a34a', 'line-width': 2 } });
    }
  }
  function updateLoadedOverlay(){
    if (!document.getElementById('chkShowLoaded').checked) return; // –Ω–µ –æ–Ω–æ–≤–ª—é—î–º–æ —è–∫—â–æ –≤–∏–º–∫–Ω–µ–Ω–æ
    const data = fc || { type:'FeatureCollection', features: [] };
    try{ map.getSource('fc-source')?.setData(data); }catch(_){ }
  }
  function setLoadedOverlayVisibility(show){
    ensureLoadedOverlay();
    const vis = show ? 'visible' : 'none';
    try{ map.setLayoutProperty('fc-fill','visibility', vis); }catch(_){}
    try{ map.setLayoutProperty('fc-line','visibility', vis); }catch(_){}
    if (show) updateLoadedOverlay();
  }

  function clearDraw(){ try{ Draw.deleteAll(); }catch(_){ } }

  function download(){
    if (!fc || !fc.features.length){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –î–æ–¥–∞–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–∏–Ω –ø–æ–ª—ñ–≥–æ–Ω.'); return; }
    const blob = new Blob([JSON.stringify(fc, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    const nm = (fc.name || 'geozones').replace(/[^a-zA-Z0-9_\-]+/g,'_');
    a.download = nm + '_' + new Date().toISOString().slice(0,10) + '.geojson';
    a.href = URL.createObjectURL(blob);
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 5000);
  }

  function copyJson(){
    if (!fc){ alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'); return; }
    const txt = JSON.stringify(fc, null, 2);
    navigator.clipboard.writeText(txt).then(()=> setState('JSON —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É'), ()=> alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏'));
  }

  function loadFromFile(file){
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const obj = JSON.parse(String(fr.result||'').trim());
        if (!obj || obj.type !== 'FeatureCollection' || !Array.isArray(obj.features)) throw new Error('–ù–µ FeatureCollection');
        fc = obj;
        document.getElementById('fcName').value = String(fc.name || '');
        setState(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: features=${fc.features.length}`);
        updatePreview();
      }catch(e){
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ GeoJSON: ' + (e?.message || e));
      }
    };
    fr.readAsText(file);
  }

  document.getElementById('btnNew').onclick = newFile;
  document.getElementById('btnUseDrawn').onclick = addPolygonFromDraw;
  document.getElementById('btnClearDraw').onclick = clearDraw;
  document.getElementById('btnDownload').onclick = download;
  document.getElementById('btnCopy').onclick = copyJson;
  document.getElementById('btnLoad').onclick = ()=>{
    const f = document.getElementById('fileInput').files[0];
    if (!f){ alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª .geojson –∞–±–æ .json'); return; }
    loadFromFile(f);
  };
  document.getElementById('btnShowJson').onclick = ()=>{
    const w = document.getElementById('jsonWrap');
    w.style.display = (w.style.display==='none' || !w.style.display) ? 'block' : 'none';
  };
  document.getElementById('chkShowLoaded').onchange = (e)=> setLoadedOverlayVisibility(e.target.checked);

  // ===== Tilesets (—Å–ø—Ä–æ—â–µ–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç —è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π) =====
  async function loadTilesetsConfig(){
    try{
      const res = await fetch('/config/tilesets.json?v=' + Date.now());
      const data = await res.json().catch(()=> null);
      TILESETS = Array.isArray(data) ? data : (data && Array.isArray(data.tilesets) ? data.tilesets : []);
    }catch(e){ console.warn('tilesets.json –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π', e); TILESETS = []; }
    renderTilesetList();
  }
  function renderTilesetList(){
    const box = document.getElementById('tilesetList');
    if (!box) return;
    if (!TILESETS.length){ box.textContent = '–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (/config/tilesets.json)'; return; }
    box.innerHTML = '';
    TILESETS.forEach(ts =>{
      const id = 'ts_' + (ts.key || ts.layer || ts.url);
      const row = document.createElement('label'); row.className='row'; row.style.gap='8px'; row.style.alignItems='center';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked = geozonesVisible !== false;
      cb.onchange = ()=> setTilesetVisibility(ts, cb.checked);
      const span = document.createElement('span'); span.textContent = (ts.name || ts.key || ts.layer || ts.url);
      row.appendChild(cb); row.appendChild(span); box.appendChild(row);
    });
  }
  function ensureTilesetLayers(ts){
    const srcId = 'ts-src-' + ts.key;
    if (!map.getSource(srcId)){
      map.addSource(srcId, { type:'vector', url: ts.url });
      const fillId = 'ts-fill-' + ts.key;
      const lineId = 'ts-line-' + ts.key;
      map.addLayer({ id: fillId, type:'fill', source: srcId, 'source-layer': ts.layer, paint:{ 'fill-color':'#0ea5e9', 'fill-opacity': 0.15 }, layout:{ visibility: geozonesVisible ? 'visible' : 'none' } });
      map.addLayer({ id: lineId, type:'line', source: srcId, 'source-layer': ts.layer, paint:{ 'line-color':'#0284c7', 'line-width': 1.5 }, layout:{ visibility: geozonesVisible ? 'visible' : 'none' } });
    }
  }
  function setTilesetVisibility(ts, show){
    ensureTilesetLayers(ts);
    const vis = show ? 'visible' : 'none';
    try{ map.setLayoutProperty('ts-fill-' + ts.key, 'visibility', vis); }catch(_){}
    try{ map.setLayoutProperty('ts-line-' + ts.key, 'visibility', vis); }catch(_){}
  }
  function setAllTilesetsVisibility(show){
    geozonesVisible = !!show;
    TILESETS.forEach(ts => setTilesetVisibility(ts, geozonesVisible));
    try{
      const b = document.getElementById('btnToggleTilesets');
      b.textContent = geozonesVisible ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ –≥–µ–æ–∑–æ–Ω–∏';
    }catch(_){}
    // —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ —á–µ–∫–±–æ–∫—Å–∏
    try{
      TILESETS.forEach(ts =>{
        const id = 'ts_' + (ts.key || ts.layer || ts.url);
        const cb = document.getElementById(id); if (cb) cb.checked = geozonesVisible;
      });
    }catch(_){}
  }
  document.getElementById('btnToggleTilesets').onclick = ()=> setAllTilesetsVisibility(!geozonesVisible);

  map.on('load', async ()=>{
    ensureLoadedOverlay();
    setLoadedOverlayVisibility(true);
    await loadTilesetsConfig();
    // –î–æ–¥–∞–º–æ –¥–∂–µ—Ä–µ–ª–∞/—à–∞—Ä–∏ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥
    TILESETS.forEach(ts => ensureTilesetLayers(ts));
  });

  // –ê–≤—Ç–æ-—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ñ–∞–π–ª
  newFile();
  // –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç–∏ –π–æ–≥–æ —è–∫ —à–∞—Ä (–ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π)
  setTimeout(()=>{ try{ ensureLoadedOverlay(); setLoadedOverlayVisibility(true); }catch(_){ } }, 0);
})();
</script>
</body>
</html>
