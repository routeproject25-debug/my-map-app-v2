# üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è —Å–∞–π—Ç—É

## –û–ø–∏—Å —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É—î –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è —Å–∞–π—Ç—É —Ç–∞ –∑–±–∏—Ä–∞—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —è–∫—É –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ **—Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏**.

## –©–æ –≤—ñ–¥—Å—Ç–µ–∂—É—î—Ç—å—Å—è

1. **üü¢ –û–Ω–ª–∞–π–Ω –∑–∞—Ä–∞–∑** - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –∞–∫—Ç–∏–≤–Ω–∏—Ö –æ—Å—Ç–∞–Ω–Ω—ñ 2 —Ö–≤–∏–ª–∏–Ω–∏
2. **üìÖ –°—å–æ–≥–æ–¥–Ω—ñ** - –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å
3. **üë• –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Å—å–æ–≥–æ–¥–Ω—ñ** - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤ –∑–∞ –¥–µ–Ω—å
4. **üìä –ó–∞ —Ç–∏–∂–¥–µ–Ω—å** - –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤
5. **üåê –í—Å—å–æ–≥–æ** - –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å –∑–∞ –≤–µ—Å—å —á–∞—Å

## –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ç—Ä–µ–∫—ñ–Ω–≥
- –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Å–µ—Å—ñ—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞
- –ö–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è "heartbeat" –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å—É
- –ü—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Å–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è
- –ö–æ–∂–µ–Ω –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö –≤ Firestore

#### –ö–æ–ª–µ–∫—Ü—ñ—è `visitor_sessions`
–ó–±–µ—Ä—ñ–≥–∞—î –∞–∫—Ç–∏–≤–Ω—ñ —Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ñ —Å–µ—Å—ñ—ó:
```javascript
{
  userId: "v_1234567890_xyz",      // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞
  startTime: Timestamp,             // –ß–∞—Å –ø–æ—á–∞—Ç–∫—É —Å–µ—Å—ñ—ó
  lastHeartbeat: Timestamp,         // –û—Å—Ç–∞–Ω–Ω—ñ–π heartbeat
  endTime: Timestamp | null,        // –ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (null —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞)
  page: "/index.html",              // –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
  userAgent: "Mozilla/5.0...",      // User Agent –±—Ä–∞—É–∑–µ—Ä–∞
  date: "2025-11-23"                // –î–∞—Ç–∞ —É —Ñ–æ—Ä–º–∞—Ç—ñ YYYY-MM-DD
}
```

#### –ö–æ–ª–µ–∫—Ü—ñ—è `visitor_stats`
–ó–±–µ—Ä—ñ–≥–∞—î –∞–≥—Ä–µ–≥–æ–≤–∞–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–Ω—è—Ö:
```javascript
{
  date: "2025-11-23",               // –î–∞—Ç–∞ (ID –¥–æ–∫—É–º–µ–Ω—Ç–∞)
  totalVisits: 150,                 // –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å
  uniqueVisitors: ["v_123", "v_456"],  // –ú–∞—Å–∏–≤ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö ID
  lastUpdate: Timestamp             // –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
}
```

## –Ø–∫ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤)

1. –£–≤—ñ–π–¥—ñ—Ç—å –Ω–∞ —Å–∞–π—Ç —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä
2. –£ –≤–µ—Ä—Ö–Ω—å–æ–º—É –ø—Ä–∞–≤–æ–º—É –∫—É—Ç—ñ –∑'—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ **üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
4. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å üîÑ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Firestore Rules

–ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–ø–µ–∫–∏ –≤–∂–µ –¥–æ–¥–∞–Ω—ñ –¥–æ `firestore.rules`:

```javascript
// –°–µ—Å—ñ—ó –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤
match /visitor_sessions/{sessionId} {
  allow create: if authed();
  allow update: if authed() && resource.data.userId == request.resource.data.userId;
  allow read: if authed() && isAdmin();
  allow delete: if false;
}

// –î–µ–Ω–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
match /visitor_stats/{date} {
  allow read: if authed() && isAdmin();
  allow create, update: if authed();
  allow delete: if false;
}
```

## –î–µ–ø–ª–æ–π –ø—Ä–∞–≤–∏–ª

–ü—ñ—Å–ª—è –≤–Ω–µ—Å–µ–Ω–Ω—è –∑–º—ñ–Ω —É `firestore.rules`, –≤–∏–∫–æ–Ω–∞–π—Ç–µ:

```bash
firebase deploy --only firestore:rules
```

## –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –¥–∞–Ω–∏—Ö (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º—ñ—Å—Ü—è –≤ Firestore, –º–æ–∂–Ω–∞ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –≤–∏–¥–∞–ª—è—Ç–∏ —Å—Ç–∞—Ä—ñ —Å–µ—Å—ñ—ó:

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –í—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ Firestore Console
1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Firebase Console
2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ Firestore Database
3. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ–ª–µ–∫—Ü—ñ—é `visitor_sessions`
4. –í–∏–¥–∞–ª—ñ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∏ —Å—Ç–∞—Ä—à—ñ –∑–∞ 30 –¥–Ω—ñ–≤

### –í–∞—Ä—ñ–∞–Ω—Ç 2: Cloud Function (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
–°—Ç–≤–æ—Ä—ñ—Ç—å Cloud Function –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');

exports.cleanOldSessions = functions.pubsub
  .schedule('every 24 hours')
  .onRun(async (context) => {
    const db = admin.firestore();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const oldSessions = await db.collection('visitor_sessions')
      .where('startTime', '<', admin.firestore.Timestamp.fromDate(thirtyDaysAgo))
      .get();
    
    const batch = db.batch();
    oldSessions.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    
    console.log(`Deleted ${oldSessions.size} old sessions`);
  });
```

## –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

- **Heartbeat —ñ–Ω—Ç–µ—Ä–≤–∞–ª**: 30 —Å–µ–∫—É–Ω–¥
- **–û–Ω–ª–∞–π–Ω –ø–æ—Ä–æ–≥**: 2 —Ö–≤–∏–ª–∏–Ω–∏ (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–∞–∂–∞—î—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω, —è–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π heartbeat < 2 —Ö–≤ —Ç–æ–º—É)
- **–£–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞**: –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –ø–æ localStorage (–Ω–µ –ø–æ IP)
- **–ü—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—å**: —Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è

1. **–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è**: –¥–æ–¥–∞—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—Ä–∞—ó–Ω–∏/–º—ñ—Å—Ç–∞ –ø–æ IP
2. **–î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è**: –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –º—ñ–∂ —Å—Ç–æ—Ä—ñ–Ω–∫–∞–º–∏
3. **–ì—Ä–∞—Ñ—ñ–∫–∏**: –¥–æ–¥–∞—Ç–∏ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö (Chart.js)
4. **–ï–∫—Å–ø–æ—Ä—Ç**: –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –µ–∫—Å–ø–æ—Ä—Ç—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ CSV/Excel
5. **–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è**: push-–Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—ñ –ø–µ–≤–Ω–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤

## –ü–∏—Ç–∞–Ω–Ω—è —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞

–ü—Ä–∏ –≤–∏–Ω–∏–∫–Ω–µ–Ω–Ω—ñ –ø–∏—Ç–∞–Ω—å –∞–±–æ –ø—Ä–æ–±–ª–µ–º:
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –ø–æ–º–∏–ª–∫–∏
2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –ø—Ä–∞–≤–∏–ª–∞ Firestore –∑–∞–¥–µ–ø–ª–æ—î–Ω—ñ
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î —Ä–æ–ª—å `admin`

---

**–ü—Ä–∏–º—ñ—Ç–∫–∞**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –ø–æ–≤–Ω—ñ—Å—Ç—é –Ω–∞ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–º—É JavaScript –±–µ–∑ –ø–æ—Ç—Ä–µ–±–∏ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö.
